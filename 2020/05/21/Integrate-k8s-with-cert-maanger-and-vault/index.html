<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 12**作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明** #install vault #https://ubuntu.com/kubernetes/docs/using-vault #ht">
<meta property="og:type" content="article">
<meta property="og:title" content="Integrate k8s with cert-maanger and vault">
<meta property="og:url" content="http://yoursite.com/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 12**作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明** #install vault #https://ubuntu.com/kubernetes/docs/using-vault #ht">
<meta property="og:updated_time" content="2020-05-21T11:16:33.518Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Integrate k8s with cert-maanger and vault">
<meta name="twitter:description" content="作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 12**作者：张华 发表于：2020-05-21版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明** #install vault #https://ubuntu.com/kubernetes/docs/using-vault #ht">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/"/>





  <title>Integrate k8s with cert-maanger and vault | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Integrate k8s with cert-maanger and vault</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-21T18:50:34+08:00">
                2020-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>作者：张华 发表于：2020-05-21<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**作者：张华 发表于：2020-05-21</span><br><span class="line">版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明**</span><br></pre></td></tr></table></figure>
<p>#install vault</p>
<p>#<a href="https://ubuntu.com/kubernetes/docs/using-vault" target="_blank" rel="external">https://ubuntu.com/kubernetes/docs/using-vault</a></p>
<p>#<a href="https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-certificate-management.html" target="_blank" rel="external">https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-certificate-management.html</a></p>
<p>#<a href="https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-vault.html" target="_blank" rel="external">https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-vault.html</a></p>
<p>#./generate-bundle.sh -s bionic –create-model –name k8s –run<br>wget <a href="https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/vault-pki-overlay.yaml" target="_blank" rel="external">https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/vault-pki-overlay.yaml</a><br>./generate-bundle.sh -s bionic –name k8s<br>juju add-model k8s &amp;&amp; juju deploy … –overlay ./vault-pki-overlay.yaml …<br>juju status vault-ca<br>$ cat vault-pki-overlay.yaml<br>applications:<br>  easyrsa: null<br>  vault:<br>    charm: cs:~openstack-charmers-next/vault<br>    num_units: 1<br>    options:<br>      auto-generate-root-ca-cert: true<br>  percona-cluster:<br>    charm: cs:percona-cluster<br>    num_units: 1<br>relations:</p>
<ul>
<li><ul>
<li>kubernetes-master:certificates</li>
<li>vault:certificates</li>
</ul>
</li>
<li><ul>
<li>etcd:certificates</li>
<li>vault:certificates</li>
</ul>
</li>
<li><ul>
<li>kubernetes-worker:certificates</li>
<li>vault:certificates</li>
</ul>
</li>
<li><ul>
<li>vault:shared-db</li>
<li>percona-cluster:shared-db</li>
</ul>
</li>
</ul>
<p>#install vault client<br>juju expose vault<br>sudo snap install vault</p>
<p>#./tools/vault-unseal-and-authorise.sh<br>export VAULT_ADDR=<a href="http://10.0.0.22:8200" target="_blank" rel="external">http://10.0.0.22:8200</a>  #vault_ip is 10.0.0.22<br>vault operator init -key-shares=5 -key-threshold=3<br>vault operator unseal <run-5-times-against-5-keys-created-by-vault-init-command><br>export VAULT_TOKEN=<root-key-created-by-vault-init-command><br>export VAULT_TOKEN=s.etL4szXrqoFiud8NnBOyU1rk<br>VAULT_TOKEN=<root-key-created-by-vault-init-command> vault token create –ttl=100m #give you a token to auth the charm<br>juju run-action –wait vault/0 authorize-charm token=<charm-token-not-root-token></charm-token-not-root-token></root-key-created-by-vault-init-command></root-key-created-by-vault-init-command></run-5-times-against-5-keys-created-by-vault-init-command></p>
<p>#can run again to re-generate-root-ca if you want when auto-generate-root-ca-cert=true<br>juju run-action vault/0 disable-pki<br>juju run-action vault/0 generate-root-ca max-ttl=’2800h’ ttl=’87598h’ # 3 months; 10 years - <a href="https://review.opendev.org/#/c/678161" target="_blank" rel="external">https://review.opendev.org/#/c/678161</a></p>
<h1 id="option-Upload-the-new-certificate-from-the-signed-CSR-in-vault"><a href="#option-Upload-the-new-certificate-from-the-signed-CSR-in-vault" class="headerlink" title="[option]Upload the new certificate from the signed CSR in vault"></a>[option]Upload the new certificate from the signed CSR in vault</h1><p>#NOTE: We may not need this step when using auto-generate-root-ca-cert=true to generate cert, only need to do for company’s CA cert</p>
<p>#how to generate ca and intermediate cert, pls see the appendix or <a href="https://www.cnblogs.com/adhzl/p/11577384.html" target="_blank" rel="external">https://www.cnblogs.com/adhzl/p/11577384.html</a></p>
<p>#To upload the new certificate from the signed CSR in Vault, we also need to provide the whole CA chain.</p>
<p>#The “pem” bundle needs to be a concatenation of : signed csr + intermediate CA + root CA.</p>
<p>#The root-ca bundle needs to include the intermediate CA + root CA. The order is important.</p>
<p>#juju config vault ssl-ca=”$(cat ./intermediate/certs/ca-chain.cert.pem | base64 )” \</p>
<h1 id="ssl-cert-”-cat-intermediate-certs-client-quqi-com-cert-pem-base64-”"><a href="#ssl-cert-”-cat-intermediate-certs-client-quqi-com-cert-pem-base64-”" class="headerlink" title="ssl-cert=”$(cat ./intermediate/certs/client.quqi.com.cert.pem | base64 )” \"></a>ssl-cert=”$(cat ./intermediate/certs/client.quqi.com.cert.pem | base64 )” \</h1><h1 id="ssl-key-”-cat-intermediate-private-client-quqi-com-key-pem-base64-”"><a href="#ssl-key-”-cat-intermediate-private-client-quqi-com-key-pem-base64-”" class="headerlink" title="ssl-key=”$(cat ./intermediate/private/client.quqi.com.key.pem | base64 )”"></a>ssl-key=”$(cat ./intermediate/private/client.quqi.com.key.pem | base64 )”</h1><p>juju run-action –wait vault/0 get-csr<br>juju run-action vault-ca/leader upload-signed-csr pem=”$(cat ./pem-bundle.pem | base64)” root-ca=”$(cat ./root-bundle.pem | base64 )” allowed-domains=’quqi.com’ allowed-subdomains=’client.quqi.com’ allow-any-name=true –wait</p>
<p>#Cert-Manager Role Creation<br>bash -c ‘cat &gt; ./policy-local.hcl’ &lt;&lt; EOF<br>path “charm-pki-local/issue/cert-manager” {<br>  capabilities = [“read”, “list”, “create”, “update”]<br>}<br>path “charm-pki-local/sign/cert-manager” {<br>  capabilities = [“read”, “list”, “create”, “update”]<br>}<br>EOF<br>$ vault policy write cert-manager ./policy-local.hcl<br>Error opening policy file: open /tmp/policy-local.hcl: no such file or directory<br>cat policy-local.hcl  |vault policy write cert-manager -<br>vault policy read cert-manager</p>
<p>#Create the cert-manager role for Vault and associate the newly created policy with that role<br>vault write auth/approle/role/cert-manager-role policies=cert-manager</p>
<p>#Generate a role-id and secret-id.<br>$ vault read auth/approle/role/cert-manager-role/role-id<br>Key        Value</p>
<hr>
<p>role_id    e1239e02-056b-f963-a285-baaa42ae8c40<br>$ vault write -f auth/approle/role/cert-manager-role/secret-id<br>Key                   Value</p>
<hr>
<p>secret_id             693e7657-a994-8435-2a80-df83aba23132<br>secret_id_accessor    820eff6e-e52b-45a8-db59-9d393d3920fe</p>
<p>#PKI Initialization</p>
<p>#The Vault PKI is initialized automatically by the charm. To give access to cert-manager,</p>
<p>#we need to create a permission for the role created by the policy.<br>vault write charm-pki-local/roles/cert-manager allowed_domains=quqi.com allow_subdomains=true max_ttl=8760h allow_bare_domains=true allow_any_name=true</p>
<p>#Install Cert-Manager<br>kubectl apply –validate=false -f <a href="https://github.com/jetstack/cert-manager/releases/download/v0.14.3/cert-manager.yaml" target="_blank" rel="external">https://github.com/jetstack/cert-manager/releases/download/v0.14.3/cert-manager.yaml</a><br>kubectl get all -n cert-manager</p>
<p>#configure certmanager</p>
<p>#For k8s to authenticate to the external Vault, the cert-manager secret_id must be created as a k8s secret.</p>
<p>#NOTE: The bolded secretID is the secret_id captured above encoded in base64. To encode in base64<br>$ echo 693e7657-a994-8435-2a80-df83aba23132 |base64<br>NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==<br>bash -c ‘cat &gt; cert-manager-vault-approle-ca.yaml’ &lt;&lt; EOF<br>apiVersion: v1<br>kind: Secret<br>type: Opaque<br>metadata:<br>  name: cert-manager-vault-approle-ca<br>  namespace: cert-manager<br>data:<br>  secretId: NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==<br>EOF<br>kubectl apply -f cert-manager-vault-approle-ca.yaml<br>kubectl get secrets -n cert-manager cert-manager-vault-approle-ca</p>
<p>#configure certmanager</p>
<p>#a certificate Issuer must be created within k8s to direct it to the Vault and identify the cert-manager role to match secret.<br>bash -c ‘cat &gt; vault-ca-issuer.yaml’ &lt;&lt; EOF<br>apiVersion: cert-manager.io/v1alpha2<br>kind: ClusterIssuer<br>metadata:<br>  name: vault-issuer<br>spec:<br>  vault:<br>    path: charm-pki-local/sign/cert-manager<br>    server: <a href="http://10.0.0.22:8200" target="_blank" rel="external">http://10.0.0.22:8200</a><br>    auth:<br>      appRole:<br>        path: approle<br>        roleId: “e1239e02-056b-f963-a285-baaa42ae8c40”<br>        secretRef:<br>          name: cert-manager-vault-approle-ca<br>          key: secretId<br>EOF<br>kubectl apply -f vault-ca-issuer.yaml<br>kubectl get clusterissuer</p>
<p>#Testing</p>
<p>#NOTE: the ip must be one of the k8s workers ip in this model<br>$ juju status kubernetes-worker/1 |grep started<br>5        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE<br>bash -c ‘cat &gt; microbot-cert.yaml’ &lt;&lt; EOF<br>apiVersion: cert-manager.io/v1alpha2<br>kind: Certificate<br>metadata:<br>  name: microbot<br>  namespace: default<br>spec:<br>  secretName: microbot-cert-ca<br>  issuerRef:<br>    name: vault-ca-issuer<br>    kind: ClusterIssuer<br>  commonName: microbot.10.0.0.15.quqi.com<br>  dnsNames:</p>
<ul>
<li>microbot.10.0.0.15.quqi.com<br>EOF<br>kubectl apply -f microbot-cert.yaml<br>kubectl get certs</li>
</ul>
<p>#Workload<br>bash -c ‘cat &gt; microbot-test.yaml’ &lt;&lt; EOF<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  creationTimestamp: null<br>  labels:<br>    app: microbot<br>  name: microbot<br>spec:<br>  replicas: 3<br>  selector:<br>    matchLabels:<br>      app: microbot<br>  strategy: {}<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: microbot<br>    spec:<br>      containers:</p>
<pre><code>- image: dontrebootme/microbot:v1
  imagePullPolicy: &quot;&quot;
  name: microbot
  ports:
  - containerPort: 80
  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 5
    timeoutSeconds: 30
  resources: {}
restartPolicy: Always
serviceAccountName: &quot;&quot;
</code></pre><h2 id="status"><a href="#status" class="headerlink" title="status: {}"></a>status: {}</h2><p>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: microbot<br>  labels:<br>    app: microbot<br>spec:<br>  ports:</p>
<pre><code>- port: 8080
  protocol: TCP
  targetPort: 80
</code></pre><p>  selector:</p>
<pre><code>app: microbot
</code></pre><hr>
<p>apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br> name: microbot<br> labels:<br>   app: microbot<br>spec:<br> tls:</p>
<ul>
<li>hosts:<ul>
<li>microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model<br>secretName: microbot-cert<br>rules:</li>
</ul>
</li>
<li>host: microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model<br>http:<br>  paths:<pre><code>- path: /
  backend:
    serviceName: microbot
    servicePort: 8080
</code></pre>EOF<br>kubectl apply -f microbot-test.yaml<br>kubectl get all</li>
</ul>
<p>#Enable NodePort for svc microbot<br>$ kubectl get svc |grep microbot<br>microbot     ClusterIP   10.152.183.135   <none>        8080/TCP   22m<br>$ kubectl edit svc microbot<br>service/microbot edited<br>$ kubectl get svc microbot<br>NAME       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br>microbot   NodePort   10.152.183.135   <none>        8080:32765/TCP   28m</none></none></p>
<p>#Enable security rule for icmp and the port 32765<br>$ juju status kubernetes-worker/1 |grep started<br>        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE<br>source ~/novarc<br>openstack port list |grep 10.0.0.15<br>openstack port show f3d147e1-2a00-496d-8184-302a825270fd |grep security_group_ids<br>openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b –protocol icmp –remote-ip 0.0.0.0/0<br>openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b –protocol tcp –remote-ip 0.0.0.0/0 –dst-port 32765<br>ping 10.0.0.15</p>
<p>curl –resolve microbot.10.0.0.15.quqi.com:32765:10.0.0.15 -k <a href="http://microbot.10.0.0.15.quqi.com:32765" target="_blank" rel="external">http://microbot.10.0.0.15.quqi.com:32765</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">## appendix - create key</span><br></pre></td></tr></table></figure></p>
<p>#<a href="https://www.dazhuanlan.com/2019/12/15/5df63aed10999" target="_blank" rel="external">https://www.dazhuanlan.com/2019/12/15/5df63aed10999</a></p>
<p>#generate ca key pairs<br>mkdir -p ca/{private,certs,newcerts} &amp;&amp; cd ca<br>openssl genrsa -aes256 -passout pass:password -out private/ca.key.pem 4096<br>chmod 400 private/ca.key.pem<br>wget <a href="https://jamielinux.com/docs/openssl-certificate-authority/_downloads/root-config.txt" target="_blank" rel="external">https://jamielinux.com/docs/openssl-certificate-authority/_downloads/root-config.txt</a> -O openssl.cnf<br>sed -i “s,/root/ca,.,g” openssl.cnf<br>openssl req -config ./openssl.cnf -key private/ca.key.pem -new -x509 -days 7300 -sha256 -extensions v3_ca -passin pass:password \<br>     -subj “/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.rootca/emailAddress=quqi@mail.com” -out certs/ca.cert.pem<br>chmod 444 certs/ca.cert.pem<br>openssl x509 -noout -text -in certs/ca.cert.pem #verify</p>
<p>#generate intermediate key pairs<br>mkdir -p intermediate/{certs,crl,csr,newcerts,private}<br>chmod 744 intermediate/private<br>touch index.txt &amp;&amp; echo 1000 &gt; serial &amp;&amp; echo 1000 &gt; crlnumber<br>openssl genrsa -aes256 -passout pass:password -out intermediate/private/intermediate.key.pem 4096<br>chmod 400 intermediate/private/intermediate.key.pem<br>cp ./openssl.cnf ./openssl-im.cnf</p>
<p>#modify the following section of openssl-im.cnf file<br>[ CA_default ]<br>dir             = .<br>private_key     = $dir/private/intermediate.key.pem<br>certificate     = $dir/certs/intermediate.cert.pem<br>crl             = $dir/crl/intermediate.crl.pem<br>policy          = policy_loose<br>openssl req -config ./openssl-im.cnf -new -sha256 -passin pass:password \<br>     -subj “/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.imca/emailAddress=quqi@mail.com” \<br>     -key intermediate/private/intermediate.key.pem -out intermediate/csr/intermediate.csr.pem<br>openssl ca -config ./openssl.cnf -extensions v3_intermediate_ca -days 3650 -notext -md sha256 -passin pass:password \<br>     -in intermediate/csr/intermediate.csr.pem -out intermediate/certs/intermediate.cert.pem<br>chmod 444 intermediate/certs/intermediate.cert.pem<br>openssl x509 -noout -text -in intermediate/certs/intermediate.cert.pem<br>openssl verify -CAfile certs/ca.cert.pem intermediate/certs/intermediate.cert.pem</p>
<p>#generate certificate chain<br>cat intermediate/certs/intermediate.cert.pem certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem<br>chmod 444 intermediate/certs/ca-chain.cert.pem</p>
<p>#generate clinet.quqi.com key pairs<br>openssl genrsa -out intermediate/private/client.quqi.com.key.pem 2048<br>chmod 444 intermediate/private/client.quqi.com.key.pem<br>openssl req -config ./openssl-im.cnf -key intermediate/private/client.quqi.com.key.pem \<br>     -subj “/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=client.quqi.com/emailAddress=quqi@mail.com” \<br>     -new -sha256 -out intermediate/csr/client.quqi.com.csr.pem<br>openssl ca -config ./openssl.cnf -extensions server_cert -days 3650 -notext -md sha256 -passin pass:password\<br>     -in intermediate/csr/client.quqi.com.csr.pem -out intermediate/certs/client.quqi.com.cert.pem<br>chmod 444 intermediate/certs/client.quqi.com.cert.pem<br>openssl x509 -noout -text -in intermediate/certs/client.quqi.com.cert.pem<br>openssl verify -CAfile intermediate/certs/ca-chain.cert.pem intermediate/certs/client.quqi.com.cert.pem<br>```</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/19/为什么dnsmasq服务总是重启/" rel="next" title="为什么dnsmasq服务总是重启">
                <i class="fa fa-chevron-left"></i> 为什么dnsmasq服务总是重启
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#option-Upload-the-new-certificate-from-the-signed-CSR-in-vault"><span class="nav-number">1.</span> <span class="nav-text">[option]Upload the new certificate from the signed CSR in vault</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ssl-cert-”-cat-intermediate-certs-client-quqi-com-cert-pem-base64-”"><span class="nav-number">2.</span> <span class="nav-text">ssl-cert=”$(cat ./intermediate/certs/client.quqi.com.cert.pem | base64 )” \</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ssl-key-”-cat-intermediate-private-client-quqi-com-key-pem-base64-”"><span class="nav-number">3.</span> <span class="nav-text">ssl-key=”$(cat ./intermediate/private/client.quqi.com.key.pem | base64 )”</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#status"><span class="nav-number">3.1.</span> <span class="nav-text">status: {}</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
