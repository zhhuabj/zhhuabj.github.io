<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="作者：张华 发表于：2020-07-07版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 问题在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 https://node1.lan:8081/discharge/info 时抛的错.1maas (ma">
<meta property="og:type" content="article">
<meta property="og:title" content="Fix the error CERTIFICAT_VERIFY_FAILED">
<meta property="og:url" content="http://yoursite.com/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="作者：张华 发表于：2020-07-07版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 问题在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 https://node1.lan:8081/discharge/info 时抛的错.1maas (ma">
<meta property="og:updated_time" content="2020-07-09T02:21:05.753Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fix the error CERTIFICAT_VERIFY_FAILED">
<meta name="twitter:description" content="作者：张华 发表于：2020-07-07版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 问题在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 https://node1.lan:8081/discharge/info 时抛的错.1maas (ma">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/"/>





  <title>Fix the error CERTIFICAT_VERIFY_FAILED | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Fix the error CERTIFICAT_VERIFY_FAILED</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-07T15:54:08+08:00">
                2020-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>作者：张华 发表于：2020-07-07<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 <a href="https://node1.lan:8081/discharge/info" target="_blank" rel="external">https://node1.lan:8081/discharge/info</a> 时抛的错.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maas (maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest) -&gt; rbac with http (http://node1.lan:8081) -&gt; candid with https (https://node1.lan:8081/discharge/info) -&gt; ldap with https</span><br></pre></td></tr></table></figure></p>
<p>奇怪的是, 我已经运行过这个命令( cp ~/certs/ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates )了. 不应该啊.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-ca-certificates --fresh</span><br><span class="line">$ export SSL_CERT_DIR=/etc/ssl/certs</span><br></pre></td></tr></table></figure></p>
<h2 id="curl测试"><a href="#curl测试" class="headerlink" title="curl测试"></a>curl测试</h2><p>运行下列三个命令均无问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://node1.lan:8081/discharge/info</span><br><span class="line">curl https://node1.lan:8081/discharge/info -k</span><br><span class="line">curl https://node1.lan:8081/discharge/info --cacert ~/certs/ca.crt</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-urllib2-request"><a href="#python测试-urllib2-request" class="headerlink" title="python测试 - urllib2.request"></a>python测试 - urllib2.request</h2><p>下列python代码测试也没问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; test.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import ssl</span><br><span class="line">try:</span><br><span class="line">    import urllib2 #python2</span><br><span class="line">except:</span><br><span class="line">    import urllib.request as urllib2 #python3</span><br><span class="line"></span><br><span class="line">req = urllib2.Request(sys.argv[1], headers=&#123;&apos;Bakery-Protocol-Version&apos;:&apos;3&apos;&#125;)</span><br><span class="line">print(urllib2.urlopen(req).read())</span><br><span class="line">EOF</span><br><span class="line">mkdir /usr/share/ca-certificates/extras</span><br><span class="line">cp ~/certs//ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates</span><br><span class="line">python test.py https://node1.lan:8081/discharge/info</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-requests"><a href="#python测试-requests" class="headerlink" title="python测试 - requests"></a>python测试 - requests</h2><p>奇了怪了, 只好继续调试代码, 发现rbac使用了pymacaroons (<a href="https://github.com/ecordell/pymacaroons" target="_blank" rel="external">https://github.com/ecordell/pymacaroons</a>), pymacaroons它又会调用requests (不是urllib2.request)<br>所以继续写了一个python测试, 问题就重现了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; test2.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = sys.argv[1]</span><br><span class="line">print(requests.get(url).read())</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">...</span><br><span class="line">requests.exceptions.SSLError: HTTPSConnectionPool(host=&apos;node1.lan&apos;, port=8081): Max retries exceeded with url: /discharge/info (Caused by SSLError(SSLError(1, &apos;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:852)&apos;),))</span><br></pre></td></tr></table></figure></p>
<p>添加REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem 问题解决.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem  python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">200</span><br></pre></td></tr></table></figure>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>改为下列使命启动rbac<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<p>或者使用全局ca database<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># use the full system database</span><br><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>应该是遇到了这个bug - <a href="https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144" target="_blank" rel="external">https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144</a><br>现在request的代码(<a href="https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径" target="_blank" rel="external">https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r where /bak/work/crbs/.ve/lib/python3.6/site-packages/requests/certs.py</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line"></span><br><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &quot;cacert.pem&quot;)</span><br></pre></td></tr></table></figure></p>
<p>python-request 2.9.1版本的debian包中有一个01_use-system-ca-certificates.patch修改了ca路径为/etc/ssl/certs/ca-certificates.crt, requests-2.18.4版本开始改用certifi模块中的where函数并修复了这个问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;return&apos; /tmp/requests-2.9.1/debian/patches/01_use-system-ca-certificates.patch</span><br><span class="line">-        return os.path.join(os.path.dirname(__file__), &apos;cacert.pem&apos;)</span><br><span class="line">+        return &apos;/etc/ssl/certs/ca-certificates.crt&apos;</span><br><span class="line"></span><br><span class="line"># grep -r where /tmp/requests-2.18.4/requests/certs.py</span><br><span class="line">environment, you can change the definition of where() to return a separately</span><br><span class="line">from certifi import where</span><br><span class="line">    print(where())</span><br><span class="line"># grep -r &apos;def where&apos; /usr/lib/python3/dist-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    return &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br></pre></td></tr></table></figure></p>
<p>但virtualenv环境中没有改:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br></pre></td></tr></table></figure></p>
<p>不可能去修改上游virtualenv模块, 看来只能修改rbac这个应用了.</p>
<h2 id="怎么解决呢"><a href="#怎么解决呢" class="headerlink" title="怎么解决呢"></a>怎么解决呢</h2><p>requests module (/snap/xxx-rbac/224/lib/python3.6/site-packages/requests)在使用/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem. 而不是在使用/var/snap/xxx-rbac/current/conf/certs/ca.pem (snap set xxx-rbac ssl.ca=”$(cat $cert_dir/ca.crt)”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# grep -r &apos;import where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/requests/certs.py -A 3</span><br><span class="line">from certifi import where</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line">(.ve) root@node1:~# grep -r &apos;where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &apos;cacert.pem&apos;)</span><br><span class="line"></span><br><span class="line">(.ve) root@node1:~# ls /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br><span class="line">/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br></pre></td></tr></table></figure></p>
<p>所以得使用REQUESTS_CA_BUNDLE变量, 但上面是通过源码运行的 (REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver –debug run -P 5000),  现在改从snap(systemctl restart snap.xxx-rbac.uwsgi)的方式启动.  但发现这条code path (./crbs/wsgi.py#make_wsgi_app -&gt; ./crbs/setup.py#setup_globals -&gt; ./crbs/snap/_env.py(set REQUESTS_CA_BUNDLE))设置了REQUESTS_CA_BUNDLE, 可它为什么不生效了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>但从snap容器中没查着这个环境变量:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# snap run --shell xxx-rbac.uwsgi</span><br><span class="line">root@node1:/root# env |grep REQUESTS_CA_BUNDLE</span><br><span class="line"></span><br><span class="line">NOTE: 也可以通过:snap run xxx-rbac.uwsgi --ini /var/snap/xxx-rbac/x4/conf/uwsgi.ini 来在snap container里运行命令，但是snap container里没有python命令:</span><br><span class="line">root@node1:~# snap run canonical-rbac.python</span><br><span class="line">error: cannot find app &quot;python&quot; in &quot;canonical-rbac&quot;</span><br></pre></td></tr></table></figure></p>
<p>从host机器也没查着:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# pidof uwsgi</span><br><span class="line">3898 3897 3896 3895 3894 3893 3892 3891 3679</span><br><span class="line">(.ve) root@node1:~# cat /proc/3898/environ |grep REQUESTS_CA_BUNDLE</span><br><span class="line">(.ve) root@node1:~#</span><br></pre></td></tr></table></figure></p>
<p>改以只能想着通过pdb ( import pdb;pdb.set_trace() )调试, 但/snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py是只读的没法添加断点.<br>另一种可能的调试方法是采用’python3 -m pdb xx.py’的方式交互性调试( 这样, 断点设置在第1行 - <a href="https://pymotw.com/3/pdb/" target="_blank" rel="external">https://pymotw.com/3/pdb/</a> ). snap.xxx-rbac.uwsgi最终得通过(/usr/bin/snap run xxx-rbac.uwsgi) 启动, 最终调用command-uwsgi.wrapper启动, 但似乎我们也无法修改command-uwsgi.wrapper啊它也中只读的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# cat /snap/xxx-rbac/224/command-uwsgi.wrapper</span><br><span class="line">#!/bin/sh</span><br><span class="line">exec &quot;uwsgi&quot; &quot;--ini&quot; &quot;$SNAP_DATA/conf/uwsgi.ini&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="debug-snap"><a href="#debug-snap" class="headerlink" title="debug snap"></a>debug snap</h2><p>想给snap里的python用pdb加个断点，因为snap的代码目录是只读的，非常难调．用下列方法可以修改源代码．但是仍然无法加 ‘import pdb;pdb.set_trace()’ 到源码，因为pdb需要通过python启动程序而不是通过snap启动程序．所以实际上snap部分的代码还是相当难调．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://forum.snapcraft.io/t/make-a-snap-writable-temporarily-for-debugging/16370/3</span><br><span class="line">unsquashfs -d canonical-rbac /var/lib/snapd/snaps/canonical-rbac_224.snap</span><br><span class="line"># modfity file here. eg:  ./canonical-rbac/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">snap try canonical-rbac --devmode</span><br></pre></td></tr></table></figure></p>
<h2 id="问题最终解决"><a href="#问题最终解决" class="headerlink" title="问题最终解决"></a>问题最终解决</h2><p>snap都是只读的实在无法调试，最后发现一个现象．直接在浏览器(最好用firefox, 使用chrome时不弹出框)访问rbac portal (<a href="https://node1.lan:5000" target="_blank" rel="external">https://node1.lan:5000</a> )并不出现这个错，只是使用＂maas configauth –rbac-url <a href="https://node1.lan:5000/" target="_blank" rel="external">https://node1.lan:5000/</a> –rbac-service-name maastest＂命令时报这个错．这会不会是maas的问题？尤其是maas是通过snap安装的，而不是通过debian安装的，maas是不是缺少了下 面类似于rbac的用于设置的代码．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>通过debian包安装后证明果然是这个问题.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install maas --channel=2.8</span><br><span class="line">#sudo snap install maas-test-db                              #enter shell - maas-test-db.psql</span><br><span class="line">#sudo maas init region+rack --database-uri maas-test-db:///  #http://192.168.99.124:5240/MAAS</span><br><span class="line">sudo add-apt-repository ppa:maas/2.8   #https://launchpad.net/~maas</span><br><span class="line">sudo apt install maas</span><br><span class="line"></span><br><span class="line">sudo maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest  #use external authentication</span><br><span class="line"># sudo maas createadmin   #not use external authentication</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/05/开发用的devstack/" rel="next" title="开发用的devstack">
                <i class="fa fa-chevron-left"></i> 开发用的devstack
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/09/Play-with-MAAS/" rel="prev" title="Play with MAAS">
                Play with MAAS <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#curl测试"><span class="nav-number">2.</span> <span class="nav-text">curl测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python测试-urllib2-request"><span class="nav-number">3.</span> <span class="nav-text">python测试 - urllib2.request</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python测试-requests"><span class="nav-number">4.</span> <span class="nav-text">python测试 - requests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题解决"><span class="nav-number">5.</span> <span class="nav-text">问题解决</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题分析"><span class="nav-number">6.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#怎么解决呢"><span class="nav-number">7.</span> <span class="nav-text">怎么解决呢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#debug-snap"><span class="nav-number">8.</span> <span class="nav-text">debug snap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题最终解决"><span class="nav-number">9.</span> <span class="nav-text">问题最终解决</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
