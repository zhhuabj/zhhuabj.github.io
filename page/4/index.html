<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/利用squid的tcp-outgoing-address特性选择第二块网卡出流量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/12/利用squid的tcp-outgoing-address特性选择第二块网卡出流量/" itemprop="url">利用squid的tcp_outgoing_address特性选择第二块网卡出流量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-12T14:40:17+08:00">
                2020-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-12<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>有两块网卡192.168.99.135与192.168.8.101, 对于chrome的某些tab想灵活地类似于ForceBindIp[1]某时走192.168.8.101, 不想使用修改路由的全局方式, 怎么办呢? 那需要在本机构建一个squid http代理服务器, 然后用到squid的tcp_outgoing_address特性, 但是tcp_outgoing_address这个特性做测试时可没那么容易成功的, 最终这个最小化的squid.conf如下, 底层原理可参照[2]:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install squid -y</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/squid/squid.conf</span><br><span class="line">#sudo rm -rf /dev/shm/squid*</span><br><span class="line">#sudo mkdir -p /var/log/squid &amp;&amp; sudo chown -R proxy:proxy /var/log/squid/</span><br><span class="line">http_port 192.168.99.135:3128</span><br><span class="line">dns_v4_first on</span><br><span class="line">dns_nameservers 192.168.8.1</span><br><span class="line">acl gfw myip 192.168.99.135</span><br><span class="line">tcp_outgoing_address 192.168.8.101 gfw</span><br><span class="line">#http_access allow all</span><br><span class="line">acl localip src 192.168.99.135</span><br><span class="line">http_access allow localip</span><br><span class="line">http_access deny all</span><br><span class="line">cache_access_log /var/log/squid/access.log</span><br><span class="line">cache_log /var/log/squid/cache.log</span><br><span class="line">cache_store_log none</span><br><span class="line">logfile_rotate 7</span><br><span class="line">coredump_dir /var/cache/squid</span><br><span class="line">#coredump_dir /var/log/squid/cache</span><br><span class="line">max_filedescriptors 3200</span><br><span class="line">#prevent squid from adding http headers to cause some websites to detect proxy and prohibit access</span><br><span class="line">via off</span><br><span class="line">forwarded_for delete</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl reload squid</span><br><span class="line">sudo systemctl enable squid</span><br><span class="line"></span><br><span class="line">#Ipc::Mem::Segment::create failed to shm_open(/squid-cf__metadata.shm): (17) File exists</span><br><span class="line">sudo rm -rf /dev/shm/squid-cf__*</span><br><span class="line">sudo mkdir -p /var/log/squid &amp;&amp; sudo chown -R proxy:proxy /var/log/squid/</span><br><span class="line">sudo mkdir -p /var/cache/squid &amp;&amp; sudo chown -R proxy:proxy /var/cache/squid/</span><br><span class="line"></span><br><span class="line">#add the following lines in systemd file</span><br><span class="line">ExecStartPre=mkdir -p /var/log/squid</span><br><span class="line">ExecStartPre=chown -R proxy:proxy /var/log/squid/</span><br><span class="line">ExecStartPre=mkdir -p /var/cache/squid</span><br><span class="line">ExecStartPre=chown -R proxy:proxy /var/cache/squid/</span><br><span class="line"></span><br><span class="line">NOTE: 20200626更新</span><br><span class="line">添加了policy router之后也可以使用ssh</span><br><span class="line">ssh ubuntu@xxx -b 192.168.8.101 -D192.168.99.135:3128 -fN -o ServerAliveInterval=30 -o ServerAliveCountMax=1</span><br></pre></td></tr></table></figure>
<p>如果是ssh呢，这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">GW=$(nmcli d show wlp4s0 |grep -i &apos;ip4.gateway&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">GW=$(ip route list table main |grep wlp4s0 |grep default |awk &apos;&#123;print $3&#125;&apos;)</span><br><span class="line">sudo ip route add default via $GW dev wlp4s0 table ssh</span><br><span class="line">sudo ip route add default via 172.20.10.1 dev wlp4s0 table ssh</span><br><span class="line">sudo ip rule add from 172.20.10.0/24 table ssh</span><br><span class="line">sudo ip rule add from 192.168.8.0/24 table ssh</span><br><span class="line">ip route list table ssh</span><br><span class="line">ip rule list</span><br><span class="line">ssh ubuntu@xxx -b 172.20.10.3 -v</span><br><span class="line">ssh ubuntu@xxx -b 192.168.8.101 -v</span><br><span class="line"></span><br><span class="line"># NOTE: the following doesn&apos;t work, need to fix</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/NetworkManager/dispatcher.d/008_policy_route_4g&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line">echo &quot;the interface $1 is $2&quot; 1&gt;&amp;2</span><br><span class="line"># Modify policy route after the connection is made</span><br><span class="line">if [ $1 == &quot;wlp4s0&quot; ] &amp;&amp; [ $2 == &quot;up&quot; ]; then</span><br><span class="line">    #GW=$(nmcli d show wlp4s0 |grep -i &apos;ip4.gateway&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">    GW=$(ip route list table main |grep wlp4s0 |grep default |awk &apos;&#123;print $3&#125;&apos;)</span><br><span class="line">    ip route add default via $GW dev wlp4s0 table ssh</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">chmod root:root /etc/NetworkManager/dispatcher.d/008_policy_route_4g</span><br><span class="line">chmod 755 /etc/NetworkManager/dispatcher.d/008_policy_route_4g</span><br></pre></td></tr></table></figure></p>
<p><strong>题外话</strong><br>关于如何持久化上面的policy route确是一个大课题，至今未解决：<br>１，　先是用这个不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:~$ cat /etc/network/if-up.d/wlp4s0-routes</span><br><span class="line">#!/bin/sh</span><br><span class="line">set -e</span><br><span class="line">if [ &quot;$IFACE&quot; != &apos;wlp4s0&apos; ]; then</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$METHOD&quot; = loopback ]; then</span><br><span class="line">    exit 0</span><br><span class="line">elif [ &quot;$METHOD&quot; = dhcp ]; then</span><br><span class="line">    IF_ADDRESS=&quot;$(echo &quot;$IP4_ADDRESS_0&quot; | cut -d&apos;/&apos; -f1)&quot;</span><br><span class="line">    IF_GATEWAY=&quot;$(echo &quot;$IP4_ADDRESS_0&quot; | cut -d&apos; &apos; -f2)&quot;</span><br><span class="line">elif [ &quot;$METHOD&quot; = static]; then</span><br><span class="line">    if [ ! &quot;$GATEWAY&quot; ]; then</span><br><span class="line">        IF_GATEWAY=&quot;$(echo &quot;$IF_ADDRESS&quot; | cut -d. -f1-3).1&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">ip route flush table &quot;$IFACE&quot;</span><br><span class="line">ip route add default via &quot;$IF_GATEWAY&quot; table &quot;$IFACE&quot;</span><br><span class="line">ip rule del lookup &quot;$IFACE&quot; || true</span><br><span class="line">ip rule add from &quot;$IF_ADDRESS&quot; lookup &quot;$IFACE&quot;</span><br></pre></td></tr></table></figure></p>
<p>2, 再用这个还不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:~$ cat /etc/network/if-up.d/wlp4s0-routes</span><br><span class="line">if [ &quot;$IFACE&quot; == &quot;wlp4s0&quot; ]; then</span><br><span class="line">  ip rule add from 172.20.10.0/24 table ssh</span><br><span class="line">  ip rule add from 192.168.8.0/24 table ssh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>3, 这个（/etc/NetworkManager/system-connections/huawei4G）里也不能持久化policy routing<br>4, 改用netplan理论上应该可以，但实际测试又报别的错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/netplan/01-network-manager-all.yaml /etc/netplan/01-network-manager-all.yaml_bak</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/netplan/01-network-manager-all.yaml</span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd # change this from &apos;NetworkManager&apos; if it&apos;s set.</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      #dhcp6: no</span><br><span class="line">      #accept-ra: no</span><br><span class="line">      #gateway6: 2a01:xxx:xxxx:xx::x</span><br><span class="line">      #addresses: [81.94.xx.xx/28, &quot;2a01:xxx:xxxx:xx::xx/64&quot;]</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.99.135/24]</span><br><span class="line">      gateway4: 192.168.99.1</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [192.168.99.1]</span><br><span class="line">    wlp4s0:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.8.101/24]</span><br><span class="line">      gateway4:    # unset, since we configure the route below</span><br><span class="line">      routes:</span><br><span class="line">        - to: 91.189.0.0/16</span><br><span class="line">          via: 192.168.8.1</span><br><span class="line">          metric: 600</span><br><span class="line">          #table: 9             #echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">      routing-policy:</span><br><span class="line">        - from: 172.20.10.0/24</span><br><span class="line">          table: 9</span><br><span class="line">        - from: 192.168.8.101</span><br><span class="line">          table: 9</span><br><span class="line">EOF</span><br><span class="line">sudo netplan try   # it will rolling back your last configurations in 120 seconds</span><br><span class="line">sudo systemctl stop netplan</span><br><span class="line">sudo netplan -d apply</span><br><span class="line">sudo systemctl restart network-manager</span><br><span class="line">#sudo systemctl restart systemd-networkd  #for ubuntu server version</span><br><span class="line"></span><br><span class="line">hua@t440p:~$ sudo netplan apply</span><br><span class="line">bind: Address already in use</span><br><span class="line">netplan: fatal error: cannot bind to port 2983, is another daemon running?, exiting</span><br><span class="line"></span><br><span class="line">netplan的方法不通，这个网页( https://blogs.gnome.org/thaller/category/networkmanager/ ) network-manager 1.18开始技术policy route (使用方法：http://devemmeff.blogspot.com/2016/02/howto-policy-based-routing-using.html）, 但是照下列方法从源码编译network-manager遇到太多太多包依赖问题了，至今未解决</span><br><span class="line">git clone https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git &amp;&amp; cd NetworkManager</span><br><span class="line">git checkout -b 1.18.4 1.18.4</span><br><span class="line">sudo apt install gtk-doc-tools build-essential automake</span><br><span class="line">sudo apt install wireless-tools libiw-dev libdbus-glib-1-dev libgudev-1.0-dev uuid-dev uuid libnss-db libnss3-dev ppp-dev libjansson-dev libcurl4-openssl-dev libndp-dev</span><br><span class="line">sudo apt install gtk-doc-tools libglib2.0-dev libudev-dev uuid-dev libnss3-dev ppp-dev libjansson-dev libcurl4-nss-dev libndp-dev libreadline-dev intltool</span><br><span class="line">sudo apt install libnm-dev libnm-util-dev</span><br><span class="line">./autogen.sh --prefix=/usr --sysconfdir=/etc --localstatedir=/var --enable-introspection=no --disable-ppp --disable-json-validation --enable-gtk-doc=no</span><br><span class="line"></span><br><span class="line">最后通过rc.local解决：</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/rc.local&apos; &lt;&lt;EOF</span><br><span class="line">#!/bin/sh -e</span><br><span class="line">ip rule del from 172.20.10.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule del from 192.168.8.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule del to &lt;IP&gt; table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have this line</span><br><span class="line">ip rule add from 172.20.10.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule add from 192.168.8.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule add to &lt;IP&gt; table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have it</span><br><span class="line">ip route add default via 192.168.8.1 dev wlan0 table ssh &gt;/dev/null  2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have it</span><br><span class="line">exit 0</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart rc.local</span><br><span class="line">sudo systemctl enable rc.local</span><br><span class="line">注意:上面del与add之间必须使用sleep 2,因为都是异步执行的.</span><br><span class="line">然后可以使用下列命令验证:</span><br><span class="line">sudo tcpdump -ni wlan0 host &lt;IP&gt;</span><br></pre></td></tr></table></figure>
<p>5, 放弃先</p>
<p>[1] <a href="https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem" target="_blank" rel="external">https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem</a><br>[2] <a href="http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/" target="_blank" rel="external">http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/13/Debian-Customer-PPA-RFC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/13/Debian-Customer-PPA-RFC/" itemprop="url">Debian Customer PPA RFC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-13T16:42:43+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-01-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>Precondition<br>a, sudo apt install gnupg pbuilder ubuntu-dev-tools bzr-builddeb apt-file debhelper dh-systemd openstack-pkg-tools</p>
<p>b, GPG key<br>scp -r /home/hua/.gnupg ubuntu@192.168.100.3:~/<br>gpg –list-public           # or gpg –gen-key<br>export GPGKEY=XXXXXX<br>gpg –send-keys –keyserver keyserver.ubuntu.com $GPGKEY</p>
<p>c, SSH key<br>ssh-keygen -t rsa<br><a href="https://launchpad.net/~/+editsshkeys" target="_blank" rel="external">https://launchpad.net/~/+editsshkeys</a></p>
<p>d, Bazaar<br>bzr whoami “<email>“<br>bzr launchpad-login <lauchpad_id></lauchpad_id></email></p>
<p>Get the source code<br>a, Add related ppa to /etc/apt/source.list<br>   ppa info can be found from lanchpad <a href="https://launchpad.net/~zhhuabj/+archivesubscriptions" target="_blank" rel="external">https://launchpad.net/~zhhuabj/+archivesubscriptions</a></p>
<p>b, Import the public key and update the repository<br>   sudo apt-key adv –keyserver keyserver.ubuntu.com –recv-keys <public-key><br>   sudo apt-get update</public-key></p>
<p>c, Get the source code (pls don’t add other repository when executing this step)</p>
<p>   #Get package from the ppa<br>   sudo apt-get source <package-name>    </package-name></p>
<p>   #Get package from official repo</p>
<pre><code> sudo pip install --upgrade lazr.restfulclient

#pull-lp-source cinder trusty
</code></pre><p>   #debcheckout –git-track=’*’ nova   #for openstack sru</p>
<p>d, dget *.dsc</p>
<p>Example:</p>
<p>sudo add-apt-repository cloud-archive:kilo</p>
<p>#uncomment deb-src in /etc/apt/sources.list.d/cloudarchive-kilo.list<br>$ cat /etc/apt/sources.list.d/cloudarchive-kilo.list<br>deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> trusty-updates/kilo main<br>deb-src <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> trusty-updates/kilo main</p>
<p>sudo rm /var/lib/apt/lists/* -vf &amp;&amp; sudo apt-get update</p>
<p>rmadison libvirt</p>
<p>sudo apt-cache madison nova-compute  #See all versions<br>sudo apt-get source nova=1:2015.1.2-0ubuntu2~cloud</p>
<p>其中get-get source相当于:</p>
<p>#<a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+packages?field.name_filter=qemu&amp;field.status_filter=superseded&amp;field.series_filter=" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+packages?field.name_filter=qemu&amp;field.status_filter=superseded&amp;field.series_filter=</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg.orig.tar.xz" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg.orig.tar.xz</a><br>dpkg-source -x qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</p>
<p>Patch package<br>1, quilt configuration<br>   a, sudo apt-get install quilt devscripts dh-make<br>   b, Export to bash env<br>      export QUILT_PATCHES=debian/patches<br>      export QUILT_NO_DIFF_INDEX=1<br>      export QUILT_NO_DIFF_TIMESTAMPS=1<br>      export QUILT_REFRESH_ARGS=”-p ab”<br>      export QUILT_PATCHES=debian/patches<br>      export QUILT_REFRESH_ARGS=”-p ab –no-timestamps –no-index”</p>
<p>#git format-patch -1 2150d5d8e17323bc9fce11903da3afffda211d26<br>quilt import /bak/openstack/nova/0001-pci-eliminate-DB-lookup-PCI-requests-during-claim.patch</p>
<p>   c, Creating a new patch.<br>      quilt new test.diff<br>      quilt add neutron/agent/linux/ovs_lib.py<br>      quilt refresh<br>      quilt rename -P test.diff test2.diff<br>      cat debian/patches/test.diff<br>      quilt pop -a</p>
<p>   d, For the exsiting patch,<br>      Put the patch into ‘./debian/patches’ directory<br>      Pppend it into ‘./debian/patch/series’ file<br>      Use ‘quilt push -a’ command to push all existing patches onto the source tree.<br>      quilt refresh</p>
<p>3, changelog<br>   dch -i #can be changed later by dch -e<br>   cat debian/changelog<br>   cat debian/copyright<br>   cat debian/rules<br>   cat debian/control</p>
<p>   ppa name format:  <customername>[-<openstack-version>|-<ubuntu-release>]<br>   changelog format: <upstream-version>hf<lp-bug-number>v<date>.<buildnum><br>   dch -b -Dprecise-updates -v1:2014.1.5-0ubuntu1.2hf123456v20150902.0<br>   nova (1:2014.1.5-0ubuntu1.2hf123456v20150902.0) precise-update; urgency=low</buildnum></date></lp-bug-number></upstream-version></ubuntu-release></openstack-version></customername></p>
<pre><code>* [HOTFIX] Fixes some catastrophic failure (LP: #123456)
  - blah blah blah
  - d/p/my-awesome-backport.patch
</code></pre><p>4, Edit ppa’s dependancy in ‘Edit PPA dependencies’ field.<br>   Eg:<br>   for Juno,    ~ubuntu-cloud-archive/ubuntu/juno-staging<br>   for grizzly, ~ubuntu-cloud-archive/grizzly-staging</p>
<p>5, Resolv the dependancy<br>   dpkg-checkbuilddeps</p>
<p>   add grizzly dependancy repository</p>
<p>   #sudo add-apt-repository ppa:ubuntu-cloud-archive/grizzly-staging<br>   deb <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu</a> precise main<br>   deb-src <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu</a> precise main<br>   sudo apt-get build-dep  quantum    # will read debian/control to resolv dependancy.<br>   sudo apt-get build-dep –no-install-recommends quantum</p>
<p>6, Build<br>   find . -name “*.pyc” -exec rm -rf {} \;</p>
<p>   #build signed source package<br>   debuild -S -k<your key="" here=""></your></p>
<p>   #build signed binary package<br>   debuild -b -k<your key="" here=""></your></p>
<p>   #build unsigned source package<br>   debuild -i -us -uc -S</p>
<p>   #build unsigned binary package which can be tested by the command ‘dpkg -i <pac>.deb’<br>   debuild -i -us -uc -b</pac></p>
<p>   debuild -S -sa –changes-option=-DDistribution=precise -k<gpgkey>  # -sa is used for including source code</gpgkey></p>
<h1 id="pdebuild-–debbuildopts-sa"><a href="#pdebuild-–debbuildopts-sa" class="headerlink" title="pdebuild –debbuildopts -sa"></a>pdebuild –debbuildopts -sa</h1><p>   #for openstack sru, 有时候这步不成功，需要先将patch用quilt格式化一下再用（quilt import, quilt push -a, quilt refresh)</p>
<p>   sudo apt install build-essential devscripts quilt dh-autoreconf fakeroot dpkg-dev python-sphinx</p>
<p>   gbp buildpackage -S -k$GPGKEY</p>
<p>   #gbp buildpackage -S -us -uc</p>
<p>2, debiandiff, 这步需要将老新build两次再用debdiff命令产生<br>   a, Use the existing debdiff, patch -p1 &lt; ../trusty.debdiff<br>   b, Create new debdiff, <a href="http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff" target="_blank" rel="external">http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff</a><br>      debuild -S                                              #build old source to generate dsc file<br>      debdiff old.dsc new.dsc                           #generate debdiff by comparing two sources</p>
<p>7, Upload to PPA<br>   export DEBEMAIL=<email><br>   export DEBFULLNAME=<name, e.g.="" "zhang"=""></name,></email></p>
<p>   #Test PPA can be created in <a href="https://launchpad.net/~zhhuabj/+activate-ppa" target="_blank" rel="external">https://launchpad.net/~zhhuabj/+activate-ppa</a><br>   dput -f ppa:zhhuabj/trusty-sru-testing test.changes</p>
<p>   #openstack sru</p>
<p>git push –all lp:~<launchpad-id>/ubuntu/+source/nova<br>git push –tags lp:~<launchpad-id>/ubuntu/+source/nova</launchpad-id></launchpad-id></p>
<p>如果用git的话，需要先在~/.git_config中添加：</p>
<p>[url “git+ssh://zhhuabj@git.launchpad.net/“]<br>        insteadof = lp:</p>
<p>然后执行：git push lp:~zhhuabj/ubuntu/+source/nova</p>
<p>最后访问： <a href="https://code.launchpad.net/~zhhuabj/ubuntu/+source/nova/+git/nova" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/ubuntu/+source/nova/+git/nova</a></p>
<p>8, sru进度查看</p>
<p>UA,    <a href="https://people.canonical.com/~ubuntu-archive/pending-sru.html" target="_blank" rel="external">https://people.canonical.com/~ubuntu-archive/pending-sru.html</a></p>
<p>UCA, reqorts.qa.ubuntu.com/reports/ubuntu-server/cloud-archive/kilo_versions.html</p>
<p>附录一，sbuild</p>
<p>#sbuild, <a href="https://wiki.ubuntu.com/SimpleSbuild" target="_blank" rel="external">https://wiki.ubuntu.com/SimpleSbuild</a></p>
<p>#sudo add-apt-repository cloud-archive:liberty<br>cat /etc/apt/sources.list.d/ubuntu-cloud-archive-liberty-staging-trusty.list</p>
<p>deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> liberty-updates/ubuntu main</p>
<h1 id="deb-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main"><a href="#deb-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main" class="headerlink" title="deb http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu trusty main"></a>deb <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu</a> trusty main</h1><h1 id="deb-src-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main"><a href="#deb-src-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main" class="headerlink" title="deb-src http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu trusty main"></a>deb-src <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu</a> trusty main</h1><p>schroot -l<br>schroot -c source:trusty-amd64 -u root         #这句会告成电脑没有声音，可以使用sudo killall pulseaudio解决<br>schroot -c trusty-amd64 -u root  #do work<br>apt-get build-dep libvirt-bin<br>sbuild -d trusty-amd64</p>
<p>附录二, pbuilder</p>
<p>#pbuilder <a href="https://wiki.ubuntu.com/PbuilderHowto" target="_blank" rel="external">https://wiki.ubuntu.com/PbuilderHowto</a>   <a href="http://www.cr173.com/html/28930_1.html" target="_blank" rel="external">http://www.cr173.com/html/28930_1.html</a><br>sudo apt-get install pbuilder debootstrap devscripts apt-cacher-ng<br>echo ‘Acquire::http::Proxy “<a href="http://127.0.0.1:3142" target="_blank" rel="external">http://127.0.0.1:3142</a>“;’ | sudo tee /etc/apt/apt.conf.d/01acng<br>$ sudo cat /etc/pbuilderrc<br>MIRRORSITE=<a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a><br>export http_proxy=<a href="http://127.0.0.1:3142/" target="_blank" rel="external">http://127.0.0.1:3142/</a><br>export http_proxys=<a href="http://127.0.0.1:3142/" target="_blank" rel="external">http://127.0.0.1:3142/</a></p>
<p>DEBFULLNAME=’xxx’<br>DEBEMAIL=’xxx@xxx.com’</p>
<p>DISTRIBUTION=’trusty’<br>OTHERMIRROR=”deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION} universe”<br>OTHERMIRROR+=”|deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION}-updates main universe”<br>OTHERMIRROR+=”|deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION}-proposed main”<br>EXTRAPACKAGES=’’<br>EXTRAPACKAGES+=’ vim sudo openssh-server bash-completion wget rsync git build-essential gdb crash apt-transport-https ca-certificates ubuntu-cloud-keyring’</p>
<h1 id="Cloud-Archive"><a href="#Cloud-Archive" class="headerlink" title="Cloud Archive"></a>Cloud Archive</h1><p>#OS_RELEASE=’liberty’</p>
<p>#OTHERMIRROR+=”|deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> $DISTRIBUTION-updates/$OS_RELEASE main”</p>
<p>if [ -n “$OS_RELEASE” ]; then<br>    BASETGZ=”/var/cache/pbuilder/$DISTRIBUTION-$OS_RELEASE-base.tgz”<br>else<br>    BASETGZ=”/var/cache/pbuilder/$DISTRIBUTION-base.tgz”<br>fi</p>
<p>#sudo pbuilder –create –distribution trusty –architecture amd64 –basetgz /images/pbuilder/trusty-amd64-base.tgz –debootstrapopts –variant=buildd<br>sudo pbuilder –create –distribution trusty –architecture amd64 –debootstrapopts –variant=buildd</p>
<p>sudo cp /var/cache/pbuilder/trusty-base.tgz /var/cache/pbuilder/trusty-liberty-base.tgz</p>
<p>then uncomment OS_RELEASE, run ‘sudo pbuilder update’ again</p>
<p>sudo pbuilder login –save-after-login  #equal to chroot</p>
<p>echo ‘precedence ::ffff:0:0/96 100’ &gt;&gt; /etc/gai.conf<br>root# Add UCA repository  to source.list,</p>
<pre><code># &apos;deb http://ubuntu-cloud.archive.canonical.com/ubuntu liberty-updates/ubuntu main&apos; &amp;&amp; apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8A6844A29F68104E

or apt-get install software-properties-common python-software-properties  &amp;&amp;  add-apt-repository cloud-archive:liberty
</code></pre><p>root# apt update</p>
<p>then exit chroot, press ctrl-d to save</p>
<p>#schroot -c trusty-amd64 -p apt update</p>
<p>#it’s more safer to use the following chroot instead of above ‘pbulider login’ and ‘schroot’ to modify chroot env</p>
<p>LANG=C DEBIAN_FRONTEND=noninteractive chroot /var/lib/schroot/chroots/trusty-amd64 bash -c ‘apt-get update’<br>echo ‘hua     ALL=(ALL) NOPASSWD:ALL’ |sudo tee -a /var/lib/schroot/chroots/trusty-amd64/etc/sudoers</p>
<p>sudo pbuilder update   #run again when building the package every time</p>
<p>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.dsc" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.dsc</a><br>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14.orig.tar.gz" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14.orig.tar.gz</a><br>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.debian.tar.xz" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.debian.tar.xz</a></p>
<p>#注意：上面的是debian包，需要先使用beyond compare工具和ubuntu的1.2.16对debian目录进行比较转化成ubuntu包，转换规则是：</p>
<p>1， 凡1.2.14有的，1.2.16没有的，删</p>
<p>2， 凡1.2.14没有的，1.2.16有的，增</p>
<p>3， 凡1.2.14与1.2.16不一致的以1.2.16为准</p>
<p>4， debian/patch和debian/changlog可以不作处理</p>
<p>5， debian/control也是重点</p>
<p>#sudo pbuilder –build –distribution trusty –architecture amd64 ./libvirt_1.2.14-3.dsc</p>
<p>dpkg-source -x libvirt_1.2.14-3.dsc &amp;&amp; cd libvirt-1.2.14</p>
<h1 id="sudo-pdebuild"><a href="#sudo-pdebuild" class="headerlink" title="sudo pdebuild"></a>sudo pdebuild</h1><p>sudo pdebuild –debbuildopts -sa  # sometimes need to include source code for uca</p>
<h1 id="you’d-better-not-add-sudo"><a href="#you’d-better-not-add-sudo" class="headerlink" title="you’d better not add sudo"></a>you’d better not add sudo</h1><p>debsign /var/cache/pbuilder/result/<package><em><version>.changes -k$GPGKEY<br>dput ppa:techtonik/backports /var/cache/pbuilder/result/<package></package></version></em><version>.changes</version></package></p>
<p>sudo apt-get autoclean<br>sudo apt-get update<br>sudo apt-get -f install</p>
<p>sudo apt update</p>
<p>cat /etc/apt/source.list</p>
<p>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial main restricted universe multiverse<br>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial-updates main restricted universe multiverse<br>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial-proposed main restricted universe multiverse<br>deb <a href="http://security.ubuntu.com/ubuntu" target="_blank" rel="external">http://security.ubuntu.com/ubuntu</a> xenial-security main restricted universe multiverse</p>
<p>#deb-src <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> trusty main</p>
<h2 id="ubuntu-ddebs"><a href="#ubuntu-ddebs" class="headerlink" title="ubuntu ddebs"></a>ubuntu ddebs</h2><h1 id="deb-http-ddebs-ubuntu-com-xenial-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-updates-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-updates-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-updates main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-updates main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-proposed-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-proposed-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-proposed main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-proposed main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-security-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-security-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-security main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-security main restricted universe multiverse</h1><h2 id="kernel-ppa"><a href="#kernel-ppa" class="headerlink" title="kernel ppa"></a>kernel ppa</h2><h1 id="deb-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main"><a href="#deb-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main" class="headerlink" title="deb http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu xenial main"></a>deb <a href="http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu</a> xenial main</h1><h1 id="deb-src-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main"><a href="#deb-src-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main" class="headerlink" title="deb-src http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu xenial main"></a>deb-src <a href="http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu</a> xenial main</h1><p>附录 - 如何修改ubuntu-installer</p>
<p>Ubuntu有两个Installer [3], 一个是修改版的Debian Installer <a href="也叫d-i, 用C/bash写的">2</a>, 一个用于desktop CD安装的Ubiquity[1] (前端用python写的，后端还是d-i, ‘bzr branch <a href="http://bazaar.launchpad.net/~ubuntu-installer/ubiquity/trunk‘)。" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-installer/ubiquity/trunk‘)。</a><br>例如，要修改ubiquity源码(sudo apt-get source ubiquity)下的./d-i/source/preseed/debian/network-preseed.postinst文件，先从<a href="https://launchpad.net/d-i(debian对应的链接是https://anonscm.debian.org/cgit/d-i/）找到ubuntu修改后的d-i应该对应preseed，然后找到对应的源码为http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">https://launchpad.net/d-i(debian对应的链接是https://anonscm.debian.org/cgit/d-i/）找到ubuntu修改后的d-i应该对应preseed，然后找到对应的源码为http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst</a> (也可通过’bzr branch lp:preseed’或’bzr branch lp:~ubuntu-core-dev/preseed/ubuntu’命令下载源码).<br>sudo apt-get source preseed<br>bzr branch <a href="http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu</a></p>
<p>那么如何将修改的preseed debdiff生成iso文件呢？只需要先将preseed dput到ppa (preseed是没有patchless的，直接修改要修改的文件即可), 等它build完成之后然后再将debian-installer (sudo apt-get source debain-installer，不需要修改源文件，只需要在changelog中增加版本号) dput到ppa即可。等 build完之后便可以生成mini.iso ( <a href="http://ppa.launchpad.net/zhhuabj/xenial-sru-testing/ubuntu/dists/xenial/main/installer-amd64/20101020ubuntu451.19/images/netboot/mini.iso" target="_blank" rel="external">http://ppa.launchpad.net/zhhuabj/xenial-sru-testing/ubuntu/dists/xenial/main/installer-amd64/20101020ubuntu451.19/images/netboot/mini.iso</a> )。</p>
<p>如何测试这个mini.iso呢？和测试full iso的方法一样，启动后在选择语言处按TAB键(full iso是按F6键)进入grub菜单，然后添加url=<a href="http://192.168.99.135/xenial.preseed即可。在正式版出来之前只能使用mini.iso，full" target="_blank" rel="external">http://192.168.99.135/xenial.preseed即可。在正式版出来之前只能使用mini.iso，full</a> iso的日期可参见：<a href="https://wiki.ubuntu.com/BionicBeaver/ReleaseSchedule" target="_blank" rel="external">https://wiki.ubuntu.com/BionicBeaver/ReleaseSchedule</a></p>
<p>[1] <a href="https://code.launchpad.net/~ubuntu-installer/ubiquity/trunk" target="_blank" rel="external">https://code.launchpad.net/~ubuntu-installer/ubiquity/trunk</a><br>[2] <a href="http://d-i.alioth.debian.org/doc/talks/debconf6/paper/" target="_blank" rel="external">http://d-i.alioth.debian.org/doc/talks/debconf6/paper/</a><br>[3] <a href="https://wiki.ubuntu.com/Installer/Development" target="_blank" rel="external">https://wiki.ubuntu.com/Installer/Development</a><br>[4] <a href="http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu/view/head:/debian/network-preseed.postinst</a><br>[5] <a href="http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst</a><br>[6] <a href="https://anonscm.debian.org/cgit/d-i/preseed.git/tree/debian/network-preseed.postinst" target="_blank" rel="external">https://anonscm.debian.org/cgit/d-i/preseed.git/tree/debian/network-preseed.postinst</a></p>
<p>附录： How to use schroot to enter a chroot without using sudo</p>
<p>sudo apt install -y schroot sbuild debhelper ubuntu-dev-tools piuparts<br>sudo mkdir -p /var/lib/schroot/chroots/trusty-amd64<br>sudo cp /etc/schroot/schroot.conf /etc/schroot/schroot.conf.old<br>sudo debootstrap –include=sudo,bash-completion,kernel-wedge,fakeroot,git,vim,bc,gawk,libncurses5-dev,libssl-dev,openssl,build-essential,rsync –arch=amd64 trusty /var/lib/schroot/chroots/trusty-amd64 <a href="http://archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://archive.ubuntu.com/ubuntu/</a></p>
<p>#sudo pbuilder login –save-after-login</p>
<p>#schroot -c trusty-amd64 -p apt update</p>
<p>#it’s more safer to use the following chroot instead of above ‘pbulider login’ and ‘schroot’ to modify chroot env</p>
<p>LANG=C DEBIAN_FRONTEND=noninteractive chroot /var/lib/schroot/chroots/trusty-amd64 bash -c ‘apt-get update’<br>echo ‘hua     ALL=(ALL) NOPASSWD:ALL’ |sudo tee -a /var/lib/schroot/chroots/trusty-amd64/etc/sudoers</p>
<p>vi /etc/schroot/chroot.d/sbuild-trusty-amd64<br>[trusty-amd64]<br>description=trusty-amd64</p>
<h1 id="To-avoid-the-error-‘You-do-not-have-permission-to-access-the-schroot-service’"><a href="#To-avoid-the-error-‘You-do-not-have-permission-to-access-the-schroot-service’" class="headerlink" title="To avoid the error ‘You do not have permission to access the schroot service’"></a>To avoid the error ‘You do not have permission to access the schroot service’</h1><p>users=hua<br>groups=sbuild,root,admin<br>root-groups=sbuild,root,admin</p>
<h1 id="Uncomment-these-lines-to-allow-members-of-these-groups-to-access"><a href="#Uncomment-these-lines-to-allow-members-of-these-groups-to-access" class="headerlink" title="Uncomment these lines to allow members of these groups to access"></a>Uncomment these lines to allow members of these groups to access</h1><h1 id="the-source-chroots-directly-useful-for-automated-updates-etc"><a href="#the-source-chroots-directly-useful-for-automated-updates-etc" class="headerlink" title="the -source chroots directly (useful for automated updates, etc)."></a>the -source chroots directly (useful for automated updates, etc).</h1><p>#source-root-users=sbuild,root,admin</p>
<p>#source-root-groups=sbuild,root,admin<br>type=directory<br>profile=default<br>union-type=overlayfs</p>
<h1 id="We-can-also-use-the-chroot-which-is-created-by-pbuilder-eg-tar-xf-var-cache-pbuilder-trusty-base-tgz"><a href="#We-can-also-use-the-chroot-which-is-created-by-pbuilder-eg-tar-xf-var-cache-pbuilder-trusty-base-tgz" class="headerlink" title="We can also use the chroot which is created by pbuilder. eg: tar -xf /var/cache/pbuilder/trusty-base.tgz"></a>We can also use the chroot which is created by pbuilder. eg: tar -xf /var/cache/pbuilder/trusty-base.tgz</h1><p>directory=/var/lib/schroot/chroots/trusty-amd64<br>source-root-users=root,sbuild,admin<br>source-root-groups=root,sbuild,admin<br>preserve-environment=true</p>
<h1 id="https-blog-csdn-net-fenglailea-article-details-37035995"><a href="#https-blog-csdn-net-fenglailea-article-details-37035995" class="headerlink" title="https://blog.csdn.net/fenglailea/article/details/37035995"></a><a href="https://blog.csdn.net/fenglailea/article/details/37035995" target="_blank" rel="external">https://blog.csdn.net/fenglailea/article/details/37035995</a></h1><p>sudo groupadd admin<br>sudo adduser $USER admin<br>schroot -l<br>schroot -c trusty-amd64<br>schroot -c trusty-amd64 – cmd …</p>
<p>#export $(dpkg-architecture -aarm64); export CROSS_COMPILE=aarch64-linux-gnu-</p>
<p>#fakeroot debian/rules clean binary-generic</p>
<p>附录 - The best solution to fix broken ubuntu package</p>
<p>sudo apt update –fix-missing<br>hua@t440p:~$ sudo dpkg –configure -a<br>dpkg: dependency problems prevent configuration of bpfcc-tools:<br> bpfcc-tools depends on python-bpfcc (&gt;= 0.5.0-5ubuntu1); however:<br>  Package python-bpfcc is not installed.<br>dpkg: error processing package bpfcc-tools (–configure):<br> dependency problems - leaving unconfigured<br>Errors were encountered while processing:<br> bpfcc-tools</p>
<p>#Remove python-bpfcc and bpfcc-tools from the file /var/lib/dpkg/status<br>sudo vim /var/lib/dpkg/status</p>
<p>#then run<br>sudo fuser -vki /var/lib/dpkg/lock<br>sudo dpkg –configure -a</p>
<p>Reference<br>1, <a href="https://help.launchpad.net/Packaging/UploadErrors" target="_blank" rel="external">https://help.launchpad.net/Packaging/UploadErrors</a><br>2, <a href="https://wiki.canonical.com/STS/Engineering/Hotfix" target="_blank" rel="external">https://wiki.canonical.com/STS/Engineering/Hotfix</a><br>3, <a href="http://packaging.ubuntu.com/html/fixing-a-bug.html#work-on-a-fix" target="_blank" rel="external">http://packaging.ubuntu.com/html/fixing-a-bug.html#work-on-a-fix</a><br>4, <a href="http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff" target="_blank" rel="external">http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff</a><br>5, <a href="http://blog.packagecloud.io/debian/debuild/packaging/2015/06/08/buildling-deb-packages-with-debuild/" target="_blank" rel="external">http://blog.packagecloud.io/debian/debuild/packaging/2015/06/08/buildling-deb-packages-with-debuild/</a></p>
<p>6, <a href="https://wiki.ubuntu.com/OpenStack/StableReleaseUpdates" target="_blank" rel="external">https://wiki.ubuntu.com/OpenStack/StableReleaseUpdates</a><br>7, <a href="https://wiki.ubuntu.com/OpenStack/CorePackages" target="_blank" rel="external">https://wiki.ubuntu.com/OpenStack/CorePackages</a><br>8, <a href="https://wiki.ubuntu.com/ServerTeam/OpenStack/SRUCadence" target="_blank" rel="external">https://wiki.ubuntu.com/ServerTeam/OpenStack/SRUCadence</a></p>
<p>9, <a href="https://wiki.ubuntu.com/SimpleSbuild#" target="_blank" rel="external">https://wiki.ubuntu.com/SimpleSbuild#</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/24/How-to-make-pure-text-presentation-ppt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/24/How-to-make-pure-text-presentation-ppt/" itemprop="url">How to make pure text presentation/ppt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-24T18:13:57+08:00">
                2019-12-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="vim-more"><a href="#vim-more" class="headerlink" title="vim + more"></a>vim + more</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^L                   #press i to enter edit mode, then press Ctrl+L to inut ^L</span><br><span class="line">more -p  test.txt</span><br><span class="line"></span><br><span class="line">:set textwidth=70</span><br><span class="line">#for the existing lines</span><br><span class="line">v</span><br><span class="line">gq</span><br></pre></td></tr></table></figure>
<h2 id="markdown-marp"><a href="#markdown-marp" class="headerlink" title="markdown/marp"></a>markdown/marp</h2><p><a href="https://web.marp.app/" target="_blank" rel="external">https://web.marp.app/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- page_number: true --&gt;</span><br><span class="line"></span><br><span class="line"># 一级标题</span><br><span class="line">## 二级标题</span><br><span class="line">**重点**</span><br><span class="line"></span><br><span class="line">- 列表1</span><br><span class="line">- 列表2</span><br><span class="line"></span><br><span class="line">![](图片url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">Next Page</span><br></pre></td></tr></table></figure>
<h2 id="查看本地md文件"><a href="#查看本地md文件" class="headerlink" title="查看本地md文件"></a>查看本地md文件</h2><p>sudo pip install markdownserver<br>cd onedir then run:  sudo markdownserver<br>then visit: <a href="http://localhost:8009/index.md" target="_blank" rel="external">http://localhost:8009/index.md</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/" itemprop="url">How to test Neutron VRRP HA rapidly</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-09T13:03:23+08:00">
                2019-11-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2015-12-09<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</p>
<p>(<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>neutron vrrp ha still do not support conntrack feature now.</p>
<p>1, Setting up test environment</p>
<p>juju add-model queens-vrrp<br>juju deploy ./b/openstack.yaml</p>
<p>juju add-unit neutron-gateway<br>juju ssh neutron-gateway/1 – hostname<br>source ~/novarc &amp;&amp; nova interface-attach $(openstack server list -f value |awk ‘/juju-4262ae-queens-vrrp-10/ {print $1}’) –net-id=$(openstack network list -f value |awk ‘/ zhhuabj_admin_net / {print $1}’)<br>juju ssh neutron-gateway/1 – sudo ovs-vsctl add-port br-data ens7<br>juju ssh neutron-gateway/1 – sudo ifconfig ens7 up<br>juju config neutron-api overlay-network-type=vxlan<br>juju config neutron-api enable-l3ha=true</p>
<p>./configure<br>source ~/stsstack-bundles/novarc<br>./tools/instance_launch.sh 1 xenial<br>./tools/sec_groups.sh</p>
<p>fix_ip=$(openstack server list -f value |awk ‘/xenial/ {print $4}’ |awk -F ‘=’ ‘{print $2}’)<br>public_network=$(openstack network show ext_net -f value -c id)<br>fip=$(openstack floating ip create $public_network -f value -c floating_ip_address)<br>openstack floating ip set $fip –fixed-ip-address $fix_ip –port $(openstack port list –fixed-ip ip-address=$fix_ip -c id -f value)</p>
<h1 id="update-the-existing-router-as-ha-router"><a href="#update-the-existing-router-as-ha-router" class="headerlink" title="update the existing router as ha router"></a>update the existing router as ha router</h1><p>#ROUTER_ID=$(neutron router-show provider-router -c id -f value)</p>
<p>#neutron router-update $ROUTER_ID –admin_state_up=false ; neutron router-update $ROUTER_ID –ha=true; neutron router-update $ROUTER_ID –admin_state_up=true</p>
<p>#AGENT_ID=$(neutron l3-agent-list-hosting-router $ROUTER_ID |grep active |awk -F ‘|’ ‘{print $2}’)</p>
<p>#neutron l3-agent-router-remove $AGENT_ID $ROUTER_ID</p>
<p>#neutron l3-agent-router-add $AGENT_ID $ROUTER_ID</p>
<h1 id="enable-dvr"><a href="#enable-dvr" class="headerlink" title="enable dvr"></a>enable dvr</h1><p>#juju config neutron-api l2-population=false enable-l3ha=true</p>
<p>#neutron router-update –admin-state-up False provider-router</p>
<p>#neutron router-update provider-router –distributed True –ha=True</p>
<p>#neutron router-update –admin-state-up True provider-router</p>
<h1 id="test-patch-https-review-opendev-org-c-601533"><a href="#test-patch-https-review-opendev-org-c-601533" class="headerlink" title="test patch - https://review.opendev.org/#/c/601533/"></a>test patch - <a href="https://review.opendev.org/#/c/601533/" target="_blank" rel="external">https://review.opendev.org/#/c/601533/</a></h1><p>git clone <a href="https://github.com/openstack/charm-neutron-gateway.git" target="_blank" rel="external">https://github.com/openstack/charm-neutron-gateway.git</a> neutron-gateway<br>cd neutron-gateway/<br>git fetch <a href="https://review.opendev.org/openstack/charm-neutron-gateway" target="_blank" rel="external">https://review.opendev.org/openstack/charm-neutron-gateway</a> refs/changes/33/601533/1 &amp;&amp; git format-patch -1 –stdout FETCH_HEAD &gt; lp1732154.patch<br>git checkout master<br>patch -p1 &lt; lp1732154.patch<br>juju upgrade-charm neutron-gateway –path $PWD</p>
<p>wget <a href="https://gist.githubusercontent.com/dosaboy/cf8422f16605a76affa69a8db47f0897/raw/8e045160440ecf0f9dc580c8927b2bff9e9139f6/check_router_vrrp_transitions.sh" target="_blank" rel="external">https://gist.githubusercontent.com/dosaboy/cf8422f16605a76affa69a8db47f0897/raw/8e045160440ecf0f9dc580c8927b2bff9e9139f6/check_router_vrrp_transitions.sh</a><br>chmod +x check_router_vrrp_transitions.sh<br>./check_router_vrrp_transitions.sh</p>
<p>ubuntu@juju-4262ae-queens-vrrp-5:~$ bash check_router_vrrp_transitions.sh<br>Analysing keepalived vrrp transitions…1 active vrouters found (total 1):<br>router=b8d4435b-bd83-46fd-a828-6d8a0b52d23a (current=false, vrid=VR_1, pid=16716, first=Apr-23-01:48:20, last=Apr-23-01:57:05) had 2 transition(s)<br>router=b8d4435b-bd83-46fd-a828-6d8a0b52d23a (current=true, vrid=VR_1, pid=24269, first=Apr-23-02:22:16, last=Apr-23-02:22:28) had 2 transition(s) (state=MASTER)</p>
<p>Done.</p>
<p>ubuntu@zhhuabj-bastion:~$ juju ssh neutron-gateway/0 – sudo cat /var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/ha_check_script_1.sh</p>
<p>#!/bin/bash -eu<br>ip a | grep fe80::f816:3eff:fe2d:db49 || exit 0<br>ping -c 1 -w 1 10.5.0.1 1&gt;/dev/null || exit 1</p>
<p>ubuntu@zhhuabj-bastion:~$ juju ssh neutron-gateway/0 – cat /var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/keepalived.conf<br>global_defs {<br>    notification_email_from neutron@openstack.local<br>    router_id neutron<br>}</p>
<p>vrrp_script ha_health_check_1 {<br>    script “/var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/ha_check_script_1.sh”<br>    interval 30<br>    fall 2<br>    rise 2<br>}</p>
<p>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-c172aff0-67<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_delay 60<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-c172aff0-67<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-c172aff0-67<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aa1ed68a-d0<br>        10.5.150.2/32 dev qg-aa1ed68a-d0<br>        192.168.21.1/24 dev qr-00aa8199-1d<br>        fe80::f816:3eff:fe2d:db49/64 dev qr-00aa8199-1d scope link<br>        fe80::f816:3eff:feeb:a6de/64 dev qg-aa1ed68a-d0 scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aa1ed68a-d0<br>    }<br>    track_script {<br>        ha_health_check_1<br>    }<br>}</p>
<p>Some important configurations in neutron.conf are as below:<br>l3_ha = True<br>max_l3_agents_per_router = 2<br>min_l3_agents_per_router = 2<br>allow_automatic_l3agent_failover = False</p>
<p>2, Future Work &amp; Limitations<br><a href="http://assafmuller.com/2014/08/16/layer-3-high-availability/" target="_blank" rel="external">http://assafmuller.com/2014/08/16/layer-3-high-availability/</a><br><a href="http://blog.aaronorosen.com/implementing-high-availability-instances-with-neutron-using-vrrp/" target="_blank" rel="external">http://blog.aaronorosen.com/implementing-high-availability-instances-with-neutron-using-vrrp/</a></p>
<p>TCP connection tracking – With the current implementation, TCP sessions are broken on failover. The idea is to use conntrackd in order to replicate the session states across HA routers, so that when the failover finishes, TCP sessions will continue where they left off.<br>Where is the master instance hosted? As it is now it is impossible for the admin to know which network node is hosting the master instance of a HA router. The plan is for the agents to report this information and for the server to expose it via the API.<br>Evacuating an agent – Ideally bringing down a node for maintenance should cause all of the HA router instances on said node to relinquish their master states, speeding up the failover process.<br>Notifying L2pop of VIP movements – Consider the IP/MAC of the router on a tenant network. Only the master instance will actually have the IP configured, but the same Neutron port and same MAC will show up on all participating network nodes. This might have adverse effects on the L2pop mechanism driver, as it expects a MAC address in a single location in the network. The plan to solve this deficiency is to send an RPC message from the agent whenever it detects a VRRP state change, so that when a router becomes the master, the controller is notified, which can then update the L2pop state.<br>FW, VPN and LB as a service integration. Both DVR and L3 HA have issues integrating with the advanced services, and a more serious look will be taken during the Kilo cycle.<br>One HA network per tenant. This implies a limit of 255 HA routers per tenant, as each router takes up a VRID, and the VRRP protocol allows 255 distinct VRID values in a single broadcast domain.</p>
<p>3, Test steps and data</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ neutron net-list<br>+————————————–+—————————————————-+——————————————————-+<br>| id                                   | name                                               | subnets                                               |<br>+————————————–+—————————————————-+——————————————————-+<br>| 70773c83-08fe-4efe-b601-4f04522d867f | ext_net                                            | 6aed68fb-be4a-4a33-b53e-c2b742ac9985 10.5.0.0/16      |<br>| 98e10e32-13eb-48ee-b265-4ae0e449b6e5 | private                                            | b6afcd08-f3b6-4224-a125-3befa4b34a63 192.168.21.0/24  |<br>| bc699825-19e1-4bf6-a0cf-fe90251ad391 | HA network tenant b31bb0f325fd4ec291a5a65d3dc11a63 | 20173269-0eb4-4f3f-9557-807c69f6e258 169.254.192.0/18 |<br>+————————————–+—————————————————-+——————————————————-+</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ neutron router-list<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>| id                                   | name            | external_gateway_info                                                                                                                                                                  |<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>| dd74a4c6-8320-40d6-b3b1-232e578cb6c7 | provider-router | {“network_id”: “70773c83-08fe-4efe-b601-4f04522d867f”, “enable_snat”: true, “external_fixed_ips”: [{“subnet_id”: “6aed68fb-be4a-4a33-b53e-c2b742ac9985”, “ip_address”: “10.5.150.0”}]} |<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>ubuntu@zhhuabj-bastion:~/neutron-gateway-ha$ neutron l3-agent-list-hosting-router provider-router<br>+————————————–+————————-+—————-+——-+<br>| id                                   | host                    | admin_state_up | alive |<br>+————————————–+————————-+—————-+——-+<br>| 99ca5ee5-33b6-43da-86e2-df1f16fbd7cb | juju-zhhuabj-machine-23 | True           | :-)   |<br>| c95e33d5-b080-458c-8adb-d15bafc16bfb | juju-zhhuabj-machine-12 | True           | :-)   |<br>+————————————–+————————-+—————-+——-+</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ nova list<br>+————————————–+——+——–+————+————-+———————————-+<br>| ID                                   | Name | Status | Task State | Power State | Networks                         |<br>+————————————–+——+——–+————+————-+———————————-+<br>| ebfe6140-580c-43dd-b582-5e708eba58d8 | i1   | ACTIVE | -          | Running     | private=192.168.21.5, 10.5.150.1 |<br>+————————————–+——+——–+————+————-+———————————-+</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>2: ha-786d2e2f-a8: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:f5:c4:16 brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.2/18 brd 169.254.255.255 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>    inet 169.254.0.1/24 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fef5:c416/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.21.1/24 scope global qr-de8b99fa-7c<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe9f:a31b/64 scope link<br>       valid_lft forever preferred_lft forever<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff<br>    inet 10.5.150.0/16 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet 10.5.150.1/32 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe13:a924/64 scope link<br>       valid_lft forever preferred_lft forever</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>2: ha-37f7144e-02: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:04:b4:ce brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.1/18 brd 169.254.255.255 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe04:b4ce/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.5.0.1        0.0.0.0         UG    0      0        0 qg-aeb51a1d-32<br>10.5.0.0        0.0.0.0         255.255.0.0     U     0      0        0 qg-aeb51a1d-32<br>169.254.0.0     0.0.0.0         255.255.255.0   U     0      0        0 ha-786d2e2f-a8<br>169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-786d2e2f-a8<br>192.168.21.0    0.0.0.0         255.255.255.0   U     0      0        0 qr-de8b99fa-7c</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-37f7144e-02</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ ps -ef|grep ha<br>root        71     2  0 06:55 ?        00:00:00 [charger_manager]<br>neutron   5597     1  0 08:14 ?        00:00:00 /usr/bin/python /usr/bin/neutron-keepalived-state-change –router_id=dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –namespace=qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –conf_dir=/var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –monitor_interface=ha-786d2e2f-a8 –monitor_cidr=169.254.0.1/24 –pid_file=/var/lib/neutron/external/pids/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.monitor.pid –state_path=/var/lib/neutron –user=108 –group=112<br>root      5649     1  0 08:14 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp<br>root     11780  5649  0 09:02 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ ps -ef |grep ha<br>root        71     2  0 07:09 ?        00:00:00 [charger_manager]<br>root      6060 32207  0 09:02 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp<br>neutron  32142     1  0 08:14 ?        00:00:00 /usr/bin/python /usr/bin/neutron-keepalived-state-change –router_id=dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –namespace=qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –conf_dir=/var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –monitor_interface=ha-37f7144e-02 –monitor_cidr=169.254.0.1/24 –pid_file=/var/lib/neutron/external/pids/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.monitor.pid –state_path=/var/lib/neutron –user=108 –group=112<br>root     32207     1  0 08:14 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/state<br>master<br>ubuntu@juju-zhhuabj-machine-12:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf<br>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-786d2e2f-a8<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_repeat 5<br>    garp_master_refresh 10<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-786d2e2f-a8<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-786d2e2f-a8<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aeb51a1d-32<br>        10.5.150.1/32 dev qg-aeb51a1d-32<br>        192.168.21.1/24 dev qr-de8b99fa-7c<br>        fe80::f816:3eff:fe13:a924/64 dev qg-aeb51a1d-32 scope link<br>        fe80::f816:3eff:fe9f:a31b/64 dev qr-de8b99fa-7c scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aeb51a1d-32<br>    }<br>}</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/state<br>backup<br>ubuntu@juju-zhhuabj-machine-23:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf<br>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-37f7144e-02<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_repeat 5<br>    garp_master_refresh 10<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-37f7144e-02<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-37f7144e-02<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aeb51a1d-32<br>        10.5.150.1/32 dev qg-aeb51a1d-32<br>        192.168.21.1/24 dev qr-de8b99fa-7c<br>        fe80::f816:3eff:fe13:a924/64 dev qg-aeb51a1d-32 scope link<br>        fe80::f816:3eff:fe9f:a31b/64 dev qr-de8b99fa-7c scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aeb51a1d-32<br>    }<br>}</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ifconfig ha-786d2e2f-a8 down</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state UNKNOWN group default<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>2: ha-786d2e2f-a8: <broadcast,multicast> mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000<br>    link/ether fa:16:3e:f5:c4:16 brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.2/18 brd 169.254.255.255 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast></loopback,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state UNKNOWN group default<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>2: ha-37f7144e-02: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:04:b4:ce brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.1/18 brd 169.254.255.255 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet 169.254.0.1/24 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe04:b4ce/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.21.1/24 scope global qr-de8b99fa-7c<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe9f:a31b/64 scope link<br>       valid_lft forever preferred_lft forever<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff<br>    inet 10.5.150.0/16 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet 10.5.150.1/32 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe13:a924/64 scope link<br>       valid_lft forever preferred_lft forever</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></loopback,up,lower_up></p>
<p>ubuntu@zhhuabj-bastion:~/neutron-gateway-ha$ ping 10.5.150.1<br>PING 10.5.150.1 (10.5.150.1) 56(84) bytes of data.<br>64 bytes from 10.5.150.1: icmp_seq=1 ttl=63 time=5.00 ms<br>64 bytes from 10.5.150.1: icmp_seq=2 ttl=63 time=1.69 ms</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 tcpdump -n -i ha-37f7144e-02<br>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<br>listening on ha-37f7144e-02, link-type EN10MB (Ethernet), capture size 65535 bytes<br>03:59:45.723931 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:47.724833 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:49.727033 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:51.726947 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:53.728466 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:55.730700 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:57.731620 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:59.733136 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:01.734053 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:03.734711 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:05.737778 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:07.737146 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:09.739794 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:11.739332 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:13.740744 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:15.742741 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:17.744151 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:19.745413 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:21.746639 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:23.748244 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:25.750017 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:27.751713 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:29.752460 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:31.753797 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:33.755248 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:35.757904 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:37.759372 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:39.760449 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:41.761482 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:43.762326 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:45.764282 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:47.763669 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:49.764741 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:56.570867 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:58.572437 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572504 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572542 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572581 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572609 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572665 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:00.573412 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:02.574520 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:03.573747 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573850 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573898 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573948 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573993 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:04.575330 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:06.576547 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:08.577765 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:10.578863 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:12.579946 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:14.581031 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:16.582120 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:18.583161 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:20.584254 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:22.585400 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:24.586493 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:26.587590 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:28.588677 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:30.589448 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:32.590557 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:34.591728 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:36.592887 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:38.594052 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:40.595402 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:42.596719 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:44.597883 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:46.599080 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:48.600390 IP 169.2</p>
<p>20160304更新</p>
<p>Keepalived有一个bug，在配置改变时会做一个不必要的dns查询操作(可使用命令ip netns exec qrouter-xxx  tcpdump -vvv -s 0 -l -n port 53查看），如果qrouter-名空间无法访问dns服务器的话会造成master节点在做dns查询时block一分钟左右，这个时间backup结点会变成master节点。见Bug:</p>
<p> <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1181592" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1181592</a> </p>
<p><a href="https://bugs.launchpad.net/neutron/+bug/1511722" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1511722</a></p>
<p>Workaround是添加hostname:</p>
<p>dig A $(hostname) | grep -A1 “ANSWER SEC” | tail -n 1 | awk ‘{print $NF “ “ $1}’ | sed -e ‘s/.$//g’  &gt;&gt;/etc/hosts ;   grep $(hostname) /etc/hosts || echo “Failure setting up the hostname entry”</p>
<p>另一些bug (ha接口已经变成active之后再加keepalived, 这样neutron-keepalived-state-change进程的’ip netns exec xxx ip -o monitor address’感知到ha-xxx口的变化后通知neutron-server将router变成master): </p>
<p>20171215更新</p>
<p>一个实际的case，遇到了multi-active或者全部是standby的问题，问题最后查出来包括：</p>
<p>1, l3-agent上的router过多时在syslog中会看到如下错误，除了按下列的步骤增大ulimit，也可能需要设置ovs_vsctl_timeout=60 (20111108更新, of_inactivity_probe也是一个参数, 见- <a href="https://review.opendev.org/#/c/660074/" target="_blank" rel="external">https://review.opendev.org/#/c/660074/</a>) (20111109更新, 另一个参数是mac-table-size, <a href="https://bugs.launchpad.net/neutron/+bug/1775797)，另外将ovs将cpu核绑定" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1775797)，另外将ovs将cpu核绑定</a><br>“hostname ovs-vswitchd: ovs|1762125|netlink_socket|ERR|fcntl: Too many open files”<br>sudo lsof -p 2279  #the file num opened by a process<br>sudo prlimit -p 2279 –nofile=131070  #If need to persistence it, pls modify /etc/security/limits.d/ovs.conf</p>
<p>cat /etc/security/limits.d/ovs.conf</p>
<p>root soft nofile 131070<br>root hard nofile 1048576 </p>
<p>2, rabbitmq cluster有性能问题，暂时改一non-cluster rabbitmq</p>
<p>3, 修改后，router的状态并不会自己同时，因为如果之前是rabbitmq的问题，neutron-keepalived-state-change通过ip monitor监控到vrrp vip变化的event丢失，rabbitmq恢复后，这个event可能不会再发一遍（<a href="https://github.com/openstack/neutron/blob/stable/ocata/neutron/agent/l3/keepalived_state_change.py#L71）所以也需要重启l3-agent" target="_blank" rel="external">https://github.com/openstack/neutron/blob/stable/ocata/neutron/agent/l3/keepalived_state_change.py#L71）所以也需要重启l3-agent</a></p>
<p>4， 下面这些fixed patches也都是必须的</p>
<p><a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a><br><a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a><br><a href="https://review.openstack.org/#/c/454657/" target="_blank" rel="external">https://review.openstack.org/#/c/454657/</a><br><a href="https://review.openstack.org/522792" target="_blank" rel="external">https://review.openstack.org/522792</a>       (ocata)</p>
<p><a href="https://review.openstack.org/#/c/522641" target="_blank" rel="external">https://review.openstack.org/#/c/522641</a></p>
<p>节点down了，其他节点升级成master， 但是old master节点的ha port在DB里可能仍然是active状态，l3-agent重启后就会仍然spawn keepalived进程从而导致同时出现两个master节点。可以在l3-agent重启时将all ha ports的状态重置成DOWN解决。<br>见：<a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a> ， 它在fetch_and_sync_all_routers(状态为AGENT_REVIVED才运行, agent周期性失去心跳时才为此状态) -&gt; get_router_ids()中将所有ha ports设置成DOWN，<br>但有时候l3-agent无法及时报告心跳信息时，其agent的状态会被设置成AGENT_REVIVED，然后触发上面的将ha ports设置成DOWN, 然后l3-agent需要反复的处理同一个router发现它是ha_ports并且是active状态就enable_keepalived，这样l3-agent与l2-agent的负担都重反过来更加加重AGENT_REVIVED状态。所以需要将设置成DOWN的状态在重启l3-agent时才做一次（<strong>init</strong> -&gt; get_service_plugin_list -&gt; _update_ha_network_port_status)，见： <a href="https://review.openstack.org/#/c/522792/" target="_blank" rel="external">https://review.openstack.org/#/c/522792/</a><br>另一个原因： 如果先重启l3-agent再重启l2-agent, 在ovs-l2-agent还没将ha port准备好变成active状态之前，l3-agent就不应该处理ha_port并生成了keepalived实例。见：<a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a><br>ha_vrrp_health_check_interval选项支持ping GW然后实现主备切换。见：<a href="https://review.openstack.org/#/c/454657" target="_blank" rel="external">https://review.openstack.org/#/c/454657</a></p>
<p>当router很多时，可能也需要增大ha_vrrp_advert_int (lp: 1749425), 也需要设置mhash_entries=16000000 mphash_entries=16000000 (lp: 1376958)</p>
<p>Neutron-vrrp itself bug</p>
<p>keepalived instances should not be handled if ha ports are NOT ready (like first restart l3-agent then restart l2-agent) - <a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a></p>
<p>Master restart so slave will switch to new master, but old master doesn’t switch to slave because it’s initial DB status is active, so initial DB status should be set into standby, this patch do so when agent’s status is  AGENT_REVIVED - <a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a></p>
<p>Lots of VRRP problem is comprehensive problem, not caused by neutron-vrrp itself:</p>
<p>Keepalived’s bug</p>
<p>Dns problem causes slave be unable to switch to master - <a href="https://bugs.launchpad.net/neutron/+bug/1511722" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1511722</a></p>
<p>Neutron’s inappropriate settings</p>
<p>Performance problem caused by the small ovs_vsctl_timeout</p>
<p>Any performance problems can lead to vrrp problem as well. For example:</p>
<p>rabbitmq’s performance problem can cause l3-agent’s heartbeat not to be sent to neutron-api, then neutron-api will think agent has been dead (AGENT_REVIVED) so it will set the initial status into standby by using above fix (<a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a>). So this patch just set initial status into standby when restarting l3-agent instead of  AGENT_REVIVED - <a href="https://review.openstack.org/#/c/522792/" target="_blank" rel="external">https://review.openstack.org/#/c/522792/</a></p>
<p>Performance problem lead to vrrp can not be sent out in a short ha_vrrp_health_check_interval - <a href="https://review.openstack.org/#/c/454657" target="_blank" rel="external">https://review.openstack.org/#/c/454657</a></p>
<p>Performance problem caused by small mhash_entries - <a href="https://bugs.launchpad.net/charms/+source/neutron-gateway/+bug/1376958" target="_blank" rel="external">https://bugs.launchpad.net/charms/+source/neutron-gateway/+bug/1376958</a></p>
<p>Performance problem caused by ulimit and Others …</p>
<p>20180815更新</p>
<p>采用上面种种方法后仍然可能出现multiple master的问题，我们来分析一下原因：</p>
<p>openstack vrrp相关的进程有两个， 一个是neutron-keepalived-state-change is spawned由ha_router#initialize()初始化， 一个是keepalived由ha_router#process()初始化。</p>
<p>并且_process_added_router会调用neutron-keepalived-state-change, _process_updated_router会调用keepalived<br>l3_agent#_process_routers_loop -&gt; _process_router_update -&gt; _process_router_if_compatible -&gt; _process_added_router -&gt; ha_router#initialize()<br>l3_agent#_process_routers_loop -&gt; _process_router_update -&gt; _process_router_if_compatible -&gt; _process_updated_router -&gt; ha_router#process()</p>
<p>这种正常情况会保证neutron-keepalived-state-change先于keepalived进程启动 ( 20190320更新, 这个问题, 可以这样解决, 在neutron-keepalived-state-change启动之后根据节点上若有keepalived设置的vip就设置初始状态为master, 否则为slave - <a href="https://github.com/openstack/neutron/commit/5bcca13f4a58ee5541ae81a45b89f783194f1279" target="_blank" rel="external">https://github.com/openstack/neutron/commit/5bcca13f4a58ee5541ae81a45b89f783194f1279</a> )(<a href="https://bugs.launchpad.net/neutron/+bug/1818614)，并且这两个进程都被process_monitor.register方法注册进了external_process.py，" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1818614)，并且这两个进程都被process_monitor.register方法注册进了external_process.py，</a> 一旦这两个进程挂掉的后它会通过external_process.py#_respawn_action保证重启，但重启是没顺序的。比如，keepalived进程刚死， neutron-keepalived-state-change进程还没来得及通过MQ更新DB之前它也挂掉的话， 这时其他节点已经变成master了， 在这台节点上的这些进程再重启的时候也由因为认为它是master（根本原因在于keepalived没有提供一个查询当时谁是master的api，这样可以在每个节点上的keepalived启动时都先调用这个api检查一下有没有master，有master的话说明状态不一致就将自己变成backup啊。如用在master上运行下列命令很容易重现问题:</p>
<p>r=909c6b55-9bc6-476f-9d28-c32d031c41d7<br>pkill -f “/usr/bin/neutron-keepalived-state-change –router_id=$r”<br>sudo pkill -f “/var/lib/neutron/ha_confs/$r/keepalived.conf”</p>
<p>但这种问题只是在DB中看到multiple masters (neutron l3-agent-list-hosting-router provider-router), 在keepalived层面是正常的(sudo ip netns exec qdhcp-ab1a14d8-3b97-4e5e-9150-081c4afa5729 ping 192.168.21.1)</p>
<p><a href="https://review.openstack.org/#/c/273546" target="_blank" rel="external">https://review.openstack.org/#/c/273546</a> 这个patch通过ha_vrrp_health_check_interval提供了另外一种解决multiple master的办法，每个节点都定期ping网节，ping不通的话就说明出现multiple master了， 并且keepalived会根据ha_vrrp_health_check_interval重新选举直至选出新master为止。但是它依然有几个问题:</p>
<p>1, 它是ping外网网关10.5.0.1, 而不是tenant网关192.168.21.1, 所以它对解决上面问题依然无效.</p>
<p>2, 它本身有问题, 会造成VRRP状态反复的切换 - <a href="https://bugs.launchpad.net/neutron/+bug/1793102" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1793102</a></p>
<p>这个问题包括两个层面, 第一个是neutron db层面, 这是neutron的设计缺陷造成的, neutron没有调用keepalived获得状态, 而是通过ip monitor去维护状态, 这样必然有可能失去同步从而造成neutron这边看到多个master(如同时kill掉keepalived与neutron-keepalived-state-change进程), 但这点如果keepalived层面没有问题不会造成网络不通的问题, 顶多视觉上看到多个master但这点在下一次vrrp transition后也会回归正常； 另一个层面是keepalived的问题 - 应该是和这个相关 - <a href="https://github.com/acassen/keepalived/commit/e90a633c34fbe6ebbb891aa98bf29ce579b8b45c" target="_blank" rel="external">https://github.com/acassen/keepalived/commit/e90a633c34fbe6ebbb891aa98bf29ce579b8b45c</a></p>
<p>另一个问题, 下列脚本因为未在外层for循环中添加sleep会造成这个bug (<a href="https://bugs.launchpad.net/neutron/+bug/1823314)描述的问题" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1823314)描述的问题</a>, 同一个tenant下的所有HA routers的vr_id相同, 这样一台host上就只可能启动这些HA routers中的某一个, 其余的就都启动不了.</p>
<p>#!/bin/bash</p>
<p>routers=$@</p>
<p>routers_scrubbed=$(echo $routers | sed -e ‘s/,/ /g’)</p>
<p>#routers=”87d2302b-77cb-44dc-80cd-7de61edb8482</p>
<p>#9bbb7f94-955e-4f52-be5b-53e502e421be</p>
<p>#b4465e79-2346-46c2-ab32-95f586578ce1</p>
<p>#c51db509-3edb-415f-90c7-1eae0af67bd2</p>
<p>#c6fb1d6f-9ee8-4f8f-b9fe-81b6422c63a5</p>
<p>#cad767e8-c003-49e0-8c7a-d5bcb5c86251”</p>
<p>all_l3_agents=$(neutron agent-list -f value | awk ‘/l3-agent/ {print $1}’)</p>
<p>for router in ${routers_scrubbed}<br>do<br>   agents=$(neutron l3-agent-list-hosting-router -f value ${router})<br>   agent_count=$(echo “${agents}”| wc -l)<br>   active_agents=$(echo “${agents}” | awk ‘/active/ {print $1}’)<br>   standby_agents=$(echo “${agents}” | awk ‘/standby/ {print $1}’)<br>   active_agents_count=$(echo “${agents}” | grep active | wc -l)<br>   echo “Agents: ${agent_count}, ${active_agents_count} active”<br>   if [ “${active_agents_count}” -gt “1” ]<br>   then<br>       echo “Bad router found, fixing”<br>       for bump_agent in $active_agents<br>       do<br>           echo “Bumping l3 agent ${bump_agent} for router ${router}”<br>           neutron l3-agent-router-remove “${bump_agent}” “${router}”<br>           neutron l3-agent-router-add “${bump_agent}” “${router}”<br>           echo “Waiting 3 seconds between router bumping”<br>           sleep 3<br>       done<br>   elif [ “${active_agents_count}” -lt “1” ]<br>   then<br>       echo “Dead router found, fixing”</p>
<pre><code># drop all agents, then add all agents
for bump_agent in $all_l3_agents
do
    echo &quot;Bumping l3 agent ${bump_agent} for router ${router}&quot;
    neutron l3-agent-router-remove &quot;${bump_agent}&quot; &quot;${router}&quot;
    neutron l3-agent-router-add &quot;${bump_agent}&quot; &quot;${router}&quot;
done
</code></pre><p>   fi<br>done<br>20190609更新</p>
<p>遇到新问题, 客户反应, 如两个ha gateway (gw1, gw2), 如果gw1是master, gw2是slave, 没问题. 但换过来就出问题, 后来通过抓包:</p>
<p>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 tcpdump -i any -w out.pcap arp or icmp<br>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 ip n<br>sudo ovs-tcpdump -i br-int “(arp or icmp) and net 192.168.100.0/24 and ether host fa:16:3e:51:a6:8a” -p ovs_tcpdump_capture.pcap<br>tshark -r attachments/ovs_tcpdump_port_br-int_00189699.pcap | grep duplicate<br>sudo ovs-tcpdump -e -i br-int “(arp or icmp)” -w ovs_tcpdump_port_br-int.pcap<br>sudo ovs-tcpdump -e -i tapebd2a710-3a “arp or icmp” -w ovs_tcpdump_port_ebd2a710-3a.pcap<br>watch -n 1 ‘sudo ovs-ofctl dump-flows br-tun| grep <mac addr="" of="" vm="" with="" ip="" 192.168.100.6="">‘<br>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 arping -I qr-ebd2a710-3a 192.168.100.6</mac></p>
<p>发现计算节点上有下列两条流表:</p>
<p>cookie=0xc47b830f360f3102, duration=262107.239s, table=20, n_packets=166506, n_bytes=8374732, idle_age=3, hard_age=65534, priority=2,dl_vlan=4,dl_dst=fa:16:3e:51:a6:8a actions=strip_vlan,load:0x1-&gt;NXM_NX_TUN_ID[],output:46<br>cookie=0xc47b830f360f3102, duration=2138996.306s, table=20, n_packets=3039, n_bytes=331269, hard_timeout=300, idle_age=65534, hard_age=0, priority=1,vlan_tci=0x0004/0x0fff,dl_dst=fa:16:3e:51:a6:8a actions=load:0-&gt;NXM_OF_VLAN_TCI[],load:0x1-&gt;NXM_NX_TUN_ID[],output:48 </p>
<p>显然删去第一条就好了:</p>
<p>ovs-ofctl del-flows br-tun “table=20,priority=2,dl_vlan=4,dl_dst=fa:16:3e:51:a6:8a”</p>
<p>可为什么会这样呢? 这条流表是l2pop里的, 这行被加的, 明明是在non-ha时才加啊 - <a href="https://github.com/openstack/neutron/blob/stable/queens/neutron/plugins/ml2/drivers/l2pop/mech_driver.py#L323" target="_blank" rel="external">https://github.com/openstack/neutron/blob/stable/queens/neutron/plugins/ml2/drivers/l2pop/mech_driver.py#L323</a></p>
<p>原因是数据库, 下列记录的device_owner不是network:ha_router_replicated_interface</p>
<p>select device_owner,id,name,network_id,mac_address,device_id from ports where mac_address=”fa:16:3e:51:a6:8a”<br>select device_owner,id,name,network_id,mac_address,device_id from ports where device_owner=”network:ha_router_replicated_interface”</p>
<p>device_owner    id    name    network_id    mac_address    device_id<br>network:router_interface    ebd2a710-3a94-466c-98e8-4b436fbb4b43        591b004e-d640-4df6-bee1-01fc2c38f166    fa:16:3e:51:a6:8a    8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>解决办法:</p>
<p>openstack router set –disable 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –no-ha 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –ha 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –enable 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>20191105更新</p>
<p>又一个相关bug - <a href="https://bugs.launchpad.net/ubuntu/+source/openvswitch/+bug/1839592" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/openvswitch/+bug/1839592</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/Perf火焰图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/08/Perf火焰图/" itemprop="url">Perf火焰图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-08T15:17:52+08:00">
                2019-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="Install-perf"><a href="#Install-perf" class="headerlink" title="Install perf"></a>Install perf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:canonical-kernel-team/ppa</span><br><span class="line">sudo apt install linux-tools-$(uname -r)</span><br></pre></td></tr></table></figure>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul>
<li>火焰图看最宽的那条, 最宽的显示最耗时的, 上下最高则表示调用深度最长</li>
<li>如若抓应用态的(如ovs)则应添加” –call-graph dwarf “ 参数, ovs最好也安装符号表</li>
<li>如ovs隔六七秒就死, 可以使用它来抓这六七秒内的调用栈 - sudo perf record -a –call-graph dwarf – sleep 12</li>
<li>ideal的占一成的话, 那cpu占用率就是9成左右. 如果所有进程耗时都比较平均, 那只能说明整体性能不够</li>
<li>使用Ctrl + F可以搜索</li>
<li>offcpuflamegraphs.html 可以用来分析cpu为什么会睡那么久soft-lock相关的问题</li>
<li>之前使用systemtap, 但这东西需要脚本, 同时也不方便online debug session时安装. 现在主要使用perf, 另外也可以学习ebpf</li>
</ul>
<h2 id="Perf-Flame-Graph"><a href="#Perf-Flame-Graph" class="headerlink" title="Perf Flame Graph"></a>Perf Flame Graph</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/cobblau/FlameGraph</span><br><span class="line">sudo perf record --call-graph dwarf -p $(pidof qemu-system-x86_64)</span><br><span class="line">sudo perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl &gt; process.svg</span><br></pre></td></tr></table></figure>
<h2 id="分解"><a href="#分解" class="headerlink" title="分解"></a>分解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo perf record -F 99 -g -- sleep 30 $(pidof qemu-system-x86_64)</span><br><span class="line">sudo perf report -n --stdio</span><br><span class="line">sudo perf script | gzip &gt; out.perf01.gz</span><br><span class="line">git clone https://github.com/cobblau/FlameGraph</span><br><span class="line">; http://svgshare.com can be used to share svg</span><br><span class="line">sudo perf script | ./FlameGraph/stackcollapse-perf.pl | sed &apos;/cpu_idle/d;s/\[unknown\];//g&apos; | ./FlameGraph/flamegraph.pl --width 1000 &gt; perf.svg</span><br><span class="line">google-chrome-stable ./perf.svg</span><br></pre></td></tr></table></figure>
<h2 id="其他一"><a href="#其他一" class="headerlink" title="其他一"></a>其他一</h2><p>参考： <a href="https://github.com/bboymimi/perf-utils" target="_blank" rel="external">https://github.com/bboymimi/perf-utils</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># To get the all CPUs profiling callstack from user space to kernel space (both kernel and user space)</span><br><span class="line">sudo perf record -a --call-graph dwarf</span><br><span class="line"># To get the all CPUs profiling of kernel space callstack (just kernel space)</span><br><span class="line">sudo perf record -a -g</span><br><span class="line">git clone https://github.com/bboymimi/perf-utils.git</span><br><span class="line">sudo ./perf-utils/easy-flamegraph.sh -i perf.data</span><br><span class="line">google-chrome-stable ./perf-output/2018-01-04_14:18:15.perf.data.svg</span><br></pre></td></tr></table></figure></p>
<h2 id="其他二"><a href="#其他二" class="headerlink" title="其他二"></a>其他二</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Enable the sysrq</span><br><span class="line">sudo sysctl -w kernel.sysrq=1</span><br><span class="line"># Dump all active tasks stack - https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html</span><br><span class="line">echo l | sudo tee /proc/sysrq-trigger</span><br><span class="line"># Dumps tasks that are in uninterruptable (blocked) state.</span><br><span class="line">echo p | sudo tee /proc/sysrq-trigger</span><br><span class="line"># Performance profiling and get the flame-graph to see if there is</span><br><span class="line">any performance bottleneck when the problem happened</span><br><span class="line">git clone git://kernel.ubuntu.com/gavinguo/perf-production.git</span><br><span class="line">sudo perf record -a -g sleep 5</span><br><span class="line">sudo ./easy-flamegraph.sh -i ./perf.data -t</span><br></pre></td></tr></table></figure>
<p><strong>Profile Java with Perf</strong><br>默认的perf只能分析c与c++程序, 其他用户态的perf-java, perf-python, perf-go应当分别学习, 这里说的是perf-java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Profile Java with Perf</span><br><span class="line"># https://cloud.tencent.com/developer/article/1416234</span><br><span class="line"># https://my.oschina.net/u/150599/blog/3023394</span><br><span class="line">sudo apt install -y linux-tools-common linux-tools-generic bindfs</span><br><span class="line">mkdir /tmp/containerrootfs</span><br><span class="line">PID=$(docker inspect --format &#123;&#123;.State.Pid&#125;&#125; cas1)</span><br><span class="line">sudo perf record -g -p $PID</span><br><span class="line">sudo perf report</span><br><span class="line">#fix symbols in container</span><br><span class="line">cp perf.data /tmp/containerrootfs/</span><br><span class="line">bindfs /proc/$PID/root /tmp/containerrootfs</span><br><span class="line">perf report --symfs /tmp/containerrootfs</span><br><span class="line">umount /tmp/containerrootfs</span><br><span class="line"></span><br><span class="line"># install java</span><br><span class="line">sudo apt install -y openjdk-8-jdk</span><br><span class="line">dpkg-query -L openjdk-8-jdk</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64</span><br><span class="line"># install perf-map-agent to help generate symbols with FlameGraph</span><br><span class="line">sudo apt install -y cmake pkg-config libfuse-dev libfuse2 autoconf</span><br><span class="line">git clone https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">export FLAMEGRAPH_DIR=/home/ubuntu/FlameGraph</span><br><span class="line">git clone https://github.com/jvm-profiling-tools/perf-map-agent.git</span><br><span class="line">cd perf-map-agent/</span><br><span class="line">cmake .</span><br><span class="line">make</span><br><span class="line">sudo bin/create-links-in /usr/local/bin</span><br><span class="line"></span><br><span class="line"># Use perf-java-flames (</span><br><span class="line"># Need to add one jvm option in java process: -XX:+PreserveFramePointer</span><br><span class="line">perf-java-flames $PID -g</span><br><span class="line">#perf-java-record-stack $PID -g</span><br><span class="line">chromium-browser /bak/work/perf-map-agent/flamegraph-10286.svg</span><br></pre></td></tr></table></figure></p>
<p><strong>上下文切换高</strong><br>启用sar，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install sysstat</span><br><span class="line">sudo sed -i &apos;s/^ENABLED=&quot;false&quot;/ENABLED=&quot;true&quot;/&apos; /etc/default/sysstat</span><br><span class="line">sudo sed -i &apos;s/^5-55\/10/*\/2/&apos; /etc/cron.d/sysstat</span><br><span class="line">sudo systemctl restart sysstat</span><br></pre></td></tr></table></figure></p>
<p>后可以观测如上文文切换过高<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00:00:01       proc/s   cswch/s</span><br><span class="line">Average:       143.82  59339.01</span><br></pre></td></tr></table></figure></p>
<p>可以搜索火焰图（用户态内核态一起收集)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://kernel.ubuntu.com/gavinguo/perf-production.git</span><br><span class="line">cd perf-production</span><br><span class="line">sudo perf record -a --call-graph dwarf sleep 5</span><br><span class="line">sudo ./easy-flamegraph.sh -i ./perf.data -t</span><br></pre></td></tr></table></figure></p>
<p>也可以使用pidstat -w 1来确定哪个进程的上下文切换高， 或者:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://serverfault.com/questions/190049/find-out-which-task-is-generating-a-lot-of-context-switches-on-linux</span><br><span class="line">sudo perf record -e context-switches -a -g</span><br><span class="line"># then ctrl+c</span><br><span class="line">sudo perf report # inspect the result</span><br></pre></td></tr></table></figure></p>
<p><strong>Appendix - error - ERROR: No stack counts found </strong><br>遇到下面error是需要: sudo chown -R root:root perf.data, 必须使用root用户, 而非它说的普通用户.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/perf-utils$ sudo ./easy-flamegraph.sh perf.data  -f</span><br><span class="line">Use the /bak/work/perf-utils/perf.data as the source of the FlameGraph.</span><br><span class="line">File /bak/work/perf-utils/perf.data not owned by current user or root (use -f to override)</span><br><span class="line">ERROR: No stack counts found</span><br></pre></td></tr></table></figure></p>
<h2 id="tool-poormansprofiler"><a href="#tool-poormansprofiler" class="headerlink" title="tool - poormansprofiler"></a>tool - poormansprofiler</h2><p>#see what [multithreaded] programs are blocking on - <a href="https://poormansprofiler.org/" target="_blank" rel="external">https://poormansprofiler.org/</a><br>sudo gdb -ex “set pagination 0” -ex “thread apply all bt”   –batch -p $(pidof ovs-vswitchd)</p>
<p>mkdir gdb_ovs; cd gdb_ovs; for i in $(seq 1 600); do gdb -ex “set pagination 0” -ex “thread apply all bt” -batch -p $pid &amp;&gt; gdb.ovs-vswitchd.$(date -Is) ; sleep 0.1; done</p>
<h2 id="tool-tmate"><a href="#tool-tmate" class="headerlink" title="tool - tmate"></a>tool - tmate</h2><p>tmate is used to share ssh with others</p>
<h2 id="收集符号表"><a href="#收集符号表" class="headerlink" title="收集符号表"></a>收集符号表</h2><ul>
<li>内核符号表可以通过’sudo cat /proc/kallsyms | tee $(uname -r).kallsyms’命令收集,然后使用’per script –kallsyms’命令使用它.</li>
<li>用户态符号表在gavin的工具中已得到处理, 非要人工安装的话可以安装到/usr/lib/debug目录, 这也是ddeb包安装的目录</li>
<li>libunwind是一种符号表新标准.在build包时指定它生成的包体积小, 同时也能找到符号表<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/torvalds/linux/master/tools/perf/perf-archive.sh -O perf-archive.sh</span><br><span class="line">chmod +x perf-archive.sh</span><br><span class="line">./perf-archive.sh # this can take a while, a few minutes</span><br><span class="line"></span><br><span class="line">#sudo cat /proc/kallsyms | tee $(uname -r).kallsyms</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="新工具"><a href="#新工具" class="headerlink" title="新工具"></a>新工具</h2><ul>
<li>hostspot,   把perf数据用时间轴的方式图像化, 细致到时间点, 能以”Bottom Up” “top Down” Flame Graph”, “Caller/Callee”的方式看, 且能放大 hotspot –kallsyms ../xx-kallsyms</li>
<li>flamescope, 把perf数据用时间轴时间用热点的方式表示</li>
<li>speedscope, 把perf数据用</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" target="_blank" rel="external">http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html</a><br>[2] <a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="external">http://www.brendangregg.com/flamegraphs.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/使用apt-mirror和simplestreams搭建本地源/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/使用apt-mirror和simplestreams搭建本地源/" itemprop="url">使用apt-mirror和simplestreams搭建本地源</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-06T17:49:49+08:00">
                2019-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>你懂的，国内环境访问ubuntu-cloud.archive.canonical.com会非常慢(注： 其实下列方法可以同步UA, UCA, PPA)，本文将使用apt-mirror搭建一个本地apt服务器以提升办公效率。</p>
<ul>
<li>archive.ubuntu.com                   (UA, can use <a href="http://mirrors.cloud.tencent.com/ubuntu/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu/</a> instead)</li>
<li>security.ubuntu.com                  (UA, can use <a href="http://mirrors.cloud.tencent.com/ubuntu/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu/</a> instead)</li>
<li>ubuntu-cloud.archive.canonical.com (UCA)</li>
<li>images.maas.io                       (juju , lxd, maas)</li>
<li>cloud-images.ubuntu.com              (juju , lxd, maas, <a href="http://mirrors.cloud.tencent.com/ubuntu-cloud-images/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu-cloud-images/</a> instead)</li>
<li>streams.canonical.com                (juju , lxd, maas)<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br><span class="line">sudo apt -y install apache2 apt-mirror</span><br><span class="line">mkdir -p /images/xenial-repo</span><br><span class="line"></span><br><span class="line">$ cat /etc/apt/mirror.list</span><br><span class="line">############# config ##################</span><br><span class="line">#</span><br><span class="line">set base_path /images/xenial-repo</span><br><span class="line">#set defaultarch amd64</span><br><span class="line">#</span><br><span class="line"># set mirror_path  $base_path/mirror</span><br><span class="line"># set skel_path    $base_path/skel</span><br><span class="line"># set var_path     $base_path/var</span><br><span class="line"># set cleanscript $var_path/clean.sh</span><br><span class="line"># set defaultarch  &lt;running host architecture&gt;</span><br><span class="line"># set postmirror_script $var_path/postmirror.sh</span><br><span class="line"># set run_postmirror 0</span><br><span class="line">set nthreads     30</span><br><span class="line">set _tilde 0</span><br><span class="line">#</span><br><span class="line">############# end config ##############</span><br><span class="line"></span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-proposed main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-proposed main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">#see http://ubuntu-cloud.archive.canonical.com/ubuntu/dists/xenial-updates/</span><br><span class="line">deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/ocata main</span><br><span class="line">#deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/queens main</span><br><span class="line"></span><br><span class="line">#clean http://archive.ubuntu.com/ubuntu</span><br><span class="line">clean http://ubuntu-cloud.archive.canonical.com/ubuntu</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /images/xenial-repo/var/postmirror.sh</span><br><span class="line">sudo apt-mirror</span><br></pre></td></tr></table></figure>
<p>或者运行“sudo crontab -e”添加下列crob在每天四点半运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 4    * * *    root    /usr/bin/apt-mirror &gt;&gt; /var/log/apt-mirror.log</span><br></pre></td></tr></table></figure></p>
<h2 id="配置Apache"><a href="#配置Apache" class="headerlink" title="配置Apache"></a>配置Apache</h2><p>Apache的已有配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo grep -r &apos;DocumentRoot&apos; /etc/apache2/sites-available/000-default.conf</span><br><span class="line">        DocumentRoot /var/www/html</span><br><span class="line"></span><br><span class="line">$ grep -r &apos;/var/www/&apos; /etc/apache2/apache2.conf -A 4</span><br><span class="line">&lt;Directory /var/www/&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride All</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>创建软链及注意一个关键易犯问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /images/xenial-repo  /var/www/html/apt-mirror</span><br><span class="line">sudo chown -R www-data:www-data /images</span><br><span class="line">sudo service apache2 reload</span><br></pre></td></tr></table></figure>
<p>注：上面这一句”chown -R www-data:www-data /images”异常关键，网上几乎所有能搜寻的答案全部是关于添加’Options FollowSymLinks’的，其实如上/etc/apache2/apache2.conf文件中已经包含该设置。apache 2.4使用的目录的用户名和组必须全部是www-data，否则/var/log/apache2/error.log会报这个错误“Symbolic link not allowed or link target not accessible”（WEB页上看到的错误是‘You don’t have permission to access”）。可用该命令“sudo -u www-data ls /var/www/html/apt-mirror”验证它是否成功。之前我一直在这个地方犯错是因为我执行的是“chown -R www-data:www-data /images/xenial-repo”，这样导致仍然无法顺利执行““sudo -u www-data ls /var/www/html/apt-mirror”命令。<br>也可创建/etc/apache2/sites-available/ubuntu-mirror.conf使用VirtualHost同时支持对UA, UCA, PPT的同步：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-repo.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/archive.ubuntu.com/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-archive.ubuntu.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-archive.ubuntu.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-cloudrepo.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/ubuntu-cloud.archive.canonical.com/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-cloudarchive.canonical.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-cloudarchive.canonical.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-ppa.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/ppa.launchpad.net/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-ppaarchive.canonical.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-ppaarchive.canonical.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p>
<p>或要支持ssl，再添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SSLCACertificatePath /etc/ssl/certs</span><br><span class="line">SSLCertificateFile /etc/pki/tls/certs/mirror.crt</span><br><span class="line">SSLEngine On</span><br><span class="line">SSLCertificateKeyFile /etc/pki/tls/private/mirror.key</span><br></pre></td></tr></table></figure>
<p>之后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a2enmod ssl</span><br><span class="line">a2ensite *</span><br><span class="line">systemctl restart apache2</span><br></pre></td></tr></table></figure></p>
<h2 id="使用它"><a href="#使用它" class="headerlink" title="使用它"></a>使用它</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/apt/sources.list.d/mymirror.list</span><br><span class="line">cat &gt; /etc/apt/sources.list.d/mymirror.list &lt;&lt;EOF</span><br><span class="line">#deb http://node1/apt-mirror/mirror/cn.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://node1/apt-mirror/mirror/ubuntu-cloud.archive.canonical.com/ubuntu/ xenial-updates/ocata main</span><br><span class="line">EOF</span><br><span class="line">rm -rf /etc/apt/sources.list.d/cloudarchive-ocata.list*</span><br><span class="line">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 5EDB1B62EC4926EA</span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>
<h2 id="20171101更新"><a href="#20171101更新" class="headerlink" title="20171101更新"></a>20171101更新</h2><p>此次apt update慢的原因最后通过”Software &amp; Update -&gt; Ubuntu Software -&gt; Download from Other - Select Best Server”将之前的mirrors.aliyun.com改成mirrors.yun-idc.com就好了。之前各种源也都换过，为什么这次行了具体原因不明待下次遇到了待查。</p>
<h2 id="20171115更新"><a href="#20171115更新" class="headerlink" title="20171115更新"></a>20171115更新</h2><p>今天在安装libvirt0时总是发生包依赖问题（libvirt0: Depends: libxen-4.6 (&gt;=4.6.5) but 4.6.0-1ubuntu4.3 is to be installed)，原来是mirrors.aliyun.com的问题，这个源更新不及时会造成众多问题。<br><strong>为了克服这种更新不及时造成的问题，看样子还是最好别搭私有源和使用国内源，所以换回官方源</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-security main restricted universe multiverse</span><br></pre></td></tr></table></figure></p>
<h2 id="20191106更新-搭建simplestreams本地源"><a href="#20191106更新-搭建simplestreams本地源" class="headerlink" title="20191106更新 - 搭建simplestreams本地源"></a>20191106更新 - 搭建simplestreams本地源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install simplestreams</span><br><span class="line">sudo mkdir -p /var/spool/sstreams/maas &amp;&amp; sudo chown -R $USER /var/spool/sstreams/maas</span><br><span class="line"></span><br><span class="line">#MAAS images simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/maas</span><br><span class="line">sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1  https://images.maas.io/ephemeral-v3/daily/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos;</span><br><span class="line">sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1  https://images.maas.io/ephemeral-v3/daily/ $workdir &apos;os~(grub*|pxelinux)&apos;</span><br><span class="line"></span><br><span class="line">#Use MAAS images simplestreams</span><br><span class="line">maas root boot-source update 1 url=https://maas-images.yourdomain.com/ keyring_filename=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg</span><br><span class="line">maas root domains create name=&quot;yourdomain.com&quot;</span><br><span class="line">maas root dnsresources create fqdn=&quot;maas-images.yourdomain.com&quot; ip_addresses=&lt;your-mirror-ip&gt;  #orconfigure the mirror in infra.yaml</span><br><span class="line"></span><br><span class="line">#Juju agents simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/juju</span><br><span class="line">sstream-mirror --no-verify --progress --max=2 --path=streams/v1/index2.sjson https://streams.canonical.com/juju/tools/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;version~(2.6)&apos;</span><br><span class="line"></span><br><span class="line">#Use Juju agents simplestreams</span><br><span class="line">#let juju know where to get contrainers from, or defined it in juju-model-default.yaml</span><br><span class="line">juju model-config container-image-stream=released container-image-metadata-url=https://lxd-images.yourdomain.com/ image-metadata-url=https://lxd-images.yourdomain.com</span><br><span class="line">#let juju know where to fetach the agents, or defined it in juju-model-default.yaml</span><br><span class="line">juju model-config agent-metadata-url=https://juju-agents.yourdomain.com/ agent-stream=released</span><br><span class="line"></span><br><span class="line">#LXD and KVM images simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/lxdkvm</span><br><span class="line">sudo sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1 --path=streams/v1/index.json https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line">sudo sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1 --path=streams/v1/index.sjson https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line">https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line"></span><br><span class="line">sudo apt install apache2 -y</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/apache2/sites-available/sstreams-mirror.conf</span><br><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">    ServerName maas-images.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/maas</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-maas-images-error.log</span><br><span class="line">     CustomLog /var/log/apache2/mirror-maas-images-access.log combined</span><br><span class="line">     &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">     Options Indexes FollowSymLinks</span><br><span class="line">     AllowOverride None</span><br><span class="line">     Require all granted</span><br><span class="line">     &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName lxdkvm-images.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/lxdkvm</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-lxdkvm-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-lxdkvm-access.log combined</span><br><span class="line">    &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName juju-agents.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/juju</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-juju-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-juju-access.log combined</span><br><span class="line">    &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/05/k8s-http-https-nginx-ingress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/05/k8s-http-https-nginx-ingress/" itemprop="url">k8s http/https nginx ingress</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-05T12:02:18+08:00">
                2019-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2019-11-05<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="https://zhhuabj.blog.csdn.net" target="_blank" rel="external">https://zhhuabj.blog.csdn.net</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x-forwarded-proto里. 所以在L7 LB模式中, 并没有将tcp连接透传给nginx-ingress. <strong>NOTE: 这块可以使用”curl -H ‘X-Forwarded-Proto: https’ -H ‘X-Forwsarded-Host: newhost’ 192.168.99.135:8000”模拟代替.</strong></li>
<li>nginx-ingress, 默认的nginx-ingress里使用(proxy_set_header X-Forwarded-Proto $pass_access_scheme;)与(proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;)获取的是L7 LB的IP作为client ip, 以及将L7</li>
<li>LB访问的scheme作为scheme. 这里应该改从header里取(http_x_forwarded_proto). backend, 如果backend利用了x-forwarded-*这些header来构造redirect url的话, 如果没有获取到x-forwarded-proto时, 它如果要继续转发(Http Redirect)的话, 可以就会出现url问题.</li>
</ul>
<p>Client与nginx-ingress之间可以配置https，此时nginx-ignress与backends仍然可以配置http, ssl termination, ssl passthrough三种模式。若Client前面还有L7 LB那就是四种模式：</p>
<ul>
<li>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination https (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS” or nginx.ingress.kubernetes.io/secure-backends: “true”)</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl passthrough https (–enable-ssl-passthrough and nginx.ingress.kubernetes.io/ssl-passthrough: “true”)</li>
<li>client –(HTTPs)–&gt; L7 LB –(use-forwarded-headers=true, X-Forwarded-Proto=https)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl termination with F5 - <a href="https://bugs.launchpad.net/bugs/1842286" target="_blank" rel="external">https://bugs.launchpad.net/bugs/1842286</a><h2 id="http-ingress"><a href="#http-ingress" class="headerlink" title="http ingress"></a>http ingress</h2>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">juju scp kubernetes-master/0:config ~/.kube/config</span><br><span class="line">#juju run-action etcd/0 health --wait</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line">kubectl get services --namespace=ingress-nginx-kubernetes-worker default-http-backend-kubernetes-worker -o yaml</span><br><span class="line">kubectl get daemonset --namespace=ingress-nginx-kubernetes-worker nginx-ingress-controller-kubernetes-worker -o yaml</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">        - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">        - --enable-ssl-chain-completion=False</span><br><span class="line">        - --enable-ssl-passthrough=False</span><br><span class="line"></span><br><span class="line">#deploy http ingress</span><br><span class="line">kubectl run nginx --image=nginx --port 80</span><br><span class="line">kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-test.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-service</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: &quot;quqi.com&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ./ingress-test.yaml</span><br><span class="line">kubectl describe ingresses ingress-service</span><br><span class="line">kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">$ kubectl describe service nginx</span><br><span class="line">IP:                       10.152.183.250</span><br><span class="line">Port:                     &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  31463/TCP</span><br><span class="line">Endpoints:                10.1.60.3:80</span><br><span class="line">$ juju status |grep worker/0</span><br><span class="line">kubernetes-worker/0*      active    idle   4        10.5.0.53       80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line"></span><br><span class="line">#curl http(s)://&lt;worker-ip&gt;:NodePort&gt;/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ssl-termination-http"><a href="#ssl-termination-http" class="headerlink" title="ssl termination http"></a>ssl termination http</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http<br>ssl termination可参见：<a href="https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/" target="_blank" rel="external">https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/</a><br>在k8s中， 如果nginx-ingress前面还有LB如F5的话，nginx-ingress并不是和client直接相连的，client传给F5的链接里的https标记会最终设置成X-Forwarded-Proto=https, 所以nginx-ingress这端需要在configmap中设置use-forwarded-headers=true(kubectl -n ingress-nginx-kubernetes-worker edit cm nginx-configura<br>tion), If true, nginx-ingress passes the incoming X-Forwarded-* (eg: X-Forwarded-Proto) headers to upstreams. Use this option when nginx is behind another L7 proxy / LB that is setting these headers.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">kubectl create secret tls ingress-ssl-secret --cert=server.crt --key=server.key</span><br><span class="line">kubectl describe secret ingress-ssl-secret</span><br><span class="line">kubectl run nginx --image=nginx --port 80 --expose</span><br><span class="line"></span><br><span class="line"># 将ingress controller pods定义service对外暴露NodePort (NOTE: 下面namespace应该用default) -</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32080</span><br><span class="line">    - name: https</span><br><span class="line">      port: 443</span><br><span class="line">      targetPort: 443</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32443</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-w98fm -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 2.txt</span><br><span class="line">vimdiff 1.txt 2.txt</span><br><span class="line">#https://paste.ubuntu.com/p/8yV7RZJ9D7/</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure></p>
<p>如果nginx-ingress和backend总是采用https的话， ingress定义时需添加annotation：nginx.ingress.kubernetes.io/secure-backends: “true”<br>或者使用附录中的tomcat容器也行。</p>
<h2 id="ssl-termination-with-HTTPS-backend"><a href="#ssl-termination-with-HTTPS-backend" class="headerlink" title="ssl termination with HTTPS backend"></a>ssl termination with HTTPS backend</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”  or nginx.ingress.kubernetes.io/secure-backends: “true”)<br>后端需要做一个https测试应用： <a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>新版本需添加：nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”， 旧版本使用：nginx.ingress.kubernetes.io/secure-backends: “true”,<br>下面是制作一个https测试应用的步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line"></span><br><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;simple-https-server.py&apos; &lt;&lt;EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import ssl</span><br><span class="line">httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 443), SimpleHTTPServer.SimpleHTTPRequestHandler)</span><br><span class="line">httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">httpd.serve_forever()</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;index.html&apos; &lt;&lt;EOF</span><br><span class="line">Hello world!</span><br><span class="line">EOF</span><br><span class="line">nohup sudo python simple-https-server.py &amp;</span><br><span class="line">curl --resolve ssltest.quqi.com:443:192.168.99.135 --cacert ./server.pem https://ssltest.quqi.com</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;Dockerfile&apos; &lt;&lt;EOF</span><br><span class="line">FROM python:2.7-alpine</span><br><span class="line">ADD simple-https-server.py /</span><br><span class="line">ADD index.html /</span><br><span class="line">ADD server.pem /</span><br><span class="line">RUN apk update &amp;&amp; apk add bash</span><br><span class="line">RUN pip install simple_http_server</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./simple-https-server.py&quot; ]</span><br><span class="line">EOF</span><br><span class="line">#sudo docker run -it --rm --name simple-https-server -v &quot;$PWD&quot;:/root -w /root python:2.7-alpine python simple-https-server.py</span><br><span class="line"></span><br><span class="line">sudo apt install docker.io -y</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/default/docker&apos; &lt;&lt;EOF</span><br><span class="line">DOCKER_OPTS=&quot;--insecure-registry $DOCKER_OPTS --insecure-registry registry.mirrors.aliyuncs.com&quot;</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/docker/daemon.json&apos; &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https://6kx4zyno.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line">sudo docker build -t simple-https-server .</span><br><span class="line">sudo docker tag simple-https-server zhhuabj/simple-https-server</span><br><span class="line">sudo docker image rm simple-https-server</span><br><span class="line">sudo docker history zhhuabj/simple-https-server</span><br><span class="line">#sudo docker run -d --rm --name simple-https-server zhhuabj/simple-https-server</span><br><span class="line">#sudo docker inspect simple-https-server |grep IPAddress</span><br><span class="line">#curl --resolve ssltest.quqi.com:443:172.17.0.2 --cacert server.pem https://ssltest.quqi.com</span><br><span class="line">#sudo docker rm simple-https-server --force</span><br><span class="line">proxychains4 sudo docker login</span><br><span class="line">sudo docker push zhhuabj/simple-https-server</span><br><span class="line"></span><br><span class="line">#don&apos;t know why image always doesn&apos;t update even if using --image-pul-policy=Always, so:</span><br><span class="line">sudo docker pull zhhuabj/simple-https-server</span><br><span class="line">sudo docker tag zhhuabj/simple-https-server zhhuabj/simple-https-server:withbash</span><br><span class="line">sudo docker push zhhuabj/simple-https-server:withbash</span><br><span class="line">#debug, containerd operation</span><br><span class="line">sudo ctr --namespace k8s.io containers ls</span><br><span class="line">sudo ctr --namespace k8s.io images ls</span><br><span class="line"></span><br><span class="line">kubectl run simple-https-server --image=zhhuabj/simple-https-server:withbash --image-pull-policy=Always --port 443</span><br><span class="line">kubectl expose deployment simple-https-server --port=443 --target-port=443</span><br><span class="line">kubectl describe service simple-https-server</span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl --resolve ssltest.quqi.com:31750:10.5.0.26 --cacert server.pem https://ssltest.quqi.com:31750</span><br></pre></td></tr></table></figure></p>
<p>继续测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;ingress-simple-https-server.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-simple-https-server</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: simple-https-server</span><br><span class="line">          servicePort: 443</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-simple-https-server.yaml</span><br><span class="line"></span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k</span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k -I -L</span><br><span class="line">telnet 10.5.0.40 32443</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker describe service ingress-nginx</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 --cacert server.pem https://ssltest.quqi.com:32443</span><br><span class="line"></span><br><span class="line">kubectl exec -ti simple-https-server-84d588fcb4-9sxsh -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- cat /etc/nginx/nginx.conf grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line"># NOTE: Wrong usage</span><br><span class="line">#kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 3.txt</span><br><span class="line">Error from server (NotFound): pods &quot;pod&quot; not found  #need to re-install env</span><br></pre></td></tr></table></figure></p>
<h2 id="ssl-passthrough"><a href="#ssl-passthrough" class="headerlink" title="ssl passthrough"></a>ssl passthrough</h2><p>ssl passthrough可参见：<a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>ssl passthrough时由于使用tcp不做https拆包取不到https相关字段，但nginx提供了preread on特性在握手阶段读取domain, 这样可实现SNI - 见： <a href="https://www.jianshu.com/p/c86a94b14137" target="_blank" rel="external">https://www.jianshu.com/p/c86a94b14137</a><br>在k8s中，需要启动controller时添加–enable-ssl-passthrough标志, ssl passthrough only works on layer 4 (TCP) and not on layer 7 (HTTP), 同时ingress定义时添加annotation：nginx.ingress.kubernetes.io/ssl-passthrough: “true”， 另外测试时应指明key:<br>curl –resolve ssltest.quqi.com:443:10.5.0.8 –cacert server.pem <a href="https://ssltest.quqi.com" target="_blank" rel="external">https://ssltest.quqi.com</a></p>
<h2 id="k8s-ingress-前端再加F7-LB"><a href="#k8s-ingress-前端再加F7-LB" class="headerlink" title="k8s ingress 前端再加F7 LB"></a>k8s ingress 前端再加F7 LB</h2><p>1, 编辑configmap添加内容：<br>kubectl edit cm –namespace=ingress-nginx-kubernetes-worker nginx-configuration<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  use-forwarded-headers: &quot;true&quot;</span><br></pre></td></tr></table></figure></p>
<p>2, Set up L7 LB in front of ingress-controller<br>sudo apt install haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#install haproxy in bastion</span><br><span class="line">sudo apt install haproxy -y</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/haproxy/haproxy.cfg&apos; &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     2048</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    tune.ssl.default-dh-param 2048</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option forwardfor</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">   mode http</span><br><span class="line">   bind 10.5.0.8:80</span><br><span class="line">   reqadd X-Forwarded-Proto:\ http</span><br><span class="line">   default_backend https-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind 10.5.0.8:443 ssl crt /home/ubuntu/sslkey/server.pem ca-file /home/ubuntu/sslkey/ca.crt</span><br><span class="line">    reqadd X-Forwarded-Proto:\ https</span><br><span class="line">    default_backend https-routers</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    balance roundrobin</span><br><span class="line">    cookie SERVERID insert indirect nocache</span><br><span class="line">    #http-request set-header Host ssltest.quqi.com</span><br><span class="line">    server s1 10.5.0.40:32443 check check-ssl ssl verify none</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl stop haproxy</span><br><span class="line">haproxy -vv</span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg -c</span><br><span class="line">sudo haproxy -f /etc/haproxy/haproxy.cfg -V</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 https://ssltest.quqi.com:32443 --cacert ~/sslkey/server.pem</span><br><span class="line">curl https://10.5.0.8 -k</span><br><span class="line">curl --resolve ssltest.quqi.com:443:10.5.0.8 https://ssltest.quqi.com:443 --cacert ~/sslkey/server.pem</span><br></pre></td></tr></table></figure>
<p>如果需要ssl双向认证, 可将上面的” server s1 10.5.0.40:32443 check check-ssl ssl verify none”改为(but it doesn’t work now):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#two-day authenication, but it doesn&apos;t work - https://blog.csdn.net/yin_slin/article/details/81130723</span><br><span class="line">openssl genrsa -passout pass:password -out client.key</span><br><span class="line">openssl req -new -key client.key -out client.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=10.5.0.8&quot;</span><br><span class="line">openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 3650</span><br><span class="line">openssl pkcs12 -export -inkey client.key -in client.crt -certfile ca.crt -passout pass:password -out client.p12</span><br><span class="line">echo y | keytool -importcert -alias ca -file ca.crt -keystore client-trust.jks -storepass password</span><br><span class="line">echo y | keytool -importcert -alias client -file client.crt -keystore client-trust.jks -storepass password</span><br></pre></td></tr></table></figure></p>
<h2 id="支持X-FORWARDED-PROTO转发的应用"><a href="#支持X-FORWARDED-PROTO转发的应用" class="headerlink" title="支持X_FORWARDED_PROTO转发的应用"></a>支持X_FORWARDED_PROTO转发的应用</h2><p>要继续测试nginx-ingress未传X_FORWARDED_PROTO的影响的话, 需要构建这么一个测试应用, 它要使用X_FORWARDED_PROTO来构建url来做跳转. (或者应用前再搞一级nginx代理之类的作跳转?)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-django -y</span><br><span class="line">python -m django --version</span><br><span class="line">django-admin startproject mysite</span><br><span class="line">cd mysite</span><br><span class="line">sed -i &quot;s,ALLOWED_HOSTS = \[\],ALLOWED_HOSTS = \[&apos;*&apos;\],g&quot; mysite/settings.py</span><br><span class="line">sed -i &quot;s,DEBUG = True,DEBUG = False,g&quot; mysite/settings.py</span><br><span class="line">echo &quot;SECURE_PROXY_SSL_HEADER = (&apos;HTTP_X_FORWARDED_PROTO&apos;, &apos;https&apos;)&quot; &gt;&gt; mysite/settings.py</span><br><span class="line"></span><br><span class="line">#Note: To properly simulate a HTTPS connection in Django, you should also set an environment variable HTTPS=on.</span><br><span class="line">HTTPS=on python manage.py runserver 192.168.99.135:8000</span><br><span class="line">lynx http://192.168.99.135:8000/</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee mysite/sslmiddleware.py</span><br><span class="line"># refer https://github.com/rdegges/django-sslify.git</span><br><span class="line">try:</span><br><span class="line">    # Python 2.x</span><br><span class="line">    from urlparse import urlsplit, urlunsplit</span><br><span class="line">except ImportError:</span><br><span class="line">    # Python 3.x</span><br><span class="line">    from urllib.parse import urlsplit</span><br><span class="line">    from urllib.parse import urlunsplit</span><br><span class="line"></span><br><span class="line">from django.conf import settings</span><br><span class="line">from django.http import HttpResponsePermanentRedirect</span><br><span class="line">from django.http import HttpResponse, HttpResponseRedirect</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    # Django 1.10</span><br><span class="line">    from django.utils.deprecation import MiddlewareMixin</span><br><span class="line">except ImportError:</span><br><span class="line">    # Django &lt;1.10</span><br><span class="line">    class MiddlewareMixin(object):</span><br><span class="line">        def __init__(self, get_response=None):</span><br><span class="line">            self.get_response = get_response</span><br><span class="line">            super(MiddlewareMixin, self).__init__()</span><br><span class="line"></span><br><span class="line">        def __call__(self, request):</span><br><span class="line">            response = None</span><br><span class="line">            if hasattr(self, &apos;process_request&apos;):</span><br><span class="line">                response = self.process_request(request)</span><br><span class="line">            if not response:</span><br><span class="line">                response = self.get_response(request)</span><br><span class="line">            if hasattr(self, &apos;process_response&apos;):</span><br><span class="line">                response = self.process_response(request, response)</span><br><span class="line">            return response</span><br><span class="line"></span><br><span class="line">import logging</span><br><span class="line">logger = logging.getLogger(&apos;router&apos;)</span><br><span class="line"></span><br><span class="line">class SSLMiddleware(MiddlewareMixin):</span><br><span class="line"></span><br><span class="line">    def process_request(self, request):</span><br><span class="line">        url = request.build_absolute_uri(request.get_full_path())</span><br><span class="line">        forwarded_proto = request.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">        #forwarded_proto = request.META.get(&quot;HTTP_X_FORWARDED_PROTO&quot;, &quot;&quot;)</span><br><span class="line">        if forwarded_proto:</span><br><span class="line">            url_split = urlsplit(url)</span><br><span class="line">            scheme = &apos;https&apos; if url_split.scheme == &apos;http&apos; else url_split.scheme</span><br><span class="line">            url_secure_split = (scheme, &quot;%s:%d&quot; % (url_split.hostname or &apos;&apos;, 443)) + url_split[2:]</span><br><span class="line">            #secure_url = url.replace(&quot;http://&quot;, &quot;https://&quot;)</span><br><span class="line">            secure_url = urlunsplit(url_secure_split)</span><br><span class="line">        #print(url)</span><br><span class="line">        #print(forwarded_proto)</span><br><span class="line">        #print(secure_url)</span><br><span class="line">        #return HttpResponsePermanentRedirect(secure_url)</span><br><span class="line">        return HttpResponseRedirect(secure_url)</span><br><span class="line"></span><br><span class="line">    def process_response(self,request,response):</span><br><span class="line">        #print(&apos;response:&apos;)</span><br><span class="line">        print(response)</span><br><span class="line">        return response</span><br><span class="line">EOF</span><br><span class="line">add the line &apos;mysite.middleware.SSLMiddleware&apos;, into MIDDLEWARE item in settings.py, NOTE: Make sure this middleware is the first middleware class listed, as this will ensure that if a user makes an insecure request (over HTTP)</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; http://192.168.99.135:8000</span><br><span class="line">$ python manage.py runserver 192.168.99.135:8000</span><br><span class="line">...</span><br><span class="line">Starting development server at http://192.168.99.135:8000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Location: https://192.168.99.135:443/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[13/Nov/2019 11:16:31] &quot;GET / HTTP/1.1&quot; 302 0</span><br></pre></td></tr></table></figure></p>
<p>改良型的应用如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee simple-http-server.py</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># NOTE: Need to make chrome stop redirect from http to https when using chrome for test</span><br><span class="line"># Go to chrome://net-internals/#hsts , enter 192.168.99.135 under Delete domain security policies and press the Delete button.</span><br><span class="line"># Go to chrome://settings/clearBrowserData,  tick the box Cached images and files and press click the button Clear data.</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import os, io, shutil</span><br><span class="line">import ssl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):</span><br><span class="line"></span><br><span class="line">    def do_GET(self):</span><br><span class="line">        #SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)</span><br><span class="line">        scheme = self.headers.get(&apos;X-Forwarded-Proto&apos;,&apos;&apos;)</span><br><span class="line">        serverip = self.headers.get(&apos;X-Forwarded-Host&apos;,&apos;localhost&apos;)</span><br><span class="line">        port = self.headers.get(&apos;X-Forwarded-Port&apos;,&apos;443&apos;)</span><br><span class="line">        clientip = self.headers.get(&apos;X-Forwarded-For&apos;,&apos;localhost&apos;)</span><br><span class="line">        if scheme == &apos;https&apos;:</span><br><span class="line">            # 301 will redirect with a GET request even if you sent a POST request</span><br><span class="line">            self.send_response(301)</span><br><span class="line">            #url_secure_split = (scheme, &quot;%s:%d&quot; % (serverip, port)) + self.path</span><br><span class="line">            new_url = &apos;%s%s%s%s%s%s&apos; % (scheme, &apos;://&apos;, serverip, &apos;:&apos;, port, self.path)</span><br><span class="line">            self.send_header(&apos;Location&apos;, new_url)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(&quot;redirect url to %s&quot; % (new_url))</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line">        else:</span><br><span class="line">            self.send_response(200)</span><br><span class="line">            #self.send_header(&apos;Content-type&apos;,&apos;text/html&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 8000), MyHandler)</span><br><span class="line">    #httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">    httpd.serve_forever()</span><br><span class="line">except KeyboardInterrupt:</span><br><span class="line">    print(&apos;^C received, shutting down server&apos;)</span><br><span class="line">    httpd.socket.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpHost: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: http</span><br><span class="line">X-Forwsarded-Host: newhost</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpsredirect url to https://localhost:443/Host: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: https</span><br><span class="line">X-Forwsarded-Host: newhost</span><br></pre></td></tr></table></figure>
<h2 id="Appendix-tomcat-container"><a href="#Appendix-tomcat-container" class="headerlink" title="Appendix - tomcat container"></a>Appendix - tomcat container</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;tomcat-deploy.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    port: 8080</span><br><span class="line">  - name: ajp</span><br><span class="line">    targetPort: 8009</span><br><span class="line">    port: 8009</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: tomcat:9.0-jre8-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: ajp</span><br><span class="line">          containerPort: 8009</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f tomcat-deploy.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-tomcat.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat</span><br><span class="line">          servicePort: 8080</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-tomcat.yaml</span><br><span class="line"></span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
<h2 id="Apendix-a-haproxy-example"><a href="#Apendix-a-haproxy-example" class="headerlink" title="Apendix - a haproxy example"></a>Apendix - a haproxy example</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:80</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: http</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: https</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend ssl-in</span><br><span class="line">    mode tcp</span><br><span class="line">    reqirep ^Host: 10.5.0.53:4443 Host: ssltest.quqi.com</span><br><span class="line">    bind :4443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    default_backend tcp-routers</span><br><span class="line"></span><br><span class="line">backend http-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:80 check inter 1000</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:443 check inter 1000</span><br><span class="line"></span><br><span class="line">backend tcp-routers</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:4443 check inter 1000</span><br><span class="line"> reqirep ^Host: external-address:4443 Host: loggregator.internal-address:4443</span><br></pre></td></tr></table></figure>
<p>```</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://ju.outofmemory.cn/entry/359682" target="_blank" rel="external">http://ju.outofmemory.cn/entry/359682</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/OpenStack开发过程中常用Git操作场景/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/14/OpenStack开发过程中常用Git操作场景/" itemprop="url">OpenStack开发过程中常用Git操作场景</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-14T17:06:30+08:00">
                2019-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  OpenStack开发过程中常用Git操作场景( by quqi99 )</p>
<p>作者：张华  发表于：2013-07-23<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br><a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<pre><code>    Git是一个分布式的代码管理库，linux之父开发，用了三年多了，直观感受的优点如下：

一是真正的分布式，既不用担心哪天服务器坏了代码丢失了，也不用担心像中美之间网速慢啊或断网什么的影响开发，因为本地就是一个代码库。
二是体积小，对存储进行了优化。
三是速度快，因为比较的是哈希。
四是差异比较算法很智能，能到达行级，甚至一行中的列级。
五是支持对二进制的差异比较，如一个Word文档什么的。
六是其它。。。


    虽然对原理也算熟，用得也算多，但一段时间不用还是容易忘，下面记下一些日常工作场景常用到的命令：
</code></pre><p>场景一：如何往社区提交一个Bug<br>      安装git： sudo yum install git git-review<br>     下载代码：git clone <a href="https://github.com/openstack/neutron.git" target="_blank" rel="external">https://github.com/openstack/neutron.git</a></p>
<p>1    通过ssh-keygen命令创建密钥, 然后在“<a href="https://review.openstack.org/#/settings/ssh-keys" target="_blank" rel="external">https://review.openstack.org/#/settings/ssh-keys</a> 界面设置public key.<br>2    运行“git review -s”命令设置git-review, 这步会在.git/config文件中添加一个名为gerrit的远程分支ssh://zhhuabj@review.openstack.org:29418/openstack/neutron.git，并且可以通过ssh访问：ssh -p 29418 review.openstack.org)<br>      如果报“Permission denied (publickey)”这样的错的话，简单运行”ssh-add”命令将ssh key添加到ssh agent即可</p>
<pre><code>还有一种可能是用户弄错了，ssh -i zhhuabj_lcy01.pem ubuntu@162.213.**  -vvv
</code></pre><p>3   如果想要修改一个bug时，先创建一个本地分支,<br>      git checkout -b task/132002<br>4  写完代码之后，也得运行一下pep8测试吧<br>      pep8 –count –repeat –show-source .  或者     ./run_tests.sh -p -N<br>5  或者也运行一下单元测试吧<br>      nosetests -s -v test_backend_sql.py  &amp;&amp; nosetests -s -v test_db_plugin:TestNetworksV2.test_list_shared_networks_with_non_admin_user<br>      或者 python -m testtools.run neutron.tests.unit.test_security_groups_rpc<br>      或者 python setup.py testr –slowest –testr-args=’–subunit  neutron.tests.unit.test_security_groups_rpc’ |  subunit2pyunit<br>      或者 ./run_test.sh -N testtools.run neutron.tests.unit.test_security_groups_rpc<br>6  提交代码到本地库<br>      git add -u (修改的文件）， 若创建了新文件 git add -i<br>      git commit<br>      提交信息的格式一般如下，一般分三段，第一段是标准说清楚你要做什么，如果你在改hyper-v模块最好有hyper-v的字眼，这样大家在收到邮件时只看标题就知道你在做什么了，这很重要；第二段简短描述；第三段一般使用“Fixed bug #161317”，＃号很重要，这样会自动在gerrit上链接到bug上。<br>      Add documentation for upgrading hyperv OpenStack compute node</p>
<pre><code>This guide covers how to upgrade and configure hyperv OpenStack
compute node from Grizzly to Havana

Fixed bug #161317
如果是延用上次提交的信息使用命令：git commit --amend
</code></pre><p>7  本来在git review通过后gerrit会自动rebase到master分支的，但是有冲突的话没人帮你改，所以自己在git review前最好在本地做一个rebase操作，有冲突及时改：<br>      git rebase master  有冲突再解决冲突之后继续执行：git rebase –continue<br>8  提交代码评审<br>      git review 或者 git review master</p>
<pre><code>这时会在gerrit服务器上创建一个本地分支：refs/for/master/task/132002, 如果上面改bug时不建分支的话，这里就变成了: refs/for/master，下一个人提交直接就被冲掉了。
</code></pre><p>9 如果社区上的jenkins出错，确定不是你自己的代码造成的，可以回复“recheck no bug” 触发重新检查，或者”recheck bug ###”</p>
<p>10 说说依赖提交，例如如果一个patch在社区已经被很多人+1了，但这时候有人希望提交一个相关的其他patch, 你当然不想破坏这么多已经+1的成果，所以你会希望再提一个patch但它会依赖前一个patch。注意两点：生成一个新的gerrit评审页是由Change-Id决定的；而是否在一个评审页上产生一个新的change set去破坏+1是由commit id决定的。所以只要保证前一个patch的commit id不变就行了，然后在这个基础上再提交一个patch再git review即可。当然，在git review之前最好先git rebase一下，不然如果本地git rebase的话就会产生一个新的commit id这样同样会产生一个新的change set，不过gerrit还比较智能，那些+1会自动添加上（Automatically re-added by Gerrit trivial rebase detection script.），　一个例子见：<a href="https://review.openstack.org/#/c/51375/" target="_blank" rel="external">https://review.openstack.org/#/c/51375/</a></p>
<p>场景二：如何rebase代码<br>git rebase用于在一个分支中合并另一分支，举个例子，一家公司想要用OpenStack做二次开发的话，<br>在公司内部的git库里创建了三个分支：my-master, my-grizzly, my-havana<br>OpenStack的git库里的分支叫：    github-master, github-grizzly, github-havana<br>现在大家把内部代码都提交在my-havana分支，那么也需要时不时将社区的github-havana的代码rebase合并到my-havana分支中<br>1，首先在.git/config里要有两个remote分支，一个指向内部的版本库，一个指向github的版本库，如.git/config的相应配置如下：<br>[core]<br>        repositoryformatversion = 0<br>        filemode = true<br>        bare = false<br>        logallrefupdates = true<br>[remote “my-origin”]<br>        fetch = +refs/heads/<em>:refs/remotes/my-origin/</em><br>        url = git://<your_ip>/neutron.git<br>[remote “github-origin”]<br>        fetch = +refs/heads/<em>:refs/remotes/github-origin/</em><br>        url = <a href="https://github.com/openstack/neutron.git" target="_blank" rel="external">https://github.com/openstack/neutron.git</a><br>[branch “master”]<br>        remote = my-origin<br>        merge = refs/heads/master<br>[branch “my-havana”]<br>        remote = my-origin<br>        merge = refs/heads/my-havana<br>[branch “my-grizzly”]<br>        remote = my-origin<br>        merge = refs/heads/my-grizzly<br>2, 更新上面所有的remote分支 git remote update<br>3, 因为是要将社区的havana分支的代码同步到自己havana分支，所以为两个远程分支创建对应的本地分支<br>   git checkout -b github-havana github/stable/havana<br>   git checkout -b my-havana origin/my-havana<br>4, 合并，成功后应该用git log -1能看到一个新的合并提交。如果有冲突的话就解决冲突再git merge next<br>   git checkout my-havana<br>   git merget github-havana<br>5, 运行单元测试<br>  tox –recreate -e py27,pep8<br>  ./run_tests.sh -V -f<br>6, 用-n参数(dry-run)测试提交, 提交到名为my-origin的远程分支的my-havana分支中：<br>   git push -n my-origin HEAD:refs/heads/my-havana<br>   若没有问题的话真正提交：<br>   git push  my-origin HEAD:refs/heads/my-havana</your_ip></p>
<p>场景三：cherry pick代码<br>例如，一个社区bug 1161195被提交到master分支, 社区没有批准进stable-havana分支，或者来不及等它进，这时候公司内部要求进my-havana分支的话，可以将这个bug通过cherry pick合并过来。<br>1, 为这个任务创建一个bug.<br>   git checkout stable-havana<br>   git pull<br>   git checkout -b bug/1161195<br>2, 在社区找到bug 1161195的代码提交id, 如:5f3fa391ed499750ad68ad5b000b4e2e0a86978e<br>   可以通过 git log |grep -B 30 <commit-id>查看确认<br>3, 在bug/1161195分支上执行cherry pick命令：<br>   git cherry-pick -s  -x  <commit-id><br>4, 提交代码评审<br>   git commit or git commit –amend<br>   git review stable-havana</commit-id></commit-id></p>
<p>另一个例子：</p>
<p>git clone <a href="https://github.com/openstack/charm-ceilometer" target="_blank" rel="external">https://github.com/openstack/charm-ceilometer</a><br>git checkout stable/16.07 </p>
<h1 id="come-from-lauchpad-page"><a href="#come-from-lauchpad-page" class="headerlink" title="come from lauchpad page"></a>come from lauchpad page</h1><p>git fetch git://git.openstack.org/openstack/charm-ceilometer refs/changes/00/375100/1 &amp;&amp; git cherry-pick FETCH_HEAD</p>
<p>git review stable/18.07</p>
<p>场景四：将git产生的patch变成和svn兼容</p>
<p>#!/bin/sh<br>#</p>
<h1 id="git-svn-diff"><a href="#git-svn-diff" class="headerlink" title="git-svn-diff"></a>git-svn-diff</h1><h1 id="Generate-an-SVN-compatible-diff-against-the-tip-of-the-tracking-branch"><a href="#Generate-an-SVN-compatible-diff-against-the-tip-of-the-tracking-branch" class="headerlink" title="Generate an SVN-compatible diff against the tip of the tracking branch"></a>Generate an SVN-compatible diff against the tip of the tracking branch</h1><p>REV=<code>git svn find-rev $(git rev-list --date-order --max-count=1 master)</code><br>git diff –no-prefix $(git rev-list –date-order –max-count=1 master) $<em> |sed -e “s/^+++ .</em>/&amp; (working copy)/“ \<br>-e “s/^— .<em>/&amp; (revision $REV)/“ \<br>-e “s/^diff –git [^[:space:]]</em>/Index:/“ -e “s/^index.*/===================================================================/“</p>
<p>在本机上创建一个共享的git库：</p>
<p>sudo groupadd git<br>sudo useradd -d /home/git -m -g git git<br>sudo passwd git<br>su - git<br>mkdir /home/git/patent.git<br>cd patent.git/<br>git init –bare –shared</p>
<h1 id="test-in-another-directory"><a href="#test-in-another-directory" class="headerlink" title="test in another directory"></a>test in another directory</h1><p>cd /bak/tmp<br>git clone git@9.123.136.122:/home/git/patent.git<br>cd patent<br>cp test.doc .<br>git add test.doc<br>git commit -m “init commit”<br>git push origin master</p>
<p>这时候肯定是希望大家通过git用户可以访问git库，但又不希望他们通过ssh登录这台机器，所以修改/etc/passwd文件，</p>
<p>将     “  git:x:502:503::/home/git:/bin/bash ”</p>
<p>改成：git:x:502:503::/home/git:/usr/bin/git-shell</p>
<p>这时候还需要将每个客户端的公钥加到/home/git/.ssh/authorized_keys文件里，公钥可以通过ssh-keygen -t rsa生成。</p>
<p>场景五，使用git命令操作bzr与hg</p>
<p>sudo apt-get install mercurial python-hglib<br>wget <a href="https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg" target="_blank" rel="external">https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg</a><br>wget <a href="https://raw.githubusercontent.com/felipec/git-remote-bzr/master/git-remote-bzr" target="_blank" rel="external">https://raw.githubusercontent.com/felipec/git-remote-bzr/master/git-remote-bzr</a><br>sudo chmod 755 ./git-remote-<em><br>sudo mv git-remote-</em> /usr/bin</p>
<p>examples:<br>git clone “bzr::lp:ubuntu/ifupdown”<br>git clone “bzr::lp:debian/ifupdown”<br>git clone “hg::<a href="http://anonscm.debian.org/hg/collab-maint/ifupdown/" target="_blank" rel="external">http://anonscm.debian.org/hg/collab-maint/ifupdown/</a>“</p>
<p>场景六，依赖提交</p>
<p>有一种情况，我向社区同时提交了两个有依赖的提交，在本地提交这两个提交之后直接git review即可。<br>现在前一个提交（假设提交id为：187f）要修改，怎么办呢？<br>a, git rebase 187f^ –interactive， 回到要修改的提交的前一个点上<br>b, 修改那个提交，最后git commit –amend<br>c, git rebase –continue, 继续变基并且返回到原来的HEAD处<br>如果中间出现“interactive rebase already started”， 用“git rebase -i –abort”命令重来。</p>
<p>场景七, 在lp上创建私有git仓库, 并使用lp评审代码</p>
<p>git clone <a href="https://git.launchpad.net/layer-snap" target="_blank" rel="external">https://git.launchpad.net/layer-snap</a></p>
<p>git remote set-url –push origin no_push</p>
<h1 id="注意，这里有一个坑，下面链接不应该有-git，并且layer-snap必须和lp里实际的工程名字相同。"><a href="#注意，这里有一个坑，下面链接不应该有-git，并且layer-snap必须和lp里实际的工程名字相同。" class="headerlink" title="注意，这里有一个坑，下面链接不应该有+git，并且layer-snap必须和lp里实际的工程名字相同。"></a>注意，这里有一个坑，下面链接不应该有+git，并且layer-snap必须和lp里实际的工程名字相同。</h1><p>#如果有+git的话，提交PR时， 原本指定target是<a href="https://git.launchpad.net/layer-snap，" target="_blank" rel="external">https://git.launchpad.net/layer-snap，</a> 但它会自动变回~zhhuabj/+git/layer-snap:master</p>
<p>#并且可能会报这种错误”’~zhhuabj/+git/layer-snap:lp1847574 is not mergeable into layer-snap:master’“</p>
<h1 id="git-remote-add-zhhuabj-git-ssh-zhhuabj-git-launchpad-net-zhhuabj-git-layer-snap"><a href="#git-remote-add-zhhuabj-git-ssh-zhhuabj-git-launchpad-net-zhhuabj-git-layer-snap" class="headerlink" title="git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/+git/layer-snap"></a>git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/+git/layer-snap</h1><p>git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/layer-snap<br>git push –set-upstream zhhuabj master  #then you will see the new repo in <a href="https://code.launchpad.net/~zhhuabj/+git" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/+git</a></p>
<p>git remote -v<br>git branch -a<br>git fetch –all<br>git fetch –all –prune</p>
<p>#git fetch origin</p>
<p>#git checkout master</p>
<p>#git rebase origin/master</p>
<p>git checkout -b lp1847574<br>git commit -m ‘test’<br>git commit –amend -author=’Hua <xxx.mail.com>‘<br>git push –set-upstream zhhuabj lp1847574</xxx.mail.com></p>
<h1 id="Propose-for-merging-https-code-launchpad-net-zhhuabj-git-layer-snap-ref-lp1847574"><a href="#Propose-for-merging-https-code-launchpad-net-zhhuabj-git-layer-snap-ref-lp1847574" class="headerlink" title="Propose for merging - https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574"></a>Propose for merging - <a href="https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574</a></h1><h1 id="zhhuabj-git-layer-snap-lp1847574-gt-layer-snap-master"><a href="#zhhuabj-git-layer-snap-lp1847574-gt-layer-snap-master" class="headerlink" title="~zhhuabj/+git/layer-snap:lp1847574 -&gt; layer-snap:master"></a>~zhhuabj/+git/layer-snap:lp1847574 -&gt; layer-snap:master</h1><p>#target repository -&gt; other: ~openstack-charm-testers/xxxstack-bundles/+git/xxxstack-bundles<br>target repository -&gt; other: <a href="https://git.launchpad.net/layer-snap" target="_blank" rel="external">https://git.launchpad.net/layer-snap</a><br>target branch: refs/heads/master</p>
<p>场景八: 内核</p>
<p>git remote add xenial git://kernel.ubuntu.com/ubuntu/ubuntu-xenial.git<br>git fetch xenial<br>git log –no-merges –oneline xenial/hwe…xenial/master drivers/net/ethernet/mellanox/mlx5/</p>
<p>其它命令：</p>
<p>git reset HEAD~1                      撤销最后一次提交。<br>git reset –hard HEAD^             撤销最后一次提交并清除本地修改</p>
<p>git reset –hard Merge_Head  和服务器保持一致</p>
<p>git clean -dfx                               删除本地未在版本库的东西</p>
<p>git stash  &amp; git stash list &amp; git stash pop  暂存代码</p>
<p>git rebase -i –abort </p>
<p>git tag –contains af055e37a91d215d7174d0b84c86795ca81086a7</p>
<p>git branch -a –contains <sha1></sha1></p>
<p>git tag –contains <sha1></sha1></p>
<p>git grep smp_call_function_many</p>
<h1 id="refer-https-www-oreilly-com-library-view-git-pocket-guide-9781449327507-ch09-html"><a href="#refer-https-www-oreilly-com-library-view-git-pocket-guide-9781449327507-ch09-html" class="headerlink" title="refer https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html"></a>refer <a href="https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html" target="_blank" rel="external">https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html</a></h1><p>git log v4.13..master –oneline –no-merges kernel/smp.c</p>
<p>git log v4.13..master –grep=smp –oneline –no-merges kernel/smp.c</p>
<p>git log |grep Ibaf4385              一个patch只有一部分，另一部分肯定是被其他patch覆盖了， 可用’git log’查找   </p>
<p>git revert 7b60534</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently/" itemprop="url">Root Mi note lte with SuperSU without flashing TWRP Recovery permanently</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-22T11:50:03+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="作者：张华-发表于：2017-06-23"><a href="#作者：张华-发表于：2017-06-23" class="headerlink" title="作者：张华 发表于：2017-06-23"></a>作者：张华 发表于：2017-06-23</h2><p>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> ) ##</p>
<p>I have two Meizu MX4 ubuntu cellphones, now I will re-install Flyme or native google android on them. All softwares can be downloaded from the link: <a href="https://pan.baidu.com/s/1bpo0xbx" target="_blank" rel="external">https://pan.baidu.com/s/1bpo0xbx</a></p>
<p>1, Start MX4 Ubuntu, and enable ‘Developer Mode’ from ‘System Setting -&gt; About Cellphone’ menu.</p>
<p>2, Install the tools adb and fastboot from the link <a href="http://esausilva.com/wp-content/plugins/cimy-counter/cc_redirect.php?cc=platform-tools-linux&amp;fn=http://esausilva.com/misc/android/platform-tools-linux.tar.gz" target="_blank" rel="external">http://esausilva.com/wp-content/plugins/cimy-counter/cc_redirect.php?cc=platform-tools-linux&amp;fn=http://esausilva.com/misc/android/platform-tools-linux.tar.gz</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/bak/java/platform-tools:$PATH</span><br></pre></td></tr></table></figure>
<p>3, Make sure your cellphone can connect to compute (Ubuntu) via USB and adb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo lsusb |grep Meizu</span><br><span class="line">  Bus 003 Device 010: ID 2a45:0c02 Meizu Corp. MX Phone (MTP &amp; ADB)</span><br><span class="line">$ cat /etc/udev/rules.d/51-android.rules</span><br><span class="line">  SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;2a45&quot;, MODE=&quot;0666&quot;, SYMLINK+=&quot;android_adb&quot;</span><br><span class="line">$ cat ~/.android/adb_usb.ini</span><br><span class="line">  2a45</span><br><span class="line">$ sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</span><br><span class="line">$ adb kill-server &amp;&amp; adb start-server</span><br><span class="line">$ adb devices</span><br><span class="line">  List of devices attached</span><br><span class="line">  75HABLMCYUR3	device</span><br><span class="line">$ sudo apt-get install go-mtpfs mtp-tools gmtp</span><br><span class="line">$ sudo mtp-detect</span><br><span class="line">  libmtp version: 1.1.10</span><br><span class="line">  Listing raw device(s)</span><br><span class="line">  Device 0 (VID=2a45 and PID=0c02) is a Meizu MX Phone (MTP+ADB).</span><br><span class="line">  Found 1 device(s):</span><br><span class="line">  Meizu: MX Phone (MTP+ADB) (2a45:0c02) @ bus 3, dev 10</span><br></pre></td></tr></table></figure>
<p>4, Brush the thirty party recovery. Shutdown your cellphone, and press POWER + VOL-DOWN to enter fastboot mode. Use usb to connect cellphone and compute, than run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hua@node1:/bak/tools/mx4 $ fastboot flash recovery recovery.img</span><br><span class="line">sending &apos;recovery&apos; (10000 KB)...</span><br><span class="line">OKAY [  0.506s]</span><br><span class="line">writing &apos;recovery&apos;...</span><br><span class="line">OKAY [  0.410s]</span><br><span class="line">finished. total time: 0.916s</span><br></pre></td></tr></table></figure></p>
<p>5, Press POWER + VOL-UP to enter above recoerty, and Click ‘Install Zip -&gt; Install zip from sideload’, then run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hua@node1:/bak/java/platform-tools$ adb sideload update.zip</span><br><span class="line">sending: &apos;sideload&apos;  100%</span><br></pre></td></tr></table></figure>
<p>NOTE: if you want to install raw google android, just run ‘adb sideload cm-13.0-20160820-UNOFFICIAL-mx4.zip’ instead.</p>
<p>6, Reboot the cellphone. OK.</p>
<h2 id="附录-小米手机线刷开发版-国际版"><a href="#附录-小米手机线刷开发版-国际版" class="headerlink" title="附录 - 小米手机线刷开发版/国际版"></a>附录 - 小米手机线刷开发版/国际版</h2><p>现在, 小米不再允许行货和国际版互刷ROM, 它加入了防回滚保护（Anti-Rollback Protection）机制. 这意味着，如果手机当前处于较高的MIUI版本，降级刷机大概率会变砖。实测发现，行货机刷国际版ROM将卡死在Recovery界面，显示“this MIUI version can’t be installed on this device”。当然，想要绕过官方的限制也有办法，前提是解锁bootloader，然后用TWRP、fastboot或者MiFlash刷机。使用MiFlash时切记勾选“Clean All”，不要选“clean all and lock”。如果你不幸刷在国际版和国行版ROM之间刷机成砖，只有进入EDL（紧急下载）模式自救。然而，EDL模式仅对极为有限的小米账号开放权限。本文测试的手机是mi note lte不再之列.</p>
<p>1, 下载dev rom是virgo_images_5.12.4_20151126.0000.5_4.4_cn_eb14b0eb8d.tgz (<a href="http://pan.baidu.com/s/1bfGxVg" target="_blank" rel="external">http://pan.baidu.com/s/1bfGxVg</a>). rom里的内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NOTE: 这步应该在解锁, 以及在开发模式打开充许OEM之后运行</span><br><span class="line">$ ls virgo_images_5.12.4_20151126.0000.5_4.4_cn</span><br><span class="line">flash_all.bat  flash_all_except_data_storage.bat  flash_all_except_data_storage.sh  flash_all_except_storage.bat  flash_all_except_storage.sh  flash_all.sh  images  misc.txt</span><br><span class="line">$ ls virgo_images_5.12.4_20151126.0000.5_4.4_cn/images/</span><br><span class="line">8974_msimage.mbn  cache.img  emmc_appsboot.mbn  gpt_backup0.bin  gpt_main0.bin  MPRG8974.mbn  patch0.xml   rawprogram0.xml  rpm.mbn   sdi.mbn     tz.mbn</span><br><span class="line">boot.img          dummy.img  flash.xml          gpt_both0.bin    misc.img       NON-HLOS.bin  persist.img  recovery.img     sbl1.mbn  system.img  userdata.img</span><br><span class="line"></span><br><span class="line">$ cat flash_all.sh</span><br><span class="line">fastboot $* getvar product 2&gt;&amp;1 | grep &quot;^product: *MSM8974$&quot;</span><br><span class="line">if [ $? -ne 0 ] ; then echo &quot;Missmatching image and device&quot;; exit 1; fi</span><br><span class="line">fastboot $* getvar board_version 2&gt;&amp;1 | grep &quot;^board_version: *5.[^5]&quot;</span><br><span class="line">if [ $? -ne 0 ] ; then echo &quot;Missmatching board version&quot;; exit 1; fi</span><br><span class="line"></span><br><span class="line">fastboot $* flash tz `dirname $0`/images/tz.mbn</span><br><span class="line">fastboot $* flash dbi `dirname $0`/images/sdi.mbn</span><br><span class="line">fastboot $* flash sbl1 `dirname $0`/images/sbl1.mbn</span><br><span class="line">fastboot $* flash rpm `dirname $0`/images/rpm.mbn</span><br><span class="line">fastboot $* flash aboot `dirname $0`/images/emmc_appsboot.mbn</span><br><span class="line">fastboot $* erase boot</span><br><span class="line">fastboot $* erase DDR</span><br><span class="line">fastboot $* flash misc `dirname $0`/images/misc.img</span><br><span class="line">fastboot $* flash modem+modem1 `dirname $0`/images/NON-HLOS.bin</span><br><span class="line">fastboot $* flash system+system1 `dirname $0`/images/system.img</span><br><span class="line">fastboot $* flash cache `dirname $0`/images/cache.img</span><br><span class="line">fastboot $* flash userdata `dirname $0`/images/userdata.img</span><br><span class="line">fastboot $* flash recovery `dirname $0`/images/recovery.img</span><br><span class="line">fastboot $* flash boot+boot1 `dirname $0`/images/boot.img</span><br><span class="line">fastboot $* reboot</span><br></pre></td></tr></table></figure></p>
<p>2, 手机通过MTP模式连接电脑, 通过lsusb找到设备号为: Bus 003 Device 029: ID 2717:0360<br>3, adb连接手机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># sudo apt-get install android-tools-adb android-tools-fastboot</span><br><span class="line">$ cat /etc/udev/rules.d/51-android.rules</span><br><span class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;2717&quot;, MODE=&quot;0666&quot;, SYMLINK+=&quot;android_adb&quot;</span><br><span class="line">sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</span><br><span class="line">adb kill-server &amp;&amp; adb start-server</span><br><span class="line">sudo mtp-detect</span><br><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">d6b38a3a	device</span><br></pre></td></tr></table></figure></p>
<p>如果不出来, 是需要 狂按”设置我的设备 -&gt; 全部参数 -&gt; MINU版本”进入开发者模式, 然后”设置 -&gt; 更多设置 -&gt; 开发者选项”打开USB调试”和”FASTBOOT刷机模式”<br>4, 和Meizu是一样的, 也是音量下+电源键进入fastboot模式, 不连电脑，音量下+电源键长按进入fastboot,USB线连接电脑. 注: 同样, 也是音量上+电源键可安装第三方recovery, 见 [5].<br>5, 刷机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x flash_all.sh</span><br><span class="line">./flash_all.sh</span><br><span class="line">#./flash_all_except_storage.sh  #clean cache, but not clean data</span><br></pre></td></tr></table></figure></p>
<p>6, 继续root, 刷机成功之后, 已经是开发版, 进入手机，安全中心 -&gt; 授权管理 -&gt; ROOT,反复确认后，手机会下载对应的ROOT包安装后重启。机后，安全中心 -&gt; 授权管理已经可以进入. 这时候就可以使用’adb root’了.</p>
<p>注: 遗憾地是, 机子刚好音量下键损坏, 这样借助如刷机精灵里的实用工具进入fastboot或recovery模式. 好吧, 又得整到windows上了. 照着文档[4]. (注: 其实不用转到windows, 直接在linux下使用”adb reboot bootloader”也可以重启至fastboot模式”<br>1, 安装小米助手, 当手机连上win7电脑时会自动安装驱动 - <a href="http://zhushou.xiaomi.com/" target="_blank" rel="external">http://zhushou.xiaomi.com/</a><br>2, 安装线刷工具 - <a href="http://bigota.d.miui.com/tools/MiPhone20141107.exe" target="_blank" rel="external">http://bigota.d.miui.com/tools/MiPhone20141107.exe</a><br>3, 线刷包解压 - <a href="http://pan.baidu.com/s/1bfGxVg" target="_blank" rel="external">http://pan.baidu.com/s/1bfGxVg</a><br>4, 安装刷机精灵, 使用里面的fastboot实用工具根本无法进入fastboot, 所以直接采用刷机精灵的一键刷机功能上传线刷包线刷. 但出错了, 说是刷入的版本比机子已有的版本低会线刷失败.<br>5, 但上一步一键刷机功能代替音量减键成功让手机进入了fastboot模式, 所以此时切换成小米的刷机工具再试, 结果小米的刷机工具也有bug, 报找不到远程分区.<br>6, 试图找到小米原生的线刷包恢复, 但官网上找不着.<br>7, 还好, 手机进入fastboot模式之后, 没有刷机成功, 只要手机还有电, 再重启还是进入的是flashboot模式, 这样避免了坏的音量键及进不了系统. 继续找啊找试啊试, 终于发现这个包是好的(Xiaomi_Mi_Note_LTE_V9.5.1.0.MXEMIFA_20180406.0000.00_Global_6.0_XFT.zip, <a href="https://firmwarefile.com/xiaomi-mi-note-lte" target="_blank" rel="external">https://firmwarefile.com/xiaomi-mi-note-lte</a> )<br>8, 这个网站(<a href="https://xiaomiflashtool.com/)下载的最新的xiaomiflashtool反而不行说找不着设备" target="_blank" rel="external">https://xiaomiflashtool.com/)下载的最新的xiaomiflashtool反而不行说找不着设备</a>. 注: 这个tool也可在driver菜单自动安装驱动.<br>9, 这样成功换上了Xiaomi_Mi_Note_LTE_V9.5.1.0.MXEMIFA_20180406.0000.00_Global_6.0_XFT.zip, 这似乎是国际稳定版哦.</p>
<p>如何将国际稳定版转成国际开发版呢? 再线刷一遍. 这次都在linux下进行.<br>1,Install Global Developer ROM for Redmi Note 4G<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># search in google by &apos;eveloper bigota.d.miui.com redmi note 4g -stable&apos;, and download fastboot rom - https://c.mi.com/thread-510369-1-0.html</span><br><span class="line">#NOTE: this recovery - http://bigota.d.miui.com/7.11.6/miui_MINoteGlobal_7.11.6_ce58816710_6.0.zip</span><br><span class="line">wget http://bigota.d.miui.com/7.11.6/virgo_global_images_7.11.6_20171106.0000.00_6.0_global_be457b58a3.tgz</span><br><span class="line">tar -xf virgo_global_images_7.11.6_20171106.0000.00_6.0_global_be457b58a3.tgz</span><br><span class="line">cd virgo_global_images_7.11.6_20171106.0000.00_6.0_global</span><br><span class="line">adb reboot bootloader</span><br><span class="line">chmod +x flash_all.sh</span><br><span class="line">./flash_all.sh</span><br><span class="line">运行./flash_all.sh相当于:</span><br><span class="line">#https://blog.csdn.net/quqi99/article/details/51636869</span><br><span class="line">fastboot flash boot boot.img</span><br><span class="line">fastboot flash recovery recovery.img</span><br><span class="line">fastboot erase system</span><br><span class="line">fastboot flash system system.img</span><br><span class="line">#fastboot flash userdata userdata.img</span><br><span class="line">#fastboot flash cache cache.img</span><br></pre></td></tr></table></figure></p>
<p>2, Custom TWRP for Xiaomi Redmi Note 4G (twrp-3.3.1-0-dior.img - <a href="https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html" target="_blank" rel="external">https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html</a>),<br>注: 目前小米也关闭了解锁功能(<a href="https://www.miui.com/unlock/index.html)不允许行货和国际版互刷ROM" target="_blank" rel="external">https://www.miui.com/unlock/index.html)不允许行货和国际版互刷ROM</a>, 小米增加了一段区域对照码, 想绕开限制, 只有先不互刷先解锁(即国行版先刷国内ROM骗过解锁), 然后再用TWRP, fastboot或mifalsh刷机.<br>但mi note lte无须解锁, 因为’fastboot oem device-info’显示’Device unloced: true”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adb reboot bootloader</span><br><span class="line">$ fastboot oem device-info</span><br><span class="line">...</span><br><span class="line">(bootloader) 	Device tampered: true</span><br><span class="line">(bootloader) 	Device unlocked: true</span><br><span class="line">(bootloader) 	Charger screen enabled: false</span><br><span class="line">(bootloader) 	Display panel:</span><br><span class="line">OKAY [  0.006s]</span><br><span class="line">finished. total time: 0.006s</span><br></pre></td></tr></table></figure></p>
<p>继续刷TWRP:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.twrp.me/dior/twrp-3.3.1-0-dior.img</span><br><span class="line">adb reboot bootloader              #enter fastboot mode</span><br><span class="line">#fastboot devices                     #just for case when locking BL lock</span><br><span class="line"># fastboot flash unlock unlock.key  #if need to unlock, eg https://www.techmesto.com/guide-unlock-bootloader-nokia-android-phones/</span><br><span class="line">#fastboot oem unlock</span><br><span class="line">fastboot flash recovery twrp-3.3.1-0-dior.img</span><br><span class="line">fastboot reboot</span><br></pre></td></tr></table></figure></p>
<p>但是上面刷了之后不work,, 刷了TWRP之后’adb reboot recovery’进入的还是Mi-Recovery 2.0.1模式, 官网说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html</span><br><span class="line">Note many devices will replace your custom recovery automatically during first boot. To prevent this, use Google to find the proper key combo to enter recovery. After typing fastboot reboot, hold the key combo and boot to TWRP. Once TWRP is booted, TWRP will patch the stock ROM to prevent the stock ROM from replacing TWRP. If you don&apos;t follow this step, you will have to repeat the install.</span><br></pre></td></tr></table></figure></p>
<p>但运行完’fastboot reboot’再按音量上键+电源键根本就进不了recovery模式, 可能是我的音量键有问题的原因吧. 此路不通.这个网页说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.reddit.com/r/Xiaomi/comments/bdurg8/replace_mi_recovery_with_twrp/</span><br><span class="line">With the new protection you need to boot from adb to twrp, by fastboot boot twrp.img. When boot in twrp transfer the image and flash inside from twrp. Now, it will reboot on TWRP recovery.</span><br></pre></td></tr></table></figure></p>
<p>所以我们可以先’fastboot boot’来启动TWRP, 再将TWRP持久化. 但是试了很多多twrp版本都报下列错”dtb not found”.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ fastboot boot twrp-3.3.1-0-dior.img</span><br><span class="line">downloading &apos;boot.img&apos;...</span><br><span class="line">OKAY [  0.433s]</span><br><span class="line">booting...</span><br><span class="line">FAILED (remote: dtb not found)</span><br><span class="line">finished. total time: 0.449s</span><br></pre></td></tr></table></figure></p>
<p>无奈下载网页(<a href="http://en.miui.com/thread-213264-1-1.html" target="_blank" rel="external">http://en.miui.com/thread-213264-1-1.html</a>) 或这个网页(<a href="http://en.miui.com/thread-628692-1-1.html)上提到的twrp均可成功" target="_blank" rel="external">http://en.miui.com/thread-628692-1-1.html)上提到的twrp均可成功</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot boot twrp.img</span><br></pre></td></tr></table></figure></p>
<p>但语言却不是英语看不懂啊, 没办法, 只好在网上找一个有图的, 照着大致的位置点了.<br><img src="https://img-blog.csdnimg.cn/20190822112723313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly96aGh1YWJqLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190822112742744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly96aGh1YWJqLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上面需要事先将supersu下载放到手机上, 注意: 只有/sdcard/Download是可写的. (其他目录需要root权限运行”adb remount  #mount -o remount,rw /system”才行”.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push SR5-SuperSU-v2.82-SR5-20171001224502.zip /sdcard/Download/</span><br></pre></td></tr></table></figure>
<p>这样就完成了在不替换现有的mi-recovery的情况下同时又使用TWRP安装supersu, 可参考 - <a href="https://in.c.mi.com/thread-79402-1-1.html" target="_blank" rel="external">https://in.c.mi.com/thread-79402-1-1.html</a></p>
<p>3, 可选  - 本来正常情况TWRP能直接flash的话, 应该可以这样安装supersu的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reboot recovery        #enter recovery mode</span><br><span class="line">adb sideload adb sideload SR5-SuperSU-v2.82-SR5-20171001224502.zip</span><br></pre></td></tr></table></figure></p>
<p>4, 安装必要的软件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># use adb via wifi</span><br><span class="line">/su/bin/su root</span><br><span class="line">setprop service.adb.tcp.port 5555</span><br><span class="line">setprop persist.adb.tcp.port 5555</span><br><span class="line">start adbd</span><br><span class="line">adb connect 192.168.99.249:5555</span><br><span class="line">adb install Complete\ Linux\ Installer_v3.0\ BETA_apkpure.com.apk</span><br><span class="line"></span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line"></span><br><span class="line"># grep &apos;system&apos; /proc/mounts</span><br><span class="line">mount -o rw,remount -t ext4 /dev/block/platform/msm_sdcc.1/by-name/system /system</span><br><span class="line"></span><br><span class="line"># ssh server -  by install SSHDroid and use supersu to give it root</span><br><span class="line"></span><br><span class="line"># ssh client</span><br><span class="line">ln -s /data/data/berserker.android.apps.sshdroid/dropbear/ssh /system/bin/ssh</span><br><span class="line">chmod o+rx /system/bin/ssh</span><br><span class="line"></span><br><span class="line"># key</span><br><span class="line">cd /data/data/berserker.android.apps.sshdroid/dropbear/</span><br><span class="line">./dropbearkey -t rsa -f ../home/.ssh/id_rsa &gt; ../home/.ssh/id_rsa.pub</span><br><span class="line">cd /data/data/berserker.android.apps.sshdroid/home</span><br><span class="line">echo &apos;ssh hua@t440p -i ~/.ssh/id_rsa&apos; &gt; ./ssht440p.sh</span><br><span class="line">sh ssht440p.sh</span><br><span class="line"></span><br><span class="line"># use vi in adb shell, we don&apos;t need to add busybox prefix in ssh</span><br><span class="line">busybox vi /etc/hosts</span><br></pre></td></tr></table></figure></p>
<p>5, run ubuntu 18.04 on android by using linuxdeploy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#run ubuntu 18.04 on android by using linuxdeploy</span><br><span class="line">#https://www.maketecheasier.com/install-ubuntu-on-android-linux-deploy/</span><br><span class="line">wget https://github.com/meefik/busybox/releases/download/1.30.1/busybox-1.30.1-41.apk</span><br><span class="line">adb install busybox-1.30.1-41.apk  #install into /system/xbin</span><br><span class="line">wget https://github.com/meefik/linuxdeploy/releases/download/2.4.0/linuxdeploy-2.4.0-251.apk</span><br><span class="line">adb install linuxdeploy-2.4.0-251.apk</span><br><span class="line">adb install vnc_viewer_remote_desktop.apk</span><br><span class="line"></span><br><span class="line">#enter linuxdeploy</span><br><span class="line">telnet 192.168.99.249 5023</span><br><span class="line"></span><br><span class="line">#but hit the error: chroot: can&apos;t execute &apos;/bin/su&apos;: No such file or directory</span><br><span class="line">/su/bin/su root</span><br><span class="line">/data/user/0/ru.meefik.linuxdeploy/files/bin/linuxdeploy shell</span><br><span class="line">mkdir /data/local/mnt/&#123;dev,sys,proc&#125;</span><br><span class="line">#for d in dev sys proc; do mount -o bind /$d /data/local/mnt/$d; done</span><br><span class="line">#umount /data/local/mnt/&#123;dev,proc,sys&#125;</span><br><span class="line">chroot /data/local/mnt/ /bin/pwd</span><br><span class="line">ls /data/local/mnt/bin/su</span><br><span class="line"></span><br><span class="line">上面的chroot错误实际上是image文件没有创建的原因</span><br><span class="line">ls /data/data/ru.meefik.linuxdeploy/files/config/linux.conf</span><br><span class="line">rm -rf /sdcard/linux.img</span><br><span class="line">vi /data/user/0/ru.meefik.linuxdeploy/files/include/bootstrap/rootfs/deploy.sh</span><br><span class="line"></span><br><span class="line">20191012更新</span><br><span class="line">架构使用armhf，源使用http://mirrors.ustc.edu.cn/ubuntu-ports/时可以进入debootstrap了， 但是在lsb_base这步总是出错， 怀疑是科大的源有问题， 所以换成腾讯的源https://mirrors.cloud.tencent.com/ubuntu-ports/后可以debootstrap成功， 但是在chroot /data/local/mnt bin/su - root -c &apos;DEBIAN_FRONTEND=nointeractive apt-get install -yfq --no-install-recommends dbus&apos;这步也是相当地慢(才0.10k/s)，不得已， 又退回使用http://ports.ubuntu.com/ubuntu-ports/， 然后就成功了， 在手机上通过‘ssh ubuntu@localhost’登录bionic。</span><br><span class="line">1, 但ubuntu里的chrome仍然无法在外面使用，而使用android版本的chrome又无法打开SF(需要设置浏览器中的查看桌面版网页，但仍然无法选择sf owner), 试试microsoft edge</span><br><span class="line">2, 下面adb或者ssh两种方式连接手机</span><br><span class="line">/su/bin/su root</span><br><span class="line">setprop service.adb.tcp.port 5555</span><br><span class="line">setprop persist.adb.tcp.port 5555</span><br><span class="line">start adbd</span><br><span class="line">adb connect 192.168.99.249:5555</span><br><span class="line">adb devices</span><br><span class="line">3, 手机外接大屏幕的话，采用android中的”无线投屏&quot;或者在连接好adb之后运行“sudo snap install --channel=edge scrcpy &amp;&amp; scrcpy --fullscreen --show-touches --bit-rate 2M --max-size 800&quot; (注：若电脑的scrcpy容器是黑屏的话是因为手机是黑屏的）</span><br><span class="line"></span><br><span class="line">若手机未root的话, 可以这个投屏:</span><br><span class="line">将手机与电脑连接至相同wifi 记录WLAN设置中手机的IP地址</span><br><span class="line">连接数据线并允许调试</span><br><span class="line">终端执行 adb tcpip 5555 并在手机上点击“ 确定 ” ( 即在手机上开启5555端口 )</span><br><span class="line">终端执行 adb connect [手机IP]:5555 并在手机上点击“ 确定 ”( 此处可用 adb devices 检查连接情况 )</span><br><span class="line">拔掉数据线</span><br><span class="line">终端执行 adb reconnect offline 强制未授权设备重新连接</span><br><span class="line">终端执行 adb connect [手机IP]:5555 重新进行连接 ( 此处可用 adb devices 检查连接情况 )</span><br><span class="line">scrcpy --fullscreen --show-touches --bit-rate 2M --max-size 800</span><br><span class="line">想用声音的话, 可结合usbaudio - https://github.com/rom1v/usbaudio , 但是似乎usbaudio不支持android 8.1以上版本了</span><br></pre></td></tr></table></figure></p>
<h2 id="root-redmi4x-20200618更新"><a href="#root-redmi4x-20200618更新" class="headerlink" title="root redmi4x - 20200618更新"></a>root redmi4x - 20200618更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">安装要用到的软件</span><br><span class="line">1, xiaomi redmi 4x usb driver (Universal ADB Driver V6.0.zip - https://www.skyneel.com/xiaomi-usb-driver)</span><br><span class="line">2, xiaomi redmi 4x unlock bootloader (miflash_unlock-en-4.5.514.47.zip - https://en.miui.com/unlock/）</span><br><span class="line">3, xiaomi redmi 4x TWRP recovery (twrp-3.3.1-0-santoni.img - https://www.skyneel.com/supersu-zip-app)</span><br><span class="line">4, xiaomi redmi 4x supersu (UPDATE-SuperSU-v2.82-20170528234214.zip - https://www.skyneel.com/supersu-zip-app)</span><br><span class="line">5, xiaomi redmi 4x adb/fast-boot tool (platform-tools_r30.0.2-windows.zip - https://developer.android.com/studio/releases/platform-tools)</span><br><span class="line">6, [option] mi flash (https://www.skyneel.com/xiaomi-mi-flash-tool)</span><br><span class="line"></span><br><span class="line">unlock bootloader</span><br><span class="line">#https://www.skyneel.com/unlock-bootloader-xiaomi-devices</span><br><span class="line">1, 打开开发者模式， 并在开发者模式中打开USB调试， 并同时打开充许OEM解锁</span><br><span class="line">2, 先关机，USB线连上， 然后长按音量下+电源键进入fastboot模式, ( 注: 音量上+电源键是安装第三方recovery)</span><br><span class="line">3 , 并用这个手机的小米帐号登录后解锁手机。</span><br><span class="line">注: 目前小米也关闭了解锁功能(https://www.miui.com/unlock/index.html)不允许行货和国际版互刷ROM, 小米增加了一段区域对照码, 想绕开限制, 只有先不互刷先解锁(即国行版先刷国内ROM骗过解锁), 然后再用TWRP, fastboot或mifalsh刷机. 见我之前的一篇博客.</span><br><span class="line">mi note lte无须解锁, 因为’fastboot oem device-info’显示’Device unloced: true&quot;</span><br><span class="line">redmi 4x采用此段方法解锁</span><br><span class="line"></span><br><span class="line">flash TWRP</span><br><span class="line">1, usb连接手机，并在手机上点击信任后， 就可以使用adb命令了</span><br><span class="line">D:\&gt;adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">aa89d2927d93    device</span><br><span class="line">2, 进入bootloader模式： adb reboot bootloader</span><br><span class="line">3, 因为上面我们已经unlock bootloader了， 所以&apos;fastboot devices&apos;能看到东西</span><br><span class="line">E:\tools\redmi4x&gt;fastboot devices</span><br><span class="line">aa89d2927d93    fastboot</span><br><span class="line">4， fastboot.exe flash recovery twrp-3.3.1-0-santoni.img - fastboot.exe flash recovery twrp-3.3.1-0-santoni.img</span><br><span class="line">5, fastboot reboot</span><br><span class="line">6, 刷TWRP成功后， 再使用&apos;adb reboot recovery&apos;命令(相当于音量上+电源键的recovery模式)就能看到TWRP界面了， 而不是mi-recovery 3.0了</span><br><span class="line">但上面recovery twrp-3.3.1-0-santoni.img刷了之后不work, 进入的还是mi-recovery, 这时就又相当于我之前的一篇博客遇到的问题了（https://blog.csdn.net/quqi99/article/details/73613138), 所以得在不替换现有的mi-recovery的情况下同时又使用TWRP（fastboot boot twrp-3.3.1-0-santoni.img）安装supersu（可参考 - https://in.c.mi.com/thread-79402-1-1.html）</span><br></pre></td></tr></table></figure>
<p>完整步骤:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1, set up adb</span><br><span class="line"></span><br><span class="line">sudo apt-get install android-tools-adb android-tools-fastboot</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/udev/rules.d/51-android.rules&apos; &lt;&lt; EOF</span><br><span class="line">EOF</span><br><span class="line">sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</span><br><span class="line">adb kill-server &amp;&amp; adb start-server</span><br><span class="line">sudo mtp-detect</span><br><span class="line">adb devices</span><br><span class="line"></span><br><span class="line">2, enable developer mode, and enable usb debugging and OEM unlock in developer mode</span><br><span class="line"></span><br><span class="line">3, unlock bootloader in the page https://www.miui.com/unlock/index.html</span><br><span class="line"></span><br><span class="line">4, install global developer firmware because supersu can only be used in developer version</span><br><span class="line"></span><br><span class="line">#click &apos;Global -&gt; Fast boot Developer&apos; in https://mifirm.net/model/santoni.ttt to find download link</span><br><span class="line">axel http://bigota.d.miui.com/9.6.27/santoni_global_images_9.6.27_20190627.0000.00_7.1_global_67dc2b29e2.tgz</span><br><span class="line">tar -xf santoni_global_images_9.6.27_20190627.0000.00_7.1_global_67dc2b29e2.tgz</span><br><span class="line">adb reboot bootloader</span><br><span class="line">cd santoni_global_images_9.6.27_20190627.0000.00_7.1_global_67dc2b29e2 &amp;&amp; ./flash_all.sh</span><br><span class="line"></span><br><span class="line">5, then repeat the step 2 in new global deveoper version</span><br><span class="line"></span><br><span class="line">6, copy supersu into your cellphone</span><br><span class="line"></span><br><span class="line">adb push UPDATE-SuperSU-v2.82-20170528234214.zip /sdcard/Download/</span><br><span class="line">adb shell -- ls /sdcard/Download/</span><br><span class="line"></span><br><span class="line">7, boot from twrp instead of mi-recovery temporaily one time to install supersu</span><br><span class="line"></span><br><span class="line">adb reboot bootloader</span><br><span class="line">fastboot oem device-info   #double confim uncloked=true</span><br><span class="line">fastboot boot twrp-3.2.3-0-santoni.img</span><br><span class="line">#then install supersu from the GUI</span><br><span class="line"></span><br><span class="line">8, use supersu</span><br><span class="line"></span><br><span class="line">adb root</span><br><span class="line">/su/bin/su root</span><br><span class="line">setprop service.adb.tcp.port 5555</span><br><span class="line">setprop persist.adb.tcp.port 5555</span><br><span class="line">start adbd</span><br><span class="line">adb connect 192.168.99.249:5555</span><br><span class="line">adb devices</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://news.mydrivers.com/1/596/596856.htm" target="_blank" rel="external">https://news.mydrivers.com/1/596/596856.htm</a><br>[2] <a href="http://en.miui.com/thread-140154-1-1.html" target="_blank" rel="external">http://en.miui.com/thread-140154-1-1.html</a><br>[3] <a href="http://www.miui.com/thread-9286730-1-1.html" target="_blank" rel="external">http://www.miui.com/thread-9286730-1-1.html</a><br>[4] <a href="https://mrxn.net/other/xiaominote-shuaji.html" target="_blank" rel="external">https://mrxn.net/other/xiaominote-shuaji.html</a><br>[5] <a href="http://en.miui.com/forum.php?mod=viewthread&amp;tid=279802" target="_blank" rel="external">http://en.miui.com/forum.php?mod=viewthread&amp;tid=279802</a><br>[6] <a href="http://www.miui.com/thread-9286730-1-1.html" target="_blank" rel="external">http://www.miui.com/thread-9286730-1-1.html</a><br>[7] <a href="https://www.getdroidtips.com/custom-rom-redmi-note-4g/" target="_blank" rel="external">https://www.getdroidtips.com/custom-rom-redmi-note-4g/</a><br>[8] <a href="https://www.getdroidtips.com/official-twrp-recovery-for-xiaomi-redmi-note-4g/" target="_blank" rel="external">https://www.getdroidtips.com/official-twrp-recovery-for-xiaomi-redmi-note-4g/</a><br>[9] <a href="https://mi-globe.com/miui-firmware-rom-builder/" target="_blank" rel="external">https://mi-globe.com/miui-firmware-rom-builder/</a><br>[10] <a href="https://xiaomi.eu/community/threads/9-8-15.51822/" target="_blank" rel="external">https://xiaomi.eu/community/threads/9-8-15.51822/</a><br>[11] <a href="https://aubykhan.wordpress.com/2013/07/21/android-tip-boot-into-twrp-or-cwm-recovery-without-flashing/" target="_blank" rel="external">https://aubykhan.wordpress.com/2013/07/21/android-tip-boot-into-twrp-or-cwm-recovery-without-flashing/</a><br>[11] <a href="https://qc5.androidfilehost.com/dl/hhcuqmQO_jb6GzZK8aDvbw/1566669181/24421527759888026/TWRP_virgo.zip" target="_blank" rel="external">https://qc5.androidfilehost.com/dl/hhcuqmQO_jb6GzZK8aDvbw/1566669181/24421527759888026/TWRP_virgo.zip</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/24/如何让OpenStack支持多个FIP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/24/如何让OpenStack支持多个FIP/" itemprop="url">如何让OpenStack支持多个FIP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-24T20:24:20+08:00">
                2019-04-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2019-04-24)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>OpenStack可以支持多个公网IP吗?<br>OpenStack CLI不支持将同一个子网的多个FIPs分配给同一个fixed_ip的接口. 最简单的方法是直接分配FIP后手工配置在qrouter-xxx上, 并且手工做DNAT/SNAT. 但还有其他更好的方法吗?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be ip addr add 10.5.150.15 dev qg-60d62ebb-47</span><br><span class="line"></span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-OUTPUT -d 10.5.150.15/32 -j DNAT --to-destination 192.168.22.53</span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-PREROUTING -d 10.5.150.15/32 -j DNAT --to-destination 192.168.22.53</span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-float-snat -s 192.168.22.53/32 -j SNAT --to-source 10.5.150.15</span><br><span class="line"></span><br><span class="line">ubuntu@juju-54f223-pike-5:~$ ping 10.5.150.15</span><br><span class="line">PING 10.5.150.15 (10.5.150.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.15: icmp_seq=1 ttl=63 time=3.25 ms</span><br></pre></td></tr></table></figure>
<h2 id="创建多个tenant子网"><a href="#创建多个tenant子网" class="headerlink" title="创建多个tenant子网"></a>创建多个tenant子网</h2><p>创建多个tenant子网(fixed_ip), 将这些子网分配给VM, 然后再将多个FIP分别和这些tenant port关联. 结果是虚机内部多个网卡造成了不对称路由问题, 引入policy route之后解决了outbound的问题, 但仍然无法解决inbound的问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">step 1, created a test VM with the network private (192.168.21.0/24) and a fix_ip 192.168.21.5 and a FIP 10.5.150.2</span><br><span class="line"></span><br><span class="line">openstack server create --wait --image bionic --flavor m1.small --key-name mykey --nic net-id=e4074ac4-3c48-41f2-81e2-5a798468bf88 --min 1 --max 1 test</span><br><span class="line">fix_ip=&quot;192.168.21.5&quot;</span><br><span class="line">public_network=$(openstack network show ext_net -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $public_network -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address $fix_ip --port $(openstack port list --fixed-ip ip-address=$fix_ip -c id -f value)</span><br><span class="line"></span><br><span class="line">step 2, created another network private2 (192.168.22.0/24) and attach another interface into the test VM, then allocated a FIP (192.168.22.53) for it (192.168.22.51)</span><br><span class="line"></span><br><span class="line">openstack network create private2</span><br><span class="line">openstack subnet create --subnet-range 192.168.22.0/24 --network private2 --allocation-pool start=192.168.22.50,end=192.168.22.100 --gateway 192.168.22.1 priavte2-subnet</span><br><span class="line">openstack router add subnet provider-router priavte2-subnet</span><br><span class="line">nova interface-attach $(openstack server list -f value |awk &apos;/test/ &#123;print $1&#125;&apos;) --net-id=$(openstack network list -f value |awk &apos;/private2/ &#123;print $1&#125;&apos;)</span><br><span class="line">ssh ubuntu@10.5.150.2 -- sudo ifconfig ens5 up</span><br><span class="line"># then connection is disconnect because the default route moves from ens2 to ens5</span><br><span class="line">ssh ubuntu@10.5.150.2 -- dhcpclient ens5</span><br><span class="line"></span><br><span class="line">Finally it looks like - https://paste.ubuntu.com/p/yMJpJXYqDY/</span><br><span class="line"></span><br><span class="line">step 3, now the default gw is in ens5 so we can ping external inside test VM</span><br><span class="line"></span><br><span class="line">root@test:~# ping -I ens2 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.21.5 ens2: 56(84) bytes of data.</span><br><span class="line">root@test:~# ping -I ens5 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.22.53 ens5: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=3.34 ms</span><br><span class="line"></span><br><span class="line">step 4, outbound traffic works after adding policy router rules.</span><br><span class="line"></span><br><span class="line">echo &quot;1 t21&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip route add 192.168.21.0/24 dev ens2 src 192.168.21.5 table t21</span><br><span class="line">ip route add default via 192.168.21.5 dev ens2 table t21</span><br><span class="line">ip rule add from 192.168.21.5/24 table t21</span><br><span class="line"></span><br><span class="line">root@test:~# ping -I ens2 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.21.5 ens2: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=6.28 ms</span><br><span class="line">root@test:~# ping -I ens5 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.22.53 ens5: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=4.90 ms</span><br><span class="line"></span><br><span class="line">step 5, but inbound traffic for two FIPs can&apos;t work at the same time</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping -c 1 10.5.150.2</span><br><span class="line">PING 10.5.150.2 (10.5.150.2) 56(84) bytes of data.</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping -c 1 10.5.150.8</span><br><span class="line">PING 10.5.150.8 (10.5.150.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.8: icmp_seq=1 ttl=63 time=3.41 ms</span><br></pre></td></tr></table></figure></p>
<h2 id="创建多个FIP子网"><a href="#创建多个FIP子网" class="headerlink" title="创建多个FIP子网"></a>创建多个FIP子网</h2><p>创建多个外部网络的方法也不可行, 因为多个外部网络意味着多个router, 但无法将一个tenant subnet添加到多个routers中去:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ neutron router-interface-add provider-router2 private_subnet</span><br><span class="line">IP address 192.168.21.1 already allocated in subnet ada0b5b0-6780-4131-b07b-cee7069eab8d</span><br><span class="line">Neutron server returns request_ids: [&apos;req-8110ac5c-94ca-4b15-bf72-e199b635aa6f&apos;]</span><br></pre></td></tr></table></figure></p>
<p>这样在为一个port关联多个FIPs时报下列错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ neutron floatingip-associate $(neutron floatingip-list |grep $fip2 |awk &apos;&#123;print $2&#125;&apos;) $(neutron port-list |grep $fix_ip |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">External network 30769889-a664-4d99-8035-047773d2031c is not reachable from subnet ada0b5b0-6780-4131-b07b-cee7069eab8d.  Therefore, cannot associate Port 7e8d017b-8e1d-4f8f-98cd-9de3fe52c687 with a Floating IP.</span><br><span class="line">Neutron server returns request_ids: [&apos;req-76951e0d-aff8-4106-826c-72d99fe03c2d&apos;]</span><br></pre></td></tr></table></figure></p>
<p>具体测试方法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Created another FIP network for test</span><br><span class="line"></span><br><span class="line"># first provides the physical network in the underlying OpenStack of sts-stack</span><br><span class="line">source ~/novarc</span><br><span class="line">openstack router create zhhuabj_router2</span><br><span class="line">openstack network create --disable-port-security zhhuabj_admin_net2</span><br><span class="line">openstack subnet create --subnet-range 10.10.0.0/24 --network zhhuabj_admin_net2 --allocation-pool start=10.10.0.50,end=10.10.0.100 --gateway 10.10.0.1 zhhuabj_admin_net2_subnet</span><br><span class="line">openstack router add subnet zhhuabj_router2 zhhuabj_admin_net2</span><br><span class="line">openstack router set --external-gateway zhhuabj_admin_net2 zhhuabj_router2</span><br><span class="line"></span><br><span class="line"># For convenience of management, add a ip address from this network into bastion</span><br><span class="line">source ~/novarc</span><br><span class="line">nova interface-attach $(nova list |grep zhhuabj-bastion |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">sudo ip addr add 10.10.0.58/24 dev ens9</span><br><span class="line">sudo ip link set dev ens9 up</span><br><span class="line"></span><br><span class="line"># then defines the flat provider network in the upper OpenStack of sts-stack</span><br><span class="line">juju deploy ./b/openstack.yaml</span><br><span class="line">./configre</span><br><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh neutron-gateway/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ovs-vsctl add-br br-data2</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ovs-vsctl add-port br-data2 ens7</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ifconfig ens7 up</span><br><span class="line">juju config neutron-gateway bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-gateway data-port=&quot;br-data:fa:16:3e:45:fc:23 br-data2:ens7&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo systemctl restart neutron-openvswitch-agent.service</span><br><span class="line"></span><br><span class="line">source stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create --shared --router:external --provider:network_type flat --provider:physical_network physnet2 ext_net2</span><br><span class="line">neutron subnet-create --name ext_net2_subnet --gateway 10.10.0.1 --allocation-pool start=10.10.0.60,end=10.10.0.70 --disable-dhcp ext_net2 10.10.0.0/24</span><br><span class="line">neutron router-create provider-router2</span><br><span class="line">neutron router-gateway-set provider-router2 ext_net2</span><br><span class="line"># OpenStack doesn&apos;t support add the same subnet into multiple routers</span><br><span class="line"># neutron router-interface-add provider-router2 private_subnet</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~$ neutron router-interface-add provider-router2 private_subnet</span><br><span class="line">IP address 192.168.21.1 already allocated in subnet ada0b5b0-6780-4131-b07b-cee7069eab8d</span><br><span class="line">Neutron server returns request_ids: [&apos;req-8110ac5c-94ca-4b15-bf72-e199b635aa6f&apos;]</span><br><span class="line"></span><br><span class="line"># Create a test VM and allocate two FIPs to it from two FIP pool</span><br><span class="line">./tools/instance_launch.sh 1 xenial</span><br><span class="line">./tools/sec_groups.sh</span><br><span class="line">fix_ip=$(openstack server list -f value |awk &apos;/xenial/ &#123;print $4&#125;&apos; |awk -F &apos;=&apos; &apos;&#123;print $2&#125;&apos; |awk -F &apos;,&apos; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">ext_net=$(openstack network show ext_net -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $ext_net -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address $fix_ip --port $(openstack port list --fixed-ip ip-address=$fix_ip -c id -f value)</span><br><span class="line">ext_net2=$(openstack network show ext_net2 -f value -c id)</span><br><span class="line">fip2=$(openstack floating ip create $ext_net2 -f value -c floating_ip_address)</span><br><span class="line">neutron floatingip-associate $(neutron floatingip-list |grep $fip2 |awk &apos;&#123;print $2&#125;&apos;) $(neutron port-list |grep $fix_ip |awk &apos;&#123;print $2&#125;&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="使用flat-provider-network"><a href="#使用flat-provider-network" class="headerlink" title="使用flat provider network"></a>使用flat provider network</h2><p>使用flat provider network, 虚机内虽然也有多个网卡, 但因为虚机内的网卡和虚机外的网卡属于同一相flat网络并不存在路径选择问题, 结果证明可行.<br>第一步, 继续需要为计算结点准备外部网卡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh nova-compute/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-br br-data2</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-port br-data2 ens7</span><br><span class="line">juju ssh nova-compute/0 -- sudo ifconfig ens7 up</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data2:ens7&quot;</span><br><span class="line">#juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br><span class="line"></span><br><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh nova-compute/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net -c id -f value)</span><br><span class="line">#juju ssh nova-compute/0 -- sudo ovs-vsctl add-br br-data</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-port br-data ens9</span><br><span class="line">juju ssh nova-compute/0 -- sudo ifconfig ens9 up</span><br><span class="line">#juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9 br-data2:ens7&quot;</span><br><span class="line">#juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br></pre></td></tr></table></figure></p>
<p>第二步, 创建flat网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source ~/stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create ext_net2 --provider:network_type flat --provider:physical_network physnet2 --router:external=True --shared</span><br><span class="line">neutron subnet-create --name ext_net2_subnet --enable_dhcp=False --allocation_pool start=10.10.0.60,end=10.10.0.70 --gateway=10.10.0.1 ext_net2 10.10.0.0/24</span><br></pre></td></tr></table></figure>
<p>第三步, 创建测试虚机, 记得使用一个tenant private network避免引入metadata的问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --wait --image xenial --flavor m1.small --key-name mykey --network=private i1</span><br><span class="line">nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net -c id -f value)</span><br><span class="line">nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net2 -c id -f value)</span><br></pre></td></tr></table></figure></p>
<p>第四步, 因为我们的外部网络都没有使用dhcp, 所以需要登录虚机手动设置IP.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks                                                       |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">| 45083dc2-c72e-4201-b35c-6d0f6ef3712a | i1   | ACTIVE | -          | Running     | ext_net=10.5.150.8; ext_net2=10.10.0.64; private=192.168.21.13 |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">juju ssh neutron-gateway/0</span><br><span class="line">sudo ip netns exec qrouter-8b597dd0-49b3-40e3-8e0e-c035d8535cae ssh -i /home/ubuntu/id_rsa ubuntu@192.168.21.13</span><br><span class="line">$ sudo ifconfig ens5 up</span><br><span class="line">$ sudo ifconfig ens6 up</span><br><span class="line">$ sudo ip addr add 10.5.150.8/16 dev ens5</span><br><span class="line">$ sudo ip addr add 10.10.0.64/24 dev ens6</span><br></pre></td></tr></table></figure>
<p>第五步, 测试.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ ping 10.5.150.8</span><br><span class="line">PING 10.5.150.8 (10.5.150.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.8: icmp_seq=1 ttl=64 time=5.07 ms</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping 10.10.0.64</span><br><span class="line">PING 10.10.0.64 (10.10.0.64) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.0.64: icmp_seq=1 ttl=64 time=4.16 ms</span><br><span class="line"></span><br><span class="line">ubuntu@i1:~$ ping -c 1 10.10.0.58</span><br><span class="line">PING 10.10.0.58 (10.10.0.58) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.0.58: icmp_seq=1 ttl=64 time=2.21 ms</span><br><span class="line">ubuntu@i1:~$ ping -c 1 10.5.0.8</span><br><span class="line">PING 10.5.0.8 (10.5.0.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.0.8: icmp_seq=1 ttl=64 time=2.18 ms</span><br></pre></td></tr></table></figure></p>
<p>注: 若报下列这种错误, 是因为没有做第一步创建br-data2及相关的NIC.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net2 -c id -f value)</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">ERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.</span><br><span class="line">&lt;class &apos;PortBindingFailed_Remote&apos;&gt; (HTTP 500) (Request-ID: req-38c9faad-872c-43c4-921d-798b31bff548)</span><br></pre></td></tr></table></figure></p>
<h2 id="更近一步考虑"><a href="#更近一步考虑" class="headerlink" title="更近一步考虑"></a>更近一步考虑</h2><p>如果设置”juju config neutron-openvswitch enable-local-dhcp-and-metadata=True”这样可以省掉计算节点的网卡, 这样计算节点原先用于连l3-agent的网卡(现在不需要l3-agent了, 同时dhcp-agent与metadata-agent挪到了计算节点上)可以挪出来用于provider network. (<strong>注意: 至少需要两个网卡的, 一个管理用的, 一个用来做data-port的, data-port最终用在bridge-mapping中用在vlan与flat之类的provider network中, 但是对在dvr这种provider network是必须要一个的</strong>) 所以对于flat之前的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=False</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9 br-data2:ens7&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br></pre></td></tr></table></figure></p>
<p>变成了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=True</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1&quot;</span><br></pre></td></tr></table></figure></p>
<p>或者:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh --name octavia --create-model --run --octavia -r stein --dvr-snat --num-compute 2</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens7&quot;</span><br><span class="line">./bin/add-data-ports.sh</span><br></pre></td></tr></table></figure></p>
<p>如果是vlan, 则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=True</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9&quot;</span><br><span class="line">juju config neutron-api vlan-ranges=&quot;physnet1:1000:2000&quot;</span><br><span class="line"># must configure external switch to truck mode to allow vlan 1000 to 2000</span><br><span class="line">neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1001</span><br><span class="line">neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1002</span><br></pre></td></tr></table></figure></p>
<p>如果将provider network 共享给其他tenant的话, 可以加–shared参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neutron net-create ext_net2 --provider:network_type flat --provider:physical_network physnet2 --router:external=True --shared</span><br></pre></td></tr></table></figure></p>
<p>或者使用rbac特性 (<a href="https://docs.openstack.org/neutron/pike/admin/config-rbac.html" target="_blank" rel="external">https://docs.openstack.org/neutron/pike/admin/config-rbac.html</a> )<br>如果使用dvr, 还可以让l3ha与dvr共存, 并且使用use-dvr-snat=true充许将网关运行在计算节点(<strong>dvr_snat模式会在计算节点上也创建snat-xxx名空间作为主, 同时neutron-gateway上的snat-xxx由l3ha特性作为副</strong> )上. 见: <a href="https://review.opendev.org/#/c/624495/" target="_blank" rel="external">https://review.opendev.org/#/c/624495/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-api enable-dvr=True</span><br><span class="line">juju config neutron-api enable-l3ha=true</span><br><span class="line">juju config neutron-openvswitch use-dvr-snat=True</span><br></pre></td></tr></table></figure></p>
<p>测试DVR的情况如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh --series xenial --release queens</span><br><span class="line">juju add-model dvr-lp1825966</span><br><span class="line">juju deploy ./b/openstack.yaml</span><br><span class="line"># just flat/vlan need this extra NIC</span><br><span class="line">#source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh nova-compute/1 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net -c id -f value)</span><br><span class="line">./bin/add-data-ports.sh</span><br><span class="line"></span><br><span class="line">#juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data&quot;</span><br><span class="line">#juju config neutron-api flat-network-providers=&quot;physnet1&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens7&quot;</span><br><span class="line"></span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1&quot;</span><br><span class="line"># vlan - must configure external switch to truck mode to allow vlan 1000 to 2000</span><br><span class="line">#juju config neutron-api vlan-ranges=&quot;physnet1:1000:2000&quot;</span><br><span class="line">#neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1001</span><br><span class="line">#neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1002</span><br><span class="line"></span><br><span class="line">git clone https://github.com/openstack/charm-neutron-openvswitch.git neutron-openvswitch</span><br><span class="line">cd neutron-openvswitch/</span><br><span class="line">patch -p1 &lt; 0001-Enable-keepalived-VRRP-health-check.patch</span><br><span class="line">juju upgrade-charm neutron-openvswitch --path $PWD</span><br><span class="line"></span><br><span class="line">juju config neutron-api enable-dvr=True</span><br><span class="line">juju config neutron-openvswitch use-dvr-snat=True</span><br><span class="line">juju config neutron-api enable-l3ha=true</span><br><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=True</span><br><span class="line"></span><br><span class="line">./configure</span><br><span class="line">./tools/sec_groups.sh</span><br><span class="line">source ~/stsstack-bundles/openstack/novarc</span><br><span class="line"># non-flat tenant router</span><br><span class="line">neutron router-show provider-router</span><br><span class="line">#neutron router-update --admin-state-up False provider-router</span><br><span class="line">#neutron router-update provider-router --distributed True --ha=True</span><br><span class="line">#neutron router-update --admin-state-up True provider-router</span><br><span class="line"></span><br><span class="line"># can use flat network ext_net directly by using enable-local-dhcp-and-metadata=True to bypass metadata feature instead of using tenant network</span><br><span class="line"># but ext_net without dhcp, so vm can&apos;t get IP</span><br><span class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">nova boot --key-name mykey --image xenial --flavor m1.small --nic net-id=$(neutron net-list |grep &apos; ext_net &apos; |awk &apos;&#123;print $2&#125;&apos;) i1</span><br><span class="line">nova boot --key-name mykey --image xenial --flavor m1.small --nic net-id=$(neutron net-list |grep &apos; private &apos; |awk &apos;&#123;print $2&#125;&apos;) --nic net-id=$(neutron net-list |grep &apos; ext_net &apos; |awk &apos;&#123;print $2&#125;&apos;) i1</span><br><span class="line"></span><br><span class="line"># in nova-compute/1 unit. compute node will have snat-xxx namespace due to use-dvr-snat=True</span><br><span class="line">wget https://gist.githubusercontent.com/dosaboy/cf8422f16605a76affa69a8db47f0897/raw/8e045160440ecf0f9dc580c8927b2bff9e9139f6/check_router_vrrp_transitions.sh</span><br><span class="line">chmod +x check_router_vrrp_transitions.sh</span><br><span class="line"># https://paste.ubuntu.com/p/PYPptZRhrn/</span><br><span class="line">date; neutron l3-agent-list-hosting-router $(neutron router-show provider-router -c id -f value); juju ssh nova-compute/1 -- bash /home/ubuntu/check_router_vrrp_transitions.sh; juju ssh nova-compute/1 -- bash /home/ubuntu/check_router_vrrp_transitions.sh; sleep 40; date; neutron l3-agent-list-hosting-router $(neutron router-show provider-router -c id -f value); juju ssh nova-compute/1 -- bash /home/ubuntu/check_router_vrrp_transitions.sh; juju ssh nova-compute/1 -- bash /home/ubuntu/check_router_vrrp_transitions.sh;</span><br></pre></td></tr></table></figure>
<h2 id="更新-20190717"><a href="#更新-20190717" class="headerlink" title="更新 20190717"></a>更新 20190717</h2><p>dpdk环境, 没neutron-gateway, dhcp-agent与metadata-agent均在计算节点上, 计算节点上因为memory不足导致ovs死掉, 在迁移一些虚机到其他机器并重启这台计算节点之后仍然发现虚机无法从dhcp处获取IP, 在使用config-drive静态指定IP后无问题, 所以后来发现原来是服务这些虚机的dhcp已经迁移到其他host, 在重启这个host后问题解决.</p>
<h2 id="20200110更新-dmz测试"><a href="#20200110更新-dmz测试" class="headerlink" title="20200110更新 - dmz测试"></a>20200110更新 - dmz测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">openstack router create externalrouter</span><br><span class="line">openstack network create dmznet --external</span><br><span class="line">openstack subnet create --subnet-range 172.21.8.0/24 --network dmznet --allocation-pool start=172.21.8.86,end=172.21.8.100 --gateway 172.21.8.1 dmzsubnetinternal</span><br><span class="line">openstack subnet create --subnet-range 193.169.205.0/24 --network dmznet --allocation-pool start=193.169.205.87,end=193.169.205.100 --gateway 193.169.205.1 dmzsubnetexternal</span><br><span class="line">openstack router add subnet externalrouter dmzsubnetinternal</span><br><span class="line">openstack router add subnet externalrouter dmzsubnetexternal</span><br><span class="line"></span><br><span class="line">openstack router create dmzrouterinternal</span><br><span class="line">openstack network create tenantnet</span><br><span class="line">openstack subnet create --subnet-range 192.168.4.0/24 --network tenantnet --allocation-pool start=192.168.4.87,end=192.168.4.100 --gateway 192.168.4.1 tenantsubnet</span><br><span class="line">openstack router add subnet dmzrouterinternal tenantsubnet</span><br><span class="line">openstack router set --external-gateway dmznet --fixed-ip subnet=dmzsubnetinternal,ip-address=172.21.8.87 dmzrouterinternal</span><br><span class="line">#openstack router set --enable dmzrouterinternal</span><br><span class="line"></span><br><span class="line">openstack router create dmzrouterexternal</span><br><span class="line">openstack router set --external-gateway dmznet --fixed-ip subnet=dmzsubnetexternal,ip-address=193.169.205.100 dmzrouterexternal</span><br><span class="line"></span><br><span class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --wait --image cirros2 --flavor m1.small --key-name mykey --nic net-id=$(openstack network show dmznet -c id -f value),v4-fixed-ip=193.169.205.99 externaldns</span><br><span class="line">openstack server create --wait --image cirros2 --flavor m1.small --key-name mykey --network=$(openstack network show tenantnet -c id -f value) i1</span><br><span class="line">dmznet_id=$(openstack network show dmznet -f value -c id)</span><br><span class="line">dmzsubnetinternal_id=$(openstack subnet show dmzsubnetinternal -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create --subnet $dmzsubnetinternal_id $dmznet_id -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address 192.168.4.100 --port $(openstack port list --fixed-ip ip-address=192.168.4.100 -c id -f value)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
