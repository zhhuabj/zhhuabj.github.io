<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/04/Autoinstall-Ubuntu20-04-KVM-Instance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/04/Autoinstall-Ubuntu20-04-KVM-Instance/" itemprop="url">Autoinstall Ubuntu20.04 KVM Instance</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-04T15:22:49+08:00">
                2020-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-07-04<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>我们将使用 non-GUI (text or console)的方式尽可能的自动通过KVM安装Ubuntu20.04虚机．<br>目前，Ubuntu20.04已经默认使用subiquity作为安装工具了 (之前使用debian-installer，使用preseed机制进行自动安装），subiquity使用cloud-init进行自动安装．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://cdimage.ubuntu.com/ubuntu/releases/20.04/release/ubuntu-20.04-live-server-arm64.iso</span><br><span class="line">wget http://cdimage.ubuntu.com/ubuntu-legacy-server/releases/20.04/release/ubuntu-20.04-legacy-server-amd64.iso</span><br></pre></td></tr></table></figure></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>打开硬件虚拟化，及安装KVM相关包．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cpu-checker -y</span><br><span class="line">sudo kvm-ok  #remember to enable VT-x and VT-d in BIOS</span><br><span class="line">sudo apt install qemu qemu-kvm libvirt-daemon libvirt-clients bridge-utils virt-manager libosinfo-bin</span><br><span class="line">sudo systemctl status libvirtd</span><br><span class="line">lsmod |grep -i kvm</span><br><span class="line">egrep -c &apos;(vmx|svm)&apos; /proc/cpuinfo</span><br><span class="line">osinfo-query os|grep ubuntu</span><br></pre></td></tr></table></figure></p>
<h2 id="virt-install-console-only模式安装kvm虚机"><a href="#virt-install-console-only模式安装kvm虚机" class="headerlink" title="virt-install + console only模式安装kvm虚机"></a>virt-install + console only模式安装kvm虚机</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-install --name=demo --ram=8192 --vcpus=2 --hvm --virt-type=kvm \</span><br><span class="line">    --connect=qemu:///system --os-variant=ubuntu20.04 --os-type=linux --accelerate \</span><br><span class="line">    --disk=/game/demo.qcow2,bus=virtio,format=qcow2,cache=none,sparse=true,size=32 \</span><br><span class="line">    --network=bridge=virbr0,model=rtl8139 --nographics -v \</span><br><span class="line">    --location &apos;http://mirrors.cloud.tencent.com/ubuntu/dists/bionic/main/installer-amd64/&apos; --extra-args=&apos;console=ttyS0,115200n8 serial&apos;</span><br></pre></td></tr></table></figure>
<p>正常情况下，上面使用（–extra-args=’console=ttyS0,115200n8 serial’）参数应该就能自动通过console连接的(sudo virsh console demo), 但暂不清楚为什么不行 (实际上在后来调试时发现上面命令其实已经将下列内容添加到了虚机内部的/etc/default/grub文件).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_TERMINAL=serial</span><br><span class="line">GRUB_SERIAL_COMMAND=&quot;serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1&quot;</span><br></pre></td></tr></table></figure></p>
<p>OK, 我们可以继续采用下列两种方法之一在虚机内部enable console, 方法一如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ arp -an |grep $(sudo virsh domiflist demo |awk &apos;/default/ &#123;print $5&#125;&apos;)</span><br><span class="line">? (192.168.122.62) at 52:54:00:e8:fb:47 [ether] on virbr0</span><br><span class="line">ssh demo@192.168.122.62</span><br><span class="line">sudo vim /etc/default/grub</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash console=ttyS0&quot;</span><br><span class="line">sudo update-grub</span><br><span class="line">init 6</span><br></pre></td></tr></table></figure></p>
<p>方法二如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo virsh destroy demo</span><br><span class="line">sudo guestmount -d demo -i /mnt</span><br><span class="line">$ sudo cat /mnt/etc/default/grub |tail -n2</span><br><span class="line">GRUB_TERMINAL=serial</span><br><span class="line">GRUB_SERIAL_COMMAND=&quot;serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1&quot;</span><br><span class="line"></span><br><span class="line"># but above GRUB_SERIAL_COMMAND doesn&apos;t work, so remove them and use the following</span><br><span class="line">sudo vim /mnt/etc/default/grub</span><br><span class="line">#GRUB_CMDLINE_LINUX=&quot;&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;console=tty0 console=ttyS0,19200n8&quot;</span><br><span class="line"></span><br><span class="line">sudo vim /mnt/boot/grub/grub.cfg</span><br><span class="line">menuentry &apos;Ubuntu&apos; --class ubuntu --class gnu-linux --class gnu ...</span><br><span class="line">...</span><br><span class="line">        #linux  /boot/vmlinuz-5.4.0-40-generic root=UUID=646ea42b-f96e-465a-b20a-546ba34b03d6 ro  quiet splash $vt_handoff</span><br><span class="line">        linux   /boot/vmlinuz-5.4.0-40-generic root=UUID=646ea42b-f96e-465a-b20a-546ba34b03d6 ro console=ttyS0,19200 earlyprint=serial,ttyS0,19200 quiet splash $vt_handoff</span><br><span class="line"></span><br><span class="line">sudo guestunmount /mnt</span><br><span class="line">sudo virsh start demo &amp;&amp; sudo virsh --connect qemu:///system console demo</span><br></pre></td></tr></table></figure></p>
<h2 id="基于legacy-d-i-preseed机制自动安装"><a href="#基于legacy-d-i-preseed机制自动安装" class="headerlink" title="基于legacy d-i/preseed机制自动安装"></a>基于legacy d-i/preseed机制自动安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: we use legacy iso (legacy way uses debian-installer + preseed, new way uses subiquity + init-cloud)</span><br><span class="line">#       for new way pls refer - https://ubuntu.com/server/docs/install/autoinstall-quickstart</span><br><span class="line"># wget http://releases.ubuntu.com/20.04/ubuntu-20.04-live-server-amd64.iso</span><br><span class="line">wget http://cdimage.ubuntu.com/ubuntu-legacy-server/releases/20.04/release/ubuntu-20.04-legacy-server-amd64.iso</span><br><span class="line">wget http://mirrors.cloud.tencent.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/ubuntu-installer/amd64/initrd.gz</span><br><span class="line">wget http://mirrors.cloud.tencent.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/ubuntu-installer/amd64/linux</span><br><span class="line">wget https://help.ubuntu.com/lts/installation-guide/example-preseed.txt</span><br><span class="line">sed -e &quot;s/#.*//g&quot; example-preseed.txt  |awk &apos;&#123;if (length!=0) print $0&#125;&apos; &gt; preseed.cfg</span><br><span class="line">sed -i &quot;s/archive.ubuntu.com/mirrors.cloud.tencent.com/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/unassigned-hostname/openstack/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/unassigned-domain/lan/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/US\/Eastern/Asia\/Shanghai/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/ubuntu-desktop/standard, ubuntu-server/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/ubuntu-server/a\d-i pkgsel\/include string openssh-server&quot; preseed.cfg  #append a line after the matched line</span><br><span class="line">sed -i &quot;/openssh-server/a\d-i pkgsel\/upgrade select none&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/confirm_nooverwrite/a\d-i passwd\/user-fullname string demo&quot; preseed.cfg #create a new user demo</span><br><span class="line">sed -i &quot;/demo/a\d-i passwd\/user-password password password&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/user-password/a\d-i passwd\/user-password-again password password&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/user-password-again/a\d-i user-setup\/allow-password-weak boolean true&quot; preseed.cfg</span><br><span class="line">sudo python -m http.server  #http://localhost:8000/preseed.cfg</span><br><span class="line">sudo mount -o ro /bak/images/ubuntu-20.04-legacy-server-amd64.iso /mnt/</span><br><span class="line">sudo virt-install --name demo --ram 8192 --vcpus 2 --virt-type kvm \</span><br><span class="line">   --connect=qemu:///system --os-variant=ubuntu20.04 --os-type=linux --accelerate \</span><br><span class="line">   --disk=/game/demo.qcow2,bus=virtio,format=qcow2,cache=none,sparse=true,size=32 \</span><br><span class="line">   --network bridge=virbr0 --graphics none --force --debug \</span><br><span class="line">   --cdrom=/bak/images/ubuntu-20.04-legacy-server-amd64.iso \</span><br><span class="line">   --boot kernel=./linux,initrd=./initrd.gz,kernel_args=&quot;console=ttyS0 url=http://192.168.99.135:8080/preseed.cfg debian-installer/allow_unauthenticated_ssl=true&quot;</span><br><span class="line"></span><br><span class="line">NOTE: 实际安装中，报找不着http://192.168.99.135:8080/preseed.cfg以致无法自动安装，奇怪．</span><br></pre></td></tr></table></figure>
<h2 id="基于subiquity-cloud-init新机制自动安装"><a href="#基于subiquity-cloud-init新机制自动安装" class="headerlink" title="基于subiquity/cloud-init新机制自动安装"></a>基于subiquity/cloud-init新机制自动安装</h2><p>参考 - <a href="https://ubuntu.com/server/docs/install/autoinstall-quickstart" target="_blank" rel="external">https://ubuntu.com/server/docs/install/autoinstall-quickstart</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># The crypted password is just &quot;ubuntu&quot;.</span><br><span class="line">cat &gt; user-data &lt;&lt; &apos;EOF&apos;</span><br><span class="line">#cloud-config</span><br><span class="line">autoinstall:</span><br><span class="line">  version: 1</span><br><span class="line">  identity:</span><br><span class="line">    hostname: openstack</span><br><span class="line">    password: &quot;$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0&quot;</span><br><span class="line">    username: ubuntu</span><br><span class="line">EOF</span><br><span class="line">touch meta-data</span><br><span class="line"></span><br><span class="line">sudo python -m http.server</span><br><span class="line"></span><br><span class="line"># Install ubuntu 20.04 with subiquity/cloud-init</span><br><span class="line">sudo umount /mnt</span><br><span class="line">sudo mount -o ro /bak/images/ubuntu-20.04-live-server-amd64.iso /mnt/   #remember to use live rather than legacy</span><br><span class="line">truncate -s 20G /game/demo.img</span><br><span class="line">sudo qemu-system-x86_64 -cdrom /bak/images/ubuntu-20.04-live-server-amd64.iso -bios /usr/share/qemu/OVMF.fd -nographic -serial mon:stdio -m 8096 -kernel /mnt/casper/vmlinuz -initrd /mnt/casper/initrd -append &apos;autoinstall ds=nocloud-net;s=http://localhost:8000/ console=ttyS0,115200n8&apos; -hda /game/demo.img</span><br><span class="line"></span><br><span class="line"># Boot the installed system</span><br><span class="line">kvm -no-reboot -m 8092 -drive file=/game/demo.img,format=raw,cache=none,if=virtio</span><br></pre></td></tr></table></figure></p>
<h2 id="Hack-Ubiquity’s-source-code"><a href="#Hack-Ubiquity’s-source-code" class="headerlink" title="Hack Ubiquity’s source code"></a>Hack Ubiquity’s source code</h2><p>see - <a href="https://blog.csdn.net/quqi99/article/details/76553404" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/76553404</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/30/juju-reactive-charm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/30/juju-reactive-charm/" itemprop="url">juju reactive charm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-30T15:34:10+08:00">
                2020-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hello-Charm"><a href="#Hello-Charm" class="headerlink" title="Hello Charm"></a>Hello Charm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install charm --classic</span><br><span class="line">mkdir -p ~/charms/&#123;layers,interfaces&#125;</span><br><span class="line">export CHARM_LAYERS_DIR=~/charms/layers</span><br><span class="line">export CHARM_INTERFACES_DIR=~/charms/interfaces</span><br><span class="line">cd ~/charms/layers/</span><br><span class="line">charm create layer-example</span><br><span class="line">charm proof layer-example</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes: [&apos;layer:basic&apos;]</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">name: layer-example</span><br><span class="line">summary: a very basic example charm</span><br><span class="line">maintainer: hua &lt;hua@t440p.lan&gt;</span><br><span class="line">description: |</span><br><span class="line">  This is my first charm</span><br><span class="line">tags:</span><br><span class="line">  # https://jujucharms.com/docs/stable/authors-charm-metadata</span><br><span class="line">  - misc</span><br><span class="line">  - tutorials</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import when, when_not, set_flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;layer-example.installed&apos;)</span><br><span class="line">def install_layer_example():</span><br><span class="line">    set_flag(&apos;layer-example.installed&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm build layer-example</span><br><span class="line">ls /tmp/charm-builds/layer-example</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes:</span><br><span class="line">  - &apos;layer:basic&apos;</span><br><span class="line">  - &apos;layer:apt&apos;</span><br><span class="line">options:</span><br><span class="line">  apt:</span><br><span class="line">    packages:</span><br><span class="line">     - hello</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import set_flag, when, when_not</span><br><span class="line">from charmhelpers.core.hookenv import application_version_set, status_set</span><br><span class="line">from charmhelpers.fetch import get_upstream_version</span><br><span class="line">import subprocess as sp</span><br><span class="line"></span><br><span class="line">@when_not(&apos;example.installed&apos;)</span><br><span class="line">def install_example():</span><br><span class="line">    set_flag(&apos;example.installed&apos;)</span><br><span class="line"></span><br><span class="line">@when(&apos;apt.installed.hello&apos;)</span><br><span class="line">def set_message_hello():</span><br><span class="line">    # Set the upstream version of hello for juju status.</span><br><span class="line">    application_version_set(get_upstream_version(&apos;hello&apos;))</span><br><span class="line">    # Run hello and get the message</span><br><span class="line">    message = sp.check_output(&apos;hello&apos;, stderr=sp.STDOUT)</span><br><span class="line">    # Set the active status with the message</span><br><span class="line">    status_set(&apos;active&apos;, message )</span><br><span class="line">    # Signal that we know the version of hello</span><br><span class="line">    set_flag(&apos;hello.version.set&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm build layer-example</span><br><span class="line"></span><br><span class="line">sudo snap install juju --classic</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=bionic --config agent-stream=devel localhost lxd-controller</span><br><span class="line">juju add-model test</span><br><span class="line">juju deploy /tmp/charm-builds/layer-example</span><br><span class="line">juju debug-log</span><br><span class="line">ls /var/lib/juju/agents/unit-layer-example-0/charm/reactive/layer_example.py</span><br></pre></td></tr></table></figure>
<h2 id="Add-a-mysql-interface"><a href="#Add-a-mysql-interface" class="headerlink" title="Add a mysql interface"></a>Add a mysql interface</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes:</span><br><span class="line">  - &apos;layer:basic&apos;</span><br><span class="line">  - &apos;layer:apt&apos;</span><br><span class="line">  - &apos;interface:mysql&apos;</span><br><span class="line">options:</span><br><span class="line">  apt:</span><br><span class="line">    packages:</span><br><span class="line">     - hello</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">name: layer-example</span><br><span class="line">summary: a very basic example charm</span><br><span class="line">maintainer: hua &lt;hua@t440p.lan&gt;</span><br><span class="line">description: |</span><br><span class="line">  This is my first charm</span><br><span class="line">tags:</span><br><span class="line">  # https://jujucharms.com/docs/stable/authors-charm-metadata</span><br><span class="line">  - misc</span><br><span class="line">  - tutorials</span><br><span class="line">requires:</span><br><span class="line">  database:</span><br><span class="line">    interface: mysql</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir layer-example/templates</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/templates/text-file.tmpl&apos; &lt;&lt; EOF</span><br><span class="line">DB_HOST = &apos;&#123;&#123; my_database.host() &#125;&#125;&apos;</span><br><span class="line">DB_NAME = &apos;&#123;&#123; my_database.database() &#125;&#125;&apos;</span><br><span class="line">DB_USER = &apos;&#123;&#123; my_database.user() &#125;&#125;&apos;</span><br><span class="line">DB_PASSWORD = &apos;&#123;&#123; my_database.password() &#125;&#125;&apos;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import set_flag, when, when_not</span><br><span class="line">from charmhelpers.core.hookenv import application_version_set, status_set</span><br><span class="line">from charmhelpers.fetch import get_upstream_version</span><br><span class="line">import subprocess as sp</span><br><span class="line">from charmhelpers.core.templating import render</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;example.installed&apos;)</span><br><span class="line">def install_example():</span><br><span class="line">    set_flag(&apos;example.installed&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;apt.installed.hello&apos;)</span><br><span class="line">def set_message_hello():</span><br><span class="line">    # Set the upstream version of hello for juju status.</span><br><span class="line">    application_version_set(get_upstream_version(&apos;hello&apos;))</span><br><span class="line"></span><br><span class="line">    # Run hello and get the message</span><br><span class="line">    message = sp.check_output(&apos;hello&apos;, stderr=sp.STDOUT)</span><br><span class="line"></span><br><span class="line">    # Set the maintenance status with a message</span><br><span class="line">    status_set(&apos;maintenance&apos;, message )</span><br><span class="line"></span><br><span class="line">    # Signal that we know the version of hello</span><br><span class="line">    set_flag(&apos;hello.version.set&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;database.available&apos;)</span><br><span class="line">def write_text_file(mysql):</span><br><span class="line">    render(source=&apos;text-file.tmpl&apos;,</span><br><span class="line">           target=&apos;/root/text-file.txt&apos;,</span><br><span class="line">           owner=&apos;root&apos;,</span><br><span class="line">           perms=0o775,</span><br><span class="line">           context=&#123;</span><br><span class="line">               &apos;my_database&apos;: mysql,</span><br><span class="line">           &#125;)</span><br><span class="line">    status_set(&apos;active&apos;, &apos;Ready: File rendered.&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;database.connected&apos;)</span><br><span class="line">def missing_mysql():</span><br><span class="line">    status_set(&apos;blocked&apos;, &apos;Please add relation to MySQL&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;database.connected&apos;)</span><br><span class="line">@when_not(&apos;database.available&apos;)</span><br><span class="line">def waiting_mysql(mysql):</span><br><span class="line">    status_set(&apos;waiting&apos;, &apos;Waiting for MySQL&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm proof layer-example</span><br><span class="line">charm build layer-example</span><br><span class="line"></span><br><span class="line">sudo snap install juju --classic</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=bionic --config agent-stream=devel localhost lxd-controller</span><br><span class="line">juju add-model test</span><br><span class="line">juju deploy /tmp/charm-builds/layer-example</span><br><span class="line">juju deploy cs:mysql</span><br><span class="line">juju add-relation layer-example mysql</span><br><span class="line">$ juju ssh layer-example/0 sudo cat /root/text-file.txt</span><br><span class="line">DB_HOST = &apos;10.63.242.39&apos;</span><br><span class="line">DB_NAME = &apos;layer-example&apos;</span><br><span class="line">DB_USER = &apos;eiMogh5Ahc1aido&apos;</span><br><span class="line">DB_PASSWORD = &apos;bieng5Quah5aehe&apos;Connection to 10.63.242.196 closed.</span><br></pre></td></tr></table></figure>
<h2 id="Charm-Store"><a href="#Charm-Store" class="headerlink" title="Charm Store"></a>Charm Store</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;&gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">repo: git@github.com:zhhuabj/layer-example.git</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">series:</span><br><span class="line">  - xenial</span><br><span class="line">  - bionic</span><br><span class="line">EOF</span><br><span class="line">charm proof layer-example</span><br><span class="line">charm build layer-example</span><br><span class="line">charm login  #https://discourse.juju.is/</span><br><span class="line">cd /tmp/charm-builds/layer-example</span><br><span class="line">charm push .</span><br><span class="line">juju deploy cs:~zhhuabj/example-0</span><br></pre></td></tr></table></figure>
<h2 id="OSM-charm"><a href="#OSM-charm" class="headerlink" title="OSM charm"></a>OSM charm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install charm --classic</span><br><span class="line">mkdir -p /bak/work/charms/layers</span><br><span class="line">export JUJU_REPOSITORY=/bak/work/charms</span><br><span class="line">export LAYER_PATH=$JUJU_REPOSITORY/layers</span><br><span class="line">cd $LAYER_PATH</span><br><span class="line">charm create simple</span><br><span class="line">cd simple</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;layer.yaml&apos; &lt;&lt;EOF</span><br><span class="line">includes: [&apos;layer:basic&apos;, &apos;layer:vnfproxy&apos;]</span><br><span class="line">options:</span><br><span class="line">    basic:</span><br><span class="line">        use_venv: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;metadata.yaml&apos; &lt;&lt;EOF</span><br><span class="line">name: simple</span><br><span class="line">summary: a simple vnf proxy charm</span><br><span class="line">maintainer: hua &lt;hua@localhost&gt;</span><br><span class="line">subordinate: false</span><br><span class="line">series: [&apos;xenial&apos;]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;actions.yaml&apos; &lt;&lt;EOF</span><br><span class="line">touch:</span><br><span class="line">  description: &quot;Touch a file on the VNF.&quot;</span><br><span class="line">  params:</span><br><span class="line">    filename:</span><br><span class="line">        description: &quot;The name of the file to touch.&quot;</span><br><span class="line">        type: string</span><br><span class="line">        default: &quot;&quot;</span><br><span class="line">  required:</span><br><span class="line">    - filename</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir -p actions</span><br><span class="line">sudo bash -c &apos;cat &gt;actions/touch&apos; &lt;&lt;EOF</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">import sys</span><br><span class="line">sys.path.append(&apos;lib&apos;)</span><br><span class="line">from charms.reactive import main, set_flag</span><br><span class="line">from charmhelpers.core.hookenv import action_fail, action_name</span><br><span class="line"></span><br><span class="line">set_flag(&apos;actions.&#123;&#125;&apos;.format(action_name()))</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">   main()</span><br><span class="line">except Exception as e:</span><br><span class="line">   action_fail(repr(e))</span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x actions/touch</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;reactive/simple.py&apos; &lt;&lt;EOF</span><br><span class="line">from charmhelpers.core.hookenv import (</span><br><span class="line">     action_get,</span><br><span class="line">     action_fail,</span><br><span class="line">     action_set,</span><br><span class="line">     status_set,</span><br><span class="line">)</span><br><span class="line">from charms.reactive import (</span><br><span class="line">     clear_flag,</span><br><span class="line">     set_flag,</span><br><span class="line">     when,</span><br><span class="line">     when_not,</span><br><span class="line">)</span><br><span class="line">import charms.sshproxy</span><br><span class="line"># Set the charm’s state to active so the LCM knows it’s ready to work.</span><br><span class="line">@when_not(&apos;simple.installed&apos;)</span><br><span class="line">def install_simple_proxy_charm():</span><br><span class="line">     set_flag(&apos;simple.installed&apos;)</span><br><span class="line">     status_set(&apos;active&apos;, &apos;Ready!&apos;)</span><br><span class="line"># Define what to do when the `touch` primitive is invoked.</span><br><span class="line">@when(&apos;actions.touch&apos;)</span><br><span class="line">def touch():</span><br><span class="line">     err = &apos;&apos;</span><br><span class="line">     try:</span><br><span class="line">          filename = action_get(&apos;filename&apos;)</span><br><span class="line">          cmd = [&apos;touch &#123;&#125;&apos;.format(filename)]</span><br><span class="line">          result, err = charms.sshproxy._run(cmd)</span><br><span class="line">     except:</span><br><span class="line">         action_fail(&apos;command failed:&apos; + err)</span><br><span class="line">     else:</span><br><span class="line">         action_set(&#123;&apos;output&apos;: result&#125;)</span><br><span class="line">      finally:</span><br><span class="line">          clear_flag(&apos;actions.touch&apos;)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">charm build</span><br><span class="line"></span><br><span class="line">vnfd file</span><br><span class="line">vnfd:vnfd-catalog:</span><br><span class="line">    vnfd:</span><br><span class="line">    -   id: hackfest3charmed-vnf</span><br><span class="line">        name: hackfest3charmed-vnf</span><br><span class="line">        vnf-configuration:</span><br><span class="line">            juju:</span><br><span class="line">                charm: simple</span><br><span class="line">            initial-config-primitive:</span><br><span class="line">            -   seq: &apos;1&apos;</span><br><span class="line">                name: config</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: ssh-hostname</span><br><span class="line">                    value: &lt;rw_mgmt_ip&gt;</span><br><span class="line">                -   name: ssh-username</span><br><span class="line">                    value: ubuntu</span><br><span class="line">                -   name: ssh-password</span><br><span class="line">                    value: osm4u</span><br><span class="line">            -   seq: &apos;2&apos;</span><br><span class="line">                name: touch</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: filename</span><br><span class="line">                    value: &apos;/home/ubuntu/first-touch&apos;</span><br><span class="line">            config-primitive:</span><br><span class="line">            -   name: touch</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: filename</span><br><span class="line">                    data-type: STRING</span><br><span class="line">                    default-value: &apos;/home/ubuntu/touched&apos;</span><br></pre></td></tr></table></figure>
<h2 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p clear_flag run-default-upgrade-charm ; charms.reactive -p clear_flag ceph.create_pool.req.sent; hooks/update-status&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;hooks/shared-db-relation-changed&apos;</span><br><span class="line">juju status</span><br><span class="line">juju upgrade-charm gnocchi --revision 30</span><br><span class="line">https://paste.ubuntu.com/p/qPm5dtFtz2/</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- &apos;for flag in shared-db.connected shared-db.available shared-db.available.access_network shared-db.available.ssl; do charms.reactive -p clear_flag $flag; done&apos;</span><br><span class="line"></span><br><span class="line">#https://bugs.launchpad.net/juju/+bug/1891395/comments/4</span><br><span class="line">juju remove-relation vault:secrets kubernetes-master:vault-kv --force</span><br><span class="line">juju resolved vault/2 --no-retry  #make sure there no error state</span><br><span class="line">juju status --relation vault-kv   #make sure all relations have been removed</span><br><span class="line">juju run --unit vault/0 -- &apos;relation-ids shared-db&apos;</span><br><span class="line">juju add-relation vault:secrets kubernetes-master:vault-kv</span><br><span class="line"></span><br><span class="line">juju run --unit graylog/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;nagios_token&apos;)); print(charms.leadership.leader_get(&apos;nagios_token&apos;))&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[1] https://review.opendev.org/#/c/686584/3/src/reactive/gnocchi_handlers.py</span><br><span class="line">[2] https://review.opendev.org/#/c/700125/1/src/reactive/gnocchi_handlers.py</span><br><span class="line">[3] https://review.opendev.org/#/c/716545/4/src/reactive/gnocchi_handlers.py</span><br></pre></td></tr></table></figure>
<h2 id="sru"><a href="#sru" class="headerlink" title="sru"></a>sru</h2><p>fix needs to backport to stable backport, eg: <a href="https://review.opendev.org/#/c/758038" target="_blank" rel="external">https://review.opendev.org/#/c/758038</a><br>and stable backport is merged and available in 20.08 charm cs:octavia-28 (when?)</p>
<p>another example<br>1, merge the code into master(openstack-charmers-next) - <a href="https://review.opendev.org/#/c/755276/" target="_blank" rel="external">https://review.opendev.org/#/c/755276/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://jaas.ai/u/openstack-charmers-next</span><br><span class="line">https://jaas.ai/u/openstack-charmers-next/vault/118</span><br><span class="line">https://jaas.ai/vault</span><br><span class="line">hua@t440p:/bak/work/charms/vault$ git log |grep a38bf7 -A 2 |grep -E &apos;a38bf7|Date&apos;</span><br><span class="line">Merge: ae2d79f a38bf7c</span><br><span class="line">Date:   Wed Nov 4 12:36:34 2020 +0000</span><br><span class="line">commit a38bf7cbd265ab46357ea7f9e99f55d126da8fb2</span><br><span class="line">Date:   Wed Sep 30 17:45:43 2020 +0530</span><br></pre></td></tr></table></figure></p>
<p>2, Backport patch submitted to stable branch (eg: branch/20.10) according to <a href="https://docs.openstack.org/charm-guide/latest/release-schedule.html" target="_blank" rel="external">https://docs.openstack.org/charm-guide/latest/release-schedule.html</a><br>3, stable backport is merged and available in 20.10 charm cs:vault-42 - <a href="https://jaas.ai/vault" target="_blank" rel="external">https://jaas.ai/vault</a><br>4,  the patch is ready to be applied. When would be a suitable time to update the Octavia charm in your environment?<br>but when will get charm revision nubmer? Is it the moment when the code is merged into the git repository, or is it going to take a few days?     I think some one need to trigger -<br><a href="https://docs.openstack.org/charm-guide/latest/release-policy.html" target="_blank" rel="external">https://docs.openstack.org/charm-guide/latest/release-policy.html</a></p>
<h2 id="20201110更新-nagios-nrpe-ntp-charm流程"><a href="#20201110更新-nagios-nrpe-ntp-charm流程" class="headerlink" title="20201110更新 - nagios/nrpe/ntp charm流程"></a>20201110更新 - nagios/nrpe/ntp charm流程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">/etc/nagios/nrpe.d/check_ntpmon.py是由nrpe subordinate charm在render_nrpe_check_config中创建的。</span><br><span class="line"></span><br><span class="line"># nrpe subordinate charm has a nrpe-external-master relation</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-worker:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:monitors nagios:monitors</span><br><span class="line"></span><br><span class="line"># subordinate charm ntp deployed to the same principal (kubernetes-worker) also has a nrpe-external-master relation</span><br><span class="line">juju add-relation kubernetes-worker ntp</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line"></span><br><span class="line">ntp与nrpe都是kubernetest-worker的subordinate charm,  所以运行上面的“juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master”之后nrpe subordinate charm也会把它和ntp subordinate charm的check_ntpmon这个monitor一起搜索后通过render_nrpe_check_config写到/etc/nagios/nrpe.d/check_ntpmon.py</span><br><span class="line"></span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-ids nrpe-external-master&quot;</span><br><span class="line">nrpe-external-master:18</span><br><span class="line">nrpe-external-master:24</span><br><span class="line">juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:18&quot;</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:18&quot;</span><br><span class="line">kubernetes-worker/0</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:24&quot;</span><br><span class="line">ntp/1</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:18 - kubernetes-worker/0&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        node:</span><br><span class="line">          command: check_node</span><br><span class="line">        snap.kube-proxy.daemon:</span><br><span class="line">          command: check_snap.kube-proxy.daemon</span><br><span class="line">        snap.kubelet.daemon:</span><br><span class="line">          command: check_snap.kubelet.daemon</span><br><span class="line">primary: &quot;True&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:24 - ntp/1&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        ntpmon:</span><br><span class="line">          command: check_ntpmon</span><br><span class="line">primary: &quot;False&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line"></span><br><span class="line">class MonitorsRelation(helpers.RelationContext):</span><br><span class="line">...</span><br><span class="line">    def get_monitors(self):</span><br><span class="line">        all_monitors = Monitors()</span><br><span class="line">        monitors = [</span><br><span class="line">            self.get_principal_monitors(),</span><br><span class="line">            self.get_subordinate_monitors(),</span><br><span class="line">            self.get_user_defined_monitors(),</span><br><span class="line">        ]</span><br><span class="line">        for mon in monitors:</span><br><span class="line">            all_monitors.add_monitors(mon)</span><br><span class="line">        return all_monitors</span><br><span class="line"></span><br><span class="line">def render_nrpe_check_config(checkctxt):</span><br><span class="line">    &quot;&quot;&quot;Write nrpe check definition.&quot;&quot;&quot;</span><br><span class="line">    # Only render if we actually have cmd parameters</span><br><span class="line">    if checkctxt[&quot;cmd_params&quot;]:</span><br><span class="line">        render(</span><br><span class="line">            &quot;nrpe_command.tmpl&quot;,</span><br><span class="line">            &quot;/etc/nagios/nrpe.d/&#123;&#125;.cfg&quot;.format(checkctxt[&quot;cmd_name&quot;]),</span><br><span class="line">            checkctxt,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">这样会和下列升级路径产生竞争从而出现问题.</span><br><span class="line">ntp包含了layer-ntpmon会先有/opt/ntpmon-ntp-charm/check_ntpmon.cfg</span><br><span class="line">ntp upgrade之后调用update_nrpe_config, 会先调用charmhelpr的copy_nrpe_checks将/opt/ntpmon-ntp-charm/check_ntpmon.cfg写到/usr/local/lib/nagios/plugins/check_ntpmon.py</span><br><span class="line">然后copy_nrpe_checks会继续调用charmhelper中的NRPE#add_check然后调用NRPE#write最后调用Check#write这时去写/etc/nagios/nrpe.d/check_ntpmon.py发现不存在从而抛错。</span><br><span class="line"></span><br><span class="line">1, check_ntpmon.cfg is from layer-ntpmon (ntp charm includes it) and is copied to /opt/ntpmon-ntp-charm/check_ntpmon.cfg [3]</span><br><span class="line"></span><br><span class="line">hua@t440p:/bak/work/charms/ntp$ grep -r &apos;options&apos; layer.yaml -A 2</span><br><span class="line">options:</span><br><span class="line">    ntpmon:</span><br><span class="line">        install-dir: /opt/ntpmon-ntp-charm</span><br><span class="line"></span><br><span class="line"># https://git.launchpad.net/ntpmon/tree/reactive/ntpmon.py#n72</span><br><span class="line">@when_not(&apos;ntpmon.installed&apos;)</span><br><span class="line">def install_ntpmon():</span><br><span class="line">    install_dir = layer.options.get(&apos;ntpmon&apos;, &apos;install-dir&apos;)</span><br><span class="line">    if install_dir:</span><br><span class="line">        host.mkdir(os.path.dirname(install_dir))</span><br><span class="line">        host.rsync(&apos;src/&apos;, &apos;&#123;&#125;/&apos;.format(install_dir))</span><br><span class="line"></span><br><span class="line">2, ntp&apos;s upgrade-charm will set nrpe-external-master.available so then update_nrpe_config is called</span><br><span class="line"></span><br><span class="line">258 @when_all(&apos;nrpe-external-master.available&apos;, &apos;ntpmon.installed&apos;)</span><br><span class="line">259 @when_not(&apos;ntp.nrpe.configured&apos;)</span><br><span class="line">260 def update_nrpe_config():</span><br><span class="line">261     options = layer.options(&apos;ntpmon&apos;)</span><br><span class="line">262     if options is None or &apos;install-dir&apos; not in options:</span><br><span class="line">263         return</span><br><span class="line">265     nrpe.copy_nrpe_checks(nrpe_files_dir=options[&apos;install-dir&apos;])</span><br><span class="line"></span><br><span class="line">3, charmhelper&apos;s copy_nrpe_checks will copy /opt/ntpmon-ntp-charm/check_ntpmon.cfg to /usr/local/lib/nagios/plugins/check_ntpmon.py</span><br><span class="line"></span><br><span class="line">def copy_nrpe_checks(nrpe_files_dir=None):</span><br><span class="line">    ...</span><br><span class="line">    NAGIOS_PLUGINS = &apos;/usr/local/lib/nagios/plugins&apos;</span><br><span class="line">    for fname in glob.glob(os.path.join(nrpe_files_dir, &quot;check_*&quot;)):</span><br><span class="line">        if os.path.isfile(fname):</span><br><span class="line">            shutil.copy2(fname, os.path.join(NAGIOS_PLUGINS, os.path.basename(fname)))</span><br><span class="line"></span><br><span class="line">4, then update_nrpe_config continues to run charmhelper NRPE&apos;s add_check,</span><br><span class="line"></span><br><span class="line">258 @when_all(&apos;nrpe-external-master.available&apos;, &apos;ntpmon.installed&apos;)</span><br><span class="line">259 @when_not(&apos;ntp.nrpe.configured&apos;)</span><br><span class="line">260 def update_nrpe_config():</span><br><span class="line">    ...</span><br><span class="line">279     check_cmd = os.path.join(options[&apos;install-dir&apos;], &apos;check_ntpmon.py&apos;) + &apos; --check &apos; + &apos; &apos;.join(nagios_ntpmon_checks)</span><br><span class="line">280     unitdata.kv().set(&apos;check_cmd&apos;, check_cmd)</span><br><span class="line">281     nrpe_setup.add_check(</span><br><span class="line">282         check_cmd=check_cmd,</span><br><span class="line">283         description=&apos;Check NTPmon &#123;&#125;&apos;.format(current_unit),</span><br><span class="line">284         shortname=&quot;ntpmon&quot;,</span><br><span class="line">285     )</span><br><span class="line">286     nrpe_setup.write()</span><br><span class="line"></span><br><span class="line">here check_cmd should be:</span><br><span class="line"></span><br><span class="line">#juju config ntp nagios_ntpmon_checks</span><br><span class="line">/opt/ntpmon-ntp-charm/check_ntpmon.cfg --check offset peers reach sync proc vars</span><br><span class="line"></span><br><span class="line">We also saw the following context from sosreport, so there&apos;s no problem with this.</span><br><span class="line"></span><br><span class="line"># check ntpmon</span><br><span class="line"># The following header was added automatically by juju</span><br><span class="line"># Modifying it will affect nagios monitoring and alerting</span><br><span class="line"># servicegroups: juju</span><br><span class="line">command[check_ntpmon]=/opt/ntpmon-ntp-charm/check_ntpmon.py --check offset peers reach sync proc vars</span><br><span class="line"></span><br><span class="line">5, then update_nrpe_config continues to run charmhelper NRPE&apos;s write,</span><br><span class="line"></span><br><span class="line">class NRPE(object):</span><br><span class="line">    ...</span><br><span class="line">    nrpe_confdir = &apos;/etc/nagios/nrpe.d&apos;</span><br><span class="line">    def write(self):</span><br><span class="line">        ...</span><br><span class="line">        # check that the charm can write to the conf dir.  If not, then nagios</span><br><span class="line">        # probably isn&apos;t installed, and we can defer.</span><br><span class="line">        if not self.does_nrpe_conf_dir_exist():</span><br><span class="line">            return</span><br><span class="line">        for nrpecheck in self.checks:</span><br><span class="line">            nrpecheck.write(self.nagios_context, self.hostname, self.nagios_servicegroups)</span><br><span class="line"></span><br><span class="line">6, charmhelp NRPE&apos;s write invokes Check&apos;s write.</span><br><span class="line"></span><br><span class="line">class Check(object):</span><br><span class="line">    ...</span><br><span class="line">    def _get_check_filename(self):</span><br><span class="line">        return os.path.join(NRPE.nrpe_confdir, &apos;&#123;&#125;.cfg&apos;.format(self.command))</span><br><span class="line">    def write(self, nagios_context, hostname, nagios_servicegroups):</span><br><span class="line">        nrpe_check_file = self._get_check_filename()</span><br><span class="line">        with open(nrpe_check_file, &apos;w&apos;) as nrpe_check_config:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">原理搞清楚了，通过下列命令可以重现问题(直接运行“juju upgrade-charm ntp --revision 41”不知道为什么有时候不触发）</span><br><span class="line">juju remove-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag ntp.installed ; charms.reactive -p set_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line"></span><br><span class="line">==&gt; /var/log/juju/unit-ntp-2.log &lt;==</span><br><span class="line">2020-11-10 12:21:05 INFO juju-log Invoking reactive handler: reactive/ntp.py:112:install</span><br><span class="line">2020-11-10 12:21:06 INFO juju-log Installing [&apos;chrony&apos;] with options: [&apos;--option=Dpkg::Options::=--force-confold&apos;]</span><br><span class="line">2020-11-10 12:21:06 INFO juju-log Installing [&apos;facter&apos;, &apos;ntpdate&apos;, &apos;python3-psutil&apos;, &apos;virt-what&apos;] with options: [&apos;--option=Dpkg::Options::=--force-confold&apos;]</span><br><span class="line">2020-11-10 12:21:09 INFO juju-log Invoking reactive handler: reactive/ntp.py:179:config_changed</span><br><span class="line">2020-11-10 12:21:09 INFO juju-log Invoking reactive handler: reactive/ntp.py:258:update_nrpe_config</span><br><span class="line">2020-11-10 12:21:09 ERROR juju-log Hook error:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/__init__.py&quot;, line 74, in main</span><br><span class="line">    bus.dispatch(restricted=restricted_mode)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 390, in dispatch</span><br><span class="line">    _invoke(other_handlers)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 359, in _invoke</span><br><span class="line">    handler.invoke()</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 181, in invoke</span><br><span class="line">    self._action(*args)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/charm/reactive/ntp.py&quot;, line 286, in update_nrpe_config</span><br><span class="line">    nrpe_setup.write()</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charmhelpers/contrib/charmsupport/nrpe.py&quot;, line 315, in write</span><br><span class="line">    self.nagios_servicegroups)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charmhelpers/contrib/charmsupport/nrpe.py&quot;, line 196, in write</span><br><span class="line">    with open(nrpe_check_file, &apos;w&apos;) as nrpe_check_config:</span><br><span class="line">FileNotFoundError: [Errno 2] No such file or directory: &apos;/etc/nagios/nrpe.d/check_ntpmon.cfg&apos;</span><br><span class="line"></span><br><span class="line">发现只是nagios/0上的ntp/2才是error状态，而其他ntp units则是active的。显然是因为缺乏这个关系（juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master）导致。</span><br><span class="line">nagios/0*             active    idle   2        10.5.2.4        80/tcp          ready</span><br><span class="line">  ntp/2*              error    idle            10.5.2.4        123/udp         chrony: Ready</span><br><span class="line"></span><br><span class="line">所以要想恢复，得先把这个关系加上“juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master”之后，nrpe-external-master:24变成了nrpe-external-master:25</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:25 - ntp/1&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        ntpmon:</span><br><span class="line">          command: check_ntpmon</span><br><span class="line">primary: &quot;False&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line"></span><br><span class="line">最后运行下列命令将error状态修复好。</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line">juju resolved ntp/2</span><br><span class="line"></span><br><span class="line">环境搭建：</span><br><span class="line">juju add-model k8s stsstack/stsstack</span><br><span class="line">juju deploy kubernetes-core</span><br><span class="line">juju deploy nagios</span><br><span class="line">juju deploy nrpe</span><br><span class="line">juju deploy cs:ntp-39</span><br><span class="line">juju expose nagios</span><br><span class="line">juju add-relation nagios:monitors nrpe:monitors</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-master:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-worker:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:nrpe-external-master etcd:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:general-info easyrsa:juju-info</span><br><span class="line">juju add-relation easyrsa:juju-info ntp:juju-info</span><br><span class="line">juju add-relation kubernetes-worker:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nagios:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju upgrade-charm ntp --revision 41</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag ntp.installed ; charms.reactive -p set_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">juju add-model nagios stsstack/stsstack</span><br><span class="line">juju deploy ubuntu</span><br><span class="line">juju deploy nrpe</span><br><span class="line">juju deploy nagios</span><br><span class="line">juju deploy cs:ntp-39</span><br><span class="line">juju add-relation ubuntu nrpe</span><br><span class="line">juju add-relation nrpe:monitors nagios:monitors</span><br><span class="line">juju add-relation ubuntu ntp</span><br><span class="line">juju add-relation nagios:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju upgrade-charm ntp --revision 41</span><br></pre></td></tr></table></figure>
<h2 id="20201114更新-如何获取vault中的cert-key"><a href="#20201114更新-如何获取vault中的cert-key" class="headerlink" title="20201114更新 - 如何获取vault中的cert/key"></a>20201114更新 - 如何获取vault中的cert/key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export VAULT_ADDR=&quot;http://10.5.0.27:8200&quot;</span><br><span class="line">vault status</span><br><span class="line">curl -s -H &quot;X-Vault-Token:$VAULT_TOKEN&quot; http://localhost:8200/v1/$pki_backend/certs/pem</span><br><span class="line"></span><br><span class="line">$ juju run --unit nova-cloud-controller/0 &quot;relation-list -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;)&quot;</span><br><span class="line">vault/0</span><br><span class="line">juju run --unit nova-cloud-controller/0 &quot;relation-get -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;) - vault/0&quot; |grep -E &apos;cert|key|ca&apos;</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;charm.vault.global-client-cert&apos;));&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># charm-nova-cloud-controller/blob/master/charmhelpers/contrib/openstack/cert_utils.py#install_certs is used to install cert/key</span><br><span class="line">vim vault/src/reactive/vault_handlers.py#publish_global_client_cert</span><br><span class="line">def publish_global_client_cert():</span><br><span class="line">      ...</span><br><span class="line">      bundle = vault_pki.generate_certificate(&apos;client&apos;, &apos;global-client&apos;, [], ttl, max_ttl)</span><br><span class="line">      unitdata.kv().set(&apos;charm.vault.global-client-cert&apos;, bundle)</span><br><span class="line">      ...</span><br><span class="line">      tls.set_client_cert(bundle[&apos;certificate&apos;], bundle[&apos;private_key&apos;])</span><br></pre></td></tr></table></figure>
<h2 id="20201114更新-k8s升级过程中出错"><a href="#20201114更新-k8s升级过程中出错" class="headerlink" title="20201114更新 - k8s升级过程中出错"></a>20201114更新 - k8s升级过程中出错</h2><p>k8s在升级过程中会有两个client_token，下面逻辑会导致有的master的token是旧的，有的是新的，这样，workers上的token也会有旧的有新的，从而有的有问题有的无问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/N &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/N&apos; for /0 and /4</span><br><span class="line">juju run --unit kubernetes-master/0 &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/0&apos; |grep client_token</span><br><span class="line">juju run --unit kubernetes-master/1 &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/1&apos; |grep client_token</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">This is the whole code process for the further diagnosis</span><br><span class="line"></span><br><span class="line">1, kubernetes-master leader will invoke create_tokens_and_sign_auth_requests to generate client_token and then call &apos;kube_control.sign_auth_request&apos;, while non-leader won&apos;t do it.</span><br><span class="line"></span><br><span class="line">        if kubelet_token and proxy_token and client_token:</span><br><span class="line">            kube_control.sign_auth_request(request[0], username,</span><br><span class="line">                                           kubelet_token, proxy_token,</span><br><span class="line">                                           client_token)</span><br><span class="line"></span><br><span class="line">https://github.com/freyes/charm-kubernetes-master/blob/master/reactive/kubernetes_master.py#L1273</span><br><span class="line"></span><br><span class="line">2, interface-kube-control&apos;s sign_auth_request will update &apos;creds&apos; for all relations like kubernetes-worker</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/provides.py#L95</span><br><span class="line"></span><br><span class="line">3, interface-kube-control will set the flag kube-control.auth.available after &apos;creds&apos; is set</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/requires.py#L37</span><br><span class="line"></span><br><span class="line">4, kubernetes-worker will run start_worker if kube-control.auth.available is set</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L592</span><br><span class="line"></span><br><span class="line">and check if creds is changed and run create_config</span><br><span class="line"></span><br><span class="line">    creds = db.get(&apos;credentials&apos;)</span><br><span class="line">    data_changed(&apos;kube-control.creds&apos;, creds)</span><br><span class="line">    create_config(servers[get_unit_number() % len(servers)], creds)</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L621</span><br><span class="line"></span><br><span class="line">5, kubernetes_worker will call kube_control.get_auth_credentials when kube-control.connected is set</span><br><span class="line"></span><br><span class="line">@when(&apos;kube-control.connected&apos;)</span><br><span class="line">def catch_change_in_creds(kube_control):</span><br><span class="line">    &quot;&quot;&quot;Request a service restart in case credential updates were detected.&quot;&quot;&quot;</span><br><span class="line">    nodeuser = &apos;system:node:&#123;&#125;&apos;.format(get_node_name().lower())</span><br><span class="line">    creds = kube_control.get_auth_credentials(nodeuser)</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L1205</span><br><span class="line"></span><br><span class="line">6, get_auth_credentials get creds from all leader and non-leader</span><br><span class="line"></span><br><span class="line">    def get_auth_credentials(self, user):</span><br><span class="line">        rx = &#123;&#125;</span><br><span class="line">        for unit in self.all_joined_units:</span><br><span class="line">            rx.update(unit.received.get(&apos;creds&apos;, &#123;&#125;))</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/requires.py#L57-L58</span><br></pre></td></tr></table></figure>
<p>是应该运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/0 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;admin::gQL9NVtbxY1GCAyIg2xc36JwZ1sHOXm9&apos;&quot;</span><br><span class="line">juju run --unit kubernetes-master/5 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;admin::gQL9NVtbxY1GCAyIg2xc36JwZ1sHOXm9&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<p>还是清空它呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/0 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;&apos;&quot;</span><br><span class="line">juju run --unit kubernetes-master/5 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<p>升级过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># Upgrade containerd charm</span><br><span class="line">$ juju upgrade-charm containerd --revision 88</span><br><span class="line"></span><br><span class="line"># Upgrade etcd charm</span><br><span class="line">If you want you can make an additional backup of etcd:</span><br><span class="line">$ juju run-action etcd/0 snapshot --wait</span><br><span class="line"></span><br><span class="line">$ juju scp etcd/0:/home/ubuntu/etcd-snapshots/&lt;filename&gt;.tar.gz .</span><br><span class="line"></span><br><span class="line">Perform the upgrade</span><br><span class="line">$ juju upgrade-charm etcd --revision 531</span><br><span class="line"></span><br><span class="line"># Upgrade easyrsa charm</span><br><span class="line">$ juju upgrade-charm easyrsa --revision 325</span><br><span class="line"></span><br><span class="line"># Upgrade canal charm</span><br><span class="line">$ juju upgrade-charm canal --revision 736</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master charm</span><br><span class="line">$ juju upgrade-charm kubernetes-master --revision 865</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker charm</span><br><span class="line">$ juju upgrade-charm kubernetes-worker --revision 692</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Make a backup</span><br><span class="line"></span><br><span class="line"># Set kubernetes-master to the 1.18 channel</span><br><span class="line">juju config kubernetes-master channel=1.18/stable</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master units, one at a time</span><br><span class="line">juju run-action kubernetes-master/0 upgrade</span><br><span class="line">juju run-action kubernetes-master/3 upgrade</span><br><span class="line">juju run-action kubernetes-master/4 upgrade</span><br><span class="line"></span><br><span class="line"># Set kubernetes-worker to the 1.18 channel</span><br><span class="line">juju config kubernetes-worker channel=1.18/stable</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker units, one at a time</span><br><span class="line">juju run-action kubernetes-worker/0 upgrade</span><br><span class="line">juju run-action kubernetes-worker/1 upgrade</span><br><span class="line">juju run-action kubernetes-worker/2 upgrade</span><br><span class="line">juju run-action kubernetes-worker/3 upgrade</span><br><span class="line"></span><br><span class="line">juju config etcd channel=&quot;3.4/stable&quot;</span><br><span class="line"></span><br><span class="line">juju upgrade-charm openstack-dashboard --revision 308</span><br><span class="line">juju upgrade-charm keystone --revision 319</span><br><span class="line"></span><br><span class="line">Once we have upgraded to 1.18, if we still have time, I would recommend that we upgrade some additional charms to take advantage of some bug fixes.</span><br><span class="line"></span><br><span class="line"># Make a backup</span><br><span class="line"></span><br><span class="line"># Upgrade containerd charm</span><br><span class="line">$ juju upgrade-charm containerd --revision 94</span><br><span class="line"></span><br><span class="line"># Upgrade etcd charm</span><br><span class="line">$ juju upgrade-charm etcd --revision 540</span><br><span class="line"></span><br><span class="line"># Upgrade easyrsa charm</span><br><span class="line">$ juju upgrade-charm easyrsa --revision 333</span><br><span class="line"></span><br><span class="line"># Upgrade canal charm</span><br><span class="line">$ juju upgrade-charm canal --revision 741</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master charm</span><br><span class="line">$ juju upgrade-charm kubernetes-master --revision 891</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker charm</span><br><span class="line">$ juju upgrade-charm kubernetes-worker --revision 704</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://osm.etsi.org/wikipub/index.php/Creating_your_VNF_Charm" target="_blank" rel="external">https://osm.etsi.org/wikipub/index.php/Creating_your_VNF_Charm</a><br>[2] <a href="https://cloud.garr.it/charms/create-and-deploy-charms/" target="_blank" rel="external">https://cloud.garr.it/charms/create-and-deploy-charms/</a><br>[3] <a href="https://discourse.juju.is/t/tutorial-charm-development-beginner-part-1/377" target="_blank" rel="external">https://discourse.juju.is/t/tutorial-charm-development-beginner-part-1/377</a><br>[4] <a href="https://discourse.juju.is/t/tutorial-charm-development-beginner-part-3/379" target="_blank" rel="external">https://discourse.juju.is/t/tutorial-charm-development-beginner-part-3/379</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/" itemprop="url">Integrate k8s with cert-maanger and vault</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-21T18:50:34+08:00">
                2020-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-05-21<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">#install vault</span><br><span class="line">#https://ubuntu.com/kubernetes/docs/using-vault</span><br><span class="line">#https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-certificate-management.html</span><br><span class="line">#https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-vault.html</span><br><span class="line">#./generate-bundle.sh -s bionic --create-model --name k8s --run</span><br><span class="line">wget https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/vault-pki-overlay.yaml</span><br><span class="line">./generate-bundle.sh -s bionic --name k8s</span><br><span class="line">juju add-model k8s &amp;&amp; juju deploy ... --overlay ./vault-pki-overlay.yaml ...</span><br><span class="line">juju status vault-ca</span><br><span class="line">$ cat vault-pki-overlay.yaml</span><br><span class="line">applications:</span><br><span class="line">  easyrsa: null</span><br><span class="line">  vault:</span><br><span class="line">    charm: cs:~openstack-charmers-next/vault</span><br><span class="line">    num_units: 1</span><br><span class="line">    options:</span><br><span class="line">      auto-generate-root-ca-cert: true</span><br><span class="line">  percona-cluster:</span><br><span class="line">    charm: cs:percona-cluster</span><br><span class="line">    num_units: 1</span><br><span class="line">relations:</span><br><span class="line">- - kubernetes-master:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - etcd:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - kubernetes-worker:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - vault:shared-db</span><br><span class="line">  - percona-cluster:shared-db</span><br><span class="line"></span><br><span class="line">#install vault client</span><br><span class="line">juju expose vault</span><br><span class="line">sudo snap install vault</span><br><span class="line">#./tools/vault-unseal-and-authorise.sh</span><br><span class="line">export VAULT_ADDR=http://10.0.0.22:8200  #vault_ip is 10.0.0.22</span><br><span class="line">vault operator init -key-shares=5 -key-threshold=3</span><br><span class="line">vault operator unseal &lt;run-5-times-against-5-keys-created-by-vault-init-command&gt;</span><br><span class="line">export VAULT_TOKEN=&lt;root-key-created-by-vault-init-command&gt;</span><br><span class="line">export VAULT_TOKEN=s.etL4szXrqoFiud8NnBOyU1rk</span><br><span class="line">VAULT_TOKEN=&lt;root-key-created-by-vault-init-command&gt; vault token create --ttl=100m #give you a token to auth the charm</span><br><span class="line">juju run-action --wait vault/0 authorize-charm token=&lt;charm-token-not-root-token&gt;</span><br><span class="line"></span><br><span class="line">#can run again to re-generate-root-ca if you want when auto-generate-root-ca-cert=true</span><br><span class="line">juju run-action vault/0 disable-pki</span><br><span class="line">juju run-action vault/0 generate-root-ca max-ttl=&apos;2800h&apos; ttl=&apos;87598h&apos; # 3 months; 10 years - https://review.opendev.org/#/c/678161</span><br><span class="line"></span><br><span class="line"># [option]Upload the new certificate from the signed CSR in vault</span><br><span class="line">#NOTE: We may not need this step when using auto-generate-root-ca-cert=true to generate cert, only need to do for company&apos;s CA cert</span><br><span class="line">#how to generate ca and intermediate cert, pls see the appendix or https://www.cnblogs.com/adhzl/p/11577384.html</span><br><span class="line">#To upload the new certificate from the signed CSR in Vault, we also need to provide the whole CA chain.</span><br><span class="line">#The “pem” bundle needs to be a concatenation of : signed csr + intermediate CA + root CA.</span><br><span class="line">#The root-ca bundle needs to include the intermediate CA + root CA. The order is important.</span><br><span class="line">#juju config vault ssl-ca=&quot;$(cat ./intermediate/certs/ca-chain.cert.pem | base64 )&quot; \</span><br><span class="line">#                  ssl-cert=&quot;$(cat ./intermediate/certs/client.quqi.com.cert.pem | base64 )&quot; \</span><br><span class="line">#                  ssl-key=&quot;$(cat ./intermediate/private/client.quqi.com.key.pem | base64 )&quot;</span><br><span class="line">juju run-action --wait vault/0 get-csr</span><br><span class="line">juju run-action vault-ca/leader upload-signed-csr pem=&quot;$(cat ./pem-bundle.pem | base64)&quot; root-ca=&quot;$(cat ./root-bundle.pem | base64 )&quot; allowed-domains=&apos;quqi.com&apos; allowed-subdomains=&apos;client.quqi.com&apos; allow-any-name=true --wait</span><br><span class="line"></span><br><span class="line">#Cert-Manager Role Creation</span><br><span class="line">bash -c &apos;cat &gt; ./policy-local.hcl&apos; &lt;&lt; EOF</span><br><span class="line">path &quot;charm-pki-local/issue/cert-manager&quot; &#123;</span><br><span class="line">  capabilities = [&quot;read&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span><br><span class="line">&#125;</span><br><span class="line">path &quot;charm-pki-local/sign/cert-manager&quot; &#123;</span><br><span class="line">  capabilities = [&quot;read&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ vault policy write cert-manager ./policy-local.hcl</span><br><span class="line">Error opening policy file: open /tmp/policy-local.hcl: no such file or directory</span><br><span class="line">cat policy-local.hcl  |vault policy write cert-manager -</span><br><span class="line">vault policy read cert-manager</span><br><span class="line"></span><br><span class="line">#Create the cert-manager role for Vault and associate the newly created policy with that role</span><br><span class="line">vault write auth/approle/role/cert-manager-role policies=cert-manager</span><br><span class="line"></span><br><span class="line">#Generate a role-id and secret-id.</span><br><span class="line">$ vault read auth/approle/role/cert-manager-role/role-id</span><br><span class="line">Key        Value</span><br><span class="line">---        -----</span><br><span class="line">role_id    e1239e02-056b-f963-a285-baaa42ae8c40</span><br><span class="line">$ vault write -f auth/approle/role/cert-manager-role/secret-id</span><br><span class="line">Key                   Value</span><br><span class="line">---                   -----</span><br><span class="line">secret_id             693e7657-a994-8435-2a80-df83aba23132</span><br><span class="line">secret_id_accessor    820eff6e-e52b-45a8-db59-9d393d3920fe</span><br><span class="line"></span><br><span class="line">#PKI Initialization</span><br><span class="line">#The Vault PKI is initialized automatically by the charm. To give access to cert-manager,</span><br><span class="line">#we need to create a permission for the role created by the policy.</span><br><span class="line">vault write charm-pki-local/roles/cert-manager allowed_domains=quqi.com allow_subdomains=true max_ttl=8760h allow_bare_domains=true allow_any_name=true</span><br><span class="line"></span><br><span class="line">#Install Cert-Manager</span><br><span class="line">kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.14.3/cert-manager.yaml</span><br><span class="line">kubectl get all -n cert-manager</span><br><span class="line"></span><br><span class="line">#configure certmanager</span><br><span class="line">#For k8s to authenticate to the external Vault, the cert-manager secret_id must be created as a k8s secret.</span><br><span class="line">#NOTE: The bolded secretID is the secret_id captured above encoded in base64. To encode in base64</span><br><span class="line">$ echo 693e7657-a994-8435-2a80-df83aba23132 |base64</span><br><span class="line">NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==</span><br><span class="line">bash -c &apos;cat &gt; cert-manager-vault-approle-ca.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">type: Opaque</span><br><span class="line">metadata:</span><br><span class="line">  name: cert-manager-vault-approle-ca</span><br><span class="line">  namespace: cert-manager</span><br><span class="line">data:</span><br><span class="line">  secretId: NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f cert-manager-vault-approle-ca.yaml</span><br><span class="line">kubectl get secrets -n cert-manager cert-manager-vault-approle-ca</span><br><span class="line"></span><br><span class="line">#configure certmanager</span><br><span class="line">#a certificate Issuer must be created within k8s to direct it to the Vault and identify the cert-manager role to match secret.</span><br><span class="line">bash -c &apos;cat &gt; vault-ca-issuer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: cert-manager.io/v1alpha2</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: vault-issuer</span><br><span class="line">spec:</span><br><span class="line">  vault:</span><br><span class="line">    path: charm-pki-local/sign/cert-manager</span><br><span class="line">    server: http://10.0.0.22:8200</span><br><span class="line">    auth:</span><br><span class="line">      appRole:</span><br><span class="line">        path: approle</span><br><span class="line">        roleId: &quot;e1239e02-056b-f963-a285-baaa42ae8c40&quot;</span><br><span class="line">        secretRef:</span><br><span class="line">          name: cert-manager-vault-approle-ca</span><br><span class="line">          key: secretId</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f vault-ca-issuer.yaml</span><br><span class="line">kubectl get clusterissuer</span><br><span class="line"></span><br><span class="line">#Testing</span><br><span class="line">#NOTE: the ip must be one of the k8s workers ip in this model</span><br><span class="line">$ juju status kubernetes-worker/1 |grep started</span><br><span class="line">5        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE</span><br><span class="line">bash -c &apos;cat &gt; microbot-cert.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: cert-manager.io/v1alpha2</span><br><span class="line">kind: Certificate</span><br><span class="line">metadata:</span><br><span class="line">  name: microbot</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  secretName: microbot-cert-ca</span><br><span class="line">  issuerRef:</span><br><span class="line">    name: vault-ca-issuer</span><br><span class="line">    kind: ClusterIssuer</span><br><span class="line">  commonName: microbot.10.0.0.15.quqi.com</span><br><span class="line">  dnsNames:</span><br><span class="line">  -  microbot.10.0.0.15.quqi.com</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f microbot-cert.yaml</span><br><span class="line">kubectl get certs</span><br><span class="line"></span><br><span class="line">#Workload</span><br><span class="line">bash -c &apos;cat &gt; microbot-test.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: microbot</span><br><span class="line">  name: microbot</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: microbot</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: microbot</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: dontrebootme/microbot:v1</span><br><span class="line">        imagePullPolicy: &quot;&quot;</span><br><span class="line">        name: microbot</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 80</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: &quot;&quot;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: microbot</span><br><span class="line">  labels:</span><br><span class="line">    app: microbot</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: microbot</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line"> name: microbot</span><br><span class="line"> labels:</span><br><span class="line">   app: microbot</span><br><span class="line">spec:</span><br><span class="line"> tls:</span><br><span class="line">   - hosts:</span><br><span class="line">     - microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model</span><br><span class="line">     secretName: microbot-cert</span><br><span class="line"> rules:</span><br><span class="line">   - host: microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model</span><br><span class="line">     http:</span><br><span class="line">       paths:</span><br><span class="line">         - path: /</span><br><span class="line">           backend:</span><br><span class="line">             serviceName: microbot</span><br><span class="line">             servicePort: 8080</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f microbot-test.yaml</span><br><span class="line">kubectl get all</span><br><span class="line"></span><br><span class="line">#Enable NodePort for svc microbot</span><br><span class="line">$ kubectl get svc |grep microbot</span><br><span class="line">microbot     ClusterIP   10.152.183.135   &lt;none&gt;        8080/TCP   22m</span><br><span class="line">$ kubectl edit svc microbot</span><br><span class="line">service/microbot edited</span><br><span class="line">$ kubectl get svc microbot</span><br><span class="line">NAME       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">microbot   NodePort   10.152.183.135   &lt;none&gt;        8080:32765/TCP   28m</span><br><span class="line"></span><br><span class="line">#Enable security rule for icmp and the port 32765</span><br><span class="line">$ juju status kubernetes-worker/1 |grep started</span><br><span class="line">        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE</span><br><span class="line">source ~/novarc</span><br><span class="line">openstack port list |grep 10.0.0.15</span><br><span class="line">openstack port show f3d147e1-2a00-496d-8184-302a825270fd |grep security_group_ids</span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol icmp --remote-ip 0.0.0.0/0</span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol tcp --remote-ip 0.0.0.0/0 --dst-port 32765</span><br><span class="line">ping 10.0.0.15</span><br><span class="line"></span><br><span class="line">curl --resolve microbot.10.0.0.15.quqi.com:32765:10.0.0.15 -k http://microbot.10.0.0.15.quqi.com:32765</span><br></pre></td></tr></table></figure>
<h2 id="appendix-create-key"><a href="#appendix-create-key" class="headerlink" title="appendix - create key"></a>appendix - create key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#https://www.dazhuanlan.com/2019/12/15/5df63aed10999</span><br><span class="line">#generate ca key pairs</span><br><span class="line">mkdir -p ca/&#123;private,certs,newcerts&#125; &amp;&amp; cd ca</span><br><span class="line">openssl genrsa -aes256 -passout pass:password -out private/ca.key.pem 4096</span><br><span class="line">chmod 400 private/ca.key.pem</span><br><span class="line">wget https://jamielinux.com/docs/openssl-certificate-authority/_downloads/root-config.txt -O openssl.cnf</span><br><span class="line">sed -i &quot;s,/root/ca,.,g&quot; openssl.cnf</span><br><span class="line">openssl req -config ./openssl.cnf -key private/ca.key.pem -new -x509 -days 7300 -sha256 -extensions v3_ca -passin pass:password \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.rootca/emailAddress=quqi@mail.com&quot; -out certs/ca.cert.pem</span><br><span class="line">chmod 444 certs/ca.cert.pem</span><br><span class="line">openssl x509 -noout -text -in certs/ca.cert.pem #verify</span><br><span class="line"></span><br><span class="line">#generate intermediate key pairs</span><br><span class="line">mkdir -p intermediate/&#123;certs,crl,csr,newcerts,private&#125;</span><br><span class="line">chmod 744 intermediate/private</span><br><span class="line">touch index.txt &amp;&amp; echo 1000 &gt; serial &amp;&amp; echo 1000 &gt; crlnumber</span><br><span class="line">openssl genrsa -aes256 -passout pass:password -out intermediate/private/intermediate.key.pem 4096</span><br><span class="line">chmod 400 intermediate/private/intermediate.key.pem</span><br><span class="line">cp ./openssl.cnf ./openssl-im.cnf</span><br><span class="line">#modify the following section of openssl-im.cnf file</span><br><span class="line">[ CA_default ]</span><br><span class="line">dir             = .</span><br><span class="line">private_key     = $dir/private/intermediate.key.pem</span><br><span class="line">certificate     = $dir/certs/intermediate.cert.pem</span><br><span class="line">crl             = $dir/crl/intermediate.crl.pem</span><br><span class="line">policy          = policy_loose</span><br><span class="line">openssl req -config ./openssl-im.cnf -new -sha256 -passin pass:password \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.imca/emailAddress=quqi@mail.com&quot; \</span><br><span class="line">     -key intermediate/private/intermediate.key.pem -out intermediate/csr/intermediate.csr.pem</span><br><span class="line">openssl ca -config ./openssl.cnf -extensions v3_intermediate_ca -days 3650 -notext -md sha256 -passin pass:password \</span><br><span class="line">     -in intermediate/csr/intermediate.csr.pem -out intermediate/certs/intermediate.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/intermediate.cert.pem</span><br><span class="line">openssl x509 -noout -text -in intermediate/certs/intermediate.cert.pem</span><br><span class="line">openssl verify -CAfile certs/ca.cert.pem intermediate/certs/intermediate.cert.pem</span><br><span class="line"></span><br><span class="line">#generate certificate chain</span><br><span class="line">cat intermediate/certs/intermediate.cert.pem certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/ca-chain.cert.pem</span><br><span class="line"></span><br><span class="line">#generate clinet.quqi.com key pairs</span><br><span class="line">openssl genrsa -out intermediate/private/client.quqi.com.key.pem 2048</span><br><span class="line">chmod 444 intermediate/private/client.quqi.com.key.pem</span><br><span class="line">openssl req -config ./openssl-im.cnf -key intermediate/private/client.quqi.com.key.pem \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=client.quqi.com/emailAddress=quqi@mail.com&quot; \</span><br><span class="line">     -new -sha256 -out intermediate/csr/client.quqi.com.csr.pem</span><br><span class="line">openssl ca -config ./openssl.cnf -extensions server_cert -days 3650 -notext -md sha256 -passin pass:password\</span><br><span class="line">     -in intermediate/csr/client.quqi.com.csr.pem -out intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">openssl x509 -noout -text -in intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">openssl verify -CAfile intermediate/certs/ca-chain.cert.pem intermediate/certs/client.quqi.com.cert.pem</span><br></pre></td></tr></table></figure>
<h2 id="20201023-another-vault-problem"><a href="#20201023-another-vault-problem" class="headerlink" title="20201023 - another vault problem"></a>20201023 - another vault problem</h2><p>vault只能为intermediate ca产生csr，然后这个csr需要用ca签名．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">https://bugs.launchpad.net/vault-charm/+bug/1885576</span><br><span class="line">https://review.opendev.org/#/c/755276/</span><br><span class="line">https://launchpadlibrarian.net/500735722/lp1885576_reproducer</span><br><span class="line">./generate-bundle.sh -s bionic -r stein -n vault --dvr-snat --vault --run</span><br><span class="line">juju config vault auto-generate-root-ca-cert=false</span><br><span class="line">#juju ssh nova-compute/0 -- sudo apt --fix-broken install &amp;&amp; juju resolved nova-compute/0</span><br><span class="line">./tools/vault-unseal-and-authorise.sh</span><br><span class="line"></span><br><span class="line"># Generate CA and intermediate CA</span><br><span class="line">#DOMAIN=$(juju ssh keystone/0 -- hostname -f |sed s/[[:space:]]//g) &amp;&amp; echo $DOMAIN</span><br><span class="line">#openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out ca.crt -keyout ca.key -subj &quot;/C=US/ST=UK/L=London/O=Ubuntu/OU=IT/CN=CA&quot;</span><br><span class="line">#openssl genrsa -out $DOMAIN.key</span><br><span class="line">#openssl req -new -key $DOMAIN.key -out $DOMAIN.csr -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=$DOMAIN&quot;</span><br><span class="line">#openssl x509 -req -in $DOMAIN.csr -out $DOMAIN.crt -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650</span><br><span class="line">#openssl x509 -noout -text -in $DOMAIN.crt |grep CN</span><br><span class="line">#cat $DOMAIN.crt $DOMAIN.key &gt; $DOMAIN.pem</span><br><span class="line"></span><br><span class="line">dout=`mktemp -d`</span><br><span class="line">(</span><br><span class="line">cd $dout &amp;&amp; echo $dout</span><br><span class="line">mkdir -p demoCA/newcerts &amp;&amp; touch demoCA/index.txt &amp;&amp; touch demoCA/index.txt.attr</span><br><span class="line">openssl genrsa -passout pass:password -des3 -out ca.key 2048</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 365 -out ca.crt \</span><br><span class="line">    -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=quqi.com&quot;</span><br><span class="line">juju run-action --wait vault/leader get-csr \</span><br><span class="line">    country=GB \</span><br><span class="line">    province=UK \</span><br><span class="line">    organization=Ubuntu \</span><br><span class="line">    common-name=quqi.com \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .results | .output&apos; \</span><br><span class="line">  | tee csr.pem</span><br><span class="line">openssl ca -passin pass:password -cert $dout/ca.crt -keyfile $dout/ca.key \</span><br><span class="line">    -create_serial -batch -policy policy_anything -extensions v3_ca \</span><br><span class="line">    -in csr.pem -days 60 -out $dout/intermediate_ca.crt</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># Upload the CSR and it fails since it is signed for 60 days where as</span><br><span class="line"># the default-ttl used to generate certs using this certificate is 1 year</span><br><span class="line">juju run-action --wait vault/leader upload-signed-csr \</span><br><span class="line">    pem=&quot;$(base64 $dout/intermediate_ca.crt)&quot; root-ca=&quot;$(base64 $dout/ca.crt)&quot; \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .status&apos;</span><br><span class="line"></span><br><span class="line"># Change the default-ttl for less than 60 days,</span><br><span class="line">juju config vault default-ttl=1100h</span><br><span class="line"></span><br><span class="line">#  but it has no effect on the unit since the unit is in failed state.</span><br><span class="line"># so it needs this patch - https://review.opendev.org/#/c/755276/</span><br><span class="line">git clone https://github.com/openstack/charm-vault.git</span><br><span class="line">cd charm-vault/</span><br><span class="line">git fetch https://review.opendev.org/openstack/charm-vault refs/changes/76/755276/1 &amp;&amp; git checkout FETCH_HEAD</span><br><span class="line">cd src &amp;&amp; charm build   #need this step for reactive charm</span><br><span class="line">juju upgrade-charm vault --path /tmp/charm-builds/vault --force-units #use --force-units even in an error state</span><br><span class="line">juju run --unit vault/0 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju resolved vault/0  #trigger the state to &apos;active&apos;</span><br><span class="line">juju config vault default-ttl=1109h  #run again</span><br><span class="line"></span><br><span class="line"># Upload the CSR and expects the action to be successful since the default-ttl</span><br><span class="line"># is less than 60 days and required certs will be generated with ttl default-ttl value</span><br><span class="line">juju run-action --wait vault/leader upload-signed-csr \</span><br><span class="line">    pem=&quot;$(base64 $dout/intermediate_ca.crt)&quot; root-ca=&quot;$(base64 $dout/ca.crt)&quot; \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .status&apos;</span><br><span class="line"></span><br><span class="line">#another workaround, run in vault/0</span><br><span class="line">export VAULT_TOKEN=&lt;root_token&gt;</span><br><span class="line">export VAULT_ADDR=http://10.224.211.37:8200</span><br><span class="line">vault secrets tune -default-lease-ttl=2871h charm-pki-local/</span><br></pre></td></tr></table></figure></p>
<h2 id="20201114-如何从vault中读取证书"><a href="#20201114-如何从vault中读取证书" class="headerlink" title="20201114 如何从vault中读取证书"></a>20201114 如何从vault中读取证书</h2><p>vault read <path></path>应该可以用来读取证书，但不清楚如何获取path值啊，研究了半天未果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export VAULT_TOKEN=s.N80f2BMRgk9BWkEyaMfMNtNX</span><br><span class="line">vault secrets list -detailed</span><br><span class="line">vault auth list</span><br><span class="line"># vault pki engine - https://www.vaultproject.io/docs/secrets/pki</span><br><span class="line"># vault study - http://just4coding.com/2020/03/13/vault-introduction/</span><br><span class="line">vault read &lt;path&gt;</span><br></pre></td></tr></table></figure></p>
<p>但可以从juju方面获取它。例如nova-cloud-controller与vault的关系如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># charm-nova-cloud-controller/blob/master/charmhelpers/contrib/openstack/cert_utils.py#install_certs is used to install cert/key</span><br><span class="line">vim vault/src/reactive/vault_handlers.py#publish_global_client_cert</span><br><span class="line">def publish_global_client_cert():</span><br><span class="line">      ...</span><br><span class="line">      bundle = vault_pki.generate_certificate(&apos;client&apos;, &apos;global-client&apos;, [], ttl, max_ttl)</span><br><span class="line">      unitdata.kv().set(&apos;charm.vault.global-client-cert&apos;, bundle)</span><br><span class="line">      ...</span><br><span class="line">      tls.set_client_cert(bundle[&apos;certificate&apos;], bundle[&apos;private_key&apos;])</span><br></pre></td></tr></table></figure></p>
<p>所以应该有以下两种方法获取证书:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ juju run --unit nova-cloud-controller/0 &quot;relation-list -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;)&quot;</span><br><span class="line">vault/0</span><br><span class="line">juju run --unit nova-cloud-controller/0 &quot;relation-get -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;) - vault/0&quot; |grep -E &apos;cert|key|ca&apos;</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;charm.vault.global-client-cert&apos;));&quot;</span><br></pre></td></tr></table></figure></p>
<p>但似乎并没有获取它的必要，例如，如果证书采用文件系统存储的话，可以下列方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s bionic -r ussuri --create-model --name sslwithssl:stsstack --num-compute 1 --openstack-dashboard --nova-console --ssl</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=xxx/ssl/openstack-ssl-ussuri/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=spice</span><br><span class="line">juju config nova-cloud-controller console-ssl-cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-ssl-key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>但如果采用vault来存储的话，只通过关系即可　（未测试）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s bionic -r ussuri --create-model --name sslwithssl:stsstack --num-compute 1 --openstack-dashboard --nova-console --vault</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">juju add-relation openstack-dashboard:certificates vault:certificates</span><br><span class="line">juju add-relation nova-cloud-controller:certificates vault:certificates</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/19/为什么dnsmasq服务总是重启/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/19/为什么dnsmasq服务总是重启/" itemprop="url">为什么dnsmasq服务总是重启</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-19T15:48:08+08:00">
                2020-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-05-19<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>最近, 是有点感觉到家里的网络有时有点慢, 特别有时候看网页时显示dns找不到,但马上在半秒之内又自动找着了成功显示页面. 能用也不算特别慢所以一直就没太注意这个事.<br>依平时的经验, 这种慢一般和dns有关, 所以今早就特地登录到路由器查看dnsmasq的状态. 检查了一遍配置啥的也没见异常, 但无意间发现dnsmasq的进程ID有时在变(不是很经常, 不容易观察出来).</p>
<h2 id="dnsmasq-exiting-on-receipt-of-SIGTERM"><a href="#dnsmasq-exiting-on-receipt-of-SIGTERM" class="headerlink" title="dnsmasq: exiting on receipt of SIGTERM"></a>dnsmasq: exiting on receipt of SIGTERM</h2><p>然后就想着将 dnmasq进程停掉, 然后以debug模式(-d)启动看看日志, 但是当运行了/etc/init.d/dnsma stop之后怎么也停不掉啊, 一会儿进程又自动启动了. 读代码发现openwrt的init脚本使用了procd, 但将所有procd相关的行全注释掉之后, 停掉了但还是马上就自动启动了.<br>然后发现是/etc/rc.common在自动启动, 接着就在反复测试过程中形成了下列的代码.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/init.d/dnsmasq</span><br><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=80</span><br><span class="line">start() &#123;</span><br><span class="line">      #/usr/sbin/dnsmasq --conf-dir=/tmp/dnsmasq.d --conf-file=/etc/dnsmasq.conf --user=dnsmasq --group=dnsmasq --server=114.114.114.114 -k &amp;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line">stop() &#123;</span><br><span class="line">   killall dnsmasq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这时在前台以’/usr/sbin/dnsmasq –conf-dir=/tmp/dnsmasq.d –conf-file=/etc/dnsmasq.conf –user=dnsmasq –group=dnsmasq –server=114.114.114.114 -d’调试时发现dnsmasq进程自已会退出, 报这个错”dnsmasq: exiting on receipt of SIGTERM”<br>这时以为是dnsmasq程序有问题, 正在绝望之刻, 注意到了原因dnsmasq是被上面的stop杀死的. 通过/etc/init.d/dnsmasq stop根本停不住dnsmasq, 所以上面的stop函数中的killall dnsmasq在后台被定期运行, 这样就杀死了前台的debug dnsmasq进程.</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>搞清楚’dnsmasq: exiting on receipt of SIGTERM’发生的原因之后, 将脚本暂时改成下列丑陋的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">COLUMNS=999 ps -ef |grep dns</span><br><span class="line">oot@OpenWrt:~# cat /etc/init.d/dnsmasq</span><br><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=80</span><br><span class="line">SERVICE_USE_PID=1</span><br><span class="line">SERVICE_WRITE_PID=1</span><br><span class="line">SERVICE_DAEMONIZE=1</span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line"># Only use &apos;if pidof dnsmasq &gt;/dev/null&apos; will see more and more processes when upstream network is down so change to use awk&apos; NF</span><br><span class="line"># and in some system it gives me 0 when binary not running and in some systems it gives me NULL(nothing)</span><br><span class="line">if [ -z `pidof dnsmasq` ];then</span><br><span class="line">    ulimit -c unlimited</span><br><span class="line">    echo &quot;dnsmasq stopped, start it now ...&quot;</span><br><span class="line">    mkdir -p /var/lib/misc</span><br><span class="line">    service_start /usr/sbin/dnsmasq --conf-dir=/tmp/dnsmasq.ssr --conf-file=/etc/dnsmasq.conf --user=dnsmasq --group=dnsmasq \</span><br><span class="line">      --server=221.130.33.60 --listen-address=192.168.99.1,127.0.0.1 --dhcp-range=192.168.99.100,192.168.99.199,3650d \</span><br><span class="line">      --dhcp-option=3,192.168.99.1 --dhcp-option=option:dns-server,192.168.99.1 --cache-size=0</span><br><span class="line">elif [ $(pidof dnsmasq |awk &apos;&#123;print NF&#125;&apos;) -eq 1 ];then</span><br><span class="line">    echo &quot;dnsmasq is running&quot;</span><br><span class="line">else</span><br><span class="line">    echo &apos;upstream network is down&apos;</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">   #echo &apos;NOTE: we must not use &apos;killall dnsmasq&apos; to stop dnsmasq here because stop function always be called by rc.common periodically&apos;</span><br><span class="line">   #killall dnsmasq &gt;/dev/null</span><br><span class="line">   #service_stop /usr/sbin/dnsmasq</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#don&apos;t custom restart so that it can be always invoked automatically to run start()</span><br><span class="line">#restart() &#123;</span><br><span class="line">   #workaround to avoid killall dnamasq in stop() because do not know why restart is always invoked automatically</span><br><span class="line">   #echo &apos;hint: both stop and restart not work for dnsmasq service&apos;</span><br><span class="line">   #exit 0</span><br><span class="line">   #start</span><br><span class="line">   #sleep 1</span><br><span class="line">   #return</span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="server-can’t-find-xxx-my-salesforce-com-REFUSED"><a href="#server-can’t-find-xxx-my-salesforce-com-REFUSED" class="headerlink" title="server can’t find xxx.my.salesforce.com: REFUSED"></a>server can’t find xxx.my.salesforce.com: REFUSED</h2><p>另外, 解释白名单的dns没问题, 解析黑名单的dns也没问题, 但解析不在名单之内的dns时报’server can’t find xxx.my.salesforce.com: REFUSED’之类的错误时, 那是因为dnsmasq命令中没有添加–server=114.114.114.114</p>
<h2 id="cache-size-0"><a href="#cache-size-0" class="headerlink" title="cache-size=0"></a>cache-size=0</h2><p>–cache-size=0避免使用使用dnsmasq的缓存</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/15/Play-with-OSM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/15/Play-with-OSM/" itemprop="url">Play with OSM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-15T18:04:41+08:00">
                2020-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-05-08<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="对OSM的一般印象"><a href="#对OSM的一般印象" class="headerlink" title="对OSM的一般印象"></a>对OSM的一般印象</h2><p>各种社区推动着NFV和SDN技术背后软件堆栈的创新，如OpenStack、ONAP、ETSI Open Source MANO（OSM）、OPNFV、OpenDaylight、Open Networking Foundation（ONF）、Open Contrail、Open Baron、On.Lab、 CORD、Kubernetes、ONOS和Open-O。其中OpenStack与OSM是部署NFV的两大支柱．</p>
<ul>
<li>各种OpenStack项目（包括Tacker、Neutron、Nova、Astara、Congress、Mistral和Senlin）能够管理NFV环境的虚拟化基础设施组件。例如，Tacker用于构建通用VNF管理器（VNFM）和NFV　Orchestrator（NFVO），这有助于在NFV基础设施内部署和运维VNF。此外，集成OpenStack项目为NFV基础设施引入了各种功能，包括大页面、CPU　Pinning、NUMA拓扑和SR-IOV等性能功能以及服务功能链、网络切片、可扩展性、高可用性、弹性和多站点支持。用OpenStack实施NFV环境的电信服务提供商和企业包括AT＆T、中国移动、SK电信、爱立信、德国电信、康卡斯特和彭博。类似于OpenStack官方</li>
<li>Tacker(<a href="https://blog.csdn.net/quqi99/article/details/78473137)可以编排VIM与VNF" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/78473137)可以编排VIM与VNF</a>, Open Source MANO(OSM，OPNFV和ONAP都同属于Linux基金会, ETSI ISG NFV和OSM都属于ETSI，在ETSI ISG NFV中活跃的成员包括：NTT Docomo，KDDI，KT，中国联通，德国电信，Telefonica，意大利电信，BT，Orange，AT＆T，Verizon，Bell Canada和Rogers。其中也有很多成员积极参与OPNFV和ONAP。）也可以做类似的事，前者Tacker基于TOSCA VNFD语法，后者OSM则一般采用ssh的方式编排VIM与VNF）</li>
</ul>
<p>OSM的一般用法见： <a href="https://osm.etsi.org/docs/user-guide/01-quickstart.html" target="_blank" rel="external">https://osm.etsi.org/docs/user-guide/01-quickstart.html</a>, 和Tacker也类似：</p>
<ul>
<li>首先需要部署OSM自身的服务(lcm, mon, nbi, pol, ro, keystone, kafka, mongo, mysql, zookeeper, prometheus etc) OSM官方默认将OSM服务部署在Docker Swarm中，也可以部署在k8s集群中, Ubuntu有对应的charm来部署这些OSM自身的服务（A minimal charmed OSM : <a href="https://jaas.ai/osm/bundle，" target="_blank" rel="external">https://jaas.ai/osm/bundle，</a>　HA charmed OSM - <a href="https://jaas.ai/osm-ha/bundle），既然有charm，当然通过juju就可以将这些服务部署到裸机，虚机，lxd，k8s上，这里也描述了如何将OSM部署到microk8s上（https://jaas.ai/osm/bundle" target="_blank" rel="external">https://jaas.ai/osm-ha/bundle），既然有charm，当然通过juju就可以将这些服务部署到裸机，虚机，lxd，k8s上，这里也描述了如何将OSM部署到microk8s上（https://jaas.ai/osm/bundle</a></li>
<li>在OSM配置访问VIM(eg: OpenStack, VMWare vCloud Direcor, AWS, Azure)的帐号, eg: osm vim-create –name openstack-site –user admin –password userpwd –auth_url <a href="http://10.10.10.11:5000/v2.0" target="_blank" rel="external">http://10.10.10.11:5000/v2.0</a> –tenant admin –account_type openstack</li>
<li>部署VNF, 官网中是以cirros_vnf为例的 如果使用了charmed osm, vnf是通过proxy<br>charm写的，例子见：<a href="https://blog.csdn.net/quqi99/article/details/103175749" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/103175749</a><br><img src="https://img-blog.csdnimg.cn/20200514160307452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200514160323739.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h2 id="实验-MicroK8s-MicroStack-Charmed-OSM"><a href="#实验-MicroK8s-MicroStack-Charmed-OSM" class="headerlink" title="实验 - MicroK8s + MicroStack + Charmed OSM"></a>实验 - MicroK8s + MicroStack + Charmed OSM</h2></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">Ubuntu 18.04 LTS Operating System,</span><br><span class="line">16 GB of RAM,</span><br><span class="line">4 CPUs,</span><br><span class="line">50 GB of free storage space.</span><br><span class="line"></span><br><span class="line">#Before you start</span><br><span class="line">sudo snap install juju --classic</span><br><span class="line">sudo snap install osmclient --beta</span><br><span class="line">sudo snap connect osmclient:juju-client-observe</span><br><span class="line">sudo snap connect osmclient:ssh-public-keys</span><br><span class="line">sudo snap connect osmclient:network-control</span><br><span class="line">juju bootstrap localhost osm-lxd</span><br><span class="line"></span><br><span class="line">#Setting up MicroK8s</span><br><span class="line">sudo snap install microk8s --classic</span><br><span class="line">sudo usermod -a -G microk8s $USER</span><br><span class="line">newgrp microk8s</span><br><span class="line">microk8s.status --wait-ready</span><br><span class="line">microk8s.enable storage dns</span><br><span class="line">microk8s.kubectl cluster-info</span><br><span class="line"></span><br><span class="line">#Setting up MicroStack</span><br><span class="line">sudo snap install microstack --classic --beta</span><br><span class="line">sudo microstack.init --auto</span><br><span class="line">wget https://cloud-images.ubuntu.com/releases/16.04/release/ubuntu-16.04-server-cloudimg-amd64-disk1.img</span><br><span class="line">microstack.openstack image create --public --disk-format qcow2 --container-format bare --file ubuntu-16.04-server-cloudimg-amd64-disk1.img ubuntu1604</span><br><span class="line">microstack.openstack server list</span><br><span class="line"></span><br><span class="line">#Setting up Charmed OSM</span><br><span class="line">juju bootstrap microk8s osm-k8s</span><br><span class="line">juju add-model osm</span><br><span class="line">osmclient.overlay</span><br><span class="line">juju deploy osm --overlay vca-overlay.yaml</span><br><span class="line">juju status</span><br><span class="line">export OSM_HOSTNAME=`juju status nbi-k8s | grep kubernetes | awk &apos;&#123;print $8&#125;&apos;`</span><br><span class="line">echo &quot;export OSM_HOSTNAME=$OSM_HOSTNAME&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">osmclient.osm ns-list</span><br><span class="line"></span><br><span class="line">#Add MicroStack as a VIM</span><br><span class="line">osmclient.osm vim-create --name microstack \</span><br><span class="line">      --user admin \</span><br><span class="line">      --password keystone \</span><br><span class="line">      --auth_url http://10.20.20.1:5000/v3 \</span><br><span class="line">      --tenant admin \</span><br><span class="line">      --account_type openstack \</span><br><span class="line">      --config=&apos;&#123;security_groups: default,</span><br><span class="line">                 keypair: microstack,</span><br><span class="line">                 project_name: admin,</span><br><span class="line">                 user_domain_name: default,</span><br><span class="line">                 region_name: microstack,</span><br><span class="line">                 insecure: True,</span><br><span class="line">                 availability_zone: nova,</span><br><span class="line">                 version: 3,</span><br><span class="line">                 use_floating_ip: true&#125;&apos;</span><br><span class="line"></span><br><span class="line">#Onboarding VNFs</span><br><span class="line">wget http://bit.ly/basic_vnfd -O hackfest_basic_vnf.tar.gz</span><br><span class="line">wget http://bit.ly/basic_nsd -O hackfest_basic_ns.tar.gz</span><br><span class="line">osmclient.osm upload-package hackfest_basic_vnf.tar.gz</span><br><span class="line">osmclient.osm upload-package hackfest_basic_ns.tar.gz</span><br><span class="line">osmclient.osm nsd-list</span><br><span class="line">osmclient.osm vnfd-list</span><br><span class="line">osmclient.osm ns-create --ns_name hackfest_basic_ns --nsd_name hackfest_basic-ns --vim_account microstack --config &apos;&#123;vld: [ &#123; name: mgmtnet, vim-network-name: test &#125; ] &#125;&apos;</span><br><span class="line">osmclient.osm ns-list</span><br><span class="line">IP=`microstack.openstack server list -c Networks -f value --name basic | awk &apos;&#123; print $2 &#125;&apos;`</span><br><span class="line">ssh ubuntu@$IP -i .ssh/id_microstack</span><br><span class="line"></span><br><span class="line">#Enable/Disable the Development Stack</span><br><span class="line">#microk8s.disable dns</span><br><span class="line">#sudo snap disable microstack</span><br><span class="line">#sudo snap disable microk8s</span><br><span class="line">sudo snap enable microstack; sleep 60</span><br><span class="line">sudo snap enable microk8s</span><br><span class="line">microk8s.status --wait-ready</span><br><span class="line">microk8s.enable dns</span><br><span class="line">microstack.openstack server list</span><br><span class="line"></span><br><span class="line">#use multipass in win10 - https://multipass.run/#install</span><br><span class="line">#enable hyper-v server and start hypver-v services</span><br><span class="line">multipass find</span><br><span class="line">multipass launch --name ubuntu  #note: need to kill wall</span><br><span class="line">multipass exec ubuntu -- lsb_release -a</span><br><span class="line">multipass list</span><br></pre></td></tr></table></figure>
<h2 id="实验-k8s-openstack-Charmed-OSM"><a href="#实验-k8s-openstack-Charmed-OSM" class="headerlink" title="实验 - k8s + openstack + Charmed OSM"></a>实验 - k8s + openstack + Charmed OSM</h2><p>上面的实验是基于MicroK8s + MicroStack + Charmed OSM的, 全是LXD容器的, 可以运行在单机上, 但是资源不够时容易出错.<br>现在的这种实验是先将一个openstack环境注册为juju cloud(stsstack), 然后再其上部署k8s cluster(k8s model in cloud stsstack) , 接着再将这个k8s cluster注册为juju cloud(myk8scloud),<br>然后在myk8scloud上部署Charmed OSM, 最后Charmed OSM再将底层的openstack作为vim管理. 部署步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd ~/xxx-bundles/</span><br><span class="line">cd ./kubernetes</span><br><span class="line">./generate-bundle.sh -s bionic --create-model --name k8s --run</span><br><span class="line">cd ./osm</span><br><span class="line">#Added &apos;osm&apos; model on myk8scloud/default with credential &apos;myk8scloud&apos; for user &apos;admin&apos;</span><br><span class="line">./generate-bundle.sh --name osm:myk8scloud --k8s-model k8s  --create-model</span><br><span class="line">juju show-cloud myk8scloud</span><br><span class="line">#juju destroy-model osm --destroy-storage -y</span><br><span class="line">#openstack volume list |grep pvc |awk &apos;&#123;print $2&#125;&apos; |xargs -i openstack volume delete &#123;&#125;</span><br><span class="line">juju deploy ./b/osm/osm.yaml --channel=stable #it needs 22 volues at least, so be careful your quota</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ juju status |grep nbi-k8s</span><br><span class="line">nbi-k8s         nbi:7                           active      1  nbi-k8s         jujucharms   38  kubernetes  10.152.183.96</span><br><span class="line">nbi-k8s/0*         active    idle   10.1.88.44  9999/TCP                    ready</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ kubectl -n osm get svc |grep &apos;nbi-k8s &apos;</span><br><span class="line">nbi-k8s                    NodePort    10.152.183.96    &lt;none&gt;        9999:30585/TCP               66m</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ juju status kubernetes-worker/0 |grep started</span><br><span class="line">4        started  10.0.0.26  932b2c48-2f75-411b-94c1-32d4e102a9f8  bionic  nova  ACTIVE</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ openstack port list |grep 10.0.0.26</span><br><span class="line">| 5f4a0c8f-d786-4143-b72c-c85b933559c3 |                      | fa:16:3e:18:b0:44 | ip_address=&apos;10.0.0.26&apos;, subnet_id=&apos;027cc592-fdc4-4a61-bfee-b4430e924841&apos;    | ACTIVE |</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ openstack port show 5f4a0c8f-d786-4143-b72c-c85b933559c3 |grep security_group_ids</span><br><span class="line">| security_group_ids      | 415241ed-6b97-4543-8b62-e1b38610dc7b, 662913c6-1179-4cdb-b814-4cb854b6382d</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ openstack port show 5f4a0c8f-d786-4143-b72c-c85b933559c3 |grep security_group_ids</span><br><span class="line">| security_group_ids      | 415241ed-6b97-4543-8b62-e1b38610dc7b, 662913c6-1179-4cdb-b814-4cb854b6382d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol tcp --remote-ip 0.0.0.0/0 --dst-port 30585</span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol icmp --remote-ip 0.0.0.0/0</span><br><span class="line">telnet 10.152.183.96 30585</span><br><span class="line">export OSM_HOSTNAME=10.0.0.26:30585</span><br><span class="line">osmclient.osm ns-list</span><br></pre></td></tr></table></figure></p>
<p>一些输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">$ juju models</span><br><span class="line">Controller: zhhuabj</span><br><span class="line">Model       Cloud/Region        Type        Status     Machines  Cores  Units  Access  Last connection</span><br><span class="line">controller  stsstack/stsstack   openstack   available         1      2  -      admin   just now</span><br><span class="line">default     stsstack/stsstack   openstack   available         0      -  -      admin   4 hours ago</span><br><span class="line">k8s         stsstack/stsstack   openstack   available         7      9  13     admin   2 minutes ago</span><br><span class="line">osm*        myk8scloud/default  kubernetes  available         0      -  12     admin   1 minute ago</span><br><span class="line"></span><br><span class="line">buntu@zhhuabj-bastion:~/stsstack-bundles/osm$ kubectl get pods -n osm</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">grafana-k8s-7fc6d958f9-lk7cx   1/1     Running   0          112m</span><br><span class="line">grafana-k8s-operator-0         1/1     Running   0          113m</span><br><span class="line">kafka-k8s-0                    1/1     Running   0          112m</span><br><span class="line">kafka-k8s-operator-0           1/1     Running   0          113m</span><br><span class="line">lcm-k8s-0                      1/1     Running   0          111m</span><br><span class="line">lcm-k8s-operator-0             1/1     Running   0          113m</span><br><span class="line">mariadb-k8s-0                  1/1     Running   0          112m</span><br><span class="line">mariadb-k8s-operator-0         1/1     Running   0          113m</span><br><span class="line">mon-k8s-0                      1/1     Running   0          111m</span><br><span class="line">mon-k8s-operator-0             1/1     Running   0          113m</span><br><span class="line">mongodb-k8s-0                  1/1     Running   0          112m</span><br><span class="line">mongodb-k8s-operator-0         1/1     Running   0          112m</span><br><span class="line">nbi-k8s-0                      1/1     Running   0          111m</span><br><span class="line">nbi-k8s-operator-0             1/1     Running   0          112m</span><br><span class="line">pol-k8s-0                      1/1     Running   0          111m</span><br><span class="line">pol-k8s-operator-0             1/1     Running   0          112m</span><br><span class="line">prometheus-k8s-0               2/2     Running   0          112m</span><br><span class="line">prometheus-k8s-operator-0      1/1     Running   0          112m</span><br><span class="line">ro-k8s-0                       1/1     Running   0          112m</span><br><span class="line">ro-k8s-operator-0              1/1     Running   0          112m</span><br><span class="line">ui-k8s-85c84c6fbf-6xj7p        1/1     Running   0          111m</span><br><span class="line">ui-k8s-operator-0              1/1     Running   0          112m</span><br><span class="line">zookeeper-k8s-0                1/1     Running   0          112m</span><br><span class="line">zookeeper-k8s-operator-0       1/1     Running   0          112m</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/osm$ juju status</span><br><span class="line">Model  Controller  Cloud/Region       Version  SLA          Timestamp</span><br><span class="line">k8s    zhhuabj     stsstack/stsstack  2.7.6    unsupported  09:46:41Z</span><br><span class="line"></span><br><span class="line">App                    Version  Status  Scale  Charm                  Store       Rev  OS      Notes</span><br><span class="line">containerd             1.3.3    active      3  containerd             jujucharms   64  ubuntu</span><br><span class="line">easyrsa                3.0.1    active      1  easyrsa                jujucharms  303  ubuntu</span><br><span class="line">etcd                   3.2.10   active      1  etcd                   jujucharms  501  ubuntu</span><br><span class="line">flannel                0.11.0   active      3  flannel                jujucharms  477  ubuntu</span><br><span class="line">kubeapi-load-balancer  1.14.0   active      1  kubeapi-load-balancer  jujucharms  715  ubuntu  exposed</span><br><span class="line">kubernetes-master      1.18.2   active      1  kubernetes-master      jujucharms  826  ubuntu  exposed</span><br><span class="line">kubernetes-worker      1.18.2   active      2  kubernetes-worker      jujucharms  661  ubuntu  exposed</span><br><span class="line">openstack-integrator   train    active      1  openstack-integrator   jujucharms   59  ubuntu</span><br><span class="line"></span><br><span class="line">Unit                      Workload  Agent  Machine  Public address  Ports           Message</span><br><span class="line">easyrsa/0*                active    idle   0        10.0.0.4                        Certificate Authority connected.</span><br><span class="line">etcd/0*                   active    idle   1        10.0.0.5        2379/tcp        Healthy with 1 known peer</span><br><span class="line">kubeapi-load-balancer/0*  active    idle   2        10.0.0.27       443/tcp         Loadbalancer ready.</span><br><span class="line">kubernetes-master/0*      active    idle   3        10.0.0.10       6443/tcp        Kubernetes master running.</span><br><span class="line">  containerd/2            active    idle            10.0.0.10                       Container runtime available</span><br><span class="line">  flannel/2               active    idle            10.0.0.10                       Flannel subnet 10.1.59.1/24</span><br><span class="line">kubernetes-worker/0       active    idle   4        10.0.0.26       80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  containerd/1            active    idle            10.0.0.26                       Container runtime available</span><br><span class="line">  flannel/1               active    idle            10.0.0.26                       Flannel subnet 10.1.22.1/24</span><br><span class="line">kubernetes-worker/1*      active    idle   5        10.0.0.15       80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  containerd/0*           active    idle            10.0.0.15                       Container runtime available</span><br><span class="line">  flannel/0*              active    idle            10.0.0.15                       Flannel subnet 10.1.88.1/24</span><br><span class="line">openstack-integrator/0*   active    idle   6        10.0.0.23                       Ready</span><br><span class="line"></span><br><span class="line">Machine  State    DNS        Inst id                               Series  AZ    Message</span><br><span class="line">0        started  10.0.0.4   ea81504a-0c5a-4899-9840-c71a099cd881  bionic  nova  ACTIVE</span><br><span class="line">1        started  10.0.0.5   cd1bac89-0c93-4b2a-87fe-1ed4df68dac5  bionic  nova  ACTIVE</span><br><span class="line">2        started  10.0.0.27  d1cdc6e1-fee8-44b3-8deb-5037c6eebc13  bionic  nova  ACTIVE</span><br><span class="line">3        started  10.0.0.10  9d2603b0-2833-4011-87e0-9894791181fd  bionic  nova  ACTIVE</span><br><span class="line">4        started  10.0.0.26  932b2c48-2f75-411b-94c1-32d4e102a9f8  bionic  nova  ACTIVE</span><br><span class="line">5        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE</span><br><span class="line">6        started  10.0.0.23  653815b1-5b30-418f-a244-3d1a5feb47a4  bionic  nova  ACTIVE</span><br></pre></td></tr></table></figure></p>
<p>创建vim</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># if it needs amdin you can also create a upper openstack over underlying openstack</span><br><span class="line">juju add-model rocky stsstack/stsstack</span><br><span class="line">./generate-bundle.sh --series bionic --release rocky --num-compute 2 --create-model --name rocky:stsstack --run</span><br><span class="line">./configure</span><br><span class="line">./tools/instance_launch.sh 1 cirros  #to create testkey</span><br><span class="line"></span><br><span class="line">#Add MicroStack as a VIM</span><br><span class="line">$ env |grep OS_</span><br><span class="line">OS_AUTH_URL=http://10.5.0.5:5000/v3</span><br><span class="line">OS_REGION_NAME=RegionOne</span><br><span class="line">OS_PROJECT_NAME=admin</span><br><span class="line">OS_PROJECT_DOMAIN_NAME=admin_domain</span><br><span class="line">OS_USER_DOMAIN_NAME=admin_domain</span><br><span class="line">OS_IDENTITY_API_VERSION=3</span><br><span class="line">OS_PASSWORD=openstack</span><br><span class="line">OS_USERNAME=admin</span><br><span class="line">osmclient.osm vim-create --wait --name testvim \</span><br><span class="line">      --user admin \</span><br><span class="line">      --password openstack \</span><br><span class="line">      --auth_url http://10.5.0.5:5000/v3 \</span><br><span class="line">      --tenant admin \</span><br><span class="line">      --account_type openstack \</span><br><span class="line">      --config=&apos;&#123;security_groups: default,</span><br><span class="line">                 keypair: testkey,</span><br><span class="line">                 project_name: admin,</span><br><span class="line">                 user_domain_name: admin_domain,</span><br><span class="line">                 project_domain_name: admin_domain,</span><br><span class="line">                 region_name: RegionOne,</span><br><span class="line">                 availability_zone: nova,</span><br><span class="line">                 version: 3,</span><br><span class="line">                 use_floating_ip: true&#125;&apos;</span><br><span class="line">osmclient.osm vim-list</span><br></pre></td></tr></table></figure>
<p>Onboarding VNFs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#Onboarding VNFs</span><br><span class="line">wget http://bit.ly/basic_vnfd -O hackfest_basic_vnf.tar.gz</span><br><span class="line">wget http://bit.ly/basic_nsd -O hackfest_basic_ns.tar.gz</span><br><span class="line">#image name is hard codes in hackfest_basic_vnf/hackfest_basic_vnfd.yaml, so change it, then run</span><br><span class="line">tar -czvf hackfest_basic_vnf.tar.gz hackfest_basic_vnf</span><br><span class="line">osmclient.osm upload-package hackfest_basic_vnf.tar.gz</span><br><span class="line">osmclient.osm upload-package hackfest_basic_ns.tar.gz</span><br><span class="line">osmclient.osm nsd-list</span><br><span class="line">osmclient.osm vnfd-list</span><br><span class="line">osmclient.osm ns-create --ns_name hackfest_basic_ns --nsd_name hackfest_basic-ns --vim_account testvim --config &apos;&#123;vld: [ &#123; name: mgmtnet, vim-network-name: private &#125; ] &#125;&apos;</span><br><span class="line">osmclient.osm ns-list</span><br><span class="line">kubectl -n osm logs ro-k8s-0 -f  #this is the place where we can see communication from OSM to openstack</span><br><span class="line">IP=`openstack server list -c Networks -f value --name basic | awk &apos;&#123; print $2 &#125;&apos;`</span><br><span class="line">ssh ubuntu@$IP -i ~/testkey.priv</span><br></pre></td></tr></table></figure></p>
<p>some logs:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">$ osmclient.osm ns-list</span><br><span class="line">+-------------------+--------------------------------------+---------------------+----------+-------------------+---------------+</span><br><span class="line">| ns instance name  | id                                   | date                | ns state | current operation | error details |</span><br><span class="line">+-------------------+--------------------------------------+---------------------+----------+-------------------+---------------+</span><br><span class="line">| hackfest_basic_ns | f34cb6a7-250c-49f9-9a39-213be63f603c | 2020-05-15T09:31:46 | READY    | IDLE (None)       | N/A           |</span><br><span class="line">+-------------------+--------------------------------------+---------------------+----------+-------------------+---------------+</span><br><span class="line">To get the history of all operations over a NS, run &quot;osm ns-op-list NS_ID&quot;</span><br><span class="line">For more details on the current operation, run &quot;osm ns-op-show OPERATION_ID&quot;</span><br><span class="line"></span><br><span class="line">$ nova list |grep hack</span><br><span class="line">| b3696be4-773a-4bc6-8153-1ba06321d470 | hackfest_basic_ns-1-hackfest_basic-VM-1 | ACTIVE | -          | Running     | private=192.168.21.7, 10.5.150.20 |</span><br><span class="line"></span><br><span class="line">$ cat hackfest_basic_vnfd.yaml</span><br><span class="line">vnfd:vnfd-catalog:</span><br><span class="line">    vnfd:</span><br><span class="line">    -   id: hackfest_basic-vnf</span><br><span class="line">        name: hackfest_basic-vnf</span><br><span class="line">        short-name: hackfest_basic-vnf</span><br><span class="line">        version: &apos;1.0&apos;</span><br><span class="line">        description: A basic VNF descriptor w/ one VDU</span><br><span class="line">        logo: osm.png</span><br><span class="line">        connection-point:</span><br><span class="line">        -   name: vnf-cp0</span><br><span class="line">            type: VPORT</span><br><span class="line">        vdu:</span><br><span class="line">        -   id: hackfest_basic-VM</span><br><span class="line">            name: hackfest_basic-VM</span><br><span class="line">            image: bionic</span><br><span class="line">            alternative-images:</span><br><span class="line">            -   vim-type: aws</span><br><span class="line">                image: ubuntu/images/hvm-ssd/ubuntu-artful-17.10-amd64-server-20180509</span><br><span class="line">            count: &apos;1&apos;</span><br><span class="line">            vm-flavor:</span><br><span class="line">                vcpu-count: &apos;1&apos;</span><br><span class="line">                memory-mb: &apos;1024&apos;</span><br><span class="line">                storage-gb: &apos;10&apos;</span><br><span class="line">            interface:</span><br><span class="line">            -   name: vdu-eth0</span><br><span class="line">                type: EXTERNAL</span><br><span class="line">                virtual-interface:</span><br><span class="line">                    type: PARAVIRT</span><br><span class="line">                external-connection-point-ref: vnf-cp0</span><br><span class="line">        mgmt-interface:</span><br><span class="line">            cp: vnf-cp0</span><br><span class="line"></span><br><span class="line">$ cat hackfest_basic_nsd.yaml</span><br><span class="line">nsd:nsd-catalog:</span><br><span class="line">    nsd:</span><br><span class="line">    -   id: hackfest_basic-ns</span><br><span class="line">        name: hackfest_basic-ns</span><br><span class="line">        short-name: hackfest_basic-ns</span><br><span class="line">        description: Simple NS with a single VNF and a single VL</span><br><span class="line">        version: &apos;1.0&apos;</span><br><span class="line">        logo: osm.png</span><br><span class="line">        constituent-vnfd:</span><br><span class="line">        -   vnfd-id-ref: hackfest_basic-vnf</span><br><span class="line">            member-vnf-index: &apos;1&apos;</span><br><span class="line">        vld:</span><br><span class="line">        -   id: mgmtnet</span><br><span class="line">            name: mgmtnet</span><br><span class="line">            short-name: mgmtnet</span><br><span class="line">            type: ELAN</span><br><span class="line">            mgmt-network: &apos;true&apos;</span><br><span class="line">            vnfd-connection-point-ref:</span><br><span class="line">            -   vnfd-id-ref: hackfest_basic-vnf</span><br><span class="line">                member-vnf-index-ref: &apos;1&apos;</span><br><span class="line">                vnfd-connection-point-ref: vnf-cp0</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://jaas.ai/tutorials/charmed-osm-get-started" target="_blank" rel="external">https://jaas.ai/tutorials/charmed-osm-get-started</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/18/用ubuntu的使用习惯使用windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/18/用ubuntu的使用习惯使用windows/" itemprop="url">用ubuntu的使用习惯使用windows</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-18T16:25:23+08:00">
                2020-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-04-18<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>新入手了一台笔记本电脑，默认安装了win10，用了十几年linux了，也一大堆linux的vps维护的太麻烦，还是就只使用单系统的win10吧。那样，问题来了，如何像平时使用ubuntu的习惯一样使用linux呢？</p>
<h2 id="CLI工具的选择"><a href="#CLI工具的选择" class="headerlink" title="CLI工具的选择"></a>CLI工具的选择</h2><p>国内网络太慢，所以从来不在国内的机器上跑程序，都是ssh到国外vps上来办公的， 这样主要是使用CLI命令，很少或几乎没有使用GUI工具的习惯。所以选择一个好的CLI工具是决定能否继续使用windows的关键。</p>
<ul>
<li>能用wsl吗？wsl将linux系统调用翻译成windows调用, 决定了它仅支持CLI， 当然也可以通过windows上安装xming之类的x server来运行某一些GUI（wsl内运行:export DISPLAY=:0.0)，但很多GUI是不支持的如chrome与firefox; 另外，wsl也不支持访问底层硬件所以无法运行python pyaudio之类的程序。wsl的优点它可以通过运行’wsl’快速切换到ubuntu bash；也可以通过’wsl ls’之类的命令实现在windows上直接运行bash命令， 这对我这种只熟悉unix命令不熟悉windows命令的人来说吸引力是很大的。所以wsl要结合着用，但主要就是用它的’wsl ls’之类的方便（后面会讲如何通过alias来使用它）。</li>
<li>能用powershell吗？要运行访问硬件之类的python pyaudio程序只能通过powershell, 不能使用ubuntu wsl shell或者cgwin shell. 使用powershell不支持自定义快捷键让我像使用bash的快捷键习惯一样使用它，这个缺点是对我来说是致命的，所以我不能用它。</li>
<li>能用mabaxterm吗？mabaxterm同时集成了wsl shell, cgwin shell, powershell， 但这些全如上面说的不合我的需求。所以只能将它作为备用，偶尔用用它好用的x server, scp等功能。我很少用GUI，所以这对我来说也属于低概率事件，备用着吧。</li>
<li>cmder是我最终选用的工具，它的cmder shell支持使用python pyaudio程序，和bash一样的快捷键使用习惯。也集成了git, ssh这些常用的功能，也能通过定义alias别名方便使用wsl bash命令， 也支持tabs。很好，就是它了，现在需要设置它让它更符合我平时使用linux的习惯。<h2 id="设置cmder的home-dir"><a href="#设置cmder的home-dir" class="headerlink" title="设置cmder的home dir"></a>设置cmder的home dir</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;wsl</span><br><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# grep -r &apos;home pat&apos; /mnt/d/soft/cmder/vendor/init.bat -A 3</span><br><span class="line">:: Set home path</span><br><span class="line">if not defined HOME set &quot;HOME=%USERPROFILE%&quot;</span><br><span class="line">%lib_console% debug_output init.bat &quot;Env Var - HOME=%HOME%&quot;</span><br><span class="line">@cd /d &quot;D:/&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="定义-bak软链与ubuntu的路径使用习惯相同"><a href="#定义-bak软链与ubuntu的路径使用习惯相同" class="headerlink" title="定义/bak软链与ubuntu的路径使用习惯相同"></a>定义/bak软链与ubuntu的路径使用习惯相同</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# ln -s /mnt/d /bak</span><br><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# ls /bak/soft/cmder/vendor/init.bat</span><br><span class="line">/bak/soft/cmder/vendor/init.bat</span><br></pre></td></tr></table></figure>
<p><strong>定义alias别名在cmder shell更方便直接使用wsl bash命令</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;cat soft/cmder/config/user_aliases.cmd |tail -n 20</span><br><span class="line">sshxxx=ssh ubuntu@xxx -b 192.168.8.101</span><br><span class="line">ifconfig=wsl ifconfig</span><br><span class="line">awk=wsl awk</span><br><span class="line">head=wsl head</span><br><span class="line">less=wsl less</span><br><span class="line">ls=wsl ls</span><br><span class="line">man=wsl man</span><br><span class="line">sed=wsl sed</span><br><span class="line">tail=wsl tail</span><br><span class="line">route=wsl route</span><br><span class="line">ping=wsl ping</span><br><span class="line">nslookup=wsl nslookup</span><br><span class="line">dig=wsl dig</span><br><span class="line">tar=wsl tar</span><br><span class="line">cat=wsl cat</span><br><span class="line">tee=wsl tee</span><br></pre></td></tr></table></figure></p>
<h2 id="设置默认使用cmder-shell"><a href="#设置默认使用cmder-shell" class="headerlink" title="设置默认使用cmder shell"></a>设置默认使用cmder shell</h2><p>注： win+shift+s可以快速截屏<br><img src="https://img-blog.csdnimg.cn/20200418153925206.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="标题在General-gt-Confirm中去掉警告"><a href="#标题在General-gt-Confirm中去掉警告" class="headerlink" title="标题在General -&gt; Confirm中去掉警告"></a>标题在General -&gt; Confirm中去掉警告</h2><h2 id="设置tab相关的快捷键与chrome-vimum"><a href="#设置tab相关的快捷键与chrome-vimum" class="headerlink" title="设置tab相关的快捷键与chrome vimum"></a>设置tab相关的快捷键与chrome vimum</h2><p><img src="https://img-blog.csdnimg.cn/2020041815444182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="其他-让windows支持内录"><a href="#其他-让windows支持内录" class="headerlink" title="其他 - 让windows支持内录"></a>其他 - 让windows支持内录</h2><p>thinkpad x1 yoga只有一个音频口，喇叭在放音的时候就单工了麦克风不能录音了，能让声音内部从喇叭路由到pyaudio程序处理了再内部路由到麦克风吗？答案是需要安装虚拟路由，同时得支持路由在虚拟设备和物理设备间路由。有款叫voicemeeter的软件就是做这件事的。路由设置如下图：</p>
<ul>
<li>在1处选内装麦克风，同时将A去掉，A代表可以从麦克风处输入声音</li>
<li>2处不选 ，因为只有一个音频物理设备</li>
<li>3处是选虚拟设备的，A,B两处默认都选<br>最右侧输出到扬声器<br><img src="https://img-blog.csdnimg.cn/20200418155154203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>需要将声音的输入和输出默认都走虚拟设备<br><img src="https://img-blog.csdnimg.cn/20200418155253484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>注意：这样，声音就被内部路由到python pyaudio了， 如果外部也能从物理设备录音的话，必须一直开着voicemeeter, 所以按win+r键输入 shell:startup 进入 C:\Users\ThinkPad\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup 目录， 将voicemeeter的链接加到这个目录开机就自动启动了. 不过， 我不是这样做的，voicemeeter菜单中有如下的两项开机自动启动并放入拖盘的设置，如下图。<br><img src="https://img-blog.csdnimg.cn/20200418155839452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h2 id="粘贴到vim全变成一行的问题"><a href="#粘贴到vim全变成一行的问题" class="headerlink" title="粘贴到vim全变成一行的问题"></a>粘贴到vim全变成一行的问题</h2>如从记事本复制多行内容，然后粘贴到vim却变成了多行，将下图中Ctrl+Shift+V的快捷键设置成Multi lines模式即可。<br><img src="https://img-blog.csdnimg.cn/20200418161126265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<h2 id="另一个开机自启的方法"><a href="#另一个开机自启的方法" class="headerlink" title="另一个开机自启的方法"></a>另一个开机自启的方法</h2><p>上面介绍了一种开机自启的方法，但对于cmd命令的自启还要写脚本打开shell，再后台运行程序，再关shell。但我的windows shell不熟悉啊。有一种简单的将自己的应用放入服务的方法， 以开机自启frpc为例：</p>
<ul>
<li>将nssm.exe下载放到和frpc同一级目录</li>
<li>运行：nssm install frpc 会弹出配置服务界面，照着配置就行了</li>
<li><p>到服务目录设置自动启动它。</p>
<h2 id="安装clink增强cmder的像bash-completion一样的命令提示"><a href="#安装clink增强cmder的像bash-completion一样的命令提示" class="headerlink" title="安装clink增强cmder的像bash completion一样的命令提示"></a>安装clink增强cmder的像bash completion一样的命令提示</h2><h2 id="安装类似于proxychain的proxycap"><a href="#安装类似于proxychain的proxycap" class="headerlink" title="安装类似于proxychain的proxycap"></a>安装类似于proxychain的proxycap</h2><h2 id="安装winaera-tweaker设置系统代替设置注册表"><a href="#安装winaera-tweaker设置系统代替设置注册表" class="headerlink" title="安装winaera tweaker设置系统代替设置注册表"></a>安装winaera tweaker设置系统代替设置注册表</h2><h2 id="使用qnap-nas"><a href="#使用qnap-nas" class="headerlink" title="使用qnap nas"></a>使用qnap nas</h2><p>qnap nas设置了nfs server, wsl中由于没nfs内核模块，无法通过autofs设置nfs.<br>所以直接在浏览器上通过\<nas-ip>就可以访问nas了, 或者安装qfinder pro</nas-ip></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/14/猫盘安装群晖synology/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/14/猫盘安装群晖synology/" itemprop="url">猫盘安装群晖synology</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-14T11:42:48+08:00">
                2020-04-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-04-14<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>家里有两个nas, 一个威联通的，一个猫盘，猫盘长期没怎么用，今天一看开机后找不着IP，后来多重启几次后，发现偶尔路由器上能看到IP, 它每次IP都变，并且也容易掉IP．而且还无法打开ssh，所以这个猫盘不是我心目中理想的样子，它很烂．但想着里面还有一块硬盘也不能就这么丢了啊．于是想着把它刷成群晖synology.<br>网上一堆通过什么ttl刷机的方法，那个太麻烦了，还得买线，还得拆机，还得搭线，我们还是寻找软个的方法．其实问题的关键是猫盘打开ssh太麻烦了，如果有了ssh直接刷synology很简单．x3p默认支持ssh，所以我们先通过网络的方式刷x3p，然后再刷synology.</p>
<h2 id="通过猫盘一键刷机v2-0刷x3p"><a href="#通过猫盘一键刷机v2-0刷x3p" class="headerlink" title="通过猫盘一键刷机v2.0刷x3p"></a>通过猫盘一键刷机v2.0刷x3p</h2><p>我也忘了哪里下载的猫盘一键刷机v2.0工具，大家自行在网上搜索，有名字应该很容易找到该工具的下载地址，或者去百度网盘搜搜．下载安装好后，通过网络刷x3p要知道几个信息：</p>
<ul>
<li>猫盘的IP，从路由器里找</li>
<li>猫盘的mac，从猫盘背后找．但注意一点是，要想每次启动IP不变的话，mac地址前面几位应该固定成78C2C0，后面六位从猫盘背后找．</li>
<li><p>猫盘的SN, 从猫盘背后找．<br>有了这些信息后，按下列步骤刷x3p</p>
</li>
<li><p>打开猫盘一键刷机工具，把上面的信息粘贴进去，点击开始刷机 (注意注意：刷机前一定要关闭win10上的防火墙）</p>
</li>
<li>刷好后有提示，这时候需要拔下电源，按住reset！等待10秒以上，按着他不要停！同时连上电源，等网线的灯亮起在松手。</li>
<li>这时候猫盘应该顶灯不停闪烁，等待15分钟左右，路由器能够看到你的猫盘就算刷好了</li>
<li>打开网页，地址栏输入猫盘的新ip，进入X3P登录页面. 它有两个帐号，一个admin，密码：123456, 一个root, 密码为Etech12 (呆会ssh时需要使用root用户）</li>
<li>做到这一步如果想使用x3p就继续升级，如果想使用synology的话做到这一步就算完了．<h2 id="ssh一键刷synology"><a href="#ssh一键刷synology" class="headerlink" title="ssh一键刷synology"></a>ssh一键刷synology</h2>使用root (Etech12)用户ssh登录到系统，一键运行下列命令即可：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -N --no-check-certificate https://raw.githubusercontent.com/Squaregentleman/catdrive-syno/master/install.sh</span><br><span class="line">chmod +x install.sh</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>但是由于你知道的糟糕的网络环境，可能install.sh里面要下载的<a href="https://github.com/Squaregentleman/catdrive-syno/raw/master/full.bin永远无法下载下来．所以可以手工把它先下载下来，再把它上传到x3p(无权限），然后再将install.sh里换成这个链接．" target="_blank" rel="external">https://github.com/Squaregentleman/catdrive-syno/raw/master/full.bin永远无法下载下来．所以可以手工把它先下载下来，再把它上传到x3p(无权限），然后再将install.sh里换成这个链接．</a></p>
<h2 id="配置synology"><a href="#配置synology" class="headerlink" title="配置synology"></a>配置synology</h2><p>上步安装好synology之后，接着就要配置synology, 本来也没什么好说的，看着文字说明一步一步做就行了．也是因为你知道的糟糕的网络环境，需要先手工下载下列文件，然后做到这一步时看文字选手工安装安装它：<br><a href="https://cndl.synology.cn/download/DSM/release/6.2.2/24922/DSM_DS119j_24922.pat?model=DS119j&amp;bays=1&amp;dsm_version=6.2.2&amp;build_number=24922" target="_blank" rel="external">https://cndl.synology.cn/download/DSM/release/6.2.2/24922/DSM_DS119j_24922.pat?model=DS119j&amp;bays=1&amp;dsm_version=6.2.2&amp;build_number=24922</a>　</p>
<h2 id="配置nfs"><a href="#配置nfs" class="headerlink" title="配置nfs"></a>配置nfs</h2><p>控制面板定义一个共享文件夹如bak, 关联用户admin, 然后要定义NFS权限，如下图，在squash处选择＂映射所有用户为admin. 不然的话，你若通过（sudo mount -t nfs 192.168.99.169:/volume1/bak /cat）mount了的话，然后使用添加sudo如＂sudo ls /cat”才能访问．<br><img src="https://img-blog.csdnimg.cn/20200414113138418.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="autofs配置"><a href="#autofs配置" class="headerlink" title="autofs配置"></a>autofs配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/auto.direct |tail -n 1</span><br><span class="line">/cat    -fstype=nfs,rw,rsize=32768,wsize=32768,vers=3,username=admin,password=nanting413     192.168.99.169:/volume1/bak</span><br><span class="line">$ cat /etc/auto.master |tail -n 1</span><br><span class="line">/-	auto.direct</span><br><span class="line"></span><br><span class="line">sudo systemctl restart autofs</span><br></pre></td></tr></table></figure>
<h2 id="一个大坑"><a href="#一个大坑" class="headerlink" title="一个大坑"></a>一个大坑</h2><p>通过IP访问控制台时，在套件中心要安装软件时，总是会报连接网络失败，问题是我们的网络肯定是好的．找了好久，终于发现仍然是我们特殊的网络环境造成的．<br>需要打开ntp，如下图，但默认使用的ntp服务器是time.google.com，所以被那个了，ntp也就不好使了从而造成无法访问应用软件库．<br><img src="https://img-blog.csdnimg.cn/20200414113835409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>注：还可以添加这个软件仓库　－　<a href="https://synocommunity.com/#easy-install" target="_blank" rel="external">https://synocommunity.com/#easy-install</a></p>
<h2 id="rsync同步"><a href="#rsync同步" class="headerlink" title="rsync同步"></a>rsync同步</h2><p> 可通过rsync命令同步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avztur --progress --delete --exclude &apos;me/xx&apos; /nas/  /cat</span><br></pre></td></tr></table></figure></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://post.smzdm.com/p/a4wm2rll/" target="_blank" rel="external">https://post.smzdm.com/p/a4wm2rll/</a><br>[2] <a href="https://post.smzdm.com/p/a6l8zglg/" target="_blank" rel="external">https://post.smzdm.com/p/a6l8zglg/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/17/How-to-use-private-registry-in-docker-and-containerd-and-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/17/How-to-use-private-registry-in-docker-and-containerd-and-k8s/" itemprop="url">How to use private registry in docker and containerd and k8s</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-17T10:01:59+08:00">
                2020-03-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-03-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="set-up-a-test-private-registry"><a href="#set-up-a-test-private-registry" class="headerlink" title="set up a test private registry"></a>set up a test private registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry:2</span><br><span class="line">mkdir ~/registry/certs &amp;&amp; cd  ~/registry/certs</span><br><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=zhhuabj-bastion.cloud.sts&quot;</span><br><span class="line">#openssl genrsa -passout pass:password -out server.key</span><br><span class="line">#openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=zhhuabj-bastion.cloud.sts&quot;</span><br><span class="line">#openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">#cat server.crt server.key &gt; server.pem</span><br><span class="line"></span><br><span class="line">cd ~/registry &amp;&amp; mkdir auth &amp;&amp; mkdir images</span><br><span class="line">sudo docker run --entrypoint htpasswd registry:2 -Bbn test password &gt; ./auth/htpasswd</span><br><span class="line">sudo docker run -d -p 5000:5000 -v `pwd`/images:/var/lib/registry --restart=always --name registry \</span><br><span class="line">-v `pwd`/auth:/auth \</span><br><span class="line">-e &quot;REGISTRY_AUTH=htpasswd&quot; \</span><br><span class="line">-e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; \</span><br><span class="line">-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">-v `pwd`/certs:/certs \</span><br><span class="line">-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/ca.crt \</span><br><span class="line">-e REGISTRY_HTTP_TLS_KEY=/certs/ca.key \</span><br><span class="line">registry:2</span><br><span class="line">curl -X GET --cacert /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/ca.crt https://zhhuabj-bastion.cloud.sts:5000</span><br></pre></td></tr></table></figure>
<h2 id="upload-a-test-image-into-test-private-registry"><a href="#upload-a-test-image-into-test-private-registry" class="headerlink" title="upload a test image into test private registry"></a>upload a test image into test private registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">scp -r root@zhhuabj-bastion.cloud.sts:/root/registry/certs/ca.crt .</span><br><span class="line">sudo mkdir -p /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo cp ca.crt /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/</span><br><span class="line">#must restart docker, or it will throw x509 related errors when running &apos;docker push&apos;</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">#another error when running &apos;docker login&apos; - cannot autolaunch D-Bus without X11 $DISPLAY</span><br><span class="line">#sudo apt autoremove --purge docker-compose -y</span><br><span class="line"></span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line"># cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;https://index.docker.io/v1/&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;emhodWFiajpuYW50aW5nNDEz&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;zhhuabj-bastion.cloud.sts:5000&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client/18.09.7 (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">sudo docker pull busybox &amp;&amp; sudo docker tag docker.io/busybox zhhuabj-bastion.cloud.sts:5000/busybox</span><br><span class="line">sudo docker push zhhuabj-bastion.cloud.sts:5000/busybox</span><br><span class="line">sudo docker logout zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">#docker save zhhuabj-bastion.cloud.sts:5000/busybox &gt; busybox.tar</span><br><span class="line">curl -X GET --cacert /etc/containerd/ca.crt https://zhhuabj-bastion.cloud.sts:5000/v2/busybox/manifests/latest --user test:password</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-docker"><a href="#test-it-in-docker" class="headerlink" title="test it in docker"></a>test it in docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ca.crt /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo docker pull zhhuabj-bastion.cloud.sts:5000/busybox</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-containerd"><a href="#test-it-in-containerd" class="headerlink" title="test it in containerd"></a>test it in containerd</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install containerd  #it will stop docker automatically</span><br><span class="line">sudo mkdir -p /etc/containerd</span><br><span class="line">containerd config default |sudo tee /etc/containerd/config.toml</span><br><span class="line">#juju scp ./certs/ca.crt kubernetes-worker/1:/home/ubuntu/</span><br><span class="line">sudo vim /etc/containerd/config.toml</span><br><span class="line">change</span><br><span class="line">    [plugins.cri.registry]</span><br><span class="line">      [plugins.cri.registry.mirrors]</span><br><span class="line">        [plugins.cri.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">to</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          endpoint = [&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths.&quot;https://zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          auth = &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">          username = &quot;test&quot;</span><br><span class="line">          password = &quot;password&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.tls_configs]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.tls_configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          ca_file = &quot;/etc/containerd/ca.crt&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;.tls]</span><br><span class="line">            insecure_skip_verify = true</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;.auth]</span><br><span class="line">            auth = &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">            username = &quot;test&quot;</span><br><span class="line">            password = &quot;password&quot;</span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">#sudo ctr -n k8s.io image import busybox.tar</span><br><span class="line">curl -X GET --cacert /etc/containerd/ca.crt https://zhhuabj-bastion.cloud.sts:5000/v2/busybox/manifests/latest --user test:password</span><br><span class="line">echo -n | openssl s_client -showcerts -connect zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo cp /home/ubuntu/ca.crt /etc/containerd/</span><br><span class="line">sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest --skip-verify</span><br><span class="line">sudo ctr --namespace k8s.io image ls |grep busybox</span><br><span class="line">sudo ctr image ls  |grep zhhuabj</span><br><span class="line"></span><br><span class="line">#seems there is a bug with insecure_skip_verify=true, finally we run update-ca-certificates, then remove &apos;skip-verify&apos;</span><br><span class="line">cp /etc/containerd/ca.crt /usr/local/share/ca-certificates/</span><br><span class="line">update-ca-certificates</span><br><span class="line">#sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest --skip-verify</span><br><span class="line">sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-k8s"><a href="#test-it-in-k8s" class="headerlink" title="test it in k8s"></a>test it in k8s</h2><p>Before running the following commands, we need first to modify above /etc/containerd/config.toml, custom_registries of containerd charm will do it<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju config containerd custom_registries=&apos;[&#123;&quot;url&quot;: &quot;https://zhhuabj-bastion.cloud.sts:5000&quot;, &quot;username&quot;: &quot;test&quot;, &quot;password&quot;: &quot;password&quot;&#125;]&apos;</span><br></pre></td></tr></table></figure></p>
<p>But how to run update-ca-certificates with ca.crt ? we search ‘ca_crt_path’ option from charm code. but how to do ?<br>then we can run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#kubectl create secret docker-registry regcred --docker-server=zhhuabj-bastion.cloud.sts:5000 --docker-username=test --docker-password=password --docker-email=&apos;admin@demo.com&apos;</span><br><span class="line">sudo bash -c &apos;cat &gt;config.json&apos; &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;zhhuabj-bastion.cloud.sts:5000&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client/18.09.7 (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">kubectl create secret generic regcred \</span><br><span class="line">    --from-file=.dockerconfigjson=./config.json \</span><br><span class="line">    --type=kubernetes.io/dockerconfigjson</span><br><span class="line">kubectl get secret regcred --output=&quot;jsonpath=&#123;.data.\.dockerconfigjson&#125;&quot; | base64 --decode</span><br><span class="line">sudo bash -c &apos;cat &gt;busybox.yaml&apos; &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: zhhuabj-bastion.cloud.sts:5000/busybox:latest</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f busybox.yaml</span><br><span class="line">kubectl get events</span><br></pre></td></tr></table></figure></p>
<h2 id="appendix-create-another-test-image"><a href="#appendix-create-another-test-image" class="headerlink" title="appendix - create another test image"></a>appendix - create another test image</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;simple-http-server.py&apos; &lt;&lt;EOF</span><br><span class="line">import SimpleHTTPServer</span><br><span class="line">import SocketServer</span><br><span class="line">PORT = 8000</span><br><span class="line">Handler = SimpleHTTPServer.SimpleHTTPRequestHandler</span><br><span class="line">httpd = SocketServer.TCPServer((&quot;0.0.0.0&quot;, PORT), Handler)</span><br><span class="line">print &quot;serving at port&quot;, PORT</span><br><span class="line">httpd.serve_forever()</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;Dockerfile&apos; &lt;&lt;EOF</span><br><span class="line">FROM python:2.7-alpine</span><br><span class="line">ADD simple-http-server.py /</span><br><span class="line">RUN apk update &amp;&amp; apk add bash</span><br><span class="line">RUN pip install simple_http_server</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./simple-http-server.py&quot; ]</span><br><span class="line">EOF</span><br><span class="line">sudo docker build -t simple-http-server .</span><br><span class="line">sudo docker tag simple-http-server zhhuabj-bastion.cloud.sts:5000/simple-http-server</span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo docker push zhhuabj-bastion.cloud.sts/simple-http-server</span><br><span class="line">sudo docker logout zhhuabj-bastion.cloud.sts:5000</span><br></pre></td></tr></table></figure>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://itnext.io/working-with-image-registries-and-containerd-in-kubernetes-63c311b86368" target="_blank" rel="external">https://itnext.io/working-with-image-registries-and-containerd-in-kubernetes-63c311b86368</a><br>[2] <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</a><br>[3] <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-18-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-18-04</a><br>[4] <a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/" target="_blank" rel="external">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/</a><br>[5] <a href="https://github.com/containerd/cri/blob/master/docs/registry.md#configure-registry-tls-communication" target="_blank" rel="external">https://github.com/containerd/cri/blob/master/docs/registry.md#configure-registry-tls-communication</a><br>[6] <a href="https://blog.csdn.net/y_chen_007/article/details/97525206" target="_blank" rel="external">https://blog.csdn.net/y_chen_007/article/details/97525206</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/Using-4G-NIC-in-OpenWRT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/03/Using-4G-NIC-in-OpenWRT/" itemprop="url">Using 4G NIC in OpenWRT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-03T21:27:16+08:00">
                2020-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-03-03<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>买了一块4G上网卡(ZTE MF79U), 买这款的原因是它支持Linux．在Ubuntu上运行不错，但想着将它安装到OpenWRT路由器上．</p>
<p>1, 编译OpenWRT源码添加下列模块，略．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kmod-usb-net kmod-mii kmod-usb-net-cdc-ether kmod-usb-net-rndis usb-modeswitch usbutils udev kmod-usb-core</span><br><span class="line"></span><br><span class="line">#https://www.cnblogs.com/vx-cg248805770/p/11477155.html</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-core=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-ohci=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-uhci=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-storage=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-storage-extras=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb2=y</span><br><span class="line">CONFIG_PACKAGE_kmod-scsi-core=y</span><br><span class="line">CONFIG_PACKAGE_block-mount=y</span><br><span class="line">CONFIG_PACKAGE_libmount=y</span><br><span class="line">CONFIG_BUSYBOX_CONFIG_MOUNT=y</span><br><span class="line">CONFIG_PACKAGE_kmod-fs-ext4=y</span><br><span class="line">CONFIG_PACKAGE_e2fsprogs=y</span><br><span class="line"></span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net-rndis=y</span><br><span class="line">CONFIG_PACKAGE_usb-modeswitch=y</span><br><span class="line">CONFIG_PACKAGE_usbutils=y</span><br></pre></td></tr></table></figure></p>
<p>NOTE:　当需要快速编译某个包的时候，如tcpdump<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grep -r &apos;tcpdump&apos; .config</span><br><span class="line">CONFIG_PACKAGE_tcpdump=y</span><br><span class="line">make ./package/network/utils/tcpdump/compile V=s</span><br></pre></td></tr></table></figure></p>
<p>2, 安装时遇到一个奇怪问题，明明上步编译的模块和之前的内核是同一版本编译的，但安装时对某些模块总是报下列错, 最后通过添加”–nodeps”解决．<br>NOTE:造成这个的原因是因为运行了’make clean＇这样导致现在的版本是4.14.137-1 (之前的是4.14.137)，多出一个-1，运行了’make clean’再重新编译了整个内核会产生产版本，所以也就出了这个错，只编译模块或者不运行’make clean’可避免这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Cannot satisfy the following dependencies for kmod-usb-net</span><br><span class="line">opkg install kmod-usb-net_4.14.167-1_mips_24kc.ipk --nodeps</span><br></pre></td></tr></table></figure></p>
<p>３，安装完上述模块后，插入4G上网卡，看到它使用了eth1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# opkg list-installed |grep usb</span><br><span class="line">kmod-usb-core - 4.14.167-1</span><br><span class="line">kmod-usb-ehci - 4.14.167-1</span><br><span class="line">kmod-usb-ledtrig-usbport - 4.14.167-1</span><br><span class="line">kmod-usb-net - 4.14.167-1</span><br><span class="line">kmod-usb-net-cdc-ether - 4.14.167-1</span><br><span class="line">kmod-usb-net-rndis - 4.14.167-1</span><br><span class="line">kmod-usb-storage - 4.14.167-1</span><br><span class="line">kmod-usb-storage-extras - 4.14.167-1</span><br><span class="line">kmod-usb2 - 4.14.167-1</span><br><span class="line">kmod-usb3 - 4.14.167-1</span><br><span class="line">libusb-1.0 - 1.0.22-1</span><br><span class="line">usb-modeswitch - 2017-12-19-f40f84c2-2</span><br><span class="line">usbutils - 007-9</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# lsusb |grep ZTE</span><br><span class="line">Bus 001 Device 015: ID 19d2:1405 ZTE WCDMA Technologies MSM</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# dmesg |grep ZTE |grep eth</span><br><span class="line">[2237153.266258] cdc_ether 1-1:1.0 eth1: register &apos;cdc_ether&apos; at usb-ehci-platform-1, ZTE CDC Ethernet Device, 00:a0:c6:00:00:00</span><br></pre></td></tr></table></figure></p>
<p>4, OpenWRT中作如下配置后就能看到eth1上有IP了．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/config/network</span><br><span class="line">config interface &apos;wan4g&apos;</span><br><span class="line">        option ifname  &apos;eth1&apos;</span><br><span class="line">        option proto &apos;dhcp&apos;</span><br><span class="line">        option dns &apos;8.8.8.8,8.8.4.4&apos;</span><br><span class="line">ifup eth1</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# ip addr show eth1 |grep global</span><br><span class="line">    inet 192.168.0.179/24 brd 192.168.0.255 scope global eth1</span><br></pre></td></tr></table></figure></p>
<p>5, 记得在防火墙设置中（<a href="http://192.168.99.1/cgi-bin/luci/admin/network/firewall/zones)把zone" target="_blank" rel="external">http://192.168.99.1/cgi-bin/luci/admin/network/firewall/zones)把zone</a> wan里面的network的参数改成’wan wan1’,之后可以看到添加了下列防火墙规则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# iptables-save |grep eth0</span><br><span class="line">-A PREROUTING -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_prerouting</span><br><span class="line">-A POSTROUTING -o eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_postrouting</span><br><span class="line">-A FORWARD -o eth0.2 -p tcp -m tcp --tcp-flags SYN,RST SYN -m comment --comment &quot;!fw3: Zone wan MTU fixing&quot; -j TCPMSS --clamp-mss-to-pmtu</span><br><span class="line">-A INPUT -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_input</span><br><span class="line">-A FORWARD -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_forward</span><br><span class="line">-A OUTPUT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_output</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth0.2 -m conntrack --ctstate INVALID -m comment --comment &quot;!fw3: Prevent NAT leakage&quot; -j DROP</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j ACCEPT</span><br><span class="line">-A zone_wan_dest_REJECT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">-A zone_wan_src_REJECT -i eth0.2 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">root@OpenWrt:~#</span><br><span class="line">root@OpenWrt:~# iptables-save |grep eth1</span><br><span class="line">-A PREROUTING -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_prerouting</span><br><span class="line">-A POSTROUTING -o eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_postrouting</span><br><span class="line">-A FORWARD -o eth1 -p tcp -m tcp --tcp-flags SYN,RST SYN -m comment --comment &quot;!fw3: Zone wan MTU fixing&quot; -j TCPMSS --clamp-mss-to-pmtu</span><br><span class="line">-A INPUT -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_input</span><br><span class="line">-A FORWARD -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_forward</span><br><span class="line">-A OUTPUT -o eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_output</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth1 -m conntrack --ctstate INVALID -m comment --comment &quot;!fw3: Prevent NAT leakage&quot; -j DROP</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth1 -m comment --comment &quot;!fw3&quot; -j ACCEPT</span><br><span class="line">-A zone_wan_dest_REJECT -o eth1 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">-A zone_wan_src_REJECT -i eth1 -m comment --comment &quot;!fw3&quot; -j reject</span><br></pre></td></tr></table></figure></p>
<p>6, 添加下列policy router之后就可以使用ssh的-b参数啦<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip rule add from 192.168.0.0/24 table ssh</span><br><span class="line">ip route add default via 192.168.0.1 dev eth1 table ssh</span><br><span class="line">ssh ubuntu@xxx -b 192.168.0.179</span><br></pre></td></tr></table></figure></p>
<p>7, 也可以将你想要走这个网卡出去的流量添加路由出去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#route add -host &lt;IP&gt; gw 192.168.0.1</span><br><span class="line">ip rule add from &lt;IP&gt; table ssh</span><br></pre></td></tr></table></figure></p>
<p>上面这种方法只针对路由器本机的可以，但会导致局域网其他机器无法ping这个IP了，改成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee -a /etc/firewall.user</span><br><span class="line">ipset create ssh iphash --exist</span><br><span class="line">ipset add ssh &lt;IP&gt; --exist</span><br><span class="line"></span><br><span class="line">#don&apos;t use chain to make sure these rules can be run before other chains</span><br><span class="line">iptables -t mangle -I PREROUTING -m set --match-set ssh dst -p tcp -m multiport --dport 22 -j MARK --set-mark 8</span><br><span class="line">iptables -t mangle -I OUTPUT -m set --match-set ssh dst -p tcp -m multiport --dport 22 -j MARK --set-mark 8</span><br><span class="line">#iptables -t mangle -I PREROUTING -m set --match-set ssh dst -j MARK --set-mark 8</span><br><span class="line">#iptables -t mangle -I OUTPUT -m set --match-set ssh dst -j MARK --set-mark 8</span><br><span class="line">#need to set rp_fillter=2 when using mangle</span><br><span class="line">sysctl net.ipv4.conf.all.rp_filter=2</span><br><span class="line">sysctl net.ipv4.conf.default.rp_filter=2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip rule del from 192.168.0.0/24 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule add from 192.168.0.0/24 table ssh</span><br><span class="line">ip route add default via 192.168.0.1 dev eth1 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule del fwmark 8 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule add fwmark 8 table ssh</span><br><span class="line">/etc/init.d/firewall restart</span><br><span class="line"></span><br><span class="line">#debug &amp; confirm</span><br><span class="line">tcpdump -ni eth1 host IP</span><br></pre></td></tr></table></figure>
<h2 id="appendix-use-usb-disk"><a href="#appendix-use-usb-disk" class="headerlink" title="appendix - use usb disk"></a>appendix - use usb disk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">block-mount e2fsprogs kmod-fs-ext4 kmod-usb-storage kmod-usb2 kmod-usb3</span><br><span class="line">fdisk libsmartcols libfdisk libncursesw terminfo</span><br><span class="line">kmod-fs-vfat kmod-nls-cp437 kmod-nls-iso8859-1 kmod-nls-utf8</span><br><span class="line">#nfs doesn&apos;t work - mounting nfsd on /proc/fs/nfsd failed: No such device</span><br><span class="line">nfs-kernel-server libblkid libtirpc libcomerr libext2fs libss  libwrap kmod-fs-nfsd rpcbind nfs-utils-libs libkeyutils libdevmapper kmod-fs-exportfs kmod-fs-nfs-common-rpcsec kmod-dm kmod-dax</span><br><span class="line"></span><br><span class="line">mkfs.ext4 /dev/sda1</span><br><span class="line">mount /dev/sda1 /mnt/sda1</span><br></pre></td></tr></table></figure>
<h2 id="Appendix-enable-docker"><a href="#Appendix-enable-docker" class="headerlink" title="Appendix - enable docker"></a>Appendix - enable docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Global build settings -&gt; kernel build options -&gt; Enable kernel cgroup [select all]</span><br><span class="line">Global build settings -&gt; kernel build options -&gt; Enable kernel namespaces [select all]</span><br><span class="line"></span><br><span class="line">CONFIG_KERNEL_PERF_EVENTS=y</span><br><span class="line">CONFIG_KERNEL_PROC_PID_CPUSET=y</span><br><span class="line">CONFIG_KERNEL_MEMCG_SWAP=y</span><br><span class="line">CONFIG_KERNEL_CGROUP_PERF=y</span><br><span class="line">CONFIG_KERNEL_NAMESPACES=y</span><br><span class="line">CONFIG_KERNEL_UTS_NS=y</span><br><span class="line">CONFIG_KERNEL_IPC_NS=y</span><br><span class="line">CONFIG_KERNEL_USER_NS=y</span><br><span class="line">CONFIG_KERNEL_PID_NS=y</span><br><span class="line">CONFIG_KERNEL_NET_NS=y</span><br><span class="line"></span><br><span class="line">opkg install libdevmapper libltdl iptables-mod-extra</span><br><span class="line">opkg find iptables-mod-* | cut -d &apos; &apos; -f 1 | grep iptables | xargs opkg install</span><br><span class="line">then install https://download.docker.com/linux/static/stable/aarch64/docker-19.03.8.tgz</span><br><span class="line">测试结果是启动dockerd时还需要bridge相关的包</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/docker/docker/master/contrib/check-config.sh</span><br><span class="line">chmod +x check-config.sh</span><br><span class="line">./check-config.sh</span><br><span class="line"></span><br><span class="line">The docker installer uses iptables for nat. Unfortunately Debian uses nftables. You can convert the entries over to nftables or just setup Debian to use the legacy iptables.</span><br><span class="line">sudo update-alternatives --set iptables /usr/sbin/iptables-legacy</span><br><span class="line">sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy</span><br><span class="line">dockerd, should start fine after switching to iptables-legacy.</span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure>
<h2 id="NanoPi-R2S"><a href="#NanoPi-R2S" class="headerlink" title="NanoPi R2S"></a>NanoPi R2S</h2><p>NanoPi R2S刷了官方ubuntu arm版镜像后, 使用网线连接r2s的LAN口与电脑, 在电脑设置了192.168.2.3/24后并无法ping通192.168.2.1, 那是为什么呢?<br>因为没买串口调试线, 后来将网线和WAN口也连接后, 看到WAN口绿灯了, 从而从192.162.99.216顺利登录了, 发现eth1口上没有设置IP和dhcp (之前在linux下使用sudo dd if=./xx.img bs=1M of=/dev/sdc conv=sync 写镜像连不上, 后来改到windows下使用win32DiskImager写入可以连WAN, 应该和这个没有关系, 之前没有试WAN的方法). 做下列设置即可.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;/etc/network/interfaces.d/eth1&apos; &lt;&lt;EOF</span><br><span class="line">auto eth1</span><br><span class="line">iface eth1 inet static</span><br><span class="line">    address 192.168.2.1</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl stop systemd-resolved</span><br><span class="line">systemctl disable systemd-resolved</span><br><span class="line">apt install dnsmasq</span><br><span class="line">rm /etc/resolv.conf</span><br><span class="line">echo &quot;nameserver 8.8.8.8&quot; &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dnsmasq.conf&apos; &lt;&lt;EOF</span><br><span class="line">#dns</span><br><span class="line">port=53</span><br><span class="line"># Never forward plain names (without a dot or domain part)</span><br><span class="line">domain-needed</span><br><span class="line"># Never forward addresses in the non-routed address spaces.</span><br><span class="line">bogus-priv</span><br><span class="line"># By  default,  dnsmasq  will  send queries to any of the upstream</span><br><span class="line"># servers it knows about and tries to favour servers to are  known</span><br><span class="line"># to  be  up.  Uncommenting this forces dnsmasq to try each query</span><br><span class="line"># with  each  server  strictly  in  the  order  they   appear   in</span><br><span class="line"># /etc/resolv.conf</span><br><span class="line">strict-order</span><br><span class="line"># Set this (and domain: see below) if you want to have a domain</span><br><span class="line"># automatically added to simple names in a hosts-file.</span><br><span class="line">expand-hosts</span><br><span class="line"># Set the domain for dnsmasq. this is optional, but if it is set, it</span><br><span class="line"># does the following things.</span><br><span class="line"># 1) Allows DHCP hosts to have fully qualified domain names, as long</span><br><span class="line">#     as the domain part matches this setting.</span><br><span class="line"># 2) Sets the &quot;domain&quot; DHCP option thereby potentially setting the</span><br><span class="line">#    domain of all systems configured by DHCP</span><br><span class="line"># 3) Provides the domain part for &quot;expand-hosts&quot;</span><br><span class="line">domain=lan</span><br><span class="line"># Set Liste address</span><br><span class="line">listen-address=192.168.2.1</span><br><span class="line">#dnssec</span><br><span class="line"></span><br><span class="line"># dhcp</span><br><span class="line">interface=eth1</span><br><span class="line">dhcp-range=192.168.2.25,192.168.2.50,24h</span><br><span class="line">dhcp-option=option:router,192.168.2.1</span><br><span class="line">#dhcp-option=option:ntp-server,192.168.2.5</span><br><span class="line">dhcp-option=option:dns-server,192.168.2.1</span><br><span class="line">dhcp-option=option:netmask,255.255.255.0</span><br><span class="line"></span><br><span class="line"># Logging.</span><br><span class="line">log-facility=/var/log/dnsmasq.log   # logfile path.</span><br><span class="line">log-async</span><br><span class="line">log-queries # log queries.</span><br><span class="line">log-dhcp    # log dhcp related messages.</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl restart dnsmasq</span><br><span class="line">systemctl enable dnsmasq</span><br></pre></td></tr></table></figure></p>
<p>其他设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#enable 4G network card</span><br><span class="line">cat &lt;&lt; EOF | tee -a /etc/network/interfaces.d/enx00a0c6000000</span><br><span class="line">auto enx00a0c6000000</span><br><span class="line">iface enx00a0c6000000 inet dhcp</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#others</span><br><span class="line">echo &apos;precedence ::ffff:0:0/96 100&apos; |sudo tee -a /etc/gai.conf</span><br><span class="line">apt update</span><br><span class="line">apt install docker.io</span><br><span class="line">mkdir -p /jellyfin/config</span><br><span class="line">mkdir -p /jellyfin/videos</span><br><span class="line">docker run --restart=always -d -p 8096:8096 -v /jellyfin/config:/config -v /jellyfin/videos:/videos jellyfin/jellyfin:10.1.0-arm64 -name myjellyfin</span><br><span class="line">mkdir /nextcloud -p</span><br><span class="line">docker run -d -p 8888:80  --name nextcloud  -v /nextcloud/:/var/www/html/ --restart=always --privileged=true  arm64v8/nextcloud</span><br><span class="line"></span><br><span class="line">#upgrade boost to 1.66.0</span><br><span class="line">rm -f /usr/lib/libboost*</span><br><span class="line">rm -fr &apos;find / -name libboost*&apos;</span><br><span class="line">mv /usr/include/boost /usr/include/boost-bak</span><br><span class="line">wget https://dl.bintray.com/boostorg/release/1.66.0/source/boost_1_66_0.tar.gz</span><br><span class="line">tar -zxvf boost_1_66_0.tar.gz</span><br><span class="line">cd boost_1_66_0</span><br><span class="line">./bootstrap.sh</span><br><span class="line">./b2 install</span><br></pre></td></tr></table></figure>
<h2 id="Failed-to-download-Packages-gz-wget-returned-1"><a href="#Failed-to-download-Packages-gz-wget-returned-1" class="headerlink" title="Failed to download /Packages.gz, wget returned 1"></a>Failed to download /Packages.gz, wget returned 1</h2><p>20201103更新，就想安装个rsync但运行’opkg install rsync’时报size不匹配错误，那是需要先运行’opkg update’但运行它时又报错误”Failed to download /Packages.gz, wget returned 1”,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# opkg update</span><br><span class="line">Downloading /Packages.gz</span><br><span class="line">*** Failed to download the package list from /Packages.gz</span><br><span class="line">...</span><br><span class="line">Collected errors:</span><br><span class="line"> * opkg_download: Failed to download /Packages.gz, wget returned 1.</span><br></pre></td></tr></table></figure></p>
<p>是由下列原因导致，注释它即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/opkg/customfeeds.conf</span><br><span class="line">src/gz https://mirrors.bfsu.edu.cn/openwrt/snapshots/packages/x86_64/packages/</span><br></pre></td></tr></table></figure></p>
<p>另外，注意里面应该使用http打头而不是https<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/opkg/distfeeds.conf</span><br><span class="line">#src/gz openwrt_core https://openwrt.proxy.ustclug.org/snapshots/targets/x86/64/packages</span><br><span class="line">#src/gz openwrt_base https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/base</span><br><span class="line">#src/gz openwrt_freifunk https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/freifunk</span><br><span class="line">#src/gz openwrt_helloworld https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/helloworld</span><br><span class="line">#src/gz openwrt_lienol https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/lienol</span><br><span class="line">#src/gz openwrt_luci https://openwrt.proxy.ustclug.org/releases/18.06.8/packages/x86_64/luci</span><br><span class="line">#src/gz openwrt_packages https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/packages</span><br><span class="line">#src/gz openwrt_routing https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/routing</span><br><span class="line">#src/gz openwrt_telephony https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/telephony</span><br><span class="line">#src/gz openwrt_base https://mirrors.cloud.tencent.com/openwrt/releases/packages-19.07/x86_64/base/</span><br><span class="line">#src/gz openwrt_luci https://mirrors.cloud.tencent.com/openwrt/releases/packages-19.07/x86_64/luci/</span><br><span class="line"></span><br><span class="line">#src/gz openwrt_all http://openwrt.download/ExtraPackages/all</span><br><span class="line">#src/gz openwrt_ipk http://openwrt.download/ExtraPackages/x86_64</span><br><span class="line"></span><br><span class="line">src/gz openwrt_base http://downloads.openwrt.org/snapshots/packages/x86_64/base</span><br><span class="line">src/gz openwrt_packages http://downloads.openwrt.org/snapshots/packages/x86_64/packages</span><br><span class="line">src/gz openwrt_luci http://downloads.openwrt.org/snapshots/packages/x86_64/luci</span><br></pre></td></tr></table></figure></p>
<h2 id="20201105更新-openwrt密钥"><a href="#20201105更新-openwrt密钥" class="headerlink" title="20201105更新 - openwrt密钥"></a>20201105更新 - openwrt密钥</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.ssh</span><br><span class="line">dropbearkey -t rsa -f ~/.ssh/id_rsa</span><br><span class="line">dropbearkey -y -f ~/.ssh/id_rsa |sed -n 2p &gt; ~/.ssh/id_rsa.pub</span><br><span class="line"># https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9</span><br><span class="line">ln -s ~/.ssh/id_rsa ~/.ssh/id_dropbear</span><br><span class="line">chmod 700 ~/.ssh</span><br><span class="line">touch ~/.ssh/authorized_keys &amp;&amp; chmod 644 ~/.ssh/authorized_keys</span><br><span class="line">ssh admin@192.168.2.103 &quot;tee -a /root/.ssh/authorized_keys&quot; &lt; ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/set-up-rabbitmq-pacemaker-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/27/set-up-rabbitmq-pacemaker-cluster/" itemprop="url">set up rabbitmq pacemaker cluster</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-27T19:22:45+08:00">
                2020-02-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-27<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="test-steps"><a href="#test-steps" class="headerlink" title="test steps"></a>test steps</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">juju add-model ha</span><br><span class="line">juju deploy ubuntu rabbit1 --series=bionic --config hostname=rabbit1 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">juju deploy ubuntu rabbit2 --series=bionic --config hostname=rabbit2 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">juju deploy ubuntu rabbit3 --series=bionic --config hostname=rabbit3 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ juju status |grep ready</span><br><span class="line">rabbit1/0*  active    idle   0        10.5.0.7               ready</span><br><span class="line">rabbit2/0*  active    idle   1        10.5.0.15              ready</span><br><span class="line">rabbit3/0*  active    idle   2        10.5.0.12              ready</span><br><span class="line"></span><br><span class="line">#run the following commands in 3 units</span><br><span class="line">echo -e &quot;10.5.0.7 rabbit1\n10.5.0.15 rabbit2\n10.5.0.12 rabbit3&quot; |sudo tee -a /etc/hosts</span><br><span class="line"></span><br><span class="line">echo -e &quot;net.ipv4.ip_nonlocal_bind = 1\nnet.ipv4.ip_forward = 1&quot; |sudo tee -a /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br><span class="line"></span><br><span class="line">sudo apt install chrony -y      ##https://www.server-world.info/en/note?os=Ubuntu_18.04&amp;p=ntp</span><br><span class="line">sudo systemctl restart chrony</span><br><span class="line"></span><br><span class="line">sudo apt install pacemaker corosync fence-agents resource-agents crmsh pcs -y</span><br><span class="line">sudo apt install rabbitmq-server -y</span><br><span class="line"></span><br><span class="line">HOSTNAME=$(hostname)</span><br><span class="line">cat &lt;&lt; EOF | sudo tee -a /etc/rabbitmq/rabbitmq-env.conf</span><br><span class="line">RABBITMQ_NODENAME=rabbit@$HOSTNAME</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/corosync/corosync.conf</span><br><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    cluster_name: quqicluster</span><br><span class="line">    transport: udpu</span><br><span class="line">    token: 55000</span><br><span class="line">    rrp_problem_count_timeout: 110000</span><br><span class="line">    rrp_problem_count_threshold: 30</span><br><span class="line">    token_retransmits_before_loss_const: 30</span><br><span class="line">&#125;</span><br><span class="line">nodelist &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit1</span><br><span class="line">        nodeid: 1</span><br><span class="line">    &#125;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit2</span><br><span class="line">        nodeid: 2</span><br><span class="line">    &#125;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit3</span><br><span class="line">        nodeid: 3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">&#125;</span><br><span class="line">logging &#123;</span><br><span class="line">    fileline: off</span><br><span class="line">    to_stderr: no</span><br><span class="line">    to_logfile: yes</span><br><span class="line">    logfile: /var/log/corosync.log</span><br><span class="line">    to_syslog: yes</span><br><span class="line">    syslog_facility: daemon</span><br><span class="line">    debug: on</span><br><span class="line">    timestamp: on</span><br><span class="line">    logger_subsys &#123;</span><br><span class="line">        subsys: QUORUM</span><br><span class="line">        debug: on</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">#sudo systemctl restart corosync   #use pcs instead for management</span><br><span class="line">sudo systemctl restart pcsd</span><br><span class="line">sudo systemctl enable pcsd</span><br><span class="line">#configure node authentication</span><br><span class="line">sudo passwd hacluster   #change the password to &apos;password&apos; for the user hacluster</span><br><span class="line">sudo pcs cluster auth -u hacluster -p password rabbit1 rabbit2 rabbit3</span><br><span class="line">#create the cluster</span><br><span class="line">sudo pcs cluster setup --force --name quqicluster rabbit1 rabbit2 rabbit3</span><br><span class="line">sudo pcs cluster enable --all</span><br><span class="line">sudo pcs cluster start --all</span><br><span class="line">sudo pcs status</span><br><span class="line">sudo pcs status corosync</span><br><span class="line">sudo pcs cluster status</span><br><span class="line">sudo corosync-cfgtool -s</span><br><span class="line">sudo corosync-cmapctl | grep members</span><br><span class="line">sudo pcs property set stonith-enabled=false  #Resource start-up disabled since no STONITH resources have been defined</span><br><span class="line">sudo pcs property set no-quorum-policy=ignore</span><br><span class="line">sudo crm_verify -L -V</span><br><span class="line">sudo pcs property set pe-warn-series-max=1000 pe-input-series-max=1000 pe-error-series-max=1000</span><br><span class="line">sudo pcs property set cluster-recheck-interval=5</span><br><span class="line">sudo pcs resource delete rabbitmq-clone --force</span><br><span class="line">sudo pcs resource create rabbitmq-clone ocf:heartbeat:rabbitmq-cluster --clone ordered=true interleave=true</span><br><span class="line">sudo pcs resource update rabbitmq-clone op monitor interval=30 timeout=120</span><br><span class="line">sudo pcs resource update rabbitmq-clone op start interval=0 timeout=100</span><br><span class="line">sudo pcs resource update rabbitmq-clone op stop interval=0 timeout=90</span><br><span class="line">#sudo pcs resource update rabbitmq-clone meta ordered=true interleave=true</span><br><span class="line">sudo pcs resource show rabbitmq-clone</span><br><span class="line">sudo pcs resource</span><br><span class="line">sudo pcs config show</span><br><span class="line">sudo pcs status</span><br><span class="line">sudo rabbitmqctl cluster_status</span><br><span class="line">sudo crm resource restart rabbitmq-clone</span><br><span class="line">sudo crm resource clean rabbitmq-clone</span><br><span class="line">sudo rabbitmqctl list_users</span><br><span class="line">sudo rabbitmqctl cluster_status</span><br><span class="line"></span><br><span class="line">#or use crm command instead of pcs</span><br><span class="line">wget https://raw.githubusercontent.com/ClusterLabs/crmsh/master/contrib/bash_completion.sh</span><br><span class="line">sudo cp bash_completion.sh /etc/bash_completion.d/crmsh</span><br><span class="line">source /etc/bash_completion.d/crmsh</span><br><span class="line">sudo crm configure show</span><br><span class="line">sudo crm ra list ocf |grep rabbit</span><br><span class="line">sudo crm ra meta rabbitmq-cluster</span><br><span class="line">sudo crm configure property stonith-enabled=false</span><br><span class="line">sudo crm configure primitive rabbitmq ocf:heartbeat:rabbitmq-cluster \</span><br><span class="line">  op monitor interval=30 timeout=120 \</span><br><span class="line">  op start interval=0 timeout=100 \</span><br><span class="line">  op stop interval=0 timeout=90</span><br><span class="line">sudo crm configure clone rabbitmq-clone rabbitmq \</span><br><span class="line">  meta ordered=true interleave=true</span><br><span class="line"></span><br><span class="line">#configure a VIP 10.5.0.122 by using pcs/corosync</span><br><span class="line">sudo pcs resource create rabbitvip ocf:heartbeat:IPaddr2 ip=10.5.0.122 cidr_netmask=24 nic=ens3 op monitor interval=30s</span><br><span class="line">#or configure a VIP 10.5.0.122 by using haproxy (not test)</span><br><span class="line">sudo apt install -y haproxy</span><br><span class="line">cat &lt;&lt; EOF | sudo tee -a /etc/haproxy/haproxy.cfg</span><br><span class="line">listen httpd</span><br><span class="line">    bind 10.5.0.122:5672</span><br><span class="line">    balance source</span><br><span class="line">    option tcpka</span><br><span class="line">    option httpchk</span><br><span class="line">    option tcplog</span><br><span class="line">    server juju-3f992e-ha-0 10.5.0.12:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">    server juju-3f992e-ha-1 10.5.0.7:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">    server juju-3f992e-ha-2 10.5.0.10:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">EOF</span><br><span class="line">sudo pcs resource create lb-haproxy systemd:haproxy --clone</span><br><span class="line">sudo pcs constraint colocation add lb-haproxy-clone with vip   #make haproxy and vip in the same nodes</span><br><span class="line">sudo pcs constraint order start vip then lb-haproxy-clone kind=Optional  #make first start vip before starting haproxy</span><br><span class="line">sudo pcs resource</span><br></pre></td></tr></table></figure>
<h2 id="standby-test"><a href="#standby-test" class="headerlink" title="standby test"></a>standby test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@rabbit1:~$ sudo crm node standby rabbit1</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit1:~$ sudo crm status</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: rabbit1 (version 1.1.18-2b07d5c5a9) - partition with quorum</span><br><span class="line">Last updated: Fri Feb 28 03:00:32 2020</span><br><span class="line">Last change: Fri Feb 28 02:58:53 2020 by root via crm_attribute on rabbit1</span><br><span class="line">3 nodes configured</span><br><span class="line">4 resources configured</span><br><span class="line">Node rabbit1: standby</span><br><span class="line">Online: [ rabbit2 rabbit3 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> Clone Set: rabbitmq-clone-clone [rabbitmq-clone]</span><br><span class="line">     Started: [ rabbit2 rabbit3 ]</span><br><span class="line">     Stopped: [ rabbit1 ]</span><br><span class="line"> rabbitvip      (ocf::heartbeat:IPaddr2):       Started rabbit2</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit2:~$ sudo rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbit2</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbit2]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbit2]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit@rabbit2&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;rabbit@rabbit2,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="some-logs"><a href="#some-logs" class="headerlink" title="some logs"></a>some logs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@rabbit1:~$ sudo rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbit1</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbit1]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbit1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit@rabbit1&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;rabbit@rabbit1,[]&#125;]&#125;]</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit1:~$ sudo pcs resource show rabbitmq-clone</span><br><span class="line"> Resource: rabbitmq-clone (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">  Operations: monitor interval=10 timeout=40 (rabbitmq-clone-monitor-interval-10)</span><br><span class="line">              start interval=0s timeout=100 (rabbitmq-clone-start-interval-0s)</span><br><span class="line">              stop interval=0s timeout=90 (rabbitmq-clone-stop-interval-0s)</span><br><span class="line">ubuntu@rabbit1:~$</span><br><span class="line">ubuntu@rabbit1:~$ sudo crm status</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: rabbit1 (version 1.1.18-2b07d5c5a9) - partition with quorum</span><br><span class="line">Last updated: Fri Feb 28 02:52:34 2020</span><br><span class="line">Last change: Fri Feb 28 02:49:43 2020 by root via cibadmin on rabbit1</span><br><span class="line"></span><br><span class="line">3 nodes configured</span><br><span class="line">4 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ rabbit1 rabbit2 rabbit3 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Clone Set: rabbitmq-clone-clone [rabbitmq-clone]</span><br><span class="line">     Started: [ rabbit1 rabbit2 rabbit3 ]</span><br><span class="line"> rabbitvip      (ocf::heartbeat:IPaddr2):       Started rabbit1</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster auth -u hacluster -p password rabbit1 rabbit2 rabbit3</span><br><span class="line">rabbit3: Authorized</span><br><span class="line">rabbit2: Authorized</span><br><span class="line">rabbit1: Authorized</span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster setup --force --name quqicluster rabbit1 rabbit2 rabbit3</span><br><span class="line">Destroying cluster on nodes: rabbit1, rabbit2, rabbit3...</span><br><span class="line">rabbit1: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit3: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit2: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit3: Successfully destroyed cluster</span><br><span class="line">rabbit1: Successfully destroyed cluster</span><br><span class="line">rabbit2: Successfully destroyed cluster</span><br><span class="line"></span><br><span class="line">Sending &apos;pacemaker_remote authkey&apos; to &apos;rabbit1&apos;, &apos;rabbit2&apos;, &apos;rabbit3&apos;</span><br><span class="line">rabbit3: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">rabbit1: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">rabbit2: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">Sending cluster config files to the nodes...</span><br><span class="line">rabbit1: Succeeded</span><br><span class="line">rabbit2: Succeeded</span><br><span class="line">rabbit3: Succeeded</span><br><span class="line"></span><br><span class="line">Synchronizing pcsd certificates on nodes rabbit1, rabbit2, rabbit3...</span><br><span class="line">rabbit3: Success</span><br><span class="line">rabbit2: Success</span><br><span class="line">rabbit1: Success</span><br><span class="line">Restarting pcsd on the nodes in order to reload the certificates...</span><br><span class="line">rabbit3: Success</span><br><span class="line">rabbit1: Success</span><br><span class="line">rabbit2: Success</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster enable --all</span><br><span class="line">rabbit1: Cluster Enabled</span><br><span class="line">rabbit2: Cluster Enabled</span><br><span class="line">rabbit3: Cluster Enabled</span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster start --all</span><br><span class="line">rabbit1: Starting Cluster...</span><br><span class="line">rabbit2: Starting Cluster...</span><br><span class="line">rabbit3: Starting Cluster...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ubuntu@juju-3f992e-ha-2:~$ sudo pcs resource show rabbitmq-clone</span><br><span class="line"> Clone: rabbitmq-clone</span><br><span class="line">  Meta Attrs: ordered=true interleave=true</span><br><span class="line">  Resource: rabbitmq (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">   Operations: monitor interval=30 timeout=120 (rabbitmq-monitor-30)</span><br><span class="line">               start interval=0 timeout=100 (rabbitmq-start-0)</span><br><span class="line">               stop interval=0 timeout=90 (rabbitmq-stop-0)</span><br><span class="line"></span><br><span class="line"> Clone: rabbitmq-clone</span><br><span class="line">  Meta Attrs: interleave=true ordered=true</span><br><span class="line">  Resource: rabbitmq (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">   Attributes: set_policy=&quot;ha-all ^(?!amq\.).* &#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&quot;</span><br><span class="line">   Operations: start interval=0s timeout=100 (rabbitmq-start-interval-0s)</span><br><span class="line">               stop interval=0s timeout=90 (rabbitmq-stop-interval-0s)</span><br><span class="line">               monitor interval=30 timeout=120 (rabbitmq-monitor-interval-30)</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://www.andylouse.net/openstack-queens-cluster-mode-system-optimize-and-configuration" target="_blank" rel="external">https://www.andylouse.net/openstack-queens-cluster-mode-system-optimize-and-configuration</a><br>[2] <a href="https://www.centos.bz/2019/06/linux%E4%B8%8B%E6%90%AD%E5%BB%BAhaproxypacemakercorosync%E9%9B%86%E7%BE%A4/" target="_blank" rel="external">https://www.centos.bz/2019/06/linux%E4%B8%8B%E6%90%AD%E5%BB%BAhaproxypacemakercorosync%E9%9B%86%E7%BE%A4/</a><br>[3] <a href="https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html" target="_blank" rel="external">https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">89</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
