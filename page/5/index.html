<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/18/用ubuntu的使用习惯使用windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/18/用ubuntu的使用习惯使用windows/" itemprop="url">用ubuntu的使用习惯使用windows</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-18T16:25:23+08:00">
                2020-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-04-18<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>新入手了一台笔记本电脑，默认安装了win10，用了十几年linux了，也一大堆linux的vps维护的太麻烦，还是就只使用单系统的win10吧。那样，问题来了，如何像平时使用ubuntu的习惯一样使用linux呢？</p>
<h2 id="CLI工具的选择"><a href="#CLI工具的选择" class="headerlink" title="CLI工具的选择"></a>CLI工具的选择</h2><p>国内网络太慢，所以从来不在国内的机器上跑程序，都是ssh到国外vps上来办公的， 这样主要是使用CLI命令，很少或几乎没有使用GUI工具的习惯。所以选择一个好的CLI工具是决定能否继续使用windows的关键。</p>
<ul>
<li>能用wsl吗？wsl将linux系统调用翻译成windows调用, 决定了它仅支持CLI， 当然也可以通过windows上安装xming之类的x server来运行某一些GUI（wsl内运行:export DISPLAY=:0.0)，但很多GUI是不支持的如chrome与firefox; 另外，wsl也不支持访问底层硬件所以无法运行python pyaudio之类的程序。wsl的优点它可以通过运行’wsl’快速切换到ubuntu bash；也可以通过’wsl ls’之类的命令实现在windows上直接运行bash命令， 这对我这种只熟悉unix命令不熟悉windows命令的人来说吸引力是很大的。所以wsl要结合着用，但主要就是用它的’wsl ls’之类的方便（后面会讲如何通过alias来使用它）。</li>
<li>能用powershell吗？要运行访问硬件之类的python pyaudio程序只能通过powershell, 不能使用ubuntu wsl shell或者cgwin shell. 使用powershell不支持自定义快捷键让我像使用bash的快捷键习惯一样使用它，这个缺点是对我来说是致命的，所以我不能用它。</li>
<li>能用mabaxterm吗？mabaxterm同时集成了wsl shell, cgwin shell, powershell， 但这些全如上面说的不合我的需求。所以只能将它作为备用，偶尔用用它好用的x server, scp等功能。我很少用GUI，所以这对我来说也属于低概率事件，备用着吧。</li>
<li>cmder是我最终选用的工具，它的cmder shell支持使用python pyaudio程序，和bash一样的快捷键使用习惯。也集成了git, ssh这些常用的功能，也能通过定义alias别名方便使用wsl bash命令， 也支持tabs。很好，就是它了，现在需要设置它让它更符合我平时使用linux的习惯。<h2 id="设置cmder的home-dir"><a href="#设置cmder的home-dir" class="headerlink" title="设置cmder的home dir"></a>设置cmder的home dir</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;wsl</span><br><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# grep -r &apos;home pat&apos; /mnt/d/soft/cmder/vendor/init.bat -A 3</span><br><span class="line">:: Set home path</span><br><span class="line">if not defined HOME set &quot;HOME=%USERPROFILE%&quot;</span><br><span class="line">%lib_console% debug_output init.bat &quot;Env Var - HOME=%HOME%&quot;</span><br><span class="line">@cd /d &quot;D:/&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="定义-bak软链与ubuntu的路径使用习惯相同"><a href="#定义-bak软链与ubuntu的路径使用习惯相同" class="headerlink" title="定义/bak软链与ubuntu的路径使用习惯相同"></a>定义/bak软链与ubuntu的路径使用习惯相同</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# ln -s /mnt/d /bak</span><br><span class="line">root@DESKTOP-ENUSKP0:/mnt/d# ls /bak/soft/cmder/vendor/init.bat</span><br><span class="line">/bak/soft/cmder/vendor/init.bat</span><br></pre></td></tr></table></figure>
<p><strong>定义alias别名在cmder shell更方便直接使用wsl bash命令</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;cat soft/cmder/config/user_aliases.cmd |tail -n 20</span><br><span class="line">sshxxx=ssh ubuntu@xxx -b 192.168.8.101</span><br><span class="line">ifconfig=wsl ifconfig</span><br><span class="line">awk=wsl awk</span><br><span class="line">head=wsl head</span><br><span class="line">less=wsl less</span><br><span class="line">ls=wsl ls</span><br><span class="line">man=wsl man</span><br><span class="line">sed=wsl sed</span><br><span class="line">tail=wsl tail</span><br><span class="line">route=wsl route</span><br><span class="line">ping=wsl ping</span><br><span class="line">nslookup=wsl nslookup</span><br><span class="line">dig=wsl dig</span><br><span class="line">tar=wsl tar</span><br><span class="line">cat=wsl cat</span><br><span class="line">tee=wsl tee</span><br></pre></td></tr></table></figure></p>
<h2 id="设置默认使用cmder-shell"><a href="#设置默认使用cmder-shell" class="headerlink" title="设置默认使用cmder shell"></a>设置默认使用cmder shell</h2><p>注： win+shift+s可以快速截屏<br><img src="https://img-blog.csdnimg.cn/20200418153925206.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="标题在General-gt-Confirm中去掉警告"><a href="#标题在General-gt-Confirm中去掉警告" class="headerlink" title="标题在General -&gt; Confirm中去掉警告"></a>标题在General -&gt; Confirm中去掉警告</h2><h2 id="设置tab相关的快捷键与chrome-vimum"><a href="#设置tab相关的快捷键与chrome-vimum" class="headerlink" title="设置tab相关的快捷键与chrome vimum"></a>设置tab相关的快捷键与chrome vimum</h2><p><img src="https://img-blog.csdnimg.cn/2020041815444182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="其他-让windows支持内录"><a href="#其他-让windows支持内录" class="headerlink" title="其他 - 让windows支持内录"></a>其他 - 让windows支持内录</h2><p>thinkpad x1 yoga只有一个音频口，喇叭在放音的时候就单工了麦克风不能录音了，能让声音内部从喇叭路由到pyaudio程序处理了再内部路由到麦克风吗？答案是需要安装虚拟路由，同时得支持路由在虚拟设备和物理设备间路由。有款叫voicemeeter的软件就是做这件事的。路由设置如下图：</p>
<ul>
<li>在1处选内装麦克风，同时将A去掉，A代表可以从麦克风处输入声音</li>
<li>2处不选 ，因为只有一个音频物理设备</li>
<li>3处是选虚拟设备的，A,B两处默认都选<br>最右侧输出到扬声器<br><img src="https://img-blog.csdnimg.cn/20200418155154203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>需要将声音的输入和输出默认都走虚拟设备<br><img src="https://img-blog.csdnimg.cn/20200418155253484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>注意：这样，声音就被内部路由到python pyaudio了， 如果外部也能从物理设备录音的话，必须一直开着voicemeeter, 所以按win+r键输入 shell:startup 进入 C:\Users\ThinkPad\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup 目录， 将voicemeeter的链接加到这个目录开机就自动启动了. 不过， 我不是这样做的，voicemeeter菜单中有如下的两项开机自动启动并放入拖盘的设置，如下图。<br><img src="https://img-blog.csdnimg.cn/20200418155839452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h2 id="粘贴到vim全变成一行的问题"><a href="#粘贴到vim全变成一行的问题" class="headerlink" title="粘贴到vim全变成一行的问题"></a>粘贴到vim全变成一行的问题</h2>如从记事本复制多行内容，然后粘贴到vim却变成了多行，将下图中Ctrl+Shift+V的快捷键设置成Multi lines模式即可。<br><img src="https://img-blog.csdnimg.cn/20200418161126265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li>
</ul>
<h2 id="另一个开机自启的方法"><a href="#另一个开机自启的方法" class="headerlink" title="另一个开机自启的方法"></a>另一个开机自启的方法</h2><p>上面介绍了一种开机自启的方法，但对于cmd命令的自启还要写脚本打开shell，再后台运行程序，再关shell。但我的windows shell不熟悉啊。有一种简单的将自己的应用放入服务的方法， 以开机自启frpc为例：</p>
<ul>
<li>将nssm.exe下载放到和frpc同一级目录</li>
<li>运行：nssm install frpc 会弹出配置服务界面，照着配置就行了</li>
<li><p>到服务目录设置自动启动它。</p>
<h2 id="安装clink增强cmder的像bash-completion一样的命令提示"><a href="#安装clink增强cmder的像bash-completion一样的命令提示" class="headerlink" title="安装clink增强cmder的像bash completion一样的命令提示"></a>安装clink增强cmder的像bash completion一样的命令提示</h2><h2 id="安装类似于proxychain的proxycap"><a href="#安装类似于proxychain的proxycap" class="headerlink" title="安装类似于proxychain的proxycap"></a>安装类似于proxychain的proxycap</h2><h2 id="安装winaera-tweaker设置系统代替设置注册表"><a href="#安装winaera-tweaker设置系统代替设置注册表" class="headerlink" title="安装winaera tweaker设置系统代替设置注册表"></a>安装winaera tweaker设置系统代替设置注册表</h2><h2 id="使用qnap-nas"><a href="#使用qnap-nas" class="headerlink" title="使用qnap nas"></a>使用qnap nas</h2><p>qnap nas设置了nfs server, wsl中由于没nfs内核模块，无法通过autofs设置nfs.<br>所以直接在浏览器上通过\<nas-ip>就可以访问nas了, 或者安装qfinder pro</nas-ip></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/14/猫盘安装群晖synology/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/14/猫盘安装群晖synology/" itemprop="url">猫盘安装群晖synology</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-14T11:42:48+08:00">
                2020-04-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-04-14<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>家里有两个nas, 一个威联通的，一个猫盘，猫盘长期没怎么用，今天一看开机后找不着IP，后来多重启几次后，发现偶尔路由器上能看到IP, 它每次IP都变，并且也容易掉IP．而且还无法打开ssh，所以这个猫盘不是我心目中理想的样子，它很烂．但想着里面还有一块硬盘也不能就这么丢了啊．于是想着把它刷成群晖synology.<br>网上一堆通过什么ttl刷机的方法，那个太麻烦了，还得买线，还得拆机，还得搭线，我们还是寻找软个的方法．其实问题的关键是猫盘打开ssh太麻烦了，如果有了ssh直接刷synology很简单．x3p默认支持ssh，所以我们先通过网络的方式刷x3p，然后再刷synology.</p>
<h2 id="通过猫盘一键刷机v2-0刷x3p"><a href="#通过猫盘一键刷机v2-0刷x3p" class="headerlink" title="通过猫盘一键刷机v2.0刷x3p"></a>通过猫盘一键刷机v2.0刷x3p</h2><p>我也忘了哪里下载的猫盘一键刷机v2.0工具，大家自行在网上搜索，有名字应该很容易找到该工具的下载地址，或者去百度网盘搜搜．下载安装好后，通过网络刷x3p要知道几个信息：</p>
<ul>
<li>猫盘的IP，从路由器里找</li>
<li>猫盘的mac，从猫盘背后找．但注意一点是，要想每次启动IP不变的话，mac地址前面几位应该固定成78C2C0，后面六位从猫盘背后找．</li>
<li><p>猫盘的SN, 从猫盘背后找．<br>有了这些信息后，按下列步骤刷x3p</p>
</li>
<li><p>打开猫盘一键刷机工具，把上面的信息粘贴进去，点击开始刷机 (注意注意：刷机前一定要关闭win10上的防火墙）</p>
</li>
<li>刷好后有提示，这时候需要拔下电源，按住reset！等待10秒以上，按着他不要停！同时连上电源，等网线的灯亮起在松手。</li>
<li>这时候猫盘应该顶灯不停闪烁，等待15分钟左右，路由器能够看到你的猫盘就算刷好了</li>
<li>打开网页，地址栏输入猫盘的新ip，进入X3P登录页面. 它有两个帐号，一个admin，密码：123456, 一个root, 密码为Etech12 (呆会ssh时需要使用root用户）</li>
<li>做到这一步如果想使用x3p就继续升级，如果想使用synology的话做到这一步就算完了．<h2 id="ssh一键刷synology"><a href="#ssh一键刷synology" class="headerlink" title="ssh一键刷synology"></a>ssh一键刷synology</h2>使用root (Etech12)用户ssh登录到系统，一键运行下列命令即可：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -N --no-check-certificate https://raw.githubusercontent.com/Squaregentleman/catdrive-syno/master/install.sh</span><br><span class="line">chmod +x install.sh</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>但是由于你知道的糟糕的网络环境，可能install.sh里面要下载的<a href="https://github.com/Squaregentleman/catdrive-syno/raw/master/full.bin永远无法下载下来．所以可以手工把它先下载下来，再把它上传到x3p(无权限），然后再将install.sh里换成这个链接．" target="_blank" rel="external">https://github.com/Squaregentleman/catdrive-syno/raw/master/full.bin永远无法下载下来．所以可以手工把它先下载下来，再把它上传到x3p(无权限），然后再将install.sh里换成这个链接．</a></p>
<h2 id="配置synology"><a href="#配置synology" class="headerlink" title="配置synology"></a>配置synology</h2><p>上步安装好synology之后，接着就要配置synology, 本来也没什么好说的，看着文字说明一步一步做就行了．也是因为你知道的糟糕的网络环境，需要先手工下载下列文件，然后做到这一步时看文字选手工安装安装它：<br><a href="https://cndl.synology.cn/download/DSM/release/6.2.2/24922/DSM_DS119j_24922.pat?model=DS119j&amp;bays=1&amp;dsm_version=6.2.2&amp;build_number=24922" target="_blank" rel="external">https://cndl.synology.cn/download/DSM/release/6.2.2/24922/DSM_DS119j_24922.pat?model=DS119j&amp;bays=1&amp;dsm_version=6.2.2&amp;build_number=24922</a>　</p>
<h2 id="配置nfs"><a href="#配置nfs" class="headerlink" title="配置nfs"></a>配置nfs</h2><p>控制面板定义一个共享文件夹如bak, 关联用户admin, 然后要定义NFS权限，如下图，在squash处选择＂映射所有用户为admin. 不然的话，你若通过（sudo mount -t nfs 192.168.99.169:/volume1/bak /cat）mount了的话，然后使用添加sudo如＂sudo ls /cat”才能访问．<br><img src="https://img-blog.csdnimg.cn/20200414113138418.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="autofs配置"><a href="#autofs配置" class="headerlink" title="autofs配置"></a>autofs配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/auto.direct |tail -n 1</span><br><span class="line">/cat    -fstype=nfs,rw,rsize=32768,wsize=32768,vers=3,username=admin,password=nanting413     192.168.99.169:/volume1/bak</span><br><span class="line">$ cat /etc/auto.master |tail -n 1</span><br><span class="line">/-	auto.direct</span><br><span class="line"></span><br><span class="line">sudo systemctl restart autofs</span><br></pre></td></tr></table></figure>
<h2 id="一个大坑"><a href="#一个大坑" class="headerlink" title="一个大坑"></a>一个大坑</h2><p>通过IP访问控制台时，在套件中心要安装软件时，总是会报连接网络失败，问题是我们的网络肯定是好的．找了好久，终于发现仍然是我们特殊的网络环境造成的．<br>需要打开ntp，如下图，但默认使用的ntp服务器是time.google.com，所以被那个了，ntp也就不好使了从而造成无法访问应用软件库．<br><img src="https://img-blog.csdnimg.cn/20200414113835409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>注：还可以添加这个软件仓库　－　<a href="https://synocommunity.com/#easy-install" target="_blank" rel="external">https://synocommunity.com/#easy-install</a></p>
<h2 id="rsync同步"><a href="#rsync同步" class="headerlink" title="rsync同步"></a>rsync同步</h2><p> 可通过rsync命令同步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avztur --progress --delete --exclude &apos;me/xx&apos; /nas/  /cat</span><br></pre></td></tr></table></figure></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://post.smzdm.com/p/a4wm2rll/" target="_blank" rel="external">https://post.smzdm.com/p/a4wm2rll/</a><br>[2] <a href="https://post.smzdm.com/p/a6l8zglg/" target="_blank" rel="external">https://post.smzdm.com/p/a6l8zglg/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/17/How-to-use-private-registry-in-docker-and-containerd-and-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/17/How-to-use-private-registry-in-docker-and-containerd-and-k8s/" itemprop="url">How to use private registry in docker and containerd and k8s</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-17T10:01:59+08:00">
                2020-03-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-03-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="set-up-a-test-private-registry"><a href="#set-up-a-test-private-registry" class="headerlink" title="set up a test private registry"></a>set up a test private registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry:2</span><br><span class="line">mkdir ~/registry/certs &amp;&amp; cd  ~/registry/certs</span><br><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=zhhuabj-bastion.cloud.sts&quot;</span><br><span class="line">#openssl genrsa -passout pass:password -out server.key</span><br><span class="line">#openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=zhhuabj-bastion.cloud.sts&quot;</span><br><span class="line">#openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">#cat server.crt server.key &gt; server.pem</span><br><span class="line"></span><br><span class="line">cd ~/registry &amp;&amp; mkdir auth &amp;&amp; mkdir images</span><br><span class="line">sudo docker run --entrypoint htpasswd registry:2 -Bbn test password &gt; ./auth/htpasswd</span><br><span class="line">sudo docker run -d -p 5000:5000 -v `pwd`/images:/var/lib/registry --restart=always --name registry \</span><br><span class="line">-v `pwd`/auth:/auth \</span><br><span class="line">-e &quot;REGISTRY_AUTH=htpasswd&quot; \</span><br><span class="line">-e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; \</span><br><span class="line">-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">-v `pwd`/certs:/certs \</span><br><span class="line">-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/ca.crt \</span><br><span class="line">-e REGISTRY_HTTP_TLS_KEY=/certs/ca.key \</span><br><span class="line">registry:2</span><br><span class="line">curl -X GET --cacert /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/ca.crt https://zhhuabj-bastion.cloud.sts:5000</span><br></pre></td></tr></table></figure>
<h2 id="upload-a-test-image-into-test-private-registry"><a href="#upload-a-test-image-into-test-private-registry" class="headerlink" title="upload a test image into test private registry"></a>upload a test image into test private registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">scp -r root@zhhuabj-bastion.cloud.sts:/root/registry/certs/ca.crt .</span><br><span class="line">sudo mkdir -p /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo cp ca.crt /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/</span><br><span class="line">#must restart docker, or it will throw x509 related errors when running &apos;docker push&apos;</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">#another error when running &apos;docker login&apos; - cannot autolaunch D-Bus without X11 $DISPLAY</span><br><span class="line">#sudo apt autoremove --purge docker-compose -y</span><br><span class="line"></span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line"># cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;https://index.docker.io/v1/&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;emhodWFiajpuYW50aW5nNDEz&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;zhhuabj-bastion.cloud.sts:5000&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client/18.09.7 (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">sudo docker pull busybox &amp;&amp; sudo docker tag docker.io/busybox zhhuabj-bastion.cloud.sts:5000/busybox</span><br><span class="line">sudo docker push zhhuabj-bastion.cloud.sts:5000/busybox</span><br><span class="line">sudo docker logout zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">#docker save zhhuabj-bastion.cloud.sts:5000/busybox &gt; busybox.tar</span><br><span class="line">curl -X GET --cacert /etc/containerd/ca.crt https://zhhuabj-bastion.cloud.sts:5000/v2/busybox/manifests/latest --user test:password</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-docker"><a href="#test-it-in-docker" class="headerlink" title="test it in docker"></a>test it in docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ca.crt /etc/docker/certs.d/zhhuabj-bastion.cloud.sts:5000/</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo docker pull zhhuabj-bastion.cloud.sts:5000/busybox</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-containerd"><a href="#test-it-in-containerd" class="headerlink" title="test it in containerd"></a>test it in containerd</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install containerd  #it will stop docker automatically</span><br><span class="line">sudo mkdir -p /etc/containerd</span><br><span class="line">containerd config default |sudo tee /etc/containerd/config.toml</span><br><span class="line">#juju scp ./certs/ca.crt kubernetes-worker/1:/home/ubuntu/</span><br><span class="line">sudo vim /etc/containerd/config.toml</span><br><span class="line">change</span><br><span class="line">    [plugins.cri.registry]</span><br><span class="line">      [plugins.cri.registry.mirrors]</span><br><span class="line">        [plugins.cri.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">to</span><br><span class="line">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          endpoint = [&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths.&quot;https://zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          auth = &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">          username = &quot;test&quot;</span><br><span class="line">          password = &quot;password&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.tls_configs]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.tls_configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          ca_file = &quot;/etc/containerd/ca.crt&quot;</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span><br><span class="line">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;]</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;.tls]</span><br><span class="line">            insecure_skip_verify = true</span><br><span class="line">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;zhhuabj-bastion.cloud.sts:5000&quot;.auth]</span><br><span class="line">            auth = &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">            username = &quot;test&quot;</span><br><span class="line">            password = &quot;password&quot;</span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">#sudo ctr -n k8s.io image import busybox.tar</span><br><span class="line">curl -X GET --cacert /etc/containerd/ca.crt https://zhhuabj-bastion.cloud.sts:5000/v2/busybox/manifests/latest --user test:password</span><br><span class="line">echo -n | openssl s_client -showcerts -connect zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo cp /home/ubuntu/ca.crt /etc/containerd/</span><br><span class="line">sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest --skip-verify</span><br><span class="line">sudo ctr --namespace k8s.io image ls |grep busybox</span><br><span class="line">sudo ctr image ls  |grep zhhuabj</span><br><span class="line"></span><br><span class="line">#seems there is a bug with insecure_skip_verify=true, finally we run update-ca-certificates, then remove &apos;skip-verify&apos;</span><br><span class="line">cp /etc/containerd/ca.crt /usr/local/share/ca-certificates/</span><br><span class="line">update-ca-certificates</span><br><span class="line">#sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest --skip-verify</span><br><span class="line">sudo ctr --debug images pull --user test:password zhhuabj-bastion.cloud.sts:5000/busybox:latest</span><br></pre></td></tr></table></figure>
<h2 id="test-it-in-k8s"><a href="#test-it-in-k8s" class="headerlink" title="test it in k8s"></a>test it in k8s</h2><p>Before running the following commands, we need first to modify above /etc/containerd/config.toml, custom_registries of containerd charm will do it<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju config containerd custom_registries=&apos;[&#123;&quot;url&quot;: &quot;https://zhhuabj-bastion.cloud.sts:5000&quot;, &quot;username&quot;: &quot;test&quot;, &quot;password&quot;: &quot;password&quot;&#125;]&apos;</span><br></pre></td></tr></table></figure></p>
<p>But how to run update-ca-certificates with ca.crt ? we search ‘ca_crt_path’ option from charm code. but how to do ?<br>then we can run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#kubectl create secret docker-registry regcred --docker-server=zhhuabj-bastion.cloud.sts:5000 --docker-username=test --docker-password=password --docker-email=&apos;admin@demo.com&apos;</span><br><span class="line">sudo bash -c &apos;cat &gt;config.json&apos; &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;zhhuabj-bastion.cloud.sts:5000&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;dGVzdDpwYXNzd29yZA==&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client/18.09.7 (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">kubectl create secret generic regcred \</span><br><span class="line">    --from-file=.dockerconfigjson=./config.json \</span><br><span class="line">    --type=kubernetes.io/dockerconfigjson</span><br><span class="line">kubectl get secret regcred --output=&quot;jsonpath=&#123;.data.\.dockerconfigjson&#125;&quot; | base64 --decode</span><br><span class="line">sudo bash -c &apos;cat &gt;busybox.yaml&apos; &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: zhhuabj-bastion.cloud.sts:5000/busybox:latest</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f busybox.yaml</span><br><span class="line">kubectl get events</span><br></pre></td></tr></table></figure></p>
<h2 id="appendix-create-another-test-image"><a href="#appendix-create-another-test-image" class="headerlink" title="appendix - create another test image"></a>appendix - create another test image</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;simple-http-server.py&apos; &lt;&lt;EOF</span><br><span class="line">import SimpleHTTPServer</span><br><span class="line">import SocketServer</span><br><span class="line">PORT = 8000</span><br><span class="line">Handler = SimpleHTTPServer.SimpleHTTPRequestHandler</span><br><span class="line">httpd = SocketServer.TCPServer((&quot;0.0.0.0&quot;, PORT), Handler)</span><br><span class="line">print &quot;serving at port&quot;, PORT</span><br><span class="line">httpd.serve_forever()</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;Dockerfile&apos; &lt;&lt;EOF</span><br><span class="line">FROM python:2.7-alpine</span><br><span class="line">ADD simple-http-server.py /</span><br><span class="line">RUN apk update &amp;&amp; apk add bash</span><br><span class="line">RUN pip install simple_http_server</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./simple-http-server.py&quot; ]</span><br><span class="line">EOF</span><br><span class="line">sudo docker build -t simple-http-server .</span><br><span class="line">sudo docker tag simple-http-server zhhuabj-bastion.cloud.sts:5000/simple-http-server</span><br><span class="line">sudo docker login -u=test -p=password zhhuabj-bastion.cloud.sts:5000</span><br><span class="line">sudo docker push zhhuabj-bastion.cloud.sts/simple-http-server</span><br><span class="line">sudo docker logout zhhuabj-bastion.cloud.sts:5000</span><br></pre></td></tr></table></figure>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://itnext.io/working-with-image-registries-and-containerd-in-kubernetes-63c311b86368" target="_blank" rel="external">https://itnext.io/working-with-image-registries-and-containerd-in-kubernetes-63c311b86368</a><br>[2] <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</a><br>[3] <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-18-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-18-04</a><br>[4] <a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/" target="_blank" rel="external">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/</a><br>[5] <a href="https://github.com/containerd/cri/blob/master/docs/registry.md#configure-registry-tls-communication" target="_blank" rel="external">https://github.com/containerd/cri/blob/master/docs/registry.md#configure-registry-tls-communication</a><br>[6] <a href="https://blog.csdn.net/y_chen_007/article/details/97525206" target="_blank" rel="external">https://blog.csdn.net/y_chen_007/article/details/97525206</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/Using-4G-NIC-in-OpenWRT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/03/Using-4G-NIC-in-OpenWRT/" itemprop="url">Using 4G NIC in OpenWRT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-03T21:27:16+08:00">
                2020-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-03-03<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>买了一块4G上网卡(ZTE MF79U), 买这款的原因是它支持Linux．在Ubuntu上运行不错，但想着将它安装到OpenWRT路由器上．</p>
<p>1, 编译OpenWRT源码添加下列模块，略．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kmod-usb-net kmod-mii kmod-usb-net-cdc-ether kmod-usb-net-rndis usb-modeswitch usbutils udev kmod-usb-core</span><br><span class="line"></span><br><span class="line">#https://www.cnblogs.com/vx-cg248805770/p/11477155.html</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-core=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-ohci=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-uhci=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-storage=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-storage-extras=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb2=y</span><br><span class="line">CONFIG_PACKAGE_kmod-scsi-core=y</span><br><span class="line">CONFIG_PACKAGE_block-mount=y</span><br><span class="line">CONFIG_PACKAGE_libmount=y</span><br><span class="line">CONFIG_BUSYBOX_CONFIG_MOUNT=y</span><br><span class="line">CONFIG_PACKAGE_kmod-fs-ext4=y</span><br><span class="line">CONFIG_PACKAGE_e2fsprogs=y</span><br><span class="line"></span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net-cdc-ether=y</span><br><span class="line">CONFIG_PACKAGE_kmod-usb-net-rndis=y</span><br><span class="line">CONFIG_PACKAGE_usb-modeswitch=y</span><br><span class="line">CONFIG_PACKAGE_usbutils=y</span><br></pre></td></tr></table></figure></p>
<p>NOTE:　当需要快速编译某个包的时候，如tcpdump<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grep -r &apos;tcpdump&apos; .config</span><br><span class="line">CONFIG_PACKAGE_tcpdump=y</span><br><span class="line">make ./package/network/utils/tcpdump/compile V=s</span><br></pre></td></tr></table></figure></p>
<p>2, 安装时遇到一个奇怪问题，明明上步编译的模块和之前的内核是同一版本编译的，但安装时对某些模块总是报下列错, 最后通过添加”–nodeps”解决．<br>NOTE:造成这个的原因是因为运行了’make clean＇这样导致现在的版本是4.14.137-1 (之前的是4.14.137)，多出一个-1，运行了’make clean’再重新编译了整个内核会产生产版本，所以也就出了这个错，只编译模块或者不运行’make clean’可避免这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Cannot satisfy the following dependencies for kmod-usb-net</span><br><span class="line">opkg install kmod-usb-net_4.14.167-1_mips_24kc.ipk --nodeps</span><br></pre></td></tr></table></figure></p>
<p>３，安装完上述模块后，插入4G上网卡，看到它使用了eth1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# opkg list-installed |grep usb</span><br><span class="line">kmod-usb-core - 4.14.167-1</span><br><span class="line">kmod-usb-ehci - 4.14.167-1</span><br><span class="line">kmod-usb-ledtrig-usbport - 4.14.167-1</span><br><span class="line">kmod-usb-net - 4.14.167-1</span><br><span class="line">kmod-usb-net-cdc-ether - 4.14.167-1</span><br><span class="line">kmod-usb-net-rndis - 4.14.167-1</span><br><span class="line">kmod-usb-storage - 4.14.167-1</span><br><span class="line">kmod-usb-storage-extras - 4.14.167-1</span><br><span class="line">kmod-usb2 - 4.14.167-1</span><br><span class="line">kmod-usb3 - 4.14.167-1</span><br><span class="line">libusb-1.0 - 1.0.22-1</span><br><span class="line">usb-modeswitch - 2017-12-19-f40f84c2-2</span><br><span class="line">usbutils - 007-9</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# lsusb |grep ZTE</span><br><span class="line">Bus 001 Device 015: ID 19d2:1405 ZTE WCDMA Technologies MSM</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# dmesg |grep ZTE |grep eth</span><br><span class="line">[2237153.266258] cdc_ether 1-1:1.0 eth1: register &apos;cdc_ether&apos; at usb-ehci-platform-1, ZTE CDC Ethernet Device, 00:a0:c6:00:00:00</span><br></pre></td></tr></table></figure></p>
<p>4, OpenWRT中作如下配置后就能看到eth1上有IP了．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/config/network</span><br><span class="line">config interface &apos;wan4g&apos;</span><br><span class="line">        option ifname  &apos;eth1&apos;</span><br><span class="line">        option proto &apos;dhcp&apos;</span><br><span class="line">        option dns &apos;8.8.8.8,8.8.4.4&apos;</span><br><span class="line">ifup eth1</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# ip addr show eth1 |grep global</span><br><span class="line">    inet 192.168.0.179/24 brd 192.168.0.255 scope global eth1</span><br></pre></td></tr></table></figure></p>
<p>5, 记得在防火墙设置中（<a href="http://192.168.99.1/cgi-bin/luci/admin/network/firewall/zones)把zone" target="_blank" rel="external">http://192.168.99.1/cgi-bin/luci/admin/network/firewall/zones)把zone</a> wan里面的network的参数改成’wan wan1’,之后可以看到添加了下列防火墙规则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# iptables-save |grep eth0</span><br><span class="line">-A PREROUTING -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_prerouting</span><br><span class="line">-A POSTROUTING -o eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_postrouting</span><br><span class="line">-A FORWARD -o eth0.2 -p tcp -m tcp --tcp-flags SYN,RST SYN -m comment --comment &quot;!fw3: Zone wan MTU fixing&quot; -j TCPMSS --clamp-mss-to-pmtu</span><br><span class="line">-A INPUT -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_input</span><br><span class="line">-A FORWARD -i eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_forward</span><br><span class="line">-A OUTPUT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j zone_wan_output</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth0.2 -m conntrack --ctstate INVALID -m comment --comment &quot;!fw3: Prevent NAT leakage&quot; -j DROP</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j ACCEPT</span><br><span class="line">-A zone_wan_dest_REJECT -o eth0.2 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">-A zone_wan_src_REJECT -i eth0.2 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">root@OpenWrt:~#</span><br><span class="line">root@OpenWrt:~# iptables-save |grep eth1</span><br><span class="line">-A PREROUTING -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_prerouting</span><br><span class="line">-A POSTROUTING -o eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_postrouting</span><br><span class="line">-A FORWARD -o eth1 -p tcp -m tcp --tcp-flags SYN,RST SYN -m comment --comment &quot;!fw3: Zone wan MTU fixing&quot; -j TCPMSS --clamp-mss-to-pmtu</span><br><span class="line">-A INPUT -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_input</span><br><span class="line">-A FORWARD -i eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_forward</span><br><span class="line">-A OUTPUT -o eth1 -m comment --comment &quot;!fw3&quot; -j zone_wan_output</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth1 -m conntrack --ctstate INVALID -m comment --comment &quot;!fw3: Prevent NAT leakage&quot; -j DROP</span><br><span class="line">-A zone_wan_dest_ACCEPT -o eth1 -m comment --comment &quot;!fw3&quot; -j ACCEPT</span><br><span class="line">-A zone_wan_dest_REJECT -o eth1 -m comment --comment &quot;!fw3&quot; -j reject</span><br><span class="line">-A zone_wan_src_REJECT -i eth1 -m comment --comment &quot;!fw3&quot; -j reject</span><br></pre></td></tr></table></figure></p>
<p>6, 添加下列policy router之后就可以使用ssh的-b参数啦<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip rule add from 192.168.0.0/24 table ssh</span><br><span class="line">ip route add default via 192.168.0.1 dev eth1 table ssh</span><br><span class="line">ssh ubuntu@xxx -b 192.168.0.179</span><br></pre></td></tr></table></figure></p>
<p>7, 也可以将你想要走这个网卡出去的流量添加路由出去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#route add -host &lt;IP&gt; gw 192.168.0.1</span><br><span class="line">ip rule add from &lt;IP&gt; table ssh</span><br></pre></td></tr></table></figure></p>
<p>上面这种方法只针对路由器本机的可以，但会导致局域网其他机器无法ping这个IP了，改成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee -a /etc/firewall.user</span><br><span class="line">ipset create ssh iphash --exist</span><br><span class="line">ipset add ssh &lt;IP&gt; --exist</span><br><span class="line"></span><br><span class="line">#don&apos;t use chain to make sure these rules can be run before other chains</span><br><span class="line">iptables -t mangle -I PREROUTING -m set --match-set ssh dst -p tcp -m multiport --dport 22 -j MARK --set-mark 8</span><br><span class="line">iptables -t mangle -I OUTPUT -m set --match-set ssh dst -p tcp -m multiport --dport 22 -j MARK --set-mark 8</span><br><span class="line">#iptables -t mangle -I PREROUTING -m set --match-set ssh dst -j MARK --set-mark 8</span><br><span class="line">#iptables -t mangle -I OUTPUT -m set --match-set ssh dst -j MARK --set-mark 8</span><br><span class="line">#need to set rp_fillter=2 when using mangle</span><br><span class="line">sysctl net.ipv4.conf.all.rp_filter=2</span><br><span class="line">sysctl net.ipv4.conf.default.rp_filter=2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip rule del from 192.168.0.0/24 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule add from 192.168.0.0/24 table ssh</span><br><span class="line">ip route add default via 192.168.0.1 dev eth1 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule del fwmark 8 table ssh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">ip rule add fwmark 8 table ssh</span><br><span class="line">/etc/init.d/firewall restart</span><br><span class="line"></span><br><span class="line">#debug &amp; confirm</span><br><span class="line">tcpdump -ni eth1 host IP</span><br></pre></td></tr></table></figure>
<h2 id="appendix-use-usb-disk"><a href="#appendix-use-usb-disk" class="headerlink" title="appendix - use usb disk"></a>appendix - use usb disk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">block-mount e2fsprogs kmod-fs-ext4 kmod-usb-storage kmod-usb2 kmod-usb3</span><br><span class="line">fdisk libsmartcols libfdisk libncursesw terminfo</span><br><span class="line">kmod-fs-vfat kmod-nls-cp437 kmod-nls-iso8859-1 kmod-nls-utf8</span><br><span class="line">#nfs doesn&apos;t work - mounting nfsd on /proc/fs/nfsd failed: No such device</span><br><span class="line">nfs-kernel-server libblkid libtirpc libcomerr libext2fs libss  libwrap kmod-fs-nfsd rpcbind nfs-utils-libs libkeyutils libdevmapper kmod-fs-exportfs kmod-fs-nfs-common-rpcsec kmod-dm kmod-dax</span><br><span class="line"></span><br><span class="line">mkfs.ext4 /dev/sda1</span><br><span class="line">mount /dev/sda1 /mnt/sda1</span><br></pre></td></tr></table></figure>
<h2 id="Appendix-enable-docker"><a href="#Appendix-enable-docker" class="headerlink" title="Appendix - enable docker"></a>Appendix - enable docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Global build settings -&gt; kernel build options -&gt; Enable kernel cgroup [select all]</span><br><span class="line">Global build settings -&gt; kernel build options -&gt; Enable kernel namespaces [select all]</span><br><span class="line"></span><br><span class="line">CONFIG_KERNEL_PERF_EVENTS=y</span><br><span class="line">CONFIG_KERNEL_PROC_PID_CPUSET=y</span><br><span class="line">CONFIG_KERNEL_MEMCG_SWAP=y</span><br><span class="line">CONFIG_KERNEL_CGROUP_PERF=y</span><br><span class="line">CONFIG_KERNEL_NAMESPACES=y</span><br><span class="line">CONFIG_KERNEL_UTS_NS=y</span><br><span class="line">CONFIG_KERNEL_IPC_NS=y</span><br><span class="line">CONFIG_KERNEL_USER_NS=y</span><br><span class="line">CONFIG_KERNEL_PID_NS=y</span><br><span class="line">CONFIG_KERNEL_NET_NS=y</span><br><span class="line"></span><br><span class="line">opkg install libdevmapper libltdl iptables-mod-extra</span><br><span class="line">opkg find iptables-mod-* | cut -d &apos; &apos; -f 1 | grep iptables | xargs opkg install</span><br><span class="line">then install https://download.docker.com/linux/static/stable/aarch64/docker-19.03.8.tgz</span><br><span class="line">测试结果是启动dockerd时还需要bridge相关的包</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/docker/docker/master/contrib/check-config.sh</span><br><span class="line">chmod +x check-config.sh</span><br><span class="line">./check-config.sh</span><br><span class="line"></span><br><span class="line">The docker installer uses iptables for nat. Unfortunately Debian uses nftables. You can convert the entries over to nftables or just setup Debian to use the legacy iptables.</span><br><span class="line">sudo update-alternatives --set iptables /usr/sbin/iptables-legacy</span><br><span class="line">sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy</span><br><span class="line">dockerd, should start fine after switching to iptables-legacy.</span><br><span class="line">sudo service docker start</span><br></pre></td></tr></table></figure>
<h2 id="NanoPi-R2S"><a href="#NanoPi-R2S" class="headerlink" title="NanoPi R2S"></a>NanoPi R2S</h2><p>NanoPi R2S刷了官方ubuntu arm版镜像后, 使用网线连接r2s的LAN口与电脑, 在电脑设置了192.168.2.3/24后并无法ping通192.168.2.1, 那是为什么呢?<br>因为没买串口调试线, 后来将网线和WAN口也连接后, 看到WAN口绿灯了, 从而从192.162.99.216顺利登录了, 发现eth1口上没有设置IP和dhcp (之前在linux下使用sudo dd if=./xx.img bs=1M of=/dev/sdc conv=sync 写镜像连不上, 后来改到windows下使用win32DiskImager写入可以连WAN, 应该和这个没有关系, 之前没有试WAN的方法). 做下列设置即可.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;/etc/network/interfaces.d/eth1&apos; &lt;&lt;EOF</span><br><span class="line">auto eth1</span><br><span class="line">iface eth1 inet static</span><br><span class="line">    address 192.168.2.1</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl stop systemd-resolved</span><br><span class="line">systemctl disable systemd-resolved</span><br><span class="line">apt install dnsmasq</span><br><span class="line">rm /etc/resolv.conf</span><br><span class="line">echo &quot;nameserver 8.8.8.8&quot; &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dnsmasq.conf&apos; &lt;&lt;EOF</span><br><span class="line">#dns</span><br><span class="line">port=53</span><br><span class="line"># Never forward plain names (without a dot or domain part)</span><br><span class="line">domain-needed</span><br><span class="line"># Never forward addresses in the non-routed address spaces.</span><br><span class="line">bogus-priv</span><br><span class="line"># By  default,  dnsmasq  will  send queries to any of the upstream</span><br><span class="line"># servers it knows about and tries to favour servers to are  known</span><br><span class="line"># to  be  up.  Uncommenting this forces dnsmasq to try each query</span><br><span class="line"># with  each  server  strictly  in  the  order  they   appear   in</span><br><span class="line"># /etc/resolv.conf</span><br><span class="line">strict-order</span><br><span class="line"># Set this (and domain: see below) if you want to have a domain</span><br><span class="line"># automatically added to simple names in a hosts-file.</span><br><span class="line">expand-hosts</span><br><span class="line"># Set the domain for dnsmasq. this is optional, but if it is set, it</span><br><span class="line"># does the following things.</span><br><span class="line"># 1) Allows DHCP hosts to have fully qualified domain names, as long</span><br><span class="line">#     as the domain part matches this setting.</span><br><span class="line"># 2) Sets the &quot;domain&quot; DHCP option thereby potentially setting the</span><br><span class="line">#    domain of all systems configured by DHCP</span><br><span class="line"># 3) Provides the domain part for &quot;expand-hosts&quot;</span><br><span class="line">domain=lan</span><br><span class="line"># Set Liste address</span><br><span class="line">listen-address=192.168.2.1</span><br><span class="line">#dnssec</span><br><span class="line"></span><br><span class="line"># dhcp</span><br><span class="line">interface=eth1</span><br><span class="line">dhcp-range=192.168.2.25,192.168.2.50,24h</span><br><span class="line">dhcp-option=option:router,192.168.2.1</span><br><span class="line">#dhcp-option=option:ntp-server,192.168.2.5</span><br><span class="line">dhcp-option=option:dns-server,192.168.2.1</span><br><span class="line">dhcp-option=option:netmask,255.255.255.0</span><br><span class="line"></span><br><span class="line"># Logging.</span><br><span class="line">log-facility=/var/log/dnsmasq.log   # logfile path.</span><br><span class="line">log-async</span><br><span class="line">log-queries # log queries.</span><br><span class="line">log-dhcp    # log dhcp related messages.</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl restart dnsmasq</span><br><span class="line">systemctl enable dnsmasq</span><br></pre></td></tr></table></figure></p>
<p>其他设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#enable 4G network card</span><br><span class="line">cat &lt;&lt; EOF | tee -a /etc/network/interfaces.d/enx00a0c6000000</span><br><span class="line">auto enx00a0c6000000</span><br><span class="line">iface enx00a0c6000000 inet dhcp</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#others</span><br><span class="line">echo &apos;precedence ::ffff:0:0/96 100&apos; |sudo tee -a /etc/gai.conf</span><br><span class="line">apt update</span><br><span class="line">apt install docker.io</span><br><span class="line">mkdir -p /jellyfin/config</span><br><span class="line">mkdir -p /jellyfin/videos</span><br><span class="line">docker run --restart=always -d -p 8096:8096 -v /jellyfin/config:/config -v /jellyfin/videos:/videos jellyfin/jellyfin:10.1.0-arm64 -name myjellyfin</span><br><span class="line">mkdir /nextcloud -p</span><br><span class="line">docker run -d -p 8888:80  --name nextcloud  -v /nextcloud/:/var/www/html/ --restart=always --privileged=true  arm64v8/nextcloud</span><br><span class="line"></span><br><span class="line">#upgrade boost to 1.66.0</span><br><span class="line">rm -f /usr/lib/libboost*</span><br><span class="line">rm -fr &apos;find / -name libboost*&apos;</span><br><span class="line">mv /usr/include/boost /usr/include/boost-bak</span><br><span class="line">wget https://dl.bintray.com/boostorg/release/1.66.0/source/boost_1_66_0.tar.gz</span><br><span class="line">tar -zxvf boost_1_66_0.tar.gz</span><br><span class="line">cd boost_1_66_0</span><br><span class="line">./bootstrap.sh</span><br><span class="line">./b2 install</span><br></pre></td></tr></table></figure>
<h2 id="Failed-to-download-Packages-gz-wget-returned-1"><a href="#Failed-to-download-Packages-gz-wget-returned-1" class="headerlink" title="Failed to download /Packages.gz, wget returned 1"></a>Failed to download /Packages.gz, wget returned 1</h2><p>20201103更新，就想安装个rsync但运行’opkg install rsync’时报size不匹配错误，那是需要先运行’opkg update’但运行它时又报错误”Failed to download /Packages.gz, wget returned 1”,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# opkg update</span><br><span class="line">Downloading /Packages.gz</span><br><span class="line">*** Failed to download the package list from /Packages.gz</span><br><span class="line">...</span><br><span class="line">Collected errors:</span><br><span class="line"> * opkg_download: Failed to download /Packages.gz, wget returned 1.</span><br></pre></td></tr></table></figure></p>
<p>是由下列原因导致，注释它即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/opkg/customfeeds.conf</span><br><span class="line">src/gz https://mirrors.bfsu.edu.cn/openwrt/snapshots/packages/x86_64/packages/</span><br></pre></td></tr></table></figure></p>
<p>另外，注意里面应该使用http打头而不是https<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/opkg/distfeeds.conf</span><br><span class="line">#src/gz openwrt_core https://openwrt.proxy.ustclug.org/snapshots/targets/x86/64/packages</span><br><span class="line">#src/gz openwrt_base https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/base</span><br><span class="line">#src/gz openwrt_freifunk https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/freifunk</span><br><span class="line">#src/gz openwrt_helloworld https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/helloworld</span><br><span class="line">#src/gz openwrt_lienol https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/lienol</span><br><span class="line">#src/gz openwrt_luci https://openwrt.proxy.ustclug.org/releases/18.06.8/packages/x86_64/luci</span><br><span class="line">#src/gz openwrt_packages https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/packages</span><br><span class="line">#src/gz openwrt_routing https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/routing</span><br><span class="line">#src/gz openwrt_telephony https://openwrt.proxy.ustclug.org/snapshots/packages/x86_64/telephony</span><br><span class="line">#src/gz openwrt_base https://mirrors.cloud.tencent.com/openwrt/releases/packages-19.07/x86_64/base/</span><br><span class="line">#src/gz openwrt_luci https://mirrors.cloud.tencent.com/openwrt/releases/packages-19.07/x86_64/luci/</span><br><span class="line"></span><br><span class="line">#src/gz openwrt_all http://openwrt.download/ExtraPackages/all</span><br><span class="line">#src/gz openwrt_ipk http://openwrt.download/ExtraPackages/x86_64</span><br><span class="line"></span><br><span class="line">src/gz openwrt_base http://downloads.openwrt.org/snapshots/packages/x86_64/base</span><br><span class="line">src/gz openwrt_packages http://downloads.openwrt.org/snapshots/packages/x86_64/packages</span><br><span class="line">src/gz openwrt_luci http://downloads.openwrt.org/snapshots/packages/x86_64/luci</span><br></pre></td></tr></table></figure></p>
<h2 id="20201105更新-openwrt密钥"><a href="#20201105更新-openwrt密钥" class="headerlink" title="20201105更新 - openwrt密钥"></a>20201105更新 - openwrt密钥</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.ssh</span><br><span class="line">dropbearkey -t rsa -f ~/.ssh/id_rsa</span><br><span class="line">dropbearkey -y -f ~/.ssh/id_rsa |sed -n 2p &gt; ~/.ssh/id_rsa.pub</span><br><span class="line"># https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9</span><br><span class="line">ln -s ~/.ssh/id_rsa ~/.ssh/id_dropbear</span><br><span class="line">chmod 700 ~/.ssh</span><br><span class="line">touch ~/.ssh/authorized_keys &amp;&amp; chmod 644 ~/.ssh/authorized_keys</span><br><span class="line">ssh admin@192.168.2.103 &quot;tee -a /root/.ssh/authorized_keys&quot; &lt; ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/set-up-rabbitmq-pacemaker-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/27/set-up-rabbitmq-pacemaker-cluster/" itemprop="url">set up rabbitmq pacemaker cluster</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-27T19:22:45+08:00">
                2020-02-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-27<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="test-steps"><a href="#test-steps" class="headerlink" title="test steps"></a>test steps</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">juju add-model ha</span><br><span class="line">juju deploy ubuntu rabbit1 --series=bionic --config hostname=rabbit1 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">juju deploy ubuntu rabbit2 --series=bionic --config hostname=rabbit2 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">juju deploy ubuntu rabbit3 --series=bionic --config hostname=rabbit3 --constraints &quot;mem=1G cores=1 root-disk=6G&quot;</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ juju status |grep ready</span><br><span class="line">rabbit1/0*  active    idle   0        10.5.0.7               ready</span><br><span class="line">rabbit2/0*  active    idle   1        10.5.0.15              ready</span><br><span class="line">rabbit3/0*  active    idle   2        10.5.0.12              ready</span><br><span class="line"></span><br><span class="line">#run the following commands in 3 units</span><br><span class="line">echo -e &quot;10.5.0.7 rabbit1\n10.5.0.15 rabbit2\n10.5.0.12 rabbit3&quot; |sudo tee -a /etc/hosts</span><br><span class="line"></span><br><span class="line">echo -e &quot;net.ipv4.ip_nonlocal_bind = 1\nnet.ipv4.ip_forward = 1&quot; |sudo tee -a /etc/sysctl.conf</span><br><span class="line">sudo sysctl -p</span><br><span class="line"></span><br><span class="line">sudo apt install chrony -y      ##https://www.server-world.info/en/note?os=Ubuntu_18.04&amp;p=ntp</span><br><span class="line">sudo systemctl restart chrony</span><br><span class="line"></span><br><span class="line">sudo apt install pacemaker corosync fence-agents resource-agents crmsh pcs -y</span><br><span class="line">sudo apt install rabbitmq-server -y</span><br><span class="line"></span><br><span class="line">HOSTNAME=$(hostname)</span><br><span class="line">cat &lt;&lt; EOF | sudo tee -a /etc/rabbitmq/rabbitmq-env.conf</span><br><span class="line">RABBITMQ_NODENAME=rabbit@$HOSTNAME</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/corosync/corosync.conf</span><br><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    cluster_name: quqicluster</span><br><span class="line">    transport: udpu</span><br><span class="line">    token: 55000</span><br><span class="line">    rrp_problem_count_timeout: 110000</span><br><span class="line">    rrp_problem_count_threshold: 30</span><br><span class="line">    token_retransmits_before_loss_const: 30</span><br><span class="line">&#125;</span><br><span class="line">nodelist &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit1</span><br><span class="line">        nodeid: 1</span><br><span class="line">    &#125;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit2</span><br><span class="line">        nodeid: 2</span><br><span class="line">    &#125;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: rabbit3</span><br><span class="line">        nodeid: 3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">&#125;</span><br><span class="line">logging &#123;</span><br><span class="line">    fileline: off</span><br><span class="line">    to_stderr: no</span><br><span class="line">    to_logfile: yes</span><br><span class="line">    logfile: /var/log/corosync.log</span><br><span class="line">    to_syslog: yes</span><br><span class="line">    syslog_facility: daemon</span><br><span class="line">    debug: on</span><br><span class="line">    timestamp: on</span><br><span class="line">    logger_subsys &#123;</span><br><span class="line">        subsys: QUORUM</span><br><span class="line">        debug: on</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">#sudo systemctl restart corosync   #use pcs instead for management</span><br><span class="line">sudo systemctl restart pcsd</span><br><span class="line">sudo systemctl enable pcsd</span><br><span class="line">#configure node authentication</span><br><span class="line">sudo passwd hacluster   #change the password to &apos;password&apos; for the user hacluster</span><br><span class="line">sudo pcs cluster auth -u hacluster -p password rabbit1 rabbit2 rabbit3</span><br><span class="line">#create the cluster</span><br><span class="line">sudo pcs cluster setup --force --name quqicluster rabbit1 rabbit2 rabbit3</span><br><span class="line">sudo pcs cluster enable --all</span><br><span class="line">sudo pcs cluster start --all</span><br><span class="line">sudo pcs status</span><br><span class="line">sudo pcs status corosync</span><br><span class="line">sudo pcs cluster status</span><br><span class="line">sudo corosync-cfgtool -s</span><br><span class="line">sudo corosync-cmapctl | grep members</span><br><span class="line">sudo pcs property set stonith-enabled=false  #Resource start-up disabled since no STONITH resources have been defined</span><br><span class="line">sudo pcs property set no-quorum-policy=ignore</span><br><span class="line">sudo crm_verify -L -V</span><br><span class="line">sudo pcs property set pe-warn-series-max=1000 pe-input-series-max=1000 pe-error-series-max=1000</span><br><span class="line">sudo pcs property set cluster-recheck-interval=5</span><br><span class="line">sudo pcs resource delete rabbitmq-clone --force</span><br><span class="line">sudo pcs resource create rabbitmq-clone ocf:heartbeat:rabbitmq-cluster --clone ordered=true interleave=true</span><br><span class="line">sudo pcs resource update rabbitmq-clone op monitor interval=30 timeout=120</span><br><span class="line">sudo pcs resource update rabbitmq-clone op start interval=0 timeout=100</span><br><span class="line">sudo pcs resource update rabbitmq-clone op stop interval=0 timeout=90</span><br><span class="line">#sudo pcs resource update rabbitmq-clone meta ordered=true interleave=true</span><br><span class="line">sudo pcs resource show rabbitmq-clone</span><br><span class="line">sudo pcs resource</span><br><span class="line">sudo pcs config show</span><br><span class="line">sudo pcs status</span><br><span class="line">sudo rabbitmqctl cluster_status</span><br><span class="line">sudo crm resource restart rabbitmq-clone</span><br><span class="line">sudo crm resource clean rabbitmq-clone</span><br><span class="line">sudo rabbitmqctl list_users</span><br><span class="line">sudo rabbitmqctl cluster_status</span><br><span class="line"></span><br><span class="line">#or use crm command instead of pcs</span><br><span class="line">wget https://raw.githubusercontent.com/ClusterLabs/crmsh/master/contrib/bash_completion.sh</span><br><span class="line">sudo cp bash_completion.sh /etc/bash_completion.d/crmsh</span><br><span class="line">source /etc/bash_completion.d/crmsh</span><br><span class="line">sudo crm configure show</span><br><span class="line">sudo crm ra list ocf |grep rabbit</span><br><span class="line">sudo crm ra meta rabbitmq-cluster</span><br><span class="line">sudo crm configure property stonith-enabled=false</span><br><span class="line">sudo crm configure primitive rabbitmq ocf:heartbeat:rabbitmq-cluster \</span><br><span class="line">  op monitor interval=30 timeout=120 \</span><br><span class="line">  op start interval=0 timeout=100 \</span><br><span class="line">  op stop interval=0 timeout=90</span><br><span class="line">sudo crm configure clone rabbitmq-clone rabbitmq \</span><br><span class="line">  meta ordered=true interleave=true</span><br><span class="line"></span><br><span class="line">#configure a VIP 10.5.0.122 by using pcs/corosync</span><br><span class="line">sudo pcs resource create rabbitvip ocf:heartbeat:IPaddr2 ip=10.5.0.122 cidr_netmask=24 nic=ens3 op monitor interval=30s</span><br><span class="line">#or configure a VIP 10.5.0.122 by using haproxy (not test)</span><br><span class="line">sudo apt install -y haproxy</span><br><span class="line">cat &lt;&lt; EOF | sudo tee -a /etc/haproxy/haproxy.cfg</span><br><span class="line">listen httpd</span><br><span class="line">    bind 10.5.0.122:5672</span><br><span class="line">    balance source</span><br><span class="line">    option tcpka</span><br><span class="line">    option httpchk</span><br><span class="line">    option tcplog</span><br><span class="line">    server juju-3f992e-ha-0 10.5.0.12:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">    server juju-3f992e-ha-1 10.5.0.7:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">    server juju-3f992e-ha-2 10.5.0.10:5672 check inter 2000 rise 2 fall 5</span><br><span class="line">EOF</span><br><span class="line">sudo pcs resource create lb-haproxy systemd:haproxy --clone</span><br><span class="line">sudo pcs constraint colocation add lb-haproxy-clone with vip   #make haproxy and vip in the same nodes</span><br><span class="line">sudo pcs constraint order start vip then lb-haproxy-clone kind=Optional  #make first start vip before starting haproxy</span><br><span class="line">sudo pcs resource</span><br></pre></td></tr></table></figure>
<h2 id="standby-test"><a href="#standby-test" class="headerlink" title="standby test"></a>standby test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@rabbit1:~$ sudo crm node standby rabbit1</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit1:~$ sudo crm status</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: rabbit1 (version 1.1.18-2b07d5c5a9) - partition with quorum</span><br><span class="line">Last updated: Fri Feb 28 03:00:32 2020</span><br><span class="line">Last change: Fri Feb 28 02:58:53 2020 by root via crm_attribute on rabbit1</span><br><span class="line">3 nodes configured</span><br><span class="line">4 resources configured</span><br><span class="line">Node rabbit1: standby</span><br><span class="line">Online: [ rabbit2 rabbit3 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> Clone Set: rabbitmq-clone-clone [rabbitmq-clone]</span><br><span class="line">     Started: [ rabbit2 rabbit3 ]</span><br><span class="line">     Stopped: [ rabbit1 ]</span><br><span class="line"> rabbitvip      (ocf::heartbeat:IPaddr2):       Started rabbit2</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit2:~$ sudo rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbit2</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbit2]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbit2]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit@rabbit2&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;rabbit@rabbit2,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="some-logs"><a href="#some-logs" class="headerlink" title="some logs"></a>some logs</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@rabbit1:~$ sudo rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@rabbit1</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@rabbit1]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[rabbit@rabbit1]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit@rabbit1&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;rabbit@rabbit1,[]&#125;]&#125;]</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit1:~$ sudo pcs resource show rabbitmq-clone</span><br><span class="line"> Resource: rabbitmq-clone (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">  Operations: monitor interval=10 timeout=40 (rabbitmq-clone-monitor-interval-10)</span><br><span class="line">              start interval=0s timeout=100 (rabbitmq-clone-start-interval-0s)</span><br><span class="line">              stop interval=0s timeout=90 (rabbitmq-clone-stop-interval-0s)</span><br><span class="line">ubuntu@rabbit1:~$</span><br><span class="line">ubuntu@rabbit1:~$ sudo crm status</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: rabbit1 (version 1.1.18-2b07d5c5a9) - partition with quorum</span><br><span class="line">Last updated: Fri Feb 28 02:52:34 2020</span><br><span class="line">Last change: Fri Feb 28 02:49:43 2020 by root via cibadmin on rabbit1</span><br><span class="line"></span><br><span class="line">3 nodes configured</span><br><span class="line">4 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ rabbit1 rabbit2 rabbit3 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> Clone Set: rabbitmq-clone-clone [rabbitmq-clone]</span><br><span class="line">     Started: [ rabbit1 rabbit2 rabbit3 ]</span><br><span class="line"> rabbitvip      (ocf::heartbeat:IPaddr2):       Started rabbit1</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster auth -u hacluster -p password rabbit1 rabbit2 rabbit3</span><br><span class="line">rabbit3: Authorized</span><br><span class="line">rabbit2: Authorized</span><br><span class="line">rabbit1: Authorized</span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster setup --force --name quqicluster rabbit1 rabbit2 rabbit3</span><br><span class="line">Destroying cluster on nodes: rabbit1, rabbit2, rabbit3...</span><br><span class="line">rabbit1: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit3: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit2: Stopping Cluster (pacemaker)...</span><br><span class="line">rabbit3: Successfully destroyed cluster</span><br><span class="line">rabbit1: Successfully destroyed cluster</span><br><span class="line">rabbit2: Successfully destroyed cluster</span><br><span class="line"></span><br><span class="line">Sending &apos;pacemaker_remote authkey&apos; to &apos;rabbit1&apos;, &apos;rabbit2&apos;, &apos;rabbit3&apos;</span><br><span class="line">rabbit3: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">rabbit1: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">rabbit2: successful distribution of the file &apos;pacemaker_remote authkey&apos;</span><br><span class="line">Sending cluster config files to the nodes...</span><br><span class="line">rabbit1: Succeeded</span><br><span class="line">rabbit2: Succeeded</span><br><span class="line">rabbit3: Succeeded</span><br><span class="line"></span><br><span class="line">Synchronizing pcsd certificates on nodes rabbit1, rabbit2, rabbit3...</span><br><span class="line">rabbit3: Success</span><br><span class="line">rabbit2: Success</span><br><span class="line">rabbit1: Success</span><br><span class="line">Restarting pcsd on the nodes in order to reload the certificates...</span><br><span class="line">rabbit3: Success</span><br><span class="line">rabbit1: Success</span><br><span class="line">rabbit2: Success</span><br><span class="line"></span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster enable --all</span><br><span class="line">rabbit1: Cluster Enabled</span><br><span class="line">rabbit2: Cluster Enabled</span><br><span class="line">rabbit3: Cluster Enabled</span><br><span class="line">ubuntu@rabbit3:~$ sudo pcs cluster start --all</span><br><span class="line">rabbit1: Starting Cluster...</span><br><span class="line">rabbit2: Starting Cluster...</span><br><span class="line">rabbit3: Starting Cluster...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ubuntu@juju-3f992e-ha-2:~$ sudo pcs resource show rabbitmq-clone</span><br><span class="line"> Clone: rabbitmq-clone</span><br><span class="line">  Meta Attrs: ordered=true interleave=true</span><br><span class="line">  Resource: rabbitmq (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">   Operations: monitor interval=30 timeout=120 (rabbitmq-monitor-30)</span><br><span class="line">               start interval=0 timeout=100 (rabbitmq-start-0)</span><br><span class="line">               stop interval=0 timeout=90 (rabbitmq-stop-0)</span><br><span class="line"></span><br><span class="line"> Clone: rabbitmq-clone</span><br><span class="line">  Meta Attrs: interleave=true ordered=true</span><br><span class="line">  Resource: rabbitmq (class=ocf provider=heartbeat type=rabbitmq-cluster)</span><br><span class="line">   Attributes: set_policy=&quot;ha-all ^(?!amq\.).* &#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&quot;</span><br><span class="line">   Operations: start interval=0s timeout=100 (rabbitmq-start-interval-0s)</span><br><span class="line">               stop interval=0s timeout=90 (rabbitmq-stop-interval-0s)</span><br><span class="line">               monitor interval=30 timeout=120 (rabbitmq-monitor-interval-30)</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://www.andylouse.net/openstack-queens-cluster-mode-system-optimize-and-configuration" target="_blank" rel="external">https://www.andylouse.net/openstack-queens-cluster-mode-system-optimize-and-configuration</a><br>[2] <a href="https://www.centos.bz/2019/06/linux%E4%B8%8B%E6%90%AD%E5%BB%BAhaproxypacemakercorosync%E9%9B%86%E7%BE%A4/" target="_blank" rel="external">https://www.centos.bz/2019/06/linux%E4%B8%8B%E6%90%AD%E5%BB%BAhaproxypacemakercorosync%E9%9B%86%E7%BE%A4/</a><br>[3] <a href="https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html" target="_blank" rel="external">https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/How-to-set-up-systemd-resolved-dnssec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/How-to-set-up-systemd-resolved-dnssec/" itemprop="url">How to set up systemd-resolved + dnssec</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-25T11:21:11+08:00">
                2020-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-25<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="Set-up-test-env"><a href="#Set-up-test-env" class="headerlink" title="Set up test env"></a>Set up test env</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#first let us know 8.8.8.8 supports dnssec, while 114.114.114.114 doesn&apos;t support</span><br><span class="line">dig paypal.com +dnssec @8.8.8.8 |grep RRSIG</span><br><span class="line">dig paypal.com +dnssec @114.114.114.114 |grep RRSIG</span><br><span class="line"></span><br><span class="line">#set up dnsmasq as upstream dns server</span><br><span class="line">IFACE=dummy0</span><br><span class="line">SUBNET=10.0.0</span><br><span class="line">sudo ip link add $IFACE type dummy</span><br><span class="line">sudo ifconfig $IFACE $&#123;SUBNET&#125;.1/24</span><br><span class="line">#https://www.cnblogs.com/taoyuxuan/p/11205491.html</span><br><span class="line">#sudo dnsmasq -h -R -d -C /dev/null -z -i $IFACE -I lo --host-record=test.test,$&#123;SUBNET&#125;.1 -2 $IFACE &amp;</span><br><span class="line">#sudo dnsmasq -h -R -d -C /dev/null -z -i $IFACE -I lo -S /test/ --host-record=test.test,$&#123;SUBNET&#125;.1 -2 $IFACE &amp;</span><br><span class="line"></span><br><span class="line">#sudo dnsmasq --no-hosts --no-resolv --no-daemon --no-dhcp-interface==$IFACE --bind-interfaces --interface=$IFACE \</span><br><span class="line">    --except-interface=lo --server=/test/ --host-record=test.test,$&#123;SUBNET&#125;.1 --conf-file=/dev/null --log-queries &amp;</span><br><span class="line">sudo dnsmasq --no-hosts --no-resolv --no-daemon --no-dhcp-interface==$IFACE --bind-interfaces --interface=$IFACE \</span><br><span class="line">    --except-interface=lo --server=/test/10.0.0.1 --host-record=test.test,$&#123;SUBNET&#125;.1 --log-queries \</span><br><span class="line">    --dnssec --conf-file=/usr/share/dnsmasq-base/trust-anchors.conf --dnssec-check-unsigned --dnssec-debug --server=8.8.8.8 &amp;</span><br><span class="line">dig paypal.com +dnssec @10.0.0.1 |grep RRSIG</span><br><span class="line"></span><br><span class="line">#test dns server with dig</span><br><span class="line">ubuntu@bastion:~$ dig -t a test.test @10.0.0.1 | grep EDNS</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">ubuntu@bastion:~$ dig -t aaaa test.test @10.0.0.1 | grep EDNS</span><br><span class="line"># again, should return &quot;; EDNS ...&quot; but doesn&apos;t</span><br><span class="line"></span><br><span class="line">#configure systemd-resolved to look at only 10.0.0.1</span><br><span class="line">ubuntu@bastion:~$ grep -Ev &apos;#|^$&apos; /etc/systemd/resolved.conf</span><br><span class="line">[Resolve]</span><br><span class="line">DNS=10.0.0.1</span><br><span class="line">DNSSEC=yes</span><br><span class="line">Cache=no</span><br><span class="line">ubuntu@bastion:~$ grep -Ev &apos;#|^$&apos;  /etc/resolv.conf</span><br><span class="line">nameserver 127.0.0.53</span><br><span class="line">options edns0</span><br><span class="line"></span><br><span class="line">#debug with systemd-resolved</span><br><span class="line">sudo systemctl disable systemd-resolved   #seems systemd-resolved always restart if not disable it as well</span><br><span class="line">sudo systemctl stop systemd-resolved</span><br><span class="line">sudo SYSTEMD_LOG_LEVEL=debug script -c /lib/systemd/systemd-resolved /tmp/debug.txt</span><br><span class="line">systemd-resolve --status --no-pager |egrep &apos;DNSSEC|DNS Servers&apos;</span><br><span class="line">#repeat the following 3 lines to test every time - ./src/resolve/resolved-dns-server.c</span><br><span class="line">sudo systemd-resolve --flush-caches; sudo systemd-resolve --reset-server-features; systemd-resolve test.test -t A</span><br><span class="line">sudo systemd-resolve --flush-caches; sudo systemd-resolve --reset-server-features; systemd-resolve paypal.com -t A</span><br><span class="line">systemd-resolve test.test -t A   #don&apos;t reset, try directly</span><br><span class="line">systemd-resolve paypal.com -t A</span><br><span class="line">systemd-resolve example.com ubuntu.com us.archive.ubuntu.com packages.icinga.com mirror.steadfast.net archive.ubuntu.com ppa.launchpad.net private-ppa.launchpad.net sigok.verteiltesysteme.net sigfail.verteiltesysteme.net verisign.com www.verisign.com</span><br></pre></td></tr></table></figure>
<h2 id="一些术语"><a href="#一些术语" class="headerlink" title="一些术语"></a>一些术语</h2><ul>
<li>LLMNR: 当dns服务不可用时, 支持使用组播dns协议(mDNS)继续在子网内局部查询dns直至网络连接还原为止.</li>
<li>Knot-DNS: 类似于dnsmasq, bind9的dns server</li>
<li>EDNS:允许将DNS消息大小从标准的512字节扩展（当UDP用作传输协议时），而无需切换到TCP. 它能提升访问CDN的性能，因为：标准DNS协议只能传递域名参数查IP,　而不能传递域名+用户参数来源查IP．查询下游的CDN, DNS服务器应该是根据用户的来源查询,而不是将上游DNS服务做为来源查询.由于国内的运营商之间互联的带宽是很低的,　所以造成访问速度超慢.</li>
<li>EDNS0:可以将UDP包从512字节扩展到4096字节从而可以容纳DNSEC包, systemd-resolved通过/etc/resovled.conf里的’options edns0’通知dns server可以edns0, server再回的时候会将其+1, 所以: 雖然是EDNS0 封包，可是不代表這是 DNSSEC 封包，在EDNS0 中有一個 bit: DO 被設定為 1 的時候，才代表這是 DNSSEC 封包 (通过: dig +dnssec example.com ns |grep EDNS  命令可以查看)</li>
</ul>
<h2 id="Some-bugs"><a href="#Some-bugs" class="headerlink" title="Some bugs"></a>Some bugs</h2><p>1, <a href="https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1857639" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1857639</a><br>upstream dns能力被检测正确让dnssec工作(现在一旦突然检查错了, resovle就停止work了), 或者允许disable能力检查<br><a href="https://github.com/systemd/systemd/issues/6490" target="_blank" rel="external">https://github.com/systemd/systemd/issues/6490</a><br><a href="https://github.com/systemd/systemd/issues/14435" target="_blank" rel="external">https://github.com/systemd/systemd/issues/14435</a><br><a href="https://github.com/systemd/systemd/pull/8849" target="_blank" rel="external">https://github.com/systemd/systemd/pull/8849</a><br>a, 第一种解决方案<br> resolve不能看到timeout or error了就降级(tcp-&gt;dns over tls -&gt; edns0)声称不支持某个特性, 它的特性应该独立于实际查询<br><a href="https://github.com/systemd/systemd/issues/9384" target="_blank" rel="external">https://github.com/systemd/systemd/issues/9384</a><br>b, 允许disable dnsec能力检查<br><a href="https://github.com/systemd/systemd/issues/14435" target="_blank" rel="external">https://github.com/systemd/systemd/issues/14435</a><br>c, 从resolved中移除dnssec</p>
<p>如有些咖啡厅等公共网络不支持ends0查询，会响应domain not found, 即收到＇NXDOMAIN when queried with EDNS0＇消息时(the query is with EDNS0 enabled and D0 bit set to zero)需要继续只根据EDNS0继续重试<br><a href="https://github.com/systemd/systemd/pull/8608" target="_blank" rel="external">https://github.com/systemd/systemd/pull/8608</a><br><a href="https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1727237" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1727237</a><br><a href="https://github.com/systemd/systemd/commit/7abcaa93ab13b1a7b11d50fcd43938de44687970" target="_blank" rel="external">https://github.com/systemd/systemd/commit/7abcaa93ab13b1a7b11d50fcd43938de44687970</a>  - 代码<br>journalctl -b -u systemd-resolve | grep DVE-2018  - 确诊<br>Workaround:<br>sudo systemctl disable systemd-resolved.service<br>sudo service systemd-resolved stop<br>sudo rm /etc/resolv.conf<br>sudo nano /etc/NetworkManager/NetworkManager.conf<br> then add “dns=default” under [main]<br>sudo service network-manager restart</p>
<p>上面的降级（resolved-Mitigate-DVE-2018-0001-by-retrying-NXDOMAIN-with.patch）应该只在DNSSEC=allow-downgrade or DNSSEC=no时运行．在真实世界中，NetworkManager’s在无法降级时会告诉用户关掉dnssec<br><a href="https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1796501" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1796501</a></p>
<p>2, <a href="https://github.com/systemd/systemd/pull/9264/commits/844c58fb27b4420f5f8b07070fe2319af6537ae3" target="_blank" rel="external">https://github.com/systemd/systemd/pull/9264/commits/844c58fb27b4420f5f8b07070fe2319af6537ae3</a><br>systemd-resolved只是一个stub resovler, 它只是转发dns请求到upstream dns server并等待请求(等待时间为RTT)，它没有考虑到上游递归dns服务器(interative resolver, eg: dnsmasq)的query timeout(authoritative server是用内存来存储dns记录所以它快，但也不是所有的都快），这样systemd-resolved会经常错误的降级（Therefore it often mistakenly degrades the feature set of its　upstream resolvers if it takes them longer than usual to answer a query），特别当DNSSEC=yes不充许降级时就更严重，所以systemd-resolved应该使用RTT+上游的查询时间，而不是只用RTT (DNS_TIMEOUT_MAX_USEC=DNS_SERVER_FEATURE_RETRY_ATTEMPTS * DNS_TIMEOUT_MAX_USEC = 15s），当然，这也不是解决根本问题，但可以缓解．</p>
<p>3, <a href="https://github.com/systemd/systemd/commit/7abcaa93ab13b1a7b11d50fcd43938de44687970" target="_blank" rel="external">https://github.com/systemd/systemd/commit/7abcaa93ab13b1a7b11d50fcd43938de44687970</a><br> <a href="https://github.com/systemd/systemd/issues/11171" target="_blank" rel="external">https://github.com/systemd/systemd/issues/11171</a><br><a href="https://github.com/systemd/systemd/issues/4315" target="_blank" rel="external">https://github.com/systemd/systemd/issues/4315</a> - <a href="https://github.com/poettering/systemd/commit/fc50d3f20d56862520635c3703fd90725b288afb" target="_blank" rel="external">https://github.com/poettering/systemd/commit/fc50d3f20d56862520635c3703fd90725b288afb</a><br><a href="https://github.com/systemd/systemd/pull/8608" target="_blank" rel="external">https://github.com/systemd/systemd/pull/8608</a><br><a href="https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1727237" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1727237</a><br>这个commit (7abcaa93ab - debian/patches/resolved-Mitigate-DVE-2018-0001-by-retrying-NXDOMAIN-with.patch)可以解决上面关于降级的问题，但是它又引入了回归bug, 没DNSSEC=yes时没有做安全检查 (为DNSSEC=yes时不从UDP+ends0(DNS_SERVER_FEATURE_LEVEL_EDNS0)降级互UDP(DNS_SERVER_FEATURE_LEVEL_UDP)但upstream还未接受patch，故先在debian/patches/resolved_disable-connection-downgrade-when-DNSSEC-yes.patch</p>
<p>4, <a href="https://github.com/dns-violations/dns-violations/issues/62" target="_blank" rel="external">https://github.com/dns-violations/dns-violations/issues/62</a><br><a href="https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1785383" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1785383</a><br>dnsmasq 2.79当返回空时省略了EDNS0 OPT记录 (例如访问无AAAA记录时 - patch - 1682d15a744880b0398af75eadf68fe66128af78)) , systemd-resolved能hang (但只是使用了dnsmasq的router会如此)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/16/利用squid的tcp-outgoing-address特性选择第二块网卡出流量-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/16/利用squid的tcp-outgoing-address特性选择第二块网卡出流量-1/" itemprop="url">利用squid的tcp_outgoing_address特性选择第二块网卡出流量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-16T23:23:50+08:00">
                2020-02-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-12<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>有两块网卡192.168.99.135与192.168.8.101, 对于chrome的某些tab想灵活地类似于ForceBindIp[1]某时走192.168.8.101, 不想使用修改路由的全局方式, 怎么办呢? 那需要在本机构建一个squid http代理服务器, 然后用到squid的tcp_outgoing_address特性, 但是tcp_outgoing_address这个特性做测试时可没那么容易成功的, 最终这个最小化的squid.conf如下, 底层原理可参照[2]:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install squid -y</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/squid/squid.conf</span><br><span class="line">http_port 192.168.99.135:3128</span><br><span class="line">dns_v4_first on</span><br><span class="line">#dns_nameservers 192.168.8.1</span><br><span class="line">acl gfw myip 192.168.8.101</span><br><span class="line">tcp_outgoing_address 192.168.8.101 gfw</span><br><span class="line">acl localip src 192.168.99.135</span><br><span class="line">http_access allow localip</span><br><span class="line">http_access deny all</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl reload squid</span><br><span class="line">sudo systemctl enable squid</span><br></pre></td></tr></table></figure>
<p>如果是ssh呢，这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">sudo ip route add default via 192.168.8.1 dev wlp4s0 table ssh</span><br><span class="line">sudo ip rule add from 192.168.8.101/24 table ssh</span><br><span class="line">ssh ubuntu@xxx -b 192.168.8.101</span><br></pre></td></tr></table></figure></p>
<p>[1] <a href="https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem" target="_blank" rel="external">https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem</a><br>[2] <a href="http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/" target="_blank" rel="external">http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/利用squid的tcp-outgoing-address特性选择第二块网卡出流量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/12/利用squid的tcp-outgoing-address特性选择第二块网卡出流量/" itemprop="url">利用squid的tcp_outgoing_address特性选择第二块网卡出流量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-12T14:40:17+08:00">
                2020-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-02-12<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>有两块网卡192.168.99.135与192.168.8.101, 对于chrome的某些tab想灵活地类似于ForceBindIp[1]某时走192.168.8.101, 不想使用修改路由的全局方式, 怎么办呢? 那需要在本机构建一个squid http代理服务器, 然后用到squid的tcp_outgoing_address特性, 但是tcp_outgoing_address这个特性做测试时可没那么容易成功的, 最终这个最小化的squid.conf如下, 底层原理可参照[2]:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install squid -y</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/squid/squid.conf</span><br><span class="line">#sudo rm -rf /dev/shm/squid*</span><br><span class="line">#sudo mkdir -p /var/log/squid &amp;&amp; sudo chown -R proxy:proxy /var/log/squid/</span><br><span class="line">http_port 192.168.99.135:3128</span><br><span class="line">dns_v4_first on</span><br><span class="line">dns_nameservers 192.168.8.1</span><br><span class="line">acl gfw myip 192.168.99.135</span><br><span class="line">tcp_outgoing_address 192.168.8.101 gfw</span><br><span class="line">#http_access allow all</span><br><span class="line">acl localip src 192.168.99.135</span><br><span class="line">http_access allow localip</span><br><span class="line">http_access deny all</span><br><span class="line">cache_access_log /var/log/squid/access.log</span><br><span class="line">cache_log /var/log/squid/cache.log</span><br><span class="line">cache_store_log none</span><br><span class="line">logfile_rotate 7</span><br><span class="line">coredump_dir /var/cache/squid</span><br><span class="line">#coredump_dir /var/log/squid/cache</span><br><span class="line">max_filedescriptors 3200</span><br><span class="line">#prevent squid from adding http headers to cause some websites to detect proxy and prohibit access</span><br><span class="line">via off</span><br><span class="line">forwarded_for delete</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl reload squid</span><br><span class="line">sudo systemctl enable squid</span><br><span class="line"></span><br><span class="line">#Ipc::Mem::Segment::create failed to shm_open(/squid-cf__metadata.shm): (17) File exists</span><br><span class="line">sudo rm -rf /dev/shm/squid-cf__*</span><br><span class="line">sudo mkdir -p /var/log/squid &amp;&amp; sudo chown -R proxy:proxy /var/log/squid/</span><br><span class="line">sudo mkdir -p /var/cache/squid &amp;&amp; sudo chown -R proxy:proxy /var/cache/squid/</span><br><span class="line"></span><br><span class="line">#add the following lines in systemd file</span><br><span class="line">ExecStartPre=mkdir -p /var/log/squid</span><br><span class="line">ExecStartPre=chown -R proxy:proxy /var/log/squid/</span><br><span class="line">ExecStartPre=mkdir -p /var/cache/squid</span><br><span class="line">ExecStartPre=chown -R proxy:proxy /var/cache/squid/</span><br><span class="line"></span><br><span class="line">NOTE: 20200626更新</span><br><span class="line">添加了policy router之后也可以使用ssh</span><br><span class="line">ssh ubuntu@xxx -b 192.168.8.101 -D192.168.99.135:3128 -fN -o ServerAliveInterval=30 -o ServerAliveCountMax=1</span><br></pre></td></tr></table></figure>
<p>如果是ssh呢，这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">GW=$(nmcli d show wlp4s0 |grep -i &apos;ip4.gateway&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">GW=$(ip route list table main |grep wlp4s0 |grep default |awk &apos;&#123;print $3&#125;&apos;)</span><br><span class="line">sudo ip route add default via $GW dev wlp4s0 table ssh</span><br><span class="line">sudo ip route add default via 172.20.10.1 dev wlp4s0 table ssh</span><br><span class="line">sudo ip rule add from 172.20.10.0/24 table ssh</span><br><span class="line">sudo ip rule add from 192.168.8.0/24 table ssh</span><br><span class="line">ip route list table ssh</span><br><span class="line">ip rule list</span><br><span class="line">ssh ubuntu@xxx -b 172.20.10.3 -v</span><br><span class="line">ssh ubuntu@xxx -b 192.168.8.101 -v</span><br><span class="line"></span><br><span class="line"># NOTE: the following doesn&apos;t work, need to fix</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/NetworkManager/dispatcher.d/008_policy_route_4g&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line">echo &quot;the interface $1 is $2&quot; 1&gt;&amp;2</span><br><span class="line"># Modify policy route after the connection is made</span><br><span class="line">if [ $1 == &quot;wlp4s0&quot; ] &amp;&amp; [ $2 == &quot;up&quot; ]; then</span><br><span class="line">    #GW=$(nmcli d show wlp4s0 |grep -i &apos;ip4.gateway&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">    GW=$(ip route list table main |grep wlp4s0 |grep default |awk &apos;&#123;print $3&#125;&apos;)</span><br><span class="line">    ip route add default via $GW dev wlp4s0 table ssh</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">chmod root:root /etc/NetworkManager/dispatcher.d/008_policy_route_4g</span><br><span class="line">chmod 755 /etc/NetworkManager/dispatcher.d/008_policy_route_4g</span><br></pre></td></tr></table></figure></p>
<p><strong>题外话</strong><br>关于如何持久化上面的policy route确是一个大课题，至今未解决：<br>１，　先是用这个不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:~$ cat /etc/network/if-up.d/wlp4s0-routes</span><br><span class="line">#!/bin/sh</span><br><span class="line">set -e</span><br><span class="line">if [ &quot;$IFACE&quot; != &apos;wlp4s0&apos; ]; then</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$METHOD&quot; = loopback ]; then</span><br><span class="line">    exit 0</span><br><span class="line">elif [ &quot;$METHOD&quot; = dhcp ]; then</span><br><span class="line">    IF_ADDRESS=&quot;$(echo &quot;$IP4_ADDRESS_0&quot; | cut -d&apos;/&apos; -f1)&quot;</span><br><span class="line">    IF_GATEWAY=&quot;$(echo &quot;$IP4_ADDRESS_0&quot; | cut -d&apos; &apos; -f2)&quot;</span><br><span class="line">elif [ &quot;$METHOD&quot; = static]; then</span><br><span class="line">    if [ ! &quot;$GATEWAY&quot; ]; then</span><br><span class="line">        IF_GATEWAY=&quot;$(echo &quot;$IF_ADDRESS&quot; | cut -d. -f1-3).1&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">ip route flush table &quot;$IFACE&quot;</span><br><span class="line">ip route add default via &quot;$IF_GATEWAY&quot; table &quot;$IFACE&quot;</span><br><span class="line">ip rule del lookup &quot;$IFACE&quot; || true</span><br><span class="line">ip rule add from &quot;$IF_ADDRESS&quot; lookup &quot;$IFACE&quot;</span><br></pre></td></tr></table></figure></p>
<p>2, 再用这个还不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:~$ cat /etc/network/if-up.d/wlp4s0-routes</span><br><span class="line">if [ &quot;$IFACE&quot; == &quot;wlp4s0&quot; ]; then</span><br><span class="line">  ip rule add from 172.20.10.0/24 table ssh</span><br><span class="line">  ip rule add from 192.168.8.0/24 table ssh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>3, 这个（/etc/NetworkManager/system-connections/huawei4G）里也不能持久化policy routing<br>4, 改用netplan理论上应该可以，但实际测试又报别的错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/netplan/01-network-manager-all.yaml /etc/netplan/01-network-manager-all.yaml_bak</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/netplan/01-network-manager-all.yaml</span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd # change this from &apos;NetworkManager&apos; if it&apos;s set.</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      #dhcp6: no</span><br><span class="line">      #accept-ra: no</span><br><span class="line">      #gateway6: 2a01:xxx:xxxx:xx::x</span><br><span class="line">      #addresses: [81.94.xx.xx/28, &quot;2a01:xxx:xxxx:xx::xx/64&quot;]</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.99.135/24]</span><br><span class="line">      gateway4: 192.168.99.1</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [192.168.99.1]</span><br><span class="line">    wlp4s0:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.8.101/24]</span><br><span class="line">      gateway4:    # unset, since we configure the route below</span><br><span class="line">      routes:</span><br><span class="line">        - to: 91.189.0.0/16</span><br><span class="line">          via: 192.168.8.1</span><br><span class="line">          metric: 600</span><br><span class="line">          #table: 9             #echo &quot;9 ssh&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">      routing-policy:</span><br><span class="line">        - from: 172.20.10.0/24</span><br><span class="line">          table: 9</span><br><span class="line">        - from: 192.168.8.101</span><br><span class="line">          table: 9</span><br><span class="line">EOF</span><br><span class="line">sudo netplan try   # it will rolling back your last configurations in 120 seconds</span><br><span class="line">sudo systemctl stop netplan</span><br><span class="line">sudo netplan -d apply</span><br><span class="line">sudo systemctl restart network-manager</span><br><span class="line">#sudo systemctl restart systemd-networkd  #for ubuntu server version</span><br><span class="line"></span><br><span class="line">hua@t440p:~$ sudo netplan apply</span><br><span class="line">bind: Address already in use</span><br><span class="line">netplan: fatal error: cannot bind to port 2983, is another daemon running?, exiting</span><br><span class="line"></span><br><span class="line">netplan的方法不通，这个网页( https://blogs.gnome.org/thaller/category/networkmanager/ ) network-manager 1.18开始技术policy route (使用方法：http://devemmeff.blogspot.com/2016/02/howto-policy-based-routing-using.html）, 但是照下列方法从源码编译network-manager遇到太多太多包依赖问题了，至今未解决</span><br><span class="line">git clone https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git &amp;&amp; cd NetworkManager</span><br><span class="line">git checkout -b 1.18.4 1.18.4</span><br><span class="line">sudo apt install gtk-doc-tools build-essential automake</span><br><span class="line">sudo apt install wireless-tools libiw-dev libdbus-glib-1-dev libgudev-1.0-dev uuid-dev uuid libnss-db libnss3-dev ppp-dev libjansson-dev libcurl4-openssl-dev libndp-dev</span><br><span class="line">sudo apt install gtk-doc-tools libglib2.0-dev libudev-dev uuid-dev libnss3-dev ppp-dev libjansson-dev libcurl4-nss-dev libndp-dev libreadline-dev intltool</span><br><span class="line">sudo apt install libnm-dev libnm-util-dev</span><br><span class="line">./autogen.sh --prefix=/usr --sysconfdir=/etc --localstatedir=/var --enable-introspection=no --disable-ppp --disable-json-validation --enable-gtk-doc=no</span><br><span class="line"></span><br><span class="line">最后通过rc.local解决：</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/rc.local&apos; &lt;&lt;EOF</span><br><span class="line">#!/bin/sh -e</span><br><span class="line">ip rule del from 172.20.10.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule del from 192.168.8.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule del to &lt;IP&gt; table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have this line</span><br><span class="line">ip rule add from 172.20.10.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule add from 192.168.8.0/24 table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">ip rule add to &lt;IP&gt; table ssh &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have it</span><br><span class="line">ip route add default via 192.168.8.1 dev wlan0 table ssh &gt;/dev/null  2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1 #must have it</span><br><span class="line">exit 0</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart rc.local</span><br><span class="line">sudo systemctl enable rc.local</span><br><span class="line">注意:上面del与add之间必须使用sleep 2,因为都是异步执行的.</span><br><span class="line">然后可以使用下列命令验证:</span><br><span class="line">sudo tcpdump -ni wlan0 host &lt;IP&gt;</span><br></pre></td></tr></table></figure>
<p>5, 放弃先</p>
<p>[1] <a href="https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem" target="_blank" rel="external">https://stackoverflow.com/questions/43140360/how-can-i-force-outgoing-ip-for-specific-applications-forcebindip-doesnt-seem</a><br>[2] <a href="http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/" target="_blank" rel="external">http://xiaorui.cc/2015/04/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E4%B9%8Bpython%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%87%BA%E5%8F%A3ip/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/13/Debian-Customer-PPA-RFC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/13/Debian-Customer-PPA-RFC/" itemprop="url">Debian Customer PPA RFC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-13T16:42:43+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-01-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>Precondition<br>a, sudo apt install gnupg pbuilder ubuntu-dev-tools bzr-builddeb apt-file debhelper dh-systemd openstack-pkg-tools</p>
<p>b, GPG key<br>scp -r /home/hua/.gnupg ubuntu@192.168.100.3:~/<br>gpg –list-public           # or gpg –gen-key<br>export GPGKEY=XXXXXX<br>gpg –send-keys –keyserver keyserver.ubuntu.com $GPGKEY</p>
<p>c, SSH key<br>ssh-keygen -t rsa<br><a href="https://launchpad.net/~/+editsshkeys" target="_blank" rel="external">https://launchpad.net/~/+editsshkeys</a></p>
<p>d, Bazaar<br>bzr whoami “<email>“<br>bzr launchpad-login <lauchpad_id></lauchpad_id></email></p>
<p>Get the source code<br>a, Add related ppa to /etc/apt/source.list<br>   ppa info can be found from lanchpad <a href="https://launchpad.net/~zhhuabj/+archivesubscriptions" target="_blank" rel="external">https://launchpad.net/~zhhuabj/+archivesubscriptions</a></p>
<p>b, Import the public key and update the repository<br>   sudo apt-key adv –keyserver keyserver.ubuntu.com –recv-keys <public-key><br>   sudo apt-get update</public-key></p>
<p>c, Get the source code (pls don’t add other repository when executing this step)</p>
<p>   #Get package from the ppa<br>   sudo apt-get source <package-name>    </package-name></p>
<p>   #Get package from official repo</p>
<pre><code> sudo pip install --upgrade lazr.restfulclient

#pull-lp-source cinder trusty
</code></pre><p>   #debcheckout –git-track=’*’ nova   #for openstack sru</p>
<p>d, dget *.dsc</p>
<p>Example:</p>
<p>sudo add-apt-repository cloud-archive:kilo</p>
<p>#uncomment deb-src in /etc/apt/sources.list.d/cloudarchive-kilo.list<br>$ cat /etc/apt/sources.list.d/cloudarchive-kilo.list<br>deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> trusty-updates/kilo main<br>deb-src <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> trusty-updates/kilo main</p>
<p>sudo rm /var/lib/apt/lists/* -vf &amp;&amp; sudo apt-get update</p>
<p>rmadison libvirt</p>
<p>sudo apt-cache madison nova-compute  #See all versions<br>sudo apt-get source nova=1:2015.1.2-0ubuntu2~cloud</p>
<p>其中get-get source相当于:</p>
<p>#<a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+packages?field.name_filter=qemu&amp;field.status_filter=superseded&amp;field.series_filter=" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+packages?field.name_filter=qemu&amp;field.status_filter=superseded&amp;field.series_filter=</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</a><br>wget <a href="https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg.orig.tar.xz" target="_blank" rel="external">https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg.orig.tar.xz</a><br>dpkg-source -x qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</p>
<p>Patch package<br>1, quilt configuration<br>   a, sudo apt-get install quilt devscripts dh-make<br>   b, Export to bash env<br>      export QUILT_PATCHES=debian/patches<br>      export QUILT_NO_DIFF_INDEX=1<br>      export QUILT_NO_DIFF_TIMESTAMPS=1<br>      export QUILT_REFRESH_ARGS=”-p ab”<br>      export QUILT_PATCHES=debian/patches<br>      export QUILT_REFRESH_ARGS=”-p ab –no-timestamps –no-index”</p>
<p>#git format-patch -1 2150d5d8e17323bc9fce11903da3afffda211d26<br>quilt import /bak/openstack/nova/0001-pci-eliminate-DB-lookup-PCI-requests-during-claim.patch</p>
<p>   c, Creating a new patch.<br>      quilt new test.diff<br>      quilt add neutron/agent/linux/ovs_lib.py<br>      quilt refresh<br>      quilt rename -P test.diff test2.diff<br>      cat debian/patches/test.diff<br>      quilt pop -a</p>
<p>   d, For the exsiting patch,<br>      Put the patch into ‘./debian/patches’ directory<br>      Pppend it into ‘./debian/patch/series’ file<br>      Use ‘quilt push -a’ command to push all existing patches onto the source tree.<br>      quilt refresh</p>
<p>3, changelog<br>   dch -i #can be changed later by dch -e<br>   cat debian/changelog<br>   cat debian/copyright<br>   cat debian/rules<br>   cat debian/control</p>
<p>   ppa name format:  <customername>[-<openstack-version>|-<ubuntu-release>]<br>   changelog format: <upstream-version>hf<lp-bug-number>v<date>.<buildnum><br>   dch -b -Dprecise-updates -v1:2014.1.5-0ubuntu1.2hf123456v20150902.0<br>   nova (1:2014.1.5-0ubuntu1.2hf123456v20150902.0) precise-update; urgency=low</buildnum></date></lp-bug-number></upstream-version></ubuntu-release></openstack-version></customername></p>
<pre><code>* [HOTFIX] Fixes some catastrophic failure (LP: #123456)
  - blah blah blah
  - d/p/my-awesome-backport.patch
</code></pre><p>4, Edit ppa’s dependancy in ‘Edit PPA dependencies’ field.<br>   Eg:<br>   for Juno,    ~ubuntu-cloud-archive/ubuntu/juno-staging<br>   for grizzly, ~ubuntu-cloud-archive/grizzly-staging</p>
<p>5, Resolv the dependancy<br>   dpkg-checkbuilddeps</p>
<p>   add grizzly dependancy repository</p>
<p>   #sudo add-apt-repository ppa:ubuntu-cloud-archive/grizzly-staging<br>   deb <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu</a> precise main<br>   deb-src <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/grizzly-staging/ubuntu</a> precise main<br>   sudo apt-get build-dep  quantum    # will read debian/control to resolv dependancy.<br>   sudo apt-get build-dep –no-install-recommends quantum</p>
<p>6, Build<br>   find . -name “*.pyc” -exec rm -rf {} \;</p>
<p>   #build signed source package<br>   debuild -S -k<your key="" here=""></your></p>
<p>   #build signed binary package<br>   debuild -b -k<your key="" here=""></your></p>
<p>   #build unsigned source package<br>   debuild -i -us -uc -S</p>
<p>   #build unsigned binary package which can be tested by the command ‘dpkg -i <pac>.deb’<br>   debuild -i -us -uc -b</pac></p>
<p>   debuild -S -sa –changes-option=-DDistribution=precise -k<gpgkey>  # -sa is used for including source code</gpgkey></p>
<h1 id="pdebuild-–debbuildopts-sa"><a href="#pdebuild-–debbuildopts-sa" class="headerlink" title="pdebuild –debbuildopts -sa"></a>pdebuild –debbuildopts -sa</h1><p>   #for openstack sru, 有时候这步不成功，需要先将patch用quilt格式化一下再用（quilt import, quilt push -a, quilt refresh)</p>
<p>   sudo apt install build-essential devscripts quilt dh-autoreconf fakeroot dpkg-dev python-sphinx</p>
<p>   gbp buildpackage -S -k$GPGKEY</p>
<p>   #gbp buildpackage -S -us -uc</p>
<p>2, debiandiff, 这步需要将老新build两次再用debdiff命令产生<br>   a, Use the existing debdiff, patch -p1 &lt; ../trusty.debdiff<br>   b, Create new debdiff, <a href="http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff" target="_blank" rel="external">http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff</a><br>      debuild -S                                              #build old source to generate dsc file<br>      debdiff old.dsc new.dsc                           #generate debdiff by comparing two sources</p>
<p>7, Upload to PPA<br>   export DEBEMAIL=<email><br>   export DEBFULLNAME=<name, e.g.="" "zhang"=""></name,></email></p>
<p>   #Test PPA can be created in <a href="https://launchpad.net/~zhhuabj/+activate-ppa" target="_blank" rel="external">https://launchpad.net/~zhhuabj/+activate-ppa</a><br>   dput -f ppa:zhhuabj/trusty-sru-testing test.changes</p>
<p>   #openstack sru</p>
<p>git push –all lp:~<launchpad-id>/ubuntu/+source/nova<br>git push –tags lp:~<launchpad-id>/ubuntu/+source/nova</launchpad-id></launchpad-id></p>
<p>如果用git的话，需要先在~/.git_config中添加：</p>
<p>[url “git+ssh://zhhuabj@git.launchpad.net/“]<br>        insteadof = lp:</p>
<p>然后执行：git push lp:~zhhuabj/ubuntu/+source/nova</p>
<p>最后访问： <a href="https://code.launchpad.net/~zhhuabj/ubuntu/+source/nova/+git/nova" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/ubuntu/+source/nova/+git/nova</a></p>
<p>8, sru进度查看</p>
<p>UA,    <a href="https://people.canonical.com/~ubuntu-archive/pending-sru.html" target="_blank" rel="external">https://people.canonical.com/~ubuntu-archive/pending-sru.html</a></p>
<p>UCA, reqorts.qa.ubuntu.com/reports/ubuntu-server/cloud-archive/kilo_versions.html</p>
<p>附录一，sbuild</p>
<p>#sbuild, <a href="https://wiki.ubuntu.com/SimpleSbuild" target="_blank" rel="external">https://wiki.ubuntu.com/SimpleSbuild</a></p>
<p>#sudo add-apt-repository cloud-archive:liberty<br>cat /etc/apt/sources.list.d/ubuntu-cloud-archive-liberty-staging-trusty.list</p>
<p>deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> liberty-updates/ubuntu main</p>
<h1 id="deb-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main"><a href="#deb-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main" class="headerlink" title="deb http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu trusty main"></a>deb <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu</a> trusty main</h1><h1 id="deb-src-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main"><a href="#deb-src-http-ppa-launchpad-net-ubuntu-cloud-archive-liberty-staging-ubuntu-trusty-main" class="headerlink" title="deb-src http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu trusty main"></a>deb-src <a href="http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/ubuntu-cloud-archive/liberty-staging/ubuntu</a> trusty main</h1><p>schroot -l<br>schroot -c source:trusty-amd64 -u root         #这句会告成电脑没有声音，可以使用sudo killall pulseaudio解决<br>schroot -c trusty-amd64 -u root  #do work<br>apt-get build-dep libvirt-bin<br>sbuild -d trusty-amd64</p>
<p>附录二, pbuilder</p>
<p>#pbuilder <a href="https://wiki.ubuntu.com/PbuilderHowto" target="_blank" rel="external">https://wiki.ubuntu.com/PbuilderHowto</a>   <a href="http://www.cr173.com/html/28930_1.html" target="_blank" rel="external">http://www.cr173.com/html/28930_1.html</a><br>sudo apt-get install pbuilder debootstrap devscripts apt-cacher-ng<br>echo ‘Acquire::http::Proxy “<a href="http://127.0.0.1:3142" target="_blank" rel="external">http://127.0.0.1:3142</a>“;’ | sudo tee /etc/apt/apt.conf.d/01acng<br>$ sudo cat /etc/pbuilderrc<br>MIRRORSITE=<a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a><br>export http_proxy=<a href="http://127.0.0.1:3142/" target="_blank" rel="external">http://127.0.0.1:3142/</a><br>export http_proxys=<a href="http://127.0.0.1:3142/" target="_blank" rel="external">http://127.0.0.1:3142/</a></p>
<p>DEBFULLNAME=’xxx’<br>DEBEMAIL=’xxx@xxx.com’</p>
<p>DISTRIBUTION=’trusty’<br>OTHERMIRROR=”deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION} universe”<br>OTHERMIRROR+=”|deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION}-updates main universe”<br>OTHERMIRROR+=”|deb <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> ${DISTRIBUTION}-proposed main”<br>EXTRAPACKAGES=’’<br>EXTRAPACKAGES+=’ vim sudo openssh-server bash-completion wget rsync git build-essential gdb crash apt-transport-https ca-certificates ubuntu-cloud-keyring’</p>
<h1 id="Cloud-Archive"><a href="#Cloud-Archive" class="headerlink" title="Cloud Archive"></a>Cloud Archive</h1><p>#OS_RELEASE=’liberty’</p>
<p>#OTHERMIRROR+=”|deb <a href="http://ubuntu-cloud.archive.canonical.com/ubuntu" target="_blank" rel="external">http://ubuntu-cloud.archive.canonical.com/ubuntu</a> $DISTRIBUTION-updates/$OS_RELEASE main”</p>
<p>if [ -n “$OS_RELEASE” ]; then<br>    BASETGZ=”/var/cache/pbuilder/$DISTRIBUTION-$OS_RELEASE-base.tgz”<br>else<br>    BASETGZ=”/var/cache/pbuilder/$DISTRIBUTION-base.tgz”<br>fi</p>
<p>#sudo pbuilder –create –distribution trusty –architecture amd64 –basetgz /images/pbuilder/trusty-amd64-base.tgz –debootstrapopts –variant=buildd<br>sudo pbuilder –create –distribution trusty –architecture amd64 –debootstrapopts –variant=buildd</p>
<p>sudo cp /var/cache/pbuilder/trusty-base.tgz /var/cache/pbuilder/trusty-liberty-base.tgz</p>
<p>then uncomment OS_RELEASE, run ‘sudo pbuilder update’ again</p>
<p>sudo pbuilder login –save-after-login  #equal to chroot</p>
<p>echo ‘precedence ::ffff:0:0/96 100’ &gt;&gt; /etc/gai.conf<br>root# Add UCA repository  to source.list,</p>
<pre><code># &apos;deb http://ubuntu-cloud.archive.canonical.com/ubuntu liberty-updates/ubuntu main&apos; &amp;&amp; apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8A6844A29F68104E

or apt-get install software-properties-common python-software-properties  &amp;&amp;  add-apt-repository cloud-archive:liberty
</code></pre><p>root# apt update</p>
<p>then exit chroot, press ctrl-d to save</p>
<p>#schroot -c trusty-amd64 -p apt update</p>
<p>#it’s more safer to use the following chroot instead of above ‘pbulider login’ and ‘schroot’ to modify chroot env</p>
<p>LANG=C DEBIAN_FRONTEND=noninteractive chroot /var/lib/schroot/chroots/trusty-amd64 bash -c ‘apt-get update’<br>echo ‘hua     ALL=(ALL) NOPASSWD:ALL’ |sudo tee -a /var/lib/schroot/chroots/trusty-amd64/etc/sudoers</p>
<p>sudo pbuilder update   #run again when building the package every time</p>
<p>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.dsc" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.dsc</a><br>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14.orig.tar.gz" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14.orig.tar.gz</a><br>wget <a href="https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.debian.tar.xz" target="_blank" rel="external">https://launchpad.net/debian/+archive/primary/+files/libvirt_1.2.14-3.debian.tar.xz</a></p>
<p>#注意：上面的是debian包，需要先使用beyond compare工具和ubuntu的1.2.16对debian目录进行比较转化成ubuntu包，转换规则是：</p>
<p>1， 凡1.2.14有的，1.2.16没有的，删</p>
<p>2， 凡1.2.14没有的，1.2.16有的，增</p>
<p>3， 凡1.2.14与1.2.16不一致的以1.2.16为准</p>
<p>4， debian/patch和debian/changlog可以不作处理</p>
<p>5， debian/control也是重点</p>
<p>#sudo pbuilder –build –distribution trusty –architecture amd64 ./libvirt_1.2.14-3.dsc</p>
<p>dpkg-source -x libvirt_1.2.14-3.dsc &amp;&amp; cd libvirt-1.2.14</p>
<h1 id="sudo-pdebuild"><a href="#sudo-pdebuild" class="headerlink" title="sudo pdebuild"></a>sudo pdebuild</h1><p>sudo pdebuild –debbuildopts -sa  # sometimes need to include source code for uca</p>
<h1 id="you’d-better-not-add-sudo"><a href="#you’d-better-not-add-sudo" class="headerlink" title="you’d better not add sudo"></a>you’d better not add sudo</h1><p>debsign /var/cache/pbuilder/result/<package><em><version>.changes -k$GPGKEY<br>dput ppa:techtonik/backports /var/cache/pbuilder/result/<package></package></version></em><version>.changes</version></package></p>
<p>注意： 其他帐户的私有PPA要点击”Manage Access”按钮将自己LP ID加进去之后才能在<a href="https://launchpad.net/~zhhuabj/+archivesubscriptions" target="_blank" rel="external">https://launchpad.net/~zhhuabj/+archivesubscriptions</a> 键接看到ppa的用户名和密码</p>
<p>sudo apt-get autoclean<br>sudo apt-get update<br>sudo apt-get -f install</p>
<p>sudo apt update</p>
<p>cat /etc/apt/source.list</p>
<p>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial main restricted universe multiverse<br>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial-updates main restricted universe multiverse<br>deb <a href="http://cn.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://cn.archive.ubuntu.com/ubuntu/</a> xenial-proposed main restricted universe multiverse<br>deb <a href="http://security.ubuntu.com/ubuntu" target="_blank" rel="external">http://security.ubuntu.com/ubuntu</a> xenial-security main restricted universe multiverse</p>
<p>#deb-src <a href="http://us.archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://us.archive.ubuntu.com/ubuntu/</a> trusty main</p>
<h2 id="ubuntu-ddebs"><a href="#ubuntu-ddebs" class="headerlink" title="ubuntu ddebs"></a>ubuntu ddebs</h2><h1 id="deb-http-ddebs-ubuntu-com-xenial-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-updates-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-updates-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-updates main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-updates main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-proposed-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-proposed-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-proposed main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-proposed main restricted universe multiverse</h1><h1 id="deb-http-ddebs-ubuntu-com-xenial-security-main-restricted-universe-multiverse"><a href="#deb-http-ddebs-ubuntu-com-xenial-security-main-restricted-universe-multiverse" class="headerlink" title="deb http://ddebs.ubuntu.com/ xenial-security main restricted universe multiverse"></a>deb <a href="http://ddebs.ubuntu.com/" target="_blank" rel="external">http://ddebs.ubuntu.com/</a> xenial-security main restricted universe multiverse</h1><h2 id="kernel-ppa"><a href="#kernel-ppa" class="headerlink" title="kernel ppa"></a>kernel ppa</h2><h1 id="deb-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main"><a href="#deb-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main" class="headerlink" title="deb http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu xenial main"></a>deb <a href="http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu</a> xenial main</h1><h1 id="deb-src-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main"><a href="#deb-src-http-ppa-launchpad-net-canonical-kernel-team-ppa-ubuntu-xenial-main" class="headerlink" title="deb-src http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu xenial main"></a>deb-src <a href="http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu" target="_blank" rel="external">http://ppa.launchpad.net/canonical-kernel-team/ppa/ubuntu</a> xenial main</h1><p>附录 - 如何修改ubuntu-installer</p>
<p>Ubuntu有两个Installer [3], 一个是修改版的Debian Installer <a href="也叫d-i, 用C/bash写的">2</a>, 一个用于desktop CD安装的Ubiquity[1] (前端用python写的，后端还是d-i, ‘bzr branch <a href="http://bazaar.launchpad.net/~ubuntu-installer/ubiquity/trunk‘)。" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-installer/ubiquity/trunk‘)。</a><br>例如，要修改ubiquity源码(sudo apt-get source ubiquity)下的./d-i/source/preseed/debian/network-preseed.postinst文件，先从<a href="https://launchpad.net/d-i(debian对应的链接是https://anonscm.debian.org/cgit/d-i/）找到ubuntu修改后的d-i应该对应preseed，然后找到对应的源码为http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">https://launchpad.net/d-i(debian对应的链接是https://anonscm.debian.org/cgit/d-i/）找到ubuntu修改后的d-i应该对应preseed，然后找到对应的源码为http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst</a> (也可通过’bzr branch lp:preseed’或’bzr branch lp:~ubuntu-core-dev/preseed/ubuntu’命令下载源码).<br>sudo apt-get source preseed<br>bzr branch <a href="http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu</a></p>
<p>那么如何将修改的preseed debdiff生成iso文件呢？只需要先将preseed dput到ppa (preseed是没有patchless的，直接修改要修改的文件即可), 等它build完成之后然后再将debian-installer (sudo apt-get source debain-installer，不需要修改源文件，只需要在changelog中增加版本号) dput到ppa即可。等 build完之后便可以生成mini.iso ( <a href="http://ppa.launchpad.net/zhhuabj/xenial-sru-testing/ubuntu/dists/xenial/main/installer-amd64/20101020ubuntu451.19/images/netboot/mini.iso" target="_blank" rel="external">http://ppa.launchpad.net/zhhuabj/xenial-sru-testing/ubuntu/dists/xenial/main/installer-amd64/20101020ubuntu451.19/images/netboot/mini.iso</a> )。</p>
<p>如何测试这个mini.iso呢？和测试full iso的方法一样，启动后在选择语言处按TAB键(full iso是按F6键)进入grub菜单，然后添加url=<a href="http://192.168.99.135/xenial.preseed即可。在正式版出来之前只能使用mini.iso，full" target="_blank" rel="external">http://192.168.99.135/xenial.preseed即可。在正式版出来之前只能使用mini.iso，full</a> iso的日期可参见：<a href="https://wiki.ubuntu.com/BionicBeaver/ReleaseSchedule" target="_blank" rel="external">https://wiki.ubuntu.com/BionicBeaver/ReleaseSchedule</a></p>
<p>[1] <a href="https://code.launchpad.net/~ubuntu-installer/ubiquity/trunk" target="_blank" rel="external">https://code.launchpad.net/~ubuntu-installer/ubiquity/trunk</a><br>[2] <a href="http://d-i.alioth.debian.org/doc/talks/debconf6/paper/" target="_blank" rel="external">http://d-i.alioth.debian.org/doc/talks/debconf6/paper/</a><br>[3] <a href="https://wiki.ubuntu.com/Installer/Development" target="_blank" rel="external">https://wiki.ubuntu.com/Installer/Development</a><br>[4] <a href="http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-core-dev/preseed/ubuntu/view/head:/debian/network-preseed.postinst</a><br>[5] <a href="http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst" target="_blank" rel="external">http://bazaar.launchpad.net/~ubuntu-installer/preseed/master/view/head:/debian/network-preseed.postinst</a><br>[6] <a href="https://anonscm.debian.org/cgit/d-i/preseed.git/tree/debian/network-preseed.postinst" target="_blank" rel="external">https://anonscm.debian.org/cgit/d-i/preseed.git/tree/debian/network-preseed.postinst</a></p>
<p>附录： How to use schroot to enter a chroot without using sudo</p>
<p>sudo apt install -y schroot sbuild debhelper ubuntu-dev-tools piuparts<br>sudo mkdir -p /var/lib/schroot/chroots/trusty-amd64<br>sudo cp /etc/schroot/schroot.conf /etc/schroot/schroot.conf.old<br>sudo debootstrap –include=sudo,bash-completion,kernel-wedge,fakeroot,git,vim,bc,gawk,libncurses5-dev,libssl-dev,openssl,build-essential,rsync –arch=amd64 trusty /var/lib/schroot/chroots/trusty-amd64 <a href="http://archive.ubuntu.com/ubuntu/" target="_blank" rel="external">http://archive.ubuntu.com/ubuntu/</a></p>
<p>#sudo pbuilder login –save-after-login</p>
<p>#schroot -c trusty-amd64 -p apt update</p>
<p>#it’s more safer to use the following chroot instead of above ‘pbulider login’ and ‘schroot’ to modify chroot env</p>
<p>LANG=C DEBIAN_FRONTEND=noninteractive chroot /var/lib/schroot/chroots/trusty-amd64 bash -c ‘apt-get update’<br>echo ‘hua     ALL=(ALL) NOPASSWD:ALL’ |sudo tee -a /var/lib/schroot/chroots/trusty-amd64/etc/sudoers</p>
<p>vi /etc/schroot/chroot.d/sbuild-trusty-amd64<br>[trusty-amd64]<br>description=trusty-amd64</p>
<h1 id="To-avoid-the-error-‘You-do-not-have-permission-to-access-the-schroot-service’"><a href="#To-avoid-the-error-‘You-do-not-have-permission-to-access-the-schroot-service’" class="headerlink" title="To avoid the error ‘You do not have permission to access the schroot service’"></a>To avoid the error ‘You do not have permission to access the schroot service’</h1><p>users=hua<br>groups=sbuild,root,admin<br>root-groups=sbuild,root,admin</p>
<h1 id="Uncomment-these-lines-to-allow-members-of-these-groups-to-access"><a href="#Uncomment-these-lines-to-allow-members-of-these-groups-to-access" class="headerlink" title="Uncomment these lines to allow members of these groups to access"></a>Uncomment these lines to allow members of these groups to access</h1><h1 id="the-source-chroots-directly-useful-for-automated-updates-etc"><a href="#the-source-chroots-directly-useful-for-automated-updates-etc" class="headerlink" title="the -source chroots directly (useful for automated updates, etc)."></a>the -source chroots directly (useful for automated updates, etc).</h1><p>#source-root-users=sbuild,root,admin</p>
<p>#source-root-groups=sbuild,root,admin<br>type=directory<br>profile=default<br>union-type=overlayfs</p>
<h1 id="We-can-also-use-the-chroot-which-is-created-by-pbuilder-eg-tar-xf-var-cache-pbuilder-trusty-base-tgz"><a href="#We-can-also-use-the-chroot-which-is-created-by-pbuilder-eg-tar-xf-var-cache-pbuilder-trusty-base-tgz" class="headerlink" title="We can also use the chroot which is created by pbuilder. eg: tar -xf /var/cache/pbuilder/trusty-base.tgz"></a>We can also use the chroot which is created by pbuilder. eg: tar -xf /var/cache/pbuilder/trusty-base.tgz</h1><p>directory=/var/lib/schroot/chroots/trusty-amd64<br>source-root-users=root,sbuild,admin<br>source-root-groups=root,sbuild,admin<br>preserve-environment=true</p>
<h1 id="https-blog-csdn-net-fenglailea-article-details-37035995"><a href="#https-blog-csdn-net-fenglailea-article-details-37035995" class="headerlink" title="https://blog.csdn.net/fenglailea/article/details/37035995"></a><a href="https://blog.csdn.net/fenglailea/article/details/37035995" target="_blank" rel="external">https://blog.csdn.net/fenglailea/article/details/37035995</a></h1><p>sudo groupadd admin<br>sudo adduser $USER admin<br>schroot -l<br>schroot -c trusty-amd64<br>schroot -c trusty-amd64 – cmd …</p>
<p>#export $(dpkg-architecture -aarm64); export CROSS_COMPILE=aarch64-linux-gnu-</p>
<p>#fakeroot debian/rules clean binary-generic</p>
<p>附录 - The best solution to fix broken ubuntu package</p>
<p>sudo apt update –fix-missing<br>hua@t440p:~$ sudo dpkg –configure -a<br>dpkg: dependency problems prevent configuration of bpfcc-tools:<br> bpfcc-tools depends on python-bpfcc (&gt;= 0.5.0-5ubuntu1); however:<br>  Package python-bpfcc is not installed.<br>dpkg: error processing package bpfcc-tools (–configure):<br> dependency problems - leaving unconfigured<br>Errors were encountered while processing:<br> bpfcc-tools</p>
<p>#Remove python-bpfcc and bpfcc-tools from the file /var/lib/dpkg/status<br>sudo vim /var/lib/dpkg/status</p>
<p>#then run<br>sudo fuser -vki /var/lib/dpkg/lock<br>sudo dpkg –configure -a</p>
<p>Reference<br>1, <a href="https://help.launchpad.net/Packaging/UploadErrors" target="_blank" rel="external">https://help.launchpad.net/Packaging/UploadErrors</a><br>2, <a href="https://wiki.canonical.com/STS/Engineering/Hotfix" target="_blank" rel="external">https://wiki.canonical.com/STS/Engineering/Hotfix</a><br>3, <a href="http://packaging.ubuntu.com/html/fixing-a-bug.html#work-on-a-fix" target="_blank" rel="external">http://packaging.ubuntu.com/html/fixing-a-bug.html#work-on-a-fix</a><br>4, <a href="http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff" target="_blank" rel="external">http://packaging.ubuntu.com/html/traditional-packaging.html#creating-a-debdiff</a><br>5, <a href="http://blog.packagecloud.io/debian/debuild/packaging/2015/06/08/buildling-deb-packages-with-debuild/" target="_blank" rel="external">http://blog.packagecloud.io/debian/debuild/packaging/2015/06/08/buildling-deb-packages-with-debuild/</a></p>
<p>6, <a href="https://wiki.ubuntu.com/OpenStack/StableReleaseUpdates" target="_blank" rel="external">https://wiki.ubuntu.com/OpenStack/StableReleaseUpdates</a><br>7, <a href="https://wiki.ubuntu.com/OpenStack/CorePackages" target="_blank" rel="external">https://wiki.ubuntu.com/OpenStack/CorePackages</a><br>8, <a href="https://wiki.ubuntu.com/ServerTeam/OpenStack/SRUCadence" target="_blank" rel="external">https://wiki.ubuntu.com/ServerTeam/OpenStack/SRUCadence</a></p>
<p>9, <a href="https://wiki.ubuntu.com/SimpleSbuild#" target="_blank" rel="external">https://wiki.ubuntu.com/SimpleSbuild#</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/24/How-to-make-pure-text-presentation-ppt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/24/How-to-make-pure-text-presentation-ppt/" itemprop="url">How to make pure text presentation/ppt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-24T18:13:57+08:00">
                2019-12-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="vim-more"><a href="#vim-more" class="headerlink" title="vim + more"></a>vim + more</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^L                   #press i to enter edit mode, then press Ctrl+L to inut ^L</span><br><span class="line">more -p  test.txt</span><br><span class="line"></span><br><span class="line">:set textwidth=70</span><br><span class="line">#for the existing lines</span><br><span class="line">v</span><br><span class="line">gq</span><br></pre></td></tr></table></figure>
<h2 id="markdown-marp"><a href="#markdown-marp" class="headerlink" title="markdown/marp"></a>markdown/marp</h2><p><a href="https://web.marp.app/" target="_blank" rel="external">https://web.marp.app/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- page_number: true --&gt;</span><br><span class="line"></span><br><span class="line"># 一级标题</span><br><span class="line">## 二级标题</span><br><span class="line">**重点**</span><br><span class="line"></span><br><span class="line">- 列表1</span><br><span class="line">- 列表2</span><br><span class="line"></span><br><span class="line">![](图片url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">Next Page</span><br></pre></td></tr></table></figure>
<h2 id="查看本地md文件"><a href="#查看本地md文件" class="headerlink" title="查看本地md文件"></a>查看本地md文件</h2><p>sudo pip install markdownserver<br>cd onedir then run:  sudo markdownserver<br>then visit: <a href="http://localhost:8009/index.md" target="_blank" rel="external">http://localhost:8009/index.md</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">94</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
