<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/04/使用rsync同步数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/04/使用rsync同步数据/" itemprop="url">使用rsync同步数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T21:15:27+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2015-12-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )<br>急需使用rsync在家里的多台机器上同步相片。</p>
<p>sudo apt-get  install  rsync<br>sudo update-rc.d -f rsync remove<br>sudo update-rc.d rsync start 20 2 3 4 5 . stop 20 0 1 6 .<br>sudo update-rc.d rsync enable<br>hua@node1:~$ sudo sysv-rc-conf –list rsync<br>rsync        0:off    1:off    2:on    3:on    4:on    5:on    6:off</p>
<p>这时候就可以在一台机器上同步目录了(rsync server运行在qnap上，统一在qnap上修改，rsync client定时运行下列命令即可让客户端的文件夹与服务端同步，以服务端为准）:</p>
<p>rsync -avzur –progress –delete /bak/tmp/qnap/ /qnap/<br>rsync -avzur –progress –delete –password-file=/etc/rsync.secret  /bak/tmp/qnap/ /qnap/</p>
<p>在多台机器上同步目录：</p>
<p>rsync -rave “ssh -p 22 -l hua” -avzur –progress –delete 192.168.99.124:/qnap/ /qnap/<br>等价于：rsync -avzur –progress –delete hua@192.168.99.124:/qnap/ /qnap/</p>
<p>也可以配置使用::qnap使用下列配置文件/etc/rsyncd.conf中的[qnap]模块：</p>
<p>sudo rsync -avrzP hua@192.168.99.124::qnap qnap</p>
<p>hua@node1:~$ sudo rsync –list-only hua@192.168.99.124::<br>++++++++++++++++++++++++++++++++++++++++++++++<br>Welcome to use quqi rsync services!<br>++++++++++++++++++++++++++++++++++++++++++++++</p>
<p>qnap               This is qnap backup data</p>
<p>配置[qnap]模块的步骤如下：</p>
<p>sudo touch /etc/rsyncd.conf<br>sudo touch /etc/rsyncd.motd<br>hua@node1:~$ sudo cat /etc/rsyncd.motd<br>++++++++++++++++++++++++++++++++++++++++++++++<br>Welcome to use quqi rsync services!<br>++++++++++++++++++++++++++++++++++++++++++++++<br>sudo touch /etc/rsyncd.secrets<br>hua@node1:~$ sudo cat /etc/rsyncd.secrets<br>hua:Passw0rd<br>sudo chmod 600 /etc/rsyncd.secrets<br>sudo chown root:root /etc/rsyncd.secrets<br>hua@node1:~$ sudo cat /etc/default/rsync |grep ‘RSYNC_ENABLE’<br>RSYNC_ENABLE=true</p>
<p>sudo /etc/init.d/rsync restart<br>sudo iptables -A INPUT -p tcp -m state –state NEW  -m tcp –dport 873 -j ACCEPT<br>vi /etc/rsyncd.conf<br>pid file = /var/run/rsyncd.pid<br>port = 873<br>address = 192.168.99.124</p>
<p>#usermod -g root hua<br>uid = hua<br>gid = root<br>use chroot = yes<br>read only = yes<br>hosts allow=192.168.99.0/255.255.255.0 10.0.1.0/255.255.255.0<br>hosts deny=*<br>max connections = 5<br>motd file = /etc/rsyncd.motd<br>log file = /var/log/rsync.log</p>
<p>#transfer logging = yes<br>log format = %t %a %m %f %b<br>syslog facility = local3<br>timeout = 300</p>
<p>[qnap]<br>path = /qnap<br>list=yes             # 可以使用rsync –list-only hua@192.168.99.124::命令列出目录<br>ignore errors<br>auth users = hua,root<br>secrets file = /etc/rsyncd.secrets<br>comment = This is qnap backup data<br>exclude = tmp/  test/</p>
<p>最后，我实际上是这样处理的，我有一个qnap，一个台式机，一个笔记本，对于一些相片啥的想多存储几份别一个机器哪天坏了丢了。</p>
<p>1, 由于iscsi上一个bug，一个client对qnap上的iscsi server写了之后，没法实时更新在另一个client上（必须先umount再mount一下才行）， 并且qnap的iscsi采用一个大的虚拟文件存储的，这都不是我想要的。所以最后只使用了qnap上的nfs将相片存储了一份。</p>
<p>2, 台式机因为IP固定开机自动mount (sudo mount -t nfs -o vers=3 192.168.99.122:/Public /bak/qnap), 另外直接复制了一份到/bak/qnap_local目录防止rsync操作失误毁坏数据。</p>
<p>3, 笔记本因为经常外出IP不固定，外出时使用/bak/qnap_local目录的内容，在家需要同步时手工同步：</p>
<p>   sudo mount -t nfs -o vers=3 192.168.99.122:/Public /bak/qnap<br>   cd ~ &amp;&amp; rsync -avzurP –exclude ‘doc’ –exclude ‘photo’ –exclude ‘media’  –progress –delete /bak/qnap/ /bak/qnap_local</p>
<p>4, 平时在家办公统一从台式机上写/bak/qnap目录将数据直接写到qnap上。手机等移动设备通过qnap ftp访问数据。</p>
<p>20171031更新：</p>
<p>最后的方案是：</p>
<p>1， 使用autos先将nas上的nfs共享目录共享到台式机（注： nfs共离目录无法使用inotify)：</p>
<p>hua@node1:~$ grep -r ‘auto.direct’ /etc/auto.master<br>/-      auto.direct        –timeout 60<br>hua@node1:~$ cat /etc/auto.direct<br>/nas    -fstype=nfs4,rsize=32768,wsize=32768     192.168.99.122:/Public</p>
<p>2, 然后直接手动运行下列两个命令：</p>
<p>rsync -avztur –progress –delete  /nas/doc/  /bak/doc<br>rsync -avztur –progress –delete  /nas/photo/  /bak/photo</p>
<p>20201104更新 - nas往openwrt同步数据</p>
<p>rsync can work in two different mode, rsync over rsync (873, rsyncd) and rsync over ssh, see <a href="https://serverfault.com/questions/827633/confused-about-rsync-port-873-and-nas" target="_blank" rel="external">https://serverfault.com/questions/827633/confused-about-rsync-port-873-and-nas</a><br>we use rsync over ssh mode here.</p>
<h1 id="openwrt-192-168-2-47-192-168-99-1"><a href="#openwrt-192-168-2-47-192-168-99-1" class="headerlink" title="openwrt (192.168.2.47, 192.168.99.1)"></a>openwrt (192.168.2.47, 192.168.99.1)</h1><p>opkg install rsync</p>
<h1 id="nas-192-168-2-103-push-data-into-openwrt-192-168-2-47"><a href="#nas-192-168-2-103-push-data-into-openwrt-192-168-2-47" class="headerlink" title="nas (192.168.2.103) push data into openwrt(192.168.2.47)"></a>nas (192.168.2.103) push data into openwrt(192.168.2.47)</h1><h1 id="don’t-use-rsync"><a href="#don’t-use-rsync" class="headerlink" title="don’t use rsync"></a>don’t use rsync</h1><p>cd /share/HDA_DATA/Public/test &amp;&amp; touch test1 &amp;&amp; touch test2 &amp;&amp; touch test3<br>ssh root@192.168.2.47 “tee -a /etc/dropbear/authorized_keys” &lt; ~/.ssh/id_rsa.pub<br>rsync -avztur –progress –delete –exclude ‘test/test1’ –exclude ‘test/test2’ /share/HDA_DATA/Public/test root@192.168.2.47:/mnt/sdb1/<br>rsync -avztur –progress –delete –exclude ‘test1’ –exclude ‘test2’ /share/HDA_DATA/Public/test/ root@192.168.2.47:/mnt/sdb1/<br>rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /share/HDA_DATA/Public/ root@192.168.2.47:/mnt/sdb1/<br>contab -e<br>0 1 <em> </em> * /usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /share/HDA_DATA/Public/ root@192.168.2.47:/mnt/sdb1/</p>
<p>或者在openwrt端做:</p>
<p>mkdir ~/.ssh<br>dropbearkey -t rsa -f ~/.ssh/id_rsa<br>dropbearkey -y -f ~/.ssh/id_rsa |sed -n 2p &gt; ~/.ssh/id_rsa.pub</p>
<h1 id="https-community-onion-io-topic-2538-resolved-ssh-from-omega-to-linux-server-without-password-9"><a href="#https-community-onion-io-topic-2538-resolved-ssh-from-omega-to-linux-server-without-password-9" class="headerlink" title="https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9"></a><a href="https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9" target="_blank" rel="external">https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9</a></h1><p>ln -s ~/.ssh/id_rsa ~/.ssh/id_dropbear<br>chmod 700 ~/.ssh<br>touch ~/.ssh/authorized_keys &amp;&amp; chmod 644 ~/.ssh/authorized_keys<br>ssh admin@192.168.2.103 “tee -a /root/.ssh/authorized_keys” &lt; ~/.ssh/id_rsa.pub<br>/usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ admin@192.168.2.103:/share/HDA_DATA/Public/ /mnt/sdb1/</p>
<p>但这无论从nas还是从openwrt运行rsync都由于nas太慢大概只有4M左右，可能提升速度最好的办法是先将nas通过nfs映射到openwrt然后再拷．这样速度能达到30M</p>
<p>opkg install nfs-utils<br>showmount -e 192.168.2.103<br>/usr/bin/mount -t nfs 192.168.2.103:Public /mnt/nas -o proto=tcp -o nolock -o vers=4<br>/usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /mnt/nas/ /mnt/sdc1/<br>但是我担心将mount放到fstab时当nas有问题时也影响openwrt的启动，所以我将上面命令放在rc.local中.<br>root@OpenWrt:~# cat /etc/init.d/done</p>
<p>#!/bin/sh /etc/rc.common</p>
<h1 id="Copyright-C-2006-OpenWrt-org"><a href="#Copyright-C-2006-OpenWrt-org" class="headerlink" title="Copyright (C) 2006 OpenWrt.org"></a>Copyright (C) 2006 OpenWrt.org</h1><p>START=95<br>boot() {<br>    mount_root done<br>    rm -f /sysupgrade.tgz &amp;&amp; sync</p>
<pre><code># process user commands
[ -f /etc/rc.local ] &amp;&amp; {
    sh /etc/rc.local
}

# set leds to normal state
. /etc/diag.sh
set_state done
</code></pre><p>}<br>并且crontab也在openwrt这边做．这样速度达到了30M</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/04/Install-OpenStack-on-MAAS-Nodes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/04/Install-OpenStack-on-MAAS-Nodes/" itemprop="url">Install OpenStack on MAAS Nodes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T16:23:01+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>作者：张华 发表于：2016-11-09<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</em></p>
<p>1, Prepare MAAS Nodes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y maas-cli</span><br><span class="line">echo &apos;&lt;key-in-&lt;MAASIP&gt;/MAAS/r/account/prefs/api-keys&gt;&apos; &gt; ~/maas-apikey</span><br><span class="line">maas login admin http://10.230.56.2/MAAS `cat ~/maas-apikey`</span><br><span class="line">maas admin tags read</span><br><span class="line"></span><br><span class="line"># https://juju.is/docs/maas-cloud</span><br><span class="line">sudo bash -c &apos;cat &gt; /tmp/mymmas.yaml&apos; &lt;&lt; EOF</span><br><span class="line">clouds:</span><br><span class="line">   mymmas:</span><br><span class="line">      type: maas</span><br><span class="line">      auth-types: [oauth1]</span><br><span class="line">      endpoint: http://&lt;MAASIP&gt;/MAAS</span><br><span class="line">EOF</span><br><span class="line">juju remove-cloud --local mymmas</span><br><span class="line">juju add-cloud --local mymmas /tmp/mymmas.yaml</span><br><span class="line">juju list-clouds</span><br><span class="line">juju show-cloud mymmas --local</span><br><span class="line">sudo bash -c &apos;cat &gt; /tmp/credential.yaml&apos; &lt;&lt; EOF</span><br><span class="line">credentials:</span><br><span class="line">  mymmas:</span><br><span class="line">    zhhuabj:</span><br><span class="line">      auth-type: oauth1</span><br><span class="line">      maas-oauth: &lt;key-in-&lt;MAASIP&gt;/MAAS/r/account/prefs/api-keys&gt;</span><br><span class="line">EOF</span><br><span class="line">juju remove-credential --local mymmas zhhuabj</span><br><span class="line">juju add-credential --local mymmas -f /tmp/credential.yaml</span><br><span class="line">juju credentials --local</span><br><span class="line">juju show-credential --local mymmas zhhuabj</span><br><span class="line">cat ~/.local/share/juju/credentials.yaml</span><br><span class="line"></span><br><span class="line">juju bootstrap --debug segmaas --no-gui --config image-stream=daily --config default-series=focal --constraints=&quot;tags=virtual&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">juju export-bundle --filename /tmp/sriov.yaml   #seg-bundles</span><br><span class="line">series: bionic</span><br><span class="line">applications:</span><br><span class="line">  glance:</span><br><span class="line">    charm: cs:~openstack-charmers-next/glance-423</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  keystone:</span><br><span class="line">    charm: cs:~openstack-charmers-next/keystone-508</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      admin-password: openstack</span><br><span class="line">      debug: true</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  mysql:</span><br><span class="line">    charm: cs:~openstack-charmers-next/percona-cluster-376</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      innodb-buffer-pool-size: 512M</span><br><span class="line">      max-connections: 1000</span><br><span class="line">      root-password: admin</span><br><span class="line">      sst-password: admin</span><br><span class="line">  neutron-api:</span><br><span class="line">    charm: local:bionic/neutron-api-0</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      enable-sriov: true</span><br><span class="line">      flat-network-providers: physnet1</span><br><span class="line">      neutron-security-groups: true</span><br><span class="line">      supported-pci-vendor-devs: 14e4:16af 8086:1515 8086:1528</span><br><span class="line">      verbose: true</span><br><span class="line">      vlan-ranges: &quot;&quot;</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  neutron-openvswitch:</span><br><span class="line">    charm: local:bionic/neutron-openvswitch-0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      enable-local-dhcp-and-metadata: true</span><br><span class="line">      enable-sriov: true</span><br><span class="line">      sriov-device-mappings: physnet1:eno50</span><br><span class="line">      verbose: true</span><br><span class="line">      vlan-ranges: &quot;&quot;</span><br><span class="line">  nova-cloud-controller:</span><br><span class="line">    charm: local:bionic/nova-cloud-controller-501</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      network-manager: Neutron</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  nova-compute:</span><br><span class="line">    charm: local:bionic/nova-compute-133</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - &quot;1&quot;</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      pci-passthrough-whitelist: &apos;[&#123;&quot;devname&quot;:&quot;eno50&quot;, &quot;physical_network&quot;:&quot;physnet1&quot;&#125;]&apos;</span><br><span class="line">      verbose: true</span><br><span class="line">  ntp:</span><br><span class="line">    charm: cs:ntp-41</span><br><span class="line">  rabbitmq-server:</span><br><span class="line">    charm: cs:~openstack-charmers-next/rabbitmq-server-379</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">machines:</span><br><span class="line">  &quot;0&quot;:</span><br><span class="line">    constraints: tags=buneary</span><br><span class="line">  &quot;1&quot;:</span><br><span class="line">    constraints: tags=duduo</span><br><span class="line">  &quot;2&quot;:</span><br><span class="line">    constraints: tags=virtual</span><br><span class="line">    series: bionic</span><br><span class="line">relations:</span><br><span class="line">- - keystone:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - nova-cloud-controller:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - glance:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - neutron-api:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - neutron-openvswitch:neutron-plugin-api</span><br><span class="line">  - neutron-api:neutron-plugin-api</span><br><span class="line">- - neutron-api:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - neutron-api:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - glance:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - glance:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-cloud-controller:image-service</span><br><span class="line">  - glance:image-service</span><br><span class="line">- - nova-cloud-controller:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - neutron-openvswitch:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-cloud-controller:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - nova-cloud-controller:neutron-api</span><br><span class="line">  - neutron-api:neutron-api</span><br><span class="line">- - nova-compute:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-compute:image-service</span><br><span class="line">  - glance:image-service</span><br><span class="line">- - nova-cloud-controller:cloud-compute</span><br><span class="line">  - nova-compute:cloud-compute</span><br><span class="line">- - nova-compute:neutron-plugin</span><br><span class="line">  - neutron-openvswitch:neutron-plugin</span><br><span class="line">- - ntp:juju-info</span><br><span class="line">  - nova-compute:juju-info</span><br></pre></td></tr></table></figure>
<p>2, Upload the image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://api.jujucharms.com/charmstore/v5/openstack-base/archive</span><br><span class="line">source novarc</span><br><span class="line">wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1511.qcow2</span><br><span class="line">glance image-create --name centos --disk-format qcow2 --container-format bare --file ./CentOS-7-x86_64-GenericCloud-1511.qcow2 --progress</span><br></pre></td></tr></table></figure>
<p>3, Create the network<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: can use seg-bundles instead</span><br><span class="line">neutron net-create private --provider:network_type gre --provider:segmentation_id 1012</span><br><span class="line">neutron subnet-create --allocation-pool start=192.168.21.22,end=192.168.21.122 --gateway 192.168.21.1 private 192.168.21.0/24 --enable_dhcp=True --name private_subnet</span><br><span class="line"></span><br><span class="line">neutron net-create ext_net -- --router:external=True --provider:network_type flat --provider:physical_network physnet1</span><br><span class="line">neutron subnet-create --allocation-pool start=10.230.56.100,end=10.230.56.104 --gateway 10.230.56.1 ext_net 10.230.56.100/21 --enable_dhcp=False --name ext_net_subnet</span><br><span class="line"></span><br><span class="line">neutron router-create provider-router</span><br><span class="line">EXT_NET_ID=$(neutron net-list |grep &apos; ext_net &apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">ROUTER_ID=$(neutron router-list |grep &apos; provider-router &apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">SUBNET_ID=$(neutron subnet-list |grep &apos;192.168.21.0/24&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">neutron router-interface-add $ROUTER_ID $SUBNET_ID</span><br><span class="line">neutron router-gateway-set $ROUTER_ID $EXT_NET_ID</span><br><span class="line">#neutron router-gateway-clear provider-router</span><br><span class="line">#neutron router-interface-delete provider-router private_subnet</span><br><span class="line">#nova floating-ip-delete 10.230.56.101</span><br><span class="line">#neutron subnet-delete ext_net_subnet</span><br><span class="line">#neutron subnet-delete private_subnet</span><br><span class="line">#neutron net-delete ext_net</span><br><span class="line">#neutron net-delete private</span><br><span class="line">#neutron router-delete provider-router</span><br></pre></td></tr></table></figure></p>
<p>4, Boot the VM<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">neutron security-group-rule-create --protocol icmp --direction ingress default</span><br><span class="line">neutron security-group-rule-create --protocol tcp --port-range-min 22 --port-range-max 22 --direction ingress default</span><br><span class="line">nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">nova service-list</span><br><span class="line">nova hypervisor-list</span><br><span class="line">nova boot --poll --key-name mykey --image centos --flavor 2 --nic net-id=$(neutron net-list |grep &apos;private&apos; |awk &apos;&#123;print $2&#125;&apos;) --availability-zone nova:node2 i2</span><br><span class="line">nova floating-ip-create</span><br><span class="line">nova floating-ip-associate i2 10.230.56.104</span><br><span class="line">ssh -i mykey centos@10.230.56.104 -v #dd if=/dev/urandom of=/var/tmp/live_mig_test bs=4M count=1000  #~/.local/share/juju/ssh/juju_id_rsa</span><br><span class="line">nova live-migration --block-migrate i2 voltorb</span><br><span class="line">#sudo virsh --connect qemu+ssh://node2/system list</span><br><span class="line">#LIBVIRT_DEBUG=1 virsh migrate --verbose --live --copy-storage-all instance-0000000d qemu+ssh://voltorb/system 2&gt;&amp;1 &gt; debug.log</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/30/Play-with-OVN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/30/Play-with-OVN/" itemprop="url">Play with OVN</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-30T16:06:55+08:00">
                2020-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华  发表于：2019-11-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>OVN is the replacement of Neutron, so we need to have a look at OVN.</p>
<p>Refer - <a href="https://zhhuabj.blog.csdn.net/article/details/42773417" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/42773417</a></p>
<h2 id="Basic-ovn-L2-test"><a href="#Basic-ovn-L2-test" class="headerlink" title="Basic ovn L2 test"></a>Basic ovn L2 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#controller node has ovn-central(northbound and southbound db), but compute node (local ovn-controller) doesn&apos;t have it</span><br><span class="line">sudo apt install -y openvswitch-switch ovn-common ovn-controller-vtep ovn-docker ovn-host ovn-central</span><br><span class="line"></span><br><span class="line">#In controller, enable remote access, tell OVN southbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-sbctl set-connection ptcp:6642</span><br><span class="line">#In controller, for the time being don&apos;t need to tell OVN northbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-nbctl set-connection ptcp:6641</span><br><span class="line">$ netstat -lntp | grep  664</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp        0      0 0.0.0.0:6642            0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:6640          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:6641            0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line">#In controller, create logical switch and ports:</span><br><span class="line">sudo ovn-nbctl ls-add sw</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp1 &quot;00:00:00:00:00:01 10.0.0.1&quot;</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp2</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp2 &quot;00:00:00:00:00:02 10.0.0.2&quot;</span><br><span class="line">sudo ovn-nbctl show</span><br><span class="line"></span><br><span class="line">#In compute node, make ovn-controller connect to southbound db, and create test</span><br><span class="line">#external_ids:ovn-remote=&quot;tcp:&lt;remote-controller-ip&gt;:6642&quot; external_ids:ovn-encap-ip=&lt;my-ip-used-for-endpoint&gt;</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm1&quot;</span><br><span class="line">sudo ip link add sp1_l type veth peer name sp1_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp1_l  #sudo ovs-vsctl add-br br-int -- set Bridge br-int fail-mode=secure</span><br><span class="line">sudo ovs-vsctl set interface sp1_l external_ids:iface-id=sp1</span><br><span class="line">sudo ip link set sp1_l up</span><br><span class="line">sudo ip netns add sp1</span><br><span class="line">sudo ip link set sp1_r netns sp1</span><br><span class="line">sudo ip netns exec sp1 ip link set sp1_r up</span><br><span class="line">sudo ip netns exec sp1 ip addr add 10.0.0.1/24 dev sp1_r</span><br><span class="line">sudo ip netns exec sp1 ip link set dev sp1_r address 00:00:00:00:00:01</span><br><span class="line"></span><br><span class="line">#or run the following command on another machine instead</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm2&quot;</span><br><span class="line">sudo ip link add sp2_l type veth peer name sp2_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp2_l</span><br><span class="line">sudo ovs-vsctl set interface sp2_l external_ids:iface-id=sp2</span><br><span class="line">sudo ip link set sp2_l up</span><br><span class="line">sudo ip netns add sp2</span><br><span class="line">sudo ip link set sp2_r netns sp2</span><br><span class="line">sudo ip netns exec sp2 ip link set sp2_r up</span><br><span class="line">sudo ip netns exec sp2 ip addr add 10.0.0.2/24 dev sp2_r</span><br><span class="line">sudo ip netns exec sp2 ip link set dev sp2_r address 00:00:00:00:00:02</span><br><span class="line"></span><br><span class="line">#test</span><br><span class="line">$ sudo ip netns exec sp1 ping 10.0.0.2 -c 1</span><br><span class="line">PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.318 ms</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch a28291a4-bea9-445f-af0f-cae65c04e9f7 (sw)</span><br><span class="line">    port sp2</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:02 10.0.0.2&quot;]</span><br><span class="line">    port sp1</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:01 10.0.0.1&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-sbctl show</span><br><span class="line">Chassis vm2</span><br><span class="line">    hostname: node1</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: localhost</span><br><span class="line">        options: &#123;csum=&quot;true&quot;&#125;</span><br><span class="line">    Port_Binding sp2</span><br><span class="line">    Port_Binding sp1</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl lsp-del sp1</span><br><span class="line">sudo ovn-nbctl lsp-del sp2</span><br><span class="line">sudo ovn-nbctl ls-del sw</span><br><span class="line">sudo ip netns del sp1</span><br><span class="line">sudo ip netns del sp2</span><br><span class="line">sudo ovs-vsctl del-port br-int sp1_l</span><br><span class="line">sudo ovs-vsctl del-port br-int sp2_l</span><br></pre></td></tr></table></figure>
<h2 id="Basic-ovs-flow-test"><a href="#Basic-ovs-flow-test" class="headerlink" title="Basic ovs flow test"></a>Basic ovs flow test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -itd --name i1 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo docker run -itd --name i2 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo ovs-vsctl add-br br-int</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i1 --ipaddress=192.168.1.2/24</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i2 --ipaddress=192.168.1.3/24</span><br><span class="line">sudo docker exec -it i1 bash</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line">sudo ovs-vsctl list interface d15c80f8359d4_l</span><br><span class="line">#when doing test in the two machines</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.122 options:key=flow</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.123 options:key=flow</span><br><span class="line"></span><br><span class="line">#test 1 - delete flow</span><br><span class="line">$ sudo ovs-ofctl dump-flows br-int</span><br><span class="line"> cookie=0x0, duration=563.338s, table=0, n_packets=6, n_bytes=364, priority=0 actions=NORMAL</span><br><span class="line">sudo ovs-ofctl del-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line"></span><br><span class="line">#test 2 - add flow</span><br><span class="line">$ sudo ovs-vsctl list interface d15c80f8359d4_l |grep ofport</span><br><span class="line">ofport              : 3</span><br><span class="line">$ sudo ovs-vsctl list interface 85023af15d0c4_l |grep ofport</span><br><span class="line">ofport              : 4</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=1,in_port=3,actions=output:4&quot;</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=2,in_port=4,actions=output:3&quot;</span><br><span class="line">sudo ovs-ofctl dump-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br></pre></td></tr></table></figure>
<h2 id="ovn-L3-test"><a href="#ovn-L3-test" class="headerlink" title="ovn L3 test"></a>ovn L3 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#create two vSwitches</span><br><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-port1 &quot;50:54:00:00:00:01 192.168.0.2&quot;</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl ls-add sw1</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 sw1-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw1-port1 &quot;50:54:00:00:00:03 11.0.0.2&quot;</span><br><span class="line"></span><br><span class="line">#create a vRouter, and connect two vSwitches to it</span><br><span class="line">sudo ovn-nbctl lr-add lr0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp0 00:00:00:00:ff:01 192.168.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 lrp0-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp0-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp0-attachment 00:00:00:00:ff:01</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp0-attachment router-port=lrp0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp1 00:00:00:00:ff:02 11.0.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 lrp1-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp1-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp1-attachment 00:00:00:00:ff:02</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp1-attachment router-port=lrp1</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch 25c77c44-9be4-434b-8b38-e325d4c2b044 (sw0)</span><br><span class="line">    port lrp0-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:01&quot;]</span><br><span class="line">        router-port: lrp0</span><br><span class="line">    port sw0-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:01 192.168.0.2&quot;]</span><br><span class="line">switch 0b33e823-577b-4c76-a661-c3bd358624cc (sw1)</span><br><span class="line">    port lrp1-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:02&quot;]</span><br><span class="line">        router-port: lrp1</span><br><span class="line">    port sw1-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:03 11.0.0.2&quot;]</span><br><span class="line">router cd8095b3-287f-4e0c-af3d-a10a089f977c (lr0)</span><br><span class="line">    port lrp1</span><br><span class="line">        mac: &quot;00:00:00:00:ff:02&quot;</span><br><span class="line">        networks: [&quot;11.0.0.1/24&quot;]</span><br><span class="line">    port lrp0</span><br><span class="line">        mac: &quot;00:00:00:00:ff:01&quot;</span><br><span class="line">        networks: [&quot;192.168.0.1/24&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-trace --minimal sw0 &apos;inport == &quot;sw0-port1&quot; &amp;&amp; eth.src == 50:54:00:00:00:01 &amp;&amp; ip4.src == 192.168.0.2 &amp;&amp; eth.dst == 00:00:00:00:ff:01 &amp;&amp; ip4.dst == 11.0.0.2 &amp;&amp; ip.ttl == 64&apos;</span><br><span class="line"># ip,reg14=0x1,vlan_tci=0x0000,dl_src=50:54:00:00:00:01,dl_dst=00:00:00:00:ff:01,nw_src=192.168.0.2,nw_dst=11.0.0.2,nw_proto=0,nw_tos=0,nw_ecn=0,nw_ttl=64</span><br><span class="line">ip.ttl--;</span><br><span class="line">eth.src = 00:00:00:00:ff:02;</span><br><span class="line">eth.dst = 50:54:00:00:00:03;</span><br><span class="line">output(&quot;sw1-port1&quot;);</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl ls-del sw0</span><br><span class="line">sudo ovn-nbctl ls-del sw1</span><br><span class="line">sudo ovn-nbctl lr-del lr0</span><br></pre></td></tr></table></figure>
<p>其他见文档　OVN Routing and ovn-trace　－　<a href="http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/" target="_blank" rel="external">http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/</a></p>
<h2 id="ovn-dhcp"><a href="#ovn-dhcp" class="headerlink" title="ovn dhcp"></a>ovn dhcp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#create dhcp port</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-dhcpport</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">#sudo ovn-nbctl lsp-set-port-security sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">options=&quot;$(sudo ovn-nbctl create DHCP_Options cidr=192.168.0.0/24 \</span><br><span class="line">options=&quot;\&quot;server_id\&quot;=\&quot;192.168.0.10\&quot; \&quot;server_mac\&quot;=\&quot;02:ac:10:ff:01:29\&quot; \</span><br><span class="line">\&quot;lease_time\&quot;=\&quot;3600\&quot; \&quot;router\&quot;=\&quot;192.168.0.10\&quot;&quot;)&quot;</span><br><span class="line">echo &quot;DHCP options is: &quot; $options</span><br><span class="line">sudo ovn-nbctl lsp-set-dhcpv4-options sw0-dhcpport $options</span><br><span class="line">sudo ovn-nbctl dhcp-options-list</span><br><span class="line">sudo ovn-nbctl lsp-get-dhcpv4-options sw0-dhcpport</span><br><span class="line"></span><br><span class="line">#create test vm</span><br><span class="line">sudo ip netns add nsi3</span><br><span class="line">sudo ovs-vsctl add-port br-int i3 -- set interface i3 type=internal</span><br><span class="line">sudo ip link set i3 address 02:ac:10:ff:01:30</span><br><span class="line">sudo ip link set i3 netns nsi3</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=sw0-i3</span><br><span class="line"></span><br><span class="line">#get ip address via dhcp</span><br><span class="line">sudo ip netns exec nsi3 dhclient i3</span><br><span class="line">sudo ip netns exec nsi3 ip addr show i3</span><br><span class="line">sudo ip netns exec nsi3 ip route show</span><br></pre></td></tr></table></figure>
<h2 id="OVN-vRouter"><a href="#OVN-vRouter" class="headerlink" title="OVN vRouter"></a>OVN vRouter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 outs-wan</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses outs-wan unknown</span><br><span class="line">sudo ovn-nbctl lsp-set-type outs-wan localnet</span><br><span class="line">sudo ovn-nbctl lsp-set-options outs-wan network_name=wanNet</span><br><span class="line"></span><br><span class="line">sudo ovs-vsctl add-br br-eth</span><br><span class="line">sudo ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=wanNet:br-eth</span><br><span class="line">sudo ovs-vsctl add-port br-eth eth0</span><br><span class="line">sudo ip link set br-eth up</span><br><span class="line">sudo ip addr add 192.168.66.111/23 dev br-eth</span><br><span class="line"></span><br><span class="line">#associated VM&apos;s port to bridge</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=i3</span><br></pre></td></tr></table></figure>
<h2 id="OVN-SNAT-DNAT"><a href="#OVN-SNAT-DNAT" class="headerlink" title="OVN SNAT/DNAT"></a>OVN SNAT/DNAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#fixed-ip: 10.0.1.103  FIP: 192.168.99.122</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;snat&quot; logical_ip=10.0.1.0/24 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;dnat_and_snat&quot; logical_ip=10.0.1.103 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br></pre></td></tr></table></figure>
<h2 id="一个问题，如何从ovn网关ping其他机器"><a href="#一个问题，如何从ovn网关ping其他机器" class="headerlink" title="一个问题，如何从ovn网关ping其他机器"></a>一个问题，如何从ovn网关ping其他机器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">如下，以前non-ovn环境下，可以从l3-agent上的qrouter-xxx上通过GW(192.168.21.1)来ping servic vm IP (192.168.21.39), 但现在ovn情况下无namespace了，该如何来做这件事呢？</span><br><span class="line">router ca47f4c3-3379-475a-ab80-fac4062e0a3e (neutron-ab4310a3-09b9-4638-8f7c-3873bc9b4c47) (aka provider-router)</span><br><span class="line">    port lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        mac: &quot;fa:16:3e:0e:f8:f5&quot;</span><br><span class="line">        networks: [&quot;192.168.21.1/24&quot;]</span><br><span class="line">    ...</span><br><span class="line">switch a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 (neutron-0f409568-561e-4e33-89ea-2814faa44add) (aka private)</span><br><span class="line">    port 3f382ff5-7601-4bec-a687-e964adadefc2</span><br><span class="line">        addresses: [&quot;fa:16:3e:f1:fa:a5 192.168.21.237&quot;]</span><br><span class="line">    port 38d6c6f7-8a64-406d-94bb-c550eb50427d</span><br><span class="line">        type: localport</span><br><span class="line">        addresses: [&quot;fa:16:3e:8d:0b:5b 192.168.21.2&quot;]</span><br><span class="line">    port c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        type: router</span><br><span class="line">        router-port: lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">    port 18ce4590-453a-4152-97b9-eafb3523047d (aka octavia-lb-6058a336-3922-468f-9f70-8e34bd14e195)</span><br><span class="line">        type: virtual</span><br><span class="line">        addresses: [&quot;fa:16:3e:ce:84:fd 192.168.21.39&quot;]</span><br><span class="line"></span><br><span class="line">这样，来做一个pingvm</span><br><span class="line">sudo ovn-nbctl lsp-add a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 pingvm</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses pingvm &quot;40:44:00:00:00:01 192.168.21.122&quot;</span><br><span class="line"></span><br><span class="line">在计算节点中继续：</span><br><span class="line">sudo ovs-vsctl add-port br-int pingvm -- set Interface pingvm type=internal -- set Interface pingvm external_ids:iface-id=pingvm</span><br><span class="line">sudo ip netns add pingvm</span><br><span class="line">sudo ip link set pingvm netns pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm address 40:44:00:00:00:01</span><br><span class="line">sudo ip netns exec pingvm ip addr add 192.168.21.122/24 dev pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm up</span><br><span class="line">sudo ip netns exec pingvm ip route add default via 192.168.21.1</span><br><span class="line"></span><br><span class="line">测试, 上面实验可能ping不了，因为应该用octavia的管理IP，但这不妨碍，思路如此．</span><br><span class="line">sudo ip netns exec pingvm ping 192.168.21.39</span><br><span class="line">sudo ip netns exec pingvm ssh 192.168.21.39</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/28/ssh总断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/28/ssh总断/" itemprop="url">ssh总断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-28T19:43:30+08:00">
                2020-10-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>公司服务器今天升级了，结果遇到了一个问题，登录在该服务器上的bastion虚机在运行 一个名为configure的脚本的下列代码时总是中断．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">set_img_properties ()</span><br><span class="line">&#123;</span><br><span class="line">    img_name=$1</span><br><span class="line">    img_version=$2</span><br><span class="line">    img_file=$3</span><br><span class="line"></span><br><span class="line">    ts=`stat ~/images/$img_file| sed -rn &apos;s/Modify:\s+([[:digit:]-]+)\s+.+/\1/p&apos;| tr -d &apos;-&apos;`</span><br><span class="line">    declare -A props=( [architecture]=x86_64</span><br><span class="line">                       [os_distro]=&apos;ubuntu&apos;</span><br><span class="line">                       [os_version]=$img_version</span><br><span class="line">                       [version_name]=&quot;$ts&quot;</span><br><span class="line">                       [product_name]=&quot;com.ubuntu.cloud:server:$&#123;img_version&#125;:amd64&quot;</span><br><span class="line">    )</span><br><span class="line">    for p in $&#123;!props[@]&#125;; do</span><br><span class="line">      openstack image set --property $p=$&#123;props[$p]&#125; $img_name &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br></pre></td></tr></table></figure></p>
<p>ssh中断之后，只能重启bastion才能解决．<br>因为一直没有问题，只是今天服务器升级才遇到问题，所以没想别的，只是要求同事也测了一下，他没遇到问题．<br>接着，以为是mtu问题，将mtu从8930改为1450依旧有问题．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 ping -O -M do -s 8930 10.5.0.8</span><br><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 nc -vz 10.5.0.8 22</span><br></pre></td></tr></table></figure></p>
<p>所以就以为是底层openstack有问题，但我没有底层openstack的管理权限，所以只好找有权限的同事帮忙，最后确定没有这方面的问题．<br>最后，就是怀疑bastion这台虚机有问题了．发现里面什么时候安装了devstack，删除devstack后，正常了．<br>但为什么之前一又没问题呢？在有devstack的情况下，代码作下列更改问题也消失．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img</span><br></pre></td></tr></table></figure></p>
<p>devstack这些东西不要乱在机器上装啊，习惯要好．上了一大课．</p>
<p>另外，如果ssh连接慢的话，可以尝试在sshd.conf中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UseDNS no</span><br><span class="line">GSSAPIAuthentication no</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/如何将国外的ftp气象大数据下载回来/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/22/如何将国外的ftp气象大数据下载回来/" itemprop="url">如何将国外的ftp气象大数据下载回来</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-22T20:49:19+08:00">
                2020-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>由于运营商对non-http流量限速，从国外ftp下载大数据将变得异常艰难．目前采用的方法如下：</p>
<p>1, 国外虚机上安装curlftpfs将ftp站点镜像到/mnt/ftp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curlftpfs -y</span><br><span class="line">#sudo fusermount -zu /mnt/ftp</span><br><span class="line">sudo mkdir -p /mnt/ftp &amp;&amp; sudo chown -R $USER /mnt/ftp</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt;/etc/fstab&apos; &lt;&lt;EOF</span><br><span class="line">curlftpfs#@ftp.hycom.org/datasets/global/GLBa0.08_rect/data /mnt/ftp fuse defaults,rw,allow_other,uid=1000,gid=1000,_netdev 0 0</span><br><span class="line">EOF</span><br><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure></p>
<p>2, 安装nginx指向/mnt/ftp将ftp变http<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx -y</span><br><span class="line">sudo vim /etc/nginx/sites-available/default</span><br><span class="line">        #root /var/www/html;</span><br><span class="line">        root /mnt/ftp;</span><br><span class="line">        location / &#123;</span><br><span class="line">                try_files $uri $uri/ =404;</span><br><span class="line">                autoindex on;</span><br><span class="line">                autoindex_exact_size off;</span><br><span class="line">                autoindex_localtime on;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>3, 国内采用下列命令下载．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -c -m http://3.18.xx.xx</span><br><span class="line">#rsync -avztur -e &quot;ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.aws/xxx.pem&quot; --progress ubuntu@3.18.xx.xx:/mnt/ftp .</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/14/Lost-connection-to-MySQL-server-during-query/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/14/Lost-connection-to-MySQL-server-during-query/" itemprop="url">Lost connection to MySQL server during query</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-14T13:37:44+08:00">
                2020-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-11-06)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>neutron designate日志中发现错误”Got lower serial for”, 并且创建zone时永远停留在PENDING状态.</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>minidns中看到下列日志:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var/log/designate/designate-mdns.log.2.gz:2018-10-23 23:27:36.016 94713 INFO designate.mdns.handler [req-26d8910d-61d5-4fd6-bc6b-df7acaf36c12 - - - - -] NotFound, refusing. Question was xxx.openstack-au-east-2.oc.xxx.com. IN SOA</span><br><span class="line">var/log/designate/designate-mdns.log.2.gz:2018-10-23 23:27:36.024 94713 WARNING designate.mdns.handler [req-fa5518dd-9506-44f8-a2ee-ee7d79ffaa3c - - - - -] ZoneNotFound while handling axfr request. Question was xxx.openstack-au-east-2.oc.xxx.com. IN AXFR: ZoneNotFound: Could not find Zone</span><br></pre></td></tr></table></figure></p>
<p>根据代码[1], 查询DB时报ZoneNotFound从而导致无法构建SOA无法构建axfr response, 从而导致minidns master与bind9 slave无法做zone transfer, 这样导致bind9 slave的serial number也无法更新, 最终在minidns notify时看到”Got lower serial for”</p>
<p>在发生ZoneNotFound的附近有下列日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[req-b48612b0-ed3e-46d9-8510-6634282ef0a2 - - - - -] Database connection was found disconnected; reconnecting: DBConnectionError: (pymysql.err.OperationalError) (2013, &apos;Lost connection to MySQL server during query&apos;) [SQL: u&apos;SELECT 1&apos;]</span><br></pre></td></tr></table></figure>
<p>于是, 用下列测试程序重现了上述DB error,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">from sqlalchemy.engine import create_engine</span><br><span class="line">url = &apos;mysql+pymysql://root@127.0.0.1:3306/mysql&apos;</span><br><span class="line">engine = create_engine(url, pool_recycle=4).connect()</span><br><span class="line">query = &apos;SELECT NOW();&apos;</span><br><span class="line">while True:</span><br><span class="line">    print(&apos;Q1&apos;, engine.execute(query).fetchall())</span><br><span class="line">    engine.execute(&apos;SET wait_timeout=2&apos;)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    print(&apos;Q2&apos;, engine.execute(query).fetchall())</span><br></pre></td></tr></table></figure>
<p>或者使用oslo.db测试程序:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p -e &quot;SET GLOBAL wait_timeout=5, slow_query_log=on, long_query_time=0.0;&quot;</span><br><span class="line"></span><br><span class="line">$ cat test.py</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">from oslo_config import cfg</span><br><span class="line">from oslo_db import options as db_options</span><br><span class="line">from oslo_db.sqlalchemy import session as db_session</span><br><span class="line">from sqlalchemy.sql.expression import select</span><br><span class="line">_facade = db_session.EngineFacade(&quot;mysql://root@localhost/test&quot;)</span><br><span class="line">x = _facade.get_session()</span><br><span class="line">print(x.scalar(select([23])))</span><br><span class="line">time.sleep(5)</span><br><span class="line">print(x.scalar(select([23])))</span><br></pre></td></tr></table></figure></p>
<p>连接线的过期时间(pool_recycle, 连接池里的连接空闲一段时间后自动释放, oslo中默认是3600)不能大于服务器端的wait_timeout时间(这里是2, 默认是8小时). 所以应该设置wait_timeout大于3600, 或者haproxy中的配置大于3600.<br>wait_timeout是mysql的一个设置，主要是用来断开不使用的数据库连接。当连接空闲的时间达到wait_timeout设置的最大值时，mysql会主动切断这个连接，以供别的客户端连接数据库。这个值一般是28800，也就是8小时。在mysql中可以通过： show variables like “%timeout%”;获取。<br>另外，当数据库主动切断连接的时候，mysql客户端并不知道这个连接已经被切断，所以程序并不知道其已经无效了，如果mysql客户端再不支持ReConnect，双重的问题叠加在一起就会导致连接池返回无效连接的可能.</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p> mysqldump –single-transaction -u root -p designate –skip-extended-insert &gt; /tmp/designate-$(date +%s).sql</p>
<p>For the error ‘Lost connection to MySQL server during query’,</p>
<p>wait_timeout is a setting of mysql, which is used for server side to disconnect unused client connections proactively. The default is 8 hours(28800), we can check it by ‘show variables like “%timeout%”;’ or ‘juju config mysql wait-timeout’</p>
<p>All the rest of the timeout below should be less than wait_timeout, if they are greater than wait_timeout, the error ‘Lost connection to MySQL server during query’ will happen.<br>1, the default value of olso’s connection_recycle_time is 3600<br>2, the timeout in haproxy.cfg</p>
<p>So we need to collect the following info for further analyses.</p>
<p>1, juju config mysql wait-timeout<br>2, mysql -unova -p -h<mysql_ip> -e ‘show variables like “%timeout%”‘  #eg: run it in nova-cloud-controller/0<br>3, juju ssh neutron-api/0 – sudo grep -r ‘connection_recycle_time’ /etc/neutron/<br>4, juju ssh neutron-api/0 – sudo grep -r ‘timeout’ /etc/haproxy/</mysql_ip></p>
<h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#This will show which openstack service is using the most mysql connections</span><br><span class="line">select user, count(*) from information_schema.processlist group by user;</span><br><span class="line"></span><br><span class="line">juju run --application mysql leader-get</span><br><span class="line">juju run --application mysql &quot;mysql -uroot -pChangeMe123 -e \&quot;SELECT IFNULL(usr,&apos;All Users&apos;) user,IFNULL(hst,&apos;All Hosts&apos;) host,COUNT(1) Connections FROM (SELECT user usr,LEFT(host,LOCATE(&apos;:&apos;,host) - 1) hst FROM information_schema.processlist WHERE user NOT IN (&apos;system user&apos;,&apos;root&apos;)) A GROUP BY usr,hst WITH ROLLUP;\&quot;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><p>openstack的各服务都有大量的这种错误：<br>var/log/mysql/error.log:2019-08-29T16:07:45.335406Z 420821 [Note] Aborted connection 420821 to db: ‘keystone’ user: ‘keystone’ host: ‘10.191.5.49’ (Got timeout reading communication packets)</p>
<p>要求客户增大了connect_timeout, net_read_timeout, net_write_timeout, interactive_timeout后使用‘show global status like ‘aborted%’;’看到Aborted_clients的数目仍在增大<br>show global variables like ‘max_conn%’;<br>show global variables like ‘%timeout%’;<br>show global status like ‘aborted%’;<br>show processlist;</p>
<p>这时发现在21:55:48， 所有的designate serveres都收到了mysql错误， 通过mysql的查询日志找到21:04到21:16之间mysql收到了40个gnocchi查询，一个查询就要返回500MB的大小, 然后看到了警告：InnoDB: Warning: difficult to find free blocks in the buffer pool (338 search iterations)!”<br>所以看起来像是IO swamp的问题进而造成查询超时。解决方法：<br>1， 增加innodb_buffer_pool_size (juju中通过dataset-size控制）<br>2, 删除gnocchi中的相关数据<br>3, 调查designate中当遇到mysql超时时是不是会反复retry造成对DB的flood</p>
<h2 id="20201014更新"><a href="#20201014更新" class="headerlink" title="20201014更新"></a>20201014更新</h2><p>amphora-agent writes heatbeat to udp, then octavia-health-manager gets heatbeat from udp and writes them to DB, finally health_manager gets heartbeat from DB via get_stale_amphora to decide if failover process will be started</p>
<p>当health-manager线程的数目(pgrep -af /usr/bin/octavia-health-manager | wc -l, 160)大于mysql的连接数时(ss -tp | grep -c :mysql, 90)时上面的get_stale_amphora就会报”Lost connection to MySQL server during query”错误(排除wait-timeout!=3600这个因素之后),<br>sqlalchemy看到这个错误后就会reconnect, 从而产生下面提到的”QueuePool limit of size 10 overflow 20 reached, connection timed out, timeout 10”这个错误(<a href="http://sqlalche.me/e/3o7r" target="_blank" rel="external">http://sqlalche.me/e/3o7r</a>). sqlalchemy’s reconnect可能不是replace, 而是删除老连接然后建立新连接, 这次当达到max_pool_size+max_overflow=20个连接后永远无新连接供它reconnect(sqlalchemy使用max_pool_size=10, 当一次使用多于5时, 会用到默认的max_overflow=10这样可以达到15个连接, 但多于20个后不再允许溢出.), 这可能是一个bug - <a href="https://github.com/sqlalchemy/sqlalchemy/issues/5308" target="_blank" rel="external">https://github.com/sqlalchemy/sqlalchemy/issues/5308</a></p>
<p>可能在mysql在做failover时会出现这种情况, 因为new VIP owner没有old TCP connections从而导致之后的old TCP connections to go stale从而导致reconnect.</p>
<p>可能的解决方法:<br>1, 如果mysql不再failover的话可能这个问题也不再重启了, 这个可以等下列fix<br>2, as a base leve request a stable backport for the following patch<br>health-manager的eventlet/greenlet的数目由health_update_threads参数决定, 默认与CPU核数同, 大多数情况下都是短连接会多路复用还没问题, 但有时候也会各种因素让有的变成长连接. charm中一般对于worker threads有0.25x的乘数(LXD容器中最大是4), octavia-charm也应该用这个乘数来减小worker threads的数目 - <a href="https://bugs.launchpad.net/charm-octavia/+bug/1889731" target="_blank" rel="external">https://bugs.launchpad.net/charm-octavia/+bug/1889731</a><br>3, We could additionally reconfigure the oslo.db [database] section to include a pool overflow limit at least as large as the number of expected threads by worker-multiplier<br>4, We could additionally open a bug against sqlalchemy that it should allow for connection replacement even when the pool limit is reached</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://github.com/openstack/designate/blob/stable/queens/designate/mdns/handler.py#L233" target="_blank" rel="external">https://github.com/openstack/designate/blob/stable/queens/designate/mdns/handler.py#L233</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/29/UEFI-Secure-Boot学习草稿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/29/UEFI-Secure-Boot学习草稿/" itemprop="url">UEFI Secure Boot学习草稿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-29T19:17:27+08:00">
                2020-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-29<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="什么是secure-boot"><a href="#什么是secure-boot" class="headerlink" title="什么是secure boot"></a>什么是secure boot</h2><p>secureboot is designed to present non-Windows OS from booting(Secure Boot works by placing the root of trust in firmware), you can still boot Grub2 with secureboot using shim and MOK manager. And from grub2, you can boot into other operating systems.也就是说:<br>secureboot将根证书放在固件firmware中, 然后可以验证signed bootloader, signed bootloader然后再验证signed kernel和signed 2nd stage boot loader.这样系统允许你修改secureboot keys.</p>
<ul>
<li>db, 允许bootloaders的公钥集合</li>
<li>dbx, 不允许bootloaders的公钥集合</li>
<li>KEK, 允许操作db的公钥集合</li>
<li>PK, 允许操作KEK的私钥.</li>
</ul>
<p>默认地, 系统有硬件制造商的PK, microsoft和硬件制造商的公钥在db与KEK里. 这样就可以使用microsoft-certified bootloaders, 再通过它签名的shim来使用其他linuxers. 有的UEFI BIOS setup允许adding and delteing所有的secureboot keys, 而有些却允许你要么删除所有要么用默认(删除之前记得备份哦). 如果PK被删除的话, secure boot这时叫so-called setup mode. 你可能想有这个密钥:<br>the db set should contain:</p>
<ul>
<li>your own public key certificate, for booting things you’ve explicitly signed</li>
<li>maybe your favorite Linux distribution’s kernel signing certificate, if you want to use pre-packaged kernels without manually re-signing them</li>
<li>maybe hardware vendor’s certificate, to allow installing firmware updates if necessary maybe Microsoft’s third-party UEFI certificate, to allow the use of pre-packaged Linux bootloaders and live Linux boot media without explicitly re-signing them or disabling Secure Boot</li>
<li>maybe Microsoft’s OS signing certificate, if you dual-boot with Windows</li>
</ul>
<p>the KEK set should contain:</p>
<ul>
<li>your own certificate, for updating db and dbx</li>
<li>if your system includes UEFI-aware Microsoft OSs, you may want to include Microsoft’s KEK certificate, as Microsoft’s updates sometimes include updates to db and/or dbx and those updates won’t install successfully if access to Secure Boot is denied</li>
<li>and finally, once all the rest is set up as you want, you should place your own certificate into PK to make Secure Boot effective again.</li>
</ul>
<h2 id="有无shim"><a href="#有无shim" class="headerlink" title="有无shim"></a>有无shim</h2><p>bootloader有两种, shim与grub2都叫bootloader, 所以理论上是可以不需要shim的, 但为什么需要shim呢? 这个网页(<a href="https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only)说:grub" target="_blank" rel="external">https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only)说:grub</a> uses firmware API to validate binary signatures; you might prefer shim instead of signing the binaries with the “precious” key each time.</p>
<p>非secureboot模式下, 没有shim组件, efi直接启动grub2.<br>在secureboot模式下, 有shim组件, 且shim需要使用efi中的证书签名(grub2和kernel的签名不一定非要用efi中的证书, 可以自己随意定制后再使用shim相关工具导入nvram中). 即使在secureboot模式下也可以有shim和无shim:</p>
<ul>
<li>无shim, 在centos中可以跳过shim, 直接让efi启动grub2也是没问题的, 但grub2与kernel都需要使用efi中的证书签名, 由efi进行grub2与kernel的校验.</li>
<li>有shim, grub2中用户选择kernel后, grub2回调shim组件校验kernel(grub2, kernel使用相同的私钥签名)</li>
</ul>
<h2 id="可信问题"><a href="#可信问题" class="headerlink" title="可信问题"></a>可信问题</h2><ul>
<li>initrd和intrd加载的模式都是不可信的, 这部分都没有经过签名;</li>
<li>systemtap, kexec, kdump也都是没有签名的;</li>
<li>第三方KO模式没有签名(正常情况下, 模块需要使用mok签名, shim来验证)</li>
</ul>
<h2 id="secureboot启动流程"><a href="#secureboot启动流程" class="headerlink" title="secureboot启动流程"></a>secureboot启动流程</h2><p>1, 打开电源, 先运行Secure Boot-capable UEFI firmware (对于qemu虚机, 这个secureboot capable UEFI OVMF firmware叫UEFI x86_64 : usr/share/OVMF/OVMF_CODE.fd,  (sudo apt install ovmf &amp;&amp; sudo systemctl restart libvirtd)</p>
<p>2, firware验证bootloader的签名. UEFI firmware中预先在NVRAM系统中(或者compiled-in defaults)集成了一些公钥集合(secure boot key sets) , 它可以给bootloader验证签名(shim or grub2), 不使用shim的话, grub2得每次调用firware api去验证签名.</p>
<p>UEFI firmware uses /boot/efi/EFI/BOOT/BOOTX64.EFI (从md5sum看它和/boot/efi/EFI/centos/shimx64.efi是同一个文件,  对于shim就是将shimx64.efi拷贝到BOOTX64.EFI, 对于grub2可能就是将grubx64.efi拷贝到BOOTX64.EFI了) to boot at the first stage.</p>
<p>[root@test2 ~]# md5sum /boot/efi/EFI/BOOT/BOOTX64.EFI<br>25d9ccc49c419d76324a29615e8371c2  /boot/efi/EFI/BOOT/BOOTX64.EFI<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/shimx64.efi<br>25d9ccc49c419d76324a29615e8371c2  /boot/efi/EFI/centos/shimx64.efi<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/shimx64-centos.efi<br>d435494a957479acac3aca09915c21d1  /boot/efi/EFI/centos/shimx64-centos.efi<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/grubx64.efi<br>031b972f3ab267f37e01ada73f4b480d  /boot/efi/EFI/centos/grubx64.efi</p>
<p>3, bootloader再去验证kernel的签名.</p>
<p>then shim will load grub2 (/boot/efi/EFI/centos/grubx64.efi) in the second stage</p>
<p>4, kernel再去验证module的签名.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://wiki.ubuntu.com/UEFI/SecureBoot/Testing?action=show&amp;redirect=SecurityTeam%2FSecureBoot" target="_blank" rel="external">https://wiki.ubuntu.com/UEFI/SecureBoot/Testing?action=show&amp;redirect=SecurityTeam%2FSecureBoot</a><br>[2] <a href="https://www.aioboot.com/en/secure-boot/" target="_blank" rel="external">https://www.aioboot.com/en/secure-boot/</a><br>[3] <a href="https://specs.openstack.org/openstack/nova-specs/specs/train/approved/allow-secure-boot-for-qemu-kvm-guests.html" target="_blank" rel="external">https://specs.openstack.org/openstack/nova-specs/specs/train/approved/allow-secure-boot-for-qemu-kvm-guests.html</a><br>[4] Grub 2：拯救你的 bootloader, <a href="https://linux.cn/article-6892-1.html?pr" target="_blank" rel="external">https://linux.cn/article-6892-1.html?pr</a><br>[5] <a href="https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only" target="_blank" rel="external">https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/18/引入nova-placement之后对调度的影响/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/18/引入nova-placement之后对调度的影响/" itemprop="url">引入nova placement之后对调度的影响</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-18T15:33:22+08:00">
                2020-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-17<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="nova-cell-v2"><a href="#nova-cell-v2" class="headerlink" title="nova cell v2"></a>nova cell v2</h2><p>nova cell v2将nova db分成了3个(nova, nova_api, nova_cell0，虚机信息只存储在所在的cell中，公共数据存储在nova_api库中), nova_api中的3个表(nova_api.host_mappings, nova_api.instance_mappings, nova_api.cell_mappings可以直接从instance找到cell_id进而找到DB与MQ的信息，这样nova-api直接就可以操作该cell之类的DB与MQ从而可以让nova-compute可以水平扩展到更多的物理节点，另一方面，nova-api节点也不再需要nova-cell服务，要有nova-api与nova-scheduler两个服务即可．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; pager less -S</span><br><span class="line">PAGER set to &apos;less -S&apos;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">mysql&gt; select instance_uuid,cell_id from instance_mappings;</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| instance_uuid                        | cell_id |</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| 4039ed4e-d0a1-46ba-99a5-68bc84421b42 |       2 |</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from host_mappings;</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| created_at          | updated_at | id | cell_id | host                                |</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| 2020-09-16 06:18:26 | NULL       |  1 |       2 | juju-3ba760-ceilometer-15.cloud.sts |</span><br><span class="line"></span><br><span class="line">mysql&gt; select transport_url,name,database_connection from cell_mappings;</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| transport_url                                                                                            | name  | database_connection                                                         |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| none:///                                                                                                 | cell0 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova_cell0 |</span><br><span class="line">| rabbit://nova:wSz5LjscfBqKnhVWKBZnrXdwS5Kz6TByz9jKfm2xKHbCRYPPSbcnqFwPTnCp8VpP@10.5.0.199:5672/openstack | cell1 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova       |</span><br></pre></td></tr></table></figure>
<p>所以当遇到这种错误时:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br><span class="line">No server with a name or ID of 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nova-manage cell_v2 list_cells</span><br><span class="line">sudo nova-manage cell_v2 map_instances --cell_uuid &lt;cell-id-from-above&gt;</span><br><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure>
<h2 id="nova-placement-API"><a href="#nova-placement-API" class="headerlink" title="nova placement API"></a>nova placement API</h2><p>nova placement API在Newton被引入, nova-scheduler调用placement-api用于调度. 主要用于跟踪记录Resource Provider(compute-node, external storage-pool, external ip-allocation-pool etc)的Inventory和Usage.自Pike版本, 必须启用Placement API来辅助nova-scheduler service进行compute node调度，并以此替代之前的RAMFilter、CoreFilter和DiskFilter。概念对象如下:</p>
<ul>
<li>Resource Class, 资源种类, placement api默认实现了DISK_GB, MEMORY_MB,VCPU三种标准resource classes, 也提供了custom resource classes的接口.</li>
<li>Resource Providers：资源提供者，实际提供资源的对象，例如：compute node、storage pool</li>
<li>Inventory：资源清单，资源提供者所拥有的资源清单，例如：compute node 拥有的vCPU、Disk、RAM 等 inventories</li>
<li>Resource Allocations：资源分配状况，包含了Resource Class、Resource Provider以及Consumer 的映射关系。记录消费者使用了多少该类型的资源数量</li>
<li>Provider Aggregate：资源聚合，类似 HostAggregate 的概念</li>
<li>Traits：资源特征，不同资源提供者可能会具有不同的资源特征。Traits 作为资源提供者特征的描述，它不能够被消费，但在某些Workflow 或者会需要这些信息。例如：标识可用的Disk是一个SSD，可以帮助Scheduler更好的匹配 instance boot请求。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from resource_providers;</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| created_at          | updated_at          | id | uuid                                 | name                                | generation | can_host | root_provider_id | parent_provider_id |</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | 2020-09-16 10:19:33 |  1 | a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |     NULL |                1 |               NULL |</span><br><span class="line"></span><br><span class="line"># for the field resource_class_id, 0 means VCPU, 1 means MEMORY_MB, 2 means DISK_GB</span><br><span class="line">mysql&gt; select * from inventories;</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | resource_class_id | total | reserved | min_unit | max_unit | step_size | allocation_ratio |</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  1 |                    1 |                 0 |     2 |        0 |        1 |        2 |         1 |               16 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  2 |                    1 |                 1 |  3944 |      512 |        1 |     3944 |         1 |              1.5 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  3 |                    1 |                 2 |    38 |        0 |        1 |       38 |         1 |                1 |</span><br><span class="line">mysql&gt; select * from allocations;</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | consumer_id                          | resource_class_id | used |</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 16 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 2 |    1 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 17 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 1 |   64 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 18 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 0 |    1 |</span><br></pre></td></tr></table></figure>
<h2 id="Placement-CLI"><a href="#Placement-CLI" class="headerlink" title="Placement CLI"></a>Placement CLI</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-osc-placement -y</span><br><span class="line"></span><br><span class="line">$ openstack resource provider list</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| uuid                                 | name                                | generation |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">$  openstack resource provider inventory list a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| resource_class | allocation_ratio | min_unit | max_unit | reserved | step_size | total |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| VCPU           |             16.0 |        1 |        2 |        0 |         1 |     2 |</span><br><span class="line">| MEMORY_MB      |              1.5 |        1 |     3944 |      512 |         1 |  3944 |</span><br><span class="line">| DISK_GB        |              1.0 |        1 |       38 |        0 |         1 |    38 |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line"></span><br><span class="line">$ openstack resource provider usage show a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+-------+</span><br><span class="line">| resource_class | usage |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| VCPU           |     3 |</span><br><span class="line">| MEMORY_MB      |   192 |</span><br><span class="line">| DISK_GB        |     3 |</span><br><span class="line">+----------------+-------+</span><br></pre></td></tr></table></figure>
<h2 id="one-bug"><a href="#one-bug" class="headerlink" title="one bug"></a>one bug</h2><p>例如, 如<a href="https://bugs.launchpad.net/nova/+bug/1679750描述的场景" target="_blank" rel="external">https://bugs.launchpad.net/nova/+bug/1679750描述的场景</a>, 在hostA上创建一虚机,hostA死掉了, 这时删除虚机时无法删除实例(因为nova-compute这时死掉了啊), 这样会导致allocations表中的记录没有被删除. 如果hostA又起来了, nova-compute的init_host-&gt;_complete_partial_deletion<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre_start_hook -&gt; update_available_resource -&gt; nova/compute/manager.py#update_available_resource_for_node -&gt; update_available_resource -&gt; _update_available_resource -&gt; _remove_deleted_instances_allocations</span><br></pre></td></tr></table></figure></p>
<p>当把一个nova-compute删除时，删了service和compute_node表记录后,却没有删除placement resource provider和host mapping records.<br>nova-compute自己都死了它是没法自己删自己的,所以改由nova-api在启动时在删除instances时也删除allocations表中的记录 -<br><a href="https://review.opendev.org/#/c/580498/" target="_blank" rel="external">https://review.opendev.org/#/c/580498/</a></p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * nova_api.from host_mappings;</span><br><span class="line">select * from nova_api.cell_mappings;</span><br><span class="line">select * from nova_api.resource_providers where name like &apos;%xxx%&apos;;   xx.bos01.xxx (9)</span><br><span class="line">select * from nova.compute_nodes where host like &apos;%bagon%&apos; or hypervisor_hostname like &apos;%xxx%&apos;;</span><br><span class="line">select * from nova_api.inventories where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;);</span><br><span class="line">select * from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;) order by consumer_id,resource_provider_id,resource_class_id;</span><br><span class="line">select uuid, host, node, vcpus, memory_mb, vm_state, power_state, task_state, root_gb, ephemeral_gb, cell_name,deleted from nova.instances where uuid in (select consumer_id from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;)) order by uuid;</span><br></pre></td></tr></table></figure>
<h2 id="20201230更新-another-bug"><a href="#20201230更新-another-bug" class="headerlink" title="20201230更新 - another bug"></a>20201230更新 - another bug</h2><p>“select numa_topology from nova.compute_nodes where hypervisor_hostname=’cloud3.xxx.com’\G”显示cell0上的pinned_cpus将所有CPU全用完了导致nova-schedule无法继续调度报“Filter NUMATopologyFilter returned 0 hosts”这种错。<br>下面代码分析显示周期性的update_available_resource本来是可以自动修改数据库记录的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre_start_hook -&gt; update_available_resource -&gt; _update_available_resource -&gt; _update_usage_from_instances -&gt; _update_usage_from_instance -&gt; _update_usage -&gt; numa_usage_from_instance_numa</span><br></pre></td></tr></table></figure></p>
<p>从数据库拿出host_cell.pinned_cpus作为pinned_cpus的初始值，特别要注意：host_cell.pinned_cpus并不是直接从数据库取的，它通过运行下列的self._copy_resources(cn, resources)方法实际上让host_cell.pinned_cpus永远为empty<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">693 def _init_compute_node(self, context, resources):</span><br><span class="line">...</span><br><span class="line">713 if nodename in self.compute_nodes:</span><br><span class="line">714 cn = self.compute_nodes[nodename]</span><br><span class="line">715 self._copy_resources(cn, resources)</span><br><span class="line">716 self._setup_pci_tracker(context, cn, resources)</span><br><span class="line">717 return False</span><br></pre></td></tr></table></figure></p>
<p>它根据free变量来决定是往pinned_cpus上加还是减。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">./nova/virt/hardware.py#numa_usage_from_instance_numa</span><br><span class="line">def numa_usage_from_instance_numa(host_topology, instance_topology,free=False):</span><br><span class="line">...</span><br><span class="line">for host_cell in host_topology.cells:</span><br><span class="line">new_cell = objects.NUMACell(</span><br><span class="line">id=host_cell.id,</span><br><span class="line">cpuset=shared_cpus,</span><br><span class="line">pcpuset=dedicated_cpus,</span><br><span class="line">memory=host_cell.memory,</span><br><span class="line">cpu_usage=0,</span><br><span class="line">memory_usage=0,</span><br><span class="line">mempages=host_cell.mempages,</span><br><span class="line">pinned_cpus=host_cell.pinned_cpus,</span><br><span class="line">siblings=host_cell.siblings)</span><br><span class="line">...</span><br><span class="line">if free:</span><br><span class="line">if (instance_cell.cpu_thread_policy ==</span><br><span class="line">fields.CPUThreadAllocationPolicy.ISOLATE):</span><br><span class="line">new_cell.unpin_cpus_with_siblings(pinned_cpus)</span><br><span class="line">else:</span><br><span class="line">new_cell.unpin_cpus(pinned_cpus)</span><br></pre></td></tr></table></figure></p>
<p>free是由”free = sign == -1“决定的（看仔细，右边的是两个等号，左边的是一个等号）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def _update_usage(self, usage, nodename, sign=1):</span><br><span class="line">...</span><br><span class="line">free = sign == -1</span><br><span class="line">cn.numa_topology = hardware.numa_usage_from_instance_numa(</span><br><span class="line">host_numa_topology, instance_numa_topology, free)._to_json()</span><br><span class="line"></span><br><span class="line">def _update_usage_from_instance():</span><br><span class="line">is_new_instance = uuid not in self.tracked_instances</span><br><span class="line">is_removed_instance = not is_new_instance and (is_removed or</span><br><span class="line">instance[&apos;vm_state&apos;] in vm_states.ALLOW_RESOURCE_REMOVAL)</span><br><span class="line">if is_new_instance:</span><br><span class="line">self.tracked_instances.add(uuid)</span><br><span class="line">sign = 1</span><br><span class="line">if is_removed_instance:</span><br><span class="line">self.tracked_instances.remove(uuid)</span><br><span class="line">sign = -1</span><br><span class="line">...</span><br><span class="line">self._update_usage(self._get_usage_dict(instance, instance),nodename, sign=sign)</span><br></pre></td></tr></table></figure></p>
<p>所以只要update_available_resource运行那脏记录必须得到修改，那现在没修改说明update_available_resource一直没运行，日志里发现这种错误placement正在使用http而非https打头的endpoint从而导致placement api不可用，这样导致update_available_resource在调用update_placement时出错，从而导致update_available_resource自2020-10-26后再未运行。详见－<a href="https://bugs.launchpad.net/charm-nova-compute/+bug/1826382" target="_blank" rel="external">https://bugs.launchpad.net/charm-nova-compute/+bug/1826382</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-10-26 15:43:34.459 1393 WARNING keystoneauth.discover [req-5dcdc394-2784-40d2-984c-54fe261f36f0 - - - - -] Failed to contact the endpoint at http://placement-int.xxx.com:8778 for discovery. Fallback to using that endpoint as the base url.</span><br><span class="line">2020-10-26 15:43:34.463 1393 ERROR nova.compute.manager [req-5dcdc394-2784-40d2-984c-54fe261f36f0 - - - - -] Could not retrieve compute node resource provider 8bd4062b-84c7-4aab-ade7-31dc01695878 and therefore unable to error out any instances stuck in BUILDING state. Error: Failed to retrieve allocations for resource provider 8bd4062b-84c7-4aab-ade7-31dc01695878:</span><br></pre></td></tr></table></figure>
<p>关于numa测试环境的搭建可以见－<a href="https://blog.csdn.net/quqi99/article/details/51993512" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/51993512</a>, 注意一点，grub里定义isolcpus并不会让nova不使用这些cpu, nova里专门有vcpu_pin_set来做这件事。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://blog.csdn.net/jmilk/article/details/81264240" target="_blank" rel="external">https://blog.csdn.net/jmilk/article/details/81264240</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/10/如何让novnc-websockify支持tls1-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/10/如何让novnc-websockify支持tls1-2/" itemprop="url">如何让novnc/websockify支持tls1.2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-10T15:04:57+08:00">
                2020-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-10<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>如果希望novnc使用tls1.2该怎么办？<br>各软件(openssl, websockify, nova)支持tls1.2的历史情况如下：</p>
<ul>
<li>openssl在1.0.0h到1.0.1的时候才开始支持tls1.2, 见”Add TLS v1.2 server support for client authentication” - <a href="https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本" target="_blank" rel="external">https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本</a></li>
<li>ubuntu 20.04开始默认使用tls1.2 [2]</li>
<li>websockify在0.9.0才开始支持配置tls版本, 见 - <a href="https://pypi.org/project/websockify/" target="_blank" rel="external">https://pypi.org/project/websockify/</a>, 所以在nova xenial/mitaka版本中因为使用了websockify0.8.0所以列代码也不支持配置tls版本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;ssl.wrap_sock&apos; /usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py -A 7</span><br><span class="line">            wrapped_sock = ssl.wrap_socket(</span><br><span class="line">                compute_sock,</span><br><span class="line">                keyfile=client_key,</span><br><span class="line">                certfile=client_cert,</span><br><span class="line">                server_side=False,</span><br><span class="line">                cert_reqs=ssl.CERT_REQUIRED,</span><br><span class="line">                ca_certs=CONF.vnc.vencrypt_ca_certs)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这样，后来在nova升级到websockify 0.9.0之后也开始有了一个patch支持配置tls版本,见<br><a href="https://review.opendev.org/#/c/679502/" target="_blank" rel="external">https://review.opendev.org/#/c/679502/</a><br>但是，目前我们使用的就是xenial，该如何办呢？<br>首先，因为使用的是websockify 0.8.0不支持配置ssl版本，那样想在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2＂来强制使用tls1_2是可行的．（如果不可行，是因为下列错误导致，见： <a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a> )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br></pre></td></tr></table></figure></p>
<p>那样，是否应该改变底层openssl的默认配置成tls1.2, 参考文档[1], 修改/etc/ssl/openssl.cnf在oid_section之后添加下列内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# grep -r &apos;oid_section&apos; /etc/ssl/openssl.cnf -A 2</span><br><span class="line">oid_section             = new_oids</span><br><span class="line"></span><br><span class="line">openssl_conf = default_conf</span><br><span class="line"></span><br><span class="line">root@juju-055b8b-ssl-7:~# cat /etc/ssl/openssl.cnf |tail -n9</span><br><span class="line">[default_conf]</span><br><span class="line">ssl_conf = ssl_sect</span><br><span class="line"></span><br><span class="line">[ssl_sect]</span><br><span class="line">system_default = system_default_sect</span><br><span class="line"></span><br><span class="line">[system_default_sect]</span><br><span class="line">MinProtocol = TLSv1.2</span><br><span class="line">CipherString = DEFAULT@SECLEVEL=2</span><br></pre></td></tr></table></figure></p>
<p>但是使用下列方法测试时报错．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nova-novncproxy nova-consoleauth</span><br><span class="line"># verify if tls 1.2 is supported - https://devanswers.co/test-server-tls-1-2-ubuntu/</span><br><span class="line"># https://www.poftut.com/use-openssl-s_client-check-verify-ssltls-https-webserver/</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line"></span><br><span class="line">#list all supported ciphers</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6080 10.5.100.4</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.2.196:6082 -tls1_2</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line">Error configuring OpenSSL</span><br><span class="line">139929571108504:error:25066067:DSO support routines:DLFCN_LOAD:could not load the shared library:dso_dlfcn.c:187:filename(libssl_conf.so): libssl_conf.so: cannot open shared object file: No such file or directory</span><br><span class="line">139929571108504:error:25070067:DSO support routines:DSO_load:could not load the shared library:dso_lib.c:233:</span><br><span class="line">139929571108504:error:0E07506E:configuration file routines:MODULE_LOAD_DSO:error loading dso:conf_mod.c:271:module=ssl_conf, path=ssl_conf</span><br><span class="line">139929571108504:error:0E076071:configuration file routines:MODULE_RUN:unknown module name:conf_mod.c:212:module=ssl_conf</span><br></pre></td></tr></table></figure>
<p>错误是找不着libssl_conf.so，作下列更改后，问题依旧 ．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libssl1.0.0 libssl-dev</span><br><span class="line">cd /lib/x86_64-linux-gnu/</span><br><span class="line">sudo ln -s libssl.so.1.0.0 libssl.so.10</span><br><span class="line">sudo ln -s libcrypto.so.1.0.0 libcrypto.so.10</span><br></pre></td></tr></table></figure></p>
<p>20201120更新-是需要添加<strong>OPENSSL_CONF=/etc/ssl/</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># OPENSSL_CONF=/etc/ssl/ openssl ciphers -v TLSv1.2 | head -4</span><br><span class="line">ECDHE-RSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-RSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AES(256)  Mac=SHA384</span><br><span class="line">ECDHE-ECDSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AES(256)  Mac=SHA384</span><br></pre></td></tr></table></figure></p>
<p>将xenial上的openssl 1.1.0g升级到1.1.1a后问题依旧:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#upgrade openssl from 1.1.0g to 1.1.1a in ubuntu 18.04</span><br><span class="line">sudo apt install build-essential checkinstall zlib1g-dev gcc make -y</span><br><span class="line">wget https://www.openssl.org/source/openssl-1.1.1a.tar.gz</span><br><span class="line">tar zxvf openssl-1.1.1a.tar.gz &amp;&amp; cd openssl-1.1.1a/</span><br><span class="line">./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/ld.so.conf.d/openss1-1.1.1b.conf&apos; &lt;&lt; EOF</span><br><span class="line">/usr/local/ssl/lib</span><br><span class="line">EOF</span><br><span class="line">sudo ldconfig -v</span><br><span class="line">sudo mv /usr/bin/c_rehash /usr/bin/c_rehash.BAK</span><br><span class="line">sudo mv /usr/bin/openssl /usr/bin/openssl.BAK</span><br><span class="line">sudo cp /etc/environment /etc/environment.BAK</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/environment&apos; &lt;&lt; EOF</span><br><span class="line">PATH=&quot;/usr/local/ssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games&quot;</span><br><span class="line">EOF</span><br><span class="line">echo $PATH</span><br><span class="line">openssl version -a</span><br><span class="line">sudo apt-get install libssl-dev -y</span><br></pre></td></tr></table></figure></p>
<p>然后修改/usr/lib/python2.7/dist-packages/websockify/websocket.py（注意，不是/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py）里的ssl.wrap_socket添加’ssl_version=ssl.PROTOCOL_TLSv1_2’就可以了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nmap --script ssl-enum-ciphers -p 6080 10.5.100.4 |grep TLSv</span><br><span class="line">|   TLSv1.2:</span><br><span class="line">root@juju-055b8b-ssl-7:~/openssl-1.1.1a# openssl s_client -connect 10.5.100.4:6080 -tls1_2 |grep &apos;CN&apos;</span><br><span class="line">depth=0 C = GB, ST = England, L = London, O = Ubuntu Cloud, OU = Cloud, CN = 10.5.100.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>此时，去掉/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py里之前做的tls1.2修改也是可以的．<br>结论，似乎修改底层openssl的默认版本到tls1.2不好使，同时websockify 0.8.0默认的只是tls1.0, 此时只是修改nova端是不work的，直接修改websockify 0.8.0改到tls1.2是可以的．在websockify 0.9.0之后支持配置tls1.2，所以此时nova端修改tls的patch也就能派上用场了．<br>相关代码分析：<br>python ssl模块在wrap_socket中是将参数硬编码成ssl_version=PROTOCOL_SSLv23，所以在websockify 0.8.0不传ssl_version参数的话是即使改底层openssl的默认编码也是无济于事的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def wrap_socket(sock, keyfile=None, certfile=None,</span><br><span class="line">                server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line">                ssl_version=PROTOCOL_SSLv23, ca_certs=None,</span><br><span class="line">                do_handshake_on_connect=True,</span><br><span class="line">                suppress_ragged_eofs=True, ciphers=None):</span><br></pre></td></tr></table></figure></p>
<p>看来唯一的办法是修改python-websockify 0.8.0包，加上那一行，做个临时hotfix了．</p>
<h2 id="20201106更新"><a href="#20201106更新" class="headerlink" title="20201106更新"></a>20201106更新</h2><p>创建了一个xenial的spice ssl测试环境．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl2:stsstack --num-compute 1 --openstack-dashboard --ssl --nova-console --run</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=/home/ubuntu/ed/stsstack-bundles/openstack/ssl/openstack-ssl2/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=spice</span><br><span class="line">juju config nova-cloud-controller console-ssl-cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-ssl-key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>但我们尽量不用–ssl，改用–vault<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl-queens:stsstack --num-compute 1 --nova-console --vault</span><br></pre></td></tr></table></figure></p>
<p>看到下列错，实际上这是正常的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ nova get-vnc-console bionic-061058 spice-html5</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| Type | Url |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| spice-html5 | https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015 |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">$ curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015</span><br><span class="line">* Trying 10.5.100.4:6082...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 10.5.100.4 (10.5.100.4) port 6082 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">* CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.3 (OUT), TLS alert, protocol version (582):</span><br><span class="line">* error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line"></span><br><span class="line">-root@juju-1833ad-ssl2-7:~# tail -f /var/log/nova/nova-spiceproxy.log</span><br><span class="line">2020-11-06 06:42:33.666 26162 DEBUG nova.console.websocketproxy [-] 10.5.0.8: new handler Process vmsg /usr/lib/python2.7/dist-packages/websockify/websocket.py:878</span><br><span class="line">2020-11-06 06:42:34.166 19170 INFO nova.console.websocketproxy [-] handler exception: [SSL: SSLV3_ALERT_CERTIFICATE_UNKNOWN] sslv3 alert certificate unknown (_ssl.c:590)</span><br></pre></td></tr></table></figure></p>
<p>为什么说它是正常的呢？因为我们是在focal上运行的curl命令或者浏览器，focal支持的最低ssl版本是tlsv1.2，而spiceproxy运行在xenial只支持tlsv1.0.　所以找一台xenial机器运行下列加了–tlsv1.0的curl命令是OK的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=bd00bb9f-83e7-4b25-9b6a-57dde9941dce --tlsv1.0</span><br></pre></td></tr></table></figure></p>
<p>还是上面类似的老问题，spice也用到了websockify0.8，而它写死了 ssl_version=PROTOCOL_TLSv1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; /usr/lib/python2.7/dist-packages/websockify/websocket.py(837)do_handshake()</span><br><span class="line">-&gt; retsock = ssl.wrap_socket(</span><br><span class="line">(Pdb) l</span><br><span class="line">832                     raise self.EClose(&quot;SSL connection but &apos;%s&apos; not found&quot;</span><br><span class="line">833                                       % self.cert)</span><br><span class="line">834                 retsock = None</span><br><span class="line">835                 try:</span><br><span class="line">836                     import rpdb;rpdb.set_trace()</span><br><span class="line">837  -&gt;                 retsock = ssl.wrap_socket(</span><br><span class="line">838                             sock,</span><br><span class="line">839                             server_side=True,</span><br><span class="line">840                             certfile=self.cert,</span><br><span class="line">841                             keyfile=self.key)</span><br><span class="line">842                 except ssl.SSLError:</span><br><span class="line">(Pdb) p self.cert</span><br><span class="line">&apos;/etc/nova/ssl/nova_cert.pem&apos;</span><br><span class="line">(Pdb) p self.key</span><br><span class="line">&apos;/etc/nova/ssl/nova_key.pem&apos;</span><br><span class="line">(Pdb) l</span><br><span class="line"> 48</span><br><span class="line"> 49         def __init__(self, sock, keyfile=None, certfile=None,</span><br><span class="line"> 50                      server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line"> 51                      ssl_version=PROTOCOL_TLSv1, ca_certs=None,</span><br><span class="line"> 52                      do_handshake_on_connect=True, *args, **kw):</span><br><span class="line"> 53  -&gt;         if not isinstance(sock, GreenSocket):</span><br><span class="line"> 54                 sock = GreenSocket(sock)</span><br><span class="line"> 55</span><br><span class="line"> 56             self.act_non_blocking = sock.act_non_blocking</span><br><span class="line"> 57</span><br><span class="line"> 58             if six.PY2:</span><br><span class="line"></span><br><span class="line">root@juju-1833ad-ssl2-7:~# pip list |grep web</span><br><span class="line">websockify (0.8.0)</span><br></pre></td></tr></table></figure></p>
<p>但直接在xenial上升级到websockify=0.9.0失败.</p>
<h2 id="在queens中使用websockify-0-9-0"><a href="#在queens中使用websockify-0-9-0" class="headerlink" title="在queens中使用websockify 0.9.0"></a>在queens中使用websockify 0.9.0</h2><p>将websockify的patch backedport到0.8.0时依赖太多，所以只能将0.9.0整体backport到queens. 测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/lib/python2.7/dist-packages/websockify ~/websockify_bak</span><br><span class="line">git clone https://github.com/novnc/websockify.git</span><br><span class="line">cd websockify &amp;&amp; git checkout -b v0.9.0 v0.9.0</span><br><span class="line">cd ../ &amp;&amp; cp -r websockify/websockify /usr/lib/python2.7/dist-packages/</span><br><span class="line"></span><br><span class="line">cp allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch /usr/lib/python2.7/dist-packages/</span><br><span class="line">cd  /usr/lib/python2.7/dist-packages/ &amp;&amp; patch -p1 &lt;allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch</span><br><span class="line"></span><br><span class="line">then set the following content in /etc/nova/nova.conf</span><br><span class="line">[console]</span><br><span class="line">ssl_minimum_version=tlsv1_2</span><br><span class="line"></span><br><span class="line">vim /usr/lib/python2.7/dist-packages/nova/console/websocketproxy.py</span><br><span class="line">    def socket(self, *args, **kwargs):</span><br><span class="line">        #return websockify.WebSocketServer.socket(*args, **kwargs)</span><br><span class="line">        return websockify.websockifyserver.WebSockifyServer.socket(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">find /usr/lib/python2.7/dist-packages/websockify -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line">find /usr/lib/python2.7/dist-packages/nova -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">systemctl restart nova-spiceproxy</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6082 10.5.2.196 |grep -i tlsv</span><br></pre></td></tr></table></figure>
<h2 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">websocketproxy.py#websockify_init (opts.ssl_options = select_ssl_version(opts.ssl_version)) -&gt; websockifyserver.py#start_server()</span><br><span class="line"></span><br><span class="line">when client is connecting:</span><br><span class="line">WebSocketProxy -&gt; ./websocketproxy.py#ProxyRequestHandler -&gt; WebSockifyRequestHandler#handle -&gt; /usr/lib/python3.6/http/server.py(377)handle_one_request() -&gt; _websocket_do_GET -&gt; handle_upgrade (self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;) -&gt;  WebSocketRequestHandlerMixIn.handle_upgrade(self) -&gt; handle_websocket(SSL/TLS)-&gt; new_websocket_client　-&gt; /usr/lib/python3/dist-packages/nova/console/websocketproxy.py(166)new_websocket_client</span><br></pre></td></tr></table></figure>
<p>似乎是在queens中下面的self.headers.get(‘upgrade’)不为wesocket<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">54     def _websocket_do_GET(self):</span><br><span class="line">55         # Checks if it is a websocket request and redirects</span><br><span class="line">56         self.do_GET = self._real_do_GET</span><br><span class="line">57</span><br><span class="line">58         if (self.headers.get(&apos;upgrade&apos;) and</span><br><span class="line">59             self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;):</span><br><span class="line">60             self.handle_upgrade()</span><br><span class="line">61         else:</span><br><span class="line">62             self.do_GET()</span><br></pre></td></tr></table></figure></p>
<p>根据这个网页（<a href="https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）" target="_blank" rel="external">https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）</a></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>主要是由两个问题导致：<br>1, one spice-html5 bug<br><a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a><br>2, ssl默认使用PROTOCOL_SSLv23 （ <a href="https://docs.python.org/2/library/ssl.html#socket-creation" target="_blank" rel="external">https://docs.python.org/2/library/ssl.html#socket-creation</a> ）要使用tlsv1_2，或者在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2，或者使用nova与websockify的patch可以通过ssl_option来配置使用的tls版本。<br>3, 或者/usr/lib/python2.7/dist-packages/eventlet/green/ssl.py中不应该用PROTOCOL_TLSv1作为默认，而应该用PROTOCOL_SSLv23， 这样PROTOCOL_SSLv23会依赖底层ssl版本自动选择tlsv1_0, tlsv1_1, tlsv1_2, 这样即使防火墙disable  tlsv1_0也不影响使用tlsv1_2. 最终的原因是因为python-eventlet 0.18.4-1引入了Rebased set-defaults-to-be-tlsv1-not-sslv23.patch，是它使用了PROTOCOL_TLSv1，应该去掉。</p>
<h2 id="附录-Websocket-based-spice-client"><a href="#附录-Websocket-based-spice-client" class="headerlink" title="附录 - Websocket based spice client"></a>附录 - Websocket based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1, a test vm with spice enabled</span><br><span class="line">    &lt;graphics type=&apos;spice&apos; port=&apos;5900&apos; autoport=&apos;yes&apos; listen=&apos;127.0.0.1&apos;&gt;</span><br><span class="line">      &lt;listen type=&apos;address&apos; address=&apos;127.0.0.1&apos;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line"></span><br><span class="line">2, spice proxy side</span><br><span class="line">sudo apt install python3-websockify -y</span><br><span class="line">websockify 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">3, spice client side</span><br><span class="line">sudo apt install spice-html5 apache2 -y</span><br><span class="line">ls /usr/share/spice-html5/spice_auto.html #it&apos;s similar to https://10.5.1.11:6082/spice_auto.html?token=xxx</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">Alias /spice /usr/share/spice-html5</span><br><span class="line">&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">    Allow from all</span><br><span class="line">    Satisfy Any</span><br><span class="line">    DirectoryIndex spice.html</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo ln -s /etc/apache2/conf-available/ws.conf /etc/apache2/conf-enabled/ws.conf</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">4, access it via http://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br></pre></td></tr></table></figure>
<h2 id="附录-Websocket-ssl-based-spice-client"><a href="#附录-Websocket-ssl-based-spice-client" class="headerlink" title="附录 - Websocket ssl based spice client"></a>附录 - Websocket ssl based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">1, create key pairs</span><br><span class="line"></span><br><span class="line">mkdir ~/ca &amp;&amp; cd ~/ca</span><br><span class="line">openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out ca.crt -keyout ca.key -subj &quot;/C=US/ST=UK/L=London/O=Ubuntu/OU=IT/CN=CA&quot;</span><br><span class="line">for DOMAIN in server client</span><br><span class="line">do</span><br><span class="line">  openssl genrsa -out $DOMAIN.key</span><br><span class="line">  openssl req -new -key $DOMAIN.key -out $DOMAIN.csr -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=$DOMAIN&quot;</span><br><span class="line">  openssl x509 -req -in $DOMAIN.csr -out $DOMAIN.crt -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">2, spice server side</span><br><span class="line"></span><br><span class="line">sudo mkdir /etc/apache2/ssl &amp;&amp; sudo chown -R $USER /etc/apache2/ssl</span><br><span class="line">cp /home/hua/ca/server.crt /etc/apache2/ssl/</span><br><span class="line">cp /home/hua/ca/server.key /etc/apache2/ssl/</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">&lt;VirtualHost 192.168.2.139:443&gt;</span><br><span class="line">        SSLEngine on</span><br><span class="line">        SSLCertificateFile      /etc/apache2/ssl/server.crt</span><br><span class="line">        SSLCertificateKeyFile   /etc/apache2/ssl/server.key</span><br><span class="line">        CustomLog       &quot;/var/log/apache2/ws.log&quot; combined</span><br><span class="line">        ErrorLog        &quot;/var/log/apache2/ws.log&quot;</span><br><span class="line">	Alias /spice /usr/share/spice-html5</span><br><span class="line">	&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">	    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">	    Allow from all</span><br><span class="line">	    Satisfy Any</span><br><span class="line">	    DirectoryIndex spice.html</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo a2enmod ssl</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">3, spice proxy side</span><br><span class="line">websockify --cert=/home/hua/ca/server.crt --key=/home/hua/ca/server.key --cafile=~/home/hua/ca/ca.crt --ssl-only --ssl-version=tlsv1_2 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">4, access it via: https://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br><span class="line">   nmap --script ssl-enum-ciphers -p 6082 192.168.2.139</span><br><span class="line">   openssl s_client -connect 192.168.2.139:6082 -tls1_2</span><br><span class="line"></span><br><span class="line">5, debug, print http headers by adding the following scripts in /usr/share/spice-html5/spice_auto.html</span><br><span class="line"></span><br><span class="line">var req = new XMLHttpRequest();</span><br><span class="line">req.open(&apos;GET&apos;, document.location, false);  #but this is not the headers for websocket upgrade</span><br><span class="line">req.send(null);</span><br><span class="line">var headers = req.getAllResponseHeaders();</span><br><span class="line">alert(headers);</span><br><span class="line"></span><br><span class="line">6, why we see the following error when visitting the url &apos;https://10.5.2.196:6082/spice_auto.html?token=xxxx&apos;</span><br><span class="line"></span><br><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br><span class="line"></span><br><span class="line">That&apos;s because the following content is missing in /usr/share/spice-html5/spice_auto.html, see this patch - https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</span><br><span class="line"></span><br><span class="line">                if (window.location.protocol == &apos;https:&apos;) &#123;</span><br><span class="line">                    scheme = &quot;wss://&quot;;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html" target="_blank" rel="external">https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html</a><br>[2] <a href="https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464" target="_blank" rel="external">https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464</a><br>[3] <a href="https://notes.bitfunnel.net/?q=node/54" target="_blank" rel="external">https://notes.bitfunnel.net/?q=node/54</a><br>[4] <a href="https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373" target="_blank" rel="external">https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/软路由/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/19/软路由/" itemprop="url">软路由</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-19T23:24:29+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-08-19<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>升级了500M宽带，但电脑用网线直线WDNR4300路由器用perf3 -s与perf -c 192.168.99.1 -t 3测试时只不到200M．所以在一台式机上安装了软路由，测试结果立马上到接近1000M了．<br>但用了1000M的电力猫之后，速度又下降到120左右，改成有线连接之后，又马又上到1000M．<br>看来瓶颈在于WDNR4300与电力猫．</p>
<h2 id="安装软路由"><a href="#安装软路由" class="headerlink" title="安装软路由"></a>安装软路由</h2><p>台式机上有两个之前做SR-IOV实验用的千兆网卡 (Winyao WY576T PCI-E X4 双口服务器千兆网卡 82576 1000M), 及一个Intel集成网卡．</p>
<ul>
<li>enp6s0f0与enp6s0f1通过passthough映射到KVM虚机. 注意不要使用macvtap+bridge模式，因为这样会造成无法从局域网ping macvtap设备上的IP，当在插一根网线到Intel集成网卡上后，默认路由总是在enp6s0f0上，从而导致无法访问台式机．enp6s0f0映射到openwrt虚机里是eth1用于生成br-lan, enp6s0f1映射到openwrt虚机里是eth0.</li>
<li>直接KVM安装导入OpenWRT x86镜像即可 (github直接下载)</li>
</ul>
<h2 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h2><p>目前家中的网络拓扑是：</p>
<ul>
<li>光猫，打电话改了桥接</li>
<li>tplink千兆路由器(192.168.2.0/24)拨号, 下接一千兆交换机接NAS, TV, Camera等．</li>
<li>台式机的enp6s0f0接tplink，从软路由(192.168.98.0/24)出来后，enp6s0f1再接一千兆交换机．</li>
<li>WNDR4300仍然从tplink出(192.168.99.0/24)</li>
<li>千兆电力猫连接软路由至卧室（电力猫速度太差，需要改成有线）<h2 id="目前问题"><a href="#目前问题" class="headerlink" title="目前问题"></a>目前问题</h2></li>
<li>台式机停电再来电自动启动的问题，改了BIOS但还未测试</li>
<li>tplink上IPv6也要拨号但复用IPv4的拨号连接后是有IPv6地址的（光猫桥接并未挡住什么），客户端直接连接tplink也能拿到IPv6, 但tplink下挂的OpenWRT路由器却拿不到IPv6, 可能是OpenWrt镜像缺包吧，因为在WAN6那里找不到dhcpv6 client，只有dhcp client) ，原因见：　<a href="https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html" target="_blank" rel="external">https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html</a> (<strong>20200824更新,就是这个原因</strong>). 那现在另外一个路由器以dhcp接在这个拨号路由器后lan口又如何获取IPv6地址呢?</li>
<li>ubuntu在/etc/network/interfaces不定义时可以拿到IPv6，但要使用桥接如何定义也能拿到IPv6呢？</li>
<li>如何将无线网卡给KVM用，同时在openwrt虚机中用它做AP?</li>
</ul>
<h2 id="一级路由访问二级路由"><a href="#一级路由访问二级路由" class="headerlink" title="一级路由访问二级路由"></a>一级路由访问二级路由</h2><p>当在一级redmi ax5路由(192.168.2.1)下又接了一个二级openwrt路由(192.168.2.47, 192.168.99.1).<br>那一级路由下的node1(192.168.2.111)如何访问二级路由下的t440p (192.168.99.136)呢?<br>1, 先照着这处贴子将redmi ax5的ssh打开, 必须重启,之后就可以通过root/admin 来ssh了(不影响web管理密码), 然后使用’passwd root’来修改密码.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/web/home#router</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h;nvram set ssh%5Fen%3D1; nvram commit;</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20nvram%20set%20ssh_en%3D1%3B%20nvram%20commit%3B%20sed%20-i%20&apos;s%2Fchannel%3D.*%2Fchannel%3D%5C%22debug%5C%22%2Fg&apos;%20%2Fetc%2Finit.d%2Fdropbear%3B%20%2Fetc%2Finit.d%2Fdropbear%20start%3B</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20echo%20-e%20&apos;admin%5Cnadmin&apos;%20%7C%20passwd%20root%3B</span><br></pre></td></tr></table></figure></p>
<p>2, 在二级路由器上如下图关闭防火墙,<br><img src="https://img-blog.csdnimg.cn/2020082422402826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>3, 在一级路由下添加静态路由<br>route add -net 192.168.99.0 netmask 255.255.255.0 gw 192.168.2.47</p>
<p>4, 在二级路由上将192.168.2.47作静态IP绑定(MAC/IP绑定即可)</p>
<p>5, 如果不行,似乎在一级路由器上上图中lan处防火墙设置中的forwarding不能是REJECT哦.</p>
<h2 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h2><p>miwifi上集成的DDNS服务基本上都是收费的, 花生壳的二级域名壳域名不收费, 但这家公司喜欢删域名, 要求你实名制, 但实名制前又问你最喜欢的动物是什么, 答错了还弄不成实名制, 打电话给客服了, 让你把身份证扫描件发到800@oray.com人工审核, 但也没下文了, 等得头疼. 另外, 就是太喜欢删域名了, 申请的壳域名忽然就删了, 被删了也不知道的怎么被删的, 死得不明不白. 得了, 还是整个免费的吧. 申请一个dnsexit的二级域名, 然后用下列脚本更新.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; /data/ddns&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/sh</span><br><span class="line">myip=$(curl -s http://myip.dnsomatic.com/)</span><br><span class="line">if [ -e &quot;ip.txt&quot; ]</span><br><span class="line">then</span><br><span class="line">  old_ip=$(cat ip.txt)</span><br><span class="line">  if [ &quot;$myip&quot; == &quot;$old_ip&quot; ]</span><br><span class="line">  then</span><br><span class="line">    echo &quot;Your IP $myip didn&apos;t change.&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;The IP Changed from $old_ip to $myip&quot;</span><br><span class="line">    change_dot_com=$(curl -s &quot;http://update.dnsexit.com/RemoteUpdate.sv?login=&lt;user&gt;&amp;password=&lt;password&gt;&amp;host=&lt;domain&gt;&amp;myip=$&#123;myip&#125;&quot;)</span><br><span class="line">    echo &quot;$change_dot_com&quot;</span><br><span class="line">    sleep 2</span><br><span class="line">  fi</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;Your IP is $myip&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">chmod +x /data/ddns</span><br><span class="line">crontab -e</span><br><span class="line">*/60 * * * * /data/ddns &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">nslookup -vc quqi99.publicvm.com 8.8.8.8</span><br></pre></td></tr></table></figure>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>1, 默认REJET</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">config defaults</span><br><span class="line">        option syn_flood &apos;0&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option drop_invalid &apos;1&apos;</span><br><span class="line">        option disable_ipv6 &apos;0&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;lan&apos;</span><br><span class="line">        option network &apos;lan&apos;</span><br><span class="line">        option input &apos;ACCEPT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;ACCEPT&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;wan&apos;</span><br><span class="line">        list network &apos;wan&apos;</span><br><span class="line">        list network &apos;wan6&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option masq &apos;1&apos;</span><br><span class="line">        option mtu_fix &apos;1&apos;</span><br></pre></td></tr></table></figure>
<p>2, 打开22端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config rule &apos;ssh&apos;</span><br><span class="line">        option name &apos;ssh&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option target &apos;ACCEPT&apos;</span><br><span class="line">        option family &apos;ipv4&apos;</span><br></pre></td></tr></table></figure></p>
<p>3, 转发2222端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">config redirect &apos;wan2222rdr1&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option src_dport &apos;2222&apos;</span><br><span class="line">        option dest_ip &apos;192.168.2.47&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option name &apos;x86_openwrt&apos;</span><br><span class="line">        option target &apos;DNAT&apos;</span><br><span class="line">        option ftype &apos;1&apos;</span><br><span class="line">        option dest &apos;lan&apos;</span><br><span class="line">root@XiaoQiang:~# iptables-save |grep 47</span><br><span class="line">-A zone_lan_postrouting -s 192.168.2.0/24 -d 192.168.2.47/32 -p tcp -m tcp --dport 22 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j SNAT --to-source 192.168.2.1</span><br><span class="line">-A zone_lan_prerouting -s 192.168.2.0/24 -d 123.115.196.xxx/32 -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j DNAT --to-destination 192.168.2.47:22</span><br><span class="line">-A zone_wan_prerouting -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt&quot; -j DNAT --to-destination 192.168.2.47:22</span><br></pre></td></tr></table></figure>
<p>转发端口时不需要为2222单独定义input规则, 另外, 联通除了封80, 443, 以外其实没有封其它端口, 可用<a href="https://tool.chinaz.com/port/" target="_blank" rel="external">https://tool.chinaz.com/port/</a> 检测 (检测时得做redirect规则, 且开服务)</p>
<h2 id="https网站不好使"><a href="#https网站不好使" class="headerlink" title="https网站不好使"></a>https网站不好使</h2><p>像csdn与baidu等网站出现HSTS相关的证书错误, 是因为广告过滤大师使用了KoolProxy签发的证书所致, 所以需要关闭广告过滤大师.</p>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&quot;data-root&quot;: &quot;/mnt/udisk/docker&quot;,</span><br><span class="line">/etc/init.d/dockerd restart</span><br><span class="line"></span><br><span class="line">#install a better docker frontend - https://koolshare.cn/thread-180474-1-1.html</span><br><span class="line">docker pull portainer/portainer</span><br><span class="line">#create a continer with portainer image, expose port 9000:9000/tcp and bind mount &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">http://192.168.99.1:9000/#/init/admin</span><br><span class="line">http://192.168.99.1:9000/#/dashboard</span><br><span class="line"></span><br><span class="line">#intall docker search ubuntu</span><br><span class="line">docker pull ubuntu</span><br><span class="line">docker run -it ubuntu</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<h2 id="天翼云盘"><a href="#天翼云盘" class="headerlink" title="天翼云盘"></a>天翼云盘</h2><p>天翼云盘是一个独立的家庭云空间，不等同于天翼云，无法获取S3登陆参数，也关闭了API - <a href="https://zhuanlan.zhihu.com/p/38592985" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/38592985</a><br>所以它无法使用s3fs加载块设备，但使用s3fs的方法类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential libfuse-dev libcurl4-openssl-dev libxml2-dev mime-support automake libtool s3fs</span><br><span class="line">echo xxx:xxx |sudo tee /etc/passwd-s3fs &amp;&amp; sudo chmod 600 /etc/passwd-s3fs &amp;&amp; sudo chown $USER /etc/passwd-s3fs</span><br><span class="line">sudo mkdir /mnt/tianyi &amp;&amp; sudo chown $USER /mnt/tianyi</span><br><span class="line">s3fs -o passwd_file=/etc/passwd-s3fs -o url=http://oos.ctyunapi.cn bucket-dingjia /mnt/tianyi</span><br><span class="line">df -h</span><br><span class="line">fusermount -u /mnt/tianyi</span><br></pre></td></tr></table></figure>
<p>它可以使用sharelist，但用途不大．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sudo apt install nodejs npm -y  &amp;&amp; sudo npm install -g npm</span><br><span class="line">git clone https://github.com/reruin/sharelist.git</span><br><span class="line">cd sharelist &amp;&amp; sudo chmod +x ./install.sh &amp;&amp; sudo ./install.sh  #http://127.0.0.1:33001/</span><br><span class="line">#cd ./sharelist/ &amp;&amp; node app.js                                  #http://127.0.0.1:33001/</span><br></pre></td></tr></table></figure></p>
<h2 id="BaiduPCS-Web"><a href="#BaiduPCS-Web" class="headerlink" title="BaiduPCS-Web"></a>BaiduPCS-Web</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># server side</span><br><span class="line"># nfs GUI(http://192.168.99.1/cgi-bin/luci/admin/nas/nfs)是坏的(luci-app-nfs - https://github.com/coolsnowwolf/lede/issues/2957)，只能使用CLI</span><br><span class="line">echo &apos;/mnt/sdb1/nfs *(rw,sync,no_root_squash,subtree_check)&apos; &gt;&gt; /etc/exports</span><br><span class="line">/etc/init.d/nfsd restart</span><br><span class="line"></span><br><span class="line"># client side</span><br><span class="line">showmount -e 192.168.99.1</span><br><span class="line">sudo mount -t nfs 192.168.99.1:/mnt/sdb1/nfs /openwrt</span><br><span class="line">sudo fuser -m -v /openwrt/</span><br><span class="line">$ cat /etc/auto.direct |tail -n1</span><br><span class="line">/openwrt    -fstype=nfs4,rsize=32768,wsize=32768     192.168.99.1:/mnt/sdb1/nfs</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://hansendong.me/609/" target="_blank" rel="external">https://hansendong.me/609/</a><br>[2] <a href="https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453" target="_blank" rel="external">https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
