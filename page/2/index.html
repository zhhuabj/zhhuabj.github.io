<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/30/Play-with-OVN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/30/Play-with-OVN/" itemprop="url">Play with OVN</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-30T16:06:55+08:00">
                2020-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华  发表于：2019-11-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>OVN is the replacement of Neutron, so we need to have a look at OVN.</p>
<p>Refer - <a href="https://zhhuabj.blog.csdn.net/article/details/42773417" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/42773417</a></p>
<h2 id="Basic-ovn-L2-test"><a href="#Basic-ovn-L2-test" class="headerlink" title="Basic ovn L2 test"></a>Basic ovn L2 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#controller node has ovn-central(northbound and southbound db), but compute node (local ovn-controller) doesn&apos;t have it</span><br><span class="line">sudo apt install -y openvswitch-switch ovn-common ovn-controller-vtep ovn-docker ovn-host ovn-central</span><br><span class="line"></span><br><span class="line">#In controller, enable remote access, tell OVN southbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-sbctl set-connection ptcp:6642</span><br><span class="line">#In controller, for the time being don&apos;t need to tell OVN northbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-nbctl set-connection ptcp:6641</span><br><span class="line">$ netstat -lntp | grep  664</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp        0      0 0.0.0.0:6642            0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:6640          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:6641            0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line">#In controller, create logical switch and ports:</span><br><span class="line">sudo ovn-nbctl ls-add sw</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp1 &quot;00:00:00:00:00:01 10.0.0.1&quot;</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp2</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp2 &quot;00:00:00:00:00:02 10.0.0.2&quot;</span><br><span class="line">sudo ovn-nbctl show</span><br><span class="line"></span><br><span class="line">#In compute node, make ovn-controller connect to southbound db, and create test</span><br><span class="line">#external_ids:ovn-remote=&quot;tcp:&lt;remote-controller-ip&gt;:6642&quot; external_ids:ovn-encap-ip=&lt;my-ip-used-for-endpoint&gt;</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm1&quot;</span><br><span class="line">sudo ip link add sp1_l type veth peer name sp1_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp1_l  #sudo ovs-vsctl add-br br-int -- set Bridge br-int fail-mode=secure</span><br><span class="line">sudo ovs-vsctl set interface sp1_l external_ids:iface-id=sp1</span><br><span class="line">sudo ip link set sp1_l up</span><br><span class="line">sudo ip netns add sp1</span><br><span class="line">sudo ip link set sp1_r netns sp1</span><br><span class="line">sudo ip netns exec sp1 ip link set sp1_r up</span><br><span class="line">sudo ip netns exec sp1 ip addr add 10.0.0.1/24 dev sp1_r</span><br><span class="line">sudo ip netns exec sp1 ip link set dev sp1_r address 00:00:00:00:00:01</span><br><span class="line"></span><br><span class="line">#or run the following command on another machine instead</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm2&quot;</span><br><span class="line">sudo ip link add sp2_l type veth peer name sp2_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp2_l</span><br><span class="line">sudo ovs-vsctl set interface sp2_l external_ids:iface-id=sp2</span><br><span class="line">sudo ip link set sp2_l up</span><br><span class="line">sudo ip netns add sp2</span><br><span class="line">sudo ip link set sp2_r netns sp2</span><br><span class="line">sudo ip netns exec sp2 ip link set sp2_r up</span><br><span class="line">sudo ip netns exec sp2 ip addr add 10.0.0.2/24 dev sp2_r</span><br><span class="line">sudo ip netns exec sp2 ip link set dev sp2_r address 00:00:00:00:00:02</span><br><span class="line"></span><br><span class="line">#test</span><br><span class="line">$ sudo ip netns exec sp1 ping 10.0.0.2 -c 1</span><br><span class="line">PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.318 ms</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch a28291a4-bea9-445f-af0f-cae65c04e9f7 (sw)</span><br><span class="line">    port sp2</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:02 10.0.0.2&quot;]</span><br><span class="line">    port sp1</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:01 10.0.0.1&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-sbctl show</span><br><span class="line">Chassis vm2</span><br><span class="line">    hostname: node1</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: localhost</span><br><span class="line">        options: &#123;csum=&quot;true&quot;&#125;</span><br><span class="line">    Port_Binding sp2</span><br><span class="line">    Port_Binding sp1</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl lsp-del sp1</span><br><span class="line">sudo ovn-nbctl lsp-del sp2</span><br><span class="line">sudo ovn-nbctl ls-del sw</span><br><span class="line">sudo ip netns del sp1</span><br><span class="line">sudo ip netns del sp2</span><br><span class="line">sudo ovs-vsctl del-port br-int sp1_l</span><br><span class="line">sudo ovs-vsctl del-port br-int sp2_l</span><br></pre></td></tr></table></figure>
<h2 id="Basic-ovs-flow-test"><a href="#Basic-ovs-flow-test" class="headerlink" title="Basic ovs flow test"></a>Basic ovs flow test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -itd --name i1 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo docker run -itd --name i2 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo ovs-vsctl add-br br-int</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i1 --ipaddress=192.168.1.2/24</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i2 --ipaddress=192.168.1.3/24</span><br><span class="line">sudo docker exec -it i1 bash</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line">sudo ovs-vsctl list interface d15c80f8359d4_l</span><br><span class="line">#when doing test in the two machines</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.122 options:key=flow</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.123 options:key=flow</span><br><span class="line"></span><br><span class="line">#test 1 - delete flow</span><br><span class="line">$ sudo ovs-ofctl dump-flows br-int</span><br><span class="line"> cookie=0x0, duration=563.338s, table=0, n_packets=6, n_bytes=364, priority=0 actions=NORMAL</span><br><span class="line">sudo ovs-ofctl del-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line"></span><br><span class="line">#test 2 - add flow</span><br><span class="line">$ sudo ovs-vsctl list interface d15c80f8359d4_l |grep ofport</span><br><span class="line">ofport              : 3</span><br><span class="line">$ sudo ovs-vsctl list interface 85023af15d0c4_l |grep ofport</span><br><span class="line">ofport              : 4</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=1,in_port=3,actions=output:4&quot;</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=2,in_port=4,actions=output:3&quot;</span><br><span class="line">sudo ovs-ofctl dump-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br></pre></td></tr></table></figure>
<h2 id="ovn-L3-test"><a href="#ovn-L3-test" class="headerlink" title="ovn L3 test"></a>ovn L3 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#create two vSwitches</span><br><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-port1 &quot;50:54:00:00:00:01 192.168.0.2&quot;</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl ls-add sw1</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 sw1-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw1-port1 &quot;50:54:00:00:00:03 11.0.0.2&quot;</span><br><span class="line"></span><br><span class="line">#create a vRouter, and connect two vSwitches to it</span><br><span class="line">sudo ovn-nbctl lr-add lr0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp0 00:00:00:00:ff:01 192.168.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 lrp0-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp0-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp0-attachment 00:00:00:00:ff:01</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp0-attachment router-port=lrp0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp1 00:00:00:00:ff:02 11.0.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 lrp1-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp1-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp1-attachment 00:00:00:00:ff:02</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp1-attachment router-port=lrp1</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch 25c77c44-9be4-434b-8b38-e325d4c2b044 (sw0)</span><br><span class="line">    port lrp0-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:01&quot;]</span><br><span class="line">        router-port: lrp0</span><br><span class="line">    port sw0-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:01 192.168.0.2&quot;]</span><br><span class="line">switch 0b33e823-577b-4c76-a661-c3bd358624cc (sw1)</span><br><span class="line">    port lrp1-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:02&quot;]</span><br><span class="line">        router-port: lrp1</span><br><span class="line">    port sw1-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:03 11.0.0.2&quot;]</span><br><span class="line">router cd8095b3-287f-4e0c-af3d-a10a089f977c (lr0)</span><br><span class="line">    port lrp1</span><br><span class="line">        mac: &quot;00:00:00:00:ff:02&quot;</span><br><span class="line">        networks: [&quot;11.0.0.1/24&quot;]</span><br><span class="line">    port lrp0</span><br><span class="line">        mac: &quot;00:00:00:00:ff:01&quot;</span><br><span class="line">        networks: [&quot;192.168.0.1/24&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-trace --minimal sw0 &apos;inport == &quot;sw0-port1&quot; &amp;&amp; eth.src == 50:54:00:00:00:01 &amp;&amp; ip4.src == 192.168.0.2 &amp;&amp; eth.dst == 00:00:00:00:ff:01 &amp;&amp; ip4.dst == 11.0.0.2 &amp;&amp; ip.ttl == 64&apos;</span><br><span class="line"># ip,reg14=0x1,vlan_tci=0x0000,dl_src=50:54:00:00:00:01,dl_dst=00:00:00:00:ff:01,nw_src=192.168.0.2,nw_dst=11.0.0.2,nw_proto=0,nw_tos=0,nw_ecn=0,nw_ttl=64</span><br><span class="line">ip.ttl--;</span><br><span class="line">eth.src = 00:00:00:00:ff:02;</span><br><span class="line">eth.dst = 50:54:00:00:00:03;</span><br><span class="line">output(&quot;sw1-port1&quot;);</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl ls-del sw0</span><br><span class="line">sudo ovn-nbctl ls-del sw1</span><br><span class="line">sudo ovn-nbctl lr-del lr0</span><br></pre></td></tr></table></figure>
<p>其他见文档　OVN Routing and ovn-trace　－　<a href="http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/" target="_blank" rel="external">http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/</a></p>
<h2 id="ovn-dhcp"><a href="#ovn-dhcp" class="headerlink" title="ovn dhcp"></a>ovn dhcp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#create dhcp port</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-dhcpport</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">#sudo ovn-nbctl lsp-set-port-security sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">options=&quot;$(sudo ovn-nbctl create DHCP_Options cidr=192.168.0.0/24 \</span><br><span class="line">options=&quot;\&quot;server_id\&quot;=\&quot;192.168.0.10\&quot; \&quot;server_mac\&quot;=\&quot;02:ac:10:ff:01:29\&quot; \</span><br><span class="line">\&quot;lease_time\&quot;=\&quot;3600\&quot; \&quot;router\&quot;=\&quot;192.168.0.10\&quot;&quot;)&quot;</span><br><span class="line">echo &quot;DHCP options is: &quot; $options</span><br><span class="line">sudo ovn-nbctl lsp-set-dhcpv4-options sw0-dhcpport $options</span><br><span class="line">sudo ovn-nbctl dhcp-options-list</span><br><span class="line">sudo ovn-nbctl lsp-get-dhcpv4-options sw0-dhcpport</span><br><span class="line"></span><br><span class="line">#create test vm</span><br><span class="line">sudo ip netns add nsi3</span><br><span class="line">sudo ovs-vsctl add-port br-int i3 -- set interface i3 type=internal</span><br><span class="line">sudo ip link set i3 address 02:ac:10:ff:01:30</span><br><span class="line">sudo ip link set i3 netns nsi3</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=sw0-i3</span><br><span class="line"></span><br><span class="line">#get ip address via dhcp</span><br><span class="line">sudo ip netns exec nsi3 dhclient i3</span><br><span class="line">sudo ip netns exec nsi3 ip addr show i3</span><br><span class="line">sudo ip netns exec nsi3 ip route show</span><br></pre></td></tr></table></figure>
<h2 id="OVN-vRouter"><a href="#OVN-vRouter" class="headerlink" title="OVN vRouter"></a>OVN vRouter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 outs-wan</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses outs-wan unknown</span><br><span class="line">sudo ovn-nbctl lsp-set-type outs-wan localnet</span><br><span class="line">sudo ovn-nbctl lsp-set-options outs-wan network_name=wanNet</span><br><span class="line"></span><br><span class="line">sudo ovs-vsctl add-br br-eth</span><br><span class="line">sudo ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=wanNet:br-eth</span><br><span class="line">sudo ovs-vsctl add-port br-eth eth0</span><br><span class="line">sudo ip link set br-eth up</span><br><span class="line">sudo ip addr add 192.168.66.111/23 dev br-eth</span><br><span class="line"></span><br><span class="line">#associated VM&apos;s port to bridge</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=i3</span><br></pre></td></tr></table></figure>
<h2 id="OVN-SNAT-DNAT"><a href="#OVN-SNAT-DNAT" class="headerlink" title="OVN SNAT/DNAT"></a>OVN SNAT/DNAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#fixed-ip: 10.0.1.103  FIP: 192.168.99.122</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;snat&quot; logical_ip=10.0.1.0/24 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;dnat_and_snat&quot; logical_ip=10.0.1.103 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br></pre></td></tr></table></figure>
<h2 id="一个问题，如何从ovn网关ping其他机器"><a href="#一个问题，如何从ovn网关ping其他机器" class="headerlink" title="一个问题，如何从ovn网关ping其他机器"></a>一个问题，如何从ovn网关ping其他机器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">如下，以前non-ovn环境下，可以从l3-agent上的qrouter-xxx上通过GW(192.168.21.1)来ping servic vm IP (192.168.21.39), 但现在ovn情况下无namespace了，该如何来做这件事呢？</span><br><span class="line">router ca47f4c3-3379-475a-ab80-fac4062e0a3e (neutron-ab4310a3-09b9-4638-8f7c-3873bc9b4c47) (aka provider-router)</span><br><span class="line">    port lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        mac: &quot;fa:16:3e:0e:f8:f5&quot;</span><br><span class="line">        networks: [&quot;192.168.21.1/24&quot;]</span><br><span class="line">    ...</span><br><span class="line">switch a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 (neutron-0f409568-561e-4e33-89ea-2814faa44add) (aka private)</span><br><span class="line">    port 3f382ff5-7601-4bec-a687-e964adadefc2</span><br><span class="line">        addresses: [&quot;fa:16:3e:f1:fa:a5 192.168.21.237&quot;]</span><br><span class="line">    port 38d6c6f7-8a64-406d-94bb-c550eb50427d</span><br><span class="line">        type: localport</span><br><span class="line">        addresses: [&quot;fa:16:3e:8d:0b:5b 192.168.21.2&quot;]</span><br><span class="line">    port c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        type: router</span><br><span class="line">        router-port: lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">    port 18ce4590-453a-4152-97b9-eafb3523047d (aka octavia-lb-6058a336-3922-468f-9f70-8e34bd14e195)</span><br><span class="line">        type: virtual</span><br><span class="line">        addresses: [&quot;fa:16:3e:ce:84:fd 192.168.21.39&quot;]</span><br><span class="line"></span><br><span class="line">这样，来做一个pingvm</span><br><span class="line">sudo ovn-nbctl lsp-add a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 pingvm</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses pingvm &quot;40:44:00:00:00:01 192.168.21.122&quot;</span><br><span class="line"></span><br><span class="line">在计算节点中继续：</span><br><span class="line">sudo ovs-vsctl add-port br-int pingvm -- set Interface pingvm type=internal -- set Interface pingvm external_ids:iface-id=pingvm</span><br><span class="line">sudo ip netns add pingvm</span><br><span class="line">sudo ip link set pingvm netns pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm address 40:44:00:00:00:01</span><br><span class="line">sudo ip netns exec pingvm ip addr add 192.168.21.122/24 dev pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm up</span><br><span class="line">sudo ip netns exec pingvm ip route add default via 192.168.21.1</span><br><span class="line"></span><br><span class="line">测试, 上面实验可能ping不了，因为应该用octavia的管理IP，但这不妨碍，思路如此．</span><br><span class="line">sudo ip netns exec pingvm ping 192.168.21.39</span><br><span class="line">sudo ip netns exec pingvm ssh 192.168.21.39</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/28/ssh总断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/28/ssh总断/" itemprop="url">ssh总断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-28T19:43:30+08:00">
                2020-10-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>公司服务器今天升级了，结果遇到了一个问题，登录在该服务器上的bastion虚机在运行 一个名为configure的脚本的下列代码时总是中断．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">set_img_properties ()</span><br><span class="line">&#123;</span><br><span class="line">    img_name=$1</span><br><span class="line">    img_version=$2</span><br><span class="line">    img_file=$3</span><br><span class="line"></span><br><span class="line">    ts=`stat ~/images/$img_file| sed -rn &apos;s/Modify:\s+([[:digit:]-]+)\s+.+/\1/p&apos;| tr -d &apos;-&apos;`</span><br><span class="line">    declare -A props=( [architecture]=x86_64</span><br><span class="line">                       [os_distro]=&apos;ubuntu&apos;</span><br><span class="line">                       [os_version]=$img_version</span><br><span class="line">                       [version_name]=&quot;$ts&quot;</span><br><span class="line">                       [product_name]=&quot;com.ubuntu.cloud:server:$&#123;img_version&#125;:amd64&quot;</span><br><span class="line">    )</span><br><span class="line">    for p in $&#123;!props[@]&#125;; do</span><br><span class="line">      openstack image set --property $p=$&#123;props[$p]&#125; $img_name &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br></pre></td></tr></table></figure></p>
<p>ssh中断之后，只能重启bastion才能解决．<br>因为一直没有问题，只是今天服务器升级才遇到问题，所以没想别的，只是要求同事也测了一下，他没遇到问题．<br>接着，以为是mtu问题，将mtu从8930改为1450依旧有问题．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 ping -O -M do -s 8930 10.5.0.8</span><br><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 nc -vz 10.5.0.8 22</span><br></pre></td></tr></table></figure></p>
<p>所以就以为是底层openstack有问题，但我没有底层openstack的管理权限，所以只好找有权限的同事帮忙，最后确定没有这方面的问题．<br>最后，就是怀疑bastion这台虚机有问题了．发现里面什么时候安装了devstack，删除devstack后，正常了．<br>但为什么之前一又没问题呢？在有devstack的情况下，代码作下列更改问题也消失．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img</span><br></pre></td></tr></table></figure></p>
<p>devstack这些东西不要乱在机器上装啊，习惯要好．上了一大课．</p>
<p>另外，如果ssh连接慢的话，可以尝试在sshd.conf中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UseDNS no</span><br><span class="line">GSSAPIAuthentication no</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/如何将国外的ftp气象大数据下载回来/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/22/如何将国外的ftp气象大数据下载回来/" itemprop="url">如何将国外的ftp气象大数据下载回来</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-22T20:49:19+08:00">
                2020-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>由于运营商对non-http流量限速，从国外ftp下载大数据将变得异常艰难．目前采用的方法如下：</p>
<p>1, 国外虚机上安装curlftpfs将ftp站点镜像到/mnt/ftp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curlftpfs -y</span><br><span class="line">#sudo fusermount -zu /mnt/ftp</span><br><span class="line">sudo mkdir -p /mnt/ftp &amp;&amp; sudo chown -R $USER /mnt/ftp</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt;/etc/fstab&apos; &lt;&lt;EOF</span><br><span class="line">curlftpfs#@ftp.hycom.org/datasets/global/GLBa0.08_rect/data /mnt/ftp fuse defaults,rw,allow_other,uid=1000,gid=1000,_netdev 0 0</span><br><span class="line">EOF</span><br><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure></p>
<p>2, 安装nginx指向/mnt/ftp将ftp变http<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx -y</span><br><span class="line">sudo vim /etc/nginx/sites-available/default</span><br><span class="line">        #root /var/www/html;</span><br><span class="line">        root /mnt/ftp;</span><br><span class="line">        location / &#123;</span><br><span class="line">                try_files $uri $uri/ =404;</span><br><span class="line">                autoindex on;</span><br><span class="line">                autoindex_exact_size off;</span><br><span class="line">                autoindex_localtime on;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>3, 国内采用下列命令下载．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -c -m http://3.18.xx.xx</span><br><span class="line">#rsync -avztur -e &quot;ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.aws/xxx.pem&quot; --progress ubuntu@3.18.xx.xx:/mnt/ftp .</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/14/Lost-connection-to-MySQL-server-during-query/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/14/Lost-connection-to-MySQL-server-during-query/" itemprop="url">Lost connection to MySQL server during query</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-14T13:37:44+08:00">
                2020-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-11-06)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>neutron designate日志中发现错误”Got lower serial for”, 并且创建zone时永远停留在PENDING状态.</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>minidns中看到下列日志:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var/log/designate/designate-mdns.log.2.gz:2018-10-23 23:27:36.016 94713 INFO designate.mdns.handler [req-26d8910d-61d5-4fd6-bc6b-df7acaf36c12 - - - - -] NotFound, refusing. Question was xxx.openstack-au-east-2.oc.xxx.com. IN SOA</span><br><span class="line">var/log/designate/designate-mdns.log.2.gz:2018-10-23 23:27:36.024 94713 WARNING designate.mdns.handler [req-fa5518dd-9506-44f8-a2ee-ee7d79ffaa3c - - - - -] ZoneNotFound while handling axfr request. Question was xxx.openstack-au-east-2.oc.xxx.com. IN AXFR: ZoneNotFound: Could not find Zone</span><br></pre></td></tr></table></figure></p>
<p>根据代码[1], 查询DB时报ZoneNotFound从而导致无法构建SOA无法构建axfr response, 从而导致minidns master与bind9 slave无法做zone transfer, 这样导致bind9 slave的serial number也无法更新, 最终在minidns notify时看到”Got lower serial for”</p>
<p>在发生ZoneNotFound的附近有下列日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[req-b48612b0-ed3e-46d9-8510-6634282ef0a2 - - - - -] Database connection was found disconnected; reconnecting: DBConnectionError: (pymysql.err.OperationalError) (2013, &apos;Lost connection to MySQL server during query&apos;) [SQL: u&apos;SELECT 1&apos;]</span><br></pre></td></tr></table></figure>
<p>于是, 用下列测试程序重现了上述DB error,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">from sqlalchemy.engine import create_engine</span><br><span class="line">url = &apos;mysql+pymysql://root@127.0.0.1:3306/mysql&apos;</span><br><span class="line">engine = create_engine(url, pool_recycle=4).connect()</span><br><span class="line">query = &apos;SELECT NOW();&apos;</span><br><span class="line">while True:</span><br><span class="line">    print(&apos;Q1&apos;, engine.execute(query).fetchall())</span><br><span class="line">    engine.execute(&apos;SET wait_timeout=2&apos;)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    print(&apos;Q2&apos;, engine.execute(query).fetchall())</span><br></pre></td></tr></table></figure>
<p>或者使用oslo.db测试程序:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p -e &quot;SET GLOBAL wait_timeout=5, slow_query_log=on, long_query_time=0.0;&quot;</span><br><span class="line"></span><br><span class="line">$ cat test.py</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">from oslo_config import cfg</span><br><span class="line">from oslo_db import options as db_options</span><br><span class="line">from oslo_db.sqlalchemy import session as db_session</span><br><span class="line">from sqlalchemy.sql.expression import select</span><br><span class="line">_facade = db_session.EngineFacade(&quot;mysql://root@localhost/test&quot;)</span><br><span class="line">x = _facade.get_session()</span><br><span class="line">print(x.scalar(select([23])))</span><br><span class="line">time.sleep(5)</span><br><span class="line">print(x.scalar(select([23])))</span><br></pre></td></tr></table></figure></p>
<p>连接线的过期时间(pool_recycle, 连接池里的连接空闲一段时间后自动释放, oslo中默认是3600)不能大于服务器端的wait_timeout时间(这里是2, 默认是8小时). 所以应该设置wait_timeout大于3600, 或者haproxy中的配置大于3600.<br>wait_timeout是mysql的一个设置，主要是用来断开不使用的数据库连接。当连接空闲的时间达到wait_timeout设置的最大值时，mysql会主动切断这个连接，以供别的客户端连接数据库。这个值一般是28800，也就是8小时。在mysql中可以通过： show variables like “%timeout%”;获取。<br>另外，当数据库主动切断连接的时候，mysql客户端并不知道这个连接已经被切断，所以程序并不知道其已经无效了，如果mysql客户端再不支持ReConnect，双重的问题叠加在一起就会导致连接池返回无效连接的可能.</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p> mysqldump –single-transaction -u root -p designate –skip-extended-insert &gt; /tmp/designate-$(date +%s).sql</p>
<p>For the error ‘Lost connection to MySQL server during query’,</p>
<p>wait_timeout is a setting of mysql, which is used for server side to disconnect unused client connections proactively. The default is 8 hours(28800), we can check it by ‘show variables like “%timeout%”;’ or ‘juju config mysql wait-timeout’</p>
<p>All the rest of the timeout below should be less than wait_timeout, if they are greater than wait_timeout, the error ‘Lost connection to MySQL server during query’ will happen.<br>1, the default value of olso’s connection_recycle_time is 3600<br>2, the timeout in haproxy.cfg</p>
<p>So we need to collect the following info for further analyses.</p>
<p>1, juju config mysql wait-timeout<br>2, mysql -unova -p -h<mysql_ip> -e ‘show variables like “%timeout%”‘  #eg: run it in nova-cloud-controller/0<br>3, juju ssh neutron-api/0 – sudo grep -r ‘connection_recycle_time’ /etc/neutron/<br>4, juju ssh neutron-api/0 – sudo grep -r ‘timeout’ /etc/haproxy/</mysql_ip></p>
<h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#This will show which openstack service is using the most mysql connections</span><br><span class="line">select user, count(*) from information_schema.processlist group by user;</span><br><span class="line"></span><br><span class="line">juju run --application mysql leader-get</span><br><span class="line">juju run --application mysql &quot;mysql -uroot -pChangeMe123 -e \&quot;SELECT IFNULL(usr,&apos;All Users&apos;) user,IFNULL(hst,&apos;All Hosts&apos;) host,COUNT(1) Connections FROM (SELECT user usr,LEFT(host,LOCATE(&apos;:&apos;,host) - 1) hst FROM information_schema.processlist WHERE user NOT IN (&apos;system user&apos;,&apos;root&apos;)) A GROUP BY usr,hst WITH ROLLUP;\&quot;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><p>openstack的各服务都有大量的这种错误：<br>var/log/mysql/error.log:2019-08-29T16:07:45.335406Z 420821 [Note] Aborted connection 420821 to db: ‘keystone’ user: ‘keystone’ host: ‘10.191.5.49’ (Got timeout reading communication packets)</p>
<p>要求客户增大了connect_timeout, net_read_timeout, net_write_timeout, interactive_timeout后使用‘show global status like ‘aborted%’;’看到Aborted_clients的数目仍在增大<br>show global variables like ‘max_conn%’;<br>show global variables like ‘%timeout%’;<br>show global status like ‘aborted%’;<br>show processlist;</p>
<p>这时发现在21:55:48， 所有的designate serveres都收到了mysql错误， 通过mysql的查询日志找到21:04到21:16之间mysql收到了40个gnocchi查询，一个查询就要返回500MB的大小, 然后看到了警告：InnoDB: Warning: difficult to find free blocks in the buffer pool (338 search iterations)!”<br>所以看起来像是IO swamp的问题进而造成查询超时。解决方法：<br>1， 增加innodb_buffer_pool_size (juju中通过dataset-size控制）<br>2, 删除gnocchi中的相关数据<br>3, 调查designate中当遇到mysql超时时是不是会反复retry造成对DB的flood</p>
<h2 id="20201014更新"><a href="#20201014更新" class="headerlink" title="20201014更新"></a>20201014更新</h2><p>amphora-agent writes heatbeat to udp, then octavia-health-manager gets heatbeat from udp and writes them to DB, finally health_manager gets heartbeat from DB via get_stale_amphora to decide if failover process will be started</p>
<p>当health-manager线程的数目(pgrep -af /usr/bin/octavia-health-manager | wc -l, 160)大于mysql的连接数时(ss -tp | grep -c :mysql, 90)时上面的get_stale_amphora就会报”Lost connection to MySQL server during query”错误(排除wait-timeout!=3600这个因素之后),<br>sqlalchemy看到这个错误后就会reconnect, 从而产生下面提到的”QueuePool limit of size 10 overflow 20 reached, connection timed out, timeout 10”这个错误(<a href="http://sqlalche.me/e/3o7r" target="_blank" rel="external">http://sqlalche.me/e/3o7r</a>). sqlalchemy’s reconnect可能不是replace, 而是删除老连接然后建立新连接, 这次当达到max_pool_size+max_overflow=20个连接后永远无新连接供它reconnect(sqlalchemy使用max_pool_size=10, 当一次使用多于5时, 会用到默认的max_overflow=10这样可以达到15个连接, 但多于20个后不再允许溢出.), 这可能是一个bug - <a href="https://github.com/sqlalchemy/sqlalchemy/issues/5308" target="_blank" rel="external">https://github.com/sqlalchemy/sqlalchemy/issues/5308</a></p>
<p>可能在mysql在做failover时会出现这种情况, 因为new VIP owner没有old TCP connections从而导致之后的old TCP connections to go stale从而导致reconnect.</p>
<p>可能的解决方法:<br>1, 如果mysql不再failover的话可能这个问题也不再重启了, 这个可以等下列fix<br>2, as a base leve request a stable backport for the following patch<br>health-manager的eventlet/greenlet的数目由health_update_threads参数决定, 默认与CPU核数同, 大多数情况下都是短连接会多路复用还没问题, 但有时候也会各种因素让有的变成长连接. charm中一般对于worker threads有0.25x的乘数(LXD容器中最大是4), octavia-charm也应该用这个乘数来减小worker threads的数目 - <a href="https://bugs.launchpad.net/charm-octavia/+bug/1889731" target="_blank" rel="external">https://bugs.launchpad.net/charm-octavia/+bug/1889731</a><br>3, We could additionally reconfigure the oslo.db [database] section to include a pool overflow limit at least as large as the number of expected threads by worker-multiplier<br>4, We could additionally open a bug against sqlalchemy that it should allow for connection replacement even when the pool limit is reached</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://github.com/openstack/designate/blob/stable/queens/designate/mdns/handler.py#L233" target="_blank" rel="external">https://github.com/openstack/designate/blob/stable/queens/designate/mdns/handler.py#L233</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/29/UEFI-Secure-Boot学习草稿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/29/UEFI-Secure-Boot学习草稿/" itemprop="url">UEFI Secure Boot学习草稿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-29T19:17:27+08:00">
                2020-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-29<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="什么是secure-boot"><a href="#什么是secure-boot" class="headerlink" title="什么是secure boot"></a>什么是secure boot</h2><p>secureboot is designed to present non-Windows OS from booting(Secure Boot works by placing the root of trust in firmware), you can still boot Grub2 with secureboot using shim and MOK manager. And from grub2, you can boot into other operating systems.也就是说:<br>secureboot将根证书放在固件firmware中, 然后可以验证signed bootloader, signed bootloader然后再验证signed kernel和signed 2nd stage boot loader.这样系统允许你修改secureboot keys.</p>
<ul>
<li>db, 允许bootloaders的公钥集合</li>
<li>dbx, 不允许bootloaders的公钥集合</li>
<li>KEK, 允许操作db的公钥集合</li>
<li>PK, 允许操作KEK的私钥.</li>
</ul>
<p>默认地, 系统有硬件制造商的PK, microsoft和硬件制造商的公钥在db与KEK里. 这样就可以使用microsoft-certified bootloaders, 再通过它签名的shim来使用其他linuxers. 有的UEFI BIOS setup允许adding and delteing所有的secureboot keys, 而有些却允许你要么删除所有要么用默认(删除之前记得备份哦). 如果PK被删除的话, secure boot这时叫so-called setup mode. 你可能想有这个密钥:<br>the db set should contain:</p>
<ul>
<li>your own public key certificate, for booting things you’ve explicitly signed</li>
<li>maybe your favorite Linux distribution’s kernel signing certificate, if you want to use pre-packaged kernels without manually re-signing them</li>
<li>maybe hardware vendor’s certificate, to allow installing firmware updates if necessary maybe Microsoft’s third-party UEFI certificate, to allow the use of pre-packaged Linux bootloaders and live Linux boot media without explicitly re-signing them or disabling Secure Boot</li>
<li>maybe Microsoft’s OS signing certificate, if you dual-boot with Windows</li>
</ul>
<p>the KEK set should contain:</p>
<ul>
<li>your own certificate, for updating db and dbx</li>
<li>if your system includes UEFI-aware Microsoft OSs, you may want to include Microsoft’s KEK certificate, as Microsoft’s updates sometimes include updates to db and/or dbx and those updates won’t install successfully if access to Secure Boot is denied</li>
<li>and finally, once all the rest is set up as you want, you should place your own certificate into PK to make Secure Boot effective again.</li>
</ul>
<h2 id="有无shim"><a href="#有无shim" class="headerlink" title="有无shim"></a>有无shim</h2><p>bootloader有两种, shim与grub2都叫bootloader, 所以理论上是可以不需要shim的, 但为什么需要shim呢? 这个网页(<a href="https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only)说:grub" target="_blank" rel="external">https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only)说:grub</a> uses firmware API to validate binary signatures; you might prefer shim instead of signing the binaries with the “precious” key each time.</p>
<p>非secureboot模式下, 没有shim组件, efi直接启动grub2.<br>在secureboot模式下, 有shim组件, 且shim需要使用efi中的证书签名(grub2和kernel的签名不一定非要用efi中的证书, 可以自己随意定制后再使用shim相关工具导入nvram中). 即使在secureboot模式下也可以有shim和无shim:</p>
<ul>
<li>无shim, 在centos中可以跳过shim, 直接让efi启动grub2也是没问题的, 但grub2与kernel都需要使用efi中的证书签名, 由efi进行grub2与kernel的校验.</li>
<li>有shim, grub2中用户选择kernel后, grub2回调shim组件校验kernel(grub2, kernel使用相同的私钥签名)</li>
</ul>
<h2 id="可信问题"><a href="#可信问题" class="headerlink" title="可信问题"></a>可信问题</h2><ul>
<li>initrd和intrd加载的模式都是不可信的, 这部分都没有经过签名;</li>
<li>systemtap, kexec, kdump也都是没有签名的;</li>
<li>第三方KO模式没有签名(正常情况下, 模块需要使用mok签名, shim来验证)</li>
</ul>
<h2 id="secureboot启动流程"><a href="#secureboot启动流程" class="headerlink" title="secureboot启动流程"></a>secureboot启动流程</h2><p>1, 打开电源, 先运行Secure Boot-capable UEFI firmware (对于qemu虚机, 这个secureboot capable UEFI OVMF firmware叫UEFI x86_64 : usr/share/OVMF/OVMF_CODE.fd,  (sudo apt install ovmf &amp;&amp; sudo systemctl restart libvirtd)</p>
<p>2, firware验证bootloader的签名. UEFI firmware中预先在NVRAM系统中(或者compiled-in defaults)集成了一些公钥集合(secure boot key sets) , 它可以给bootloader验证签名(shim or grub2), 不使用shim的话, grub2得每次调用firware api去验证签名.</p>
<p>UEFI firmware uses /boot/efi/EFI/BOOT/BOOTX64.EFI (从md5sum看它和/boot/efi/EFI/centos/shimx64.efi是同一个文件,  对于shim就是将shimx64.efi拷贝到BOOTX64.EFI, 对于grub2可能就是将grubx64.efi拷贝到BOOTX64.EFI了) to boot at the first stage.</p>
<p>[root@test2 ~]# md5sum /boot/efi/EFI/BOOT/BOOTX64.EFI<br>25d9ccc49c419d76324a29615e8371c2  /boot/efi/EFI/BOOT/BOOTX64.EFI<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/shimx64.efi<br>25d9ccc49c419d76324a29615e8371c2  /boot/efi/EFI/centos/shimx64.efi<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/shimx64-centos.efi<br>d435494a957479acac3aca09915c21d1  /boot/efi/EFI/centos/shimx64-centos.efi<br>[root@test2 ~]# md5sum /boot/efi/EFI/centos/grubx64.efi<br>031b972f3ab267f37e01ada73f4b480d  /boot/efi/EFI/centos/grubx64.efi</p>
<p>3, bootloader再去验证kernel的签名.</p>
<p>then shim will load grub2 (/boot/efi/EFI/centos/grubx64.efi) in the second stage</p>
<p>4, kernel再去验证module的签名.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://wiki.ubuntu.com/UEFI/SecureBoot/Testing?action=show&amp;redirect=SecurityTeam%2FSecureBoot" target="_blank" rel="external">https://wiki.ubuntu.com/UEFI/SecureBoot/Testing?action=show&amp;redirect=SecurityTeam%2FSecureBoot</a><br>[2] <a href="https://www.aioboot.com/en/secure-boot/" target="_blank" rel="external">https://www.aioboot.com/en/secure-boot/</a><br>[3] <a href="https://specs.openstack.org/openstack/nova-specs/specs/train/approved/allow-secure-boot-for-qemu-kvm-guests.html" target="_blank" rel="external">https://specs.openstack.org/openstack/nova-specs/specs/train/approved/allow-secure-boot-for-qemu-kvm-guests.html</a><br>[4] Grub 2：拯救你的 bootloader, <a href="https://linux.cn/article-6892-1.html?pr" target="_blank" rel="external">https://linux.cn/article-6892-1.html?pr</a><br>[5] <a href="https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only" target="_blank" rel="external">https://unix.stackexchange.com/questions/423666/secureboot-with-uefi-bootloader-and-grub2-only</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/18/引入nova-placement之后对调度的影响/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/18/引入nova-placement之后对调度的影响/" itemprop="url">引入nova placement之后对调度的影响</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-18T15:33:22+08:00">
                2020-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-17<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="nova-cell-v2"><a href="#nova-cell-v2" class="headerlink" title="nova cell v2"></a>nova cell v2</h2><p>nova cell v2将nova db分成了3个(nova, nova_api, nova_cell0，虚机信息只存储在所在的cell中，公共数据存储在nova_api库中), nova_api中的3个表(nova_api.host_mappings, nova_api.instance_mappings, nova_api.cell_mappings可以直接从instance找到cell_id进而找到DB与MQ的信息，这样nova-api直接就可以操作该cell之类的DB与MQ从而可以让nova-compute可以水平扩展到更多的物理节点，另一方面，nova-api节点也不再需要nova-cell服务，要有nova-api与nova-scheduler两个服务即可．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; pager less -S</span><br><span class="line">PAGER set to &apos;less -S&apos;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">mysql&gt; select instance_uuid,cell_id from instance_mappings;</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| instance_uuid                        | cell_id |</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| 4039ed4e-d0a1-46ba-99a5-68bc84421b42 |       2 |</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from host_mappings;</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| created_at          | updated_at | id | cell_id | host                                |</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| 2020-09-16 06:18:26 | NULL       |  1 |       2 | juju-3ba760-ceilometer-15.cloud.sts |</span><br><span class="line"></span><br><span class="line">mysql&gt; select transport_url,name,database_connection from cell_mappings;</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| transport_url                                                                                            | name  | database_connection                                                         |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| none:///                                                                                                 | cell0 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova_cell0 |</span><br><span class="line">| rabbit://nova:wSz5LjscfBqKnhVWKBZnrXdwS5Kz6TByz9jKfm2xKHbCRYPPSbcnqFwPTnCp8VpP@10.5.0.199:5672/openstack | cell1 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova       |</span><br></pre></td></tr></table></figure>
<p>所以当遇到这种错误时:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br><span class="line">No server with a name or ID of 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nova-manage cell_v2 list_cells</span><br><span class="line">sudo nova-manage cell_v2 map_instances --cell_uuid &lt;cell-id-from-above&gt;</span><br><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure>
<h2 id="nova-placement-API"><a href="#nova-placement-API" class="headerlink" title="nova placement API"></a>nova placement API</h2><p>nova placement API在Newton被引入, nova-scheduler调用placement-api用于调度. 主要用于跟踪记录Resource Provider(compute-node, external storage-pool, external ip-allocation-pool etc)的Inventory和Usage.自Pike版本, 必须启用Placement API来辅助nova-scheduler service进行compute node调度，并以此替代之前的RAMFilter、CoreFilter和DiskFilter。概念对象如下:</p>
<ul>
<li>Resource Class, 资源种类, placement api默认实现了DISK_GB, MEMORY_MB,VCPU三种标准resource classes, 也提供了custom resource classes的接口.</li>
<li>Resource Providers：资源提供者，实际提供资源的对象，例如：compute node、storage pool</li>
<li>Inventory：资源清单，资源提供者所拥有的资源清单，例如：compute node 拥有的vCPU、Disk、RAM 等 inventories</li>
<li>Resource Allocations：资源分配状况，包含了Resource Class、Resource Provider以及Consumer 的映射关系。记录消费者使用了多少该类型的资源数量</li>
<li>Provider Aggregate：资源聚合，类似 HostAggregate 的概念</li>
<li>Traits：资源特征，不同资源提供者可能会具有不同的资源特征。Traits 作为资源提供者特征的描述，它不能够被消费，但在某些Workflow 或者会需要这些信息。例如：标识可用的Disk是一个SSD，可以帮助Scheduler更好的匹配 instance boot请求。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from resource_providers;</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| created_at          | updated_at          | id | uuid                                 | name                                | generation | can_host | root_provider_id | parent_provider_id |</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | 2020-09-16 10:19:33 |  1 | a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |     NULL |                1 |               NULL |</span><br><span class="line"></span><br><span class="line"># for the field resource_class_id, 0 means VCPU, 1 means MEMORY_MB, 2 means DISK_GB</span><br><span class="line">mysql&gt; select * from inventories;</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | resource_class_id | total | reserved | min_unit | max_unit | step_size | allocation_ratio |</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  1 |                    1 |                 0 |     2 |        0 |        1 |        2 |         1 |               16 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  2 |                    1 |                 1 |  3944 |      512 |        1 |     3944 |         1 |              1.5 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  3 |                    1 |                 2 |    38 |        0 |        1 |       38 |         1 |                1 |</span><br><span class="line">mysql&gt; select * from allocations;</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | consumer_id                          | resource_class_id | used |</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 16 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 2 |    1 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 17 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 1 |   64 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 18 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 0 |    1 |</span><br></pre></td></tr></table></figure>
<h2 id="Placement-CLI"><a href="#Placement-CLI" class="headerlink" title="Placement CLI"></a>Placement CLI</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-osc-placement -y</span><br><span class="line"></span><br><span class="line">$ openstack resource provider list</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| uuid                                 | name                                | generation |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">$  openstack resource provider inventory list a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| resource_class | allocation_ratio | min_unit | max_unit | reserved | step_size | total |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| VCPU           |             16.0 |        1 |        2 |        0 |         1 |     2 |</span><br><span class="line">| MEMORY_MB      |              1.5 |        1 |     3944 |      512 |         1 |  3944 |</span><br><span class="line">| DISK_GB        |              1.0 |        1 |       38 |        0 |         1 |    38 |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line"></span><br><span class="line">$ openstack resource provider usage show a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+-------+</span><br><span class="line">| resource_class | usage |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| VCPU           |     3 |</span><br><span class="line">| MEMORY_MB      |   192 |</span><br><span class="line">| DISK_GB        |     3 |</span><br><span class="line">+----------------+-------+</span><br></pre></td></tr></table></figure>
<h2 id="one-bug"><a href="#one-bug" class="headerlink" title="one bug"></a>one bug</h2><p>例如, 如<a href="https://bugs.launchpad.net/nova/+bug/1679750描述的场景" target="_blank" rel="external">https://bugs.launchpad.net/nova/+bug/1679750描述的场景</a>, 在hostA上创建一虚机,hostA死掉了, 这时删除虚机时无法删除实例(因为nova-compute这时死掉了啊), 这样会导致allocations表中的记录没有被删除. 如果hostA又起来了, nova-compute的init_host-&gt;_complete_partial_deletion<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre_start_hook -&gt; update_available_resource -&gt; nova/compute/manager.py#update_available_resource_for_node -&gt; update_available_resource -&gt; _update_available_resource -&gt; _remove_deleted_instances_allocations</span><br></pre></td></tr></table></figure></p>
<p>当把一个nova-compute删除时，删了service和compute_node表记录后,却没有删除placement resource provider和host mapping records.<br>nova-compute自己都死了它是没法自己删自己的,所以改由nova-api在启动时在删除instances时也删除allocations表中的记录 -<br><a href="https://review.opendev.org/#/c/580498/" target="_blank" rel="external">https://review.opendev.org/#/c/580498/</a></p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * nova_api.from host_mappings;</span><br><span class="line">select * from nova_api.cell_mappings;</span><br><span class="line">select * from nova_api.resource_providers where name like &apos;%xxx%&apos;;   xx.bos01.xxx (9)</span><br><span class="line">select * from nova.compute_nodes where host like &apos;%bagon%&apos; or hypervisor_hostname like &apos;%xxx%&apos;;</span><br><span class="line">select * from nova_api.inventories where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;);</span><br><span class="line">select * from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;) order by consumer_id,resource_provider_id,resource_class_id;</span><br><span class="line">select uuid, host, node, vcpus, memory_mb, vm_state, power_state, task_state, root_gb, ephemeral_gb, cell_name,deleted from nova.instances where uuid in (select consumer_id from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;)) order by uuid;</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://blog.csdn.net/jmilk/article/details/81264240" target="_blank" rel="external">https://blog.csdn.net/jmilk/article/details/81264240</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/10/如何让novnc-websockify支持tls1-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/10/如何让novnc-websockify支持tls1-2/" itemprop="url">如何让novnc/websockify支持tls1.2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-10T15:04:57+08:00">
                2020-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-10<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>如果希望novnc使用tls1.2该怎么办？<br>各软件(openssl, websockify, nova)支持tls1.2的历史情况如下：</p>
<ul>
<li>openssl在1.0.0h到1.0.1的时候才开始支持tls1.2, 见”Add TLS v1.2 server support for client authentication” - <a href="https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本" target="_blank" rel="external">https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本</a></li>
<li>ubuntu 20.04开始默认使用tls1.2 [2]</li>
<li>websockify在0.9.0才开始支持配置tls版本, 见 - <a href="https://pypi.org/project/websockify/" target="_blank" rel="external">https://pypi.org/project/websockify/</a>, 所以在nova xenial/mitaka版本中因为使用了websockify0.8.0所以列代码也不支持配置tls版本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;ssl.wrap_sock&apos; /usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py -A 7</span><br><span class="line">            wrapped_sock = ssl.wrap_socket(</span><br><span class="line">                compute_sock,</span><br><span class="line">                keyfile=client_key,</span><br><span class="line">                certfile=client_cert,</span><br><span class="line">                server_side=False,</span><br><span class="line">                cert_reqs=ssl.CERT_REQUIRED,</span><br><span class="line">                ca_certs=CONF.vnc.vencrypt_ca_certs)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这样，后来在nova升级到websockify 0.9.0之后也开始有了一个patch支持配置tls版本,见<br><a href="https://review.opendev.org/#/c/679502/" target="_blank" rel="external">https://review.opendev.org/#/c/679502/</a><br>但是，目前我们使用的就是xenial，该如何办呢？<br>首先，因为使用的是websockify 0.8.0不支持配置ssl版本，那样想在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2＂来强制使用tls1_2是可行的．（如果不可行，是因为下列错误导致，见： <a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a> )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br></pre></td></tr></table></figure></p>
<p>那样，是否应该改变底层openssl的默认配置成tls1.2, 参考文档[1], 修改/etc/ssl/openssl.cnf在oid_section之后添加下列内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# grep -r &apos;oid_section&apos; /etc/ssl/openssl.cnf -A 2</span><br><span class="line">oid_section             = new_oids</span><br><span class="line"></span><br><span class="line">openssl_conf = default_conf</span><br><span class="line"></span><br><span class="line">root@juju-055b8b-ssl-7:~# cat /etc/ssl/openssl.cnf |tail -n9</span><br><span class="line">[default_conf]</span><br><span class="line">ssl_conf = ssl_sect</span><br><span class="line"></span><br><span class="line">[ssl_sect]</span><br><span class="line">system_default = system_default_sect</span><br><span class="line"></span><br><span class="line">[system_default_sect]</span><br><span class="line">MinProtocol = TLSv1.2</span><br><span class="line">CipherString = DEFAULT@SECLEVEL=2</span><br></pre></td></tr></table></figure></p>
<p>但是使用下列方法测试时报错．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nova-novncproxy nova-consoleauth</span><br><span class="line"># verify if tls 1.2 is supported - https://devanswers.co/test-server-tls-1-2-ubuntu/</span><br><span class="line"># https://www.poftut.com/use-openssl-s_client-check-verify-ssltls-https-webserver/</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line"></span><br><span class="line">#list all supported ciphers</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6080 10.5.100.4</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.2.196:6082 -tls1_2</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line">Error configuring OpenSSL</span><br><span class="line">139929571108504:error:25066067:DSO support routines:DLFCN_LOAD:could not load the shared library:dso_dlfcn.c:187:filename(libssl_conf.so): libssl_conf.so: cannot open shared object file: No such file or directory</span><br><span class="line">139929571108504:error:25070067:DSO support routines:DSO_load:could not load the shared library:dso_lib.c:233:</span><br><span class="line">139929571108504:error:0E07506E:configuration file routines:MODULE_LOAD_DSO:error loading dso:conf_mod.c:271:module=ssl_conf, path=ssl_conf</span><br><span class="line">139929571108504:error:0E076071:configuration file routines:MODULE_RUN:unknown module name:conf_mod.c:212:module=ssl_conf</span><br></pre></td></tr></table></figure>
<p>错误是找不着libssl_conf.so，作下列更改后，问题依旧 ．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libssl1.0.0 libssl-dev</span><br><span class="line">cd /lib/x86_64-linux-gnu/</span><br><span class="line">sudo ln -s libssl.so.1.0.0 libssl.so.10</span><br><span class="line">sudo ln -s libcrypto.so.1.0.0 libcrypto.so.10</span><br></pre></td></tr></table></figure></p>
<p>20201120更新-是需要添加<strong>OPENSSL_CONF=/etc/ssl/</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># OPENSSL_CONF=/etc/ssl/ openssl ciphers -v TLSv1.2 | head -4</span><br><span class="line">ECDHE-RSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-RSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AES(256)  Mac=SHA384</span><br><span class="line">ECDHE-ECDSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AES(256)  Mac=SHA384</span><br></pre></td></tr></table></figure></p>
<p>将xenial上的openssl 1.1.0g升级到1.1.1a后问题依旧:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#upgrade openssl from 1.1.0g to 1.1.1a in ubuntu 18.04</span><br><span class="line">sudo apt install build-essential checkinstall zlib1g-dev gcc make -y</span><br><span class="line">wget https://www.openssl.org/source/openssl-1.1.1a.tar.gz</span><br><span class="line">tar zxvf openssl-1.1.1a.tar.gz &amp;&amp; cd openssl-1.1.1a/</span><br><span class="line">./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/ld.so.conf.d/openss1-1.1.1b.conf&apos; &lt;&lt; EOF</span><br><span class="line">/usr/local/ssl/lib</span><br><span class="line">EOF</span><br><span class="line">sudo ldconfig -v</span><br><span class="line">sudo mv /usr/bin/c_rehash /usr/bin/c_rehash.BAK</span><br><span class="line">sudo mv /usr/bin/openssl /usr/bin/openssl.BAK</span><br><span class="line">sudo cp /etc/environment /etc/environment.BAK</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/environment&apos; &lt;&lt; EOF</span><br><span class="line">PATH=&quot;/usr/local/ssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games&quot;</span><br><span class="line">EOF</span><br><span class="line">echo $PATH</span><br><span class="line">openssl version -a</span><br><span class="line">sudo apt-get install libssl-dev -y</span><br></pre></td></tr></table></figure></p>
<p>然后修改/usr/lib/python2.7/dist-packages/websockify/websocket.py（注意，不是/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py）里的ssl.wrap_socket添加’ssl_version=ssl.PROTOCOL_TLSv1_2’就可以了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nmap --script ssl-enum-ciphers -p 6080 10.5.100.4 |grep TLSv</span><br><span class="line">|   TLSv1.2:</span><br><span class="line">root@juju-055b8b-ssl-7:~/openssl-1.1.1a# openssl s_client -connect 10.5.100.4:6080 -tls1_2 |grep &apos;CN&apos;</span><br><span class="line">depth=0 C = GB, ST = England, L = London, O = Ubuntu Cloud, OU = Cloud, CN = 10.5.100.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>此时，去掉/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py里之前做的tls1.2修改也是可以的．<br>结论，似乎修改底层openssl的默认版本到tls1.2不好使，同时websockify 0.8.0默认的只是tls1.0, 此时只是修改nova端是不work的，直接修改websockify 0.8.0改到tls1.2是可以的．在websockify 0.9.0之后支持配置tls1.2，所以此时nova端修改tls的patch也就能派上用场了．<br>相关代码分析：<br>python ssl模块在wrap_socket中是将参数硬编码成ssl_version=PROTOCOL_SSLv23，所以在websockify 0.8.0不传ssl_version参数的话是即使改底层openssl的默认编码也是无济于事的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def wrap_socket(sock, keyfile=None, certfile=None,</span><br><span class="line">                server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line">                ssl_version=PROTOCOL_SSLv23, ca_certs=None,</span><br><span class="line">                do_handshake_on_connect=True,</span><br><span class="line">                suppress_ragged_eofs=True, ciphers=None):</span><br></pre></td></tr></table></figure></p>
<p>看来唯一的办法是修改python-websockify 0.8.0包，加上那一行，做个临时hotfix了．</p>
<h2 id="20201106更新"><a href="#20201106更新" class="headerlink" title="20201106更新"></a>20201106更新</h2><p>创建了一个xenial的spice ssl测试环境．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl2:stsstack --num-compute 1 --openstack-dashboard --ssl --nova-console --run</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=/home/ubuntu/ed/stsstack-bundles/openstack/ssl/openstack-ssl2/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=spice</span><br><span class="line">juju config nova-cloud-controller console-ssl-cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-ssl-key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>但我们尽量不用–ssl，改用–vault<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl-queens:stsstack --num-compute 1 --nova-console --vault</span><br></pre></td></tr></table></figure></p>
<p>看到下列错，实际上这是正常的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ nova get-vnc-console bionic-061058 spice-html5</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| Type | Url |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| spice-html5 | https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015 |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">$ curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015</span><br><span class="line">* Trying 10.5.100.4:6082...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 10.5.100.4 (10.5.100.4) port 6082 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">* CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.3 (OUT), TLS alert, protocol version (582):</span><br><span class="line">* error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line"></span><br><span class="line">-root@juju-1833ad-ssl2-7:~# tail -f /var/log/nova/nova-spiceproxy.log</span><br><span class="line">2020-11-06 06:42:33.666 26162 DEBUG nova.console.websocketproxy [-] 10.5.0.8: new handler Process vmsg /usr/lib/python2.7/dist-packages/websockify/websocket.py:878</span><br><span class="line">2020-11-06 06:42:34.166 19170 INFO nova.console.websocketproxy [-] handler exception: [SSL: SSLV3_ALERT_CERTIFICATE_UNKNOWN] sslv3 alert certificate unknown (_ssl.c:590)</span><br></pre></td></tr></table></figure></p>
<p>为什么说它是正常的呢？因为我们是在focal上运行的curl命令或者浏览器，focal支持的最低ssl版本是tlsv1.2，而spiceproxy运行在xenial只支持tlsv1.0.　所以找一台xenial机器运行下列加了–tlsv1.0的curl命令是OK的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=bd00bb9f-83e7-4b25-9b6a-57dde9941dce --tlsv1.0</span><br></pre></td></tr></table></figure></p>
<p>还是上面类似的老问题，spice也用到了websockify0.8，而它写死了 ssl_version=PROTOCOL_TLSv1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; /usr/lib/python2.7/dist-packages/websockify/websocket.py(837)do_handshake()</span><br><span class="line">-&gt; retsock = ssl.wrap_socket(</span><br><span class="line">(Pdb) l</span><br><span class="line">832                     raise self.EClose(&quot;SSL connection but &apos;%s&apos; not found&quot;</span><br><span class="line">833                                       % self.cert)</span><br><span class="line">834                 retsock = None</span><br><span class="line">835                 try:</span><br><span class="line">836                     import rpdb;rpdb.set_trace()</span><br><span class="line">837  -&gt;                 retsock = ssl.wrap_socket(</span><br><span class="line">838                             sock,</span><br><span class="line">839                             server_side=True,</span><br><span class="line">840                             certfile=self.cert,</span><br><span class="line">841                             keyfile=self.key)</span><br><span class="line">842                 except ssl.SSLError:</span><br><span class="line">(Pdb) p self.cert</span><br><span class="line">&apos;/etc/nova/ssl/nova_cert.pem&apos;</span><br><span class="line">(Pdb) p self.key</span><br><span class="line">&apos;/etc/nova/ssl/nova_key.pem&apos;</span><br><span class="line">(Pdb) l</span><br><span class="line"> 48</span><br><span class="line"> 49         def __init__(self, sock, keyfile=None, certfile=None,</span><br><span class="line"> 50                      server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line"> 51                      ssl_version=PROTOCOL_TLSv1, ca_certs=None,</span><br><span class="line"> 52                      do_handshake_on_connect=True, *args, **kw):</span><br><span class="line"> 53  -&gt;         if not isinstance(sock, GreenSocket):</span><br><span class="line"> 54                 sock = GreenSocket(sock)</span><br><span class="line"> 55</span><br><span class="line"> 56             self.act_non_blocking = sock.act_non_blocking</span><br><span class="line"> 57</span><br><span class="line"> 58             if six.PY2:</span><br><span class="line"></span><br><span class="line">root@juju-1833ad-ssl2-7:~# pip list |grep web</span><br><span class="line">websockify (0.8.0)</span><br></pre></td></tr></table></figure></p>
<p>但直接在xenial上升级到websockify=0.9.0失败.</p>
<h2 id="在queens中使用websockify-0-9-0"><a href="#在queens中使用websockify-0-9-0" class="headerlink" title="在queens中使用websockify 0.9.0"></a>在queens中使用websockify 0.9.0</h2><p>将websockify的patch backedport到0.8.0时依赖太多，所以只能将0.9.0整体backport到queens. 测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/lib/python2.7/dist-packages/websockify ~/websockify_bak</span><br><span class="line">git clone https://github.com/novnc/websockify.git</span><br><span class="line">cd websockify &amp;&amp; git checkout -b v0.9.0 v0.9.0</span><br><span class="line">cd ../ &amp;&amp; cp -r websockify/websockify /usr/lib/python2.7/dist-packages/</span><br><span class="line"></span><br><span class="line">cp allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch /usr/lib/python2.7/dist-packages/</span><br><span class="line">cd  /usr/lib/python2.7/dist-packages/ &amp;&amp; patch -p1 &lt;allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch</span><br><span class="line"></span><br><span class="line">then set the following content in /etc/nova/nova.conf</span><br><span class="line">[console]</span><br><span class="line">ssl_minimum_version=tlsv1_2</span><br><span class="line"></span><br><span class="line">vim /usr/lib/python2.7/dist-packages/nova/console/websocketproxy.py</span><br><span class="line">    def socket(self, *args, **kwargs):</span><br><span class="line">        #return websockify.WebSocketServer.socket(*args, **kwargs)</span><br><span class="line">        return websockify.websockifyserver.WebSockifyServer.socket(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">find /usr/lib/python2.7/dist-packages/websockify -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line">find /usr/lib/python2.7/dist-packages/nova -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">systemctl restart nova-spiceproxy</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6082 10.5.2.196 |grep -i tlsv</span><br></pre></td></tr></table></figure>
<h2 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">websocketproxy.py#websockify_init (opts.ssl_options = select_ssl_version(opts.ssl_version)) -&gt; websockifyserver.py#start_server()</span><br><span class="line"></span><br><span class="line">when client is connecting:</span><br><span class="line">WebSocketProxy -&gt; ./websocketproxy.py#ProxyRequestHandler -&gt; WebSockifyRequestHandler#handle -&gt; /usr/lib/python3.6/http/server.py(377)handle_one_request() -&gt; _websocket_do_GET -&gt; handle_upgrade (self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;) -&gt;  WebSocketRequestHandlerMixIn.handle_upgrade(self) -&gt; handle_websocket(SSL/TLS)-&gt; new_websocket_client　-&gt; /usr/lib/python3/dist-packages/nova/console/websocketproxy.py(166)new_websocket_client</span><br></pre></td></tr></table></figure>
<p>似乎是在queens中下面的self.headers.get(‘upgrade’)不为wesocket<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">54     def _websocket_do_GET(self):</span><br><span class="line">55         # Checks if it is a websocket request and redirects</span><br><span class="line">56         self.do_GET = self._real_do_GET</span><br><span class="line">57</span><br><span class="line">58         if (self.headers.get(&apos;upgrade&apos;) and</span><br><span class="line">59             self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;):</span><br><span class="line">60             self.handle_upgrade()</span><br><span class="line">61         else:</span><br><span class="line">62             self.do_GET()</span><br></pre></td></tr></table></figure></p>
<p>根据这个网页（<a href="https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）" target="_blank" rel="external">https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）</a></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>主要是由两个问题导致：<br>1, one spice-html5 bug<br><a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a><br>2, ssl默认使用PROTOCOL_SSLv23 （ <a href="https://docs.python.org/2/library/ssl.html#socket-creation" target="_blank" rel="external">https://docs.python.org/2/library/ssl.html#socket-creation</a> ）要使用tlsv1_2，或者在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2，或者使用nova与websockify的patch可以通过ssl_option来配置使用的tls版本。<br>3, 或者/usr/lib/python2.7/dist-packages/eventlet/green/ssl.py中不应该用PROTOCOL_TLSv1作为默认，而应该用PROTOCOL_SSLv23， 这样PROTOCOL_SSLv23会依赖底层ssl版本自动选择tlsv1_0, tlsv1_1, tlsv1_2, 这样即使防火墙disable  tlsv1_0也不影响使用tlsv1_2. 最终的原因是因为python-eventlet 0.18.4-1引入了Rebased set-defaults-to-be-tlsv1-not-sslv23.patch，是它使用了PROTOCOL_TLSv1，应该去掉。</p>
<h2 id="附录-Websocket-based-spice-client"><a href="#附录-Websocket-based-spice-client" class="headerlink" title="附录 - Websocket based spice client"></a>附录 - Websocket based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1, a test vm with spice enabled</span><br><span class="line">    &lt;graphics type=&apos;spice&apos; port=&apos;5900&apos; autoport=&apos;yes&apos; listen=&apos;127.0.0.1&apos;&gt;</span><br><span class="line">      &lt;listen type=&apos;address&apos; address=&apos;127.0.0.1&apos;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line"></span><br><span class="line">2, spice proxy side</span><br><span class="line">sudo apt install python3-websockify -y</span><br><span class="line">websockify 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">3, spice client side</span><br><span class="line">sudo apt install spice-html5 apache2 -y</span><br><span class="line">ls /usr/share/spice-html5/spice_auto.html #it&apos;s similar to https://10.5.1.11:6082/spice_auto.html?token=xxx</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">Alias /spice /usr/share/spice-html5</span><br><span class="line">&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">    Allow from all</span><br><span class="line">    Satisfy Any</span><br><span class="line">    DirectoryIndex spice.html</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo ln -s /etc/apache2/conf-available/ws.conf /etc/apache2/conf-enabled/ws.conf</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">4, access it via http://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br></pre></td></tr></table></figure>
<h2 id="附录-Websocket-ssl-based-spice-client"><a href="#附录-Websocket-ssl-based-spice-client" class="headerlink" title="附录 - Websocket ssl based spice client"></a>附录 - Websocket ssl based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">1, create key pairs</span><br><span class="line"></span><br><span class="line">mkdir ~/ca &amp;&amp; cd ~/ca</span><br><span class="line">openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out ca.crt -keyout ca.key -subj &quot;/C=US/ST=UK/L=London/O=Ubuntu/OU=IT/CN=CA&quot;</span><br><span class="line">for DOMAIN in server client</span><br><span class="line">do</span><br><span class="line">  openssl genrsa -out $DOMAIN.key</span><br><span class="line">  openssl req -new -key $DOMAIN.key -out $DOMAIN.csr -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=$DOMAIN&quot;</span><br><span class="line">  openssl x509 -req -in $DOMAIN.csr -out $DOMAIN.crt -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">2, spice server side</span><br><span class="line"></span><br><span class="line">sudo mkdir /etc/apache2/ssl &amp;&amp; sudo chown -R $USER /etc/apache2/ssl</span><br><span class="line">cp /home/hua/ca/server.crt /etc/apache2/ssl/</span><br><span class="line">cp /home/hua/ca/server.key /etc/apache2/ssl/</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">&lt;VirtualHost 192.168.2.139:443&gt;</span><br><span class="line">        SSLEngine on</span><br><span class="line">        SSLCertificateFile      /etc/apache2/ssl/server.crt</span><br><span class="line">        SSLCertificateKeyFile   /etc/apache2/ssl/server.key</span><br><span class="line">        CustomLog       &quot;/var/log/apache2/ws.log&quot; combined</span><br><span class="line">        ErrorLog        &quot;/var/log/apache2/ws.log&quot;</span><br><span class="line">	Alias /spice /usr/share/spice-html5</span><br><span class="line">	&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">	    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">	    Allow from all</span><br><span class="line">	    Satisfy Any</span><br><span class="line">	    DirectoryIndex spice.html</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo a2enmod ssl</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">3, spice proxy side</span><br><span class="line">websockify --cert=/home/hua/ca/server.crt --key=/home/hua/ca/server.key --cafile=~/home/hua/ca/ca.crt --ssl-only --ssl-version=tlsv1_2 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">4, access it via: https://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br><span class="line">   nmap --script ssl-enum-ciphers -p 6082 192.168.2.139</span><br><span class="line">   openssl s_client -connect 192.168.2.139:6082 -tls1_2</span><br><span class="line"></span><br><span class="line">5, debug, print http headers by adding the following scripts in /usr/share/spice-html5/spice_auto.html</span><br><span class="line"></span><br><span class="line">var req = new XMLHttpRequest();</span><br><span class="line">req.open(&apos;GET&apos;, document.location, false);  #but this is not the headers for websocket upgrade</span><br><span class="line">req.send(null);</span><br><span class="line">var headers = req.getAllResponseHeaders();</span><br><span class="line">alert(headers);</span><br><span class="line"></span><br><span class="line">6, why we see the following error when visitting the url &apos;https://10.5.2.196:6082/spice_auto.html?token=xxxx&apos;</span><br><span class="line"></span><br><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br><span class="line"></span><br><span class="line">That&apos;s because the following content is missing in /usr/share/spice-html5/spice_auto.html, see this patch - https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</span><br><span class="line"></span><br><span class="line">                if (window.location.protocol == &apos;https:&apos;) &#123;</span><br><span class="line">                    scheme = &quot;wss://&quot;;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html" target="_blank" rel="external">https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html</a><br>[2] <a href="https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464" target="_blank" rel="external">https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464</a><br>[3] <a href="https://notes.bitfunnel.net/?q=node/54" target="_blank" rel="external">https://notes.bitfunnel.net/?q=node/54</a><br>[4] <a href="https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373" target="_blank" rel="external">https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/软路由/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/19/软路由/" itemprop="url">软路由</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-19T23:24:29+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-08-19<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>升级了500M宽带，但电脑用网线直线WDNR4300路由器用perf3 -s与perf -c 192.168.99.1 -t 3测试时只不到200M．所以在一台式机上安装了软路由，测试结果立马上到接近1000M了．<br>但用了1000M的电力猫之后，速度又下降到120左右，改成有线连接之后，又马又上到1000M．<br>看来瓶颈在于WDNR4300与电力猫．</p>
<h2 id="安装软路由"><a href="#安装软路由" class="headerlink" title="安装软路由"></a>安装软路由</h2><p>台式机上有两个之前做SR-IOV实验用的千兆网卡 (Winyao WY576T PCI-E X4 双口服务器千兆网卡 82576 1000M), 及一个Intel集成网卡．</p>
<ul>
<li>enp6s0f0与enp6s0f1通过passthough映射到KVM虚机. 注意不要使用macvtap+bridge模式，因为这样会造成无法从局域网ping macvtap设备上的IP，当在插一根网线到Intel集成网卡上后，默认路由总是在enp6s0f0上，从而导致无法访问台式机．enp6s0f0映射到openwrt虚机里是eth1用于生成br-lan, enp6s0f1映射到openwrt虚机里是eth0.</li>
<li>直接KVM安装导入OpenWRT x86镜像即可 (github直接下载)</li>
</ul>
<h2 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h2><p>目前家中的网络拓扑是：</p>
<ul>
<li>光猫，打电话改了桥接</li>
<li>tplink千兆路由器(192.168.2.0/24)拨号, 下接一千兆交换机接NAS, TV, Camera等．</li>
<li>台式机的enp6s0f0接tplink，从软路由(192.168.98.0/24)出来后，enp6s0f1再接一千兆交换机．</li>
<li>WNDR4300仍然从tplink出(192.168.99.0/24)</li>
<li>千兆电力猫连接软路由至卧室（电力猫速度太差，需要改成有线）<h2 id="目前问题"><a href="#目前问题" class="headerlink" title="目前问题"></a>目前问题</h2></li>
<li>台式机停电再来电自动启动的问题，改了BIOS但还未测试</li>
<li>tplink上IPv6也要拨号但复用IPv4的拨号连接后是有IPv6地址的（光猫桥接并未挡住什么），客户端直接连接tplink也能拿到IPv6, 但tplink下挂的OpenWRT路由器却拿不到IPv6, 可能是OpenWrt镜像缺包吧，因为在WAN6那里找不到dhcpv6 client，只有dhcp client) ，原因见：　<a href="https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html" target="_blank" rel="external">https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html</a> (<strong>20200824更新,就是这个原因</strong>). 那现在另外一个路由器以dhcp接在这个拨号路由器后lan口又如何获取IPv6地址呢?</li>
<li>ubuntu在/etc/network/interfaces不定义时可以拿到IPv6，但要使用桥接如何定义也能拿到IPv6呢？</li>
<li>如何将无线网卡给KVM用，同时在openwrt虚机中用它做AP?</li>
</ul>
<h2 id="一级路由访问二级路由"><a href="#一级路由访问二级路由" class="headerlink" title="一级路由访问二级路由"></a>一级路由访问二级路由</h2><p>当在一级redmi ax5路由(192.168.2.1)下又接了一个二级openwrt路由(192.168.2.47, 192.168.99.1).<br>那一级路由下的node1(192.168.2.111)如何访问二级路由下的t440p (192.168.99.136)呢?<br>1, 先照着这处贴子将redmi ax5的ssh打开, 必须重启,之后就可以通过root/admin 来ssh了(不影响web管理密码), 然后使用’passwd root’来修改密码.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/web/home#router</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h;nvram set ssh%5Fen%3D1; nvram commit;</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20nvram%20set%20ssh_en%3D1%3B%20nvram%20commit%3B%20sed%20-i%20&apos;s%2Fchannel%3D.*%2Fchannel%3D%5C%22debug%5C%22%2Fg&apos;%20%2Fetc%2Finit.d%2Fdropbear%3B%20%2Fetc%2Finit.d%2Fdropbear%20start%3B</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20echo%20-e%20&apos;admin%5Cnadmin&apos;%20%7C%20passwd%20root%3B</span><br></pre></td></tr></table></figure></p>
<p>2, 在二级路由器上如下图关闭防火墙,<br><img src="https://img-blog.csdnimg.cn/2020082422402826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>3, 在一级路由下添加静态路由<br>route add -net 192.168.99.0 netmask 255.255.255.0 gw 192.168.2.47</p>
<p>4, 在二级路由上将192.168.2.47作静态IP绑定(MAC/IP绑定即可)</p>
<p>5, 如果不行,似乎在一级路由器上上图中lan处防火墙设置中的forwarding不能是REJECT哦.</p>
<h2 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h2><p>miwifi上集成的DDNS服务基本上都是收费的, 花生壳的二级域名壳域名不收费, 但这家公司喜欢删域名, 要求你实名制, 但实名制前又问你最喜欢的动物是什么, 答错了还弄不成实名制, 打电话给客服了, 让你把身份证扫描件发到800@oray.com人工审核, 但也没下文了, 等得头疼. 另外, 就是太喜欢删域名了, 申请的壳域名忽然就删了, 被删了也不知道的怎么被删的, 死得不明不白. 得了, 还是整个免费的吧. 申请一个dnsexit的二级域名, 然后用下列脚本更新.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; /data/ddns&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/sh</span><br><span class="line">myip=$(curl -s http://myip.dnsomatic.com/)</span><br><span class="line">if [ -e &quot;ip.txt&quot; ]</span><br><span class="line">then</span><br><span class="line">  old_ip=$(cat ip.txt)</span><br><span class="line">  if [ &quot;$myip&quot; == &quot;$old_ip&quot; ]</span><br><span class="line">  then</span><br><span class="line">    echo &quot;Your IP $myip didn&apos;t change.&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;The IP Changed from $old_ip to $myip&quot;</span><br><span class="line">    change_dot_com=$(curl -s &quot;http://update.dnsexit.com/RemoteUpdate.sv?login=&lt;user&gt;&amp;password=&lt;password&gt;&amp;host=&lt;domain&gt;&amp;myip=$&#123;myip&#125;&quot;)</span><br><span class="line">    echo &quot;$change_dot_com&quot;</span><br><span class="line">    sleep 2</span><br><span class="line">  fi</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;Your IP is $myip&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">chmod +x /data/ddns</span><br><span class="line">crontab -e</span><br><span class="line">*/60 * * * * /data/ddns &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">nslookup -vc quqi99.publicvm.com 8.8.8.8</span><br></pre></td></tr></table></figure>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>1, 默认REJET</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">config defaults</span><br><span class="line">        option syn_flood &apos;0&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option drop_invalid &apos;1&apos;</span><br><span class="line">        option disable_ipv6 &apos;0&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;lan&apos;</span><br><span class="line">        option network &apos;lan&apos;</span><br><span class="line">        option input &apos;ACCEPT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;ACCEPT&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;wan&apos;</span><br><span class="line">        list network &apos;wan&apos;</span><br><span class="line">        list network &apos;wan6&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option masq &apos;1&apos;</span><br><span class="line">        option mtu_fix &apos;1&apos;</span><br></pre></td></tr></table></figure>
<p>2, 打开22端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config rule &apos;ssh&apos;</span><br><span class="line">        option name &apos;ssh&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option target &apos;ACCEPT&apos;</span><br><span class="line">        option family &apos;ipv4&apos;</span><br></pre></td></tr></table></figure></p>
<p>3, 转发2222端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">config redirect &apos;wan2222rdr1&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option src_dport &apos;2222&apos;</span><br><span class="line">        option dest_ip &apos;192.168.2.47&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option name &apos;x86_openwrt&apos;</span><br><span class="line">        option target &apos;DNAT&apos;</span><br><span class="line">        option ftype &apos;1&apos;</span><br><span class="line">        option dest &apos;lan&apos;</span><br><span class="line">root@XiaoQiang:~# iptables-save |grep 47</span><br><span class="line">-A zone_lan_postrouting -s 192.168.2.0/24 -d 192.168.2.47/32 -p tcp -m tcp --dport 22 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j SNAT --to-source 192.168.2.1</span><br><span class="line">-A zone_lan_prerouting -s 192.168.2.0/24 -d 123.115.196.xxx/32 -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j DNAT --to-destination 192.168.2.47:22</span><br><span class="line">-A zone_wan_prerouting -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt&quot; -j DNAT --to-destination 192.168.2.47:22</span><br></pre></td></tr></table></figure>
<p>转发端口时不需要为2222单独定义input规则, 另外, 联通除了封80, 443, 以外其实没有封其它端口, 可用<a href="https://tool.chinaz.com/port/" target="_blank" rel="external">https://tool.chinaz.com/port/</a> 检测 (检测时得做redirect规则, 且开服务)</p>
<h2 id="https网站不好使"><a href="#https网站不好使" class="headerlink" title="https网站不好使"></a>https网站不好使</h2><p>像csdn与baidu等网站出现HSTS相关的证书错误, 是因为广告过滤大师使用了KoolProxy签发的证书所致, 所以需要关闭广告过滤大师.</p>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&quot;data-root&quot;: &quot;/mnt/udisk/docker&quot;,</span><br><span class="line">/etc/init.d/dockerd restart</span><br><span class="line"></span><br><span class="line">#install a better docker frontend - https://koolshare.cn/thread-180474-1-1.html</span><br><span class="line">docker pull portainer/portainer</span><br><span class="line">#create a continer with portainer image, expose port 9000:9000/tcp and bind mount &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">http://192.168.99.1:9000/#/init/admin</span><br><span class="line">http://192.168.99.1:9000/#/dashboard</span><br><span class="line"></span><br><span class="line">#intall docker search ubuntu</span><br><span class="line">docker pull ubuntu</span><br><span class="line">docker run -it ubuntu</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<h2 id="天翼云盘"><a href="#天翼云盘" class="headerlink" title="天翼云盘"></a>天翼云盘</h2><p>天翼云盘是一个独立的家庭云空间，不等同于天翼云，无法获取S3登陆参数，也关闭了API - <a href="https://zhuanlan.zhihu.com/p/38592985" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/38592985</a><br>所以它无法使用s3fs加载块设备，但使用s3fs的方法类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential libfuse-dev libcurl4-openssl-dev libxml2-dev mime-support automake libtool s3fs</span><br><span class="line">echo xxx:xxx |sudo tee /etc/passwd-s3fs &amp;&amp; sudo chmod 600 /etc/passwd-s3fs &amp;&amp; sudo chown $USER /etc/passwd-s3fs</span><br><span class="line">sudo mkdir /mnt/tianyi &amp;&amp; sudo chown $USER /mnt/tianyi</span><br><span class="line">s3fs -o passwd_file=/etc/passwd-s3fs -o url=http://oos.ctyunapi.cn bucket-dingjia /mnt/tianyi</span><br><span class="line">df -h</span><br><span class="line">fusermount -u /mnt/tianyi</span><br></pre></td></tr></table></figure>
<p>它可以使用sharelist，但用途不大．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sudo apt install nodejs npm -y  &amp;&amp; sudo npm install -g npm</span><br><span class="line">git clone https://github.com/reruin/sharelist.git</span><br><span class="line">cd sharelist &amp;&amp; sudo chmod +x ./install.sh &amp;&amp; sudo ./install.sh  #http://127.0.0.1:33001/</span><br><span class="line">#cd ./sharelist/ &amp;&amp; node app.js                                  #http://127.0.0.1:33001/</span><br></pre></td></tr></table></figure></p>
<h2 id="BaiduPCS-Web"><a href="#BaiduPCS-Web" class="headerlink" title="BaiduPCS-Web"></a>BaiduPCS-Web</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># server side</span><br><span class="line"># nfs GUI(http://192.168.99.1/cgi-bin/luci/admin/nas/nfs)是坏的(luci-app-nfs - https://github.com/coolsnowwolf/lede/issues/2957)，只能使用CLI</span><br><span class="line">echo &apos;/mnt/sdb1/nfs *(rw,sync,no_root_squash,subtree_check)&apos; &gt;&gt; /etc/exports</span><br><span class="line">/etc/init.d/nfsd restart</span><br><span class="line"></span><br><span class="line"># client side</span><br><span class="line">showmount -e 192.168.99.1</span><br><span class="line">sudo mount -t nfs 192.168.99.1:/mnt/sdb1/nfs /openwrt</span><br><span class="line">sudo fuser -m -v /openwrt/</span><br><span class="line">$ cat /etc/auto.direct |tail -n1</span><br><span class="line">/openwrt    -fstype=nfs4,rsize=32768,wsize=32768     192.168.99.1:/mnt/sdb1/nfs</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://hansendong.me/609/" target="_blank" rel="external">https://hansendong.me/609/</a><br>[2] <a href="https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453" target="_blank" rel="external">https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/09/Play-with-MAAS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/09/Play-with-MAAS/" itemprop="url">Play with MAAS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T10:25:42+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>问题</strong><br>四年前写了一篇关于MAAS的博客 [1]，但好几年没用它了，今天发现GUI的操作流程变化还有点，记录一下。<br><strong>Host机</strong><br>配置了下面的网络：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">auto br-eth0</span><br><span class="line">iface br-eth0 inet static</span><br><span class="line">    address 192.168.99.124/24</span><br><span class="line">    gateway 192.168.99.1</span><br><span class="line">    bridge_ports eth0</span><br><span class="line">    dns-nameservers 192.168.99.1</span><br></pre></td></tr></table></figure></p>
<p>然后在virt-manger里创建了一个名为cloud的虚拟网络(192.168.100.0/24)，未使用DHCP。<br>最后，使用virt-manager创建了一个名为maas的虚机,给它分配了两个网卡(ens3=192.168.100.3用作MAAS的IP,另一个网卡ens8=192.168.99.1纯粹为了方便管理之用)<br><strong>maas虚机</strong><br>网络配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolvconf/resolv.conf.d/base</span><br><span class="line">search maas</span><br><span class="line">nameserver 192.168.100.3</span><br><span class="line"></span><br><span class="line">or modify /etc/systemd/resolved.conf to set DNS=192.168.100.3, then run:</span><br><span class="line">sudo systemctl restart systemd-resolved.service</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ifupdown has been replaced by netplan(5) on this system.  See</span><br><span class="line"># /etc/netplan for current configuration.</span><br><span class="line"># To re-enable ifupdown on this system, you can run:</span><br><span class="line">sudo apt install ifupdown</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">auto ens3</span><br><span class="line">iface ens3 inet static</span><br><span class="line">address 192.168.100.3</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.100.1</span><br><span class="line"></span><br><span class="line">auto ens8</span><br><span class="line">iface ens8 inet static</span><br><span class="line">address 192.168.99.3</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.99.1</span><br></pre></td></tr></table></figure>
<p>安装maas:<br>NOTE: 千万要注意，<strong>最好使用debian包安装</strong>，使用snap包安装里会造成snap container里没有设置REQUESTS_CA_BUNDLE环境变量由于python-requests的一个bug导致maas无法使用https服务，例如运行＂maas configauth –rbac-url <a href="https://node1.lan:5000/" target="_blank" rel="external">https://node1.lan:5000/</a> –rbac-service-name maastest＂就会抛错CERTIFICATE_VERIFY_FAILED, 具体见：　<a href="https://zhhuabj.blog.csdn.net/article/details/107182847" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/107182847</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install maas --channel=2.8</span><br><span class="line">#sudo snap install maas-test-db                              #enter shell - maas-test-db.psql</span><br><span class="line">sudo add-apt-repository ppa:maas/2.8   #https://launchpad.net/~maas</span><br><span class="line">sudo apt install maas</span><br></pre></td></tr></table></figure></p>
<p>配置maas虚机可以无密码访问物理机上的libvirt:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo chsh maas -s /bin/bash</span><br><span class="line">sudo su - maas</span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa hua@192.168.100.1</span><br><span class="line">sudo -u maas virsh -c qemu+ssh://hua@192.168.100.1/system list --all</span><br></pre></td></tr></table></figure></p>
<p>创建maas管理员用户之后就可以通过<a href="http://192.168.99.3:5240/MAAS登录GUI管理界面了" target="_blank" rel="external">http://192.168.99.3:5240/MAAS登录GUI管理界面了</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo maas createadmin</span><br><span class="line">apikey=$(sudo maas apikey --username admin)</span><br><span class="line">maas login admin http://192.168.100.3:5240/MAAS $apikey</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line">maas admin boot-resources import</span><br></pre></td></tr></table></figure></p>
<h2 id="enable-PXE"><a href="#enable-PXE" class="headerlink" title="enable PXE"></a>enable PXE</h2><p>在’Subnets’点击subnet 192.168.100.0/24对应的vlan(untagged)后’enable dhcp’才能enable PXE.<br><img src="https://img-blog.csdnimg.cn/20200925183035294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>注册maas节点</strong><br>创建一块空磁盘(truncate –size 10G /images/kvm/controller.raw)，然后在virt-manager里创建一个名为controller的新虚机(设置从PXE启动、使用truncate定义的空磁盘，同时<strong>从cloud network中定义四块网卡)</strong>, 我们能从virt-manager中看到pxe的启动过程，但最后却一闪而过了那是因为需要从maas里来启动它。好，从virt-manager中关闭该虚机，同时<strong>记得再将启动模式改回PXE</strong>。<br>NOTE: 如果此时还不行, 多半是上面一步没有enable pxe吧. 另外, 在commission时无法选择image, 只能使用默认的ubuntu image, 在deploy时可以设置使用其他如centos镜像.<br><img src="https://img-blog.csdn.net/20180724115011109?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>然后访问GUI的”Nodes -&gt; Add hardware -&gt; Machine”定义节点(注意：<strong>四块网卡的MAC地址一次性定义，如果后续此处添加网卡的话还得再执行commission操作</strong>）:<br><img src="https://img-blog.csdn.net/20180724131740628?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>commission过程可从下列几个方式调试：</p>
<ul>
<li>virt-manager vnc可以看到</li>
<li>maas节点上的/var/log/maas/maas.log</li>
<li>controller虚机(IP可从GUI里找到)里的cloud-init日志</li>
</ul>
<p>然后根据在virt-manager中定义的四块网卡的MAC地址在maas中也如下图定义一下：<br><img src="https://img-blog.csdn.net/20180724121359167?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>四块网卡定义好了之后得重新点击一下”Take action -&gt; Commision”，然后将看到如下界面：<br><img src="https://img-blog.csdn.net/20180724122506159?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>然后我们将看到”Add Interface”、”Create bond”、”Create Bridge”等按钮，先将ens8和ens9做成bond0，再在bond0上创建一些vlan（先建vlan再建bridge顺序不能变)，最后将bond0做成br-bond0，最后如下图：<br><img src="https://img-blog.csdn.net/20180724141419499?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>接着还要再点击”Take action -&gt; Deploy” (<strong>注意: 此处不是点commissioning</strong>) 重新部署，最后就可以从GUI界面中找到IP后通过ssh ubuntu@IP访问了</p>
<h2 id="附录-CLI"><a href="#附录-CLI" class="headerlink" title="附录 - CLI"></a>附录 - CLI</h2><p><img src="https://img-blog.csdnimg.cn/20200923084601361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">https://docs.maas.io/2.5/en/manage-cli-advanced</span><br><span class="line">https://maas.io/docs/concepts-and-terms</span><br><span class="line">region相当于一个datacenter或者一个single region, fabrics再去划分region, 每个rack controller都被attached到每一个fabric.</span><br><span class="line">rack下关联node, interfaces, fabric; interface关联subnets, subnets有vlan</span><br><span class="line">fabric下再关联vlan; vlan关联space</span><br><span class="line">interfaces下link到subnet, subnet有vlan</span><br><span class="line"></span><br><span class="line">maas login admin http://localhost/MAAS/api/2.0 $(sudo maas-region apikey --username admin)</span><br><span class="line"></span><br><span class="line">#machine_id=$(maas admin machines read | jq -r &apos;.[] | select(.hostname==&quot;controller&quot;).system_id&apos;)</span><br><span class="line">#maas admin interfaces read $machine_id &gt; interface.txt</span><br><span class="line"></span><br><span class="line">maas admin rack-controllers read</span><br><span class="line">system_id=$(maas admin rack-controllers read | jq -r .[].system_id)</span><br><span class="line"></span><br><span class="line">maas admin machines read</span><br><span class="line">machine_id=$(maas admin machines read | jq -r &apos;.[] | select(.hostname==&quot;controller&quot;).system_id&apos;)</span><br><span class="line">maas admin machines read |jq &quot;.[] | &#123;hostname:.hostname, system_id: .system_id, status:.status&#125;&quot; --compact-output</span><br><span class="line"></span><br><span class="line">maas admin interfaces read &quot;$system_id&quot;</span><br><span class="line">maas admin interfaces read $system_id | jq &quot;.[] |&#123;id:.id, name:.name, mac:.mac_address, vid:.vlan.vid, fabric:.vlan.fabric&#125;&quot; --compact-output</span><br><span class="line">maas admin interface update &quot;$system_id&quot; $interface vlan=5001</span><br><span class="line">#maas admin interface unlink-subnet &quot;$system_id&quot; &quot;$iface_id&quot; id=&quot;$link_id&quot;</span><br><span class="line">#maas admin interface delete &quot;$system_id&quot; &quot;$vlan_iface_id&quot;</span><br><span class="line">#maas admin interface link-subnet &quot;$system_id&quot; &quot;$iface_id&quot; mode=AUTO subnet=&quot;$iface_subnet_cidr&quot;</span><br><span class="line">interfaces=$(maas admin interfaces read &quot;$system_id&quot;)</span><br><span class="line">iface_name=&quot;ens3&quot;</span><br><span class="line">iface_id=$(echo &quot;$interfaces&quot; | jq -r &quot;.[] | select(.name==\&quot;$iface_name\&quot;) | .id&quot;)</span><br><span class="line">link_ids=$(maas admin interface read &quot;$system_id&quot; &quot;$iface_id&quot; | jq -r &apos;.links | .[].id&apos;)</span><br><span class="line">for link_id in $link_ids; do</span><br><span class="line">   maas admin interface unlink-subnet &quot;$system_id&quot; &quot;$iface_id&quot; id=&quot;$link_id&quot;</span><br><span class="line">done</span><br><span class="line">vlan_iface_ids=$(maas admin interfaces read &quot;$system_id&quot; | jq -r &apos;.[] | select(.type==&quot;vlan&quot;).id&apos;)</span><br><span class="line">for vlan_iface_id in $vlan_iface_ids; do</span><br><span class="line">   maas admin interface delete &quot;$system_id&quot; &quot;$vlan_iface_id&quot;</span><br><span class="line">done</span><br><span class="line">iface_subnet_cidr=$(maas admin subnets read | jq -r &quot;.[] | select(.name==\&quot;$iface_subnet_name\&quot;).cidr&quot;)</span><br><span class="line">maas admin interface link-subnet &quot;$system_id&quot; &quot;$iface_id&quot; mode=AUTO subnet=&quot;$iface_subnet_cidr&quot;</span><br><span class="line"></span><br><span class="line">maas admin fabrics read</span><br><span class="line">maas admin fabrics read | jq &quot;.[] |&#123;name:.name, vlans:.vlans[] | &#123;id:.id, vid:.vid&#125;&#125;&quot; --compact-output</span><br><span class="line">maas admin fabric update 0 name=maas-management</span><br><span class="line">fabric_name=&quot;maas-management&quot;</span><br><span class="line">mag_fabric_id=$(maas admin fabrics read| jq -r &quot;.[] | select(.name==\&quot;$fabric_name\&quot;).id&quot;)</span><br><span class="line"></span><br><span class="line">vid=$(maas admin subnets read | jq -M &apos;.[] | select(.cidr==&quot;10.12.1.0/24&quot;).vlan.vid&apos;)</span><br><span class="line">fabric=$(maas admin subnets read| jq -r &apos;.[] | select(.cidr==&quot;10.12.1.0/24&quot;).vlan.fabric&apos;)</span><br><span class="line">fabric_id=$(maas admin fabrics read | jq -M &apos;.[] | select(.name==&quot;`echo $fabric`&quot;).id&apos;)  #$fabric=fabric-1</span><br><span class="line">maas admin vlan read $fabric_id $vid</span><br><span class="line"></span><br><span class="line">maas admin spaces create name=os-floating</span><br><span class="line">os_floating_spaceid=$(maas admin spaces read | jq &apos;.[] | select(.name == &quot;&apos;os-floating&apos;&quot;)&apos;.id)</span><br><span class="line">maas admin vlan update $mag_fabric_id 5 space=$os_floating_spaceid mtu=1500</span><br><span class="line"></span><br><span class="line">maas admin subnets read</span><br><span class="line">maas admin subnet update $(maas admin subnets read| jq -r &quot;.[] | select(.cidr==\&quot;10.231.16.0/24\&quot;).id&quot;) cidr=10.231.16.0/21</span><br><span class="line">pxe_subnet_id=$(maas admin subnets read| jq -r &quot;.[] | select(.cidr==\&quot;10.231.16.0/21\&quot;).id&quot;)</span><br><span class="line">maas admin subnet update $pxe_subnet_id name=maas-management</span><br></pre></td></tr></table></figure>
<h2 id="附录-MAAS-Region-HA"><a href="#附录-MAAS-Region-HA" class="headerlink" title="附录 - MAAS Region HA"></a>附录 - MAAS Region HA</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"># https://sites.google.com/site/openstackinthebasement3/maasha</span><br><span class="line"># https://cloud.google.com/community/tutorials/setting-up-postgres-hot-standby</span><br><span class="line">sudo apt remove --purge postgresql maas*</span><br><span class="line">sudo apt autoremove</span><br><span class="line">sudo apt install maas-region-controller</span><br><span class="line">#sudo dpkg-reconfigure maas-region-controller</span><br><span class="line">#sudo dpkg-reconfigure maas-rack-controller</span><br><span class="line"></span><br><span class="line"># on maas to create user</span><br><span class="line">sudo maas createadmin --username admin --password ubuntu --email root@example.com</span><br><span class="line"></span><br><span class="line"># on maas and maas2</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/postgresql/9.5/main/pg_hba.conf&apos; &lt;&lt; EOF</span><br><span class="line">host     replication     repuser         192.168.100.3/32        md5</span><br><span class="line">host     replication     repuser         192.168.100.4/32        md5</span><br><span class="line">host     all             all             192.168.100.3/32        md5</span><br><span class="line">host     all             all             192.168.100.4/32        md5</span><br><span class="line">host     replication     repuser         192.168.99.3/32        md5</span><br><span class="line">host     replication     repuser         192.168.99.4/32        md5</span><br><span class="line">host     all             all             192.168.99.3/32        md5</span><br><span class="line">host     all             all             192.168.99.4/32        md5</span><br><span class="line">host     all             all             192.168.0.0/16        md5</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># on both maas and maas2</span><br><span class="line">sudo -u postgres createuser -U postgres repuser -P -c 5 --replication</span><br><span class="line">#sudo mkdir -p /var/lib/postgresql/9.5/main/mnt/server/archivedir</span><br><span class="line">#sudo chown postgres:postgres /var/lib/postgresql/9.5/main/mnt/server/archivedir</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/postgresql/9.5/main/postgresql.conf&apos; &lt;&lt; EOF</span><br><span class="line">listen_addresses = &apos;*&apos;</span><br><span class="line">max_connections = 300</span><br><span class="line">wal_level = hot_standby</span><br><span class="line">synchronous_commit = on</span><br><span class="line">archive_mode = off</span><br><span class="line">#archive_mode = on</span><br><span class="line">#archive_command = &apos;test ! -f /var/lib/postgresql/9.5/main/mnt/server/archivedir/%f &amp;&amp; cp %p /var/lib/postgresql/9.5/main/mnt/server/archivedir/%f&apos;</span><br><span class="line">max_wal_senders = 10</span><br><span class="line">wal_keep_segments = 256</span><br><span class="line">hot_standby = on</span><br><span class="line">restart_after_crash = off</span><br><span class="line">hot_standby_feedback = on</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># on maas, restart postgresql</span><br><span class="line">sudo systemctl restart postgresql.service</span><br><span class="line"></span><br><span class="line"># on maas2 run the db backup</span><br><span class="line">sudo systemctl stop postgresql</span><br><span class="line">sudo mv /var/lib/postgresql/9.5/main /var/lib/postgresql/9.5/main.old</span><br><span class="line">sudo -u postgres pg_basebackup -h 192.168.100.3 -D /var/lib/postgresql/9.5/main -U repuser -v -P --xlog-method=stream</span><br><span class="line"></span><br><span class="line">sudo cp /usr/share/postgresql/9.5/recovery.conf.sample /var/lib/postgresql/9.5/main/recovery.conf</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /var/lib/postgresql/9.5/main/recovery.conf&apos; &lt;&lt; EOF</span><br><span class="line">standby_mode = on</span><br><span class="line">primary_conninfo = &apos;host=192.168.100.3 port=5432 user=repuser password=password&apos;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># on maas2 configure the region to point at the main database</span><br><span class="line">sudo systemctl stop maas-regiond</span><br><span class="line">sudo rm /var/lib/maas/&#123;maas_id,secret&#125;</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/maas/regiond.conf&apos; &lt;&lt; EOF</span><br><span class="line">database_host: 192.168.100.3</span><br><span class="line">database_name: maasdb</span><br><span class="line">database_pass: FiPQSKlBpAvs</span><br><span class="line">database_port: 5432</span><br><span class="line">database_user: maas</span><br><span class="line">maas_url: http://192.168.99.4:5240/MAAS</span><br><span class="line">EOF</span><br><span class="line">sudo chown root:maas /etc/maas/regiond.conf</span><br><span class="line">sudo chmod 640 /etc/maas/regiond.conf</span><br><span class="line">sudo systemctl restart maas-regiond</span><br><span class="line"></span><br><span class="line"># on maas2 start postgres, now you should see the second region controller in the maas gui</span><br><span class="line">sudo systemctl restart postgresql</span><br><span class="line">sudo tail -f /var/log/postgresql/postgresql-9.5-main.log</span><br><span class="line">#2019-06-11 12:38:26 JST [29904-4] LOG:  consistent recovery state reached at 0/230000F8</span><br><span class="line">#2019-06-11 12:38:26 JST [29903-1] LOG:  database system is ready to accept read only connections</span><br><span class="line">#2019-06-11 12:38:26 JST [29908-1] LOG:  started streaming WAL from primary at 0/24000000 on timeline 1</span><br><span class="line">sudo -u postgres psql maasdb -c &apos;SELECT hostname,status,power_state FROM maasserver_node&apos;</span><br><span class="line"></span><br><span class="line"># we don&apos;t enable maas-dns in this test, on both maas and maas2 servers, clean up the bind9 conflicts:</span><br><span class="line">sudo maas-region edit_named_options --migrate-conflicting-options</span><br><span class="line">sudo systemctl restart bind9</span><br><span class="line"># and also modifty /etc/resolv.conf to use maas dns</span><br><span class="line"></span><br><span class="line"># setup HAproxy for load balancing on both maas and maas2 servers</span><br><span class="line"># then refresh the gui you will see the region jump from one server to the other back and forth.</span><br><span class="line">sudo systemctl stop apache2</span><br><span class="line">sudo systemctl disable apache2</span><br><span class="line">sudo apt install haproxy -y</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/haproxy/haproxy.cfg&apos; &lt;&lt; EOF</span><br><span class="line">frontend maas</span><br><span class="line">    bind    *:80</span><br><span class="line">    retries 3</span><br><span class="line">    option  redispatch</span><br><span class="line">    option  http-server-close</span><br><span class="line">    default_backend maas</span><br><span class="line">backend maas</span><br><span class="line">    timeout server 30s</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server localhost localhost:5240 check</span><br><span class="line">    server maas 192.168.99.3:5240 check</span><br><span class="line">    server maas2 192.168.99.4:5240 check</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart haproxy</span><br><span class="line"></span><br><span class="line"># setup keepalived (vip) on both maas and maas2, NOTE: fce use packemaker+corosync instead</span><br><span class="line">sudo apt install keepalived -y</span><br><span class="line">sudo modprobe ip_vs</span><br><span class="line">sudo sh -c &apos;echo modprobe ip_vs &gt;&gt; /etc/modules&apos;</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/sysctl.d/60-keepalived-nonlocal.conf&apos; &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart procps</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/keepalived/keepalived.conf&apos; &lt;&lt; EOF</span><br><span class="line"># https://docs.maas.io/2.3/en/manage-ha</span><br><span class="line"># Un-comment next 4 lines if using haproxy</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line"># Un-comment next 4 lines if using apache2</span><br><span class="line">vrrp_script chk_apache2 &#123;</span><br><span class="line">    script &quot;killall -0 apache2&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_named &#123;</span><br><span class="line">    script &quot;killall -0 named&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance maas_region &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens8</span><br><span class="line">    priority 150</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass password</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        ### Un-comment next line if using haproxy</span><br><span class="line">        chk_haproxy</span><br><span class="line">        ### Un-comment next line if using apache2</span><br><span class="line">        #chk_apache2</span><br><span class="line">        chk_named</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.5</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"># adjust an API server to use VIP=192.168.99.5  (http://192.168.99.5/MAAS)</span><br><span class="line">sudo maas-region local_config_set --maas-url http://192.168.99.5/MAAS</span><br><span class="line">sudo systemctl restart maas-regiond</span><br><span class="line"></span><br><span class="line"># install rack on maas and maas2, and adjust api server to use VIP=192.168.99.5</span><br><span class="line">sudo apt install -y maas-rack-controller</span><br><span class="line">sudo maas-rack register --url http://192.168.99.5/MAAS --secret $(sudo cat /var/lib/maas/secret)</span><br><span class="line">#sudo maas-rack config --region-url http://192.168.99.5/MAAS</span><br><span class="line">#sudo systemctl restart maas-rackd.service</span><br><span class="line">maas login admin http://192.168.99.5/MAAS/api/2.0 $(sudo maas-region apikey --username admin)</span><br><span class="line">maas admin rack-controllers read | grep hostname | cut -d &apos;&quot;&apos; -f 4</span><br><span class="line"></span><br><span class="line"># actuall we didn&apos;t enable maas-dns service in this test</span><br><span class="line">sudo systemctl list-unit-files --type=service | grep maas-dhcp</span><br><span class="line">ubuntu@maas:~$ cat /etc/resolv.conf</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 192.168.100.3</span><br><span class="line">#search maas</span><br><span class="line">ubuntu@maas2:~$ cat /etc/resolv.conf</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 192.168.100.4</span><br><span class="line">#search maas</span><br><span class="line"></span><br><span class="line"># the following error is because I accidentally created recovery.conf on the master server instead of the standby.</span><br><span class="line">2019-06-11 15:25:05 JST [15474-1] maas@maasdb ERROR:  cannot execute INSERT in a read-only transaction</span><br><span class="line">2019-06-11 15:31:44 JST [18618-1] maas@maasdb ERROR:  cannot execute LISTEN during recovery</span><br><span class="line"></span><br><span class="line"># present problem</span><br><span class="line">1, can&apos;t add the second rack-controller</span><br><span class="line">2, there is maas-dns and maas-dns ha</span><br><span class="line">3, lots of errors - django.db.utils.InternalError: cannot execute UPDATE in a read-only transaction</span><br><span class="line"></span><br><span class="line">sudo maas-region dbshell --installed</span><br><span class="line">maasdb=# \x</span><br><span class="line">maasdb=# select system_id, hostname from maasserver_node;</span><br><span class="line">maasdb=# \?</span><br><span class="line">maasdb=# \l</span><br><span class="line">maasdb=# \c maasdb</span><br><span class="line">maasdb=# \dtq</span><br></pre></td></tr></table></figure>
<h2 id="附录-Postgres-HA-replication-mode"><a href="#附录-Postgres-HA-replication-mode" class="headerlink" title="附录 - Postgres HA replication mode"></a>附录 - Postgres HA replication mode</h2><p>postgres HA的replication方式有3种:</p>
<ol>
<li><p>基于日志的复制, master完完WAL日志后再发给slave,<br>这样如果还没写完日志master就宕机的话未发的日志内的事务将全部丢失<br>2, 异步流模式,master库以stream的模式向slave发日志, 不需要等待整个日志填充完毕再发大大降低了丢失数据的风险.但在master提交事务之后standby等待流数据时发生宕机也会导致最后一个事务丢失. 同时备库可以配置成host standby模式向外提供查询服务供分担负载.<br>3, 流同步复制模式(synchronous replication),流复制的同步版本, 向master发生commit命令之后, 该命令会被阻塞,直到WAL日志流在所有被配置为同步节点(synchronous_standby_names)的数据库上提交后才会真正提交.因为只有master库和standby库同时宕机才会丢数据. 多层事务嵌套时，子事务不受此保护，只有最上层事务受此保护。纯读操作和回滚不受此影响。同时备库可以配置成HOT Standby，可以向外提供查询服务，供分担负载。采用这种模式的性能损耗依据网络情况和系统繁忙程度而定，网络越差越繁忙的系统性能损耗越严重。</p>
<h2 id="Debug-MaaS"><a href="#Debug-MaaS" class="headerlink" title="Debug MaaS"></a>Debug MaaS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#read maas db</span><br><span class="line">grep -r &apos;database&apos; /etc/maas/regiond.conf</span><br><span class="line">#sudo maas-region dbshell --installed</span><br><span class="line">sudo -iu postgres psql -d template1 -U postgres</span><br><span class="line"></span><br><span class="line"># debug maas - https://github.com/maas/maas/blob/master/HACKING.rst</span><br><span class="line">systemctl stop maas-regiond</span><br><span class="line"># disable any log as much as possible</span><br><span class="line">/usr/bin/python3 /usr/sbin/regiond --debug --workers 1</span><br><span class="line"></span><br><span class="line">systemctl stop maas-rackd</span><br><span class="line">setcap cap_net_bind_service=+eip /usr/sbin/rackd</span><br><span class="line">/bin/rm -f /var/lib/maas/dhcpd.sock &amp;&amp; /bin/rm -f /var/lib/maas/dhcpd.conf &amp;&amp; /bin/rm -f /var/lib/maas/dhcpd6.conf &amp;&amp; sleep 1 &amp;&amp; LOGFILE=/var/log/maas/rackd.log prometheus_multiproc_dir=/var/lib/maas/prometheus /usr/bin/python3 /usr/sbin/rackd --nodaemon</span><br><span class="line"></span><br><span class="line">enable debug log - https://discourse.maas.io/t/running-installed-maas-in-debug-logging-mode/168</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="20200907更新-maas-network-discovery"><a href="#20200907更新-maas-network-discovery" class="headerlink" title="20200907更新 - maas network_discovery"></a>20200907更新 - maas network_discovery</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:maas/2.7  #2.7 only worked on bionic</span><br><span class="line">sudo apt install -y maas</span><br><span class="line">sudo maas init --admin-username admin --admin-password password --admin-email admin@example.com --admin-ssh-import zhhuabj</span><br><span class="line">sudo maas-region apikey --username=admin &gt; ~/admin-api-key</span><br><span class="line">curl http://192.168.2.111:5240/MAAS</span><br><span class="line">apikey=$(cat ~/admin-api-key)</span><br><span class="line">maas login admin http://192.168.2.111:5240/MAAS $apikey</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line">maas admin boot-resources import</span><br><span class="line"></span><br><span class="line">$ maas admin discoveries read |jq &quot;.[] | &#123;ip:.ip, mac_address:.mac_address&#125;&quot; --compact-output</span><br><span class="line">&#123;&quot;ip&quot;:&quot;192.168.100.1&quot;,&quot;mac_address&quot;:&quot;52:54:00:14:3a:d4&quot;&#125;</span><br><span class="line">&#123;&quot;ip&quot;:&quot;192.168.100.77&quot;,&quot;mac_address&quot;:&quot;52:54:00:f8:9b:2b&quot;&#125;</span><br><span class="line">maas admin discoveries clear-by-mac-and-ip ip=&lt;IP&gt; mac=&lt;MAC&gt;</span><br><span class="line"></span><br><span class="line">#delete from maasserver_interface_ip_addresses where staticipaddress_id=64548 and id=64188;</span><br><span class="line">#delete from maasserver_staticipaddress where id=64548 and ip=&apos;192.168.128.15&apos;;</span><br><span class="line"></span><br><span class="line">#http://127.0.0.1:5240/MAAS/r/settings/network/network-discovery (Network discovery -&gt; Active subnet mapping interval)</span><br><span class="line">maas admin  maas get-config name=network_discovery</span><br><span class="line">maas admin discoveries clear all=True</span><br><span class="line">maas admin maas set-config name=network_discovery value=disabled</span><br><span class="line">maas admin maas get-config name=network_discovery</span><br><span class="line">maas admin discoveries read</span><br></pre></td></tr></table></figure>
<h2 id="20200915更新-maas-2-8中使用centos-8"><a href="#20200915更新-maas-2-8中使用centos-8" class="headerlink" title="20200915更新 - maas 2.8中使用centos 8"></a>20200915更新 - maas 2.8中使用centos 8</h2><p>maas中使用centos的主要障碍是<a href="https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335，但这个目前这个代码已经在UA了，只是maas" target="_blank" rel="external">https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335，但这个目前这个代码已经在UA了，只是maas</a> 2.8的UI还没有允许让你使用centos 8而已，可以这样使用centos 8<br>但是限制是：</p>
<ul>
<li>maas UI不支持上传centos8镜像（原因是因为这个还没有-<a href="http://images.maas.io/ephemeral-v3/daily/streams/v1/com.ubuntu.maas:daily:centos-bases-download.json)，只是api可以(通过curtin" target="_blank" rel="external">http://images.maas.io/ephemeral-v3/daily/streams/v1/com.ubuntu.maas:daily:centos-bases-download.json)，只是api可以(通过curtin</a>)</li>
<li>maas-image-builder不支持做centos8镜像，似乎packer-maas可以，或者自定义(<a href="https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d" target="_blank" rel="external">https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d</a>)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:maas/2.8</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install maas -y</span><br><span class="line">sudo maas init --admin-username admin --admin-password password --admin-email admin@example.com --admin-ssh-import zhhuabj</span><br><span class="line">sudo maas-region apikey --username=admin &gt; ~/admin-api-key</span><br><span class="line">apikey=$(cat ~/admin-api-key)</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line"></span><br><span class="line"># Once Curtin has been upgraded the image can be uploaded to MAAS via the API</span><br><span class="line">#https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335</span><br><span class="line">sudo apt install curtin=20.1-2-g42a9667f-0ubuntu1~18.04.1 -y</span><br><span class="line">sudo systemctl stop maas-rackd &amp;&amp; sudo systemctl restart maas-regiond &amp;&amp; sudo systemctl start maas-rackd</span><br><span class="line">axel https://people.canonical.com/~zhhuabj/centos8.tar.gz</span><br><span class="line">maas admin boot-resources create name=&apos;centos 8&apos; title=&apos;centos 8&apos; architecture=&apos;amd64/generic&apos; filetype=&apos;tgz&apos; content@=centos8-1.0.2-7-gac521bb.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">但似乎maas-image-builder还不支持做centos8的镜像，但可参考这篇文章做　－　https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d</span><br><span class="line">还有一个工具叫packer-maas似乎也能做，见- https://manintheit.org/bash/creating-a-image-for-maas-with-packer/</span><br><span class="line">$ sudo maas-image-builder -o centos8-amd64-root-tgz --arch amd64 centos --edition 8</span><br><span class="line">...</span><br><span class="line">mib.builders.BuildError: Unknown CentOS edition: 8.</span><br><span class="line"></span><br><span class="line">$ grep -r &apos;grub2&apos; /usr/lib/curtin/helpers/common |grep 8</span><br><span class="line">               7|8) grub_name=&quot;grub2-pc&quot;;;</span><br><span class="line">                        7|8) grubcmd=&quot;grub2-install&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">使用packer-maas创建centos8镜像如下:</span><br><span class="line"># https://github.com/canonical/packer-maas/tree/master/centos8</span><br><span class="line">sudo apt install packer</span><br><span class="line"># fix bug - https://github.com/canonical/packer-maas/issues/2</span><br><span class="line">wget https://releases.hashicorp.com/packer/1.6.2/packer_1.6.2_linux_amd64.zip</span><br><span class="line">unzip packer_1.6.2_linux_amd64.zip &amp;&amp; sudo cp ./packer /usr/bin/ &amp;&amp; packer --version</span><br><span class="line">git clone https://github.com/canonical/packer-maas.git</span><br><span class="line">cd packer-maas/centos8  #must be in cetnos8 subdir</span><br><span class="line">#change url in centos8.json to http://mirrors.aliyun.com/centos/8.2.2004/isos/x86_64/CentOS-8.2.2004-x86_64-boot.iso</span><br><span class="line">sudo PACKER_LOG=1 packer build centos8.json  #but will hit this bug - https://github.com/canonical/packer-maas/issues/2</span><br><span class="line">maas admin boot-resources create name=&apos;centos/8-custom&apos; title=&apos;CentOS 8 Custom&apos; architecture=&apos;amd64/generic&apos; filetype=&apos;tgz&apos; content@=centos8.tar.gz  #default username is cloud-user</span><br></pre></td></tr></table></figure>
<p>然后可以设置Deploy的默认镜像(commission时只能用ubuntu镜像), 也可以在Deploy时选择用centos镜像, 但commission似乎只能使用ubuntu镜像. deploy日志可见: /var/log/maas/rsyslog/test/2020-09-25/messages<br>最终可以通过: ‘ssh cloud-user@192.168.100.2’访问deploy后的centos8 机器. 如果不是deploy的而是救援模式进去的可以”ssh ubuntu@192.168.100.2 -v”, 注意: 救援模式只是commisstion不是deploy所以也是无法选择image的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[cloud-user@test ~]$ uname -a</span><br><span class="line">Linux test.maas 4.18.0-193.14.2.el8_2.x86_64 #1 SMP Sun Jul 26 03:54:29 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20200925184437707.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>但这个镜像似乎在uefi虚机时不work, 创建测试uefi虚机的步骤如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ovmf -y  #should install ovmf in node1 rather than t440p</span><br><span class="line">sudo systemctl restart libvirtd</span><br><span class="line">virt-manager --debug      #run it in t440p, then connect to node1</span><br><span class="line">Start creating a new VM in virt-manager, but before finishing, click &quot;Customize configuration before install&quot;</span><br><span class="line">Change the Firmware Option from BIOS to EUFI in &apos;Overview&apos; tab. (If it&apos;s not available do a systemctl restart libvirtd)</span><br></pre></td></tr></table></figure></p>
<h2 id="debug-curtin"><a href="#debug-curtin" class="headerlink" title="debug curtin"></a>debug curtin</h2><p><a href="https://gist.github.com/smoser/2610e9b78b8d7b54319675d9e3986a1b" target="_blank" rel="external">https://gist.github.com/smoser/2610e9b78b8d7b54319675d9e3986a1b</a><br>在maas中查看日志/var/log/maas/rsyslog/test2/2020-09-28/messages, 看到的错误如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curthooks -&gt; builtin_curthooks -&gt; setup_grub -&gt; install_grub(instdevs, target, uefi=uefi_bootable, grubcfg=grubcfg) -&gt;</span><br><span class="line"></span><br><span class="line">unshare --fork --pid -- chroot /tmp/tmp6yj0ryyc/target grub2-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=centos --recheck --no-nvram</span><br><span class="line"></span><br><span class="line">Stderr: grub2-install: error: /usr/lib/grub/x86_64-efi/modinfo.sh doesn&apos;t exist.</span><br></pre></td></tr></table></figure>
<p>/usr/lib/grub/x86_64-efi/modinfo.sh 不存在, 这个网页<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1101352" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1101352</a> 说:<br>Looks like this is intentional to avoid the fallout of unsuspecting users running grub2-install. To regain ability to grub2-install on EFI, install package grub2-efi-modules.<br>所以是需要安装grub2-efi-modules模块. 下面方法检查image中检查确认确实没有这个包:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#sudo guestmount -a /var/lib/libvirt/images/test2.qcow2  -i --rw ./root2</span><br><span class="line">sudo modprobe nbd</span><br><span class="line">sudo qemu-nbd --connect=/dev/nbd0 /var/lib/libvirt/images/test2.qcow2 -f qcow2</span><br><span class="line">sudo fdisk /dev/nbd0 -l</span><br><span class="line">sudo qemu-nbd --disconnect /dev/nbd0</span><br><span class="line">$ sudo fdisk /dev/nbd0 -l |grep dev</span><br><span class="line">Disk /dev/nbd0: 20 GiB, 21474836480 bytes, 41943040 sectors</span><br><span class="line">/dev/nbd0p1    2048  1050623  1048576  512M EFI System</span><br><span class="line">/dev/nbd0p2 1050624 41928703 40878080 19.5G Linux filesystem</span><br><span class="line"></span><br><span class="line">cd /tmp &amp;&amp; mkdir &#123;boot,root&#125;</span><br><span class="line">sudo mount /dev/nbd0p1 ./boot/</span><br><span class="line">sudo mount /dev/nbd0p2 ./root/</span><br><span class="line"></span><br><span class="line">$ ls ./root/usr/lib/grub/</span><br><span class="line">i386-pc</span><br><span class="line"></span><br><span class="line">$ sudo dpkg -L grub-efi-amd64-bin |grep modinfo.sh</span><br><span class="line">/usr/lib/grub/x86_64-efi/modinfo.sh</span><br><span class="line">$ sudo apt-file search modinfo.sh |grep amd64</span><br><span class="line">grub-efi-amd64-bin: /usr/lib/grub/x86_64-efi/modinfo.sh</span><br></pre></td></tr></table></figure></p>
<p>先试了使用kickstart定制包, 但不好使: <a href="https://manintheit.org/bash/creating-a-image-for-maas-with-packer/" target="_blank" rel="external">https://manintheit.org/bash/creating-a-image-for-maas-with-packer/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo PACKER_LOG=1 HTTPIP=127.0.0.1 HTTPPort=8000 packer build centos8.json</span><br></pre></td></tr></table></figure></p>
<p>然后用下列方法重新打包, 在image中添加这个包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/centos8 &amp;&amp; sudo tar -xf centos8.tar.gz -C /tmp/centos8/</span><br><span class="line">MOUNTDIR=/tmp/centos8</span><br><span class="line">for d in dev sys proc; do sudo mount --bind /$d $&#123;MOUNTDIR&#125;/$d; done</span><br><span class="line">sudo mv $&#123;MOUNTDIR&#125;/etc/resolv.conf $&#123;MOUNTDIR&#125;/etc/resolv.conf.bak &amp;&amp; sudo cp /etc/resolv.conf $&#123;MOUNTDIR&#125;/etc/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#sudo chroot $MOUNTDIR bash</span><br><span class="line">sudo chroot $MOUNTDIR yum update</span><br><span class="line">#install grub2-efi-x64-modules instead of grub2-efi-modules to avoid grub2-efi-aa64-modules</span><br><span class="line">sudo chroot $MOUNTDIR yum install grub2-efi-x64-modules -y</span><br><span class="line">sudo chroot $MOUNTDIR ls /usr/lib/grub/x86_64-efi/modinfo.sh</span><br><span class="line">sudo chroot $MOUNTDIR yum list --installed |grep -E &apos;shim|efi&apos;</span><br><span class="line"></span><br><span class="line">sudo umount $MOUNTDIR/&#123;proc,dev,sys,&#125;</span><br><span class="line">sudo mv $MOUNTDIR/etc/resolv.conf.bak $MOUNTDIR/etc/resolv.conf</span><br><span class="line">sudo tar -czf centos8.tar.gz -C $MOUNTDIR .</span><br></pre></td></tr></table></figure>
<p>现在之前的错误没了, 又出现下列新错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command: [&apos;unshare&apos;, &apos;--fork&apos;, &apos;--pid&apos;, &apos;--&apos;, &apos;chroot&apos;, &apos;/tmp/tmphc1fr7hk/target&apos;, &apos;dracut&apos;, &apos;-f&apos;, &apos;/boot/initramfs-4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64.img&apos;, &apos;4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64&apos;]        Exit code: 1        Reason: -        Stdout: &apos;&apos;        Stderr: dracut: Cannot find module directory /lib/modules/4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64/                dracut: and --no-kernel was not specified</span><br></pre></td></tr></table></figure></p>
<p>那是因为刚刚升级了centos(不应该升级)导致有两个内核了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4# rpm -q kernel</span><br><span class="line">kernel-4.18.0-193.14.2.el8_2.x86_64</span><br><span class="line">kernel-4.18.0-193.19.1.el8_2.x86_64</span><br><span class="line"></span><br><span class="line">bash-4.4# rpm -q --queryformat %&#123;VERSION&#125;-%&#123;RELEASE&#125;.%&#123;ARCH&#125; kernel</span><br><span class="line">4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64</span><br><span class="line"></span><br><span class="line">dracut -f /boot/initramfs-4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64.img 4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64</span><br></pre></td></tr></table></figure></p>
<p>这个修改后, 又遇到image缓存了, 之后, 这些问题没有了, 但进系统时总是进入mergency mode, 原因是initrd-switch-root.service服务启动失败, 是因为找不到硬盘.<br>最后是这样解决的, 修改packer-maas/centos8/http/centos8.ks<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#grub2-efi-x64</span><br><span class="line">efibootmgr</span><br><span class="line">#shim-x64</span><br><span class="line">grub2-efi-x64-modules</span><br></pre></td></tr></table></figure></p>
<p><strong>Reference</strong><br>[1] <a href="https://blog.csdn.net/quqi99/article/details/37990507" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/37990507</a><br>[2] <a href="https://www.cnblogs.com/aegis1019/p/8870251.html" target="_blank" rel="external">https://www.cnblogs.com/aegis1019/p/8870251.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/" itemprop="url">Fix the error CERTIFICAT_VERIFY_FAILED</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-07T15:54:08+08:00">
                2020-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-07-07<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 <a href="https://node1.lan:8081/discharge/info" target="_blank" rel="external">https://node1.lan:8081/discharge/info</a> 时抛的错.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maas (maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest) -&gt; rbac with http (http://node1.lan:8081) -&gt; candid with https (https://node1.lan:8081/discharge/info) -&gt; ldap with https</span><br></pre></td></tr></table></figure></p>
<p>奇怪的是, 我已经运行过这个命令( cp ~/certs/ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates )了. 不应该啊.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-ca-certificates --fresh</span><br><span class="line">$ export SSL_CERT_DIR=/etc/ssl/certs</span><br></pre></td></tr></table></figure></p>
<h2 id="curl测试"><a href="#curl测试" class="headerlink" title="curl测试"></a>curl测试</h2><p>运行下列三个命令均无问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://node1.lan:8081/discharge/info</span><br><span class="line">curl https://node1.lan:8081/discharge/info -k</span><br><span class="line">curl https://node1.lan:8081/discharge/info --cacert ~/certs/ca.crt</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-urllib2-request"><a href="#python测试-urllib2-request" class="headerlink" title="python测试 - urllib2.request"></a>python测试 - urllib2.request</h2><p>下列python代码测试也没问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; test.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import ssl</span><br><span class="line">try:</span><br><span class="line">    import urllib2 #python2</span><br><span class="line">except:</span><br><span class="line">    import urllib.request as urllib2 #python3</span><br><span class="line"></span><br><span class="line">req = urllib2.Request(sys.argv[1], headers=&#123;&apos;Bakery-Protocol-Version&apos;:&apos;3&apos;&#125;)</span><br><span class="line">print(urllib2.urlopen(req).read())</span><br><span class="line">EOF</span><br><span class="line">mkdir /usr/share/ca-certificates/extras</span><br><span class="line">cp ~/certs//ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates</span><br><span class="line">python test.py https://node1.lan:8081/discharge/info</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-requests"><a href="#python测试-requests" class="headerlink" title="python测试 - requests"></a>python测试 - requests</h2><p>奇了怪了, 只好继续调试代码, 发现rbac使用了pymacaroons (<a href="https://github.com/ecordell/pymacaroons" target="_blank" rel="external">https://github.com/ecordell/pymacaroons</a>), pymacaroons它又会调用requests (不是urllib2.request)<br>所以继续写了一个python测试, 问题就重现了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; test2.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = sys.argv[1]</span><br><span class="line">print(requests.get(url).read())</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">...</span><br><span class="line">requests.exceptions.SSLError: HTTPSConnectionPool(host=&apos;node1.lan&apos;, port=8081): Max retries exceeded with url: /discharge/info (Caused by SSLError(SSLError(1, &apos;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:852)&apos;),))</span><br></pre></td></tr></table></figure></p>
<p>添加REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem 问题解决.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem  python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">200</span><br></pre></td></tr></table></figure>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>改为下列使命启动rbac<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<p>或者使用全局ca database<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># use the full system database</span><br><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>应该是遇到了这个bug - <a href="https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144" target="_blank" rel="external">https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144</a><br>现在request的代码(<a href="https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径" target="_blank" rel="external">https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r where /bak/work/crbs/.ve/lib/python3.6/site-packages/requests/certs.py</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line"></span><br><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &quot;cacert.pem&quot;)</span><br></pre></td></tr></table></figure></p>
<p>python-request 2.9.1版本的debian包中有一个01_use-system-ca-certificates.patch修改了ca路径为/etc/ssl/certs/ca-certificates.crt, requests-2.18.4版本开始改用certifi模块中的where函数并修复了这个问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;return&apos; /tmp/requests-2.9.1/debian/patches/01_use-system-ca-certificates.patch</span><br><span class="line">-        return os.path.join(os.path.dirname(__file__), &apos;cacert.pem&apos;)</span><br><span class="line">+        return &apos;/etc/ssl/certs/ca-certificates.crt&apos;</span><br><span class="line"></span><br><span class="line"># grep -r where /tmp/requests-2.18.4/requests/certs.py</span><br><span class="line">environment, you can change the definition of where() to return a separately</span><br><span class="line">from certifi import where</span><br><span class="line">    print(where())</span><br><span class="line"># grep -r &apos;def where&apos; /usr/lib/python3/dist-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    return &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br></pre></td></tr></table></figure></p>
<p>但virtualenv环境中没有改:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br></pre></td></tr></table></figure></p>
<p>不可能去修改上游virtualenv模块, 看来只能修改rbac这个应用了.</p>
<h2 id="怎么解决呢"><a href="#怎么解决呢" class="headerlink" title="怎么解决呢"></a>怎么解决呢</h2><p>requests module (/snap/xxx-rbac/224/lib/python3.6/site-packages/requests)在使用/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem. 而不是在使用/var/snap/xxx-rbac/current/conf/certs/ca.pem (snap set xxx-rbac ssl.ca=”$(cat $cert_dir/ca.crt)”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# grep -r &apos;import where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/requests/certs.py -A 3</span><br><span class="line">from certifi import where</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line">(.ve) root@node1:~# grep -r &apos;where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &apos;cacert.pem&apos;)</span><br><span class="line"></span><br><span class="line">(.ve) root@node1:~# ls /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br><span class="line">/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br></pre></td></tr></table></figure></p>
<p>所以得使用REQUESTS_CA_BUNDLE变量, 但上面是通过源码运行的 (REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver –debug run -P 5000),  现在改从snap(systemctl restart snap.xxx-rbac.uwsgi)的方式启动.  但发现这条code path (./crbs/wsgi.py#make_wsgi_app -&gt; ./crbs/setup.py#setup_globals -&gt; ./crbs/snap/_env.py(set REQUESTS_CA_BUNDLE))设置了REQUESTS_CA_BUNDLE, 可它为什么不生效了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>但从snap容器中没查着这个环境变量:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# snap run --shell xxx-rbac.uwsgi</span><br><span class="line">root@node1:/root# env |grep REQUESTS_CA_BUNDLE</span><br><span class="line"></span><br><span class="line">NOTE: 也可以通过:snap run xxx-rbac.uwsgi --ini /var/snap/xxx-rbac/x4/conf/uwsgi.ini 来在snap container里运行命令，但是snap container里没有python命令:</span><br><span class="line">root@node1:~# snap run canonical-rbac.python</span><br><span class="line">error: cannot find app &quot;python&quot; in &quot;canonical-rbac&quot;</span><br></pre></td></tr></table></figure></p>
<p>从host机器也没查着:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# pidof uwsgi</span><br><span class="line">3898 3897 3896 3895 3894 3893 3892 3891 3679</span><br><span class="line">(.ve) root@node1:~# cat /proc/3898/environ |grep REQUESTS_CA_BUNDLE</span><br><span class="line">(.ve) root@node1:~#</span><br></pre></td></tr></table></figure></p>
<p>改以只能想着通过pdb ( import pdb;pdb.set_trace() )调试, 但/snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py是只读的没法添加断点.<br>另一种可能的调试方法是采用’python3 -m pdb xx.py’的方式交互性调试( 这样, 断点设置在第1行 - <a href="https://pymotw.com/3/pdb/" target="_blank" rel="external">https://pymotw.com/3/pdb/</a> ). snap.xxx-rbac.uwsgi最终得通过(/usr/bin/snap run xxx-rbac.uwsgi) 启动, 最终调用command-uwsgi.wrapper启动, 但似乎我们也无法修改command-uwsgi.wrapper啊它也中只读的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# cat /snap/xxx-rbac/224/command-uwsgi.wrapper</span><br><span class="line">#!/bin/sh</span><br><span class="line">exec &quot;uwsgi&quot; &quot;--ini&quot; &quot;$SNAP_DATA/conf/uwsgi.ini&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="debug-snap"><a href="#debug-snap" class="headerlink" title="debug snap"></a>debug snap</h2><p>想给snap里的python用pdb加个断点，因为snap的代码目录是只读的，非常难调．用下列方法可以修改源代码．但是仍然无法加 ‘import pdb;pdb.set_trace()’ 到源码，因为pdb需要通过python启动程序而不是通过snap启动程序．所以实际上snap部分的代码还是相当难调．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://forum.snapcraft.io/t/make-a-snap-writable-temporarily-for-debugging/16370/3</span><br><span class="line">unsquashfs -d canonical-rbac /var/lib/snapd/snaps/canonical-rbac_224.snap</span><br><span class="line"># modfity file here. eg:  ./canonical-rbac/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">snap try canonical-rbac --devmode</span><br></pre></td></tr></table></figure></p>
<h2 id="问题最终解决"><a href="#问题最终解决" class="headerlink" title="问题最终解决"></a>问题最终解决</h2><p>snap都是只读的实在无法调试，最后发现一个现象．直接在浏览器(最好用firefox, 使用chrome时不弹出框)访问rbac portal (<a href="https://node1.lan:5000" target="_blank" rel="external">https://node1.lan:5000</a> )并不出现这个错，只是使用＂maas configauth –rbac-url <a href="https://node1.lan:5000/" target="_blank" rel="external">https://node1.lan:5000/</a> –rbac-service-name maastest＂命令时报这个错．这会不会是maas的问题？尤其是maas是通过snap安装的，而不是通过debian安装的，maas是不是缺少了下 面类似于rbac的用于设置的代码．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>通过debian包安装后证明果然是这个问题.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install maas --channel=2.8</span><br><span class="line">#sudo snap install maas-test-db                              #enter shell - maas-test-db.psql</span><br><span class="line">#sudo maas init region+rack --database-uri maas-test-db:///  #http://192.168.99.124:5240/MAAS</span><br><span class="line">sudo add-apt-repository ppa:maas/2.8   #https://launchpad.net/~maas</span><br><span class="line">sudo apt install maas</span><br><span class="line"></span><br><span class="line">sudo maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest  #use external authentication</span><br><span class="line"># sudo maas createadmin   #not use external authentication</span><br></pre></td></tr></table></figure>
<h2 id="openstack-ssl"><a href="#openstack-ssl" class="headerlink" title="openstack ssl"></a>openstack ssl</h2><p>快速创建一个ssl环境:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh --name ovn-octavia --series bionic --release ussuri --octavia --ovn --create-model --run</span><br><span class="line">juju config neutron-api default-tenant-network-type=gre</span><br><span class="line">openstack --insecure endpoint list</span><br></pre></td></tr></table></figure></p>
<p>默认的证书./openstack/ssl/openstack-ssl/results/cacert.pem是采用了SNI的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju ssh keystone/0 -- openssl x509 -noout -text -in /etc/apache2/ssl/keystone/cert_10.5.1.45 |grep CN</span><br><span class="line">curl --resolve juju-8284e4-ovn-octavia-2.cloud.sts:5000:10.5.1.45 --cacert ./openstack/ssl/openstack-ssl/results/cacert.pem https://juju-8284e4-ovn-octavia-2.cloud.sts:5000</span><br></pre></td></tr></table></figure></p>
<p>所以第一步要将keystone endpoint中的IP改成DOMAIN<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOMAIN=$(juju ssh keystone/0 -- hostname -f |sed s/[[:space:]]//g) &amp;&amp; echo $DOMAIN</span><br><span class="line">juju config keystone os-admin-hostname=$DOMAIN os-public-hostname=$DOMAIN os-internal-hostname=$DOMAIN</span><br></pre></td></tr></table></figure></p>
<p>然后按理说应该就可以了的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source novarc</span><br><span class="line">export OS_AUTH_URL=https://juju-8284e4-ovn-octavia-2.cloud.sts:5000/v3</span><br><span class="line">export OS_CACERT=./openstack/ssl/openstack-ssl/results/cacert.pem</span><br><span class="line">openstack  endpoint list</span><br></pre></td></tr></table></figure>
<p>但实际是不行的，因为证书./openstack/ssl/openstack-ssl/results/cacert.pem已经通过下列命令加入了系统中.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ./openstack/ssl/openstack-ssl/results/cacert.pem /usr/local/share/ca-certificates/cacert.crt</span><br><span class="line">sudo chmod 644 /usr/local/share/ca-certificates/cacert.crt</span><br><span class="line">sudo update-ca-certificates --fresh</span><br></pre></td></tr></table></figure></p>
<p>这也是一个bug, 改成下列居然就好了(<a href="https://medium.com/@george.shuklin/ssl-certificate-abyss-in-openstack-5c3c4a92eb5a" target="_blank" rel="external">https://medium.com/@george.shuklin/ssl-certificate-abyss-in-openstack-5c3c4a92eb5a</a>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OS_CACERT=/etc/ssl/certs/</span><br></pre></td></tr></table></figure>
<h2 id="重要更新"><a href="#重要更新" class="headerlink" title="重要更新"></a>重要更新</h2><p>之所以要’export OS_CACERT=/etc/ssl/certs/‘的原因最后查出来是因为习惯不好，在机器上运行过devstack导致安装了python3-pip且通过pip3安装了certifi这个包，所以在删除它之后再运行“python3 -c “import certifi; print(certifi.where());””就正常了。<br>所以养成好习惯，非devstack开发环境机器上不要安装pip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 freeze | xargs -i sudo pip3 uninstall &#123;&#125; -y</span><br><span class="line">#sudo apt remove --purge python3-pip</span><br><span class="line">ls /usr/local/lib/python3.8/dist-packages/</span><br></pre></td></tr></table></figure></p>
<p>另外，由于bastion安装过devstack来导致在并行上传镜像时导致ssh中断。<br>世界由此清净了！但此时报：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openstack</span><br><span class="line">bash: /usr/local/bin/openstack: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>那是需要删除“/usr/local/bin/openstack*”确保使用/usr/bin/openstack, 同时要登出再重新登录shell即可。<br>另外，似乎也可以直接运行下列命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ~/.local/lib/python3.8/site-packages/pip*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3.6/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3.8/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python2.7/dist-packages/*</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
