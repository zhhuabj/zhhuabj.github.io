<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>技术并艺术着</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">
  
    <link rel="alternate" href="/atom.xml" title="技术并艺术着" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">技术并艺术着</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">张华的技术博客 - blog.csdn.net/quqi99</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-OpenStack-SSL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/07/OpenStack-SSL/" class="article-date">
  <time datetime="2018-02-07T05:25:04.000Z" itemprop="datePublished">2018-02-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/07/OpenStack-SSL/">OpenStack SSL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07)</strong></p>
<h2 id="OpenStack-Charm如何支持SSL"><a href="#OpenStack-Charm如何支持SSL" class="headerlink" title="OpenStack Charm如何支持SSL"></a>OpenStack Charm如何支持SSL</h2><p>OpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoint，同时也会生成/etc/apache2/ssl/keystone配置。</p>
<ol>
<li><p>一种方式有证书就直接指定证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju config &lt;openstack-charm&gt; os-admin-hostname=&apos;X.xxx.com&apos; os-public-hostname=&apos;X.xxx.com&apos; os-internal-hostname=&apos;X.xxx.com&apos; ssl_ca=&apos;$cat ~/ssl_ca.crt&apos; ssl_cert=&apos;$cat ~/ssl_cert.crt&apos; ssl_key=&apos;&apos;$cat ~/ssl_key.key&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式是由charm来自动生成证书。如果用户没有指定ssl_cert与ssl_key，那么is_cert_provided_in_config=False，charm将自动生成证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def is_cert_provided_in_config():</span><br><span class="line">    cert = config(&apos;ssl_cert&apos;)</span><br><span class="line">    key = config(&apos;ssl_key&apos;)</span><br><span class="line">    return bool(cert and key)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体命令如下，也可参考：<a href="https://paste.ubuntu.com/26533565/" target="_blank" rel="external">https://paste.ubuntu.com/26533565/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">juju config keystone use-https=true</span><br><span class="line">juju config keystone https-service-endpoints=true</span><br><span class="line">tree /var/lib/keystone/juju_ssl/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/keystone/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/nova/  #on nova node</span><br><span class="line">select * from endpoint;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-ids identity-service&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-list -r identity-service:13&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-get -r identity-service:13 - nova-cloud-controller/0&quot;</span><br><span class="line"></span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_PASSWORD=openstack</span><br><span class="line">export OS_AUTH_URL=https://10.5.0.28:5000/v2.0</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">openstack --insecure endpoint list</span><br><span class="line">openstack --insecure server list</span><br><span class="line">openstack --insecure --debug server list</span><br><span class="line">openstack --insecure --debug volume list</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-HA-Charm如何支持SSL"><a href="#OpenStack-HA-Charm如何支持SSL" class="headerlink" title="OpenStack HA Charm如何支持SSL"></a>OpenStack HA Charm如何支持SSL</h2><p>如果如nova-cloud-controller服务前又运行了下列命令添加了HA服务时呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju add-unit nova-cloud-controller -n 2  </span><br><span class="line">juju deploy hacluster ncc-hacluster --series xenial  </span><br><span class="line">juju add-relation nova-cloud-controller ncc-hacluster  </span><br><span class="line">juju config nova-cloud-controller vip=10.5.104.1</span><br></pre></td></tr></table></figure></p>
<p>corosync将通过下列配置将VIP=10.5.104.1创建在juju-2f3cc6-mitaka-10上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# crm status</span><br><span class="line">Last updated: Wed Feb  7 04:18:31 2018		Last change: Wed Feb  7 04:09:33 2018 by hacluster via crmd on juju-2f3cc6-mitaka-10</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: juju-2f3cc6-mitaka-6 (version 1.1.14-70404b0) - partition with quorum</span><br><span class="line">3 nodes and 4 resources configured</span><br><span class="line">Online: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> Resource Group: grp_nova_vips</span><br><span class="line">     res_nova_ens3_vip	(ocf::heartbeat:IPaddr2):	Started juju-2f3cc6-mitaka-10</span><br><span class="line"> Clone Set: cl_nova_haproxy [res_nova_haproxy]</span><br><span class="line">     Started: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line"></span><br><span class="line">root@juju-2f3cc6-mitaka-10:~# ip addr show ens3 |grep 10.5.104.1</span><br><span class="line">    inet 10.5.104.1/16 brd 10.5.255.255 scope global secondary ens3</span><br></pre></td></tr></table></figure></p>
<p>同时，三个HA节点上的haproxy的配置(/etc/haproxy/haproxy.cfg)将创建代理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend tcp-in_nova-api-os-compute</span><br><span class="line">    bind *:8774</span><br><span class="line">    bind :::8774</span><br><span class="line">    acl net_10.5.0.15 dst 10.5.0.15/255.255.0.0</span><br><span class="line">    use_backend nova-api-os-compute_10.5.0.15 if net_10.5.0.15</span><br><span class="line">    default_backend nova-api-os-compute_10.5.0.15</span><br><span class="line">backend nova-api-os-compute_10.5.0.15</span><br><span class="line">    balance leastconn</span><br><span class="line">    server nova-cloud-controller-1 10.5.0.15:8764 check</span><br><span class="line">    server nova-cloud-controller-0 10.5.0.37:8764 check</span><br><span class="line">    server nova-cloud-controller-2 10.5.0.52:8764 check</span><br></pre></td></tr></table></figure></p>
<p>最重要的是，三个HA节点上Apache都将设置代理“RequestHeader set X-Forwarded-Proto “https””，完整的配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# cat /etc/apache2/sites-available/openstack_https_frontend.conf </span><br><span class="line">Listen 8764</span><br><span class="line">&lt;VirtualHost 10.5.0.15:8764&gt;</span><br><span class="line">    ServerName 10.5.104.1</span><br><span class="line">    SSLEngine on</span><br><span class="line">    SSLProtocol +TLSv1 +TLSv1.1 +TLSv1.2</span><br><span class="line">    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!EXP:!LOW:!MEDIUM</span><br><span class="line">    SSLCertificateFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    # See LP 1484489 - this is to support &lt;= 2.4.7 and &gt;= 2.4.8</span><br><span class="line">    SSLCertificateChainFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    SSLCertificateKeyFile /etc/apache2/ssl/nova/key_10.5.104.1</span><br><span class="line">    ProxyPass / http://localhost:8754/</span><br><span class="line">    ProxyPassReverse / http://localhost:8754/</span><br><span class="line">    ProxyPreserveHost on</span><br><span class="line">    RequestHeader set X-Forwarded-Proto &quot;https&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">    Order deny,allow</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-Horizon和Apache代理之间如何支持SSL"><a href="#OpenStack-Horizon和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack Horizon和Apache代理之间如何支持SSL"></a>OpenStack Horizon和Apache代理之间如何支持SSL</h2><p>openstack horizon使用了Django框架，Django中有如下代码（<a href="https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），" target="_blank" rel="external">https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property</span><br><span class="line">def scheme(self):</span><br><span class="line">    if settings.SECURE_PROXY_SSL_HEADER:</span><br><span class="line">        try:</span><br><span class="line">            header, value = settings.SECURE_PROXY_SSL_HEADER</span><br><span class="line">        except ValueError:</span><br><span class="line">            raise ImproperlyConfigured(</span><br><span class="line">                &apos;The SECURE_PROXY_SSL_HEADER setting must be a tuple containing two values.&apos;</span><br><span class="line">            )</span><br><span class="line">        if self.META.get(header) == value:</span><br><span class="line">            return &apos;https&apos;</span><br><span class="line">    return self._get_scheme()</span><br></pre></td></tr></table></figure>
<p>它会根据django中是否配置了SECURE_PROXY_SSL_HEADER，然后比较和header中传过来的SECURE_PROXY_SSL_HEADER(self.META.get(header))是否相等, 若相等才返回https给前端代理。所以这说明需要做两件事情：</p>
<ol>
<li>一是在django的conf/global_settings.py模板中配置： SECURE_PROXY_SSL_HEADER = (‘HTTP_X_FORWARDED_PROTO’, ‘https’)</li>
<li>二是前端代理apache中的配置传过来名为X-Forwarded-Proto的header: RequestHeader set X-Forwarded-Proto “https”<br>更多见： <a href="https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/" target="_blank" rel="external">https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/</a></li>
</ol>
<h2 id="OpenStack其他工程和Apache代理之间如何支持SSL"><a href="#OpenStack其他工程和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack其他工程和Apache代理之间如何支持SSL"></a>OpenStack其他工程和Apache代理之间如何支持SSL</h2><p>至于其它openstack工程如nova则需要使用olso.middleware中的http_proxy_to_wsgi.py(<a href="https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto" target="_blank" rel="external">https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># World before RFC7239</span><br><span class="line">forwarded_proto = req.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">if forwarded_proto:</span><br><span class="line">    req.environ[&apos;wsgi.url_scheme&apos;] = forwarded_proto</span><br></pre></td></tr></table></figure></p>
<p>nova-api中再根据wsgi.url_scheme（<a href="https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443" target="_blank" rel="external">https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if environ[&apos;wsgi.url_scheme&apos;] == &apos;http&apos;:</span><br><span class="line">    port = &apos;80&apos;</span><br><span class="line">else:</span><br><span class="line">    port = &apos;443&apos;</span><br></pre></td></tr></table></figure></p>
<p>配置http_proxy_to_wsgi的方法是在/etc/nova/api-paste.ini中添加http_proxy_to_wsgi（ eg: <a href="https://bugs.launchpad.net/keystone/+bug/1590608" target="_blank" rel="external">https://bugs.launchpad.net/keystone/+bug/1590608</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[composite:openstack_compute_api_v21]</span><br><span class="line">use = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line">noauth2 = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit noauth2 osapi_compute_app_v21</span><br><span class="line">keystone = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line">[filter:http_proxy_to_wsgi]</span><br><span class="line">paste.filter_factory = oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory</span><br></pre></td></tr></table></figure>
<h2 id="附录-原生OpenStack配置SSL的方法"><a href="#附录-原生OpenStack配置SSL的方法" class="headerlink" title="附录 - 原生OpenStack配置SSL的方法"></a>附录 - 原生OpenStack配置SSL的方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1, Create ssl certifate</span><br><span class="line"></span><br><span class="line">$ sudo keystone-manage ssl_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">$ chown -R keystone:keystone /etc/keystone/ssl</span><br><span class="line">$ sudo ls /etc/keystone/ssl/certs</span><br><span class="line">01.pem	ca.pem	index.txt  index.txt.attr  index.txt.old  keystone.pem	openssl.conf  req.pem  serial  serial.old</span><br><span class="line">$ sudo ls /etc/keystone/ssl/private</span><br><span class="line">cakey.pem  keystonekey.pem</span><br><span class="line"></span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/cakey.pem 1024</span><br><span class="line">openssl req -new -x509 -extensions v3_ca -key /etc/keystone/ssl/private/cakey.pem -out /etc/keystone/ssl/certs/ca.pem -days 3650 -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/keystonekey.pem 1024</span><br><span class="line">openssl req -key /etc/keystone/ssl/private/keystonekey.pem -new -out /etc/keystone/ssl/certs/req.pem -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl ca -batch -out /etc/keystone/ssl/certs/keystone.pem -config /etc/keystone/ssl/certs/openssl.conf -days 3650d -cert /etc/keystone/ssl/certs/ca.pem -keyfile /etc/keystone/ssl/private/cakey.pem -infiles /etc/keystone/ssl/certs/req.pem</span><br><span class="line"></span><br><span class="line">2, Keystone ssl configuration</span><br><span class="line"></span><br><span class="line"># vi /etc/keystone/keystone.conf</span><br><span class="line">[signing]</span><br><span class="line">certfile = /var/lib/keystone/juju_ssl/pki/certs/signing_cert.pem</span><br><span class="line">keyfile = /var/lib/keystone/juju_ssl/pki/privates/signing_key.pem</span><br><span class="line">ca_certs = /var/lib/keystone/juju_ssl/pki/certs/ca.pem</span><br><span class="line">ca_key = /var/lib/keystone/juju_ssl/pki/certs/ca_key.pem</span><br><span class="line"></span><br><span class="line">export OS_AUTH_URL=https://&#123;keystoneHost&#125;:5000/v2.0</span><br><span class="line"></span><br><span class="line"># create new https endpoint</span><br><span class="line">keystone endpoint-create</span><br><span class="line">--service keystone --region RegionOne --publicurl</span><br><span class="line">https://&#123;keystoneHost&#125;:5000/v2.0 --internalurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0 --adminurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0</span><br><span class="line"></span><br><span class="line"># delete old http endpoint</span><br><span class="line">keystone –-insecure endpoint-delete &#123;old endpoint id&#125;</span><br><span class="line"></span><br><span class="line">3, Nova ssl configuration</span><br><span class="line"></span><br><span class="line"># configure nova to use https to connect keystone</span><br><span class="line"># vi /etc/nova/api-paste.ini</span><br><span class="line">auth_uri = https://10.1.0.92:5000/v2.0</span><br><span class="line">auth_protocol = https</span><br><span class="line">insecure = True</span><br><span class="line"></span><br><span class="line">service openstack-nova-api restart</span><br><span class="line">service openstack-nova-compute restart</span><br><span class="line">service openstack-nova-scheduler restart</span><br><span class="line">service openstack-nova-cert restart</span><br><span class="line">service openstack-nova-conductor restart</span><br><span class="line">service openstack-nova-consoleauth restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vi /etc/nova/nova.conf [DEFAULT]</span><br><span class="line">enabled_ssl_apis=osapi_compute</span><br><span class="line">ssl_cert_file=/etc/nova/ssl/keystone.pem</span><br><span class="line">ssl_key_file=/etc/nova/ssl/keystonekey.pem</span><br><span class="line"></span><br><span class="line"># test it, at this time other component has not be configured to use https, so use --insecure</span><br><span class="line">nova --insecure hypervisor-list</span><br><span class="line"></span><br><span class="line"># copy ssl certifate for nova</span><br><span class="line"># mkdir /etc/nova/ssl</span><br><span class="line"># cp /etc/keystone/ssl/certs/keystone.pem /etc/nova/ssl/</span><br><span class="line"># cp /etc/keystone/ssl/private/keystonekey.pem /etc/nova/ssl/</span><br><span class="line"># chown -R nova:nova /etc/nova/ssl/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># create new https endpoint for nova</span><br><span class="line"># keystone --insecure</span><br><span class="line">endpoint-create --service nova --region RegionOne --publicurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --internalurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --adminurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/07/OpenStack-SSL/" data-id="cjllrf7230003ztbp9q7gioom" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Set-up-juju-development-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/06/Set-up-juju-development-env/" class="article-date">
  <time datetime="2018-02-06T03:22:39.000Z" itemprop="datePublished">2018-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/06/Set-up-juju-development-env/">Set up juju development env</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="Install-GO"><a href="#Install-GO" class="headerlink" title="Install GO"></a>Install GO</h2><p>It can’t find context package when using go-1.6 (usr/lib/go-1.6/src/context (from $GOROOT)), so switch to go &gt; 1.8.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#sudo apt upgrade golang</span><br><span class="line">wget https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz</span><br><span class="line">sudo rm -rf /usr/lib/go &amp;&amp; sudo tar -C /usr/lib -xzf go1.10.3.linux-amd64.tar.gz</span><br><span class="line">#注意：系统包更新后，如更新为go-1.10，那么GOROOT也要相应更新，否则报很多错</span><br><span class="line">export GOROOT=/usr/lib/go</span><br><span class="line">export GOPATH=/bak/golang</span><br><span class="line">export PATH=$GOROOT/bin:$GOPATH/bin:$PATH</span><br></pre></td></tr></table></figure></p>
<h2 id="Install-juju-from-source-code"><a href="#Install-juju-from-source-code" class="headerlink" title="Install juju from source code"></a>Install juju from source code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go get -d -v github.com/juju/juju/...</span><br><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">make install-dependencies</span><br><span class="line"># may fail because of the lack of some packages caused by gfw, you can fix it by &apos;go get ...&apos; one by one</span><br><span class="line">go install -v github.com/juju/juju/...</span><br><span class="line"></span><br><span class="line">go get github.com/rogpeppe/godeps</span><br><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">godeps -u dependencies.tsv</span><br></pre></td></tr></table></figure>
<h2 id="Prepare-LXD"><a href="#Prepare-LXD" class="headerlink" title="Prepare LXD"></a>Prepare LXD</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /var/lib/lxd</span><br><span class="line">sudo rm -rf /home/hua/.config/lxc/</span><br><span class="line">sudo apt install lxd zfsutils-linux bridge-utils squid-deb-proxy</span><br><span class="line">sudo mkdir -p /images/lxd &amp;&amp; sudo ln -s /images/lxd /var/lib/lxd/containers</span><br><span class="line">sudo systemctl enable lxd</span><br><span class="line">sudo systemctl start lxd</span><br><span class="line">newgrp lxd</span><br><span class="line">sudo usermod -a -G lxd hua</span><br><span class="line">sudo lxd init</span><br><span class="line">sudo chown -R root:lxd /var/lib/lxd</span><br></pre></td></tr></table></figure>
<h2 id="Create-juju-controller"><a href="#Create-juju-controller" class="headerlink" title="Create juju controller"></a>Create juju controller</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#https://jujucharms.com/docs/2.0/controllers-creating</span><br><span class="line">#https://api.jujucharms.com/charmstore/v5/~james-page/openstack-on-lxd/archive</span><br><span class="line">sudo lxc profile create juju-controller</span><br><span class="line">cat /bak/golang/jujudata/lxd-profile.yaml |sudo lxc profile edit juju-controller</span><br><span class="line">$ cat /bak/golang/jujudata/lxd-profile.yaml</span><br><span class="line">name: juju-controller</span><br><span class="line">config:</span><br><span class="line">  boot.autostart: &quot;true&quot;</span><br><span class="line">  security.nesting: &quot;true&quot;</span><br><span class="line">  security.privileged: &quot;true&quot;</span><br><span class="line">  linux.kernel_modules: openvswitch,nbd,ip_tables,ip6_tables</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    mtu: &quot;9000&quot;</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: lxdbr0</span><br><span class="line">    type: nic</span><br><span class="line">  eth1:</span><br><span class="line">    mtu: &quot;9000&quot;</span><br><span class="line">    name: eth1</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: lxdbr0</span><br><span class="line">    type: nic</span><br><span class="line">  kvm:</span><br><span class="line">    path: /dev/kvm</span><br><span class="line">    type: unix-char</span><br><span class="line">  mem:</span><br><span class="line">    path: /dev/mem</span><br><span class="line">    type: unix-char</span><br><span class="line">  root:</span><br><span class="line">    path: /</span><br><span class="line">    type: disk</span><br><span class="line">  tun:</span><br><span class="line">    path: /dev/net/tun</span><br><span class="line">    type: unix-char</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=xenial --config agent-stream=devel localhost juju-controller</span><br><span class="line">sudo lxc exec juju-bf76c2-0 bash</span><br></pre></td></tr></table></figure>
<h2 id="Set-up-development-env"><a href="#Set-up-development-env" class="headerlink" title="Set up development env"></a>Set up development env</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br><span class="line">git config --global user.email &quot;xxx&quot;</span><br><span class="line">ln -s ../../scripts/pre-push.bash .git/hooks/pre-push</span><br><span class="line">#https://segmentfault.com/a/1190000002783245</span><br><span class="line">git remote -v</span><br><span class="line">git pull upstream master</span><br><span class="line">git checkout -b new_feature</span><br><span class="line">go test github.com/juju/juju/...</span><br><span class="line">go fmt</span><br><span class="line">#JUJU_NOTEST_MONGOJS=1 go test github.com/juju/juju/...</span><br><span class="line">git config --global push.default &apos;nothing&apos;</span><br><span class="line">git rebase master</span><br><span class="line">#git push origin new_feature</span><br><span class="line">$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">        repositoryformatversion = 0</span><br><span class="line">        filemode = true</span><br><span class="line">        bare = false</span><br><span class="line">        logallrefupdates = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">        url = git@github.com:&lt;launchpad-id&gt;/juju.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch &quot;master&quot;]</span><br><span class="line">        remote = upstream</span><br><span class="line">        merge = refs/heads/master</span><br><span class="line">[remote &quot;upstream&quot;]</span><br><span class="line">        url = https://github.com/juju/juju.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/upstream/*</span><br></pre></td></tr></table></figure>
<p>这是一个典型的使用github pull request模式开发的例子，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># First click &apos;Fork&apos; button to fork - https://github.com/zhhuabj/openstack_understand_Neutron</span><br><span class="line">git clone git@github.com:zhhuabj/openstack_understand_Neutron.git</span><br><span class="line">cd openstack_understand_Neutron</span><br><span class="line">git config user.name &quot;zhhuabj&quot;</span><br><span class="line">git config user.email veryhua2006@gmail.com</span><br><span class="line"></span><br><span class="line">#do some change on the content</span><br><span class="line">git commit -am &quot;Fix issue #1: change helo to hello&quot;</span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line">#pull request</span><br><span class="line"></span><br><span class="line">#Update own fork</span><br><span class="line">git remote add upstream https://github.com/yeasy/openstack_understand_Neutron</span><br><span class="line">git fetch upstream</span><br><span class="line">git checkout master</span><br><span class="line">git rebase upstream/master</span><br><span class="line">git push -f origin master</span><br></pre></td></tr></table></figure></p>
<p>也可使用Shared Repository Model提交PR，见：<a href="https://gist.github.com/seshness/3943237" target="_blank" rel="external">https://gist.github.com/seshness/3943237</a></p>
<h2 id="附录-如何创建Go开发环境"><a href="#附录-如何创建Go开发环境" class="headerlink" title="附录 - 如何创建Go开发环境"></a>附录 - 如何创建Go开发环境</h2><p>1, GOPATH不需要配置多个(它可以配置多个，但不需要)，只配置一个即可。如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=/usr/lib/go-1.8</span><br><span class="line">export GOPATH=/bak/golang</span><br></pre></td></tr></table></figure></p>
<p>2, 下面开始配置我的第一个Go工程ss，<strong>将它放在$GOPATH/src/github.com/zhhuabj目录下</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /bak/golang/src/github.com/zhhuabj/ &amp;&amp; mkdir ss</span><br></pre></td></tr></table></figure></p>
<p>3, 使用govendor配置包依赖，使用govendor之后，优先从$GOPATH/src/github.com/zhhuabj/ss/vendor目录下找包，如果没有，才到$GOPATH/src目录下去找。‘govendor init’命令需在$GOPATH/src/github.com/zhhuabj/ss目录下执行，故：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get -u -v github.com/kardianos/govendor</span><br><span class="line">cd ss &amp;&amp; govendor init</span><br></pre></td></tr></table></figure></p>
<p>4, 使用govendor配置本工程需要用到的其他包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/mitchellh/go-homedir</span><br><span class="line">go get github.com/phayes/freeport</span><br><span class="line">govendor add github.com/mitchellh/go-homedir</span><br><span class="line">govendor add github.com/phayes/freeport</span><br><span class="line"></span><br><span class="line">hua@t440p:/bak/golang/src/github.com/zhhuabj/ss$ govendor list -v</span><br><span class="line"> vu github.com/mitchellh/go-homedir ::/vendor/github.com/mitchellh/go-homedir</span><br><span class="line"> vu github.com/phayes/freeport ::/vendor/github.com/phayes/freeport</span><br></pre></td></tr></table></figure></p>
<p>5, 编译并运行测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#/usr/lib/go-1.8/bin/go install -v -gcflags &quot;-N -l&quot; github.com/zhhuabj/ss/...</span><br><span class="line">GOPATH=/bak/golang go install -v github.com/zhhuabj/ss/...</span><br><span class="line">ll $GOPATH/bin/ss*</span><br><span class="line">go test -cover -bench=. -run=. github.com/zhhuabj/ss/...</span><br></pre></td></tr></table></figure></p>
<p>6， 配置eclipse + goclipse环境，首先安装goclipse插件(略), 然后运行下列命令安装一些下面要用到的库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get -u golang.org/x/tools/cmd/goimports</span><br><span class="line">go get -u golang.org/x/tools/cmd/gorename</span><br><span class="line">go get -u github.com/sqs/goreturns</span><br><span class="line">go get -u github.com/nsf/gocode</span><br><span class="line">go get -u github.com/alecthomas/gometalinter</span><br><span class="line">go get -u github.com/zmb3/gogetdoc</span><br><span class="line">go get -u github.com/rogpeppe/godef</span><br><span class="line">go get -u golang.org/x/tools/cmd/guru</span><br></pre></td></tr></table></figure></p>
<p>最后配置’Preferences -&gt; Go’与’Preferences -&gt; Go -&gt; Tools‘中的下列信息即可：<br>go installation directory = /usr/lib/go-1.8<br>gocode = /bak/golang/bin/gocode<br>guru = /bak/golang/bin/guru<br>godef = /bak/golang/bin/godef<br>gofmt = /usr/lib/go-1.8/bin/gofmt<br>最后创建eclipse工程，workspace可以选择在如/bak/workspace_go目录，但是工程目录设置到$GOPATH/src/github.com/zhhuabj/ss即可。所以不需要有多个GOPATH路径。<br>注意：eclipse中对go工程的是’Build All’，因为之前我将/bak/golang为了方便看代码也链了一个工程，所以Build All时出错。去掉该工程即可。<br>7, govendor没有版本控制，可使用godep添加版本控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/tools/godep</span><br><span class="line">ls /bak/golang/src/github.com/tools/godep/</span><br><span class="line">cd $GOPATH/src/github.com/zhhuabj/ss &amp;&amp; godep save -v ./...</span><br><span class="line"></span><br><span class="line">$ cat $GOPATH/src/github.com/zhhuabj/ss/Godeps/Godeps.json</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ImportPath&quot;: &quot;github.com/zhhuabj/ss&quot;,</span><br><span class="line">	&quot;GoVersion&quot;: &quot;go1.8&quot;,</span><br><span class="line">	&quot;GodepVersion&quot;: &quot;v79&quot;,</span><br><span class="line">	&quot;Packages&quot;: [</span><br><span class="line">		&quot;./...&quot;</span><br><span class="line">	],</span><br><span class="line">	&quot;Deps&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;github.com/mitchellh/go-homedir&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;b8bc1bf767474819792c23f32d8286a45736f1c6&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;github.com/phayes/freeport&quot;,</span><br><span class="line">			&quot;Comment&quot;: &quot;1.0.2-7-ge27662a&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;e27662a4a9d6b2083dfd7e7b5d0e30985daca925&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;golang.org/x/net/proxy&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;2fb46b16b8dda405028c50f7c7f0f9dd1fa6bfb1&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rm -rf /bak/golang/src/github.com/mitchellh/go-homedir/</span><br><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss/ &amp;&amp; godep go install -v github.com/zhhuabj/ss/...</span><br></pre></td></tr></table></figure></p>
<p>8, godep仅针对git, 如果想git和bzr同时用可使用godebs，就和上面juju中使用的一样。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/rogpeppe/godeps</span><br><span class="line"></span><br><span class="line"># need to write dependencies.tsv according to the following format</span><br><span class="line">https://github.com/rogpeppe/godeps/blob/master/dependencies.tsv</span><br><span class="line">github.com/kisielk/gotool	git	d6ce6262d87e3a4e153e86023ff56ae771554a41	2017-08-28T04:23:10Z</span><br><span class="line">launchpad.net/gocheck	bzr	gustavo@niemeyer.net-20140225173054-xu9zlkf9kxhvow02	87</span><br><span class="line"></span><br><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss/ &amp;&amp; godeps -u dependencies.tsv</span><br></pre></td></tr></table></figure></p>
<p>9, git版本控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m &apos;initial version&apos;</span><br><span class="line">git remote add origin git@github.com:xxxx/xx.git</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure></p>
<p>10, Debug go in VIM<br><a href="https://michaelthessel.com/go-vim-debugging-with-gdb/" target="_blank" rel="external">https://michaelthessel.com/go-vim-debugging-with-gdb/</a></p>
<p>Add the following two plugin into plugin vundle position in ~/.vimrc<br>Plugin ‘fatih/vim-go’<br>Plugin ‘vim-scripts/Conque-GDB’</p>
<p>Then run ‘vim +BundleInstall +qall’ to install those plugins</p>
<p>Finally append the following configurations in ~/.vimrc</p>
<p>let g:ConqueTerm_Color = 2<br>let g:ConqueTerm_CloseOnEnd = 1<br>let g:ConqueTerm_StartMessages = 0</p>
<p>function DebugSession()<br>    silent make -o vimgdb -gcflags “-N -l”<br>    redraw!<br>    if (filereadable(“vimgdb”))<br>        ConqueGdb vimgdb<br>    else<br>        echom “Couldn’t find debug file”<br>    endif<br>endfunction<br>function DebugSessionCleanup(term)<br>    if (filereadable(“vimgdb”))<br>        let ds=delete(“vimgdb”)<br>    endif<br>endfunction<br>call conque_term#register_function(“after_close”, “DebugSessionCleanup”)<br>nmap <leader>d :call DebugSession()<cr>;</cr></leader></p>
<p>and run ‘:GoInstallBinaries’ in vim to install some dependencies binarys</p>
<p>Press ,d to start debug, eg:<br>(gdb) b main<br>(gdb) set args -config server.ini -debug<br>(gdb) show args<br>Argument list to give program being debugged when it is started is “-config server.ini -debug”.<br>(gdb) r</p>
<p>注：如果go里有greenthread，那么gdb将无法调试，这时得用Delve (<a href="https://yq.aliyun.com/articles/57578" target="_blank" rel="external">https://yq.aliyun.com/articles/57578</a>), 使用’dlv debug’启动后剩下的命令与gdb同。<br>go get github.com/derekparker/delve/cmd/dlv<br>dlv debug test.go<br>dlv attach existing-pid</p>
<p>11, Debug C/C++ in VIM - ConqueGDB<br><a href="https://gist.github.com/RobinCPC/228eceed32dea10f32e2b3d41ad930c8" target="_blank" rel="external">https://gist.github.com/RobinCPC/228eceed32dea10f32e2b3d41ad930c8</a><br>Compiler your c/c++ code with -g flag. if not, gdb may not find symbol, eg: gcc -g hello.c -o hello<br>Start debug by ‘:ConqueGdbSplit hello’ in VIM</p>
<p>12, Debug Python by pudb<br>sudo pip install pudb<br>from pudb import set_trace; set_trace()<br>Press ‘?’ for hinting</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://github.com/juju/juju/blob/staging/CONTRIBUTING.md" target="_blank" rel="external">https://github.com/juju/juju/blob/staging/CONTRIBUTING.md</a><br>[2] <a href="https://launchpad.net/juju-core" target="_blank" rel="external">https://launchpad.net/juju-core</a><br>[3] <a href="https://blog.labix.org/2013/06/25/the-heart-of-juju" target="_blank" rel="external">https://blog.labix.org/2013/06/25/the-heart-of-juju</a><br>[4] <a href="https://jujucharms.com/community" target="_blank" rel="external">https://jujucharms.com/community</a><br>[5] <a href="https://lists.ubuntu.com/mailman/listinfo/juju" target="_blank" rel="external">https://lists.ubuntu.com/mailman/listinfo/juju</a><br>[6] <a href="https://lists.ubuntu.com/mailman/listinfo/juju-dev" target="_blank" rel="external">https://lists.ubuntu.com/mailman/listinfo/juju-dev</a><br>[7] <a href="https://github.com/juju/juju/tree/staging/doc" target="_blank" rel="external">https://github.com/juju/juju/tree/staging/doc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/06/Set-up-juju-development-env/" data-id="cjllrf72l000bztbpxr4uuf95" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Green-on-T440P-integrated-webcam-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/" class="article-date">
  <time datetime="2018-02-01T08:46:53.000Z" itemprop="datePublished">2018-02-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/">Green on T440P integrated webcam(by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-01)</strong></p>
<p>我发现我的t440p的集成摄像头成绿色像，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@t440p:~# lsusb -d 04f2:b39a -vvv</span><br><span class="line">root@t440p:~# lsusb -d 04f2:b39a</span><br><span class="line">Bus 003 Device 006: ID 04f2:b39a Chicony Electronics Co., Ltd</span><br><span class="line"></span><br><span class="line">root@t440p:~# v4l2-ctl -V -d /dev/video0</span><br><span class="line">Format Video Capture:</span><br><span class="line">	Width/Height      : 1280/720</span><br><span class="line">	Pixel Format      : &apos;MJPG&apos;</span><br><span class="line">	Field             : None</span><br><span class="line">	Bytes per Line    : 0</span><br><span class="line">	Size Image        : 1843200</span><br><span class="line">	Colorspace        : sRGB</span><br><span class="line">	Transfer Function : Default</span><br><span class="line">	YCbCr Encoding    : Default</span><br><span class="line">	Quantization      : Default</span><br><span class="line">	Flags             :</span><br></pre></td></tr></table></figure></p>
<p>最后从这个网页找到了答案 - <a href="https://help.ubuntu.com/community/Webcam/Troubleshooting" target="_blank" rel="external">https://help.ubuntu.com/community/Webcam/Troubleshooting</a></p>
<p>安装guvcview工具，将其中的”White Balance Temperature, Auto”打勾即可。<br><img src="http://img.blog.csdn.net/20180201164449436?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="蓝牙键盘"><a href="#蓝牙键盘" class="headerlink" title="蓝牙键盘"></a>蓝牙键盘</h2><p>蓝牙键盘配对后过一会超时后要重连，但经常重连不上。采用下列方法trust蓝牙之下情况好多了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bluez bluez-tools</span><br><span class="line"></span><br><span class="line">$ bluetoothctl</span><br><span class="line">[NEW] Controller 00:15:00:CB:B0:FF t440p #2 [default]</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">[NEW] Controller 00:1A:7D:DA:71:13 t440p #1</span><br><span class="line"></span><br><span class="line"># First, turn bluetooth power on (if your device is off)</span><br><span class="line">[bluetooth]# power on</span><br><span class="line">Changing power on succeeded</span><br><span class="line"></span><br><span class="line"># Then, make sure your agent is registered:</span><br><span class="line">[bluetooth]# agent on</span><br><span class="line">Agent registered</span><br><span class="line">[bluetooth]# default-agent</span><br><span class="line">Default agent request successful</span><br><span class="line"></span><br><span class="line"># Now you can scan for devices from the console</span><br><span class="line">[bluetooth]# scan on</span><br><span class="line">Discovery started</span><br><span class="line">[CHG] Controller 00:15:00:CB:B0:FF Discovering: yes</span><br><span class="line">...</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># You can manually pair from here as well</span><br><span class="line">[bluetooth]# pairable on</span><br><span class="line">Changing pairable on succeeded</span><br><span class="line">[bluetooth]# pair 90:7F:61:00:23:C3</span><br><span class="line"></span><br><span class="line">[bluetooth]# trust 90:7F:61:00:23:C3</span><br><span class="line">[CHG] Device 90:7F:61:00:23:C3 Trusted: yes</span><br><span class="line">Changing 90:7F:61:00:23:C3 trust succeeded</span><br><span class="line"></span><br><span class="line">[bluetooth]# connect 90:7F:61:00:23:C3</span><br><span class="line">[bluetooth]# quit</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/" data-id="cjllrf71v0000ztbpn40p2unu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Assembly-Language-Learning-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/30/Assembly-Language-Learning-by-Joshua/" class="article-date">
  <time datetime="2018-01-30T04:10:21.000Z" itemprop="datePublished">2018-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/30/Assembly-Language-Learning-by-Joshua/">Assembly Language Learning (by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-01-30)</strong></p>
<h2 id="汇编测试程序"><a href="#汇编测试程序" class="headerlink" title="汇编测试程序"></a>汇编测试程序</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ cat hello.asm </span><br><span class="line">; Hello World9%] [#######################################################################################################] </span><br><span class="line">; Compile asm: nasm -f elf64 -g -F dwarf hello.asm</span><br><span class="line">; Link asm:    ld -o hello hello.o</span><br><span class="line">; Debug asm:   [gdb|cgdb|kdbg] hello </span><br><span class="line">; Debug asm: or using insight, because kdbg can&apos;t see memory well</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">    msg db &apos;Hello, world!&apos;, 0</span><br><span class="line">    msglen: equ $-msg</span><br><span class="line">section .bss</span><br><span class="line">section .text</span><br><span class="line">    global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    nop</span><br><span class="line">    mov eax, 4       ; sys_write sys call</span><br><span class="line">    mov ebx, 1       ; stdout</span><br><span class="line">    mov ecx, msg</span><br><span class="line">    mov edx, msglen</span><br><span class="line">    int 80H</span><br><span class="line">    mov eax, 1       ; exit sys call</span><br><span class="line">    mov ebx, 0       ; return 0</span><br><span class="line">    int 80H         </span><br><span class="line">    mov ebp, esp</span><br></pre></td></tr></table></figure>
<h2 id="编译与链接"><a href="#编译与链接" class="headerlink" title="编译与链接"></a>编译与链接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf64 -g -F dwarf hello.asm</span><br><span class="line">ld -o hello hello.o</span><br></pre></td></tr></table></figure>
<h2 id="用gdb调试"><a href="#用gdb调试" class="headerlink" title="用gdb调试"></a>用gdb调试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ gdb hello</span><br><span class="line">...</span><br><span class="line">(gdb) b 16</span><br><span class="line">Breakpoint 1 at 0x4000b1: file hello.asm, line 16.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /bak/work/asm/hello </span><br><span class="line"></span><br><span class="line">Breakpoint 1, _start () at hello.asm:16</span><br><span class="line">16	    mov eax, 4       ; sys_write sys call</span><br><span class="line">(gdb) n</span><br><span class="line">17	    mov ebx, 1       ; stdout</span><br><span class="line">(gdb) i r eax</span><br><span class="line">eax            0x4	4</span><br><span class="line">(gdb) set $eax=0x4</span><br></pre></td></tr></table></figure>
<h2 id="用cgdb调试"><a href="#用cgdb调试" class="headerlink" title="用cgdb调试"></a>用cgdb调试</h2><p>cgdb能方便调试的过程中查看代码，如下图：<br><img src="http://img.blog.csdn.net/20180130120215608?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用kDbg调试"><a href="#用kDbg调试" class="headerlink" title="用kDbg调试"></a>用kDbg调试</h2><p>kDbg方便查看寄存器，但是查看内存不是很方便。如图：<br><img src="http://img.blog.csdn.net/20180130120334887?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用insight调试"><a href="#用insight调试" class="headerlink" title="用insight调试"></a>用insight调试</h2><p>kDgb不方便查看内存，所以有了insight, insight在ubuntu 16.04上的安装步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install autoconf autogen texinfo zlib1g-dev tcl-dev tk-dev mesa-common-dev libjpeg-dev libtogl-dev python-dev flex bison itcl3 itk3 iwidgets4</span><br><span class="line">git clone --recursive git://sourceware.org/git/insight.git</span><br><span class="line">cd insight &amp;&amp; autoconf</span><br><span class="line">./configure --prefix=/usr/. --libdir=/usr/lib64 --disable-binutils --disable-elfcpp --disable-gas --disable-gold \</span><br><span class="line">--disable-gprof --disable-ld --disable-rpath --disable-zlib --enable-sim --with-gdb-datadir=/usr/share/insight \</span><br><span class="line">--with-jit-reader-dir=/usr/lib64/insight --with-separate-debug-dir=&apos;/usr/lib/debug&apos; --with-expat --with-python --without-libunwind</span><br><span class="line">make -j8 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20180130120523311?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用sasm调试"><a href="#用sasm调试" class="headerlink" title="用sasm调试"></a>用sasm调试</h2><p>sasm的安装方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">axel http://download.opensuse.org/repositories/home:/Dman95/xUbuntu_16.04/amd64/sasm_3.9.0_amd64.deb</span><br><span class="line">sudo dpkg -i sasm_3.9.0_amd64.deb</span><br><span class="line">sudo apt-get -f install</span><br></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20180130120714341?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>注意，使用sasm时，代码一是需要添加’%include “io64.inc”‘，二是_start需要变成CMAIN， 三是自己的代码写在下列代码的”write your code here“处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%include &quot;io64.inc&quot;</span><br><span class="line">section .text</span><br><span class="line">global CMAIN</span><br><span class="line">CMAIN:</span><br><span class="line">    ;write your code here</span><br><span class="line">    xor eax, eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>故完整的测试代码修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ cat hello2.asm </span><br><span class="line">%include &quot;io64.inc&quot;</span><br><span class="line">section .data</span><br><span class="line">    msg db &apos;Hello, world!&apos;, 0</span><br><span class="line">    msglen: equ $-msg</span><br><span class="line">section .bss</span><br><span class="line">section .text</span><br><span class="line">global CMAIN</span><br><span class="line">CMAIN:</span><br><span class="line">    nop</span><br><span class="line">    mov eax, 4       ; sys_write sys call</span><br><span class="line">    mov ebx, 1       ; stdout</span><br><span class="line">    mov ecx, msg</span><br><span class="line">    mov edx, msglen</span><br><span class="line">    int 80H</span><br><span class="line">    mov eax, 1       ; exit sys call</span><br><span class="line">    mov ebx, 0       ; return 0</span><br><span class="line">    int 80H         </span><br><span class="line">    mov ebp, esp</span><br><span class="line">    </span><br><span class="line">    xor eax, eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/30/Assembly-Language-Learning-by-Joshua/" data-id="cjllrf7240004ztbpq8dlisct" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-将声音也输出到耳机-by-joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/25/将声音也输出到耳机-by-joshua/" class="article-date">
  <time datetime="2018-01-25T12:12:26.000Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/25/将声音也输出到耳机-by-joshua/">将声音也输出到耳机(by joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-01-09)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>发现一个问题，在笔记本上使用了pyaudio包的应用在关闭扬声器仅使用耳机的情况下无法将声音送出去。(注：笔记本只有一个口)<br>而使用台式机没这个问题，即使关闭音箱只使用耳机，一样工作正常。(注：台式机是一个声卡，录音与扬声器分别出前面板和后面板，当音响接后面，耳机使用二合一线接前面板，可做到关闭音箱仍然可以从耳机抓取声音。）</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>在ubuntu上安装pulseaudio的前端控制工具pavucontrol (apt install pavucontrol), 然后执行pavucontrol命令后在Playback和Recording菜单上将默认的’Build-in Audio Analog Stereo’修改成别的试试。（注：有声音的时候才会出现相应的菜单内容）<br><img src="http://img.blog.csdn.net/20180125200958974?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="附录一，将喇叭的声音同时从多个声卡输出"><a href="#附录一，将喇叭的声音同时从多个声卡输出" class="headerlink" title="附录一，将喇叭的声音同时从多个声卡输出"></a>附录一，将喇叭的声音同时从多个声卡输出</h2><p>sudo apt-get install paprefs, 然后在paprefs应用中设置simultaneous output，重启（pulseaudio -k), 这时Sound设置中会出出一个虚拟声卡.</p>
<h2 id="附录二，Chrome中设置声音的路径"><a href="#附录二，Chrome中设置声音的路径" class="headerlink" title="附录二，Chrome中设置声音的路径"></a>附录二，Chrome中设置声音的路径</h2><p>chrome://settings/content#media-stream-mic</p>
<h2 id="20180205更新"><a href="#20180205更新" class="headerlink" title="20180205更新"></a>20180205更新</h2><p>今天发现我的hexchat不能声音提示了，原来是在我安装pavucontrol之后这个工具和’System settings -&gt; sound’里设置alert volume的声音是独立的，在pavucontrol将’Playback -&gt; system sounds’设置之后能听到声音提示了。</p>
<h2 id="20180901更新-将笔记本声音输出到手机"><a href="#20180901更新-将笔记本声音输出到手机" class="headerlink" title="20180901更新 - 将笔记本声音输出到手机"></a>20180901更新 - 将笔记本声音输出到手机</h2><p>笔记本只有一个音频输出, 所以需要买一个USB声卡, 这样就有了麦克风输入口和音频输出口. 将这个输出口用一根公对公音频线连接, 另一端接音频一分二线的麦克风输入口, 音频一分二线的公口插手机.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/25/将声音也输出到耳机-by-joshua/" data-id="cjllrf72v000lztbp25slesku" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-virtio-vhost中的限速机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/09/virtio-vhost中的限速机制/" class="article-date">
  <time datetime="2018-01-09T08:00:31.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/09/virtio-vhost中的限速机制/">virtio/vhost中的限速机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-01-09)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>日前遇到这么一个问题，客户反应虚机往外发包时丢包并看到”No buffer space available”相关的错误，虚机是windows虚机，宿主机是ubuntu并采用vhost-net机制。</p>
<h2 id="systemtap"><a href="#systemtap" class="headerlink" title="systemtap"></a>systemtap</h2><p>刚开始我们怀疑是这两个patches导致的问题：<br><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/vhost?id=8d65843c44269c21e95c98090d9bb4848d473853" target="_blank" rel="external">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/vhost?id=8d65843c44269c21e95c98090d9bb4848d473853</a><br><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/vhost?id=809ecb9bca6a9424ccd392d67e368160f8b76c92" target="_blank" rel="external">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/vhost?id=809ecb9bca6a9424ccd392d67e368160f8b76c92</a></p>
<p>所以写了个systemtap脚本在宿主机监控vhost模块中的vhost_signal函数将vring的相关信息打印如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RX 0 values: old=34264 new=34264 last_used_event=34263 vring_used=0 vring_avail=0</span><br><span class="line">TX 6297677760 values: old=30401 new=30402 last_used_event=0 vring_used=30402 vring_avail=30402</span><br><span class="line"></span><br><span class="line">RX 0 values: old=34264 new=34264 last_used_event=34263 vring_used=0 vring_avail=0</span><br><span class="line">TX 6297677760 values: old=30403 new=30404 last_used_event=0 vring_used=30404 vring_avail=30404</span><br></pre></td></tr></table></figure></p>
<p>根据打印的值，我们算出下面两个公式的结果均为False (<a href="https://github.com/torvalds/linux/blob/v4.10/drivers/vhost/vhost.c#L2189" target="_blank" rel="external">https://github.com/torvalds/linux/blob/v4.10/drivers/vhost/vhost.c#L2189</a> )。<br>vring_need_event(vq-&gt;last_used_event, new + vq-&gt;num, new)<br>vring_need_event(vq-&gt;last_used_event, new, old)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TX 34936796160 values: old=7077 new=7077 last_used_event=0 vring_used=7077 vring_avail=7077 </span><br><span class="line">1. False: (7077 + 256) - 0 - 1 &lt; (7077 + 256) - 7077 </span><br><span class="line">2. False: 7077 - 0 - 1 &lt; 7077 - 7077</span><br></pre></td></tr></table></figure>
<p>上面为False的话，vhost_notify()就为False，那样vhost也不会调用eventfd_signal通过中断向guest发通知(<a href="https://github.com/torvalds/linux/blob/v4.10/drivers/vhost/vhost.c#L2211" target="_blank" rel="external">https://github.com/torvalds/linux/blob/v4.10/drivers/vhost/vhost.c#L2211</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void vhost_signal(struct vhost_dev *dev, struct vhost_virtqueue *vq)</span><br><span class="line">&#123;</span><br><span class="line">	/* Signal the Guest tell them we used something up. */</span><br><span class="line">	if (vq-&gt;call_ctx &amp;&amp; vhost_notify(dev, vq))</span><br><span class="line">		eventfd_signal(vq-&gt;call_ctx, 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="理论分析"><a href="#理论分析" class="headerlink" title="理论分析"></a>理论分析</h2><ul>
<li>Guest发数据：guest将发送报文Buffer的head index加入avial_ring中， 在合适的时间点通过ioeventfds消息来通知backend。backend发完报文后再将其加入到used_ring中，并在一个合适的时间点来通过irqdfs中断来通知guest。</li>
<li>Guest收数据：两个queue都需要guest填充buffer, guest将空白Buffer的head index加入avail_ring中，在合适的时间点通过ioeventfds消息来通知backend。backend收完报文后再将其加入到used_ring中，并在一个合适的时间点来通过irqdfs中断来通知guest。</li>
<li>Flags, avail_ring与used_ring中都有flags字段，例如avail_ring中的flags字段代表guest告诉host在host发完报文之后是否需要通知guest。<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2>在打开VIRTIO_RING_F_EVENT_IDX特性之后，virtio/vhost将不再依据flags来决定是否向对方发送消息(guest到host根据消息通知，host到guest通过中断)，而是guest/host在发送一批报文后(flags是每个包发送性能较差)自行决定是否向对方发消息。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/* The standard layout for the ring is a continuous chunk of memory which looks</span><br><span class="line"> * like this.  We assume num is a power of 2.</span><br><span class="line"> *</span><br><span class="line"> * struct vring</span><br><span class="line"> * &#123;</span><br><span class="line"> *	// The actual descriptors (16 bytes each)</span><br><span class="line"> *	struct vring_desc desc[num];</span><br><span class="line"> *</span><br><span class="line"> *	// A ring of available descriptor heads with free-running index.</span><br><span class="line"> *	__virtio16 avail_flags;</span><br><span class="line"> *	__virtio16 avail_idx;</span><br><span class="line"> *	__virtio16 available[num];</span><br><span class="line"> *	__virtio16 used_event_idx;</span><br><span class="line"> *</span><br><span class="line"> *	// Padding to the next align boundary.</span><br><span class="line"> *	char pad[];</span><br><span class="line"> *</span><br><span class="line"> *	// A ring of used descriptor heads with free-running index.</span><br><span class="line"> *	__virtio16 used_flags;</span><br><span class="line"> *	__virtio16 used_idx;</span><br><span class="line"> *	struct vring_used_elem used[num];</span><br><span class="line"> *	__virtio16 avail_event_idx;</span><br><span class="line"> * &#125;;</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>此时，在数据结构方面，在used_ring中有avail_event_idx字段，在avail_ring中有used_event_idx字段，用下列方法相互填充。如：vring_avail_event(&amp;vq-&gt;vring)用于将avail_ring中的index填充到used_ring的最后一个字段used_event_idx中去，反之亦然。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* We publish the used event index at the end of the available ring, and vice</span><br><span class="line"> * versa. They are at the end for backwards compatibility. */</span><br><span class="line">#define vring_used_event(vr) ((vr)-&gt;avail-&gt;ring[(vr)-&gt;num])</span><br><span class="line">#define vring_avail_event(vr) (*(__virtio16 *)&amp;(vr)-&gt;used-&gt;ring[(vr)-&gt;num])</span><br></pre></td></tr></table></figure></p>
<p>1, guest端virtio驱动, 根据vring_need_event()公式，guest在发送缓冲区满了之后才kick消息给host.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/torvalds/linux/blob/v4.10/drivers/virtio/virtio_ring.c#L547</span><br><span class="line"></span><br><span class="line">bool virtqueue_kick_prepare(struct virtqueue *_vq)&#123;</span><br><span class="line">	old = vq-&gt;avail_idx_shadow - vq-&gt;num_added;</span><br><span class="line">	new = vq-&gt;avail_idx_shadow;</span><br><span class="line">	vq-&gt;num_added = 0;</span><br><span class="line">        ...</span><br><span class="line">	if (vq-&gt;event) &#123;</span><br><span class="line">		needs_kick = vring_need_event(virtio16_to_cpu(_vq-&gt;vdev, vring_avail_event(&amp;vq-&gt;vring)),</span><br><span class="line">					      new, old);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		needs_kick = !(vq-&gt;vring.used-&gt;flags &amp; cpu_to_virtio16(_vq-&gt;vdev, VRING_USED_F_NO_NOTIFY));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">vq-&gt;event = virtio_has_feature(vdev, VIRTIO_RING_F_EVENT_IDX);</span><br><span class="line"></span><br><span class="line">static inline int vring_need_event(__u16 event_idx, __u16 new_idx, __u16 old)</span><br><span class="line">&#123;</span><br><span class="line">	return (__u16)(new_idx - event_idx - 1) &lt; (__u16)(new_idx - old);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct vring_virtqueue &#123;</span><br><span class="line">	/* Last written value to avail-&gt;idx in guest byte order */</span><br><span class="line">	u16 avail_idx_shadow;</span><br><span class="line">	/* Head of free buffer list. */</span><br><span class="line">	unsigned int free_head;</span><br></pre></td></tr></table></figure></p>
<p>注： vring_need_event的公式(return (<strong>u16)(new_idx - event_idx - 1) &lt; (</strong>u16)(new_idx - old);)实际是一种限速，new指针在前, old指标在后，如果：</p>
<ul>
<li>如果event_idx也就是avail.idx的位置超过了old， vring_need_event=True, 表示后端处理的快(<strong>event_idx是后端通知给前端处理的索引值</strong>)，此时guest将发通知给host请它继续处理。</li>
<li>如果event_idx在old之前，vring_need_event=False, <strong>说明后端处理的慢</strong>，此时guest不会向host发通知。</li>
</ul>
<p>2, guest端virtio驱动是如何发包的呢？ xmit_skb会高用virtqueue_add_outbuf最终会调用virtqueue_add, 设置完ring的相关字段之后最后调virtqueue_kick<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">static int xmit_skb(struct send_queue *sq, struct sk_buff *skb)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">   return virtqueue_add_outbuf(sq-&gt;vq, sq-&gt;sg, num_sg, skb, GFP_ATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline int virtqueue_add(struct virtqueue *_vq,</span><br><span class="line">				struct scatterlist *sgs[],</span><br><span class="line">				unsigned int total_sg,</span><br><span class="line">				unsigned int out_sgs,</span><br><span class="line">				unsigned int in_sgs,</span><br><span class="line">				void *data,</span><br><span class="line">				gfp_t gfp)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">	head = vq-&gt;free_head;</span><br><span class="line">	/* Put entry in available array (but don&apos;t update avail-&gt;idx until they</span><br><span class="line">	 * do sync). */</span><br><span class="line">	avail = vq-&gt;avail_idx_shadow &amp; (vq-&gt;vring.num - 1);</span><br><span class="line">	vq-&gt;vring.avail-&gt;ring[avail] = cpu_to_virtio16(_vq-&gt;vdev, head);</span><br><span class="line"></span><br><span class="line">	/* Descriptors and available array need to be set before we expose the</span><br><span class="line">	 * new available array entries. */</span><br><span class="line">	virtio_wmb(vq-&gt;weak_barriers);</span><br><span class="line">	vq-&gt;avail_idx_shadow++;</span><br><span class="line">	vq-&gt;vring.avail-&gt;idx = cpu_to_virtio16(_vq-&gt;vdev, vq-&gt;avail_idx_shadow);</span><br><span class="line">	vq-&gt;num_added++;</span><br><span class="line"></span><br><span class="line">	pr_debug(&quot;Added buffer head %i to %p\n&quot;, head, vq);</span><br><span class="line">	END_USE(vq);</span><br><span class="line"></span><br><span class="line">	/* This is very unlikely, but theoretically possible.  Kick</span><br><span class="line">	 * just in case. */</span><br><span class="line">	if (unlikely(vq-&gt;num_added == (1 &lt;&lt; 16) - 1))</span><br><span class="line">		virtqueue_kick(_vq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>从上面的代码分析中我们已经完成能够确定:<br>1, vhost后端没有给guest通过中断通知event_idx(avail_idx)值。<br>2，virtio前端也在根据vring_need_event的公式(return (<strong>u16)(new_idx - event_idx - 1) &lt; (</strong>u16)(new_idx - old);)决定是否向vhost后端kick消息时， 由于event_idx在old的前面，vring_need_event值为False，所以前端就不会给后端发消息。这样前端就会丢包，所以前端也会看到“No buffer space available”之类的错误。通过上面的代码分析，我们也知道了造成这个的原因是因为后端发送的比前端慢。在检查宿主机的syslog后，发现了大量的MTU相关的日志”br-int: dropped over-mtu packet: 1500 &gt; 1458”。OK，问题就在这里了，虚机里需要设置合适的MTU值，如sudo ip link set eth0 mtu 1400</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/09/virtio-vhost中的限速机制/" data-id="cjllrf72q000fztbpcz5yk83n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenStack-s-multiattach-Feature" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/22/OpenStack-s-multiattach-Feature/" class="article-date">
  <time datetime="2017-12-22T05:31:50.000Z" itemprop="datePublished">2017-12-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/22/OpenStack-s-multiattach-Feature/">OpenStack&#39;s multiattach Feature</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>作者：张华  发表于：2017-12-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="什么是multiattach特性"><a href="#什么是multiattach特性" class="headerlink" title="什么是multiattach特性"></a>什么是multiattach特性</h2><p>OpenStack’s multiattach Feature允许一个read only volume经iscsi/FC被attached到多个VM。</p>
<h2 id="代码实现原理"><a href="#代码实现原理" class="headerlink" title="代码实现原理"></a>代码实现原理</h2><ul>
<li>用户首先通过cinder定义一个shareable标志的volume.</li>
<li>在attach的时候，nova需要修改即使在in-use状态下仍然可以attach, nova为每一个attachment指定read-write或者read-only, cinder端修改在available和in-use状态下仍然可attach，multiattach标志设置可以被attach多次。attach之后将volume和instance的关系记录到attachment表中。libvirt端需要将这个volume设置shareable标, 这样hypervisor将不会在volume上设置独占锁及相关针对vm的SELinux隔离设置。</li>
<li>在detach的时候，nova需要传递attachment_id到clinderclient告诉cinder哪个attahment需要detach, 然后cinder结合instance_id与attachment_id做detach。如果cinder设置了multiattach标志又没有传attachment_id(os-detach-&gt;attachment_id)过来应该失败。</li>
</ul>
<p>数据表设计：<br>volume_attachment(id, volume_id, attached_host, instance_uuid, mountpoint, attach_time, attach_mode, sttach_status, time)</p>
<p>代码实现：<br>1, cinder side<br>   <a href="https://review.openstack.org/#/c/85847/" target="_blank" rel="external">https://review.openstack.org/#/c/85847/</a><br>2, cinderclient side<br>   <a href="https://review.openstack.org/#/c/85856/" target="_blank" rel="external">https://review.openstack.org/#/c/85856/</a><br>3, nova side<br>   <a href="https://review.openstack.org/#/c/526182/" target="_blank" rel="external">https://review.openstack.org/#/c/526182/</a><br>   <a href="https://review.openstack.org/#/c/525787/" target="_blank" rel="external">https://review.openstack.org/#/c/525787/</a><br>   <a href="https://review.openstack.org/#/c/330285/" target="_blank" rel="external">https://review.openstack.org/#/c/330285/</a><br>   <a href="https://review.openstack.org/#/c/527468/" target="_blank" rel="external">https://review.openstack.org/#/c/527468/</a>  </p>
<p>CLI如何使用：<br>openstack volume create –size 1 –multi-attach multi_attach_test</p>
<h2 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h2><p>RDB驱动不支持multiattach - <a href="https://review.openstack.org/#/c/283695/" target="_blank" rel="external">https://review.openstack.org/#/c/283695/</a>, 关于它的讨论 - <a href="https://openstack.nimeyo.com/103230/openstack-dev-multi-attach-volume-for-rbd，但根据这个说法（https://bugs.launchpad.net/cinder/+bug/1535815/comments/6）似乎用这个特性是安全的。" target="_blank" rel="external">https://openstack.nimeyo.com/103230/openstack-dev-multi-attach-volume-for-rbd，但根据这个说法（https://bugs.launchpad.net/cinder/+bug/1535815/comments/6）似乎用这个特性是安全的。</a></p>
<h2 id="容器虚机通过multiattach特性使用同一个存储卷"><a href="#容器虚机通过multiattach特性使用同一个存储卷" class="headerlink" title="容器虚机通过multiattach特性使用同一个存储卷"></a>容器虚机通过multiattach特性使用同一个存储卷</h2><p>我们知道Docker容器本身是无状态的，意味着容器退出后不会保存任何数据。但实际使用场景，肯定是需要保存业务数据的，Docker通过volume实现数据的持久化存储以及共享。Docker有很多种使用OpenStack Cinder的驱动：</p>
<ul>
<li>Docker Cinder Driver - <a href="https://github.com/j-griffith/cinder-docker-driver" target="_blank" rel="external">https://github.com/j-griffith/cinder-docker-driver</a>, 如何使用见<a href="http://superuser.openstack.org/articles/how-to-use-openstack-cinder-for-docker/与http://superuser.openstack.org/articles/how-to-use-cinder-with-swarm/" target="_blank" rel="external">http://superuser.openstack.org/articles/how-to-use-openstack-cinder-for-docker/与http://superuser.openstack.org/articles/how-to-use-cinder-with-swarm/</a></li>
<li>OpenStack Fuxi - 华为主导的OpenStack官方工程，让Docker容器使用Cinder和Manila - <a href="https://docs.openstack.org/fuxi/latest/readme.html" target="_blank" rel="external">https://docs.openstack.org/fuxi/latest/readme.html</a></li>
<li>Flocker - 是一款针对容器的存储方案</li>
<li>REX-Ray - 也是一款进一步封装之后针对容器的存储方案 - rexray/cinder驱动(<a href="https://rexray.readthedocs.io/en/stable/user-guide/schedulers/docker/plug-ins/)实现了Docker的provider.Provider存储Plugin接口，rexray/cinder最终通过rexray的cinder驱动去挂载cinder" target="_blank" rel="external">https://rexray.readthedocs.io/en/stable/user-guide/schedulers/docker/plug-ins/)实现了Docker的provider.Provider存储Plugin接口，rexray/cinder最终通过rexray的cinder驱动去挂载cinder</a> volume (<a href="https://github.com/thecodeteam/rexray/blob/master/libstorage/drivers/storage/cinder/storage/cinder_storage.go)。" target="_blank" rel="external">https://github.com/thecodeteam/rexray/blob/master/libstorage/drivers/storage/cinder/storage/cinder_storage.go)。</a></li>
</ul>
<p>什么是REX-Ray:</p>
<ul>
<li>REX-Ray是一个开源的存储编排引擎(<a href="http://blog.daocloud.io/swarm-emc/" target="_blank" rel="external">http://blog.daocloud.io/swarm-emc/</a>), 进一步封装整合了不同的存储如Ceph, Cinder, EBS等，来主要为Docker, Mesos等容器来提供持续的存储访问, 似乎没有看到REX-Ray下挂到OpenStack Cinder的驱动（见: <a href="https://rexray.readthedocs.io/en/stable/）。" target="_blank" rel="external">https://rexray.readthedocs.io/en/stable/）。</a></li>
<li>REX-Ray下可以直接挂ceph驱动, 见：<a href="http://www.stillhq.com/docker/000001.html和https://blog.thecodeteam.com/2017/01/27/rexray-ceph/" target="_blank" rel="external">http://www.stillhq.com/docker/000001.html和https://blog.thecodeteam.com/2017/01/27/rexray-ceph/</a></li>
<li>REX-Ray下也可以挂cinder驱动，然后通过cinder ceph驱动来支持ceph。见：<a href="https://github.com/thecodeteam/rexray/blob/master/libstorage/drivers/storage/cinder/storage/cinder_storage.go" target="_blank" rel="external">https://github.com/thecodeteam/rexray/blob/master/libstorage/drivers/storage/cinder/storage/cinder_storage.go</a></li>
</ul>
<p>Cinder不仅是给nova用的，也可以绕开nova单独使用，见<a href="https://specs.openstack.org/openstack/cinder-specs/specs/mitaka/use-cinder-without-nova.html" target="_blank" rel="external">https://specs.openstack.org/openstack/cinder-specs/specs/mitaka/use-cinder-without-nova.html</a> ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cinder local-attach [--mountpoint /mnt/disk] [--multipath True] [--enforce-multipath True] [--mode rw] &lt;volume_id&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果通过rexray/cinder让Docker容器使用了cinder ceph volume的话，如果这个volume是有状态需要需要在容器和虚机间共享的话，这个volume也可以通过上面说的nova multiattach特性给nova instance使用的， 还可以使用这个特性’cinder local-attach’特性给non-nova instance使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/22/OpenStack-s-multiattach-Feature/" data-id="cjllrf7220002ztbpt47o4gfz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-如何修改网卡名称由enp0s25为eth0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/06/如何修改网卡名称由enp0s25为eth0/" class="article-date">
  <time datetime="2017-12-06T04:07:47.000Z" itemprop="datePublished">2017-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/06/如何修改网卡名称由enp0s25为eth0/">如何修改网卡名称由enp0s25为eth0</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>今天用下列配置创建测试用的VLAN网卡，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y vlan</span><br><span class="line">sudo modprobe 8021q</span><br><span class="line"></span><br><span class="line">auto enp0s25.1</span><br><span class="line">iface enp0s25.1 inet static</span><br><span class="line">    address 10.12.1.1/24</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    network 10.12.1.0/24</span><br><span class="line">    broadcast 10.12.1.255</span><br><span class="line">    mtu 1492</span><br><span class="line"></span><br><span class="line">sudo ifup enp0s25.1</span><br></pre></td></tr></table></figure></p>
<p>但是失败，报下列错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dec  6 08:54:50 localhost ifup[29785]: Cannot find device &quot;enp0s25.1&quot;</span><br><span class="line">Dec  6 08:54:50 localhost ifup[29785]: Failed to bring up enp0s25.1.</span><br></pre></td></tr></table></figure></p>
<p>原因是需要将enp0s25改为eth0。在谷歌上搜索一百篇文章起码有九十九篇都说要修改70-persistent-net.rules文件，但是照着改了就是不成功，那是怎么一回事呢？</p>
<h2 id="enp0s25代表什么"><a href="#enp0s25代表什么" class="headerlink" title="enp0s25代表什么"></a>enp0s25代表什么</h2><p>根据systemd中udev的代码(<a href="https://github.com/systemd/systemd/blob/master/src/udev/udev-builtin-net_id.c#L20" target="_blank" rel="external">https://github.com/systemd/systemd/blob/master/src/udev/udev-builtin-net_id.c#L20</a> ), enp0s25 意为: en:ethernet, p0:bus_num=0, s25:slot_num=25<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@t440p:~# lspci |grep Ethernet</span><br><span class="line">00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-LM (rev 04) </span><br><span class="line"></span><br><span class="line">root@t440p:~# lspci -n -s 00:19.0</span><br><span class="line">00:19.0 0200: 8086:153a (rev 04)</span><br><span class="line"></span><br><span class="line">root@t440p:~# find /sys/devices -type d -wholename &apos;/sys/devices/pci*/net&apos; -print</span><br><span class="line">/sys/devices/pci0000:00/0000:00:19.0/net</span><br><span class="line">/sys/devices/pci0000:00/0000:00:1c.1/0000:04:00.0/net</span><br><span class="line">/sys/devices/pci0000:00/0000:00:14.0/usb3/3-3/3-3:1.0/net</span><br><span class="line"></span><br><span class="line">hua@t440p:~$ sudo udevadm info /sys/class/net/enp0s25 |grep DEVPATH</span><br><span class="line">E: DEVPATH=/devices/pci0000:00/0000:00:19.0/net/enp0s25</span><br></pre></td></tr></table></figure></p>
<h2 id="方法一，修改70-persistent-net-rules"><a href="#方法一，修改70-persistent-net-rules" class="headerlink" title="方法一，修改70-persistent-net.rules"></a>方法一，修改70-persistent-net.rules</h2><p>修改/etc/udev/rules.d/70-persistent-net.rules文件如下内容(注：ubuntu 16.04上由systemd.link管理默认无此文件，直接添加即可，并将如下ATTR{address}改为网卡的MAC地址，其他不变）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;address&#125;==&quot;28:d2:44:52:31:1d&quot;, ATTR&#123;dev_id&#125;==&quot;0x0&quot;, ATTR&#123;type&#125;==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>但这样修改后并不生效，原因是动了udev的文件需要下列命令更新initrd</strong>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br></pre></td></tr></table></figure></p>
<p>将上面配置改为下面的内容也行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;dev_id&#125;==&quot;0x0&quot;, ATTR&#123;type&#125;==&quot;1&quot;, KERNELS==&quot;0000:00:19.0&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;</span><br></pre></td></tr></table></figure>
<p>该配置可直接运行这段脚本生成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scansys() &#123;</span><br><span class="line">    find /sys/devices -type d -wholename &apos;/sys/devices/pci*/net&apos; -print</span><br><span class="line">&#125;</span><br><span class="line">extract() &#123;</span><br><span class="line">    awk -F/ &apos;&#123;printf &quot;%s eth%u\n&quot;,$(NF-1),NR-1;&#125;&apos;</span><br><span class="line">&#125;</span><br><span class="line">generate() &#123;</span><br><span class="line">    echo &apos;# these rules are for persistence based on bus device address&apos;</span><br><span class="line">    awk &apos;&#123;printf &quot;SUBSYSTEM==\&quot;net\&quot;, ACTION==\&quot;add\&quot;, DRIVERS==\&quot;?*\&quot;, ATTR&#123;dev_id&#125;==\&quot;0x0\&quot;, ATTR&#123;type&#125;==\&quot;1\&quot;, KERNELS==\&quot;%s\&quot;, KERNEL==\&quot;eth*\&quot;, NAME=\&quot;%s\&quot;\n&quot;,$1,$2;&#125;&apos;</span><br><span class="line">&#125;</span><br><span class="line">scansys | extract | sort | generate</span><br></pre></td></tr></table></figure></p>
<p>一般地，上面方法就会成功，至少我成功了，如果你重启机器后还不成功，可以考虑如下方法去Disable the Predictable Network Interface Names，见：<a href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/" target="_blank" rel="external">https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /lib/udev/rules.d/80-net-setup-link.rules /bak/bin/</span><br><span class="line">ln -s /dev/null /lib/udev/rules.d/80-net-setup-link.rules  #Disable the Predictable Network Interface Names</span><br></pre></td></tr></table></figure></p>
<h2 id="方法二，使用systemd’s-systemd-link"><a href="#方法二，使用systemd’s-systemd-link" class="headerlink" title="方法二，使用systemd’s systemd.link"></a>方法二，使用systemd’s systemd.link</h2><p>修改文件/etc/systemd/network/10-internet.link添加如下内容后重启机器即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Match]</span><br><span class="line">MACAddress=28:d2:44:52:31:1d</span><br><span class="line">[Link]</span><br><span class="line">Name=eth0</span><br></pre></td></tr></table></figure></p>
<p>但参考该网页 (<a href="http://manpages.ubuntu.com/manpages/zesty/man5/systemd.link.5.html)做如下配置却不成功：" target="_blank" rel="external">http://manpages.ubuntu.com/manpages/zesty/man5/systemd.link.5.html)做如下配置却不成功：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Match]</span><br><span class="line">Path=pci-0000:0000:19.0-*</span><br><span class="line">[Link]</span><br><span class="line">Name=eth0</span><br></pre></td></tr></table></figure></p>
<h2 id="方法三，修改grub的方式"><a href="#方法三，修改grub的方式" class="headerlink" title="方法三，修改grub的方式"></a>方法三，修改grub的方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash net.ifnames=0&quot;</span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/06/如何修改网卡名称由enp0s25为eth0/" data-id="cjllrf732000sztbpk4w72or9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-三种方式使用vlan" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/06/三种方式使用vlan/" class="article-date">
  <time datetime="2017-12-06T03:47:59.000Z" itemprop="datePublished">2017-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/06/三种方式使用vlan/">三种方式使用vlan</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：张华  发表于：2016-04-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</p>
<p>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>Use OVS port in QEMU</p>
<p>sudo apt-get install qemu-system qemu-kvm virtinst libvirt-bin openvswitch-datapath-source openvswitch-controller openvswitch-switch virt-top virt-manager Python-libvirt</p>
<p>sudo ovs-vsctl add-br br-mano<br>sudo ovs-vsctl add-port br-mano eth2</p>
<p>sudo virsh net-destroy default<br>sudo virsh net-define /tmp/br-mano.xml</p>
<p><network><br>  <name>br-mano</name><br>  <forward mode="bridge"><br>  <bridge name="br-mano"><br>  <virtualport type="openvswitch"><br></virtualport></bridge></forward></network></p>
<p>#sudo virsh net-undefine default<br>sudo virsh net-start br-mano<br>sudo virsh net-autostart br-mano</p>
<p>Linux Bridge VLAN</p>
<p>sudo modprobe 8021q<br>sudo ip link add link eth1 name eth1.2 type vlan id 2</p>
<p>#sudo vconfig add eth1 2</p>
<p>#sudo ifconfig eth1.2 down</p>
<p>#sudo vconfig rem eth1.2<br>sudo ip link set eth1.2 up<br>sudo brctl addbr br2<br>sudo brctl setfd br2 0<br>sudo brctl stp br2 on<br>sudo ip link set br2 up<br>sudo brctl addif br2 eth1.2<br>sudo ifconfig br2 192.168.9.122/24<br>sudo ip tuntap add gw2 mode tap<br>sudo ip link set gw2 up<br>sudo brctl addif br2 gw2<br>hua@node1:~$ ip -d link show eth1.2<br>22: eth1.2@eth1: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue master br2 state UP mode DEFAULT group default qlen 1000<br>    link/ether 2c:53:4a:02:20:3c brd ff:ff:ff:ff:ff:ff promiscuity 1<br>    vlan protocol 802.1Q id 2 <reorder_hdr></reorder_hdr></broadcast,multicast,up,lower_up></p>
<p>可用如下方法定义VLAN</p>
<p>auto eth0.2<br>iface eth0.2 inet static<br>    address 10.12.2.2/24<br>    netmask 255.255.255.0<br>    network 10.12.2.0/24<br>    broadcast 10.12.2.255</p>
<p>如果失败，先确保安装了vlan包 （sudo apt install -y vlan），并且启用了vlan模块（sudo modprobe 8021q）， 如果还报下列错的话是因为需要将网卡名改成规范的eth0之类的。</p>
<p>Dec  6 08:54:50 localhost ifup[29785]: Cannot find device “enp0s25.2”<br>Dec  6 08:54:50 localhost ifup[29785]: Failed to bring up enp0s25.2.<br>OVS Bridge VLAN</p>
<p>sudo ovs-vsctl add-br br-veth0<br>sudo ovs-vsctl add-port br-veth0 eth1<br>sudo ip link add veth0 type veth peer name veth1<br>sudo ovs-vsctl add-port br-veth0 veth0<br>sudo ovs-vsctl add-port br-mano veth1<br>sudo ip link set veth0 up<br>sudo ip link set veth1 up</p>
<p>#sudo ovs-vsctl add-port br-veth0 veth0 – set Interface veth0 type=patch options:peer=veth1</p>
<p>#sudo ovs-vsctl add-port br-mano veth1 – set Interface veth1 type=patch options:peer=veth0</p>
<p>#sudo ovs-vsctl del-port br-mano veth1</p>
<p>#sudo ovs-vsctl del-port br-veth0 veth0</p>
<p>#Create ACCESS VLAN:<br>sudo ovs-vsctl set port vnet0 tag=2</p>
<p>#sudo ovs-vsctl remove port vnet0 tag 2</p>
<p>#Enable both ACCESS VLAN as well as TRUNK VLAN:<br>sudo ovs-vsctl set port vnet0 vlan_mode=trunk trunks=2 #access, native-tagged, native-untagged, trunk</p>
<p>#sudo ovs-vsctl set port eth2 vlan_mode=access trunks=[]</p>
<p>Verify VLAN</p>
<p>Inside VM: ping 10.0.3.1 -I eth0</p>
<p>sudo  tcpdump -i eth1  -e -n ‘arp or icmp’ and src host 10.0.3.1</p>
<p>listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes<br>11:38:20.754894 52:54:00:f2:17:37 &gt; ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 2, p 0, ethertype ARP, Request who-has 10.0.3.1 tell 10.0.3.2, length 28<br>Conclusion</p>
<p>OVS Bridge br-mano上的VM无论是采用在VM里打Tag还是在br-mano vnet0处打Tag后的vlan流量能到达eth1(vlan数据只在物理网卡上能使用tcpdump看到），但无法到达同一机器上linux bridge br2上的eth1.2，反之亦然</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/06/三种方式使用vlan/" data-id="cjllrf72r000gztbpgrskk4b9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenWRT与QNAP上通过PXE安装Xenial" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/02/OpenWRT与QNAP上通过PXE安装Xenial/" class="article-date">
  <time datetime="2017-12-02T12:04:42.000Z" itemprop="datePublished">2017-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/02/OpenWRT与QNAP上通过PXE安装Xenial/">OpenWRT与QNAP上通过PXE安装Xenial</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>本文将打开OpenWRT dnsmasq上的PXE支持并设置和QNAP上的tftp关联，然后根据preseed自动安装Ubuntu 16.04 (注：kickstart是Redhat用于自动安装的机制）。</p>
<h2 id="Set-up-tftp-on-QNAP"><a href="#Set-up-tftp-on-QNAP" class="headerlink" title="Set up tftp on QNAP"></a>Set up tftp on QNAP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: We need to configure PXE dir and authority to /Public/tftpboot in QNPA GUI, then use &apos;tftp 192.168.99.122&apos; to test</span><br><span class="line"># /etc/init.d/opentftp.sh restart</span><br><span class="line"># [/share/HDA_DATA/Public/tftpboot] # ps |grep tftp</span><br><span class="line"># 15861 admin      1016 S   /usr/sbin/opentftpd -i /etc/opentftpd.ini -l /share/HDA_DATA/Public/tftpboot/opentftpd.log</span><br><span class="line">sudo mount -o loop /bak/images/ubuntu-16.04.2-server-amd64.iso /mnt/</span><br><span class="line">mkdir /tmp/tftpboot &amp;&amp; sudo cp -r /mnt/install/netboot/* /tmp/tftpboot/</span><br><span class="line">sudo bash -c &apos;cat &gt; /tmp/tftpboot/pxelinux.cfg/default &lt;&lt; EOF</span><br><span class="line">default linux </span><br><span class="line">label linux</span><br><span class="line">    kernel ubuntu-installer/amd64/linux</span><br><span class="line">    append vga=normal initrd=ubuntu-installer/amd64/initrd.gz --</span><br><span class="line">EOF&apos;</span><br><span class="line">scp -r /tmp/tftpboot/* admin@192.168.99.122:/share/HDA_DATA/Public/tftpboot/</span><br></pre></td></tr></table></figure>
<h2 id="Configure-dnsmasq-on-OpenWRT-to-use-external-tftp-server"><a href="#Configure-dnsmasq-on-OpenWRT-to-use-external-tftp-server" class="headerlink" title="Configure dnsmasq on OpenWRT to use external tftp server"></a>Configure dnsmasq on OpenWRT to use external tftp server</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/dnsmasq.conf &lt;&lt; EOF</span><br><span class="line">enable-tftp</span><br><span class="line">dhcp-boot=pxelinux.0,pxeboot,192.168.99.122</span><br><span class="line">EOF</span><br><span class="line">/etc/init.d/dnsmasq restart</span><br></pre></td></tr></table></figure>
<h2 id="Create-Preseed-file-on-QNAP"><a href="#Create-Preseed-file-on-QNAP" class="headerlink" title="Create Preseed file on QNAP"></a>Create Preseed file on QNAP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /home/httpd/ubuntu-auto.seed &lt;&lt; EOF</span><br><span class="line">##https://help.ubuntu.com/16.04/installation-guide/example-preseed.txt</span><br><span class="line">##https://gist.github.com/eldondev/33366c2842df9d1b4a0e</span><br><span class="line">## Options to set on the command line</span><br><span class="line">d-i debian-installer/locale string en_US.UTF-8</span><br><span class="line">d-i console-setup/ask_detect boolean false</span><br><span class="line">d-i console-setup/layout string us</span><br><span class="line"></span><br><span class="line">d-i netcfg/get_hostname string ubuntu</span><br><span class="line">d-i netcfg/get_domain string local</span><br><span class="line"></span><br><span class="line">### Clock and time zone setup</span><br><span class="line">d-i time/zone string UTC</span><br><span class="line">d-i clock-setup/utc boolean true</span><br><span class="line">d-i clock-setup/ntp boolean false</span><br><span class="line"></span><br><span class="line">d-i kbd-chooser/method select us</span><br><span class="line"></span><br><span class="line">d-i mirror/country string manual</span><br><span class="line">d-i mirror/http/hostname string nova.clouds.archive.ubuntu.com</span><br><span class="line">d-i mirror/http/directory string /ubuntu</span><br><span class="line">d-i mirror/http/proxy string</span><br><span class="line"></span><br><span class="line">d-i partman-auto/choose_recipe select root</span><br><span class="line">d-i partman-auto/disk string /dev/[sv]da</span><br><span class="line">d-i partman-auto/method string regular</span><br><span class="line">d-i partman-auto/expert_recipe string root :: \</span><br><span class="line">500 10000 1000000 ext4 \</span><br><span class="line">          $primary&#123; &#125; \</span><br><span class="line">          $bootable&#123; &#125; \</span><br><span class="line">          method&#123; format &#125; \</span><br><span class="line">          format&#123; &#125; \</span><br><span class="line">          use_filesystem&#123; &#125; \</span><br><span class="line">          filesystem&#123; ext4 &#125; \</span><br><span class="line">          mountpoint&#123; / &#125; .</span><br><span class="line"></span><br><span class="line">d-i partman-basicfilesystems/no_swap boolean false</span><br><span class="line">d-i partman-partitioning/confirm_write_new_label boolean true</span><br><span class="line">d-i partman/choose_partition select finish</span><br><span class="line">d-i partman/confirm boolean true</span><br><span class="line">d-i partman/confirm_nooverwrite boolean true</span><br><span class="line"></span><br><span class="line">d-i base-installer/kernel/image string linux-virtual</span><br><span class="line">d-i debian-installer/quiet  boolean false</span><br><span class="line">d-i debian-installer/splash boolean false</span><br><span class="line"></span><br><span class="line">d-i tasksel/first select openssh-server</span><br><span class="line">d-i pkgsel/include string openssh-server ntp python sudo</span><br><span class="line">d-i pkgsel/install-language-support boolean false</span><br><span class="line">d-i pkgsel/upgrade select none</span><br><span class="line">d-i pkgsel/update-policy select none</span><br><span class="line">d-i pkgsel/updatedb boolean true</span><br><span class="line"></span><br><span class="line"># Account setup</span><br><span class="line">d-i passwd/root-login boolean true</span><br><span class="line">d-i passwd/root-password password password</span><br><span class="line">d-i passwd/root-password-again password password</span><br><span class="line">d-i passwd/make-user boolean false</span><br><span class="line">d-i user-setup/password-weak boolean true</span><br><span class="line">d-i user-setup/allow-password-weak boolean true</span><br><span class="line">d-i user-setup/encrypt-home boolean false</span><br><span class="line"></span><br><span class="line"># Disable WEP dialog</span><br><span class="line">d-i netcfg/wireless_wep string</span><br><span class="line"></span><br><span class="line"># Security</span><br><span class="line">d-i apt-setup/services-select multiselect security</span><br><span class="line">d-i apt-setup/security_host string archive.ubuntu.com</span><br><span class="line">d-i apt-setup/security_path string /ubuntu</span><br><span class="line"></span><br><span class="line"># No multiarch by default</span><br><span class="line">d-i apt-setup/multiarch string</span><br><span class="line"></span><br><span class="line">d-i grub-installer/only_debian boolean true</span><br><span class="line">d-i grub-installer/with_other_os boolean true</span><br><span class="line"></span><br><span class="line">d-i finish-install/reboot_in_progress note</span><br><span class="line"></span><br><span class="line">d-i debian-installer/exit/halt boolean false</span><br><span class="line">d-i debian-installer/exit/poweroff boolean false</span><br><span class="line"></span><br><span class="line"># Late command for Packer to auth as root with password</span><br><span class="line">d-i preseed/late_command string \</span><br><span class="line">    sed -i -e &apos;s/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g&apos; /target/etc/ssh/sshd_config;\</span><br><span class="line">    sed -i -e &apos;s/^#\?PermitRootLogin.*/PermitRootLogin yes/g&apos; /target/etc/ssh/sshd_config</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="Use-preseed"><a href="#Use-preseed" class="headerlink" title="Use preseed"></a>Use preseed</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## Modify the file /share/HDA_DATA/Public</span><br><span class="line">#https://help.ubuntu.com/lts/installation-guide/armhf/apbs02.html</span><br><span class="line">/tftpbootdefault linux</span><br><span class="line">label linux</span><br><span class="line">    kernel ubuntu-installer/amd64/linux</span><br><span class="line">    append vga=normal initrd=ubuntu-installer/amd64/initrd.gz locale=en_US keyboard-configuration/layoutcode=us ipv6.disable=1 hostname=maas auto url=http://192.168.99.122:8080/ubuntu-auto.seed --</span><br></pre></td></tr></table></figure>
<p>注意：Ubuntu只要preseed即可。kickstart是Redhat自动安装的机制，如果要同时安装Ubuntu和Redhat，可以二者都设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">append ks=http://192.168.99.122:8080/ks.cfg preseed/url=http://192.168.99.122:8080/ubuntu-auto.seed vga=normal initrd=ubuntu-installer/amd64/initrd.gz --</span><br></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">images_root=/bak/images</span><br><span class="line">rootdisk=$images_root/test.img</span><br><span class="line">domain_xml=test.xml</span><br><span class="line">dpkg -s virtinst &amp;&gt;/dev/null || sudo apt install virtinst -y</span><br><span class="line">if ! [ -e &quot;$rootdisk&quot; ]; then</span><br><span class="line">    qemu-img create -f qcow2 $rootdisk 20G</span><br><span class="line">fi</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/network/interfaces &lt;&lt; EOF</span><br><span class="line">auto enp0s25</span><br><span class="line">iface enp0s25 inet manual</span><br><span class="line">    mtu 1500</span><br><span class="line">auto br-enp0s25</span><br><span class="line">iface br-enp0s25 inet static</span><br><span class="line">    address 192.168.99.135/24</span><br><span class="line">    gateway 192.168.99.1</span><br><span class="line">    bridge_ports enp0s25</span><br><span class="line">EOF&apos;</span><br><span class="line">ifup br-enp0s25</span><br><span class="line">sudo virt-install \</span><br><span class="line">    --name=bootstrap \</span><br><span class="line">    --connect=qemu:///system --ram=2048 --vcpus=1 --hvm \</span><br><span class="line">    --virt-type=kvm \</span><br><span class="line">    --pxe --boot network,hd \</span><br><span class="line">    --graphics vnc --noautoconsole --os-type=linux --accelerate \</span><br><span class="line">    --disk=$&#123;rootdisk&#125;,bus=virtio,format=qcow2 \</span><br><span class="line">    --network=bridge=juju-vm-br,model=virtio \</span><br><span class="line">    --print-xml 2 &gt; $domain_xml</span><br><span class="line">echo &quot;test domain definition is now available at $domain_xml&quot;</span><br></pre></td></tr></table></figure>
<h2 id="相关日志"><a href="#相关日志" class="headerlink" title="相关日志"></a>相关日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[/home/httpd] # tail -f /share/HDA_DATA/Public/tftpboot/opentftpd.log           </span><br><span class="line">[02-Dec-17 19:54:25] Client 192.168.99.150:49162 /share/HDA_DATA/Public/tftpboot/pxelinux.cfg/default, 2 Blocks Served</span><br><span class="line">[02-Dec-17 19:54:44] Client 192.168.99.150:49163 /share/HDA_DATA/Public/tftpboot/ubuntu-installer/amd64/linux, 5025 Blocks Served</span><br><span class="line">[02-Dec-17 19:56:30] Client 192.168.99.150:49164 /share/HDA_DATA/Public/tftpboot/ubuntu-installer/amd64/initrd.gz, 28718 Blocks Served</span><br><span class="line">[02-Dec-17 20:20:44] Client 192.168.99.136:59249 /share/HDA_DATA/Public/tftpboot/pxelinux.0, 31 Blocks Served</span><br><span class="line">[02-Dec-17 20:20:45] Client 192.168.99.136:49152 /share/HDA_DATA/Public/tftpboot/ldlinux.c32, 84 Blocks Served</span><br><span class="line">[02-Dec-17 20:20:45] Client 192.168.99.136:49163 /share/HDA_DATA/Public/tftpboot/pxelinux.cfg/default, 2 Blocks Served</span><br><span class="line">[02-Dec-17 20:21:01] Client 192.168.99.136:49164 /share/HDA_DATA/Public/tftpboot/ubuntu-installer/amd64/linux, 5025 Blocks Served</span><br><span class="line">[02-Dec-17 20:22:44] Client 192.168.99.136:49165 /share/HDA_DATA/Public/tftpboot/ubuntu-installer/amd64/initrd.gz, 28718 Blocks Served</span><br></pre></td></tr></table></figure>
<h2 id="附录-一个KickStart的例子"><a href="#附录-一个KickStart的例子" class="headerlink" title="附录 - 一个KickStart的例子"></a>附录 - 一个KickStart的例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># then can visit via - http://192.168.99.122:8080/ks.cfg, so the key line is &apos;url --url http://192.168.99.122:8080&apos;</span><br><span class="line">cat &gt; /home/httpd/ks.cfg &lt;&lt; EOF</span><br><span class="line">#Generated by Kickstart Configurator</span><br><span class="line">#platform=AMD64 or Intel EM64T</span><br><span class="line">#System language</span><br><span class="line">lang en_US</span><br><span class="line">#Language modules to install</span><br><span class="line">langsupport en_US</span><br><span class="line">#System keyboard</span><br><span class="line">keyboard us</span><br><span class="line">#System mouse</span><br><span class="line">mouse</span><br><span class="line">#System timezone</span><br><span class="line">timezone Asia/Chongqing</span><br><span class="line">#Root password</span><br><span class="line">rootpw --disabled</span><br><span class="line">#Initial user</span><br><span class="line">user hua --fullname hua --password password</span><br><span class="line">#Reboot after installation</span><br><span class="line">reboot</span><br><span class="line">#Use text mode install</span><br><span class="line">text</span><br><span class="line">#Install OS instead of upgrade</span><br><span class="line">install</span><br><span class="line">#Use Web installation media</span><br><span class="line">url --url http://192.168.99.122:8080</span><br><span class="line">#System bootloader configuration</span><br><span class="line">bootloader --location=mbr </span><br><span class="line">#Clear the Master Boot Record</span><br><span class="line">zerombr yes</span><br><span class="line">#Partition clearing information</span><br><span class="line">clearpart --all --initlabel </span><br><span class="line">#Disk partitioning information</span><br><span class="line">part swap --size 2048 </span><br><span class="line">part /boot --fstype ext4 --size 512 </span><br><span class="line">part / --fstype ext4 --size 1 --grow </span><br><span class="line">#System authorization infomation</span><br><span class="line">auth  --useshadow  --enablemd5 </span><br><span class="line">#Network information</span><br><span class="line">network --bootproto=dhcp --device=eth0</span><br><span class="line">#network --bootproto=static--ip=192.168.5.168 --netmask=255.255.255.0 --gateway=192.168.100.1--nameserver=8.8.8.8 --device=eth0</span><br><span class="line">#Firewall configuration</span><br><span class="line">firewall --disabled </span><br><span class="line">#Do not configure the X Window System</span><br><span class="line">skipx</span><br><span class="line"># Additional packages to install</span><br><span class="line">%packages</span><br><span class="line">ca-certificates</span><br><span class="line">openssl</span><br><span class="line">python</span><br><span class="line">openssh-server</span><br><span class="line">vim</span><br><span class="line">ubuntu-desktop</span><br><span class="line">unity</span><br><span class="line"># Add your custom post installation script here</span><br><span class="line">%post</span><br><span class="line"># Add post installation script to /usr/local/bin/ directory</span><br><span class="line">ls .</span><br><span class="line"># Fix locale</span><br><span class="line">echo &apos;LANG=&quot;en_US.UTF-8&quot;&apos; &gt; /etc/default/locale</span><br><span class="line">echo &apos;LANGUAGE=&quot;en_US:en&quot;&apos; &gt;&gt; /etc/default/locale</span><br><span class="line">echo &apos;LC_ALL=&quot;en_US.UTF-8&quot;&apos; &gt;&gt; /etc/default/locale</span><br><span class="line"># Clean</span><br><span class="line">apt-get -f -y install</span><br><span class="line">apt-get -y autoremove</span><br><span class="line">apt-get clean</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/02/OpenWRT与QNAP上通过PXE安装Xenial/" data-id="cjllrf72n000cztbpcjshzkd2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/09/03/也谈wifi断流问题/">也谈wifi断流问题</a>
          </li>
        
          <li>
            <a href="/2018/08/03/IPv6来啦/">IPv6来啦</a>
          </li>
        
          <li>
            <a href="/2018/07/13/Using-kubeadm-to-deploy-k8s/">Using kubeadm to deploy k8s</a>
          </li>
        
          <li>
            <a href="/2018/07/13/用OpenSSL做自签名的证书/">用OpenSSL做自签名的证书</a>
          </li>
        
          <li>
            <a href="/2018/07/10/Set-up-k8s-development-env-by-quqi99/">Set up k8s development env (by quqi99)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 张华<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>