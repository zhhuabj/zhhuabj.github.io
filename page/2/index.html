<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>技术并艺术着</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">
  
    <link rel="alternate" href="/atom.xml" title="技术并艺术着" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">技术并艺术着</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">张华的技术博客 - blog.csdn.net/quqi99</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Set-up-k8s-development-env-by-quqi99" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/10/Set-up-k8s-development-env-by-quqi99/" class="article-date">
  <time datetime="2018-07-10T09:47:57.000Z" itemprop="datePublished">2018-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/10/Set-up-k8s-development-env-by-quqi99/">Set up k8s development env (by quqi99)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-07-10)</strong></p>
<h2 id="Sign-the-CLA"><a href="#Sign-the-CLA" class="headerlink" title="Sign the CLA"></a>Sign the CLA</h2><p>Sign via Hellosign - <a href="https://github.com/kubernetes/community/blob/master/CLA.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/CLA.md</a><br>then set email for github - <a href="https://github.com/settings/emails" target="_blank" rel="external">https://github.com/settings/emails</a><br>git config –global user.email “xxx@gmail.com”</p>
<h2 id="Run-local-k8s-via-source-code"><a href="#Run-local-k8s-via-source-code" class="headerlink" title="Run local k8s  via source code"></a>Run local k8s  via source code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># Install some packages</span><br><span class="line">sudo apt install -y gcc make socat git build-essential</span><br><span class="line"></span><br><span class="line"># Install docker</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt-cache policy docker-ce</span><br><span class="line">sudo apt install docker-ce</span><br><span class="line"></span><br><span class="line"># Change default location of docker image</span><br><span class="line">service docker stop</span><br><span class="line">rsync -aXS /var/lib/docker/* /bak/.docker/</span><br><span class="line">rm -rf /var/lib/docker/*</span><br><span class="line">echo /bak/.docker/ /var/lib/docker none bind 0 0 &gt;&gt; /etc/fstab</span><br><span class="line">mount –a</span><br><span class="line">service docker start</span><br><span class="line"></span><br><span class="line"># Install etcd &gt; 3.2.13</span><br><span class="line">ETCD_VER=v3.2.18</span><br><span class="line">DOWNLOAD_URL=&quot;https://github.com/coreos/etcd/releases/download&quot;</span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">sudo /bin/cp -f etcd-$&#123;ETCD_VER&#125;-linux-amd64/&#123;etcd,etcdctl&#125; /usr/bin</span><br><span class="line">rm -rf /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz etcd-$&#123;ETCD_VER&#125;-linux-amd64</span><br><span class="line"></span><br><span class="line"># Install golang &gt; 1.10.2</span><br><span class="line">wget https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz</span><br><span class="line">sudo rm -rf /usr/lib/go &amp;&amp; sudo tar -C /usr/lib -xzf go1.10.3.linux-amd64.tar.gz</span><br><span class="line">export GOROOT=/usr/lib/go</span><br><span class="line">export GOPATH=/bak/golang</span><br><span class="line">export PATH=$GOROOT/bin:$GOPATH/bin:$PATH</span><br><span class="line"></span><br><span class="line"># Install and run kubernetes in local env - https://www.cnblogs.com/edisonxiang/p/6951787.html</span><br><span class="line">mkdir -p $GOPATH/src/k8s.io</span><br><span class="line">#go get -d k8s.io/kubernetes</span><br><span class="line">git clone git@github.com:zhhuabj/kubernetes.git $GOPATH/src/k8s.io/kubernetes</span><br><span class="line">#make GOGCFLAGS=&quot;-N -l&quot;  #Debug it</span><br><span class="line">sudo usermod -a -G docker $&#123;USER&#125;</span><br><span class="line">sudo systemctl restart docker.service</span><br><span class="line">sudo systemctl disable kubelet.service</span><br><span class="line">sudo systemctl stop kubelet.service</span><br><span class="line"></span><br><span class="line">#注意：一直不成功的原因是需要用小写true，它是区分大小写的</span><br><span class="line">KUBE_ENABLE_CLUSTER_DASHBOARD=true ./hack/local-up-cluster.sh</span><br><span class="line">#注意：加GO_OUT可避免再次编译</span><br><span class="line">GO_OUT=/bak/golang/src/k8s.io/kubernetes/_output/bin</span><br><span class="line">KUBE_ENABLE_CLUSTER_DASHBOARD=true ./hack/local-up-cluster.sh</span><br><span class="line"></span><br><span class="line"># Test local env</span><br><span class="line">export KUBECONFIG=/var/run/kubernetes/admin.kubeconfig</span><br><span class="line">cluster/kubectl.sh get pods --all-namespaces</span><br></pre></td></tr></table></figure>
<h2 id="github-process"><a href="#github-process" class="headerlink" title="github process"></a>github process</h2><p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/github-workflow.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/guide/github-workflow.md</a><br>k8s与openstack不一样，openstack使用gerrit来review code, 但是k8s使用github的PR机制。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kubernetes提交PR的流程可以采用pull模型（Shared Repository Model，https://gist.github.com/seshness/3943237），也可以采用fork模型（https://www.cnblogs.com/edisonxiang/p/6951787.html）。我们采用fork模型：</span><br><span class="line"></span><br><span class="line"># Click &apos;Fork&apos; button to fork your own branch - https://github.com/kubernetes/kubernetes, then we have https://github.com/zhhuabj/kubernetes</span><br><span class="line">mkdir -p $GOPATH/src/k8s.io</span><br><span class="line">git clone git@github.com:zhhuabj/kubernetes.git $GOPATH/src/k8s.io/kubernetes</span><br><span class="line">cd kubernetes</span><br><span class="line">hack/local-up-cluster.sh</span><br><span class="line"></span><br><span class="line"># set up upstream branch</span><br><span class="line">git remote add upstream https://github.com/kubernetes/kubernetes.git</span><br><span class="line">git remote set-url --push upstream no_push</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"># Update our branch</span><br><span class="line">git fetch upstream</span><br><span class="line">git checkout master</span><br><span class="line">git rebase upstream/master</span><br><span class="line">#git pull upstream master</span><br><span class="line"></span><br><span class="line"># Add new branch myfeature</span><br><span class="line">git checkout -b myfeature</span><br><span class="line">git config --global user.email &quot;veryhua2006@gmail.com&quot;</span><br><span class="line">git config --global user.name &quot;zhhuabj&quot;</span><br><span class="line"># Add or Modify files</span><br><span class="line">...</span><br><span class="line">git add .</span><br><span class="line">git commit -a -F ./msg</span><br><span class="line">git commit --amend -a -F ./message</span><br><span class="line">git commit -m &quot;update&quot;</span><br><span class="line">git push origin myfeature</span><br><span class="line">git push origin :myfeature  #delete remote branch</span><br><span class="line"></span><br><span class="line"># Rebase unmerged PR into our repo</span><br><span class="line">git fetch upstream pull/56136/head:BRANCHNAME</span><br><span class="line"></span><br><span class="line"># Merge multiple local commits into a full commit by using &apos;git squash&apos;</span><br><span class="line">git log</span><br><span class="line">git rebase -i HEAD~6 把顶部的六个版本聚到一起进入编辑页面</span><br><span class="line">　　把需要压缩的日志前面的pick都改为s（squash的缩写）</span><br><span class="line">　　注意必须保留一个pick，如果将所有的pick都改为了s那就没有合并的载体了就会报如下错误</span><br><span class="line">　　依次输入CTRL+X Y ENTER三个命令完成编辑。</span><br><span class="line">　　最后Git Push orgin branchname</span><br><span class="line"></span><br><span class="line"># Pull Request - https://github.com/zhhuabj/kubernetes, 在新上传的Branch上，点击Compare &amp; Pull Request按钮创建一个Pull Requst</span><br><span class="line"></span><br><span class="line"># 最后https://github.com/kubernetes/kubernetes/pulls就可以找到刚刚提交的Pull Request。</span><br></pre></td></tr></table></figure></p>
<h2 id="Review-process"><a href="#Review-process" class="headerlink" title="Review process"></a>Review process</h2><p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md#the-testing-and-merge-workflow" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md#the-testing-and-merge-workflow</a><br> openstack社区更开放，使用gerrit机制，新人都能review代码，并能+1。<br>但k8s使用github的PR，相对封闭一些，新人是不能review代码的，新人的角色叫contributor，可以修改issue (在issue上回复/assign)并提交代码。<br>只有每个子模块下OWNERS文件定义的reviewer, approver角色的人员(<a href="https://github.com/kubernetes/community/blob/master/community-membership.md)才能review代码(reviewer可以LDTM(looks" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/community-membership.md)才能review代码(reviewer可以LDTM(looks</a> good to me, +1), approver可以+2，一个+1一个+2就可以进代码，但openstack中是只能两个+2才可以)</p>
<p>如果要为某个issue创建PR, 需要在PR的描述里填写fixes #issue_num 。这样PR在 merge后issue会“自动”关闭。PR创建后，k8s机器人会做以下几件事：<br>在相应OWNER列表里选取一个人做为reviewer<br>如果是kubernetes member，则启动CI来检查PR，例如UT, e2e test；如果不是kuberentes member ，则需要一个member帮忙启动相应ci<br>待CI没有问题后，可以ping相应的reviewers来检查代码了</p>
<p>在reviewer认为可以后，需要标lgtm (look go to me) 标签；同时需要该模块的approver标记approve标签。两个标签都有了以后，就可以等待合并了。代码的合并也是由k8s机器人完成的，可以在 <a href="http://submit-queue.k8s.io/#/queue" target="_blank" rel="external">http://submit-queue.k8s.io/#/queue</a> 看到等待合并的PR。在合并之前，k8s机器人也会自动重新跑ci以保证代码没有问题。<br>以上三步差不多就可以将typo提交到主干上。其中大部分工作都有k8s机器人自动完成，比如分配reviewer。<br>  Bot命令如下：</p>
<ul>
<li>Jenkins verification: @k8s-bot verify test this</li>
<li>GCE E2E: @k8s-bot cvm gce e2e test this</li>
<li>Test all: @k8s-bot test this please, issue #IGNORE</li>
<li>CRI test: @k8s-bot cri test this.</li>
<li>Verity test: @k8s-bot verify test this</li>
<li>LGTM (only applied if you are one of assignees):: /lgtm</li>
<li>LGTM cancel: /lgtm cancel<br>更多命令见 <a href="https://prow.k8s.io/command-help" target="_blank" rel="external">https://prow.k8s.io/command-help</a><h2 id="How-to-do-test"><a href="#How-to-do-test" class="headerlink" title="How to do test"></a>How to do test</h2><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/testing.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/devel/testing.md</a><br>make verify<br>make test<br>make test-integration<h2 id="How-to-debug-k8s"><a href="#How-to-debug-k8s" class="headerlink" title="How to debug k8s"></a>How to debug k8s</h2>local-up-cluster.sh是通过_output/local/bin/linux/amd64/hyperkube在容器里启动k8s各服务的，那样是不方便使用(dlv exec ${OUTDIR}/bin/kubelet – $kubelet_flags)来调试基于B/S的k8s服务的，那首先将k8s各服务以本地进程的形式启动，这样调试k8s服务就变得像调试openstack服务一样。</li>
</ul>
<p>1， 第一步创建systemd启动配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">$ cat /lib/systemd/system/kube-etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-etcd Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/etcd -name etcd -data-dir /var/lib/etcd \</span><br><span class="line">          -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \</span><br><span class="line">          -advertise-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001</span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line">$ cat /lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-apiserver Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/bak/golang/src/k8s.io/kubernetes/_output/bin/kube-apiserver \</span><br><span class="line">            --admission-control=NamespaceAutoProvision,LimitRanger,SecurityContextDeny \</span><br><span class="line">            --apiserver-count=1 \</span><br><span class="line">            --cors-allowed-origins=.* \</span><br><span class="line">            --enable-garbage-collector=false \</span><br><span class="line">            --etcd-servers=http://127.0.0.1:2379 \</span><br><span class="line">            --insecure-bind-address=0.0.0.0 \</span><br><span class="line">            --insecure-port=8080 \</span><br><span class="line">            --log-dir=~/.kube/log/kube-apiserver \</span><br><span class="line">            --logtostderr=false \</span><br><span class="line">            --service-cluster-ip-range=10.0.0.0/16 \</span><br><span class="line">            --v=5 \</span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line">$ cat /lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-controller-manager Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bak/golang/src/k8s.io/kubernetes/_output/bin/kube-controller-manager \</span><br><span class="line">          --enable-garbage-collector=false \</span><br><span class="line">          --logtostderr=false \</span><br><span class="line">          --log-dir=~/.kube/log/kube-controller-manager \</span><br><span class="line">          --pod-eviction-timeout=5m0s \</span><br><span class="line">          --master=http://0.0.0.0:8080 \</span><br><span class="line">          --node-monitor-grace-period=40s \</span><br><span class="line">          --terminated-pod-gc-threshold=12500 \</span><br><span class="line">          --leader-elect=true \</span><br><span class="line">          --v=4 \</span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line">$ cat /lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kube-scheduler Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bak/golang/src/k8s.io/kubernetes/_output/bin/kube-scheduler \</span><br><span class="line">            --log-dir=~/.k8s/log/kube-scheduler \</span><br><span class="line">            --logtostderr=false \</span><br><span class="line">            --master=http://0.0.0.0:8080 \</span><br><span class="line">            --leader-elect=true \</span><br><span class="line">            --v=5 \</span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br><span class="line"># prepare kubelet.kubeconfig and kube-proxy.kubeconfig</span><br><span class="line">export KUBE_APISERVER=&quot;http://127.0.0.1:8080&quot;</span><br><span class="line">./_output/bin/kubectl config set-cluster myk8s --server=$&#123;KUBE_APISERVER&#125; --kubeconfig=kubelet.kubeconfig</span><br><span class="line">./_output/bin/kubectl config set-credentials kubelet --kubeconfig=kubelet.kubeconfig</span><br><span class="line">./_output/bin/kubectl config set-context myk8s-context --cluster=myk8s --user=kubelet --kubeconfig=kubelet.kubeconfig</span><br><span class="line">./_output/bin/kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">./_output/bin/kubectl config set-cluster myk8s --server=$&#123;KUBE_APISERVER&#125; --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">./_output/bin/kubectl config set-credentials kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">./_output/bin/kubectl config set-context myk8s-context --cluster=myk8s --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">./_output/bin/kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">cp *.kubeconfig /home/hua/.kube/</span><br><span class="line"></span><br><span class="line">$ cat /lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet: The Kubernetes Node Agent</span><br><span class="line">Documentation=http://kubernetes.io/docs/</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/bak/golang/src/k8s.io/kubernetes/_output/bin/kubelet \</span><br><span class="line">          --address=127.0.0.1 --port=10250 --hostname-override=127.0.0.1 \</span><br><span class="line">          --pod-infra-container-image=docker.io/kubernetes/pause \</span><br><span class="line">          --fail-swap-on=false --cgroup-driver=cgroupfs \</span><br><span class="line">          --kubeconfig=/home/hua/.kube/kubelet.kubeconfig \</span><br><span class="line">          --runtime-cgroups=/systemd/system.slice \</span><br><span class="line">          --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">          --eviction-hard=&apos;nodefs.available&lt;1%&apos; \</span><br><span class="line">          --logtostderr=false --log-dir=~/.kube/log/kubelet --v=4</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ cat /lib/systemd/system/kube-proxy.service[Unit]</span><br><span class="line">Description=Kube-proxy Service</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bak/golang/src/k8s.io/kubernetes/_output/bin/kube-proxy \</span><br><span class="line">            --log-dir=~/.k8s/log/kube-proxy \</span><br><span class="line">            --logtostderr=false \</span><br><span class="line">            --master=http://0.0.0.0:8080 \</span><br><span class="line">            --kubeconfig=/home/hua/.kube/kube-proxy.kubeconfig \</span><br><span class="line">            --proxy-mode=userspace \</span><br><span class="line">            --v=5</span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure></p>
<p>2， 第二步，启动各服务:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl --system daemon-reload</span><br><span class="line">sudo systemctl start kube-etcd.service</span><br><span class="line">etcdctl -C http://localhost:4001 cluster-health</span><br><span class="line">sudo systemctl start kube-apiserver.service</span><br><span class="line">sudo systemctl start kube-controller-manager.service</span><br><span class="line">sudo systemctl start kube-scheduler.service</span><br><span class="line">sudo systemctl start kubelet.service</span><br></pre></td></tr></table></figure></p>
<p>3, 第二步，验证安装是否正确：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ /bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl -s http://127.0.0.1:8080 get componentstatus</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br><span class="line"></span><br><span class="line">/bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl config set-cluster myk8s --server=http://127.0.0.1:8080</span><br><span class="line">/bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl config set-context myk8s-context --cluster=myk8s --namespace=default --user=client</span><br><span class="line">/bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl config use-context myk8s-context</span><br><span class="line">/bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl config set preferences.colors true</span><br><span class="line">$ cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    server: http://127.0.0.1:8080</span><br><span class="line">  name: myk8s</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: myk8s</span><br><span class="line">    namespace: default</span><br><span class="line">    user: client</span><br><span class="line">  name: myk8s-context</span><br><span class="line">current-context: myk8s-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences:</span><br><span class="line">  colors: true</span><br><span class="line">users: []</span><br><span class="line"></span><br><span class="line">$ /bak/golang/src/k8s.io/kubernetes/_output/bin/kubectl get componentstatus</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br><span class="line">$ ./_output/bin/kubectl get nodes</span><br><span class="line">NAME        STATUS    ROLES     AGE       VERSION</span><br><span class="line">127.0.0.1   Ready     &lt;none&gt;    11m       v1.12.0-alpha.0.1999+32dc6cc08aa034-dirty</span><br><span class="line">$ ./_output/bin/kubectl get events</span><br></pre></td></tr></table></figure></p>
<p>4，第四步，例如要调试kubelet服务的话，先停止该服务(sudo systemctl stop kubelet)，然后使用(dlv exec ${OUTDIR}/bin/kubelet – $kubelet_flags)命令启动，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /bak/golang/bin/dlv --headless -l 127.0.0.1:1234 exec /bak/golang/src/k8s.io/kubernetes/_output/bin/kubelet -- --fail-swap-on=False --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice  --v=4</span><br><span class="line">API server listening at: 127.0.0.1:1234</span><br><span class="line"></span><br><span class="line">$ sudo /bak/golang/bin/dlv connect 127.0.0.1:1234</span><br><span class="line">Type &apos;help&apos; for list of commands.</span><br><span class="line">(dlv) b main.main</span><br><span class="line">Breakpoint 1 set at 0x2d08348 for main.main() ./_output/local/go/src/k8s.io/kubernetes/cmd/kubelet/kubelet.go:36</span><br><span class="line">(dlv) c</span><br></pre></td></tr></table></figure></p>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>该命令(KUBE_ENABLE_CLUSTER_DASHBOARD=true ./hack/local-up-cluster.sh）会自动安装dashboard。<br>注意：如果不成功原因是需要用小写true，它是区分大小写的。</p>
<p>安装成功后使用命令（cluster/kubectl.sh cluster-info）查看它的访问地址如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://localhost:6443//api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure></p>
<p>这个链接有点问题，在api处有两个斜线会造成看不到UI，改成如下的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://localhost:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure></p>
<p>也可运行命令（kubectl proxy –port=8001 –kubeconfig=/var/run/kubernetes/admin.kubeconfig –accept-hosts=’^*$’）访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure></p>
<p>上面的’–accept-hosts’用于在非本机外部访问，但Dashboard只允许localhost和127.0.0.1使用HTTP连接进行访问，而其它地址只允许使用HTTPS。因此，如果需要在非本机访问Dashboard的话，只能采用NodePort:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system edit service kubernetes-dashboard</span><br><span class="line">$ kubectl -n kube-system get service kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.0.0.232   &lt;none&gt;        443:31050/TCP   1h</span><br><span class="line">visit: https://192.168.99.216:31050/</span><br></pre></td></tr></table></figure></p>
<p>这时访问dashboard仍然有下列问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;message&quot;: &quot;services \&quot;https:kubernetes-dashboard:\&quot; is forbidden: User \&quot;system:anonymous\&quot; cannot get services/proxy in the namespace \&quot;kube-system\&quot;: no RBAC policy matched&quot;,</span><br></pre></td></tr></table></figure></p>
<p>这是因为最新版的k8s默认启用了RBAC(–authorization-mode=Node,RBAC)，并为未认证用户赋予了一个默认的身份：anonymous<br>对于API Server来说，它是使用证书进行认证的，我们需要先创建一个证书：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># generate client-certificate-data</span><br><span class="line">grep &apos;client-certificate-data&apos; /var/run/kubernetes/admin.kubeconfig | head -n 1 | awk &apos;&#123;print $2&#125;&apos; | base64 -d &gt;&gt; kubecfg.crt</span><br><span class="line"># generate client-key-data</span><br><span class="line">grep &apos;client-key-data&apos; /var/run/kubernetes/admin.kubeconfig | head -n 1 | awk &apos;&#123;print $2&#125;&apos; | base64 -d &gt;&gt; kubecfg.key</span><br><span class="line"># generate p12</span><br><span class="line">openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name &quot;kubernetes-client&quot;</span><br></pre></td></tr></table></figure></p>
<p>然后将该p12证书导入到浏览器即可。此时默认的anonymous身份的token可以这样获取:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster/kubectl.sh get secret -n kube-system | grep dashboard</span><br><span class="line">cluster/kubectl.sh -n kube-system  get secret kubernetes-dashboard-token-kglhd -o jsonpath=&#123;.data.token&#125;| base64 -d</span><br></pre></td></tr></table></figure></p>
<p>anonymous身份可能看不到很多东西，所以我们再在kube-system名空间下再创建一个admin用户并和cluster-admin角色关联：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /tmp/admin-user.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line">cat &gt; /tmp/admin-user-role-binding.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line">cluster/kubectl.sh create -f /tmp/admin-user.yaml</span><br><span class="line">cluster/kubectl.sh create -f /tmp/admin-user-role-binding.yaml</span><br><span class="line">cluster/kubectl.sh -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin | awk &apos;&#123;print $1&#125;&apos;)</span><br></pre></td></tr></table></figure>
<p>##直接修改local-up-cluster.sh代替hyperkube用本地进程启动 ##<br>或者直接修改脚本去掉hyperkube, 然后运行ENABLE_CLUSTER_DASHBOARD=True ./hack/local-up-cluster.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/hack/local-up-cluster.sh b/hack/local-up-cluster.sh</span><br><span class="line">index 3b688d3..95de0df 100755</span><br><span class="line">--- a/hack/local-up-cluster.sh</span><br><span class="line">+++ b/hack/local-up-cluster.sh</span><br><span class="line">@@ -202,7 +202,8 @@ do</span><br><span class="line"> done</span><br><span class="line"></span><br><span class="line"> if [ &quot;x$GO_OUT&quot; == &quot;x&quot; ]; then</span><br><span class="line">-    make -C &quot;$&#123;KUBE_ROOT&#125;&quot; WHAT=&quot;cmd/kubectl cmd/hyperkube&quot;</span><br><span class="line">+    #make -C &quot;$&#123;KUBE_ROOT&#125;&quot; WHAT=&quot;cmd/kubectl cmd/hyperkube&quot;</span><br><span class="line">+    make -C &quot;$&#123;KUBE_ROOT&#125;&quot; GOGCFLAGS=&quot;-N -l&quot; WHAT=&quot;cmd/kubelet cmd/kube-proxy cmd/kube-apiserver cmd/kube-controller-manager cmd/cloud-controller-manager cmd/kube-scheduler cmd/kubectl&quot;</span><br><span class="line"> else</span><br><span class="line">     echo &quot;skipped the build.&quot;</span><br><span class="line"> fi</span><br><span class="line">@@ -578,7 +579,7 @@ function start_apiserver &#123;</span><br><span class="line">     fi</span><br><span class="line"></span><br><span class="line">     APISERVER_LOG=$&#123;LOG_DIR&#125;/kube-apiserver.log</span><br><span class="line">-    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/hyperkube&quot; apiserver $&#123;swagger_arg&#125; $&#123;audit_arg&#125; $&#123;authorizer_arg&#125; $&#123;priv_arg&#125; $&#123;runtime_config&#125; \</span><br><span class="line">+    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/kube-apiserver&quot; $&#123;swagger_arg&#125; $&#123;audit_arg&#125; $&#123;authorizer_arg&#125; $&#123;priv_arg&#125; $&#123;runtime_config&#125; \</span><br><span class="line">       $&#123;cloud_config_arg&#125; \</span><br><span class="line">       $&#123;advertise_address&#125; \</span><br><span class="line">       $&#123;node_port_range&#125; \</span><br><span class="line">@@ -650,7 +651,7 @@ function start_controller_manager &#123;</span><br><span class="line">     fi</span><br><span class="line"></span><br><span class="line">     CTLRMGR_LOG=$&#123;LOG_DIR&#125;/kube-controller-manager.log</span><br><span class="line">-    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/hyperkube&quot; controller-manager \</span><br><span class="line">+    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/kube-controller-manager&quot; \</span><br><span class="line">       --v=$&#123;LOG_LEVEL&#125; \</span><br><span class="line">       --vmodule=&quot;$&#123;LOG_SPEC&#125;&quot; \</span><br><span class="line">       --service-account-private-key-file=&quot;$&#123;SERVICE_ACCOUNT_KEY&#125;&quot; \</span><br><span class="line">@@ -685,7 +686,7 @@ function start_cloud_controller_manager &#123;</span><br><span class="line">     fi</span><br><span class="line"></span><br><span class="line">     CLOUD_CTLRMGR_LOG=$&#123;LOG_DIR&#125;/cloud-controller-manager.log</span><br><span class="line">-    $&#123;CONTROLPLANE_SUDO&#125; $&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-&quot;$&#123;GO_OUT&#125;/hyperkube&quot; cloud-controller-manager&#125; \</span><br><span class="line">+    $&#123;CONTROLPLANE_SUDO&#125; $&#123;EXTERNAL_CLOUD_PROVIDER_BINARY:-&quot;$&#123;GO_OUT&#125;/cloud-controller-manager&quot;&#125; \</span><br><span class="line">       --v=$&#123;LOG_LEVEL&#125; \</span><br><span class="line">       --vmodule=&quot;$&#123;LOG_SPEC&#125;&quot; \</span><br><span class="line">       $&#123;node_cidr_args&#125; \</span><br><span class="line">@@ -791,7 +792,7 @@ function start_kubelet &#123;</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line">     if [[ -z &quot;$&#123;DOCKERIZE_KUBELET&#125;&quot; ]]; then</span><br><span class="line">-      sudo -E &quot;$&#123;GO_OUT&#125;/hyperkube&quot; kubelet &quot;$&#123;all_kubelet_flags[@]&#125;&quot; &gt;&quot;$&#123;KUBELET_LOG&#125;&quot; 2&gt;&amp;1 &amp;</span><br><span class="line">+      sudo -E &quot;$&#123;GO_OUT&#125;/kubelet&quot; &quot;$&#123;all_kubelet_flags[@]&#125;&quot; &gt;&quot;$&#123;KUBELET_LOG&#125;&quot; 2&gt;&amp;1 &amp;</span><br><span class="line">       KUBELET_PID=$!</span><br><span class="line">     else</span><br><span class="line"></span><br><span class="line">@@ -889,14 +890,14 @@ EOF</span><br><span class="line">       done</span><br><span class="line">     fi &gt;&gt;/tmp/kube-proxy.yaml</span><br><span class="line"></span><br><span class="line">-    sudo &quot;$&#123;GO_OUT&#125;/hyperkube&quot; proxy \</span><br><span class="line">+    sudo &quot;$&#123;GO_OUT&#125;/kube-proxy&quot; \</span><br><span class="line">       --v=$&#123;LOG_LEVEL&#125; \</span><br><span class="line">       --config=/tmp/kube-proxy.yaml \</span><br><span class="line">       --master=&quot;https://$&#123;API_HOST&#125;:$&#123;API_SECURE_PORT&#125;&quot; &gt;&quot;$&#123;PROXY_LOG&#125;&quot; 2&gt;&amp;1 &amp;</span><br><span class="line">     PROXY_PID=$!</span><br><span class="line"></span><br><span class="line">     SCHEDULER_LOG=$&#123;LOG_DIR&#125;/kube-scheduler.log</span><br><span class="line">-    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/hyperkube&quot; scheduler \</span><br><span class="line">+    $&#123;CONTROLPLANE_SUDO&#125; &quot;$&#123;GO_OUT&#125;/kube-scheduler&quot; \</span><br><span class="line">       --v=$&#123;LOG_LEVEL&#125; \</span><br><span class="line">       --kubeconfig &quot;$CERT_DIR&quot;/scheduler.kubeconfig \</span><br><span class="line">       --feature-gates=&quot;$&#123;FEATURE_GATES&#125;&quot; \</span><br></pre></td></tr></table></figure></p>
<h2 id="How-to-read-source-code"><a href="#How-to-read-source-code" class="headerlink" title="How to read source code"></a>How to read source code</h2><p><a href="http://dockone.io/article/895" target="_blank" rel="external">http://dockone.io/article/895</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://kubernetes.io/docs/imported/community/devel/" target="_blank" rel="external">https://kubernetes.io/docs/imported/community/devel/</a><br>[2] <a href="https://github.com/kubernetes/community/tree/master/contributors/devel" target="_blank" rel="external">https://github.com/kubernetes/community/tree/master/contributors/devel</a><br>[3] Bug - <a href="https://github.com/kubernetes/community/issues" target="_blank" rel="external">https://github.com/kubernetes/community/issues</a><br>[4] Submit code review - <a href="https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md</a><br>[5] Membership - <a href="https://github.com/kubernetes/community/blob/master/community-membership.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/community-membership.md</a><br>[6] CONTRIBUTING - <a href="https://github.com/kubernetes/community/blob/master/CONTRIBUTING.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/CONTRIBUTING.md</a><br>[7] Code format - <a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="external">https://github.com/golang/go/wiki/CodeReviewComments</a><br>[8] Slack - <a href="https://kubernetes.slack.com/messages" target="_blank" rel="external">https://kubernetes.slack.com/messages</a><br>[9] Mail-list - <a href="https://groups.google.com/forum/#!forum/kubernetes-dev" target="_blank" rel="external">https://groups.google.com/forum/#!forum/kubernetes-dev</a><br>[10] SIG-list (Special Interest Groups) - <a href="https://github.com/kubernetes/community/blob/master/sig-list.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/sig-list.md</a><br>[11] open-bug - <a href="https://github.com/kubernetes/community/blob/master/contributors/guide/issue-triage.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/guide/issue-triage.md</a><br>[12] BP - <a href="https://github.com/kubernetes/community/tree/master/contributors/design-proposals" target="_blank" rel="external">https://github.com/kubernetes/community/tree/master/contributors/design-proposals</a><br>[13] <a href="https://github.com/kubernetes/community/blob/master/community-membership.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/community-membership.md</a><br>[14] test - <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/testing.md" target="_blank" rel="external">https://github.com/kubernetes/community/blob/master/contributors/devel/testing.md</a><br>[15] <a href="https://ress.infoq.com/minibooks/Kubernetes-handbook/zh/pdf/kubernetes.pdf" target="_blank" rel="external">https://ress.infoq.com/minibooks/Kubernetes-handbook/zh/pdf/kubernetes.pdf</a><br>[16] <a href="https://kubernetes.io/docs/home/" target="_blank" rel="external">https://kubernetes.io/docs/home/</a><br>[17] <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank" rel="external">https://github.com/kelseyhightower/kubernetes-the-hard-way</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/10/Set-up-k8s-development-env-by-quqi99/" data-id="cjuhndt5l000dirbp8r6iefbg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-温故OpenStack中的测试-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/10/温故OpenStack中的测试-by-Joshua/" class="article-date">
  <time datetime="2018-07-10T08:28:15.000Z" itemprop="datePublished">2018-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/10/温故OpenStack中的测试-by-Joshua/">温故OpenStack中的测试(by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-03-15)</strong></p>
<ol>
<li><p>沿用tox调用virtualenv自动创建的虚拟环境(virtualenv -p python3.5 .tox/py35)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source .tox/py35/bin/activate</span><br><span class="line">sudo pip install --upgrade -r requirements.txt</span><br><span class="line">sudo pip install --upgrade -r test-requirements.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用unittest和nose运行测试。nose是对unittest的扩展，使得python的测试更加简单，nose自动发现测试代码并执行，nose提供了大量的插件，比如覆盖报表等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m unittest -v unit_tests.test_neutron_utils.TestNeutronUtils.test_get_packages_ovs_newton</span><br><span class="line">.tox/py35/bin/python nosetests -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_get_packages_ovs_newton</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>注意：上面采用nosetests运行时会报错，因为我们的测试采用了python3, 所以需要在安装了python3-nose之后（sudo apt-get install python3-nose python3-mock）再采用下列三种方式之一运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nosetests3 -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_restart_map_ovs_odl</span><br><span class="line">/bak/work/charms/neutron-gateway/.tox/py35/bin/python /usr/local/bin/nosetests -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_get_packages_ovs_newton</span><br><span class="line">python -m nose unit_tests/test_neutron_utils.py:TestNeutronUtils.test_restart_map_ovs_odl</span><br></pre></td></tr></table></figure></p>
<p>但实际上仍然找不找nose模块，那是因为nose与virtualenv结合地不大好，在这个网页找着了答案(<a href="https://stackoverflow.com/questions/864956/problems-using-nose-in-a-virtualenv" target="_blank" rel="external">https://stackoverflow.com/questions/864956/problems-using-nose-in-a-virtualenv</a>) - You need to have a copy of nose installed in the virtual environment. In order to force installation of nose into the virtualenv, even though it is already installed in the global site-packages, run pip install with the -I flag: pip install nose -I</p>
<ol>
<li><p>上面使用unittest与nose运行测试的方式只是将结果输出到stdout，不便于分析。所以可以使用python-subunit模块来运行测试，并将测试结果通过subunit协议输出到文件中便于日后分析。因为subunit是基于二进制的不便于人眼看，所以可使用subunit2pyunit工具将其人类可读化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m subunit.run discover |subunit2pyunit</span><br><span class="line">python -m subunit.run discover -t ./ ./unit_tests |subunit2pyunit</span><br><span class="line">python -m subunit.run unit_tests.test_neutron_utils.TestNeutronUtils. |subunit2pyunit</span><br></pre></td></tr></table></figure>
</li>
<li><p>在大型应用中分析测试结果很重要，testrepository可以调用subunit来用python-subunit模块来运行测试，并将测试结果通过subunit协议输出到文件中，然后testrepository在些基础上有更多的分析，如分析哪些用例运行的时间最长，如显示失败的用例，如仅运行上次运行失败的用例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testr init</span><br><span class="line">testr run</span><br><span class="line">testr run --parallel</span><br><span class="line">$ cat .testr.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">test_command=OS_STDOUT_CAPTURE=$&#123;OS_STDOUT_CAPTURE:-1&#125; \</span><br><span class="line">             OS_STDERR_CAPTURE=$&#123;OS_STDERR_CAPTURE:-1&#125; \</span><br><span class="line">             OS_TEST_TIMEOUT=$&#123;OS_TEST_TIMEOUT:-60&#125; \</span><br><span class="line">             $&#123;PYTHON:-python&#125; -m subunit.run discover -t ./ ./unit_tests $LISTOPT $IDOPTION</span><br><span class="line">test_id_option=--load-list $IDFILE</span><br><span class="line">test_list_option=--list</span><br></pre></td></tr></table></figure>
</li>
<li><p>tox用于创建虚拟python环境，也可以集成上面的testrepository(commands = ostestr {posargs})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ cat tox.ini</span><br><span class="line">[tox]</span><br><span class="line">envlist = pep8,py27,py35</span><br><span class="line">skipsdist = True</span><br><span class="line"></span><br><span class="line">[testenv]</span><br><span class="line">setenv = VIRTUAL_ENV=&#123;envdir&#125;</span><br><span class="line">         PYTHONHASHSEED=0</span><br><span class="line">         CHARM_DIR=&#123;envdir&#125;</span><br><span class="line">         AMULET_SETUP_TIMEOUT=5400</span><br><span class="line">install_command =</span><br><span class="line">  pip install --allow-unverified python-apt &#123;opts&#125; &#123;packages&#125;</span><br><span class="line">commands = ostestr &#123;posargs&#125;</span><br><span class="line">whitelist_externals = juju</span><br><span class="line">passenv = HOME TERM AMULET_* CS_API_*</span><br><span class="line"></span><br><span class="line">[testenv:py27]</span><br><span class="line">basepython = python2.7</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line">commands = /bin/true</span><br><span class="line"></span><br><span class="line">[testenv:py35]</span><br><span class="line">basepython = python3.5</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line"></span><br><span class="line">[testenv:pep8]</span><br><span class="line">basepython = python2.7</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line">commands = flake8 &#123;posargs&#125; hooks unit_tests tests actions lib</span><br><span class="line">           charm-proof</span><br><span class="line"></span><br><span class="line">[flake8]</span><br><span class="line">ignore = E402,E226</span><br><span class="line">exclude = */helpers</span><br></pre></td></tr></table></figure>
</li>
<li><p>pydev使用virtualenv中的py35<br>在eclipse的”Preferences -&gt; Pydev -&gt; Interpreters -&gt; Python Interpreters”菜单中定义python35=/bak/work/charms/neutron-gateway/.tox/py35/bin/python,然后在工程上点右键从”Properties -&gt; Pydev - Interpreter/Grammar”定义使用python35。注意，需要将/bak/work/charms/neutron-gateway/.tox/py35/lib/python3.5/site-packages也选到环境变量中，否则后面会报ImportError: No module named ‘mock。<br>为一个测试类定义”Python unitest”类型的”Debug Configurations”, 也在其Interpreter选项卡中定义使用python35 (结果：eclipse似乎有bug，此处选择了python35后无法保存)<br>所以无法成功，似乎是pydev与python3协作不大好。最后还是pudb好使(sudo pip install pudb, import pudb; pdb.set_trace())</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/10/温故OpenStack中的测试-by-Joshua/" data-id="cjuhndt6q000yirbpkpk68cqj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Play-with-ceph-radosgw" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/13/Play-with-ceph-radosgw/" class="article-date">
  <time datetime="2018-06-13T10:56:45.000Z" itemprop="datePublished">2018-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/13/Play-with-ceph-radosgw/">Play with ceph-radosgw</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-06-13)</strong></p>
<h2 id="Rapidly-install"><a href="#Rapidly-install" class="headerlink" title="Rapidly install"></a>Rapidly install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/openstack/charm-ceph-radosgw</span><br><span class="line">juju deploy ceph-radosgw --series xenial</span><br><span class="line">juju add-relation ceph-radosgw ceph</span><br><span class="line">juju add-relation keystone ceph-radosgw</span><br><span class="line">juju expose ceph-radosgw</span><br><span class="line">curl http://juju-332891-mitaka-ceph-13</span><br><span class="line"></span><br><span class="line">juju ssh ceph/0 &apos;sudo radosgw-admin metadata list user&apos;</span><br><span class="line">sudo radosgw-admin user create --uid=&quot;admin&quot; --display-name=&quot;admin&quot;</span><br><span class="line">sudo radosgw-admin usage show --uid=admin</span><br><span class="line">sudo radosgw-admin usage show --show-log-entries=false</span><br><span class="line">sudo radosgw-admin caps add --uid=admin --caps=&quot;users=*&quot;</span><br><span class="line">sudo radosgw-admin caps add --uid=admin --caps=&quot;usage=read&quot;</span><br><span class="line">sudo radosgw-admin bucket stats</span><br><span class="line">sudo radosgw-admin bucket stats --uid=anonymous</span><br></pre></td></tr></table></figure>
<h2 id="Use-s3cmd-client-to-visit-RGW"><a href="#Use-s3cmd-client-to-visit-RGW" class="headerlink" title="Use s3cmd client to visit RGW"></a>Use s3cmd client to visit RGW</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install s3cmd</span><br><span class="line">s3cmd --configure</span><br><span class="line">check_ssl_certificate = False</span><br><span class="line">check_ssl_hostname = False</span><br><span class="line">access_key = EJECCFLCB0K53EMVM3DL</span><br><span class="line">secret_key = C281KRmdFFWxzOHyjZ3OsvQorCgf1mxdML7kYJ1t</span><br><span class="line">cloudfront_host = juju-332891-mitaka-ceph-13</span><br><span class="line">host_base = juju-332891-mitaka-ceph-13:80</span><br><span class="line">host_bucket = %(bucket)s.juju-332891-mitaka-ceph-13</span><br><span class="line"></span><br><span class="line">s3cmd mb s3://my_test1</span><br><span class="line">s3cmd ls  # qeury bucket</span><br><span class="line">s3cmd put testfile s3://my_test1</span><br><span class="line">s3cmd ls s3://my_test1</span><br><span class="line">s3cmd get s3://my_test1/diff</span><br></pre></td></tr></table></figure>
<h2 id="Enable-usage-log"><a href="#Enable-usage-log" class="headerlink" title="Enable usage.log"></a>Enable usage.log</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">http://www.yangguanjun.com/2016/08/30/rgw-user-statistics/</span><br><span class="line">Add the following configurations into ceph-radosgw/0 node</span><br><span class="line">[client.radosgw.gateway]</span><br><span class="line">rgw enable usage log = true</span><br><span class="line">rgw usage log tick interval = 30</span><br><span class="line">rgw usage log flush threshold = 1024</span><br><span class="line">rgw usage max shards = 32</span><br><span class="line">rgw usage max user shards = 1</span><br><span class="line"></span><br><span class="line">sudo ceph osd pool create .usage 64   # create a pool for usage, run in &apos;ceph/0&apos;</span><br><span class="line">sudo ceph osd pool create .rgw 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.root 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.control 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.gc 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.buckets 128 128</span><br><span class="line">sudo ceph osd pool create .rgw.buckets.index 128 128</span><br><span class="line">sudo ceph osd pool create .log 128 128</span><br><span class="line">sudo ceph osd pool create .intent-log 128 128</span><br><span class="line">sudo ceph osd pool create .usage 128 128</span><br><span class="line">sudo ceph osd pool create .users 128 128</span><br><span class="line">sudo ceph osd pool create .users.email 128 128</span><br><span class="line">sudo ceph osd pool create .users.swift 128 128</span><br><span class="line">sudo ceph osd pool create .users.uid 128 128</span><br><span class="line"></span><br><span class="line">sudo /etc/init.d/radosgw restart</span><br><span class="line">ceph daemon /var/run/ceph/ceph-client.radosgw.gateway.asok config show # verify config, run in radosgw node</span><br><span class="line">sudo radosgw-admin usage show --show-log-entries=false  # after 1 hour, use radosgw-admin to see usage data, run in ceph/0</span><br></pre></td></tr></table></figure>
<h2 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h2><p>用REST API调用时遇到一个问题(radosgw-admin usage show无此问题), 就是看到anonymous用户有很多空bucket<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ sudo radosgw-admin usage show --uid=anonymous</span><br><span class="line">user.init failed: (13) Permission denied</span><br><span class="line"></span><br><span class="line">$./get_anonymous.py</span><br><span class="line">DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): juju-332891-mitaka-ceph-13</span><br><span class="line">DEBUG:urllib3.connectionpool:http://juju-332891-mitaka-ceph-13:80 &quot;GET /admin/usage?format=json&amp;show-summary=False&amp;uid=anonymous HTTP/1.1&quot; 200 242</span><br><span class="line">&lt;Response [200]&gt;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;entries&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;buckets&quot;:[</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;bucket&quot;:&quot;&quot;,</span><br><span class="line">                    &quot;categories&quot;:[</span><br><span class="line">                        &#123;</span><br><span class="line">                            &quot;bytes_received&quot;:0,</span><br><span class="line">                            &quot;bytes_sent&quot;:940,</span><br><span class="line">                            &quot;category&quot;:&quot;list_buckets&quot;,</span><br><span class="line">                            &quot;ops&quot;:4,</span><br><span class="line">                            &quot;successful_ops&quot;:4</span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;epoch&quot;:1528275600,</span><br><span class="line">                    &quot;owner&quot;:&quot;anonymous&quot;,</span><br><span class="line">                    &quot;time&quot;:&quot;2018-06-06 09:00:00.000000Z&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;user&quot;:&quot;anonymous&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat get_anonymous.py</span><br><span class="line">#!/usr/bin/python</span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import logging</span><br><span class="line">import argparse</span><br><span class="line">from awsauth import S3Auth</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">server = &apos;juju-332891-mitaka-ceph-13&apos;</span><br><span class="line">aws_key = &apos;EJECCFLCB0K53EMVM3DL&apos;</span><br><span class="line">secret = &apos;C281KRmdFFWxzOHyjZ3OsvQorCgf1mxdML7kYJ1t&apos;</span><br><span class="line">url = &apos;http://%s/admin/usage?format=json&amp;show-summary=False&amp;uid=anonymous&apos; % server</span><br><span class="line">response = requests.get(url, auth=S3Auth(aws_key, secret, server))</span><br><span class="line">print response</span><br><span class="line">print json.dumps(response.json(), sort_keys=True, indent=4, separators=(&apos;,&apos;, &apos;:&apos;))</span><br></pre></td></tr></table></figure></p>
<h2 id="Set-up-ceph-debug-env-in-boinic"><a href="#Set-up-ceph-debug-env-in-boinic" class="headerlink" title="Set up ceph debug env in boinic"></a>Set up ceph debug env in boinic</h2><p>gdb can also debug python by using prefix py- in gdb comand - <a href="http://linux-debug.blogspot.com/2015/01/ceph-debugging-python-code-in-gdb.html" target="_blank" rel="external">http://linux-debug.blogspot.com/2015/01/ceph-debugging-python-code-in-gdb.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ceph/ceph</span><br><span class="line">git submodule update --force --init --recursive</span><br><span class="line">git checkout master</span><br><span class="line">./install-deps.sh</span><br><span class="line">sudo apt install libatomic-ops-dev libboost-dev libboost-iostreams-dev libboost-thread-dev libboost-random-dev libboost-program-options-dev libcurl4-openssl-dev libcunit1 libcunit1-dev liblz4-dev liboath-dev liblttng-ust-dev libcrypto++ libcrypto++-dev libgoogle-perftools4 libtool cython libsnappy-dev libleveldb-dev libblkid-dev libudev-dev libkeyutils-dev libcrypto++-dev libcrypto++-doc libcrypto++-utils libfuse-dev libcurl4-openssl-dev libxml++2.6-dev libssl-dev libgoogle-perftools-dev libgoogle-perftools4 libatomic-ops-dev libaio-dev  xfslibs-dev libboost-iostreams-dev libfcgi-dev</span><br><span class="line">sudo apt install gcr libblockdev-crypto2 libhcrypto4-heimdal libhogweed4 libk5crypto3 libnettle6 libsodium23 openssl python-m2crypto python3-crypto python3-cryptography</span><br><span class="line">#./autogen.sh &amp;&amp; ./configure  #old way, need to modifty makefile to &apos;-O0-Wall -g&apos; for debug</span><br><span class="line">./do_cmake.sh -DCMAKE_BUILD_TYPE=Debug</span><br><span class="line">cd build</span><br><span class="line">make -j56</span><br><span class="line">make ceph-osd -j56</span><br><span class="line"></span><br><span class="line">MON=1 OSD=3 MDS=1 MGR=1 RGW=1 ../src/vstart.sh -n -d --without-dashboard</span><br><span class="line">../src/stop.sh</span><br><span class="line">./bin/ceph -s</span><br><span class="line">./bin/ceph osd pool stats</span><br><span class="line">ps aux|grep ceph</span><br><span class="line">pstree -p</span><br><span class="line"></span><br><span class="line">./bin/radosgw-admin user create --uid=admin --display-name=admin --access-key=admin --secret=password</span><br><span class="line">./bin/radosgw-admin usage show --uid=admin</span><br><span class="line">./bin/radosgw-admin bucket stats --uid=anonymous</span><br><span class="line"></span><br><span class="line">sudo gdb attach $(pidof radosgw)</span><br><span class="line">(gdb) set solib-search-path /bak/linux/ceph/src/.libs/</span><br><span class="line">(gdb) set pagination off</span><br><span class="line">(gdb) b rgw/rgw_process.cc:38</span><br><span class="line">(gdb) b process_request</span><br><span class="line">(gdb) c</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/13/Play-with-ceph-radosgw/" data-id="cjuhndt5f0009irbprz9anxog" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Play-with-LDAP-Keystone-by-quqi99" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/08/Play-with-LDAP-Keystone-by-quqi99/" class="article-date">
  <time datetime="2018-06-08T10:09:28.000Z" itemprop="datePublished">2018-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/08/Play-with-LDAP-Keystone-by-quqi99/">Play with LDAP + Keystone (by quqi99)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-05-29)</strong></p>
<h2 id="Install-OpenLDAP"><a href="#Install-OpenLDAP" class="headerlink" title="Install OpenLDAP"></a>Install OpenLDAP</h2><p>OpenLDAP Server可以使用这个charm安装 - <a href="https://jujucharms.com/u/openstack-charmers/ldap-test-fixture/3" target="_blank" rel="external">https://jujucharms.com/u/openstack-charmers/ldap-test-fixture/3</a>, 最终要添加的yaml如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keystone-ldap:</span><br><span class="line">  charm: cs:keystone-ldap-10</span><br><span class="line">ldap-test-fixture:</span><br><span class="line">  charm: cs:~openstack-charmers/ldap-test-fixture</span><br><span class="line"></span><br><span class="line">- [ keystone-ldap, keystone ]</span><br></pre></td></tr></table></figure></p>
<p>也可以根据这个链接分步安装 - <a href="https://api.jujucharms.com/charmstore/v5/~openstack-charmers/ldap-test-fixture-3/archive/hooks/install" target="_blank" rel="external">https://api.jujucharms.com/charmstore/v5/~openstack-charmers/ldap-test-fixture-3/archive/hooks/install</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export DEBIAN_FRONTEND=noninteractive</span><br><span class="line">echo -e &quot; \</span><br><span class="line">slapd slapd/internal/generated_adminpw password password</span><br><span class="line">slapd slapd/password2 password password</span><br><span class="line">slapd slapd/internal/adminpw password password</span><br><span class="line">slapd slapd/password1 password password</span><br><span class="line">&quot; | sudo debconf-set-selections</span><br><span class="line">sudo apt install slapd ldap-utils phpldapadmin</span><br><span class="line">sed -i &quot;s/dc=example/dc=test/g&quot; /etc/phpldapadmin/config.php</span><br><span class="line">service apache2 restart</span><br><span class="line">sudo service slapd restart</span><br><span class="line">#sudo dpkg-reconfigure slapd  #configure domain=test.com</span><br><span class="line">#slappasswd -h &#123;SSHA&#125; -s password</span><br><span class="line">#sudo apt-get install jxplorer  #GUI</span><br><span class="line"></span><br><span class="line"># How to test it</span><br><span class="line">sudo ldapsearch -h 10.5.0.72 -x -w password -D&quot;cn=admin,dc=test,dc=com&quot; -b dc=test,dc=com -s sub &apos;(objectclass=*)&apos; cn sn</span><br><span class="line">sudo ldapsearch -h 10.5.0.72 -x -w password -D&quot;cn=admin,dc=test,dc=com&quot; -b ou=users,dc=test,dc=com  &apos;(objectclass=*)&apos;  cn sn</span><br><span class="line">sudo ldapsearch -h 10.5.0.72 -x -w password -D&quot;cn=admin,dc=test,dc=com&quot; -b dc=test,dc=com</span><br></pre></td></tr></table></figure></p>
<h2 id="Modify-default-schema-to-support-OpenStack"><a href="#Modify-default-schema-to-support-OpenStack" class="headerlink" title="Modify default schema to support OpenStack"></a>Modify default schema to support OpenStack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://api.jujucharms.com/charmstore/v5/~openstack-charmers/ldap-test-fixture-3/archive/files/backup.ldif</span><br><span class="line">slapadd -v -c -l .backup.ldif</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ldapsearch -h 10.5.0.72 -x -w password -D&quot;cn=admin,dc=test,dc=com&quot; -b dc=test,dc=com</span><br><span class="line"># extended LDIF</span><br><span class="line">#</span><br><span class="line"># LDAPv3</span><br><span class="line"># base &lt;dc=test,dc=com&gt; with scope subtree</span><br><span class="line"># filter: (objectclass=*)</span><br><span class="line"># requesting: ALL</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># test.com</span><br><span class="line">dn: dc=test,dc=com</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line">o: test</span><br><span class="line">dc: test</span><br><span class="line"></span><br><span class="line"># admin, test.com</span><br><span class="line">dn: cn=admin,dc=test,dc=com</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">description: LDAP administrator</span><br><span class="line">userPassword:: e1NTSEF9Q1RxNU1nNHA5blhlL25WVjBqenZSYTZ2VkxQQnVJZjc=</span><br><span class="line"></span><br><span class="line"># groups, test.com</span><br><span class="line">dn: ou=groups,dc=test,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">objectClass: top</span><br><span class="line">ou: groups</span><br><span class="line"></span><br><span class="line"># admin, groups, test.com</span><br><span class="line">dn: cn=admin,ou=groups,dc=test,dc=com</span><br><span class="line">cn: admin</span><br><span class="line">gidNumber: 500</span><br><span class="line">memberUid: johndoe</span><br><span class="line">objectClass: posixGroup</span><br><span class="line">objectClass: top</span><br><span class="line"></span><br><span class="line"># openstack, groups, test.com</span><br><span class="line">dn: cn=openstack,ou=groups,dc=test,dc=com</span><br><span class="line">cn: openstack</span><br><span class="line">gidNumber: 501</span><br><span class="line">memberUid: johndoe</span><br><span class="line">objectClass: posixGroup</span><br><span class="line">objectClass: top</span><br><span class="line"></span><br><span class="line"># users, test.com</span><br><span class="line">dn: ou=users,dc=test,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">objectClass: top</span><br><span class="line">ou: users</span><br><span class="line"></span><br><span class="line"># janedoe, users, test.com</span><br><span class="line">dn: cn=janedoe,ou=users,dc=test,dc=com</span><br><span class="line">cn: janedoe</span><br><span class="line">gidNumber: 500</span><br><span class="line">givenName: Jane</span><br><span class="line">homeDirectory: /home/users/janedoe</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top</span><br><span class="line">sn: Jane Doe</span><br><span class="line">uid: janedoe</span><br><span class="line">uidNumber: 1001</span><br><span class="line">userPassword:: e01ENX1IT01SNHBNMTV0M2dZZDhXVXhNRzhnPT0=</span><br><span class="line"></span><br><span class="line"># johndoe, users, test.com</span><br><span class="line">dn: cn=johndoe,ou=users,dc=test,dc=com</span><br><span class="line">cn: johndoe</span><br><span class="line">gidNumber: 501</span><br><span class="line">givenName: John</span><br><span class="line">homeDirectory: /home/users/jdoe</span><br><span class="line">loginShell: /bin/sh</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top</span><br><span class="line">sn: John Doe</span><br><span class="line">uid: johndoe</span><br><span class="line">uidNumber: 1000</span><br><span class="line">userPassword:: e01ENX1IT01SNHBNMTV0M2dZZDhXVXhNRzhnPT0=</span><br><span class="line"></span><br><span class="line"># search result</span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"># numResponses: 9</span><br><span class="line"># numEntries: 8</span><br></pre></td></tr></table></figure>
<h2 id="Configure-Keystone"><a href="#Configure-Keystone" class="headerlink" title="Configure Keystone"></a>Configure Keystone</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">juju config keystone preferred-api-version=3</span><br><span class="line">juju deploy keystone-ldap --series xenial</span><br><span class="line">juju add-relation keystone-ldap keystone</span><br><span class="line"></span><br><span class="line">juju config keystone-ldap ldap-server=&quot;ldap://10.5.0.72&quot; ldap-user=&quot;cn=admin,dc=test,dc=com&quot; ldap-password=&quot;crapper&quot; ldap-suffix=&quot;dc=test,dc=com&quot;</span><br><span class="line">juju config keystone-ldap domain-name=&quot;aaa_domain&quot;</span><br><span class="line">juju config keystone-ldap ldap-config-flags=&quot;&#123; user_tree_dn: &apos;dc=test,dc=com&apos;, query_scope: &apos;sub&apos;, user_objectclass: posixAccount, user_id_attribute: uid, user_name_attribute: uid, group_tree_dn: &apos;ou=groups,dc=test,dc=com&apos;, group_objectclass: posixGroup, group_id_attribute: gidNumber, group_name_attribute: cn, group_member_attribute: memberUid, group_members_are_ids: True&#125;&quot;</span><br><span class="line"></span><br><span class="line">root@juju-67d093-xenial-queens-ldap-2:~# cat /etc/keystone/domains/keystone.aaa_domain.conf</span><br><span class="line">[ldap]</span><br><span class="line">url = ldap://10.5.0.72</span><br><span class="line">user = cn=admin,dc=test,dc=com</span><br><span class="line">password = password</span><br><span class="line">suffix = dc=test,dc=com</span><br><span class="line"></span><br><span class="line">user_allow_create = False</span><br><span class="line">user_allow_update = False</span><br><span class="line">user_allow_delete = False</span><br><span class="line"></span><br><span class="line">group_allow_create = False</span><br><span class="line">group_allow_update = False</span><br><span class="line">group_allow_delete = False</span><br><span class="line"></span><br><span class="line"># User supplied configuration flags</span><br><span class="line">group_id_attribute = gidNumber</span><br><span class="line">group_member_attribute = memberUid</span><br><span class="line">group_members_are_ids = True</span><br><span class="line">group_name_attribute = cn</span><br><span class="line">group_objectclass = posixGroup</span><br><span class="line">group_tree_dn = ou=groups,dc=test,dc=com</span><br><span class="line">query_scope = sub</span><br><span class="line">#user_id_attribute = uidNumber</span><br><span class="line">user_id_attribute = uid</span><br><span class="line">user_name_attribute = uid</span><br><span class="line">user_objectclass = posixAccount</span><br><span class="line">user_tree_dn = dc=test,dc=com</span><br><span class="line">[identity]</span><br><span class="line">driver = ldap</span><br></pre></td></tr></table></figure>
<p>注意， 上面有几个重要参数，注意是group_members_are_ids = True，下面将要着重讲解。<br>query_scope = sub<br>user_tree_dn = dc=test,dc=com<br>user_id_attribute = uid<br>group_members_are_ids = True<br>下面配置也可以work:<br>query_scope = base<br>user_tree_dn = dc=users,test,dc=com<br>user_id_attribute = uid<br>group_members_are_ids = True</p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">source ~/stsstack-bundles/novarcv3_domain</span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line">export OS_USER_DOMAIN_NAME=admin_domain</span><br><span class="line">export OS_AUTH_VERSION=3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_PASSWORD=openstack</span><br><span class="line">export OS_DOMAIN_NAME=admin_domain</span><br><span class="line">export OS_AUTH_URL=http://10.5.0.53:5000/v3</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line"></span><br><span class="line">openstack domain create --description &quot;aaa_domain&quot; aaa_domain</span><br><span class="line">openstack domain list</span><br><span class="line">openstack project create myproject --domain aaa_domain</span><br><span class="line">openstack project list --domain aaa_domain</span><br><span class="line">#The token used to make the request was project scoped but the policy requires [&apos;system&apos;] scope</span><br><span class="line">#so it should be &apos;openstack  group create aaa_group&apos;</span><br><span class="line">#openstack group create aaa_group --domain aaa_domain</span><br><span class="line">#openstack group create aaa_group        #we use the default openstack instead</span><br><span class="line">openstack group list --domain aaa_domain</span><br><span class="line">openstack role list</span><br><span class="line">openstack user list --domain aaa_domain</span><br><span class="line">openstack user list --group openstack --domain aaa_domain</span><br><span class="line"></span><br><span class="line">#Assign Role to a user in a Domain, it used --domain</span><br><span class="line">#openstack role add --user johndoe --domain aaa_domain Member</span><br><span class="line">#Assign Role to a group in a project, it used --group-domain</span><br><span class="line">openstack role add --group openstack --group-domain aaa_domain --project myproject Member</span><br><span class="line">openstack role add --group openstack --group-domain aaa_domain --project myproject Admin</span><br><span class="line">openstack role list --group openstack --group-domain aaa_domain --project myproject</span><br><span class="line"></span><br><span class="line">$ openstack user list --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| 5d15ad6474b1f212d159d974eba4d6b402636e67a7253bf7acb64403ff8c2c53 | janedoe |</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line"></span><br><span class="line">$ openstack group contains user --group-domain aaa_domain --user-domain aaa_domain openstack johndoe</span><br><span class="line">johndoe in group openstack</span><br><span class="line"></span><br><span class="line">source ~/stsstack-bundles/novarcv3_project</span><br><span class="line">export OS_USER_DOMAIN_NAME=aaa_domain</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=aaa_domain</span><br><span class="line">export OS_PROJECT_NAME=myproject</span><br><span class="line">export OS_USERNAME=johndoe</span><br><span class="line">export OS_PASSWORD=crapper</span><br><span class="line">export OS_AUTH_URL=http://10.5.0.72:5000/v3</span><br><span class="line">export OS_AUTH_VERSION=3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user show johndoe</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line">| Field               | Value                                                            |</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line">| domain_id           | ae678292805a4db7917137c0621fe4cc                                 |</span><br><span class="line">| id                  | dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 |</span><br><span class="line">| name                | johndoe                                                          |</span><br><span class="line">| options             | &#123;&#125;                                                               |</span><br><span class="line">| password_expires_at | None                                                             |</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list</span><br><span class="line">You are not authorized to perform the requested action: identity:list_users. (HTTP 403) (Request-ID: req-8c373161-37d7-4d33-9dda-16bdbd2cecb7)</span><br><span class="line"></span><br><span class="line">Why we are not authorized to run &apos;openstack user list&apos;, that&apos;s because the following policy rules.</span><br><span class="line"></span><br><span class="line">&quot;admin_required&quot;: &quot;role:Admin&quot;,</span><br><span class="line">&quot;cloud_admin&quot;: &quot;rule:admin_required and (is_admin_project:True or domain_id:59d6b9c88f654dba9d06772ec1b197f0 or project_id:bbbb856f30b042a9a64d6646273a9ae2)&quot;,</span><br><span class="line">&quot;owner&quot; : &quot;user_id:%(user_id)s or user_id:%(target.token.user_id)s&quot;,</span><br><span class="line">&quot;admin_and_matching_group_domain_id&quot;: &quot;rule:admin_required and domain_id:%(group.domain_id)s&quot;,</span><br><span class="line">&quot;admin_and_matching_domain_id&quot;: &quot;rule:admin_required and domain_id:%(domain_id)s&quot;,</span><br><span class="line"></span><br><span class="line">&quot;identity:get_user&quot;: &quot;rule:cloud_admin or rule:admin_and_matching_target_user_domain_id or rule:owner&quot;,</span><br><span class="line">&quot;identity:list_users&quot;: &quot;rule:cloud_admin or rule:admin_and_matching_domain_id&quot;,</span><br></pre></td></tr></table></figure>
<h2 id="问题一，找不着用户的调试"><a href="#问题一，找不着用户的调试" class="headerlink" title="问题一，找不着用户的调试"></a>问题一，找不着用户的调试</h2><p>找不着用户时, 可查看日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(keystone.common.ldap.core): 2018-06-08 12:13:23,145 DEBUG LDAP bind: who=cn=admin,dc=cloud,dc=sts</span><br><span class="line">(keystone.common.ldap.core): 2018-06-08 12:13:23,145 DEBUG LDAP search: base=dc=cloud,dc=sts scope=2 filterstr=(&amp;(uidNumber=10002)(objectClass=inetOrgPerson)) attrs=[&apos;description&apos;, &apos;uidNumber&apos;, &apos;userPassword&apos;, &apos;enabled&apos;, &apos;mail&apos;, &apos;uid&apos;] attrsonly=0</span><br></pre></td></tr></table></figure></p>
<p>转换成下列命令看是否能运行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapsearch -h 10.5.0.53 -x -b &apos;dc=cloud,dc=sts&apos; -s sub &quot;(&amp;(uidNumber=10002)(objectClass=inetOrgPerson))&quot; description uidNumber userPassword enabled mail uid attrsonly=0</span><br></pre></td></tr></table></figure></p>
<h2 id="问题二，group-members-are-ids-True"><a href="#问题二，group-members-are-ids-True" class="headerlink" title="问题二，group_members_are_ids = True"></a>问题二，group_members_are_ids = True</h2><p>例如本例数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Entry 5: cn=openstack,ou=groups,dc=test,dc=com</span><br><span class="line">dn: cn=openstack,ou=groups,dc=test,dc=com</span><br><span class="line">cn: openstack</span><br><span class="line">gidnumber: 501</span><br><span class="line">memberuid: johndoe</span><br><span class="line">objectclass: posixGroup</span><br><span class="line">objectclass: top</span><br><span class="line"></span><br><span class="line"># Entry 8: cn=johndoe,ou=users,dc=test,dc=com</span><br><span class="line">dn: cn=johndoe,ou=users,dc=test,dc=com</span><br><span class="line">cn: johndoe</span><br><span class="line">gidnumber: 501</span><br><span class="line">givenname: John</span><br><span class="line">homedirectory: /home/users/jdoe</span><br><span class="line">loginshell: /bin/sh</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">objectclass: posixAccount</span><br><span class="line">objectclass: top</span><br><span class="line">sn: John Doe</span><br><span class="line">uid: johndoe</span><br><span class="line">uidnumber: 1000</span><br><span class="line">userpassword: &#123;MD5&#125;HOMR4pM15t3gYd8WUxMG8g==</span><br><span class="line"># password is crapper</span><br></pre></td></tr></table></figure></p>
<p>根据这个bug描述 - <a href="https://bugs.launchpad.net/keystone/+bug/1526462" target="_blank" rel="external">https://bugs.launchpad.net/keystone/+bug/1526462</a><br>我们得知在posixGroup类型的group下可以有很多memberuid属性，如本例中为id的形式：<br>memberuid: johndoe<br>也可能为下列dn的形式：<br>memberuid: johndoe,ou=users,dc=test,dc=com<br>在使用rpdb (import rpdb;rpdb.set_trace())对代码调试(nc 127.0.0.1 4444)时会发现， 当group_members_are_ids=true时，list_group_users就不会再根据dn找id了。<br>同时下面的一个if语句(if group_member_id == user_id)决定配置中得是：user_id_attribute = uid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) p group_member_id</span><br><span class="line">u&apos;johndoe&apos;</span><br><span class="line">(Pdb) p user_id</span><br><span class="line">u&apos;johndoe&apos;</span><br><span class="line">(Pdb) l</span><br><span class="line">142             # work.</span><br><span class="line">143             self.get_user(user_id)</span><br><span class="line">144             import rpdb;rpdb.set_trace()</span><br><span class="line">145             member_list = self.group.list_group_users(group_id)</span><br><span class="line">146             for group_member_id in self._transform_group_member_ids(member_list):</span><br><span class="line">147  -&gt;             if group_member_id == user_id:</span><br><span class="line">148                     break</span><br><span class="line">149             else:</span><br><span class="line">150                 raise exception.NotFound(_(&quot;User &apos;%(user_id)s&apos; not found in&quot;</span><br><span class="line">151                                            &quot; group &apos;%(group_id)s&apos;&quot;) %</span><br><span class="line">152                                          &#123;&apos;user_id&apos;: user_id,</span><br></pre></td></tr></table></figure></p>
<h2 id="问题三，怎么用LDAP里的用户"><a href="#问题三，怎么用LDAP里的用户" class="headerlink" title="问题三，怎么用LDAP里的用户"></a>问题三，怎么用LDAP里的用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">1, Confirm the user johndoe is in the domain aaa_domain</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| 5d15ad6474b1f212d159d974eba4d6b402636e67a7253bf7acb64403ff8c2c53 | janedoe |</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line"></span><br><span class="line">2, Create a project myproject</span><br><span class="line"></span><br><span class="line">openstack project create myproject --domain aaa_domain</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack project list --domain aaa_domain</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| ID                               | Name      |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| f239a9aebc974664b3fb7823d7d873fa | myproject |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line"></span><br><span class="line">3, LDAP has two groups, one is admin, one is openstack, see https://api.jujucharms.com/charmstore/v5/~openstack-charmers/ldap-test-fixture-3/archive/files/backup.ldif</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack group list --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+-----------+</span><br><span class="line">| ID                                                               | Name      |</span><br><span class="line">+------------------------------------------------------------------+-----------+</span><br><span class="line">| a202723c28709cef142842b452fc93caf45d6b661e5d636a96cd10b9379fe0d2 | admin     |</span><br><span class="line">| c94536ce5d46380996999782dacf490b640385cd9b75450782cb279501238eac | openstack |</span><br><span class="line">+------------------------------------------------------------------+-----------+</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --group openstack --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --group admin --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line"></span><br><span class="line">3, Assign Role to a group in a project</span><br><span class="line"></span><br><span class="line">openstack role add --group openstack --project myproject --group-domain aaa_domain Member</span><br><span class="line">openstack role add --group openstack --project myproject --group-domain aaa_domain Admin</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack role list --group openstack --project myproject --group-domain aaa_domain</span><br><span class="line">Listing assignments using role list is deprecated. Use role assignment list --group &lt;group-name&gt; --project &lt;project-name&gt; --names instead.</span><br><span class="line">+----------------------------------+--------+-----------+-----------+</span><br><span class="line">| ID                               | Name   | Project   | Group     |</span><br><span class="line">+----------------------------------+--------+-----------+-----------+</span><br><span class="line">| 578a7eca0d184945b57ed0b718e59ae0 | Member | myproject | openstack |</span><br><span class="line">| 64c64c90886d4f3cb13d3c599748086b | Admin  | myproject | openstack |</span><br><span class="line">+----------------------------------+--------+-----------+-----------+</span><br><span class="line"></span><br><span class="line">4, Confirm the user johndoe in the the domain aaa_domain and group openstack</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --group openstack --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line"></span><br><span class="line">5, Switch to use the user johndoe</span><br><span class="line"></span><br><span class="line">source ~/stsstack-bundles/novarcv3_project</span><br><span class="line">export OS_USER_DOMAIN_NAME=aaa_domain</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=aaa_domain</span><br><span class="line">export OS_PROJECT_NAME=myproject</span><br><span class="line">export OS_USERNAME=johndoe</span><br><span class="line">export OS_PASSWORD=crapper</span><br><span class="line">export OS_AUTH_URL=http://10.5.0.72:5000/v3</span><br><span class="line">export OS_AUTH_VERSION=3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line"></span><br><span class="line">6, Test the user johndoe</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user show johndoe</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line">| Field               | Value                                                            |</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line">| domain_id           | ae678292805a4db7917137c0621fe4cc                                 |</span><br><span class="line">| id                  | dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 |</span><br><span class="line">| name                | johndoe                                                          |</span><br><span class="line">| options             | &#123;&#125;                                                               |</span><br><span class="line">| password_expires_at | None                                                             |</span><br><span class="line">+---------------------+------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list</span><br><span class="line">You are not authorized to perform the requested action: identity:list_users. (HTTP 403) (Request-ID: req-8c373161-37d7-4d33-9dda-16bdbd2cecb7)</span><br><span class="line"></span><br><span class="line">Why we are not authorized to run &apos;openstack user list&apos;, that&apos;s because the following policy rules.</span><br><span class="line"></span><br><span class="line">&quot;admin_required&quot;: &quot;role:Admin&quot;,</span><br><span class="line">&quot;cloud_admin&quot;: &quot;rule:admin_required and (is_admin_project:True or domain_id:59d6b9c88f654dba9d06772ec1b197f0 or project_id:bbbb856f30b042a9a64d6646273a9ae2)&quot;,</span><br><span class="line">&quot;owner&quot; : &quot;user_id:%(user_id)s or user_id:%(target.token.user_id)s&quot;,</span><br><span class="line">&quot;admin_and_matching_group_domain_id&quot;: &quot;rule:admin_required and domain_id:%(group.domain_id)s&quot;,</span><br><span class="line">&quot;admin_and_matching_domain_id&quot;: &quot;rule:admin_required and domain_id:%(domain_id)s&quot;,</span><br><span class="line"></span><br><span class="line">&quot;identity:get_user&quot;: &quot;rule:cloud_admin or rule:admin_and_matching_target_user_domain_id or rule:owner&quot;,</span><br><span class="line">&quot;identity:list_users&quot;: &quot;rule:cloud_admin or rule:admin_and_matching_domain_id&quot;,</span><br><span class="line"></span><br><span class="line">怎么才能让openstack user list生效呢？</span><br><span class="line">1, LDAP中的两个组openstack与admin, johndoe都在这两个组下。</span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --group openstack --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list --group admin --domain aaa_domain</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| ID                                                               | Name    |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">| dcb455d78a9cc380d615fa79c56569b3e9947d9af7a2f83813b53fca198b61a5 | johndoe |</span><br><span class="line">+------------------------------------------------------------------+---------+</span><br><span class="line">2, policy rules中在用project_id:bbbb856f30b042a9a64d6646273a9ae2</span><br><span class="line">所以首先得用admin权限为bbbb856f30b042a9a64d6646273a9ae2这个project添加Admin role：</span><br><span class="line">openstack role add --group admin --project bbbb856f30b042a9a64d6646273a9ae2 --group-domain aaa_domain Admin</span><br><span class="line">其将环境变量得使用这个group：</span><br><span class="line">unset OS_PROJECT_NAME</span><br><span class="line">export OS_PROJECT_ID=bbbb856f30b042a9a64d6646273a9ae2</span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ openstack user list</span><br><span class="line">+----------------------------------+-------------------+</span><br><span class="line">| ID                               | Name              |</span><br><span class="line">+----------------------------------+-------------------+</span><br><span class="line">| 12507a988b8a438e85ee36617302fd34 | neutron           |</span><br><span class="line">| 1b8ad6f6fc4c479a90b7a34c8187cd3b | cinderv2_cinderv3 |</span><br><span class="line">| 2c6d8f3b156c45b5bb7998cca056edc4 | nova_placement    |</span><br><span class="line">| feaaf07467f142a5a5901ab066af9dca | glance            |</span><br><span class="line">+----------------------------------+-------------------+</span><br><span class="line">ubuntu@zhhuabj-bastion:~⟫ env |grep OS_</span><br><span class="line">OS_PROJECT_ID=bbbb856f30b042a9a64d6646273a9ae2</span><br><span class="line">OS_REGION_NAME=RegionOne</span><br><span class="line">OS_USER_DOMAIN_NAME=aaa_domain</span><br><span class="line">OS_AUTH_VERSION=3</span><br><span class="line">OS_IDENTITY_API_VERSION=3</span><br><span class="line">OS_PASSWORD=crapper</span><br><span class="line">OS_AUTH_URL=http://10.5.0.72:5000/v3</span><br><span class="line">OS_USERNAME=johndoe</span><br><span class="line">OS_PROJECT_DOMAIN_NAME=aaa_domain</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/08/Play-with-LDAP-Keystone-by-quqi99/" data-id="cjuhndt5b0005irbpvutwskr8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-回顾OpenStack中的测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/15/回顾OpenStack中的测试/" class="article-date">
  <time datetime="2018-03-15T06:28:01.000Z" itemprop="datePublished">2018-03-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/15/回顾OpenStack中的测试/">回顾OpenStack中的测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-03-15)</strong></p>
<ol>
<li><p>沿用tox调用virtualenv自动创建的虚拟环境(virtualenv -p python3.5 .tox/py35)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source .tox/py35/bin/activate</span><br><span class="line">sudo pip install --upgrade -r requirements.txt</span><br><span class="line">sudo pip install --upgrade -r test-requirements.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用unittest和nose运行测试。nose是对unittest的扩展，使得python的测试更加简单，nose自动发现测试代码并执行，nose提供了大量的插件，比如覆盖报表等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m unittest -v unit_tests.test_neutron_utils.TestNeutronUtils.test_get_packages_ovs_newton</span><br><span class="line">.tox/py35/bin/python nosetests -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_get_packages_ovs_newton</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>注意：上面采用nosetests运行时会报错，因为我们的测试采用了python3, 所以需要在安装了python3-nose之后（sudo apt-get install python3-nose python3-mock）再采用下列三种方式之一运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nosetests3 -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_restart_map_ovs_odl</span><br><span class="line">/bak/work/charms/neutron-gateway/.tox/py35/bin/python /usr/local/bin/nosetests -v unit_tests/test_neutron_utils.py:TestNeutronUtils.test_get_packages_ovs_newton</span><br><span class="line">python -m nose unit_tests/test_neutron_utils.py:TestNeutronUtils.test_restart_map_ovs_odl</span><br></pre></td></tr></table></figure></p>
<p>但实际上仍然找不找nose模块，那是因为nose与virtualenv结合地不大好，在这个网页找着了答案(<a href="https://stackoverflow.com/questions/864956/problems-using-nose-in-a-virtualenv" target="_blank" rel="external">https://stackoverflow.com/questions/864956/problems-using-nose-in-a-virtualenv</a>) - You need to have a copy of nose installed in the virtual environment. In order to force installation of nose into the virtualenv, even though it is already installed in the global site-packages, run pip install with the -I flag: pip install nose -I</p>
<ol>
<li><p>上面使用unittest与nose运行测试的方式只是将结果输出到stdout，不便于分析。所以可以使用python-subunit模块来运行测试，并将测试结果通过subunit协议输出到文件中便于日后分析。因为subunit是基于二进制的不便于人眼看，所以可使用subunit2pyunit工具将其人类可读化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m subunit.run discover |subunit2pyunit</span><br><span class="line">python -m subunit.run discover -t ./ ./unit_tests |subunit2pyunit</span><br><span class="line">python -m subunit.run unit_tests.test_neutron_utils.TestNeutronUtils. |subunit2pyunit</span><br></pre></td></tr></table></figure>
</li>
<li><p>在大型应用中分析测试结果很重要，testrepository可以调用subunit来用python-subunit模块来运行测试，并将测试结果通过subunit协议输出到文件中，然后testrepository在些基础上有更多的分析，如分析哪些用例运行的时间最长，如显示失败的用例，如仅运行上次运行失败的用例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testr init</span><br><span class="line">testr run</span><br><span class="line">testr run --parallel</span><br><span class="line">$ cat .testr.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">test_command=OS_STDOUT_CAPTURE=$&#123;OS_STDOUT_CAPTURE:-1&#125; \</span><br><span class="line">             OS_STDERR_CAPTURE=$&#123;OS_STDERR_CAPTURE:-1&#125; \</span><br><span class="line">             OS_TEST_TIMEOUT=$&#123;OS_TEST_TIMEOUT:-60&#125; \</span><br><span class="line">             $&#123;PYTHON:-python&#125; -m subunit.run discover -t ./ ./unit_tests $LISTOPT $IDOPTION</span><br><span class="line">test_id_option=--load-list $IDFILE</span><br><span class="line">test_list_option=--list</span><br></pre></td></tr></table></figure>
</li>
<li><p>tox用于创建虚拟python环境，也可以集成上面的testrepository(commands = ostestr {posargs})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ cat tox.ini</span><br><span class="line">[tox]</span><br><span class="line">envlist = pep8,py27,py35</span><br><span class="line">skipsdist = True</span><br><span class="line"></span><br><span class="line">[testenv]</span><br><span class="line">setenv = VIRTUAL_ENV=&#123;envdir&#125;</span><br><span class="line">         PYTHONHASHSEED=0</span><br><span class="line">         CHARM_DIR=&#123;envdir&#125;</span><br><span class="line">         AMULET_SETUP_TIMEOUT=5400</span><br><span class="line">install_command =</span><br><span class="line">  pip install --allow-unverified python-apt &#123;opts&#125; &#123;packages&#125;</span><br><span class="line">commands = ostestr &#123;posargs&#125;</span><br><span class="line">whitelist_externals = juju</span><br><span class="line">passenv = HOME TERM AMULET_* CS_API_*</span><br><span class="line"></span><br><span class="line">[testenv:py27]</span><br><span class="line">basepython = python2.7</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line">commands = /bin/true</span><br><span class="line"></span><br><span class="line">[testenv:py35]</span><br><span class="line">basepython = python3.5</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line"></span><br><span class="line">[testenv:pep8]</span><br><span class="line">basepython = python2.7</span><br><span class="line">deps = -r&#123;toxinidir&#125;/requirements.txt</span><br><span class="line">       -r&#123;toxinidir&#125;/test-requirements.txt</span><br><span class="line">commands = flake8 &#123;posargs&#125; hooks unit_tests tests actions lib</span><br><span class="line">           charm-proof</span><br><span class="line"></span><br><span class="line">[flake8]</span><br><span class="line">ignore = E402,E226</span><br><span class="line">exclude = */helpers</span><br></pre></td></tr></table></figure>
</li>
<li><p>pydev使用virtualenv中的py35</p>
<p>在eclipse的”Preferences -&gt; Pydev -&gt; Interpreters -&gt; Python Interpreters”菜单中定义python35=/bak/work/charms/neutron-gateway/.tox/py35/bin/python,然后在工程上点右键从”Properties -&gt; Pydev - Interpreter/Grammar”定义使用python35。注意，需要将/bak/work/charms/neutron-gateway/.tox/py35/lib/python3.5/site-packages也选到环境变量中，否则后面会报ImportError: No module named ‘mock。<br>为一个测试类定义”Python unitest”类型的”Debug Configurations”, 也在其Interpreter选项卡中定义使用python35 (结果：eclipse似乎有bug，此处选择了python35后无法保存)<br>所以无法成功，似乎是pydev与python3协作不大好。最后还是pudb好使(sudo pip install pudb, import pudb; pdb.set_trace())</p>
</li>
<li><p>py27下的测试运行方法(如openstack), charm似乎只能用py35</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat tox.ini</span><br><span class="line">tox -r -epy27</span><br><span class="line">tox -e py27,pep8</span><br><span class="line">tox -e py27 neutron.tests.unit.agent.linux.test_keepalived</span><br><span class="line">tox -e py27 neutron.tests.unit.agent.linux.test_keepalived.KeepalivedInstanceTestCase.test_remove_addresses_by_interface</span><br><span class="line">mkdir /opt/stack &amp;&amp; sudo chown -R hua /opt/stack</span><br><span class="line">tox -e functional neutron.tests.functional.agent.l3.test_ha_router.L3HATestCase.test_keepalived_configuration</span><br><span class="line">tox -e dsvm-fullstack</span><br><span class="line">source .tox/functional/bin/activate</span><br><span class="line">.tox/functional/bin/pip install -r requirements.txt</span><br><span class="line">.tox/functional/bin/pip install -r test-requirements.txt</span><br><span class="line">.tox/functional/bin/pip install -r neutron/tests/functional/requirements.txt</span><br><span class="line">.tox/functional/bin/pip freeze |grep neutron</span><br><span class="line">.tox/functional/bin/pip install &apos;neutron-lib==1.13.0&apos;</span><br><span class="line">OS_SUDO_TESTING=True .tox/functional/bin/python -m unittest -v neutron.tests.functional.agent.l3.test_ha_router.L3HATestCase.test_keepalived_configuration</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>有时如mitaka已经eol了, 例如它的origain-stable-mitaka这个分支都没有了, 这会导致运行’tox -r -epy27 ‘不成功, 那么可以手工执行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">virtualenv venv</span><br><span class="line">. venv/bin/activate</span><br><span class="line"></span><br><span class="line"># pg_config executable not found</span><br><span class="line"># Error: could not determine PostgreSQL version from &apos;10.5&apos;</span><br><span class="line">sudo apt install python-setuptools python-dev libpython-dev libssl-dev python-pip libmysqlclient-dev libxml2-dev libxslt-dev libxslt1-dev libpq-dev git git-review libffi-dev gettext graphviz libjpeg-dev zlib1g-dev build-essential python-nose python-mock libssl1.0</span><br><span class="line">sudo apt install python3.6 python3.6-dev python3-pip python3-dev python3-nose python3-mock</span><br><span class="line">#sudo pip install --upgrade setuptools</span><br><span class="line">#sudo pip3 install --upgrade setuptools</span><br><span class="line">#sudo pip install --upgrade --force-reinstall pip virtualenv</span><br><span class="line"></span><br><span class="line"># Failed to install Cryptography - sudo apt install libssl1.0</span><br><span class="line"># No module named dulwich - ./venv/bin/pip install dulwich</span><br><span class="line"># unittest has no attribute &apos;virt&apos; -</span><br><span class="line">./venv/bin/pip install -c https://git.openstack.org/cgit/openstack/requirements/plain/upper-constraints.txt?h=mitaka-eol .</span><br><span class="line">./venv/bin/pip install -r requirements.txt</span><br><span class="line">./venv/bin/pip install -r test-requirements.txt</span><br><span class="line"></span><br><span class="line">find . -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">git clone https://github.com/openstack/oslo.cache.git</span><br><span class="line">cd oslo.cache &amp;&amp; git checkout -b mitaka mitaka-eol</span><br><span class="line">../nova/venv/bin/pip install -r requirements.txt</span><br><span class="line">../nova/venv/bin/pip install -r test-requirements.txt</span><br><span class="line"></span><br><span class="line"># dogpile can&apos;t cannot import name threading - venv/bin/pip uninstall dogpile.cache dogpile &amp;&amp; venv/bin/pip install dogpile.cache</span><br><span class="line">venv/bin/python -m subunit.run discover ./nova/tests/unit/compute |subunit2pyunit</span><br><span class="line">venv/bin/python -m subunit.run nova.tests.unit.compute.test_compute |subunit2pyunit</span><br><span class="line">venv/bin/python -m subunit.run nova.tests.unit.compute.test_compute.ComputeAPITestCase.test_attach_volume |subunit2pyunit</span><br><span class="line">venv/bin/python -m unittest -v nova.tests.unit.compute.test_compute  #make sure the package nova.tests.virt exists</span><br><span class="line"></span><br><span class="line">#venv/bin/pep8</span><br><span class="line">venv/bin/flake8</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/15/回顾OpenStack中的测试/" data-id="cjuhndt5u000oirbp8t7darjd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Libvirt支持的三种CPU模式与热迁移-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/09/Libvirt支持的三种CPU模式与热迁移-by-Joshua/" class="article-date">
  <time datetime="2018-03-09T03:42:14.000Z" itemprop="datePublished">2018-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/09/Libvirt支持的三种CPU模式与热迁移-by-Joshua/">Libvirt支持的三种CPU模式与热迁移(by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-03-09)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>原始的nova配置(cpu_mode=”host-passthrough”)导致无法热迁移，改成(cpu_mode=”custom”, cpu_model=”kvm64”)之后解决了热迁移问题但是嵌套虚拟化又不好便了，接着又改成(cpu_mode=’host-model’)但热迁移仍然失败。有两全其美的方法吗？</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">1, working solution was to create a custom CPU definition in /usr/share/libvirt/cpu_map.xml called SandyBridge-vmx, which contained the full feature flags for that CPU, not just the subset that differs from Westmere/etc., and includes the needed &apos;vmx&apos; feature for nested kvm</span><br><span class="line">&lt;model name=&apos;SandyBridge-vmx&apos;&gt;</span><br><span class="line">&lt;vendor name=&apos;Intel&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;aes&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;apic&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;avx&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;clflush&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;cmov&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;cx16&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;cx8&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;de&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;fpu&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;fxsr&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;lahf_lm&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;lm&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;mca&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;mce&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;mmx&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;msr&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;mtrr&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;nx&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pae&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pat&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pclmuldq&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pge&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pni&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;popcnt&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pse&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;pse36&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;rdtscp&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;sep&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;sse&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;sse2&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;sse4.1&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;sse4.2&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;ssse3&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;syscall&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;tsc&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;tsc-deadline&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;x2apic&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;xsave&apos;/&gt;</span><br><span class="line">&lt;feature name=&apos;vmx&apos;/&gt;</span><br><span class="line">&lt;/model&gt;</span><br><span class="line"></span><br><span class="line">2, And in /etc/nova/nova.conf, we use:</span><br><span class="line">$ sudo grep ^cpu_m /etc/nova/nova.conf</span><br><span class="line">cpu_mode = custom</span><br><span class="line">cpu_model = SandyBridge-vmx</span><br></pre></td></tr></table></figure>
<h2 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h2><p>Libvirt主要支持三种 CPU mode：</p>
<ol>
<li>host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。</li>
<li>host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 /usr/share/libvirt/cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。</li>
<li>custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。</li>
<li>三种mode的性能排序是：host-passthrough &gt; host-model &gt; custom</li>
<li>三种mode的热迁移通用性是： custom &gt; host-model &gt; host-passthrough</li>
</ol>
<p>实际环境中多采用Intel E5系列的CPU，但是该系列的CPU也有多种型号，常见的有Xeon，Haswell，IvyBridge，SandyBridge等等。即使是host-model，在这些不同型号的CPU之间热迁移虚拟机也可能失败。所以从热迁移的角度，在选择 host-mode时：</p>
<ul>
<li>需要充分考虑既有宿主机类型，以后采购扩容时，也需要考虑相同问题</li>
<li>除非不存在热迁移的场景，否则不应用选择host-passthrough</li>
<li><p>host-model下不同型号的 CPU 最好能以aggregate hosts划分，在迁移时可以使用aggregate filter来匹配相同型号的物理机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openstack aggregate create Broadwell</span><br><span class="line">openstack aggregate create Haswell</span><br><span class="line">openstack aggregate set --property cpu=broadwell Broadwell</span><br><span class="line">openstack aggregate set --property cpu=haswell Haswell</span><br><span class="line">opentack aggregate add host &lt;host1&gt; Haswell</span><br><span class="line">openstack flavor set --property aggregate_instance_extra_specs:cpu=broadwell &lt;flavor1&gt;</span><br><span class="line">openstack flavor set --property aggregate_instance_extra_specs:cpu=haswell &lt;flavor2&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果CPU型号过多，且不便用aggregate hosts划分，建议使用custom mode</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/09/Libvirt支持的三种CPU模式与热迁移-by-Joshua/" data-id="cjuhndt590003irbp6pech282" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenStack-SSL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/07/OpenStack-SSL/" class="article-date">
  <time datetime="2018-02-07T05:25:04.000Z" itemprop="datePublished">2018-02-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/07/OpenStack-SSL/">OpenStack SSL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07)</strong></p>
<h2 id="OpenStack-Charm如何支持SSL"><a href="#OpenStack-Charm如何支持SSL" class="headerlink" title="OpenStack Charm如何支持SSL"></a>OpenStack Charm如何支持SSL</h2><p>OpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoint，同时也会生成/etc/apache2/ssl/keystone配置。</p>
<ol>
<li><p>一种方式有证书就直接指定证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju config &lt;openstack-charm&gt; os-admin-hostname=&apos;X.xxx.com&apos; os-public-hostname=&apos;X.xxx.com&apos; os-internal-hostname=&apos;X.xxx.com&apos; ssl_ca=&apos;$cat ~/ssl_ca.crt&apos; ssl_cert=&apos;$cat ~/ssl_cert.crt&apos; ssl_key=&apos;&apos;$cat ~/ssl_key.key&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式是由charm来自动生成证书。如果用户没有指定ssl_cert与ssl_key，那么is_cert_provided_in_config=False，charm将自动生成证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def is_cert_provided_in_config():</span><br><span class="line">    cert = config(&apos;ssl_cert&apos;)</span><br><span class="line">    key = config(&apos;ssl_key&apos;)</span><br><span class="line">    return bool(cert and key)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体命令如下，也可参考：<a href="https://paste.ubuntu.com/26533565/" target="_blank" rel="external">https://paste.ubuntu.com/26533565/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">juju config keystone use-https=true</span><br><span class="line">juju config keystone https-service-endpoints=true</span><br><span class="line">tree /var/lib/keystone/juju_ssl/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/keystone/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/nova/  #on nova node</span><br><span class="line">select * from endpoint;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-ids identity-service&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-list -r identity-service:13&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-get -r identity-service:13 - nova-cloud-controller/0&quot;</span><br><span class="line"></span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_PASSWORD=openstack</span><br><span class="line">export OS_AUTH_URL=https://10.5.0.28:5000/v2.0</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">openstack --insecure endpoint list</span><br><span class="line">openstack --insecure server list</span><br><span class="line">openstack --insecure --debug server list</span><br><span class="line">openstack --insecure --debug volume list</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-HA-Charm如何支持SSL"><a href="#OpenStack-HA-Charm如何支持SSL" class="headerlink" title="OpenStack HA Charm如何支持SSL"></a>OpenStack HA Charm如何支持SSL</h2><p>如果如nova-cloud-controller服务前又运行了下列命令添加了HA服务时呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju add-unit nova-cloud-controller -n 2  </span><br><span class="line">juju deploy hacluster ncc-hacluster --series xenial  </span><br><span class="line">juju add-relation nova-cloud-controller ncc-hacluster  </span><br><span class="line">juju config nova-cloud-controller vip=10.5.104.1</span><br></pre></td></tr></table></figure></p>
<p>corosync将通过下列配置将VIP=10.5.104.1创建在juju-2f3cc6-mitaka-10上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# crm status</span><br><span class="line">Last updated: Wed Feb  7 04:18:31 2018		Last change: Wed Feb  7 04:09:33 2018 by hacluster via crmd on juju-2f3cc6-mitaka-10</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: juju-2f3cc6-mitaka-6 (version 1.1.14-70404b0) - partition with quorum</span><br><span class="line">3 nodes and 4 resources configured</span><br><span class="line">Online: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> Resource Group: grp_nova_vips</span><br><span class="line">     res_nova_ens3_vip	(ocf::heartbeat:IPaddr2):	Started juju-2f3cc6-mitaka-10</span><br><span class="line"> Clone Set: cl_nova_haproxy [res_nova_haproxy]</span><br><span class="line">     Started: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line"></span><br><span class="line">root@juju-2f3cc6-mitaka-10:~# ip addr show ens3 |grep 10.5.104.1</span><br><span class="line">    inet 10.5.104.1/16 brd 10.5.255.255 scope global secondary ens3</span><br></pre></td></tr></table></figure></p>
<p>同时，三个HA节点上的haproxy的配置(/etc/haproxy/haproxy.cfg)将创建代理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend tcp-in_nova-api-os-compute</span><br><span class="line">    bind *:8774</span><br><span class="line">    bind :::8774</span><br><span class="line">    acl net_10.5.0.15 dst 10.5.0.15/255.255.0.0</span><br><span class="line">    use_backend nova-api-os-compute_10.5.0.15 if net_10.5.0.15</span><br><span class="line">    default_backend nova-api-os-compute_10.5.0.15</span><br><span class="line">backend nova-api-os-compute_10.5.0.15</span><br><span class="line">    balance leastconn</span><br><span class="line">    server nova-cloud-controller-1 10.5.0.15:8764 check</span><br><span class="line">    server nova-cloud-controller-0 10.5.0.37:8764 check</span><br><span class="line">    server nova-cloud-controller-2 10.5.0.52:8764 check</span><br></pre></td></tr></table></figure></p>
<p>最重要的是，三个HA节点上Apache都将设置代理“RequestHeader set X-Forwarded-Proto “https””，完整的配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# cat /etc/apache2/sites-available/openstack_https_frontend.conf </span><br><span class="line">Listen 8764</span><br><span class="line">&lt;VirtualHost 10.5.0.15:8764&gt;</span><br><span class="line">    ServerName 10.5.104.1</span><br><span class="line">    SSLEngine on</span><br><span class="line">    SSLProtocol +TLSv1 +TLSv1.1 +TLSv1.2</span><br><span class="line">    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!EXP:!LOW:!MEDIUM</span><br><span class="line">    SSLCertificateFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    # See LP 1484489 - this is to support &lt;= 2.4.7 and &gt;= 2.4.8</span><br><span class="line">    SSLCertificateChainFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    SSLCertificateKeyFile /etc/apache2/ssl/nova/key_10.5.104.1</span><br><span class="line">    ProxyPass / http://localhost:8754/</span><br><span class="line">    ProxyPassReverse / http://localhost:8754/</span><br><span class="line">    ProxyPreserveHost on</span><br><span class="line">    RequestHeader set X-Forwarded-Proto &quot;https&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">    Order deny,allow</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-Horizon和Apache代理之间如何支持SSL"><a href="#OpenStack-Horizon和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack Horizon和Apache代理之间如何支持SSL"></a>OpenStack Horizon和Apache代理之间如何支持SSL</h2><p>openstack horizon使用了Django框架，Django中有如下代码（<a href="https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），" target="_blank" rel="external">https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property</span><br><span class="line">def scheme(self):</span><br><span class="line">    if settings.SECURE_PROXY_SSL_HEADER:</span><br><span class="line">        try:</span><br><span class="line">            header, value = settings.SECURE_PROXY_SSL_HEADER</span><br><span class="line">        except ValueError:</span><br><span class="line">            raise ImproperlyConfigured(</span><br><span class="line">                &apos;The SECURE_PROXY_SSL_HEADER setting must be a tuple containing two values.&apos;</span><br><span class="line">            )</span><br><span class="line">        if self.META.get(header) == value:</span><br><span class="line">            return &apos;https&apos;</span><br><span class="line">    return self._get_scheme()</span><br></pre></td></tr></table></figure>
<p>它会根据django中是否配置了SECURE_PROXY_SSL_HEADER，然后比较和header中传过来的SECURE_PROXY_SSL_HEADER(self.META.get(header))是否相等, 若相等才返回https给前端代理。所以这说明需要做两件事情：</p>
<ol>
<li>一是在django的conf/global_settings.py模板中配置： SECURE_PROXY_SSL_HEADER = (‘HTTP_X_FORWARDED_PROTO’, ‘https’)</li>
<li>二是前端代理apache中的配置传过来名为X-Forwarded-Proto的header: RequestHeader set X-Forwarded-Proto “https”<br>更多见： <a href="https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/" target="_blank" rel="external">https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/</a></li>
</ol>
<h2 id="OpenStack其他工程和Apache代理之间如何支持SSL"><a href="#OpenStack其他工程和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack其他工程和Apache代理之间如何支持SSL"></a>OpenStack其他工程和Apache代理之间如何支持SSL</h2><p>至于其它openstack工程如nova则需要使用olso.middleware中的http_proxy_to_wsgi.py(<a href="https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto" target="_blank" rel="external">https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># World before RFC7239</span><br><span class="line">forwarded_proto = req.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">if forwarded_proto:</span><br><span class="line">    req.environ[&apos;wsgi.url_scheme&apos;] = forwarded_proto</span><br></pre></td></tr></table></figure></p>
<p>nova-api中再根据wsgi.url_scheme（<a href="https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443" target="_blank" rel="external">https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if environ[&apos;wsgi.url_scheme&apos;] == &apos;http&apos;:</span><br><span class="line">    port = &apos;80&apos;</span><br><span class="line">else:</span><br><span class="line">    port = &apos;443&apos;</span><br></pre></td></tr></table></figure></p>
<p>配置http_proxy_to_wsgi的方法是在/etc/nova/api-paste.ini中添加http_proxy_to_wsgi（ eg: <a href="https://bugs.launchpad.net/keystone/+bug/1590608" target="_blank" rel="external">https://bugs.launchpad.net/keystone/+bug/1590608</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[composite:openstack_compute_api_v21]</span><br><span class="line">use = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line">noauth2 = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit noauth2 osapi_compute_app_v21</span><br><span class="line">keystone = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line">[filter:http_proxy_to_wsgi]</span><br><span class="line">paste.filter_factory = oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory</span><br></pre></td></tr></table></figure>
<h2 id="附录-原生OpenStack配置SSL的方法"><a href="#附录-原生OpenStack配置SSL的方法" class="headerlink" title="附录 - 原生OpenStack配置SSL的方法"></a>附录 - 原生OpenStack配置SSL的方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1, Create ssl certifate</span><br><span class="line"></span><br><span class="line">$ sudo keystone-manage ssl_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">$ chown -R keystone:keystone /etc/keystone/ssl</span><br><span class="line">$ sudo ls /etc/keystone/ssl/certs</span><br><span class="line">01.pem	ca.pem	index.txt  index.txt.attr  index.txt.old  keystone.pem	openssl.conf  req.pem  serial  serial.old</span><br><span class="line">$ sudo ls /etc/keystone/ssl/private</span><br><span class="line">cakey.pem  keystonekey.pem</span><br><span class="line"></span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/cakey.pem 1024</span><br><span class="line">openssl req -new -x509 -extensions v3_ca -key /etc/keystone/ssl/private/cakey.pem -out /etc/keystone/ssl/certs/ca.pem -days 3650 -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/keystonekey.pem 1024</span><br><span class="line">openssl req -key /etc/keystone/ssl/private/keystonekey.pem -new -out /etc/keystone/ssl/certs/req.pem -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl ca -batch -out /etc/keystone/ssl/certs/keystone.pem -config /etc/keystone/ssl/certs/openssl.conf -days 3650d -cert /etc/keystone/ssl/certs/ca.pem -keyfile /etc/keystone/ssl/private/cakey.pem -infiles /etc/keystone/ssl/certs/req.pem</span><br><span class="line"></span><br><span class="line">2, Keystone ssl configuration</span><br><span class="line"></span><br><span class="line"># vi /etc/keystone/keystone.conf</span><br><span class="line">[signing]</span><br><span class="line">certfile = /var/lib/keystone/juju_ssl/pki/certs/signing_cert.pem</span><br><span class="line">keyfile = /var/lib/keystone/juju_ssl/pki/privates/signing_key.pem</span><br><span class="line">ca_certs = /var/lib/keystone/juju_ssl/pki/certs/ca.pem</span><br><span class="line">ca_key = /var/lib/keystone/juju_ssl/pki/certs/ca_key.pem</span><br><span class="line"></span><br><span class="line">export OS_AUTH_URL=https://&#123;keystoneHost&#125;:5000/v2.0</span><br><span class="line"></span><br><span class="line"># create new https endpoint</span><br><span class="line">keystone endpoint-create</span><br><span class="line">--service keystone --region RegionOne --publicurl</span><br><span class="line">https://&#123;keystoneHost&#125;:5000/v2.0 --internalurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0 --adminurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0</span><br><span class="line"></span><br><span class="line"># delete old http endpoint</span><br><span class="line">keystone –-insecure endpoint-delete &#123;old endpoint id&#125;</span><br><span class="line"></span><br><span class="line">3, Nova ssl configuration</span><br><span class="line"></span><br><span class="line"># configure nova to use https to connect keystone</span><br><span class="line"># vi /etc/nova/api-paste.ini</span><br><span class="line">auth_uri = https://10.1.0.92:5000/v2.0</span><br><span class="line">auth_protocol = https</span><br><span class="line">insecure = True</span><br><span class="line"></span><br><span class="line">service openstack-nova-api restart</span><br><span class="line">service openstack-nova-compute restart</span><br><span class="line">service openstack-nova-scheduler restart</span><br><span class="line">service openstack-nova-cert restart</span><br><span class="line">service openstack-nova-conductor restart</span><br><span class="line">service openstack-nova-consoleauth restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vi /etc/nova/nova.conf [DEFAULT]</span><br><span class="line">enabled_ssl_apis=osapi_compute</span><br><span class="line">ssl_cert_file=/etc/nova/ssl/keystone.pem</span><br><span class="line">ssl_key_file=/etc/nova/ssl/keystonekey.pem</span><br><span class="line"></span><br><span class="line"># test it, at this time other component has not be configured to use https, so use --insecure</span><br><span class="line">nova --insecure hypervisor-list</span><br><span class="line"></span><br><span class="line"># copy ssl certifate for nova</span><br><span class="line"># mkdir /etc/nova/ssl</span><br><span class="line"># cp /etc/keystone/ssl/certs/keystone.pem /etc/nova/ssl/</span><br><span class="line"># cp /etc/keystone/ssl/private/keystonekey.pem /etc/nova/ssl/</span><br><span class="line"># chown -R nova:nova /etc/nova/ssl/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># create new https endpoint for nova</span><br><span class="line"># keystone --insecure</span><br><span class="line">endpoint-create --service nova --region RegionOne --publicurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --internalurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --adminurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/07/OpenStack-SSL/" data-id="cjuhndt560001irbpn4tzkxli" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Set-up-juju-development-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/06/Set-up-juju-development-env/" class="article-date">
  <time datetime="2018-02-06T03:22:39.000Z" itemprop="datePublished">2018-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/06/Set-up-juju-development-env/">Set up juju development env</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="Install-GO"><a href="#Install-GO" class="headerlink" title="Install GO"></a>Install GO</h2><p>It can’t find context package when using go-1.6 (usr/lib/go-1.6/src/context (from $GOROOT)), so switch to go &gt; 1.8.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#sudo apt upgrade golang</span><br><span class="line">wget https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz</span><br><span class="line">sudo rm -rf /usr/lib/go &amp;&amp; sudo tar -C /usr/lib -xzf go1.10.3.linux-amd64.tar.gz</span><br><span class="line">#注意：系统包更新后，如更新为go-1.10，那么GOROOT也要相应更新，否则报很多错</span><br><span class="line">export GOROOT=/usr/lib/go</span><br><span class="line">export GOPATH=/bak/golang</span><br><span class="line">export PATH=$GOROOT/bin:$GOPATH/bin:$PATH</span><br></pre></td></tr></table></figure></p>
<h2 id="Install-juju-from-source-code"><a href="#Install-juju-from-source-code" class="headerlink" title="Install juju from source code"></a>Install juju from source code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go get -d -v github.com/juju/juju/...</span><br><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">make install-dependencies</span><br><span class="line"># may fail because of the lack of some packages caused by gfw, you can fix it by &apos;go get ...&apos; one by one</span><br><span class="line">go install -v github.com/juju/juju/...</span><br><span class="line"></span><br><span class="line">go get github.com/rogpeppe/godeps</span><br><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">godeps -u dependencies.tsv</span><br></pre></td></tr></table></figure>
<h2 id="Prepare-LXD"><a href="#Prepare-LXD" class="headerlink" title="Prepare LXD"></a>Prepare LXD</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /var/lib/lxd</span><br><span class="line">sudo rm -rf /home/hua/.config/lxc/</span><br><span class="line">sudo apt install lxd zfsutils-linux bridge-utils squid-deb-proxy</span><br><span class="line">sudo mkdir -p /images/lxd &amp;&amp; sudo ln -s /images/lxd /var/lib/lxd/containers</span><br><span class="line">sudo systemctl enable lxd</span><br><span class="line">sudo systemctl start lxd</span><br><span class="line">newgrp lxd</span><br><span class="line">sudo usermod -a -G lxd hua</span><br><span class="line">sudo lxd init</span><br><span class="line">sudo chown -R root:lxd /var/lib/lxd</span><br></pre></td></tr></table></figure>
<h2 id="Create-juju-controller"><a href="#Create-juju-controller" class="headerlink" title="Create juju controller"></a>Create juju controller</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#https://jujucharms.com/docs/2.0/controllers-creating</span><br><span class="line">#https://api.jujucharms.com/charmstore/v5/~james-page/openstack-on-lxd/archive</span><br><span class="line">sudo lxc profile create juju-controller</span><br><span class="line">cat /bak/golang/jujudata/lxd-profile.yaml |sudo lxc profile edit juju-controller</span><br><span class="line">$ cat /bak/golang/jujudata/lxd-profile.yaml</span><br><span class="line">name: juju-controller</span><br><span class="line">config:</span><br><span class="line">  boot.autostart: &quot;true&quot;</span><br><span class="line">  security.nesting: &quot;true&quot;</span><br><span class="line">  security.privileged: &quot;true&quot;</span><br><span class="line">  linux.kernel_modules: openvswitch,nbd,ip_tables,ip6_tables</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    mtu: &quot;9000&quot;</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: lxdbr0</span><br><span class="line">    type: nic</span><br><span class="line">  eth1:</span><br><span class="line">    mtu: &quot;9000&quot;</span><br><span class="line">    name: eth1</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: lxdbr0</span><br><span class="line">    type: nic</span><br><span class="line">  kvm:</span><br><span class="line">    path: /dev/kvm</span><br><span class="line">    type: unix-char</span><br><span class="line">  mem:</span><br><span class="line">    path: /dev/mem</span><br><span class="line">    type: unix-char</span><br><span class="line">  root:</span><br><span class="line">    path: /</span><br><span class="line">    type: disk</span><br><span class="line">  tun:</span><br><span class="line">    path: /dev/net/tun</span><br><span class="line">    type: unix-char</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=xenial --config agent-stream=devel localhost juju-controller</span><br><span class="line">sudo lxc exec juju-bf76c2-0 bash</span><br></pre></td></tr></table></figure>
<h2 id="Set-up-development-env"><a href="#Set-up-development-env" class="headerlink" title="Set up development env"></a>Set up development env</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH/src/github.com/juju/juju</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br><span class="line">git config --global user.email &quot;xxx&quot;</span><br><span class="line">ln -s ../../scripts/pre-push.bash .git/hooks/pre-push</span><br><span class="line">#https://segmentfault.com/a/1190000002783245</span><br><span class="line">git remote -v</span><br><span class="line">git pull upstream master</span><br><span class="line">git checkout -b new_feature</span><br><span class="line">go test github.com/juju/juju/...</span><br><span class="line">go fmt</span><br><span class="line">#JUJU_NOTEST_MONGOJS=1 go test github.com/juju/juju/...</span><br><span class="line">git config --global push.default &apos;nothing&apos;</span><br><span class="line">git rebase master</span><br><span class="line">#git push origin new_feature</span><br><span class="line">$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">        repositoryformatversion = 0</span><br><span class="line">        filemode = true</span><br><span class="line">        bare = false</span><br><span class="line">        logallrefupdates = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">        url = git@github.com:&lt;launchpad-id&gt;/juju.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch &quot;master&quot;]</span><br><span class="line">        remote = upstream</span><br><span class="line">        merge = refs/heads/master</span><br><span class="line">[remote &quot;upstream&quot;]</span><br><span class="line">        url = https://github.com/juju/juju.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/upstream/*</span><br></pre></td></tr></table></figure>
<p>这是一个典型的使用github pull request模式开发的例子，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># First click &apos;Fork&apos; button to fork - https://github.com/zhhuabj/openstack_understand_Neutron</span><br><span class="line">git clone git@github.com:zhhuabj/openstack_understand_Neutron.git</span><br><span class="line">cd openstack_understand_Neutron</span><br><span class="line">git config user.name &quot;zhhuabj&quot;</span><br><span class="line">git config user.email veryhua2006@gmail.com</span><br><span class="line"></span><br><span class="line">#do some change on the content</span><br><span class="line">git commit -am &quot;Fix issue #1: change helo to hello&quot;</span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line">#pull request</span><br><span class="line"></span><br><span class="line">#Update own fork</span><br><span class="line">git remote add upstream https://github.com/yeasy/openstack_understand_Neutron</span><br><span class="line">git fetch upstream</span><br><span class="line">git checkout master</span><br><span class="line">git rebase upstream/master</span><br><span class="line">git push -f origin master</span><br></pre></td></tr></table></figure></p>
<p>也可使用Shared Repository Model提交PR，见：<a href="https://gist.github.com/seshness/3943237" target="_blank" rel="external">https://gist.github.com/seshness/3943237</a></p>
<h2 id="附录-如何创建Go开发环境"><a href="#附录-如何创建Go开发环境" class="headerlink" title="附录 - 如何创建Go开发环境"></a>附录 - 如何创建Go开发环境</h2><p>1, GOPATH不需要配置多个(它可以配置多个，但不需要)，只配置一个即可。如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export GOROOT=/usr/lib/go-1.8</span><br><span class="line">export GOPATH=/bak/golang</span><br></pre></td></tr></table></figure></p>
<p>2, 下面开始配置我的第一个Go工程ss，<strong>将它放在$GOPATH/src/github.com/zhhuabj目录下</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /bak/golang/src/github.com/zhhuabj/ &amp;&amp; mkdir ss</span><br></pre></td></tr></table></figure></p>
<p>3, 使用govendor配置包依赖，使用govendor之后，优先从$GOPATH/src/github.com/zhhuabj/ss/vendor目录下找包，如果没有，才到$GOPATH/src目录下去找。‘govendor init’命令需在$GOPATH/src/github.com/zhhuabj/ss目录下执行，故：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get -u -v github.com/kardianos/govendor</span><br><span class="line">cd ss &amp;&amp; govendor init</span><br></pre></td></tr></table></figure></p>
<p>4, 使用govendor配置本工程需要用到的其他包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/mitchellh/go-homedir</span><br><span class="line">go get github.com/phayes/freeport</span><br><span class="line">govendor add github.com/mitchellh/go-homedir</span><br><span class="line">govendor add github.com/phayes/freeport</span><br><span class="line"></span><br><span class="line">hua@t440p:/bak/golang/src/github.com/zhhuabj/ss$ govendor list -v</span><br><span class="line"> vu github.com/mitchellh/go-homedir ::/vendor/github.com/mitchellh/go-homedir</span><br><span class="line"> vu github.com/phayes/freeport ::/vendor/github.com/phayes/freeport</span><br></pre></td></tr></table></figure></p>
<p>5, 编译并运行测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#/usr/lib/go-1.8/bin/go install -v -gcflags &quot;-N -l&quot; github.com/zhhuabj/ss/...</span><br><span class="line">GOPATH=/bak/golang go install -v github.com/zhhuabj/ss/...</span><br><span class="line">ll $GOPATH/bin/ss*</span><br><span class="line">go test -cover -bench=. -run=. github.com/zhhuabj/ss/...</span><br></pre></td></tr></table></figure></p>
<p>6， 配置eclipse + goclipse环境，首先安装goclipse插件(略), 然后运行下列命令安装一些下面要用到的库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get -u golang.org/x/tools/cmd/goimports</span><br><span class="line">go get -u golang.org/x/tools/cmd/gorename</span><br><span class="line">go get -u github.com/sqs/goreturns</span><br><span class="line">go get -u github.com/nsf/gocode</span><br><span class="line">go get -u github.com/alecthomas/gometalinter</span><br><span class="line">go get -u github.com/zmb3/gogetdoc</span><br><span class="line">go get -u github.com/rogpeppe/godef</span><br><span class="line">go get -u golang.org/x/tools/cmd/guru</span><br></pre></td></tr></table></figure></p>
<p>最后配置’Preferences -&gt; Go’与’Preferences -&gt; Go -&gt; Tools‘中的下列信息即可：<br>go installation directory = /usr/lib/go-1.8<br>gocode = /bak/golang/bin/gocode<br>guru = /bak/golang/bin/guru<br>godef = /bak/golang/bin/godef<br>gofmt = /usr/lib/go-1.8/bin/gofmt<br>最后创建eclipse工程，workspace可以选择在如/bak/workspace_go目录，但是工程目录设置到$GOPATH/src/github.com/zhhuabj/ss即可。所以不需要有多个GOPATH路径。<br>注意：eclipse中对go工程的是’Build All’，因为之前我将/bak/golang为了方便看代码也链了一个工程，所以Build All时出错。去掉该工程即可。<br>7, govendor没有版本控制，可使用godep添加版本控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/tools/godep</span><br><span class="line">ls /bak/golang/src/github.com/tools/godep/</span><br><span class="line">cd $GOPATH/src/github.com/zhhuabj/ss &amp;&amp; godep save -v ./...</span><br><span class="line"></span><br><span class="line">$ cat $GOPATH/src/github.com/zhhuabj/ss/Godeps/Godeps.json</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ImportPath&quot;: &quot;github.com/zhhuabj/ss&quot;,</span><br><span class="line">	&quot;GoVersion&quot;: &quot;go1.8&quot;,</span><br><span class="line">	&quot;GodepVersion&quot;: &quot;v79&quot;,</span><br><span class="line">	&quot;Packages&quot;: [</span><br><span class="line">		&quot;./...&quot;</span><br><span class="line">	],</span><br><span class="line">	&quot;Deps&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;github.com/mitchellh/go-homedir&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;b8bc1bf767474819792c23f32d8286a45736f1c6&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;github.com/phayes/freeport&quot;,</span><br><span class="line">			&quot;Comment&quot;: &quot;1.0.2-7-ge27662a&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;e27662a4a9d6b2083dfd7e7b5d0e30985daca925&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;ImportPath&quot;: &quot;golang.org/x/net/proxy&quot;,</span><br><span class="line">			&quot;Rev&quot;: &quot;2fb46b16b8dda405028c50f7c7f0f9dd1fa6bfb1&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rm -rf /bak/golang/src/github.com/mitchellh/go-homedir/</span><br><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss/ &amp;&amp; godep go install -v github.com/zhhuabj/ss/...</span><br></pre></td></tr></table></figure></p>
<p>8, godep仅针对git, 如果想git和bzr同时用可使用godebs，就和上面juju中使用的一样。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/rogpeppe/godeps</span><br><span class="line"></span><br><span class="line"># need to write dependencies.tsv according to the following format</span><br><span class="line">https://github.com/rogpeppe/godeps/blob/master/dependencies.tsv</span><br><span class="line">github.com/kisielk/gotool	git	d6ce6262d87e3a4e153e86023ff56ae771554a41	2017-08-28T04:23:10Z</span><br><span class="line">launchpad.net/gocheck	bzr	gustavo@niemeyer.net-20140225173054-xu9zlkf9kxhvow02	87</span><br><span class="line"></span><br><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss/ &amp;&amp; godeps -u dependencies.tsv</span><br></pre></td></tr></table></figure></p>
<p>9, git版本控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /bak/golang/src/github.com/zhhuabj/ss</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m &apos;initial version&apos;</span><br><span class="line">git remote add origin git@github.com:xxxx/xx.git</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure></p>
<p>10, Debug go in VIM<br><a href="https://michaelthessel.com/go-vim-debugging-with-gdb/" target="_blank" rel="external">https://michaelthessel.com/go-vim-debugging-with-gdb/</a></p>
<p>Add the following two plugin into plugin vundle position in ~/.vimrc<br>Plugin ‘fatih/vim-go’<br>Plugin ‘vim-scripts/Conque-GDB’</p>
<p>Then run ‘vim +BundleInstall +qall’ to install those plugins</p>
<p>Finally append the following configurations in ~/.vimrc</p>
<p>let g:ConqueTerm_Color = 2<br>let g:ConqueTerm_CloseOnEnd = 1<br>let g:ConqueTerm_StartMessages = 0</p>
<p>function DebugSession()<br>    silent make -o vimgdb -gcflags “-N -l”<br>    redraw!<br>    if (filereadable(“vimgdb”))<br>        ConqueGdb vimgdb<br>    else<br>        echom “Couldn’t find debug file”<br>    endif<br>endfunction<br>function DebugSessionCleanup(term)<br>    if (filereadable(“vimgdb”))<br>        let ds=delete(“vimgdb”)<br>    endif<br>endfunction<br>call conque_term#register_function(“after_close”, “DebugSessionCleanup”)<br>nmap <leader>d :call DebugSession()<cr>;</cr></leader></p>
<p>and run ‘:GoInstallBinaries’ in vim to install some dependencies binarys</p>
<p>Press ,d to start debug, eg:<br>(gdb) b main<br>(gdb) set args -config server.ini -debug<br>(gdb) show args<br>Argument list to give program being debugged when it is started is “-config server.ini -debug”.<br>(gdb) r</p>
<p>注：如果go里有greenthread，那么gdb将无法调试，这时得用Delve (<a href="https://yq.aliyun.com/articles/57578" target="_blank" rel="external">https://yq.aliyun.com/articles/57578</a>), 使用’dlv debug’启动后剩下的命令与gdb同。<br>go get github.com/derekparker/delve/cmd/dlv<br>dlv debug test.go<br>dlv attach existing-pid</p>
<p>11, Debug C/C++ in VIM - ConqueGDB<br><a href="https://gist.github.com/RobinCPC/228eceed32dea10f32e2b3d41ad930c8" target="_blank" rel="external">https://gist.github.com/RobinCPC/228eceed32dea10f32e2b3d41ad930c8</a><br>Compiler your c/c++ code with -g flag. if not, gdb may not find symbol, eg: gcc -g hello.c -o hello<br>Start debug by ‘:ConqueGdbSplit hello’ in VIM</p>
<p>12, Debug Python by pudb<br>sudo pip install pudb<br>from pudb import set_trace; set_trace()<br>Press ‘?’ for hinting</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://github.com/juju/juju/blob/staging/CONTRIBUTING.md" target="_blank" rel="external">https://github.com/juju/juju/blob/staging/CONTRIBUTING.md</a><br>[2] <a href="https://launchpad.net/juju-core" target="_blank" rel="external">https://launchpad.net/juju-core</a><br>[3] <a href="https://blog.labix.org/2013/06/25/the-heart-of-juju" target="_blank" rel="external">https://blog.labix.org/2013/06/25/the-heart-of-juju</a><br>[4] <a href="https://jujucharms.com/community" target="_blank" rel="external">https://jujucharms.com/community</a><br>[5] <a href="https://lists.ubuntu.com/mailman/listinfo/juju" target="_blank" rel="external">https://lists.ubuntu.com/mailman/listinfo/juju</a><br>[6] <a href="https://lists.ubuntu.com/mailman/listinfo/juju-dev" target="_blank" rel="external">https://lists.ubuntu.com/mailman/listinfo/juju-dev</a><br>[7] <a href="https://github.com/juju/juju/tree/staging/doc" target="_blank" rel="external">https://github.com/juju/juju/tree/staging/doc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/06/Set-up-juju-development-env/" data-id="cjuhndt5h000airbpkg9ch6xk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Green-on-T440P-integrated-webcam-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/" class="article-date">
  <time datetime="2018-02-01T08:46:53.000Z" itemprop="datePublished">2018-02-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/">Green on T440P integrated webcam(by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-01)</strong></p>
<p>我发现我的t440p的集成摄像头成绿色像，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@t440p:~# lsusb -d 04f2:b39a -vvv</span><br><span class="line">root@t440p:~# lsusb -d 04f2:b39a</span><br><span class="line">Bus 003 Device 006: ID 04f2:b39a Chicony Electronics Co., Ltd</span><br><span class="line"></span><br><span class="line">root@t440p:~# v4l2-ctl -V -d /dev/video0</span><br><span class="line">Format Video Capture:</span><br><span class="line">	Width/Height      : 1280/720</span><br><span class="line">	Pixel Format      : &apos;MJPG&apos;</span><br><span class="line">	Field             : None</span><br><span class="line">	Bytes per Line    : 0</span><br><span class="line">	Size Image        : 1843200</span><br><span class="line">	Colorspace        : sRGB</span><br><span class="line">	Transfer Function : Default</span><br><span class="line">	YCbCr Encoding    : Default</span><br><span class="line">	Quantization      : Default</span><br><span class="line">	Flags             :</span><br></pre></td></tr></table></figure></p>
<p>最后从这个网页找到了答案 - <a href="https://help.ubuntu.com/community/Webcam/Troubleshooting" target="_blank" rel="external">https://help.ubuntu.com/community/Webcam/Troubleshooting</a></p>
<p>安装guvcview工具，将其中的”White Balance Temperature, Auto”打勾即可。<br><img src="http://img.blog.csdn.net/20180201164449436?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="蓝牙键盘"><a href="#蓝牙键盘" class="headerlink" title="蓝牙键盘"></a>蓝牙键盘</h2><p>蓝牙键盘配对后过一会超时后要重连，但经常重连不上。采用下列方法trust蓝牙之下情况好多了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bluez bluez-tools</span><br><span class="line"></span><br><span class="line">$ bluetoothctl</span><br><span class="line">[NEW] Controller 00:15:00:CB:B0:FF t440p #2 [default]</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">[NEW] Controller 00:1A:7D:DA:71:13 t440p #1</span><br><span class="line"></span><br><span class="line"># First, turn bluetooth power on (if your device is off)</span><br><span class="line">[bluetooth]# power on</span><br><span class="line">Changing power on succeeded</span><br><span class="line"></span><br><span class="line"># Then, make sure your agent is registered:</span><br><span class="line">[bluetooth]# agent on</span><br><span class="line">Agent registered</span><br><span class="line">[bluetooth]# default-agent</span><br><span class="line">Default agent request successful</span><br><span class="line"></span><br><span class="line"># Now you can scan for devices from the console</span><br><span class="line">[bluetooth]# scan on</span><br><span class="line">Discovery started</span><br><span class="line">[CHG] Controller 00:15:00:CB:B0:FF Discovering: yes</span><br><span class="line">...</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># You can manually pair from here as well</span><br><span class="line">[bluetooth]# pairable on</span><br><span class="line">Changing pairable on succeeded</span><br><span class="line">[bluetooth]# pair 90:7F:61:00:23:C3</span><br><span class="line"></span><br><span class="line">[bluetooth]# trust 90:7F:61:00:23:C3</span><br><span class="line">[CHG] Device 90:7F:61:00:23:C3 Trusted: yes</span><br><span class="line">Changing 90:7F:61:00:23:C3 trust succeeded</span><br><span class="line"></span><br><span class="line">[bluetooth]# connect 90:7F:61:00:23:C3</span><br><span class="line">[bluetooth]# quit</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/01/Green-on-T440P-integrated-webcam-by-Joshua/" data-id="cjuhndt5c0006irbpmk13acvi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Assembly-Language-Learning-by-Joshua" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/30/Assembly-Language-Learning-by-Joshua/" class="article-date">
  <time datetime="2018-01-30T04:10:21.000Z" itemprop="datePublished">2018-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/30/Assembly-Language-Learning-by-Joshua/">Assembly Language Learning (by Joshua)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-01-30)</strong></p>
<h2 id="汇编测试程序"><a href="#汇编测试程序" class="headerlink" title="汇编测试程序"></a>汇编测试程序</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ cat hello.asm </span><br><span class="line">; Hello World9%] [#######################################################################################################] </span><br><span class="line">; Compile asm: nasm -f elf64 -g -F dwarf hello.asm</span><br><span class="line">; Link asm:    ld -o hello hello.o</span><br><span class="line">; Debug asm:   [gdb|cgdb|kdbg] hello </span><br><span class="line">; Debug asm: or using insight, because kdbg can&apos;t see memory well</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">    msg db &apos;Hello, world!&apos;, 0</span><br><span class="line">    msglen: equ $-msg</span><br><span class="line">section .bss</span><br><span class="line">section .text</span><br><span class="line">    global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    nop</span><br><span class="line">    mov eax, 4       ; sys_write sys call</span><br><span class="line">    mov ebx, 1       ; stdout</span><br><span class="line">    mov ecx, msg</span><br><span class="line">    mov edx, msglen</span><br><span class="line">    int 80H</span><br><span class="line">    mov eax, 1       ; exit sys call</span><br><span class="line">    mov ebx, 0       ; return 0</span><br><span class="line">    int 80H         </span><br><span class="line">    mov ebp, esp</span><br></pre></td></tr></table></figure>
<h2 id="编译与链接"><a href="#编译与链接" class="headerlink" title="编译与链接"></a>编译与链接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf64 -g -F dwarf hello.asm</span><br><span class="line">ld -o hello hello.o</span><br></pre></td></tr></table></figure>
<h2 id="用gdb调试"><a href="#用gdb调试" class="headerlink" title="用gdb调试"></a>用gdb调试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ gdb hello</span><br><span class="line">...</span><br><span class="line">(gdb) b 16</span><br><span class="line">Breakpoint 1 at 0x4000b1: file hello.asm, line 16.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /bak/work/asm/hello </span><br><span class="line"></span><br><span class="line">Breakpoint 1, _start () at hello.asm:16</span><br><span class="line">16	    mov eax, 4       ; sys_write sys call</span><br><span class="line">(gdb) n</span><br><span class="line">17	    mov ebx, 1       ; stdout</span><br><span class="line">(gdb) i r eax</span><br><span class="line">eax            0x4	4</span><br><span class="line">(gdb) set $eax=0x4</span><br></pre></td></tr></table></figure>
<h2 id="用cgdb调试"><a href="#用cgdb调试" class="headerlink" title="用cgdb调试"></a>用cgdb调试</h2><p>cgdb能方便调试的过程中查看代码，如下图：<br><img src="http://img.blog.csdn.net/20180130120215608?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用kDbg调试"><a href="#用kDbg调试" class="headerlink" title="用kDbg调试"></a>用kDbg调试</h2><p>kDbg方便查看寄存器，但是查看内存不是很方便。如图：<br><img src="http://img.blog.csdn.net/20180130120334887?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用insight调试"><a href="#用insight调试" class="headerlink" title="用insight调试"></a>用insight调试</h2><p>kDgb不方便查看内存，所以有了insight, insight在ubuntu 16.04上的安装步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install autoconf autogen texinfo zlib1g-dev tcl-dev tk-dev mesa-common-dev libjpeg-dev libtogl-dev python-dev flex bison itcl3 itk3 iwidgets4</span><br><span class="line">git clone --recursive git://sourceware.org/git/insight.git</span><br><span class="line">cd insight &amp;&amp; autoconf</span><br><span class="line">./configure --prefix=/usr/. --libdir=/usr/lib64 --disable-binutils --disable-elfcpp --disable-gas --disable-gold \</span><br><span class="line">--disable-gprof --disable-ld --disable-rpath --disable-zlib --enable-sim --with-gdb-datadir=/usr/share/insight \</span><br><span class="line">--with-jit-reader-dir=/usr/lib64/insight --with-separate-debug-dir=&apos;/usr/lib/debug&apos; --with-expat --with-python --without-libunwind</span><br><span class="line">make -j8 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20180130120523311?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="用sasm调试"><a href="#用sasm调试" class="headerlink" title="用sasm调试"></a>用sasm调试</h2><p>sasm的安装方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">axel http://download.opensuse.org/repositories/home:/Dman95/xUbuntu_16.04/amd64/sasm_3.9.0_amd64.deb</span><br><span class="line">sudo dpkg -i sasm_3.9.0_amd64.deb</span><br><span class="line">sudo apt-get -f install</span><br></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20180130120714341?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXVxaTk5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>注意，使用sasm时，代码一是需要添加’%include “io64.inc”‘，二是_start需要变成CMAIN， 三是自己的代码写在下列代码的”write your code here“处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%include &quot;io64.inc&quot;</span><br><span class="line">section .text</span><br><span class="line">global CMAIN</span><br><span class="line">CMAIN:</span><br><span class="line">    ;write your code here</span><br><span class="line">    xor eax, eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>故完整的测试代码修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/asm$ cat hello2.asm </span><br><span class="line">%include &quot;io64.inc&quot;</span><br><span class="line">section .data</span><br><span class="line">    msg db &apos;Hello, world!&apos;, 0</span><br><span class="line">    msglen: equ $-msg</span><br><span class="line">section .bss</span><br><span class="line">section .text</span><br><span class="line">global CMAIN</span><br><span class="line">CMAIN:</span><br><span class="line">    nop</span><br><span class="line">    mov eax, 4       ; sys_write sys call</span><br><span class="line">    mov ebx, 1       ; stdout</span><br><span class="line">    mov ecx, msg</span><br><span class="line">    mov edx, msglen</span><br><span class="line">    int 80H</span><br><span class="line">    mov eax, 1       ; exit sys call</span><br><span class="line">    mov ebx, 0       ; return 0</span><br><span class="line">    int 80H         </span><br><span class="line">    mov ebp, esp</span><br><span class="line">    </span><br><span class="line">    xor eax, eax</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/30/Assembly-Language-Learning-by-Joshua/" data-id="cjuhndt5a0004irbpo1viw968" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/15/手机作为显示器及键鼠控制电脑棒/">手机作为显示器及键鼠控制电脑棒</a>
          </li>
        
          <li>
            <a href="/2019/01/18/Set-ip-IPv6-env/">Set ip IPv6 env</a>
          </li>
        
          <li>
            <a href="/2019/01/02/Using-kubeadm-to-deploy-k8s/">Using kubeadm to deploy k8s</a>
          </li>
        
          <li>
            <a href="/2018/12/31/Use-Octavia-to-Implement-HTTPS-Health-Monitors/">Use Octavia to Implement HTTPS Health Monitors</a>
          </li>
        
          <li>
            <a href="/2018/10/29/为租户下的虚机提供IPv6-DNS服务/">为租户下的虚机提供IPv6 DNS服务</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 张华<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>