<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/18/引入nova-placement之后对调度的影响/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/18/引入nova-placement之后对调度的影响/" itemprop="url">引入nova placement之后对调度的影响</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-18T15:33:22+08:00">
                2020-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-17<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="nova-cell-v2"><a href="#nova-cell-v2" class="headerlink" title="nova cell v2"></a>nova cell v2</h2><p>nova cell v2将nova db分成了3个(nova, nova_api, nova_cell0，虚机信息只存储在所在的cell中，公共数据存储在nova_api库中), nova_api中的3个表(nova_api.host_mappings, nova_api.instance_mappings, nova_api.cell_mappings可以直接从instance找到cell_id进而找到DB与MQ的信息，这样nova-api直接就可以操作该cell之类的DB与MQ从而可以让nova-compute可以水平扩展到更多的物理节点，另一方面，nova-api节点也不再需要nova-cell服务，要有nova-api与nova-scheduler两个服务即可．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; pager less -S</span><br><span class="line">PAGER set to &apos;less -S&apos;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">mysql&gt; select instance_uuid,cell_id from instance_mappings;</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| instance_uuid                        | cell_id |</span><br><span class="line">+--------------------------------------+---------+</span><br><span class="line">| 4039ed4e-d0a1-46ba-99a5-68bc84421b42 |       2 |</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from host_mappings;</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| created_at          | updated_at | id | cell_id | host                                |</span><br><span class="line">+---------------------+------------+----+---------+-------------------------------------+</span><br><span class="line">| 2020-09-16 06:18:26 | NULL       |  1 |       2 | juju-3ba760-ceilometer-15.cloud.sts |</span><br><span class="line"></span><br><span class="line">mysql&gt; select transport_url,name,database_connection from cell_mappings;</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| transport_url                                                                                            | name  | database_connection                                                         |</span><br><span class="line">+----------------------------------------------------------------------------------------------------------+-------+-----------------------------------------------------------------------------+</span><br><span class="line">| none:///                                                                                                 | cell0 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova_cell0 |</span><br><span class="line">| rabbit://nova:wSz5LjscfBqKnhVWKBZnrXdwS5Kz6TByz9jKfm2xKHbCRYPPSbcnqFwPTnCp8VpP@10.5.0.199:5672/openstack | cell1 | mysql+pymysql://nova:4Hjrdj5yMTkG6V9nxNpqrfVdhtJ5Tnww@10.5.0.103/nova       |</span><br></pre></td></tr></table></figure>
<p>所以当遇到这种错误时:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br><span class="line">No server with a name or ID of 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nova-manage cell_v2 list_cells</span><br><span class="line">sudo nova-manage cell_v2 map_instances --cell_uuid &lt;cell-id-from-above&gt;</span><br><span class="line">openstack server delete 2ebf1b2d-f679-4265-9c4b-71420dace71a</span><br></pre></td></tr></table></figure>
<h2 id="nova-placement-API"><a href="#nova-placement-API" class="headerlink" title="nova placement API"></a>nova placement API</h2><p>nova placement API在Newton被引入, nova-scheduler调用placement-api用于调度. 主要用于跟踪记录Resource Provider(compute-node, external storage-pool, external ip-allocation-pool etc)的Inventory和Usage.自Pike版本, 必须启用Placement API来辅助nova-scheduler service进行compute node调度，并以此替代之前的RAMFilter、CoreFilter和DiskFilter。概念对象如下:</p>
<ul>
<li>Resource Class, 资源种类, placement api默认实现了DISK_GB, MEMORY_MB,VCPU三种标准resource classes, 也提供了custom resource classes的接口.</li>
<li>Resource Providers：资源提供者，实际提供资源的对象，例如：compute node、storage pool</li>
<li>Inventory：资源清单，资源提供者所拥有的资源清单，例如：compute node 拥有的vCPU、Disk、RAM 等 inventories</li>
<li>Resource Allocations：资源分配状况，包含了Resource Class、Resource Provider以及Consumer 的映射关系。记录消费者使用了多少该类型的资源数量</li>
<li>Provider Aggregate：资源聚合，类似 HostAggregate 的概念</li>
<li>Traits：资源特征，不同资源提供者可能会具有不同的资源特征。Traits 作为资源提供者特征的描述，它不能够被消费，但在某些Workflow 或者会需要这些信息。例如：标识可用的Disk是一个SSD，可以帮助Scheduler更好的匹配 instance boot请求。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from resource_providers;</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| created_at          | updated_at          | id | uuid                                 | name                                | generation | can_host | root_provider_id | parent_provider_id |</span><br><span class="line">+---------------------+---------------------+----+--------------------------------------+-------------------------------------+------------+----------+------------------+--------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | 2020-09-16 10:19:33 |  1 | a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |     NULL |                1 |               NULL |</span><br><span class="line"></span><br><span class="line"># for the field resource_class_id, 0 means VCPU, 1 means MEMORY_MB, 2 means DISK_GB</span><br><span class="line">mysql&gt; select * from inventories;</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | resource_class_id | total | reserved | min_unit | max_unit | step_size | allocation_ratio |</span><br><span class="line">+---------------------+------------+----+----------------------+-------------------+-------+----------+----------+----------+-----------+------------------+</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  1 |                    1 |                 0 |     2 |        0 |        1 |        2 |         1 |               16 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  2 |                    1 |                 1 |  3944 |      512 |        1 |     3944 |         1 |              1.5 |</span><br><span class="line">| 2020-09-16 06:18:15 | NULL       |  3 |                    1 |                 2 |    38 |        0 |        1 |       38 |         1 |                1 |</span><br><span class="line">mysql&gt; select * from allocations;</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| created_at          | updated_at | id | resource_provider_id | consumer_id                          | resource_class_id | used |</span><br><span class="line">+---------------------+------------+----+----------------------+--------------------------------------+-------------------+------+</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 16 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 2 |    1 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 17 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 1 |   64 |</span><br><span class="line">| 2020-09-16 08:45:44 | NULL       | 18 |                    1 | 64cb10fd-246f-4864-b06d-687d59c47c2c |                 0 |    1 |</span><br></pre></td></tr></table></figure>
<h2 id="Placement-CLI"><a href="#Placement-CLI" class="headerlink" title="Placement CLI"></a>Placement CLI</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-osc-placement -y</span><br><span class="line"></span><br><span class="line">$ openstack resource provider list</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| uuid                                 | name                                | generation |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line">| a7081054-ee03-44b8-ae21-f20e0535cfc1 | juju-3ba760-ceilometer-15.cloud.sts |         19 |</span><br><span class="line">+--------------------------------------+-------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">$  openstack resource provider inventory list a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| resource_class | allocation_ratio | min_unit | max_unit | reserved | step_size | total |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line">| VCPU           |             16.0 |        1 |        2 |        0 |         1 |     2 |</span><br><span class="line">| MEMORY_MB      |              1.5 |        1 |     3944 |      512 |         1 |  3944 |</span><br><span class="line">| DISK_GB        |              1.0 |        1 |       38 |        0 |         1 |    38 |</span><br><span class="line">+----------------+------------------+----------+----------+----------+-----------+-------+</span><br><span class="line"></span><br><span class="line">$ openstack resource provider usage show a7081054-ee03-44b8-ae21-f20e0535cfc1</span><br><span class="line">+----------------+-------+</span><br><span class="line">| resource_class | usage |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| VCPU           |     3 |</span><br><span class="line">| MEMORY_MB      |   192 |</span><br><span class="line">| DISK_GB        |     3 |</span><br><span class="line">+----------------+-------+</span><br></pre></td></tr></table></figure>
<h2 id="one-bug"><a href="#one-bug" class="headerlink" title="one bug"></a>one bug</h2><p>例如, 如<a href="https://bugs.launchpad.net/nova/+bug/1679750描述的场景" target="_blank" rel="external">https://bugs.launchpad.net/nova/+bug/1679750描述的场景</a>, 在hostA上创建一虚机,hostA死掉了, 这时删除虚机时无法删除实例(因为nova-compute这时死掉了啊), 这样会导致allocations表中的记录没有被删除. 如果hostA又起来了, nova-compute的init_host-&gt;_complete_partial_deletion<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre_start_hook -&gt; update_available_resource -&gt; nova/compute/manager.py#update_available_resource_for_node -&gt; update_available_resource -&gt; _update_available_resource -&gt; _remove_deleted_instances_allocations</span><br></pre></td></tr></table></figure></p>
<p>当把一个nova-compute删除时，删了service和compute_node表记录后,却没有删除placement resource provider和host mapping records.<br>nova-compute自己都死了它是没法自己删自己的,所以改由nova-api在启动时在删除instances时也删除allocations表中的记录 -<br><a href="https://review.opendev.org/#/c/580498/" target="_blank" rel="external">https://review.opendev.org/#/c/580498/</a></p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * nova_api.from host_mappings;</span><br><span class="line">select * from nova_api.cell_mappings;</span><br><span class="line">select * from nova_api.resource_providers where name like &apos;%xxx%&apos;;   xx.bos01.xxx (9)</span><br><span class="line">select * from nova.compute_nodes where host like &apos;%bagon%&apos; or hypervisor_hostname like &apos;%xxx%&apos;;</span><br><span class="line">select * from nova_api.inventories where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;);</span><br><span class="line">select * from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;) order by consumer_id,resource_provider_id,resource_class_id;</span><br><span class="line">select uuid, host, node, vcpus, memory_mb, vm_state, power_state, task_state, root_gb, ephemeral_gb, cell_name,deleted from nova.instances where uuid in (select consumer_id from nova_api.allocations where resource_provider_id in (select id from nova_api.resource_providers where name like &apos;%xxx%&apos;)) order by uuid;</span><br></pre></td></tr></table></figure>
<h2 id="20201230更新-another-bug"><a href="#20201230更新-another-bug" class="headerlink" title="20201230更新 - another bug"></a>20201230更新 - another bug</h2><p>“select numa_topology from nova.compute_nodes where hypervisor_hostname=’cloud3.xxx.com’\G”显示cell0上的pinned_cpus将所有CPU全用完了导致nova-schedule无法继续调度报“Filter NUMATopologyFilter returned 0 hosts”这种错。<br>下面代码分析显示周期性的update_available_resource本来是可以自动修改数据库记录的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre_start_hook -&gt; update_available_resource -&gt; _update_available_resource -&gt; _update_usage_from_instances -&gt; _update_usage_from_instance -&gt; _update_usage -&gt; numa_usage_from_instance_numa</span><br></pre></td></tr></table></figure></p>
<p>从数据库拿出host_cell.pinned_cpus作为pinned_cpus的初始值，特别要注意：host_cell.pinned_cpus并不是直接从数据库取的，它通过运行下列的self._copy_resources(cn, resources)方法实际上让host_cell.pinned_cpus永远为empty<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">693 def _init_compute_node(self, context, resources):</span><br><span class="line">...</span><br><span class="line">713 if nodename in self.compute_nodes:</span><br><span class="line">714 cn = self.compute_nodes[nodename]</span><br><span class="line">715 self._copy_resources(cn, resources)</span><br><span class="line">716 self._setup_pci_tracker(context, cn, resources)</span><br><span class="line">717 return False</span><br></pre></td></tr></table></figure></p>
<p>它根据free变量来决定是往pinned_cpus上加还是减。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">./nova/virt/hardware.py#numa_usage_from_instance_numa</span><br><span class="line">def numa_usage_from_instance_numa(host_topology, instance_topology,free=False):</span><br><span class="line">...</span><br><span class="line">for host_cell in host_topology.cells:</span><br><span class="line">new_cell = objects.NUMACell(</span><br><span class="line">id=host_cell.id,</span><br><span class="line">cpuset=shared_cpus,</span><br><span class="line">pcpuset=dedicated_cpus,</span><br><span class="line">memory=host_cell.memory,</span><br><span class="line">cpu_usage=0,</span><br><span class="line">memory_usage=0,</span><br><span class="line">mempages=host_cell.mempages,</span><br><span class="line">pinned_cpus=host_cell.pinned_cpus,</span><br><span class="line">siblings=host_cell.siblings)</span><br><span class="line">...</span><br><span class="line">if free:</span><br><span class="line">if (instance_cell.cpu_thread_policy ==</span><br><span class="line">fields.CPUThreadAllocationPolicy.ISOLATE):</span><br><span class="line">new_cell.unpin_cpus_with_siblings(pinned_cpus)</span><br><span class="line">else:</span><br><span class="line">new_cell.unpin_cpus(pinned_cpus)</span><br></pre></td></tr></table></figure></p>
<p>free是由”free = sign == -1“决定的（看仔细，右边的是两个等号，左边的是一个等号）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def _update_usage(self, usage, nodename, sign=1):</span><br><span class="line">...</span><br><span class="line">free = sign == -1</span><br><span class="line">cn.numa_topology = hardware.numa_usage_from_instance_numa(</span><br><span class="line">host_numa_topology, instance_numa_topology, free)._to_json()</span><br><span class="line"></span><br><span class="line">def _update_usage_from_instance():</span><br><span class="line">is_new_instance = uuid not in self.tracked_instances</span><br><span class="line">is_removed_instance = not is_new_instance and (is_removed or</span><br><span class="line">instance[&apos;vm_state&apos;] in vm_states.ALLOW_RESOURCE_REMOVAL)</span><br><span class="line">if is_new_instance:</span><br><span class="line">self.tracked_instances.add(uuid)</span><br><span class="line">sign = 1</span><br><span class="line">if is_removed_instance:</span><br><span class="line">self.tracked_instances.remove(uuid)</span><br><span class="line">sign = -1</span><br><span class="line">...</span><br><span class="line">self._update_usage(self._get_usage_dict(instance, instance),nodename, sign=sign)</span><br></pre></td></tr></table></figure></p>
<p>所以只要update_available_resource运行那脏记录必须得到修改，那现在没修改说明update_available_resource一直没运行，日志里发现这种错误placement正在使用http而非https打头的endpoint从而导致placement api不可用，这样导致update_available_resource在调用update_placement时出错，从而导致update_available_resource自2020-10-26后再未运行。详见－<a href="https://bugs.launchpad.net/charm-nova-compute/+bug/1826382" target="_blank" rel="external">https://bugs.launchpad.net/charm-nova-compute/+bug/1826382</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-10-26 15:43:34.459 1393 WARNING keystoneauth.discover [req-5dcdc394-2784-40d2-984c-54fe261f36f0 - - - - -] Failed to contact the endpoint at http://placement-int.xxx.com:8778 for discovery. Fallback to using that endpoint as the base url.</span><br><span class="line">2020-10-26 15:43:34.463 1393 ERROR nova.compute.manager [req-5dcdc394-2784-40d2-984c-54fe261f36f0 - - - - -] Could not retrieve compute node resource provider 8bd4062b-84c7-4aab-ade7-31dc01695878 and therefore unable to error out any instances stuck in BUILDING state. Error: Failed to retrieve allocations for resource provider 8bd4062b-84c7-4aab-ade7-31dc01695878:</span><br></pre></td></tr></table></figure>
<p>关于numa测试环境的搭建可以见－<a href="https://blog.csdn.net/quqi99/article/details/51993512" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/51993512</a>, 注意一点，grub里定义isolcpus并不会让nova不使用这些cpu, nova里专门有vcpu_pin_set来做这件事。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://blog.csdn.net/jmilk/article/details/81264240" target="_blank" rel="external">https://blog.csdn.net/jmilk/article/details/81264240</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/10/如何让novnc-websockify支持tls1-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/10/如何让novnc-websockify支持tls1-2/" itemprop="url">如何让novnc/websockify支持tls1.2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-10T15:04:57+08:00">
                2020-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-09-10<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>如果希望novnc使用tls1.2该怎么办？<br>各软件(openssl, websockify, nova)支持tls1.2的历史情况如下：</p>
<ul>
<li>openssl在1.0.0h到1.0.1的时候才开始支持tls1.2, 见”Add TLS v1.2 server support for client authentication” - <a href="https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本" target="_blank" rel="external">https://www.openssl.org/news/changelog.html，xenial使用的是1.0.2g版本</a></li>
<li>ubuntu 20.04开始默认使用tls1.2 [2]</li>
<li>websockify在0.9.0才开始支持配置tls版本, 见 - <a href="https://pypi.org/project/websockify/" target="_blank" rel="external">https://pypi.org/project/websockify/</a>, 所以在nova xenial/mitaka版本中因为使用了websockify0.8.0所以列代码也不支持配置tls版本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;ssl.wrap_sock&apos; /usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py -A 7</span><br><span class="line">            wrapped_sock = ssl.wrap_socket(</span><br><span class="line">                compute_sock,</span><br><span class="line">                keyfile=client_key,</span><br><span class="line">                certfile=client_cert,</span><br><span class="line">                server_side=False,</span><br><span class="line">                cert_reqs=ssl.CERT_REQUIRED,</span><br><span class="line">                ca_certs=CONF.vnc.vencrypt_ca_certs)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这样，后来在nova升级到websockify 0.9.0之后也开始有了一个patch支持配置tls版本,见<br><a href="https://review.opendev.org/#/c/679502/" target="_blank" rel="external">https://review.opendev.org/#/c/679502/</a><br>但是，目前我们使用的就是xenial，该如何办呢？<br>首先，因为使用的是websockify 0.8.0不支持配置ssl版本，那样想在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2＂来强制使用tls1_2是可行的．（如果不可行，是因为下列错误导致，见： <a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a> )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br></pre></td></tr></table></figure></p>
<p>那样，是否应该改变底层openssl的默认配置成tls1.2, 参考文档[1], 修改/etc/ssl/openssl.cnf在oid_section之后添加下列内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# grep -r &apos;oid_section&apos; /etc/ssl/openssl.cnf -A 2</span><br><span class="line">oid_section             = new_oids</span><br><span class="line"></span><br><span class="line">openssl_conf = default_conf</span><br><span class="line"></span><br><span class="line">root@juju-055b8b-ssl-7:~# cat /etc/ssl/openssl.cnf |tail -n9</span><br><span class="line">[default_conf]</span><br><span class="line">ssl_conf = ssl_sect</span><br><span class="line"></span><br><span class="line">[ssl_sect]</span><br><span class="line">system_default = system_default_sect</span><br><span class="line"></span><br><span class="line">[system_default_sect]</span><br><span class="line">MinProtocol = TLSv1.2</span><br><span class="line">CipherString = DEFAULT@SECLEVEL=2</span><br></pre></td></tr></table></figure></p>
<p>但是使用下列方法测试时报错．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nova-novncproxy nova-consoleauth</span><br><span class="line"># verify if tls 1.2 is supported - https://devanswers.co/test-server-tls-1-2-ubuntu/</span><br><span class="line"># https://www.poftut.com/use-openssl-s_client-check-verify-ssltls-https-webserver/</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line"></span><br><span class="line">#list all supported ciphers</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6080 10.5.100.4</span><br><span class="line">OPENSSL_CONF=/etc/ssl/ openssl s_client -connect 10.5.2.196:6082 -tls1_2</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@juju-055b8b-ssl-7:~# openssl s_client -connect 10.5.100.4:6080 -tls1_2</span><br><span class="line">Error configuring OpenSSL</span><br><span class="line">139929571108504:error:25066067:DSO support routines:DLFCN_LOAD:could not load the shared library:dso_dlfcn.c:187:filename(libssl_conf.so): libssl_conf.so: cannot open shared object file: No such file or directory</span><br><span class="line">139929571108504:error:25070067:DSO support routines:DSO_load:could not load the shared library:dso_lib.c:233:</span><br><span class="line">139929571108504:error:0E07506E:configuration file routines:MODULE_LOAD_DSO:error loading dso:conf_mod.c:271:module=ssl_conf, path=ssl_conf</span><br><span class="line">139929571108504:error:0E076071:configuration file routines:MODULE_RUN:unknown module name:conf_mod.c:212:module=ssl_conf</span><br></pre></td></tr></table></figure>
<p>错误是找不着libssl_conf.so，作下列更改后，问题依旧 ．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libssl1.0.0 libssl-dev</span><br><span class="line">cd /lib/x86_64-linux-gnu/</span><br><span class="line">sudo ln -s libssl.so.1.0.0 libssl.so.10</span><br><span class="line">sudo ln -s libcrypto.so.1.0.0 libcrypto.so.10</span><br></pre></td></tr></table></figure></p>
<p>20201120更新-是需要添加<strong>OPENSSL_CONF=/etc/ssl/</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># OPENSSL_CONF=/etc/ssl/ openssl ciphers -v TLSv1.2 | head -4</span><br><span class="line">ECDHE-RSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AESGCM(256) Mac=AEAD</span><br><span class="line">ECDHE-RSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AES(256)  Mac=SHA384</span><br><span class="line">ECDHE-ECDSA-AES256-SHA384 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AES(256)  Mac=SHA384</span><br></pre></td></tr></table></figure></p>
<p>将xenial上的openssl 1.1.0g升级到1.1.1a后问题依旧:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#upgrade openssl from 1.1.0g to 1.1.1a in ubuntu 18.04</span><br><span class="line">sudo apt install build-essential checkinstall zlib1g-dev gcc make -y</span><br><span class="line">wget https://www.openssl.org/source/openssl-1.1.1a.tar.gz</span><br><span class="line">tar zxvf openssl-1.1.1a.tar.gz &amp;&amp; cd openssl-1.1.1a/</span><br><span class="line">./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/ld.so.conf.d/openss1-1.1.1b.conf&apos; &lt;&lt; EOF</span><br><span class="line">/usr/local/ssl/lib</span><br><span class="line">EOF</span><br><span class="line">sudo ldconfig -v</span><br><span class="line">sudo mv /usr/bin/c_rehash /usr/bin/c_rehash.BAK</span><br><span class="line">sudo mv /usr/bin/openssl /usr/bin/openssl.BAK</span><br><span class="line">sudo cp /etc/environment /etc/environment.BAK</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/environment&apos; &lt;&lt; EOF</span><br><span class="line">PATH=&quot;/usr/local/ssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games&quot;</span><br><span class="line">EOF</span><br><span class="line">echo $PATH</span><br><span class="line">openssl version -a</span><br><span class="line">sudo apt-get install libssl-dev -y</span><br></pre></td></tr></table></figure></p>
<p>然后修改/usr/lib/python2.7/dist-packages/websockify/websocket.py（注意，不是/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py）里的ssl.wrap_socket添加’ssl_version=ssl.PROTOCOL_TLSv1_2’就可以了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nmap --script ssl-enum-ciphers -p 6080 10.5.100.4 |grep TLSv</span><br><span class="line">|   TLSv1.2:</span><br><span class="line">root@juju-055b8b-ssl-7:~/openssl-1.1.1a# openssl s_client -connect 10.5.100.4:6080 -tls1_2 |grep &apos;CN&apos;</span><br><span class="line">depth=0 C = GB, ST = England, L = London, O = Ubuntu Cloud, OU = Cloud, CN = 10.5.100.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>此时，去掉/usr/lib/python2.7/dist-packages/nova/console/rfb/authvencrypt.py里之前做的tls1.2修改也是可以的．<br>结论，似乎修改底层openssl的默认版本到tls1.2不好使，同时websockify 0.8.0默认的只是tls1.0, 此时只是修改nova端是不work的，直接修改websockify 0.8.0改到tls1.2是可以的．在websockify 0.9.0之后支持配置tls1.2，所以此时nova端修改tls的patch也就能派上用场了．<br>相关代码分析：<br>python ssl模块在wrap_socket中是将参数硬编码成ssl_version=PROTOCOL_SSLv23，所以在websockify 0.8.0不传ssl_version参数的话是即使改底层openssl的默认编码也是无济于事的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def wrap_socket(sock, keyfile=None, certfile=None,</span><br><span class="line">                server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line">                ssl_version=PROTOCOL_SSLv23, ca_certs=None,</span><br><span class="line">                do_handshake_on_connect=True,</span><br><span class="line">                suppress_ragged_eofs=True, ciphers=None):</span><br></pre></td></tr></table></figure></p>
<p>看来唯一的办法是修改python-websockify 0.8.0包，加上那一行，做个临时hotfix了．</p>
<h2 id="20201106更新"><a href="#20201106更新" class="headerlink" title="20201106更新"></a>20201106更新</h2><p>创建了一个xenial的spice ssl测试环境．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl2:stsstack --num-compute 1 --openstack-dashboard --ssl --nova-console --run</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=/home/ubuntu/ed/stsstack-bundles/openstack/ssl/openstack-ssl2/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=spice</span><br><span class="line">juju config nova-cloud-controller console-ssl-cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-ssl-key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>但我们尽量不用–ssl，改用–vault<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl-queens:stsstack --num-compute 1 --nova-console --vault</span><br></pre></td></tr></table></figure></p>
<p>看到下列错，实际上这是正常的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ nova get-vnc-console bionic-061058 spice-html5</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| Type | Url |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">| spice-html5 | https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015 |</span><br><span class="line">+-------------+------------------------------------------------------------------------------------+</span><br><span class="line">$ curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=69b15db8-2575-4bc9-980b-3e4149881015</span><br><span class="line">* Trying 10.5.100.4:6082...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 10.5.100.4 (10.5.100.4) port 6082 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">* CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.3 (OUT), TLS alert, protocol version (582):</span><br><span class="line">* error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) error:1425F102:SSL routines:ssl_choose_client_version:unsupported protocol</span><br><span class="line"></span><br><span class="line">-root@juju-1833ad-ssl2-7:~# tail -f /var/log/nova/nova-spiceproxy.log</span><br><span class="line">2020-11-06 06:42:33.666 26162 DEBUG nova.console.websocketproxy [-] 10.5.0.8: new handler Process vmsg /usr/lib/python2.7/dist-packages/websockify/websocket.py:878</span><br><span class="line">2020-11-06 06:42:34.166 19170 INFO nova.console.websocketproxy [-] handler exception: [SSL: SSLV3_ALERT_CERTIFICATE_UNKNOWN] sslv3 alert certificate unknown (_ssl.c:590)</span><br></pre></td></tr></table></figure></p>
<p>为什么说它是正常的呢？因为我们是在focal上运行的curl命令或者浏览器，focal支持的最低ssl版本是tlsv1.2，而spiceproxy运行在xenial只支持tlsv1.0.　所以找一台xenial机器运行下列加了–tlsv1.0的curl命令是OK的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -vvv https://10.5.100.4:6082/spice_auto.html?token=bd00bb9f-83e7-4b25-9b6a-57dde9941dce --tlsv1.0</span><br></pre></td></tr></table></figure></p>
<p>还是上面类似的老问题，spice也用到了websockify0.8，而它写死了 ssl_version=PROTOCOL_TLSv1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; /usr/lib/python2.7/dist-packages/websockify/websocket.py(837)do_handshake()</span><br><span class="line">-&gt; retsock = ssl.wrap_socket(</span><br><span class="line">(Pdb) l</span><br><span class="line">832                     raise self.EClose(&quot;SSL connection but &apos;%s&apos; not found&quot;</span><br><span class="line">833                                       % self.cert)</span><br><span class="line">834                 retsock = None</span><br><span class="line">835                 try:</span><br><span class="line">836                     import rpdb;rpdb.set_trace()</span><br><span class="line">837  -&gt;                 retsock = ssl.wrap_socket(</span><br><span class="line">838                             sock,</span><br><span class="line">839                             server_side=True,</span><br><span class="line">840                             certfile=self.cert,</span><br><span class="line">841                             keyfile=self.key)</span><br><span class="line">842                 except ssl.SSLError:</span><br><span class="line">(Pdb) p self.cert</span><br><span class="line">&apos;/etc/nova/ssl/nova_cert.pem&apos;</span><br><span class="line">(Pdb) p self.key</span><br><span class="line">&apos;/etc/nova/ssl/nova_key.pem&apos;</span><br><span class="line">(Pdb) l</span><br><span class="line"> 48</span><br><span class="line"> 49         def __init__(self, sock, keyfile=None, certfile=None,</span><br><span class="line"> 50                      server_side=False, cert_reqs=CERT_NONE,</span><br><span class="line"> 51                      ssl_version=PROTOCOL_TLSv1, ca_certs=None,</span><br><span class="line"> 52                      do_handshake_on_connect=True, *args, **kw):</span><br><span class="line"> 53  -&gt;         if not isinstance(sock, GreenSocket):</span><br><span class="line"> 54                 sock = GreenSocket(sock)</span><br><span class="line"> 55</span><br><span class="line"> 56             self.act_non_blocking = sock.act_non_blocking</span><br><span class="line"> 57</span><br><span class="line"> 58             if six.PY2:</span><br><span class="line"></span><br><span class="line">root@juju-1833ad-ssl2-7:~# pip list |grep web</span><br><span class="line">websockify (0.8.0)</span><br></pre></td></tr></table></figure></p>
<p>但直接在xenial上升级到websockify=0.9.0失败.</p>
<h2 id="在queens中使用websockify-0-9-0"><a href="#在queens中使用websockify-0-9-0" class="headerlink" title="在queens中使用websockify 0.9.0"></a>在queens中使用websockify 0.9.0</h2><p>将websockify的patch backedport到0.8.0时依赖太多，所以只能将0.9.0整体backport到queens. 测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/lib/python2.7/dist-packages/websockify ~/websockify_bak</span><br><span class="line">git clone https://github.com/novnc/websockify.git</span><br><span class="line">cd websockify &amp;&amp; git checkout -b v0.9.0 v0.9.0</span><br><span class="line">cd ../ &amp;&amp; cp -r websockify/websockify /usr/lib/python2.7/dist-packages/</span><br><span class="line"></span><br><span class="line">cp allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch /usr/lib/python2.7/dist-packages/</span><br><span class="line">cd  /usr/lib/python2.7/dist-packages/ &amp;&amp; patch -p1 &lt;allow-TLS-ciphers-protocols-to-be-configurable-for-c.patch</span><br><span class="line"></span><br><span class="line">then set the following content in /etc/nova/nova.conf</span><br><span class="line">[console]</span><br><span class="line">ssl_minimum_version=tlsv1_2</span><br><span class="line"></span><br><span class="line">vim /usr/lib/python2.7/dist-packages/nova/console/websocketproxy.py</span><br><span class="line">    def socket(self, *args, **kwargs):</span><br><span class="line">        #return websockify.WebSocketServer.socket(*args, **kwargs)</span><br><span class="line">        return websockify.websockifyserver.WebSockifyServer.socket(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">find /usr/lib/python2.7/dist-packages/websockify -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line">find /usr/lib/python2.7/dist-packages/nova -name &quot;*.pyc&quot; -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">systemctl restart nova-spiceproxy</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6082 10.5.2.196 |grep -i tlsv</span><br></pre></td></tr></table></figure>
<h2 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">websocketproxy.py#websockify_init (opts.ssl_options = select_ssl_version(opts.ssl_version)) -&gt; websockifyserver.py#start_server()</span><br><span class="line"></span><br><span class="line">when client is connecting:</span><br><span class="line">WebSocketProxy -&gt; ./websocketproxy.py#ProxyRequestHandler -&gt; WebSockifyRequestHandler#handle -&gt; /usr/lib/python3.6/http/server.py(377)handle_one_request() -&gt; _websocket_do_GET -&gt; handle_upgrade (self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;) -&gt;  WebSocketRequestHandlerMixIn.handle_upgrade(self) -&gt; handle_websocket(SSL/TLS)-&gt; new_websocket_client　-&gt; /usr/lib/python3/dist-packages/nova/console/websocketproxy.py(166)new_websocket_client</span><br></pre></td></tr></table></figure>
<p>似乎是在queens中下面的self.headers.get(‘upgrade’)不为wesocket<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">54     def _websocket_do_GET(self):</span><br><span class="line">55         # Checks if it is a websocket request and redirects</span><br><span class="line">56         self.do_GET = self._real_do_GET</span><br><span class="line">57</span><br><span class="line">58         if (self.headers.get(&apos;upgrade&apos;) and</span><br><span class="line">59             self.headers.get(&apos;upgrade&apos;).lower() == &apos;websocket&apos;):</span><br><span class="line">60             self.handle_upgrade()</span><br><span class="line">61         else:</span><br><span class="line">62             self.do_GET()</span><br></pre></td></tr></table></figure></p>
<p>根据这个网页（<a href="https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）" target="_blank" rel="external">https://www.slideshare.net/DvidHalsz/smuggling-tcp-traffic-through-http-71473570）</a></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>主要是由两个问题导致：<br>1, one spice-html5 bug<br><a href="https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e" target="_blank" rel="external">https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</a><br>2, ssl默认使用PROTOCOL_SSLv23 （ <a href="https://docs.python.org/2/library/ssl.html#socket-creation" target="_blank" rel="external">https://docs.python.org/2/library/ssl.html#socket-creation</a> ）要使用tlsv1_2，或者在ssl.wrap_socket中直接指定＂ssl_version=ssl.PROTOCOL_TLSv1_2，或者使用nova与websockify的patch可以通过ssl_option来配置使用的tls版本。<br>3, 或者/usr/lib/python2.7/dist-packages/eventlet/green/ssl.py中不应该用PROTOCOL_TLSv1作为默认，而应该用PROTOCOL_SSLv23， 这样PROTOCOL_SSLv23会依赖底层ssl版本自动选择tlsv1_0, tlsv1_1, tlsv1_2, 这样即使防火墙disable  tlsv1_0也不影响使用tlsv1_2. 最终的原因是因为python-eventlet 0.18.4-1引入了Rebased set-defaults-to-be-tlsv1-not-sslv23.patch，是它使用了PROTOCOL_TLSv1，应该去掉。</p>
<h2 id="附录-Websocket-based-spice-client"><a href="#附录-Websocket-based-spice-client" class="headerlink" title="附录 - Websocket based spice client"></a>附录 - Websocket based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1, a test vm with spice enabled</span><br><span class="line">    &lt;graphics type=&apos;spice&apos; port=&apos;5900&apos; autoport=&apos;yes&apos; listen=&apos;127.0.0.1&apos;&gt;</span><br><span class="line">      &lt;listen type=&apos;address&apos; address=&apos;127.0.0.1&apos;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line"></span><br><span class="line">2, spice proxy side</span><br><span class="line">sudo apt install python3-websockify -y</span><br><span class="line">websockify 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">3, spice client side</span><br><span class="line">sudo apt install spice-html5 apache2 -y</span><br><span class="line">ls /usr/share/spice-html5/spice_auto.html #it&apos;s similar to https://10.5.1.11:6082/spice_auto.html?token=xxx</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">Alias /spice /usr/share/spice-html5</span><br><span class="line">&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">    Allow from all</span><br><span class="line">    Satisfy Any</span><br><span class="line">    DirectoryIndex spice.html</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo ln -s /etc/apache2/conf-available/ws.conf /etc/apache2/conf-enabled/ws.conf</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">4, access it via http://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br></pre></td></tr></table></figure>
<h2 id="附录-Websocket-ssl-based-spice-client"><a href="#附录-Websocket-ssl-based-spice-client" class="headerlink" title="附录 - Websocket ssl based spice client"></a>附录 - Websocket ssl based spice client</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">1, create key pairs</span><br><span class="line"></span><br><span class="line">mkdir ~/ca &amp;&amp; cd ~/ca</span><br><span class="line">openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out ca.crt -keyout ca.key -subj &quot;/C=US/ST=UK/L=London/O=Ubuntu/OU=IT/CN=CA&quot;</span><br><span class="line">for DOMAIN in server client</span><br><span class="line">do</span><br><span class="line">  openssl genrsa -out $DOMAIN.key</span><br><span class="line">  openssl req -new -key $DOMAIN.key -out $DOMAIN.csr -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=$DOMAIN&quot;</span><br><span class="line">  openssl x509 -req -in $DOMAIN.csr -out $DOMAIN.crt -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">2, spice server side</span><br><span class="line"></span><br><span class="line">sudo mkdir /etc/apache2/ssl &amp;&amp; sudo chown -R $USER /etc/apache2/ssl</span><br><span class="line">cp /home/hua/ca/server.crt /etc/apache2/ssl/</span><br><span class="line">cp /home/hua/ca/server.key /etc/apache2/ssl/</span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/apache2/conf-available/ws.conf</span><br><span class="line">&lt;VirtualHost 192.168.2.139:443&gt;</span><br><span class="line">        SSLEngine on</span><br><span class="line">        SSLCertificateFile      /etc/apache2/ssl/server.crt</span><br><span class="line">        SSLCertificateKeyFile   /etc/apache2/ssl/server.key</span><br><span class="line">        CustomLog       &quot;/var/log/apache2/ws.log&quot; combined</span><br><span class="line">        ErrorLog        &quot;/var/log/apache2/ws.log&quot;</span><br><span class="line">	Alias /spice /usr/share/spice-html5</span><br><span class="line">	&lt;Directory /usr/share/spice-html5&gt;</span><br><span class="line">	    # This page is broadly available, tune here to make it more restricted.</span><br><span class="line">	    Allow from all</span><br><span class="line">	    Satisfy Any</span><br><span class="line">	    DirectoryIndex spice.html</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br><span class="line">sudo a2enmod ssl</span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line">3, spice proxy side</span><br><span class="line">websockify --cert=/home/hua/ca/server.crt --key=/home/hua/ca/server.key --cafile=~/home/hua/ca/ca.crt --ssl-only --ssl-version=tlsv1_2 192.168.2.139:6082 127.0.0.1:5900</span><br><span class="line"></span><br><span class="line">4, access it via: https://192.168.2.139/spice/spice_auto.html?host=192.168.2.139&amp;port=6082</span><br><span class="line">   nmap --script ssl-enum-ciphers -p 6082 192.168.2.139</span><br><span class="line">   openssl s_client -connect 192.168.2.139:6082 -tls1_2</span><br><span class="line"></span><br><span class="line">5, debug, print http headers by adding the following scripts in /usr/share/spice-html5/spice_auto.html</span><br><span class="line"></span><br><span class="line">var req = new XMLHttpRequest();</span><br><span class="line">req.open(&apos;GET&apos;, document.location, false);  #but this is not the headers for websocket upgrade</span><br><span class="line">req.send(null);</span><br><span class="line">var headers = req.getAllResponseHeaders();</span><br><span class="line">alert(headers);</span><br><span class="line"></span><br><span class="line">6, why we see the following error when visitting the url &apos;https://10.5.2.196:6082/spice_auto.html?token=xxxx&apos;</span><br><span class="line"></span><br><span class="line">SecurityError: Failed to construct &apos;WebSocket&apos;: An insecure WebSocket connection may not be initiated from a page loaded over HTTPS.</span><br><span class="line"></span><br><span class="line">That&apos;s because the following content is missing in /usr/share/spice-html5/spice_auto.html, see this patch - https://github.com/freedesktop/spice-html5/commit/293d405e15a4499219fe81e830862cc2b1518e3e</span><br><span class="line"></span><br><span class="line">                if (window.location.protocol == &apos;https:&apos;) &#123;</span><br><span class="line">                    scheme = &quot;wss://&quot;;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<p>[1] <a href="https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html" target="_blank" rel="external">https://blog.surgut.co.uk/2019/08/how-to-disable-tls-10-and-tls-11-on.html</a><br>[2] <a href="https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464" target="_blank" rel="external">https://discourse.ubuntu.com/t/default-to-tls-v1-2-in-all-tls-libraries-in-20-04-lts/12464</a><br>[3] <a href="https://notes.bitfunnel.net/?q=node/54" target="_blank" rel="external">https://notes.bitfunnel.net/?q=node/54</a><br>[4] <a href="https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373" target="_blank" rel="external">https://github.com/certik/python-2.7/blob/master/Lib/ssl.py#L373</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/软路由/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/19/软路由/" itemprop="url">软路由</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-19T23:24:29+08:00">
                2020-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-08-19<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>升级了500M宽带，但电脑用网线直线WDNR4300路由器用perf3 -s与perf -c 192.168.99.1 -t 3测试时只不到200M．所以在一台式机上安装了软路由，测试结果立马上到接近1000M了．<br>但用了1000M的电力猫之后，速度又下降到120左右，改成有线连接之后，又马又上到1000M．<br>看来瓶颈在于WDNR4300与电力猫．</p>
<h2 id="安装软路由"><a href="#安装软路由" class="headerlink" title="安装软路由"></a>安装软路由</h2><p>台式机上有两个之前做SR-IOV实验用的千兆网卡 (Winyao WY576T PCI-E X4 双口服务器千兆网卡 82576 1000M), 及一个Intel集成网卡．</p>
<ul>
<li>enp6s0f0与enp6s0f1通过passthough映射到KVM虚机. 注意不要使用macvtap+bridge模式，因为这样会造成无法从局域网ping macvtap设备上的IP，当在插一根网线到Intel集成网卡上后，默认路由总是在enp6s0f0上，从而导致无法访问台式机．enp6s0f0映射到openwrt虚机里是eth1用于生成br-lan, enp6s0f1映射到openwrt虚机里是eth0.</li>
<li>直接KVM安装导入OpenWRT x86镜像即可 (github直接下载)</li>
</ul>
<h2 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h2><p>目前家中的网络拓扑是：</p>
<ul>
<li>光猫，打电话改了桥接</li>
<li>tplink千兆路由器(192.168.2.0/24)拨号, 下接一千兆交换机接NAS, TV, Camera等．</li>
<li>台式机的enp6s0f0接tplink，从软路由(192.168.98.0/24)出来后，enp6s0f1再接一千兆交换机．</li>
<li>WNDR4300仍然从tplink出(192.168.99.0/24)</li>
<li>千兆电力猫连接软路由至卧室（电力猫速度太差，需要改成有线）<h2 id="目前问题"><a href="#目前问题" class="headerlink" title="目前问题"></a>目前问题</h2></li>
<li>台式机停电再来电自动启动的问题，改了BIOS但还未测试</li>
<li>tplink上IPv6也要拨号但复用IPv4的拨号连接后是有IPv6地址的（光猫桥接并未挡住什么），客户端直接连接tplink也能拿到IPv6, 但tplink下挂的OpenWRT路由器却拿不到IPv6, 可能是OpenWrt镜像缺包吧，因为在WAN6那里找不到dhcpv6 client，只有dhcp client) ，原因见：　<a href="https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html" target="_blank" rel="external">https://agong.me/2019/soft-router-compile-ipv6-mppddial-by-top-navigation.html</a> (<strong>20200824更新,就是这个原因</strong>). 那现在另外一个路由器以dhcp接在这个拨号路由器后lan口又如何获取IPv6地址呢?</li>
<li>ubuntu在/etc/network/interfaces不定义时可以拿到IPv6，但要使用桥接如何定义也能拿到IPv6呢？</li>
<li>如何将无线网卡给KVM用，同时在openwrt虚机中用它做AP?</li>
</ul>
<h2 id="一级路由访问二级路由"><a href="#一级路由访问二级路由" class="headerlink" title="一级路由访问二级路由"></a>一级路由访问二级路由</h2><p>当在一级redmi ax5路由(192.168.2.1)下又接了一个二级openwrt路由(192.168.2.47, 192.168.99.1).<br>那一级路由下的node1(192.168.2.111)如何访问二级路由下的t440p (192.168.99.136)呢?<br>1, 先照着这处贴子将redmi ax5的ssh打开, 必须重启,之后就可以通过root/admin 来ssh了(不影响web管理密码), 然后使用’passwd root’来修改密码.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/web/home#router</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h;nvram set ssh%5Fen%3D1; nvram commit;</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20nvram%20set%20ssh_en%3D1%3B%20nvram%20commit%3B%20sed%20-i%20&apos;s%2Fchannel%3D.*%2Fchannel%3D%5C%22debug%5C%22%2Fg&apos;%20%2Fetc%2Finit.d%2Fdropbear%3B%20%2Fetc%2Finit.d%2Fdropbear%20start%3B</span><br><span class="line"></span><br><span class="line">http://192.168.2.1/cgi-bin/luci/;stok=5aa4576eb44e9e70dc1557c3e74b57a2/api/misystem/set_config_iotdev?bssid=Xiaomi&amp;user_id=longdike&amp;ssid=-h%3B%20echo%20-e%20&apos;admin%5Cnadmin&apos;%20%7C%20passwd%20root%3B</span><br></pre></td></tr></table></figure></p>
<p>2, 在二级路由器上如下图关闭防火墙,<br><img src="https://img-blog.csdnimg.cn/2020082422402826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>3, 在一级路由下添加静态路由<br>route add -net 192.168.99.0 netmask 255.255.255.0 gw 192.168.2.47</p>
<p>4, 在二级路由上将192.168.2.47作静态IP绑定(MAC/IP绑定即可)</p>
<p>5, 如果不行,似乎在一级路由器上上图中lan处防火墙设置中的forwarding不能是REJECT哦.</p>
<h2 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h2><p>miwifi上集成的DDNS服务基本上都是收费的, 花生壳的二级域名壳域名不收费, 但这家公司喜欢删域名, 要求你实名制, 但实名制前又问你最喜欢的动物是什么, 答错了还弄不成实名制, 打电话给客服了, 让你把身份证扫描件发到800@oray.com人工审核, 但也没下文了, 等得头疼. 另外, 就是太喜欢删域名了, 申请的壳域名忽然就删了, 被删了也不知道的怎么被删的, 死得不明不白. 得了, 还是整个免费的吧. 申请一个dnsexit的二级域名, 然后用下列脚本更新.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; /data/ddns&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/sh</span><br><span class="line">myip=$(curl -s http://myip.dnsomatic.com/)</span><br><span class="line">if [ -e &quot;ip.txt&quot; ]</span><br><span class="line">then</span><br><span class="line">  old_ip=$(cat ip.txt)</span><br><span class="line">  if [ &quot;$myip&quot; == &quot;$old_ip&quot; ]</span><br><span class="line">  then</span><br><span class="line">    echo &quot;Your IP $myip didn&apos;t change.&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;The IP Changed from $old_ip to $myip&quot;</span><br><span class="line">    change_dot_com=$(curl -s &quot;http://update.dnsexit.com/RemoteUpdate.sv?login=&lt;user&gt;&amp;password=&lt;password&gt;&amp;host=&lt;domain&gt;&amp;myip=$&#123;myip&#125;&quot;)</span><br><span class="line">    echo &quot;$change_dot_com&quot;</span><br><span class="line">    sleep 2</span><br><span class="line">  fi</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$myip&quot; &gt; ip.txt</span><br><span class="line">    echo &quot;Your IP is $myip&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">chmod +x /data/ddns</span><br><span class="line">crontab -e</span><br><span class="line">*/60 * * * * /data/ddns &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">nslookup -vc quqi99.publicvm.com 8.8.8.8</span><br></pre></td></tr></table></figure>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>1, 默认REJET</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">config defaults</span><br><span class="line">        option syn_flood &apos;0&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option drop_invalid &apos;1&apos;</span><br><span class="line">        option disable_ipv6 &apos;0&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;lan&apos;</span><br><span class="line">        option network &apos;lan&apos;</span><br><span class="line">        option input &apos;ACCEPT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;ACCEPT&apos;</span><br><span class="line">config zone</span><br><span class="line">        option name &apos;wan&apos;</span><br><span class="line">        list network &apos;wan&apos;</span><br><span class="line">        list network &apos;wan6&apos;</span><br><span class="line">        option input &apos;REJECT&apos;</span><br><span class="line">        option output &apos;ACCEPT&apos;</span><br><span class="line">        option forward &apos;REJECT&apos;</span><br><span class="line">        option masq &apos;1&apos;</span><br><span class="line">        option mtu_fix &apos;1&apos;</span><br></pre></td></tr></table></figure>
<p>2, 打开22端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config rule &apos;ssh&apos;</span><br><span class="line">        option name &apos;ssh&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option target &apos;ACCEPT&apos;</span><br><span class="line">        option family &apos;ipv4&apos;</span><br></pre></td></tr></table></figure></p>
<p>3, 转发2222端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">config redirect &apos;wan2222rdr1&apos;</span><br><span class="line">        option proto &apos;tcp&apos;</span><br><span class="line">        option src_dport &apos;2222&apos;</span><br><span class="line">        option dest_ip &apos;192.168.2.47&apos;</span><br><span class="line">        option dest_port &apos;22&apos;</span><br><span class="line">        option src &apos;wan&apos;</span><br><span class="line">        option name &apos;x86_openwrt&apos;</span><br><span class="line">        option target &apos;DNAT&apos;</span><br><span class="line">        option ftype &apos;1&apos;</span><br><span class="line">        option dest &apos;lan&apos;</span><br><span class="line">root@XiaoQiang:~# iptables-save |grep 47</span><br><span class="line">-A zone_lan_postrouting -s 192.168.2.0/24 -d 192.168.2.47/32 -p tcp -m tcp --dport 22 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j SNAT --to-source 192.168.2.1</span><br><span class="line">-A zone_lan_prerouting -s 192.168.2.0/24 -d 123.115.196.xxx/32 -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt (reflection)&quot; -j DNAT --to-destination 192.168.2.47:22</span><br><span class="line">-A zone_wan_prerouting -p tcp -m tcp --dport 2222 -m comment --comment &quot;!fw3: x86_openwrt&quot; -j DNAT --to-destination 192.168.2.47:22</span><br></pre></td></tr></table></figure>
<p>转发端口时不需要为2222单独定义input规则, 另外, 联通除了封80, 443, 以外其实没有封其它端口, 可用<a href="https://tool.chinaz.com/port/" target="_blank" rel="external">https://tool.chinaz.com/port/</a> 检测 (检测时得做redirect规则, 且开服务)</p>
<h2 id="https网站不好使"><a href="#https网站不好使" class="headerlink" title="https网站不好使"></a>https网站不好使</h2><p>像csdn与baidu等网站出现HSTS相关的证书错误, 是因为广告过滤大师使用了KoolProxy签发的证书所致, 所以需要关闭广告过滤大师.</p>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&quot;data-root&quot;: &quot;/mnt/udisk/docker&quot;,</span><br><span class="line">/etc/init.d/dockerd restart</span><br><span class="line"></span><br><span class="line">#install a better docker frontend - https://koolshare.cn/thread-180474-1-1.html</span><br><span class="line">docker pull portainer/portainer</span><br><span class="line">#create a continer with portainer image, expose port 9000:9000/tcp and bind mount &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">http://192.168.99.1:9000/#/init/admin</span><br><span class="line">http://192.168.99.1:9000/#/dashboard</span><br><span class="line"></span><br><span class="line">#intall docker search ubuntu</span><br><span class="line">docker pull ubuntu</span><br><span class="line">docker run -it ubuntu</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<h2 id="天翼云盘"><a href="#天翼云盘" class="headerlink" title="天翼云盘"></a>天翼云盘</h2><p>天翼云盘是一个独立的家庭云空间，不等同于天翼云，无法获取S3登陆参数，也关闭了API - <a href="https://zhuanlan.zhihu.com/p/38592985" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/38592985</a><br>所以它无法使用s3fs加载块设备，但使用s3fs的方法类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential libfuse-dev libcurl4-openssl-dev libxml2-dev mime-support automake libtool s3fs</span><br><span class="line">echo xxx:xxx |sudo tee /etc/passwd-s3fs &amp;&amp; sudo chmod 600 /etc/passwd-s3fs &amp;&amp; sudo chown $USER /etc/passwd-s3fs</span><br><span class="line">sudo mkdir /mnt/tianyi &amp;&amp; sudo chown $USER /mnt/tianyi</span><br><span class="line">s3fs -o passwd_file=/etc/passwd-s3fs -o url=http://oos.ctyunapi.cn bucket-dingjia /mnt/tianyi</span><br><span class="line">df -h</span><br><span class="line">fusermount -u /mnt/tianyi</span><br></pre></td></tr></table></figure>
<p>它可以使用sharelist，但用途不大．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sudo apt install nodejs npm -y  &amp;&amp; sudo npm install -g npm</span><br><span class="line">git clone https://github.com/reruin/sharelist.git</span><br><span class="line">cd sharelist &amp;&amp; sudo chmod +x ./install.sh &amp;&amp; sudo ./install.sh  #http://127.0.0.1:33001/</span><br><span class="line">#cd ./sharelist/ &amp;&amp; node app.js                                  #http://127.0.0.1:33001/</span><br></pre></td></tr></table></figure></p>
<h2 id="BaiduPCS-Web"><a href="#BaiduPCS-Web" class="headerlink" title="BaiduPCS-Web"></a>BaiduPCS-Web</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># server side</span><br><span class="line"># nfs GUI(http://192.168.99.1/cgi-bin/luci/admin/nas/nfs)是坏的(luci-app-nfs - https://github.com/coolsnowwolf/lede/issues/2957)，只能使用CLI</span><br><span class="line">echo &apos;/mnt/sdb1/nfs *(rw,sync,no_root_squash,subtree_check)&apos; &gt;&gt; /etc/exports</span><br><span class="line">/etc/init.d/nfsd restart</span><br><span class="line"></span><br><span class="line"># client side</span><br><span class="line">showmount -e 192.168.99.1</span><br><span class="line">sudo mount -t nfs 192.168.99.1:/mnt/sdb1/nfs /openwrt</span><br><span class="line">sudo fuser -m -v /openwrt/</span><br><span class="line">$ cat /etc/auto.direct |tail -n1</span><br><span class="line">/openwrt    -fstype=nfs4,rsize=32768,wsize=32768     192.168.99.1:/mnt/sdb1/nfs</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://hansendong.me/609/" target="_blank" rel="external">https://hansendong.me/609/</a><br>[2] <a href="https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453" target="_blank" rel="external">https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=4040453</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/09/Play-with-MAAS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/09/Play-with-MAAS/" itemprop="url">Play with MAAS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T10:25:42+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>问题</strong><br>四年前写了一篇关于MAAS的博客 [1]，但好几年没用它了，今天发现GUI的操作流程变化还有点，记录一下。<br><strong>Host机</strong><br>配置了下面的网络：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">auto br-eth0</span><br><span class="line">iface br-eth0 inet static</span><br><span class="line">    address 192.168.99.124/24</span><br><span class="line">    gateway 192.168.99.1</span><br><span class="line">    bridge_ports eth0</span><br><span class="line">    dns-nameservers 192.168.99.1</span><br></pre></td></tr></table></figure></p>
<p>然后在virt-manger里创建了一个名为cloud的虚拟网络(192.168.100.0/24)，未使用DHCP。<br>最后，使用virt-manager创建了一个名为maas的虚机,给它分配了两个网卡(ens3=192.168.100.3用作MAAS的IP,另一个网卡ens8=192.168.99.1纯粹为了方便管理之用)<br><strong>maas虚机</strong><br>网络配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolvconf/resolv.conf.d/base</span><br><span class="line">search maas</span><br><span class="line">nameserver 192.168.100.3</span><br><span class="line"></span><br><span class="line">or modify /etc/systemd/resolved.conf to set DNS=192.168.100.3, then run:</span><br><span class="line">sudo systemctl restart systemd-resolved.service</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ifupdown has been replaced by netplan(5) on this system.  See</span><br><span class="line"># /etc/netplan for current configuration.</span><br><span class="line"># To re-enable ifupdown on this system, you can run:</span><br><span class="line">sudo apt install ifupdown</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">auto ens3</span><br><span class="line">iface ens3 inet static</span><br><span class="line">address 192.168.100.3</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.100.1</span><br><span class="line"></span><br><span class="line">auto ens8</span><br><span class="line">iface ens8 inet static</span><br><span class="line">address 192.168.99.3</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">gateway 192.168.99.1</span><br></pre></td></tr></table></figure>
<p>安装maas:<br>NOTE: 千万要注意，<strong>最好使用debian包安装</strong>，使用snap包安装里会造成snap container里没有设置REQUESTS_CA_BUNDLE环境变量由于python-requests的一个bug导致maas无法使用https服务，例如运行＂maas configauth –rbac-url <a href="https://node1.lan:5000/" target="_blank" rel="external">https://node1.lan:5000/</a> –rbac-service-name maastest＂就会抛错CERTIFICATE_VERIFY_FAILED, 具体见：　<a href="https://zhhuabj.blog.csdn.net/article/details/107182847" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/107182847</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install maas --channel=2.8</span><br><span class="line">#sudo snap install maas-test-db                              #enter shell - maas-test-db.psql</span><br><span class="line">sudo add-apt-repository ppa:maas/2.8   #https://launchpad.net/~maas</span><br><span class="line">sudo apt install maas</span><br></pre></td></tr></table></figure></p>
<p>配置maas虚机可以无密码访问物理机上的libvirt:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo chsh maas -s /bin/bash</span><br><span class="line">sudo su - maas</span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa hua@192.168.100.1</span><br><span class="line">sudo -u maas virsh -c qemu+ssh://hua@192.168.100.1/system list --all</span><br></pre></td></tr></table></figure></p>
<p>创建maas管理员用户之后就可以通过<a href="http://192.168.99.3:5240/MAAS登录GUI管理界面了" target="_blank" rel="external">http://192.168.99.3:5240/MAAS登录GUI管理界面了</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo maas createadmin</span><br><span class="line">apikey=$(sudo maas apikey --username admin)</span><br><span class="line">maas login admin http://192.168.100.3:5240/MAAS $apikey</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line">maas admin boot-resources import</span><br></pre></td></tr></table></figure></p>
<h2 id="enable-PXE"><a href="#enable-PXE" class="headerlink" title="enable PXE"></a>enable PXE</h2><p>在’Subnets’点击subnet 192.168.100.0/24对应的vlan(untagged)后’enable dhcp’才能enable PXE.<br><img src="https://img-blog.csdnimg.cn/20200925183035294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>注册maas节点</strong><br>创建一块空磁盘(truncate –size 10G /images/kvm/controller.raw)，然后在virt-manager里创建一个名为controller的新虚机(设置从PXE启动、使用truncate定义的空磁盘，同时<strong>从cloud network中定义四块网卡)</strong>, 我们能从virt-manager中看到pxe的启动过程，但最后却一闪而过了那是因为需要从maas里来启动它。好，从virt-manager中关闭该虚机，同时<strong>记得再将启动模式改回PXE</strong>。<br>NOTE: 如果此时还不行, 多半是上面一步没有enable pxe吧. 另外, 在commission时无法选择image, 只能使用默认的ubuntu image, 在deploy时可以设置使用其他如centos镜像.<br><img src="https://img-blog.csdn.net/20180724115011109?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>然后访问GUI的”Nodes -&gt; Add hardware -&gt; Machine”定义节点(注意：<strong>四块网卡的MAC地址一次性定义，如果后续此处添加网卡的话还得再执行commission操作</strong>）:<br><img src="https://img-blog.csdn.net/20180724131740628?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>commission过程可从下列几个方式调试：</p>
<ul>
<li>virt-manager vnc可以看到</li>
<li>maas节点上的/var/log/maas/maas.log</li>
<li>controller虚机(IP可从GUI里找到)里的cloud-init日志</li>
</ul>
<p>然后根据在virt-manager中定义的四块网卡的MAC地址在maas中也如下图定义一下：<br><img src="https://img-blog.csdn.net/20180724121359167?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>四块网卡定义好了之后得重新点击一下”Take action -&gt; Commision”，然后将看到如下界面：<br><img src="https://img-blog.csdn.net/20180724122506159?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>然后我们将看到”Add Interface”、”Create bond”、”Create Bridge”等按钮，先将ens8和ens9做成bond0，再在bond0上创建一些vlan（先建vlan再建bridge顺序不能变)，最后将bond0做成br-bond0，最后如下图：<br><img src="https://img-blog.csdn.net/20180724141419499?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p>
<p>接着还要再点击”Take action -&gt; Deploy” (<strong>注意: 此处不是点commissioning</strong>) 重新部署，最后就可以从GUI界面中找到IP后通过ssh ubuntu@IP访问了</p>
<h2 id="附录-CLI"><a href="#附录-CLI" class="headerlink" title="附录 - CLI"></a>附录 - CLI</h2><p><img src="https://img-blog.csdnimg.cn/20200923084601361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">https://docs.maas.io/2.5/en/manage-cli-advanced</span><br><span class="line">https://maas.io/docs/concepts-and-terms</span><br><span class="line">region相当于一个datacenter或者一个single region, fabrics再去划分region, 每个rack controller都被attached到每一个fabric.</span><br><span class="line">rack下关联node, interfaces, fabric; interface关联subnets, subnets有vlan</span><br><span class="line">fabric下再关联vlan; vlan关联space</span><br><span class="line">interfaces下link到subnet, subnet有vlan</span><br><span class="line"></span><br><span class="line">maas login admin http://localhost/MAAS/api/2.0 $(sudo maas-region apikey --username admin)</span><br><span class="line"></span><br><span class="line">#machine_id=$(maas admin machines read | jq -r &apos;.[] | select(.hostname==&quot;controller&quot;).system_id&apos;)</span><br><span class="line">#maas admin interfaces read $machine_id &gt; interface.txt</span><br><span class="line"></span><br><span class="line">maas admin rack-controllers read</span><br><span class="line">system_id=$(maas admin rack-controllers read | jq -r .[].system_id)</span><br><span class="line"></span><br><span class="line">maas admin machines read</span><br><span class="line">machine_id=$(maas admin machines read | jq -r &apos;.[] | select(.hostname==&quot;controller&quot;).system_id&apos;)</span><br><span class="line">maas admin machines read |jq &quot;.[] | &#123;hostname:.hostname, system_id: .system_id, status:.status&#125;&quot; --compact-output</span><br><span class="line"></span><br><span class="line">maas admin interfaces read &quot;$system_id&quot;</span><br><span class="line">maas admin interfaces read $system_id | jq &quot;.[] |&#123;id:.id, name:.name, mac:.mac_address, vid:.vlan.vid, fabric:.vlan.fabric&#125;&quot; --compact-output</span><br><span class="line">maas admin interface update &quot;$system_id&quot; $interface vlan=5001</span><br><span class="line">#maas admin interface unlink-subnet &quot;$system_id&quot; &quot;$iface_id&quot; id=&quot;$link_id&quot;</span><br><span class="line">#maas admin interface delete &quot;$system_id&quot; &quot;$vlan_iface_id&quot;</span><br><span class="line">#maas admin interface link-subnet &quot;$system_id&quot; &quot;$iface_id&quot; mode=AUTO subnet=&quot;$iface_subnet_cidr&quot;</span><br><span class="line">interfaces=$(maas admin interfaces read &quot;$system_id&quot;)</span><br><span class="line">iface_name=&quot;ens3&quot;</span><br><span class="line">iface_id=$(echo &quot;$interfaces&quot; | jq -r &quot;.[] | select(.name==\&quot;$iface_name\&quot;) | .id&quot;)</span><br><span class="line">link_ids=$(maas admin interface read &quot;$system_id&quot; &quot;$iface_id&quot; | jq -r &apos;.links | .[].id&apos;)</span><br><span class="line">for link_id in $link_ids; do</span><br><span class="line">   maas admin interface unlink-subnet &quot;$system_id&quot; &quot;$iface_id&quot; id=&quot;$link_id&quot;</span><br><span class="line">done</span><br><span class="line">vlan_iface_ids=$(maas admin interfaces read &quot;$system_id&quot; | jq -r &apos;.[] | select(.type==&quot;vlan&quot;).id&apos;)</span><br><span class="line">for vlan_iface_id in $vlan_iface_ids; do</span><br><span class="line">   maas admin interface delete &quot;$system_id&quot; &quot;$vlan_iface_id&quot;</span><br><span class="line">done</span><br><span class="line">iface_subnet_cidr=$(maas admin subnets read | jq -r &quot;.[] | select(.name==\&quot;$iface_subnet_name\&quot;).cidr&quot;)</span><br><span class="line">maas admin interface link-subnet &quot;$system_id&quot; &quot;$iface_id&quot; mode=AUTO subnet=&quot;$iface_subnet_cidr&quot;</span><br><span class="line"></span><br><span class="line">maas admin fabrics read</span><br><span class="line">maas admin fabrics read | jq &quot;.[] |&#123;name:.name, vlans:.vlans[] | &#123;id:.id, vid:.vid&#125;&#125;&quot; --compact-output</span><br><span class="line">maas admin fabric update 0 name=maas-management</span><br><span class="line">fabric_name=&quot;maas-management&quot;</span><br><span class="line">mag_fabric_id=$(maas admin fabrics read| jq -r &quot;.[] | select(.name==\&quot;$fabric_name\&quot;).id&quot;)</span><br><span class="line"></span><br><span class="line">vid=$(maas admin subnets read | jq -M &apos;.[] | select(.cidr==&quot;10.12.1.0/24&quot;).vlan.vid&apos;)</span><br><span class="line">fabric=$(maas admin subnets read| jq -r &apos;.[] | select(.cidr==&quot;10.12.1.0/24&quot;).vlan.fabric&apos;)</span><br><span class="line">fabric_id=$(maas admin fabrics read | jq -M &apos;.[] | select(.name==&quot;`echo $fabric`&quot;).id&apos;)  #$fabric=fabric-1</span><br><span class="line">maas admin vlan read $fabric_id $vid</span><br><span class="line"></span><br><span class="line">maas admin spaces create name=os-floating</span><br><span class="line">os_floating_spaceid=$(maas admin spaces read | jq &apos;.[] | select(.name == &quot;&apos;os-floating&apos;&quot;)&apos;.id)</span><br><span class="line">maas admin vlan update $mag_fabric_id 5 space=$os_floating_spaceid mtu=1500</span><br><span class="line"></span><br><span class="line">maas admin subnets read</span><br><span class="line">maas admin subnet update $(maas admin subnets read| jq -r &quot;.[] | select(.cidr==\&quot;10.231.16.0/24\&quot;).id&quot;) cidr=10.231.16.0/21</span><br><span class="line">pxe_subnet_id=$(maas admin subnets read| jq -r &quot;.[] | select(.cidr==\&quot;10.231.16.0/21\&quot;).id&quot;)</span><br><span class="line">maas admin subnet update $pxe_subnet_id name=maas-management</span><br></pre></td></tr></table></figure>
<h2 id="附录-MAAS-Region-HA"><a href="#附录-MAAS-Region-HA" class="headerlink" title="附录 - MAAS Region HA"></a>附录 - MAAS Region HA</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"># https://sites.google.com/site/openstackinthebasement3/maasha</span><br><span class="line"># https://cloud.google.com/community/tutorials/setting-up-postgres-hot-standby</span><br><span class="line">sudo apt remove --purge postgresql maas*</span><br><span class="line">sudo apt autoremove</span><br><span class="line">sudo apt install maas-region-controller</span><br><span class="line">#sudo dpkg-reconfigure maas-region-controller</span><br><span class="line">#sudo dpkg-reconfigure maas-rack-controller</span><br><span class="line"></span><br><span class="line"># on maas to create user</span><br><span class="line">sudo maas createadmin --username admin --password ubuntu --email root@example.com</span><br><span class="line"></span><br><span class="line"># on maas and maas2</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/postgresql/9.5/main/pg_hba.conf&apos; &lt;&lt; EOF</span><br><span class="line">host     replication     repuser         192.168.100.3/32        md5</span><br><span class="line">host     replication     repuser         192.168.100.4/32        md5</span><br><span class="line">host     all             all             192.168.100.3/32        md5</span><br><span class="line">host     all             all             192.168.100.4/32        md5</span><br><span class="line">host     replication     repuser         192.168.99.3/32        md5</span><br><span class="line">host     replication     repuser         192.168.99.4/32        md5</span><br><span class="line">host     all             all             192.168.99.3/32        md5</span><br><span class="line">host     all             all             192.168.99.4/32        md5</span><br><span class="line">host     all             all             192.168.0.0/16        md5</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># on both maas and maas2</span><br><span class="line">sudo -u postgres createuser -U postgres repuser -P -c 5 --replication</span><br><span class="line">#sudo mkdir -p /var/lib/postgresql/9.5/main/mnt/server/archivedir</span><br><span class="line">#sudo chown postgres:postgres /var/lib/postgresql/9.5/main/mnt/server/archivedir</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/postgresql/9.5/main/postgresql.conf&apos; &lt;&lt; EOF</span><br><span class="line">listen_addresses = &apos;*&apos;</span><br><span class="line">max_connections = 300</span><br><span class="line">wal_level = hot_standby</span><br><span class="line">synchronous_commit = on</span><br><span class="line">archive_mode = off</span><br><span class="line">#archive_mode = on</span><br><span class="line">#archive_command = &apos;test ! -f /var/lib/postgresql/9.5/main/mnt/server/archivedir/%f &amp;&amp; cp %p /var/lib/postgresql/9.5/main/mnt/server/archivedir/%f&apos;</span><br><span class="line">max_wal_senders = 10</span><br><span class="line">wal_keep_segments = 256</span><br><span class="line">hot_standby = on</span><br><span class="line">restart_after_crash = off</span><br><span class="line">hot_standby_feedback = on</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># on maas, restart postgresql</span><br><span class="line">sudo systemctl restart postgresql.service</span><br><span class="line"></span><br><span class="line"># on maas2 run the db backup</span><br><span class="line">sudo systemctl stop postgresql</span><br><span class="line">sudo mv /var/lib/postgresql/9.5/main /var/lib/postgresql/9.5/main.old</span><br><span class="line">sudo -u postgres pg_basebackup -h 192.168.100.3 -D /var/lib/postgresql/9.5/main -U repuser -v -P --xlog-method=stream</span><br><span class="line"></span><br><span class="line">sudo cp /usr/share/postgresql/9.5/recovery.conf.sample /var/lib/postgresql/9.5/main/recovery.conf</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /var/lib/postgresql/9.5/main/recovery.conf&apos; &lt;&lt; EOF</span><br><span class="line">standby_mode = on</span><br><span class="line">primary_conninfo = &apos;host=192.168.100.3 port=5432 user=repuser password=password&apos;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># on maas2 configure the region to point at the main database</span><br><span class="line">sudo systemctl stop maas-regiond</span><br><span class="line">sudo rm /var/lib/maas/&#123;maas_id,secret&#125;</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/maas/regiond.conf&apos; &lt;&lt; EOF</span><br><span class="line">database_host: 192.168.100.3</span><br><span class="line">database_name: maasdb</span><br><span class="line">database_pass: FiPQSKlBpAvs</span><br><span class="line">database_port: 5432</span><br><span class="line">database_user: maas</span><br><span class="line">maas_url: http://192.168.99.4:5240/MAAS</span><br><span class="line">EOF</span><br><span class="line">sudo chown root:maas /etc/maas/regiond.conf</span><br><span class="line">sudo chmod 640 /etc/maas/regiond.conf</span><br><span class="line">sudo systemctl restart maas-regiond</span><br><span class="line"></span><br><span class="line"># on maas2 start postgres, now you should see the second region controller in the maas gui</span><br><span class="line">sudo systemctl restart postgresql</span><br><span class="line">sudo tail -f /var/log/postgresql/postgresql-9.5-main.log</span><br><span class="line">#2019-06-11 12:38:26 JST [29904-4] LOG:  consistent recovery state reached at 0/230000F8</span><br><span class="line">#2019-06-11 12:38:26 JST [29903-1] LOG:  database system is ready to accept read only connections</span><br><span class="line">#2019-06-11 12:38:26 JST [29908-1] LOG:  started streaming WAL from primary at 0/24000000 on timeline 1</span><br><span class="line">sudo -u postgres psql maasdb -c &apos;SELECT hostname,status,power_state FROM maasserver_node&apos;</span><br><span class="line"></span><br><span class="line"># we don&apos;t enable maas-dns in this test, on both maas and maas2 servers, clean up the bind9 conflicts:</span><br><span class="line">sudo maas-region edit_named_options --migrate-conflicting-options</span><br><span class="line">sudo systemctl restart bind9</span><br><span class="line"># and also modifty /etc/resolv.conf to use maas dns</span><br><span class="line"></span><br><span class="line"># setup HAproxy for load balancing on both maas and maas2 servers</span><br><span class="line"># then refresh the gui you will see the region jump from one server to the other back and forth.</span><br><span class="line">sudo systemctl stop apache2</span><br><span class="line">sudo systemctl disable apache2</span><br><span class="line">sudo apt install haproxy -y</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/haproxy/haproxy.cfg&apos; &lt;&lt; EOF</span><br><span class="line">frontend maas</span><br><span class="line">    bind    *:80</span><br><span class="line">    retries 3</span><br><span class="line">    option  redispatch</span><br><span class="line">    option  http-server-close</span><br><span class="line">    default_backend maas</span><br><span class="line">backend maas</span><br><span class="line">    timeout server 30s</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server localhost localhost:5240 check</span><br><span class="line">    server maas 192.168.99.3:5240 check</span><br><span class="line">    server maas2 192.168.99.4:5240 check</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart haproxy</span><br><span class="line"></span><br><span class="line"># setup keepalived (vip) on both maas and maas2, NOTE: fce use packemaker+corosync instead</span><br><span class="line">sudo apt install keepalived -y</span><br><span class="line">sudo modprobe ip_vs</span><br><span class="line">sudo sh -c &apos;echo modprobe ip_vs &gt;&gt; /etc/modules&apos;</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/sysctl.d/60-keepalived-nonlocal.conf&apos; &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart procps</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/keepalived/keepalived.conf&apos; &lt;&lt; EOF</span><br><span class="line"># https://docs.maas.io/2.3/en/manage-ha</span><br><span class="line"># Un-comment next 4 lines if using haproxy</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line"># Un-comment next 4 lines if using apache2</span><br><span class="line">vrrp_script chk_apache2 &#123;</span><br><span class="line">    script &quot;killall -0 apache2&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_named &#123;</span><br><span class="line">    script &quot;killall -0 named&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance maas_region &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens8</span><br><span class="line">    priority 150</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass password</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        ### Un-comment next line if using haproxy</span><br><span class="line">        chk_haproxy</span><br><span class="line">        ### Un-comment next line if using apache2</span><br><span class="line">        #chk_apache2</span><br><span class="line">        chk_named</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.5</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"># adjust an API server to use VIP=192.168.99.5  (http://192.168.99.5/MAAS)</span><br><span class="line">sudo maas-region local_config_set --maas-url http://192.168.99.5/MAAS</span><br><span class="line">sudo systemctl restart maas-regiond</span><br><span class="line"></span><br><span class="line"># install rack on maas and maas2, and adjust api server to use VIP=192.168.99.5</span><br><span class="line">sudo apt install -y maas-rack-controller</span><br><span class="line">sudo maas-rack register --url http://192.168.99.5/MAAS --secret $(sudo cat /var/lib/maas/secret)</span><br><span class="line">#sudo maas-rack config --region-url http://192.168.99.5/MAAS</span><br><span class="line">#sudo systemctl restart maas-rackd.service</span><br><span class="line">maas login admin http://192.168.99.5/MAAS/api/2.0 $(sudo maas-region apikey --username admin)</span><br><span class="line">maas admin rack-controllers read | grep hostname | cut -d &apos;&quot;&apos; -f 4</span><br><span class="line"></span><br><span class="line"># actuall we didn&apos;t enable maas-dns service in this test</span><br><span class="line">sudo systemctl list-unit-files --type=service | grep maas-dhcp</span><br><span class="line">ubuntu@maas:~$ cat /etc/resolv.conf</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 192.168.100.3</span><br><span class="line">#search maas</span><br><span class="line">ubuntu@maas2:~$ cat /etc/resolv.conf</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 192.168.100.4</span><br><span class="line">#search maas</span><br><span class="line"></span><br><span class="line"># the following error is because I accidentally created recovery.conf on the master server instead of the standby.</span><br><span class="line">2019-06-11 15:25:05 JST [15474-1] maas@maasdb ERROR:  cannot execute INSERT in a read-only transaction</span><br><span class="line">2019-06-11 15:31:44 JST [18618-1] maas@maasdb ERROR:  cannot execute LISTEN during recovery</span><br><span class="line"></span><br><span class="line"># present problem</span><br><span class="line">1, can&apos;t add the second rack-controller</span><br><span class="line">2, there is maas-dns and maas-dns ha</span><br><span class="line">3, lots of errors - django.db.utils.InternalError: cannot execute UPDATE in a read-only transaction</span><br><span class="line"></span><br><span class="line">sudo maas-region dbshell --installed</span><br><span class="line">maasdb=# \x</span><br><span class="line">maasdb=# select system_id, hostname from maasserver_node;</span><br><span class="line">maasdb=# \?</span><br><span class="line">maasdb=# \l</span><br><span class="line">maasdb=# \c maasdb</span><br><span class="line">maasdb=# \dtq</span><br></pre></td></tr></table></figure>
<h2 id="附录-Postgres-HA-replication-mode"><a href="#附录-Postgres-HA-replication-mode" class="headerlink" title="附录 - Postgres HA replication mode"></a>附录 - Postgres HA replication mode</h2><p>postgres HA的replication方式有3种:</p>
<ol>
<li><p>基于日志的复制, master完完WAL日志后再发给slave,<br>这样如果还没写完日志master就宕机的话未发的日志内的事务将全部丢失<br>2, 异步流模式,master库以stream的模式向slave发日志, 不需要等待整个日志填充完毕再发大大降低了丢失数据的风险.但在master提交事务之后standby等待流数据时发生宕机也会导致最后一个事务丢失. 同时备库可以配置成host standby模式向外提供查询服务供分担负载.<br>3, 流同步复制模式(synchronous replication),流复制的同步版本, 向master发生commit命令之后, 该命令会被阻塞,直到WAL日志流在所有被配置为同步节点(synchronous_standby_names)的数据库上提交后才会真正提交.因为只有master库和standby库同时宕机才会丢数据. 多层事务嵌套时，子事务不受此保护，只有最上层事务受此保护。纯读操作和回滚不受此影响。同时备库可以配置成HOT Standby，可以向外提供查询服务，供分担负载。采用这种模式的性能损耗依据网络情况和系统繁忙程度而定，网络越差越繁忙的系统性能损耗越严重。</p>
<h2 id="Debug-MaaS"><a href="#Debug-MaaS" class="headerlink" title="Debug MaaS"></a>Debug MaaS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#read maas db</span><br><span class="line">grep -r &apos;database&apos; /etc/maas/regiond.conf</span><br><span class="line">#sudo maas-region dbshell --installed</span><br><span class="line">sudo -iu postgres psql -d template1 -U postgres</span><br><span class="line"></span><br><span class="line"># debug maas - https://github.com/maas/maas/blob/master/HACKING.rst</span><br><span class="line">systemctl stop maas-regiond</span><br><span class="line"># disable any log as much as possible</span><br><span class="line">/usr/bin/python3 /usr/sbin/regiond --debug --workers 1</span><br><span class="line"></span><br><span class="line">systemctl stop maas-rackd</span><br><span class="line">setcap cap_net_bind_service=+eip /usr/sbin/rackd</span><br><span class="line">/bin/rm -f /var/lib/maas/dhcpd.sock &amp;&amp; /bin/rm -f /var/lib/maas/dhcpd.conf &amp;&amp; /bin/rm -f /var/lib/maas/dhcpd6.conf &amp;&amp; sleep 1 &amp;&amp; LOGFILE=/var/log/maas/rackd.log prometheus_multiproc_dir=/var/lib/maas/prometheus /usr/bin/python3 /usr/sbin/rackd --nodaemon</span><br><span class="line"></span><br><span class="line">enable debug log - https://discourse.maas.io/t/running-installed-maas-in-debug-logging-mode/168</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="20200907更新-maas-network-discovery"><a href="#20200907更新-maas-network-discovery" class="headerlink" title="20200907更新 - maas network_discovery"></a>20200907更新 - maas network_discovery</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:maas/2.7  #2.7 only worked on bionic</span><br><span class="line">sudo apt install -y maas</span><br><span class="line">sudo maas init --admin-username admin --admin-password password --admin-email admin@example.com --admin-ssh-import zhhuabj</span><br><span class="line">sudo maas-region apikey --username=admin &gt; ~/admin-api-key</span><br><span class="line">curl http://192.168.2.111:5240/MAAS</span><br><span class="line">apikey=$(cat ~/admin-api-key)</span><br><span class="line">maas login admin http://192.168.2.111:5240/MAAS $apikey</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line">maas admin boot-resources import</span><br><span class="line"></span><br><span class="line">$ maas admin discoveries read |jq &quot;.[] | &#123;ip:.ip, mac_address:.mac_address&#125;&quot; --compact-output</span><br><span class="line">&#123;&quot;ip&quot;:&quot;192.168.100.1&quot;,&quot;mac_address&quot;:&quot;52:54:00:14:3a:d4&quot;&#125;</span><br><span class="line">&#123;&quot;ip&quot;:&quot;192.168.100.77&quot;,&quot;mac_address&quot;:&quot;52:54:00:f8:9b:2b&quot;&#125;</span><br><span class="line">maas admin discoveries clear-by-mac-and-ip ip=&lt;IP&gt; mac=&lt;MAC&gt;</span><br><span class="line"></span><br><span class="line">#delete from maasserver_interface_ip_addresses where staticipaddress_id=64548 and id=64188;</span><br><span class="line">#delete from maasserver_staticipaddress where id=64548 and ip=&apos;192.168.128.15&apos;;</span><br><span class="line"></span><br><span class="line">#http://127.0.0.1:5240/MAAS/r/settings/network/network-discovery (Network discovery -&gt; Active subnet mapping interval)</span><br><span class="line">maas admin  maas get-config name=network_discovery</span><br><span class="line">maas admin discoveries clear all=True</span><br><span class="line">maas admin maas set-config name=network_discovery value=disabled</span><br><span class="line">maas admin maas get-config name=network_discovery</span><br><span class="line">maas admin discoveries read</span><br></pre></td></tr></table></figure>
<h2 id="20200915更新-maas-2-8中使用centos-8"><a href="#20200915更新-maas-2-8中使用centos-8" class="headerlink" title="20200915更新 - maas 2.8中使用centos 8"></a>20200915更新 - maas 2.8中使用centos 8</h2><p>maas中使用centos的主要障碍是<a href="https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335，但这个目前这个代码已经在UA了，只是maas" target="_blank" rel="external">https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335，但这个目前这个代码已经在UA了，只是maas</a> 2.8的UI还没有允许让你使用centos 8而已，可以这样使用centos 8<br>但是限制是：</p>
<ul>
<li>maas UI不支持上传centos8镜像（原因是因为这个还没有-<a href="http://images.maas.io/ephemeral-v3/daily/streams/v1/com.ubuntu.maas:daily:centos-bases-download.json)，只是api可以(通过curtin" target="_blank" rel="external">http://images.maas.io/ephemeral-v3/daily/streams/v1/com.ubuntu.maas:daily:centos-bases-download.json)，只是api可以(通过curtin</a>)</li>
<li>maas-image-builder不支持做centos8镜像，似乎packer-maas可以，或者自定义(<a href="https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d" target="_blank" rel="external">https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d</a>)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:maas/2.8</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install maas -y</span><br><span class="line">sudo maas init --admin-username admin --admin-password password --admin-email admin@example.com --admin-ssh-import zhhuabj</span><br><span class="line">sudo maas-region apikey --username=admin &gt; ~/admin-api-key</span><br><span class="line">apikey=$(cat ~/admin-api-key)</span><br><span class="line">maas login admin http://127.0.0.1:5240/MAAS $apikey</span><br><span class="line"></span><br><span class="line"># Once Curtin has been upgraded the image can be uploaded to MAAS via the API</span><br><span class="line">#https://code.launchpad.net/~ltrager/curtin/+git/curtin/+merge/374335</span><br><span class="line">sudo apt install curtin=20.1-2-g42a9667f-0ubuntu1~18.04.1 -y</span><br><span class="line">sudo systemctl stop maas-rackd &amp;&amp; sudo systemctl restart maas-regiond &amp;&amp; sudo systemctl start maas-rackd</span><br><span class="line">axel https://people.canonical.com/~zhhuabj/centos8.tar.gz</span><br><span class="line">maas admin boot-resources create name=&apos;centos 8&apos; title=&apos;centos 8&apos; architecture=&apos;amd64/generic&apos; filetype=&apos;tgz&apos; content@=centos8-1.0.2-7-gac521bb.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">但似乎maas-image-builder还不支持做centos8的镜像，但可参考这篇文章做　－　https://medium.com/@kemnitz.stefan/centos-8-via-maas-9ffcc6c7a22d</span><br><span class="line">还有一个工具叫packer-maas似乎也能做，见- https://manintheit.org/bash/creating-a-image-for-maas-with-packer/</span><br><span class="line">$ sudo maas-image-builder -o centos8-amd64-root-tgz --arch amd64 centos --edition 8</span><br><span class="line">...</span><br><span class="line">mib.builders.BuildError: Unknown CentOS edition: 8.</span><br><span class="line"></span><br><span class="line">$ grep -r &apos;grub2&apos; /usr/lib/curtin/helpers/common |grep 8</span><br><span class="line">               7|8) grub_name=&quot;grub2-pc&quot;;;</span><br><span class="line">                        7|8) grubcmd=&quot;grub2-install&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">使用packer-maas创建centos8镜像如下:</span><br><span class="line"># https://github.com/canonical/packer-maas/tree/master/centos8</span><br><span class="line">sudo apt install packer</span><br><span class="line"># fix bug - https://github.com/canonical/packer-maas/issues/2</span><br><span class="line">wget https://releases.hashicorp.com/packer/1.6.2/packer_1.6.2_linux_amd64.zip</span><br><span class="line">unzip packer_1.6.2_linux_amd64.zip &amp;&amp; sudo cp ./packer /usr/bin/ &amp;&amp; packer --version</span><br><span class="line">git clone https://github.com/canonical/packer-maas.git</span><br><span class="line">cd packer-maas/centos8  #must be in cetnos8 subdir</span><br><span class="line">#change url in centos8.json to http://mirrors.aliyun.com/centos/8.2.2004/isos/x86_64/CentOS-8.2.2004-x86_64-boot.iso</span><br><span class="line">sudo PACKER_LOG=1 packer build centos8.json  #but will hit this bug - https://github.com/canonical/packer-maas/issues/2</span><br><span class="line">maas admin boot-resources create name=&apos;centos/8-custom&apos; title=&apos;CentOS 8 Custom&apos; architecture=&apos;amd64/generic&apos; filetype=&apos;tgz&apos; content@=centos8.tar.gz  #default username is cloud-user</span><br></pre></td></tr></table></figure>
<p>然后可以设置Deploy的默认镜像(commission时只能用ubuntu镜像), 也可以在Deploy时选择用centos镜像, 但commission似乎只能使用ubuntu镜像. deploy日志可见: /var/log/maas/rsyslog/test/2020-09-25/messages<br>最终可以通过: ‘ssh cloud-user@192.168.100.2’访问deploy后的centos8 机器. 如果不是deploy的而是救援模式进去的可以”ssh ubuntu@192.168.100.2 -v”, 注意: 救援模式只是commisstion不是deploy所以也是无法选择image的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[cloud-user@test ~]$ uname -a</span><br><span class="line">Linux test.maas 4.18.0-193.14.2.el8_2.x86_64 #1 SMP Sun Jul 26 03:54:29 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20200925184437707.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>但这个镜像似乎在uefi虚机时不work, 创建测试uefi虚机的步骤如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ovmf -y  #should install ovmf in node1 rather than t440p</span><br><span class="line">sudo systemctl restart libvirtd</span><br><span class="line">virt-manager --debug      #run it in t440p, then connect to node1</span><br><span class="line">Start creating a new VM in virt-manager, but before finishing, click &quot;Customize configuration before install&quot;</span><br><span class="line">Change the Firmware Option from BIOS to EUFI in &apos;Overview&apos; tab. (If it&apos;s not available do a systemctl restart libvirtd)</span><br></pre></td></tr></table></figure></p>
<h2 id="debug-curtin"><a href="#debug-curtin" class="headerlink" title="debug curtin"></a>debug curtin</h2><p><a href="https://gist.github.com/smoser/2610e9b78b8d7b54319675d9e3986a1b" target="_blank" rel="external">https://gist.github.com/smoser/2610e9b78b8d7b54319675d9e3986a1b</a><br>在maas中查看日志/var/log/maas/rsyslog/test2/2020-09-28/messages, 看到的错误如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curthooks -&gt; builtin_curthooks -&gt; setup_grub -&gt; install_grub(instdevs, target, uefi=uefi_bootable, grubcfg=grubcfg) -&gt;</span><br><span class="line"></span><br><span class="line">unshare --fork --pid -- chroot /tmp/tmp6yj0ryyc/target grub2-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=centos --recheck --no-nvram</span><br><span class="line"></span><br><span class="line">Stderr: grub2-install: error: /usr/lib/grub/x86_64-efi/modinfo.sh doesn&apos;t exist.</span><br></pre></td></tr></table></figure>
<p>/usr/lib/grub/x86_64-efi/modinfo.sh 不存在, 这个网页<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1101352" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1101352</a> 说:<br>Looks like this is intentional to avoid the fallout of unsuspecting users running grub2-install. To regain ability to grub2-install on EFI, install package grub2-efi-modules.<br>所以是需要安装grub2-efi-modules模块. 下面方法检查image中检查确认确实没有这个包:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#sudo guestmount -a /var/lib/libvirt/images/test2.qcow2  -i --rw ./root2</span><br><span class="line">sudo modprobe nbd</span><br><span class="line">sudo qemu-nbd --connect=/dev/nbd0 /var/lib/libvirt/images/test2.qcow2 -f qcow2</span><br><span class="line">sudo fdisk /dev/nbd0 -l</span><br><span class="line">sudo qemu-nbd --disconnect /dev/nbd0</span><br><span class="line">$ sudo fdisk /dev/nbd0 -l |grep dev</span><br><span class="line">Disk /dev/nbd0: 20 GiB, 21474836480 bytes, 41943040 sectors</span><br><span class="line">/dev/nbd0p1    2048  1050623  1048576  512M EFI System</span><br><span class="line">/dev/nbd0p2 1050624 41928703 40878080 19.5G Linux filesystem</span><br><span class="line"></span><br><span class="line">cd /tmp &amp;&amp; mkdir &#123;boot,root&#125;</span><br><span class="line">sudo mount /dev/nbd0p1 ./boot/</span><br><span class="line">sudo mount /dev/nbd0p2 ./root/</span><br><span class="line"></span><br><span class="line">$ ls ./root/usr/lib/grub/</span><br><span class="line">i386-pc</span><br><span class="line"></span><br><span class="line">$ sudo dpkg -L grub-efi-amd64-bin |grep modinfo.sh</span><br><span class="line">/usr/lib/grub/x86_64-efi/modinfo.sh</span><br><span class="line">$ sudo apt-file search modinfo.sh |grep amd64</span><br><span class="line">grub-efi-amd64-bin: /usr/lib/grub/x86_64-efi/modinfo.sh</span><br></pre></td></tr></table></figure></p>
<p>先试了使用kickstart定制包, 但不好使: <a href="https://manintheit.org/bash/creating-a-image-for-maas-with-packer/" target="_blank" rel="external">https://manintheit.org/bash/creating-a-image-for-maas-with-packer/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo PACKER_LOG=1 HTTPIP=127.0.0.1 HTTPPort=8000 packer build centos8.json</span><br></pre></td></tr></table></figure></p>
<p>然后用下列方法重新打包, 在image中添加这个包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/centos8 &amp;&amp; sudo tar -xf centos8.tar.gz -C /tmp/centos8/</span><br><span class="line">MOUNTDIR=/tmp/centos8</span><br><span class="line">for d in dev sys proc; do sudo mount --bind /$d $&#123;MOUNTDIR&#125;/$d; done</span><br><span class="line">sudo mv $&#123;MOUNTDIR&#125;/etc/resolv.conf $&#123;MOUNTDIR&#125;/etc/resolv.conf.bak &amp;&amp; sudo cp /etc/resolv.conf $&#123;MOUNTDIR&#125;/etc/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#sudo chroot $MOUNTDIR bash</span><br><span class="line">sudo chroot $MOUNTDIR yum update</span><br><span class="line">#install grub2-efi-x64-modules instead of grub2-efi-modules to avoid grub2-efi-aa64-modules</span><br><span class="line">sudo chroot $MOUNTDIR yum install grub2-efi-x64-modules -y</span><br><span class="line">sudo chroot $MOUNTDIR ls /usr/lib/grub/x86_64-efi/modinfo.sh</span><br><span class="line">sudo chroot $MOUNTDIR yum list --installed |grep -E &apos;shim|efi&apos;</span><br><span class="line"></span><br><span class="line">sudo umount $MOUNTDIR/&#123;proc,dev,sys,&#125;</span><br><span class="line">sudo mv $MOUNTDIR/etc/resolv.conf.bak $MOUNTDIR/etc/resolv.conf</span><br><span class="line">sudo tar -czf centos8.tar.gz -C $MOUNTDIR .</span><br></pre></td></tr></table></figure>
<p>现在之前的错误没了, 又出现下列新错误:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command: [&apos;unshare&apos;, &apos;--fork&apos;, &apos;--pid&apos;, &apos;--&apos;, &apos;chroot&apos;, &apos;/tmp/tmphc1fr7hk/target&apos;, &apos;dracut&apos;, &apos;-f&apos;, &apos;/boot/initramfs-4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64.img&apos;, &apos;4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64&apos;]        Exit code: 1        Reason: -        Stdout: &apos;&apos;        Stderr: dracut: Cannot find module directory /lib/modules/4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64/                dracut: and --no-kernel was not specified</span><br></pre></td></tr></table></figure></p>
<p>那是因为刚刚升级了centos(不应该升级)导致有两个内核了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4# rpm -q kernel</span><br><span class="line">kernel-4.18.0-193.14.2.el8_2.x86_64</span><br><span class="line">kernel-4.18.0-193.19.1.el8_2.x86_64</span><br><span class="line"></span><br><span class="line">bash-4.4# rpm -q --queryformat %&#123;VERSION&#125;-%&#123;RELEASE&#125;.%&#123;ARCH&#125; kernel</span><br><span class="line">4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64</span><br><span class="line"></span><br><span class="line">dracut -f /boot/initramfs-4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64.img 4.18.0-193.14.2.el8_2.x86_644.18.0-193.19.1.el8_2.x86_64</span><br></pre></td></tr></table></figure></p>
<p>这个修改后, 又遇到image缓存了, 之后, 这些问题没有了, 但进系统时总是进入mergency mode, 原因是initrd-switch-root.service服务启动失败, 是因为找不到硬盘.<br>最后是这样解决的, 修改packer-maas/centos8/http/centos8.ks<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#grub2-efi-x64</span><br><span class="line">efibootmgr</span><br><span class="line">#shim-x64</span><br><span class="line">grub2-efi-x64-modules</span><br></pre></td></tr></table></figure></p>
<p><strong>Reference</strong><br>[1] <a href="https://blog.csdn.net/quqi99/article/details/37990507" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/37990507</a><br>[2] <a href="https://www.cnblogs.com/aegis1019/p/8870251.html" target="_blank" rel="external">https://www.cnblogs.com/aegis1019/p/8870251.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/07/Fix-the-error-CERTIFICAT-VERIFY-FAILED/" itemprop="url">Fix the error CERTIFICAT_VERIFY_FAILED</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-07T15:54:08+08:00">
                2020-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-07-07<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在测试rbac时, 下列rbac调用candid时会报CERTIFICATE_VERIFY_FAILED这个错. 在读了rbac的代码之后, 确定rbac是在调用 <a href="https://node1.lan:8081/discharge/info" target="_blank" rel="external">https://node1.lan:8081/discharge/info</a> 时抛的错.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maas (maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest) -&gt; rbac with http (http://node1.lan:8081) -&gt; candid with https (https://node1.lan:8081/discharge/info) -&gt; ldap with https</span><br></pre></td></tr></table></figure></p>
<p>奇怪的是, 我已经运行过这个命令( cp ~/certs/ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates )了. 不应该啊.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-ca-certificates --fresh</span><br><span class="line">$ export SSL_CERT_DIR=/etc/ssl/certs</span><br></pre></td></tr></table></figure></p>
<h2 id="curl测试"><a href="#curl测试" class="headerlink" title="curl测试"></a>curl测试</h2><p>运行下列三个命令均无问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://node1.lan:8081/discharge/info</span><br><span class="line">curl https://node1.lan:8081/discharge/info -k</span><br><span class="line">curl https://node1.lan:8081/discharge/info --cacert ~/certs/ca.crt</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-urllib2-request"><a href="#python测试-urllib2-request" class="headerlink" title="python测试 - urllib2.request"></a>python测试 - urllib2.request</h2><p>下列python代码测试也没问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; test.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import ssl</span><br><span class="line">try:</span><br><span class="line">    import urllib2 #python2</span><br><span class="line">except:</span><br><span class="line">    import urllib.request as urllib2 #python3</span><br><span class="line"></span><br><span class="line">req = urllib2.Request(sys.argv[1], headers=&#123;&apos;Bakery-Protocol-Version&apos;:&apos;3&apos;&#125;)</span><br><span class="line">print(urllib2.urlopen(req).read())</span><br><span class="line">EOF</span><br><span class="line">mkdir /usr/share/ca-certificates/extras</span><br><span class="line">cp ~/certs//ca.crt /usr/share/ca-certificates/extras/ldap.crt &amp;&amp; dpkg-reconfigure ca-certificates</span><br><span class="line">python test.py https://node1.lan:8081/discharge/info</span><br></pre></td></tr></table></figure></p>
<h2 id="python测试-requests"><a href="#python测试-requests" class="headerlink" title="python测试 - requests"></a>python测试 - requests</h2><p>奇了怪了, 只好继续调试代码, 发现rbac使用了pymacaroons (<a href="https://github.com/ecordell/pymacaroons" target="_blank" rel="external">https://github.com/ecordell/pymacaroons</a>), pymacaroons它又会调用requests (不是urllib2.request)<br>所以继续写了一个python测试, 问题就重现了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bash -c &apos;cat &gt; test2.py&apos; &lt;&lt; EOF</span><br><span class="line">#!/bin/env python</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = sys.argv[1]</span><br><span class="line">print(requests.get(url).read())</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">...</span><br><span class="line">requests.exceptions.SSLError: HTTPSConnectionPool(host=&apos;node1.lan&apos;, port=8081): Max retries exceeded with url: /discharge/info (Caused by SSLError(SSLError(1, &apos;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:852)&apos;),))</span><br></pre></td></tr></table></figure></p>
<p>添加REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem 问题解决.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem  python test2.py https://node1.lan:8081/discharge/info</span><br><span class="line">200</span><br></pre></td></tr></table></figure>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>改为下列使命启动rbac<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ldap.pem crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<p>或者使用全局ca database<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># use the full system database</span><br><span class="line">REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver --debug run -P 5000</span><br></pre></td></tr></table></figure></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>应该是遇到了这个bug - <a href="https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144" target="_blank" rel="external">https://stackoverflow.com/questions/42982143/python-requests-how-to-use-system-ca-certificates-debian-ubuntu/42982144#42982144</a><br>现在request的代码(<a href="https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径" target="_blank" rel="external">https://github.com/psf/requests/blob/master/requests/certs.py)使用使用certifi模块中的where函数来指定ca证书路径</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep -r where /bak/work/crbs/.ve/lib/python3.6/site-packages/requests/certs.py</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line"></span><br><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &quot;cacert.pem&quot;)</span><br></pre></td></tr></table></figure></p>
<p>python-request 2.9.1版本的debian包中有一个01_use-system-ca-certificates.patch修改了ca路径为/etc/ssl/certs/ca-certificates.crt, requests-2.18.4版本开始改用certifi模块中的where函数并修复了这个问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;return&apos; /tmp/requests-2.9.1/debian/patches/01_use-system-ca-certificates.patch</span><br><span class="line">-        return os.path.join(os.path.dirname(__file__), &apos;cacert.pem&apos;)</span><br><span class="line">+        return &apos;/etc/ssl/certs/ca-certificates.crt&apos;</span><br><span class="line"></span><br><span class="line"># grep -r where /tmp/requests-2.18.4/requests/certs.py</span><br><span class="line">environment, you can change the definition of where() to return a separately</span><br><span class="line">from certifi import where</span><br><span class="line">    print(where())</span><br><span class="line"># grep -r &apos;def where&apos; /usr/lib/python3/dist-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    return &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br></pre></td></tr></table></figure></p>
<p>但virtualenv环境中没有改:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;def where&apos; /bak/work/crbs/.ve/lib/python3.6/site-packages/certifi/core.py -A 2</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br></pre></td></tr></table></figure></p>
<p>不可能去修改上游virtualenv模块, 看来只能修改rbac这个应用了.</p>
<h2 id="怎么解决呢"><a href="#怎么解决呢" class="headerlink" title="怎么解决呢"></a>怎么解决呢</h2><p>requests module (/snap/xxx-rbac/224/lib/python3.6/site-packages/requests)在使用/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem. 而不是在使用/var/snap/xxx-rbac/current/conf/certs/ca.pem (snap set xxx-rbac ssl.ca=”$(cat $cert_dir/ca.crt)”)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# grep -r &apos;import where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/requests/certs.py -A 3</span><br><span class="line">from certifi import where</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(where())</span><br><span class="line">(.ve) root@node1:~# grep -r &apos;where&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/core.py -A 3</span><br><span class="line">def where():</span><br><span class="line">    f = os.path.dirname(__file__)</span><br><span class="line">    return os.path.join(f, &apos;cacert.pem&apos;)</span><br><span class="line"></span><br><span class="line">(.ve) root@node1:~# ls /snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br><span class="line">/snap/xxx-rbac/224/lib/python3.6/site-packages/certifi/cacert.pem</span><br></pre></td></tr></table></figure></p>
<p>所以得使用REQUESTS_CA_BUNDLE变量, 但上面是通过源码运行的 (REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt  crbs-devserver –debug run -P 5000),  现在改从snap(systemctl restart snap.xxx-rbac.uwsgi)的方式启动.  但发现这条code path (./crbs/wsgi.py#make_wsgi_app -&gt; ./crbs/setup.py#setup_globals -&gt; ./crbs/snap/_env.py(set REQUESTS_CA_BUNDLE))设置了REQUESTS_CA_BUNDLE, 可它为什么不生效了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>但从snap容器中没查着这个环境变量:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# snap run --shell xxx-rbac.uwsgi</span><br><span class="line">root@node1:/root# env |grep REQUESTS_CA_BUNDLE</span><br><span class="line"></span><br><span class="line">NOTE: 也可以通过:snap run xxx-rbac.uwsgi --ini /var/snap/xxx-rbac/x4/conf/uwsgi.ini 来在snap container里运行命令，但是snap container里没有python命令:</span><br><span class="line">root@node1:~# snap run canonical-rbac.python</span><br><span class="line">error: cannot find app &quot;python&quot; in &quot;canonical-rbac&quot;</span><br></pre></td></tr></table></figure></p>
<p>从host机器也没查着:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# pidof uwsgi</span><br><span class="line">3898 3897 3896 3895 3894 3893 3892 3891 3679</span><br><span class="line">(.ve) root@node1:~# cat /proc/3898/environ |grep REQUESTS_CA_BUNDLE</span><br><span class="line">(.ve) root@node1:~#</span><br></pre></td></tr></table></figure></p>
<p>改以只能想着通过pdb ( import pdb;pdb.set_trace() )调试, 但/snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py是只读的没法添加断点.<br>另一种可能的调试方法是采用’python3 -m pdb xx.py’的方式交互性调试( 这样, 断点设置在第1行 - <a href="https://pymotw.com/3/pdb/" target="_blank" rel="external">https://pymotw.com/3/pdb/</a> ). snap.xxx-rbac.uwsgi最终得通过(/usr/bin/snap run xxx-rbac.uwsgi) 启动, 最终调用command-uwsgi.wrapper启动, 但似乎我们也无法修改command-uwsgi.wrapper啊它也中只读的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(.ve) root@node1:~# cat /snap/xxx-rbac/224/command-uwsgi.wrapper</span><br><span class="line">#!/bin/sh</span><br><span class="line">exec &quot;uwsgi&quot; &quot;--ini&quot; &quot;$SNAP_DATA/conf/uwsgi.ini&quot; &quot;$@&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="debug-snap"><a href="#debug-snap" class="headerlink" title="debug snap"></a>debug snap</h2><p>想给snap里的python用pdb加个断点，因为snap的代码目录是只读的，非常难调．用下列方法可以修改源代码．但是仍然无法加 ‘import pdb;pdb.set_trace()’ 到源码，因为pdb需要通过python启动程序而不是通过snap启动程序．所以实际上snap部分的代码还是相当难调．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://forum.snapcraft.io/t/make-a-snap-writable-temporarily-for-debugging/16370/3</span><br><span class="line">unsquashfs -d canonical-rbac /var/lib/snapd/snaps/canonical-rbac_224.snap</span><br><span class="line"># modfity file here. eg:  ./canonical-rbac/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">snap try canonical-rbac --devmode</span><br></pre></td></tr></table></figure></p>
<h2 id="问题最终解决"><a href="#问题最终解决" class="headerlink" title="问题最终解决"></a>问题最终解决</h2><p>snap都是只读的实在无法调试，最后发现一个现象．直接在浏览器(最好用firefox, 使用chrome时不弹出框)访问rbac portal (<a href="https://node1.lan:5000" target="_blank" rel="external">https://node1.lan:5000</a> )并不出现这个错，只是使用＂maas configauth –rbac-url <a href="https://node1.lan:5000/" target="_blank" rel="external">https://node1.lan:5000/</a> –rbac-service-name maastest＂命令时报这个错．这会不会是maas的问题？尤其是maas是通过snap安装的，而不是通过debian安装的，maas是不是缺少了下 面类似于rbac的用于设置的代码．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep -r &apos;REQUESTS_CA_BUNDLE&apos; /snap/xxx-rbac/224/lib/python3.6/site-packages/crbs/snap/_env.py</span><br><span class="line">            environ[&apos;REQUESTS_CA_BUNDLE&apos;] = str(cert_bundle)</span><br></pre></td></tr></table></figure></p>
<p>通过debian包安装后证明果然是这个问题.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install maas --channel=2.8</span><br><span class="line">#sudo snap install maas-test-db                              #enter shell - maas-test-db.psql</span><br><span class="line">#sudo maas init region+rack --database-uri maas-test-db:///  #http://192.168.99.124:5240/MAAS</span><br><span class="line">sudo add-apt-repository ppa:maas/2.8   #https://launchpad.net/~maas</span><br><span class="line">sudo apt install maas</span><br><span class="line"></span><br><span class="line">sudo maas configauth --rbac-url https://node1.lan:5000/ --rbac-service-name maastest  #use external authentication</span><br><span class="line"># sudo maas createadmin   #not use external authentication</span><br></pre></td></tr></table></figure>
<h2 id="openstack-ssl"><a href="#openstack-ssl" class="headerlink" title="openstack ssl"></a>openstack ssl</h2><p>快速创建一个ssl环境:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh --name ovn-octavia --series bionic --release ussuri --octavia --ovn --create-model --run</span><br><span class="line">juju config neutron-api default-tenant-network-type=gre</span><br><span class="line">openstack --insecure endpoint list</span><br></pre></td></tr></table></figure></p>
<p>默认的证书./openstack/ssl/openstack-ssl/results/cacert.pem是采用了SNI的．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju ssh keystone/0 -- openssl x509 -noout -text -in /etc/apache2/ssl/keystone/cert_10.5.1.45 |grep CN</span><br><span class="line">curl --resolve juju-8284e4-ovn-octavia-2.cloud.sts:5000:10.5.1.45 --cacert ./openstack/ssl/openstack-ssl/results/cacert.pem https://juju-8284e4-ovn-octavia-2.cloud.sts:5000</span><br></pre></td></tr></table></figure></p>
<p>所以第一步要将keystone endpoint中的IP改成DOMAIN<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOMAIN=$(juju ssh keystone/0 -- hostname -f |sed s/[[:space:]]//g) &amp;&amp; echo $DOMAIN</span><br><span class="line">juju config keystone os-admin-hostname=$DOMAIN os-public-hostname=$DOMAIN os-internal-hostname=$DOMAIN</span><br></pre></td></tr></table></figure></p>
<p>然后按理说应该就可以了的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source novarc</span><br><span class="line">export OS_AUTH_URL=https://juju-8284e4-ovn-octavia-2.cloud.sts:5000/v3</span><br><span class="line">export OS_CACERT=./openstack/ssl/openstack-ssl/results/cacert.pem</span><br><span class="line">openstack  endpoint list</span><br></pre></td></tr></table></figure>
<p>但实际是不行的，因为证书./openstack/ssl/openstack-ssl/results/cacert.pem已经通过下列命令加入了系统中.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ./openstack/ssl/openstack-ssl/results/cacert.pem /usr/local/share/ca-certificates/cacert.crt</span><br><span class="line">sudo chmod 644 /usr/local/share/ca-certificates/cacert.crt</span><br><span class="line">sudo update-ca-certificates --fresh</span><br></pre></td></tr></table></figure></p>
<p>这也是一个bug, 改成下列居然就好了(<a href="https://medium.com/@george.shuklin/ssl-certificate-abyss-in-openstack-5c3c4a92eb5a" target="_blank" rel="external">https://medium.com/@george.shuklin/ssl-certificate-abyss-in-openstack-5c3c4a92eb5a</a>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OS_CACERT=/etc/ssl/certs/</span><br></pre></td></tr></table></figure>
<h2 id="重要更新"><a href="#重要更新" class="headerlink" title="重要更新"></a>重要更新</h2><p>之所以要’export OS_CACERT=/etc/ssl/certs/‘的原因最后查出来是因为习惯不好，在机器上运行过devstack导致安装了python3-pip且通过pip3安装了certifi这个包，所以在删除它之后再运行“python3 -c “import certifi; print(certifi.where());””就正常了。<br>所以养成好习惯，非devstack开发环境机器上不要安装pip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 freeze | xargs -i sudo pip3 uninstall &#123;&#125; -y</span><br><span class="line">#sudo apt remove --purge python3-pip</span><br><span class="line">ls /usr/local/lib/python3.8/dist-packages/</span><br></pre></td></tr></table></figure></p>
<p>另外，由于bastion安装过devstack来导致在并行上传镜像时导致ssh中断。<br>世界由此清净了！但此时报：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openstack</span><br><span class="line">bash: /usr/local/bin/openstack: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>那是需要删除“/usr/local/bin/openstack*”确保使用/usr/bin/openstack, 同时要登出再重新登录shell即可。<br>另外，似乎也可以直接运行下列命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ~/.local/lib/python3.8/site-packages/pip*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3.6/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python3.8/dist-packages/*</span><br><span class="line">sudo rm -rf /usr/local/lib/python2.7/dist-packages/*</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/05/开发用的devstack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/05/开发用的devstack/" itemprop="url">开发用的devstack</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-05T19:13:10+08:00">
                2020-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华  发表于：2014-05-15<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</strong></p>
<h2 id="网络环境"><a href="#网络环境" class="headerlink" title="网络环境"></a>网络环境</h2><p>NOTE:下面使用镜像不是万能的，<strong>镜像不同步，会造成包依赖问题进而外在表现更多的包依赖问题</strong>．但由于国内糟糕的网络环境（随意封锁纯技术网站及对出口宽带的小至十几K或者几比特的QoS限速 )，不使用镜像用国内机器又根本无法做实验．无解，enjoy!</p>
<ul>
<li><p>debian镜像, 除了下面的mirrors.cloud.tencent.com, 也可考虑 cn.archive.ubuntu.com．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list_bak</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/apt/sources.list&apos; &lt;&lt; EOF</span><br><span class="line">deb http://mirrors.cloud.tencent.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb http://mirrors.cloud.tencent.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.cloud.tencent.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">#deb http://mirrors.cloud.tencent.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line">#deb http://mirrors.cloud.tencent.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">EOF</span><br><span class="line">sudo sed -i s/mirrors.cloud.tencent.com/mirrors.aliyun.com/g /etc/apt/sources.list</span><br><span class="line">sudo apt clean all</span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
</li>
<li><p>pip镜像, 当前用户，root用户，如果创建了专门的stack用户的话，最好都添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.pip/</span><br><span class="line">cat &lt;&lt; EOF &gt; ~/.pip/pip.conf</span><br><span class="line">[global]</span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line">[install]</span><br><span class="line">trusted-host=pypi.douban.com</span><br><span class="line">disable-pip-version-check = true</span><br><span class="line">timeout = 120</span><br><span class="line">EOF</span><br><span class="line">如果添加了上述设置，但感觉&quot;sudo pip3 install -r requirements.txt＂还是慢未生效，那是因为需要在root用户中也添加：</span><br><span class="line">sudo mkdir /root/.pip</span><br><span class="line">sudo bash -c &apos;cat &gt; /root/.pip/pip.conf&apos; &lt;&lt; EOF</span><br><span class="line">[global]</span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line">[install]</span><br><span class="line">trusted-host=pypi.douban.com</span><br><span class="line">disable-pip-version-check = true</span><br><span class="line">timeout = 120</span><br><span class="line">EOF</span><br><span class="line">或者使用：</span><br><span class="line">[global]</span><br><span class="line">trusted-host=mirrors.aliyun.com</span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple</span><br><span class="line">disable-pip-version-check = true</span><br><span class="line">timeout = 120</span><br><span class="line"></span><br><span class="line">若不使用pip镜像，例如，运行下列命令时，</span><br><span class="line">sudo -H LC_ALL=en_US.UTF-8 http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite python3.8 -m pip install -c /bak/openstack/requirements/upper-constraints.txt &apos;glance-store[cinder]!=0.29.0&apos;</span><br><span class="line">会报这种错误：</span><br><span class="line">urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host=&apos;files.pythonhosted.org&apos;, port=443): Read timed out.</span><br><span class="line">局部通过如下添加＂--index-url https://pypi.douban.com/simple＂解决</span><br><span class="line">sudo -H LC_ALL=en_US.UTF-8 http_proxy= https_proxy= no_proxy= PIP_FIND_LINKS= SETUPTOOLS_SYS_PATH_TECHNIQUE=rewrite python3.8 -m pip install -c /bak/openstack/requirements/upper-constraints.txt &apos;glance-store[cinder]!=0.29.0&apos; --index-url https://pypi.douban.com/simple</span><br><span class="line">对于小包可以通过添加超时时间解决（pip --default-timeout=100 install -U pip）</span><br></pre></td></tr></table></figure>
</li>
<li><p>openstack镜像, 对github的封锁是间歇性的（如git@github.com:openstack/nova.git），尽量使用https协议，避免使用git协议．也可考虑这个openstack的代码镜像 - <a href="http://git.trystack.cn" target="_blank" rel="external">http://git.trystack.cn</a>, 代码及时性就不好说了．真要开发肯定不能用这种，搭建测试环境暂时可以用．</p>
</li>
<li>**此步可选, 注意，若添加了stack用户, 记得运行’sudo su - stack’之后再做上面的pip镜像设置:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;ubuntu     ALL=(ALL) NOPASSWD:ALL&apos; |sudo tee -a /etc/sudoers</span><br><span class="line">echo &apos;precedence ::ffff:0:0/96 100&apos; |sudo tee -a /etc/gai.conf</span><br><span class="line"></span><br><span class="line">sudo useradd -s /bin/bash -d /opt/stack -m stack</span><br><span class="line">echo &quot;stack ALL=(ALL) NOPASSWD: ALL&quot; | sudo tee /etc/sudoers.d/stack</span><br><span class="line">sudo su - stack &amp;&amp; cd /opt/stack</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="运行devstack"><a href="#运行devstack" class="headerlink" title="运行devstack"></a>运行devstack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#NOTE: this can cause bastion unable to be SSHed</span><br><span class="line">#juju deploy ubuntu openstack --series=focal --config hostname=openstack --constraints &quot;mem=8G cores=2 root-disk=60G&quot;</span><br><span class="line">sudo mkdir -p /bak/openstack &amp;&amp; sudo chown -R $(whoami) /bak/openstack &amp;&amp; cd /bak/openstack</span><br><span class="line">git clone https://github.com/openstack/devstack.git &amp;&amp; cd devstack</span><br><span class="line">sudo bash -c &apos;cat &gt; local.conf&apos; &lt;&lt;EOF</span><br><span class="line">[[local|localrc]]</span><br><span class="line"></span><br><span class="line">#proxychains wget https://github.com/etcd-io/etcd/releases/download/v3.3.12/etcd-v3.3.12-linux-amd64.tar.gz -O /bak/openstack/devstack/files/etcd-v3.3.12-linux-amd64.tar.gz</span><br><span class="line">#files.pythonhosted.org is easy to &apos;read timed out&apos;</span><br><span class="line"># Host IP - get your Server/VM IP address from ip addr command</span><br><span class="line">#HOST_IP=10.0.2.30</span><br><span class="line"></span><br><span class="line">#OFFLINE=True</span><br><span class="line">DEST=/bak/openstack</span><br><span class="line">mkdir -p \$DEST</span><br><span class="line">sudo mkdir -p \$DEST&amp;&amp; sudo chown -R $(whoami) \$DEST &amp;&amp; cd \$DEST</span><br><span class="line"></span><br><span class="line">## use proxy</span><br><span class="line">#export GIT_SSL_NO_VERIFY=1</span><br><span class="line">#export http_proxy=</span><br><span class="line">#export https_proxy=</span><br><span class="line">#export no_proxy=&quot;127.0.0.1,localhost,&lt;local-ip&gt;&quot;</span><br><span class="line"></span><br><span class="line">USE_PYTHON3=True</span><br><span class="line">DOWNLOAD_DEFAULT_IMAGES=False</span><br><span class="line">IMAGE_URLS=&quot;http://download.cirros-cloud.net/0.5.1/cirros-0.5.1-x86_64-disk.img&quot;</span><br><span class="line"></span><br><span class="line"># use TryStack git mirror</span><br><span class="line">GIT_BASE=http://git.trystack.cn</span><br><span class="line">NOVNC_REPO=http://git.trystack.cn/kanaka/noVNC.git</span><br><span class="line">SPICE_REPO=http://git.trystack.cn/git/spice/sice-html5.git</span><br><span class="line"></span><br><span class="line"># Password for KeyStone, Database, RabbitMQ and Service</span><br><span class="line">ADMIN_PASSWORD=password</span><br><span class="line">DATABASE_PASSWORD=\$ADMIN_PASSWORD</span><br><span class="line">RABBIT_PASSWORD=\$ADMIN_PASSWORD</span><br><span class="line">SERVICE_PASSWORD=\$ADMIN_PASSWORD</span><br><span class="line">SERVICE_TIMEOUT=300  #fix the error &apos;g-api did not start&apos;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">./stack.sh</span><br></pre></td></tr></table></figure>
<h2 id="Use-it"><a href="#Use-it" class="headerlink" title="Use it"></a>Use it</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">source accrc/admin/admin</span><br><span class="line">$ env |grep OS_</span><br><span class="line">OS_PROJECT_DOMAIN_ID=default</span><br><span class="line">OS_CACERT=</span><br><span class="line">OS_AUTH_URL=http://192.168.99.190/identity</span><br><span class="line">OS_USER_DOMAIN_ID=default</span><br><span class="line">OS_USERNAME=admin</span><br><span class="line">OS_PROJECT_NAME=admin</span><br><span class="line">OS_PASSWORD=password</span><br><span class="line"></span><br><span class="line">source &lt;(openstack complete)</span><br><span class="line">openstack complete |sudo tee /etc/bash_completion.d/openstack.bash_completion &gt; /dev/null</span><br><span class="line"></span><br><span class="line">nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --image cirros-0.5.1-x86_64-disk --flavor m1.tiny --key-name mykey --nic net-id=$(openstack network list | awk &apos;/private/ &#123;print $2&#125;&apos;) i1</span><br><span class="line">fix_ip=$(openstack server list | awk &apos;/private/ &#123;print $8&#125;&apos; |awk -F&apos;=&apos; &apos;&#123;print $2&#125;&apos; |awk -F&apos;,&apos; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">public_network=$(openstack network show public -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $public_network -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address $fix_ip --port $(openstack port list --fixed-ip ip-address=$fix_ip -c id -f value)</span><br><span class="line"></span><br><span class="line">sg_id=$(openstack security group list --project=$(openstack server show i1 -f value -c project_id) |grep default |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">openstack security group rule create --protocol tcp --dst-port 22 $sg_id</span><br><span class="line">openstack security group rule create --protocol icmp $sg_id</span><br><span class="line">ping $fip</span><br><span class="line">ssh cirros@$fip -v</span><br></pre></td></tr></table></figure>
<h2 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim ../logs/</span><br><span class="line">sudo systemctl --failed</span><br><span class="line">sudo systemctl list-units |grep devstack |grep failed |awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line">sudo systemctl stop &quot;devstack@*&quot;</span><br><span class="line">sudo systemctl status devstack@g-api.service</span><br><span class="line"></span><br><span class="line">sudo journalctl -f --unit devstack@n-cpu.service</span><br><span class="line">see - https://docs.openstack.org/devstack/latest/systemd.html</span><br></pre></td></tr></table></figure>
<h2 id="another-localrc-local-conf"><a href="#another-localrc-local-conf" class="headerlink" title="another localrc/local.conf"></a>another localrc/local.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /bak/openstack &amp;&amp; sudo chown -R $(whoami) /bak/openstack &amp;&amp; cd /bak/openstack</span><br><span class="line">sudo chown -R $(whoami) ~/.config</span><br><span class="line">git clone https://github.com/openstack/devstack.git</span><br><span class="line">cd devstack &amp;&amp; wget https://raw.githubusercontent.com/zhhuabj/exercise/master/o7k/localrc</span><br><span class="line">./stack.sh</span><br><span class="line">source accrc/admin/admin</span><br></pre></td></tr></table></figure>
<h2 id="代码更改"><a href="#代码更改" class="headerlink" title="代码更改"></a>代码更改</h2><p>1, 当将devstack中的OFFLINE设置为True后重新运行./stack.sh报下列错：<br>apache2.service: Failed with result ‘start-limit-hit’<br>Soluation:<br>从这个网页找到了答案：<a href="https://www.hiroom2.com/2017/02/18/linux-systemd-s-start-request-repeated-too-quickly-for-xxx-service/" target="_blank" rel="external">https://www.hiroom2.com/2017/02/18/linux-systemd-s-start-request-repeated-too-quickly-for-xxx-service/</a><br>修改文件（/lib/systemd/system/apache2.service）添加下设置禁用掉systemd对重启服务次数的限制．<br>StartLimitIntervalSec=0<br>StartLimitBurst=0<br>然后运行<br>sudo systemctl daemon-reload<br>sudo systemctl reset-failed apache2.service</p>
<p>2, 运行＂cd /bak/openstack/horizon &amp;&amp; /usr/bin/python3.8 manage.py compilemessages＂报下列错：<br>ModuleNotFoundError: No module named ‘django.utils.log.NullHandler’; ‘django.utils.log’ is not a package<br>Solution:<br>sed -i “s/django.utils.log.NullHandler/logging.NullHandler/g” ./openstack_dashboard/local/local_settings.py</p>
<p>3, 运行＂sudo ebtables -t broute -L＂报下列错：<br>table `broute’ is incompatible, use ‘nft’ tool<br>Solution:<br>Try Switching to iptable-legacy<br>sudo apt update &amp;&amp; sudo apt upgrade<br>sudo apt -y install iptables arptables ebtables<br>sudo update-alternatives –set iptables /usr/sbin/iptables-legacy || true<br>sudo update-alternatives –set ip6tables /usr/sbin/ip6tables-legacy || true<br>sudo update-alternatives –set arptables /usr/sbin/arptables-legacy || true<br>sudo update-alternatives –set ebtables /usr/sbin/ebtables-legacy || true</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/04/Autoinstall-Ubuntu20-04-KVM-Instance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/04/Autoinstall-Ubuntu20-04-KVM-Instance/" itemprop="url">Autoinstall Ubuntu20.04 KVM Instance</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-04T15:22:49+08:00">
                2020-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-07-04<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>我们将使用 non-GUI (text or console)的方式尽可能的自动通过KVM安装Ubuntu20.04虚机．<br>目前，Ubuntu20.04已经默认使用subiquity作为安装工具了 (之前使用debian-installer，使用preseed机制进行自动安装），subiquity使用cloud-init进行自动安装．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://cdimage.ubuntu.com/ubuntu/releases/20.04/release/ubuntu-20.04-live-server-arm64.iso</span><br><span class="line">wget http://cdimage.ubuntu.com/ubuntu-legacy-server/releases/20.04/release/ubuntu-20.04-legacy-server-amd64.iso</span><br></pre></td></tr></table></figure></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>打开硬件虚拟化，及安装KVM相关包．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install cpu-checker -y</span><br><span class="line">sudo kvm-ok  #remember to enable VT-x and VT-d in BIOS</span><br><span class="line">sudo apt install qemu qemu-kvm libvirt-daemon libvirt-clients bridge-utils virt-manager libosinfo-bin</span><br><span class="line">sudo systemctl status libvirtd</span><br><span class="line">lsmod |grep -i kvm</span><br><span class="line">egrep -c &apos;(vmx|svm)&apos; /proc/cpuinfo</span><br><span class="line">osinfo-query os|grep ubuntu</span><br></pre></td></tr></table></figure></p>
<h2 id="virt-install-console-only模式安装kvm虚机"><a href="#virt-install-console-only模式安装kvm虚机" class="headerlink" title="virt-install + console only模式安装kvm虚机"></a>virt-install + console only模式安装kvm虚机</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-install --name=demo --ram=8192 --vcpus=2 --hvm --virt-type=kvm \</span><br><span class="line">    --connect=qemu:///system --os-variant=ubuntu20.04 --os-type=linux --accelerate \</span><br><span class="line">    --disk=/game/demo.qcow2,bus=virtio,format=qcow2,cache=none,sparse=true,size=32 \</span><br><span class="line">    --network=bridge=virbr0,model=rtl8139 --nographics -v \</span><br><span class="line">    --location &apos;http://mirrors.cloud.tencent.com/ubuntu/dists/bionic/main/installer-amd64/&apos; --extra-args=&apos;console=ttyS0,115200n8 serial&apos;</span><br></pre></td></tr></table></figure>
<p>正常情况下，上面使用（–extra-args=’console=ttyS0,115200n8 serial’）参数应该就能自动通过console连接的(sudo virsh console demo), 但暂不清楚为什么不行 (实际上在后来调试时发现上面命令其实已经将下列内容添加到了虚机内部的/etc/default/grub文件).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_TERMINAL=serial</span><br><span class="line">GRUB_SERIAL_COMMAND=&quot;serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1&quot;</span><br></pre></td></tr></table></figure></p>
<p>OK, 我们可以继续采用下列两种方法之一在虚机内部enable console, 方法一如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ arp -an |grep $(sudo virsh domiflist demo |awk &apos;/default/ &#123;print $5&#125;&apos;)</span><br><span class="line">? (192.168.122.62) at 52:54:00:e8:fb:47 [ether] on virbr0</span><br><span class="line">ssh demo@192.168.122.62</span><br><span class="line">sudo vim /etc/default/grub</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash console=ttyS0&quot;</span><br><span class="line">sudo update-grub</span><br><span class="line">init 6</span><br></pre></td></tr></table></figure></p>
<p>方法二如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo virsh destroy demo</span><br><span class="line">sudo guestmount -d demo -i /mnt</span><br><span class="line">$ sudo cat /mnt/etc/default/grub |tail -n2</span><br><span class="line">GRUB_TERMINAL=serial</span><br><span class="line">GRUB_SERIAL_COMMAND=&quot;serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1&quot;</span><br><span class="line"></span><br><span class="line"># but above GRUB_SERIAL_COMMAND doesn&apos;t work, so remove them and use the following</span><br><span class="line">sudo vim /mnt/etc/default/grub</span><br><span class="line">#GRUB_CMDLINE_LINUX=&quot;&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;console=tty0 console=ttyS0,19200n8&quot;</span><br><span class="line"></span><br><span class="line">sudo vim /mnt/boot/grub/grub.cfg</span><br><span class="line">menuentry &apos;Ubuntu&apos; --class ubuntu --class gnu-linux --class gnu ...</span><br><span class="line">...</span><br><span class="line">        #linux  /boot/vmlinuz-5.4.0-40-generic root=UUID=646ea42b-f96e-465a-b20a-546ba34b03d6 ro  quiet splash $vt_handoff</span><br><span class="line">        linux   /boot/vmlinuz-5.4.0-40-generic root=UUID=646ea42b-f96e-465a-b20a-546ba34b03d6 ro console=ttyS0,19200 earlyprint=serial,ttyS0,19200 quiet splash $vt_handoff</span><br><span class="line"></span><br><span class="line">sudo guestunmount /mnt</span><br><span class="line">sudo virsh start demo &amp;&amp; sudo virsh --connect qemu:///system console demo</span><br></pre></td></tr></table></figure></p>
<h2 id="基于legacy-d-i-preseed机制自动安装"><a href="#基于legacy-d-i-preseed机制自动安装" class="headerlink" title="基于legacy d-i/preseed机制自动安装"></a>基于legacy d-i/preseed机制自动安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: we use legacy iso (legacy way uses debian-installer + preseed, new way uses subiquity + init-cloud)</span><br><span class="line">#       for new way pls refer - https://ubuntu.com/server/docs/install/autoinstall-quickstart</span><br><span class="line"># wget http://releases.ubuntu.com/20.04/ubuntu-20.04-live-server-amd64.iso</span><br><span class="line">wget http://cdimage.ubuntu.com/ubuntu-legacy-server/releases/20.04/release/ubuntu-20.04-legacy-server-amd64.iso</span><br><span class="line">wget http://mirrors.cloud.tencent.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/ubuntu-installer/amd64/initrd.gz</span><br><span class="line">wget http://mirrors.cloud.tencent.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/ubuntu-installer/amd64/linux</span><br><span class="line">wget https://help.ubuntu.com/lts/installation-guide/example-preseed.txt</span><br><span class="line">sed -e &quot;s/#.*//g&quot; example-preseed.txt  |awk &apos;&#123;if (length!=0) print $0&#125;&apos; &gt; preseed.cfg</span><br><span class="line">sed -i &quot;s/archive.ubuntu.com/mirrors.cloud.tencent.com/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/unassigned-hostname/openstack/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/unassigned-domain/lan/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/US\/Eastern/Asia\/Shanghai/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;s/ubuntu-desktop/standard, ubuntu-server/g&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/ubuntu-server/a\d-i pkgsel\/include string openssh-server&quot; preseed.cfg  #append a line after the matched line</span><br><span class="line">sed -i &quot;/openssh-server/a\d-i pkgsel\/upgrade select none&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/confirm_nooverwrite/a\d-i passwd\/user-fullname string demo&quot; preseed.cfg #create a new user demo</span><br><span class="line">sed -i &quot;/demo/a\d-i passwd\/user-password password password&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/user-password/a\d-i passwd\/user-password-again password password&quot; preseed.cfg</span><br><span class="line">sed -i &quot;/user-password-again/a\d-i user-setup\/allow-password-weak boolean true&quot; preseed.cfg</span><br><span class="line">sudo python -m http.server  #http://localhost:8000/preseed.cfg</span><br><span class="line">sudo mount -o ro /bak/images/ubuntu-20.04-legacy-server-amd64.iso /mnt/</span><br><span class="line">sudo virt-install --name demo --ram 8192 --vcpus 2 --virt-type kvm \</span><br><span class="line">   --connect=qemu:///system --os-variant=ubuntu20.04 --os-type=linux --accelerate \</span><br><span class="line">   --disk=/game/demo.qcow2,bus=virtio,format=qcow2,cache=none,sparse=true,size=32 \</span><br><span class="line">   --network bridge=virbr0 --graphics none --force --debug \</span><br><span class="line">   --cdrom=/bak/images/ubuntu-20.04-legacy-server-amd64.iso \</span><br><span class="line">   --boot kernel=./linux,initrd=./initrd.gz,kernel_args=&quot;console=ttyS0 url=http://192.168.99.135:8080/preseed.cfg debian-installer/allow_unauthenticated_ssl=true&quot;</span><br><span class="line"></span><br><span class="line">NOTE: 实际安装中，报找不着http://192.168.99.135:8080/preseed.cfg以致无法自动安装，奇怪．</span><br></pre></td></tr></table></figure>
<h2 id="基于subiquity-cloud-init新机制自动安装"><a href="#基于subiquity-cloud-init新机制自动安装" class="headerlink" title="基于subiquity/cloud-init新机制自动安装"></a>基于subiquity/cloud-init新机制自动安装</h2><p>参考 - <a href="https://ubuntu.com/server/docs/install/autoinstall-quickstart" target="_blank" rel="external">https://ubuntu.com/server/docs/install/autoinstall-quickstart</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># The crypted password is just &quot;ubuntu&quot;.</span><br><span class="line">cat &gt; user-data &lt;&lt; &apos;EOF&apos;</span><br><span class="line">#cloud-config</span><br><span class="line">autoinstall:</span><br><span class="line">  version: 1</span><br><span class="line">  identity:</span><br><span class="line">    hostname: openstack</span><br><span class="line">    password: &quot;$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0&quot;</span><br><span class="line">    username: ubuntu</span><br><span class="line">EOF</span><br><span class="line">touch meta-data</span><br><span class="line"></span><br><span class="line">sudo python -m http.server</span><br><span class="line"></span><br><span class="line"># Install ubuntu 20.04 with subiquity/cloud-init</span><br><span class="line">sudo umount /mnt</span><br><span class="line">sudo mount -o ro /bak/images/ubuntu-20.04-live-server-amd64.iso /mnt/   #remember to use live rather than legacy</span><br><span class="line">truncate -s 20G /game/demo.img</span><br><span class="line">sudo qemu-system-x86_64 -cdrom /bak/images/ubuntu-20.04-live-server-amd64.iso -bios /usr/share/qemu/OVMF.fd -nographic -serial mon:stdio -m 8096 -kernel /mnt/casper/vmlinuz -initrd /mnt/casper/initrd -append &apos;autoinstall ds=nocloud-net;s=http://localhost:8000/ console=ttyS0,115200n8&apos; -hda /game/demo.img</span><br><span class="line"></span><br><span class="line"># Boot the installed system</span><br><span class="line">kvm -no-reboot -m 8092 -drive file=/game/demo.img,format=raw,cache=none,if=virtio</span><br></pre></td></tr></table></figure></p>
<h2 id="Hack-Ubiquity’s-source-code"><a href="#Hack-Ubiquity’s-source-code" class="headerlink" title="Hack Ubiquity’s source code"></a>Hack Ubiquity’s source code</h2><p>see - <a href="https://blog.csdn.net/quqi99/article/details/76553404" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/76553404</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/30/juju-reactive-charm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/30/juju-reactive-charm/" itemprop="url">juju reactive charm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-30T15:34:10+08:00">
                2020-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hello-Charm"><a href="#Hello-Charm" class="headerlink" title="Hello Charm"></a>Hello Charm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install charm --classic</span><br><span class="line">mkdir -p ~/charms/&#123;layers,interfaces&#125;</span><br><span class="line">export CHARM_LAYERS_DIR=~/charms/layers</span><br><span class="line">export CHARM_INTERFACES_DIR=~/charms/interfaces</span><br><span class="line">cd ~/charms/layers/</span><br><span class="line">charm create layer-example</span><br><span class="line">charm proof layer-example</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes: [&apos;layer:basic&apos;]</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">name: layer-example</span><br><span class="line">summary: a very basic example charm</span><br><span class="line">maintainer: hua &lt;hua@t440p.lan&gt;</span><br><span class="line">description: |</span><br><span class="line">  This is my first charm</span><br><span class="line">tags:</span><br><span class="line">  # https://jujucharms.com/docs/stable/authors-charm-metadata</span><br><span class="line">  - misc</span><br><span class="line">  - tutorials</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import when, when_not, set_flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;layer-example.installed&apos;)</span><br><span class="line">def install_layer_example():</span><br><span class="line">    set_flag(&apos;layer-example.installed&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm build layer-example</span><br><span class="line">ls /tmp/charm-builds/layer-example</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes:</span><br><span class="line">  - &apos;layer:basic&apos;</span><br><span class="line">  - &apos;layer:apt&apos;</span><br><span class="line">options:</span><br><span class="line">  apt:</span><br><span class="line">    packages:</span><br><span class="line">     - hello</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import set_flag, when, when_not</span><br><span class="line">from charmhelpers.core.hookenv import application_version_set, status_set</span><br><span class="line">from charmhelpers.fetch import get_upstream_version</span><br><span class="line">import subprocess as sp</span><br><span class="line"></span><br><span class="line">@when_not(&apos;example.installed&apos;)</span><br><span class="line">def install_example():</span><br><span class="line">    set_flag(&apos;example.installed&apos;)</span><br><span class="line"></span><br><span class="line">@when(&apos;apt.installed.hello&apos;)</span><br><span class="line">def set_message_hello():</span><br><span class="line">    # Set the upstream version of hello for juju status.</span><br><span class="line">    application_version_set(get_upstream_version(&apos;hello&apos;))</span><br><span class="line">    # Run hello and get the message</span><br><span class="line">    message = sp.check_output(&apos;hello&apos;, stderr=sp.STDOUT)</span><br><span class="line">    # Set the active status with the message</span><br><span class="line">    status_set(&apos;active&apos;, message )</span><br><span class="line">    # Signal that we know the version of hello</span><br><span class="line">    set_flag(&apos;hello.version.set&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm build layer-example</span><br><span class="line"></span><br><span class="line">sudo snap install juju --classic</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=bionic --config agent-stream=devel localhost lxd-controller</span><br><span class="line">juju add-model test</span><br><span class="line">juju deploy /tmp/charm-builds/layer-example</span><br><span class="line">juju debug-log</span><br><span class="line">ls /var/lib/juju/agents/unit-layer-example-0/charm/reactive/layer_example.py</span><br></pre></td></tr></table></figure>
<h2 id="Add-a-mysql-interface"><a href="#Add-a-mysql-interface" class="headerlink" title="Add a mysql interface"></a>Add a mysql interface</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">includes:</span><br><span class="line">  - &apos;layer:basic&apos;</span><br><span class="line">  - &apos;layer:apt&apos;</span><br><span class="line">  - &apos;interface:mysql&apos;</span><br><span class="line">options:</span><br><span class="line">  apt:</span><br><span class="line">    packages:</span><br><span class="line">     - hello</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">name: layer-example</span><br><span class="line">summary: a very basic example charm</span><br><span class="line">maintainer: hua &lt;hua@t440p.lan&gt;</span><br><span class="line">description: |</span><br><span class="line">  This is my first charm</span><br><span class="line">tags:</span><br><span class="line">  # https://jujucharms.com/docs/stable/authors-charm-metadata</span><br><span class="line">  - misc</span><br><span class="line">  - tutorials</span><br><span class="line">requires:</span><br><span class="line">  database:</span><br><span class="line">    interface: mysql</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir layer-example/templates</span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/templates/text-file.tmpl&apos; &lt;&lt; EOF</span><br><span class="line">DB_HOST = &apos;&#123;&#123; my_database.host() &#125;&#125;&apos;</span><br><span class="line">DB_NAME = &apos;&#123;&#123; my_database.database() &#125;&#125;&apos;</span><br><span class="line">DB_USER = &apos;&#123;&#123; my_database.user() &#125;&#125;&apos;</span><br><span class="line">DB_PASSWORD = &apos;&#123;&#123; my_database.password() &#125;&#125;&apos;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; layer-example/reactive/layer_example.py&apos; &lt;&lt; EOF</span><br><span class="line">from charms.reactive import set_flag, when, when_not</span><br><span class="line">from charmhelpers.core.hookenv import application_version_set, status_set</span><br><span class="line">from charmhelpers.fetch import get_upstream_version</span><br><span class="line">import subprocess as sp</span><br><span class="line">from charmhelpers.core.templating import render</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;example.installed&apos;)</span><br><span class="line">def install_example():</span><br><span class="line">    set_flag(&apos;example.installed&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;apt.installed.hello&apos;)</span><br><span class="line">def set_message_hello():</span><br><span class="line">    # Set the upstream version of hello for juju status.</span><br><span class="line">    application_version_set(get_upstream_version(&apos;hello&apos;))</span><br><span class="line"></span><br><span class="line">    # Run hello and get the message</span><br><span class="line">    message = sp.check_output(&apos;hello&apos;, stderr=sp.STDOUT)</span><br><span class="line"></span><br><span class="line">    # Set the maintenance status with a message</span><br><span class="line">    status_set(&apos;maintenance&apos;, message )</span><br><span class="line"></span><br><span class="line">    # Signal that we know the version of hello</span><br><span class="line">    set_flag(&apos;hello.version.set&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;database.available&apos;)</span><br><span class="line">def write_text_file(mysql):</span><br><span class="line">    render(source=&apos;text-file.tmpl&apos;,</span><br><span class="line">           target=&apos;/root/text-file.txt&apos;,</span><br><span class="line">           owner=&apos;root&apos;,</span><br><span class="line">           perms=0o775,</span><br><span class="line">           context=&#123;</span><br><span class="line">               &apos;my_database&apos;: mysql,</span><br><span class="line">           &#125;)</span><br><span class="line">    status_set(&apos;active&apos;, &apos;Ready: File rendered.&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when_not(&apos;database.connected&apos;)</span><br><span class="line">def missing_mysql():</span><br><span class="line">    status_set(&apos;blocked&apos;, &apos;Please add relation to MySQL&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@when(&apos;database.connected&apos;)</span><br><span class="line">@when_not(&apos;database.available&apos;)</span><br><span class="line">def waiting_mysql(mysql):</span><br><span class="line">    status_set(&apos;waiting&apos;, &apos;Waiting for MySQL&apos;)</span><br><span class="line">EOF</span><br><span class="line">charm proof layer-example</span><br><span class="line">charm build layer-example</span><br><span class="line"></span><br><span class="line">sudo snap install juju --classic</span><br><span class="line">juju bootstrap --debug --config bootstrap-series=bionic --config agent-stream=devel localhost lxd-controller</span><br><span class="line">juju add-model test</span><br><span class="line">juju deploy /tmp/charm-builds/layer-example</span><br><span class="line">juju deploy cs:mysql</span><br><span class="line">juju add-relation layer-example mysql</span><br><span class="line">$ juju ssh layer-example/0 sudo cat /root/text-file.txt</span><br><span class="line">DB_HOST = &apos;10.63.242.39&apos;</span><br><span class="line">DB_NAME = &apos;layer-example&apos;</span><br><span class="line">DB_USER = &apos;eiMogh5Ahc1aido&apos;</span><br><span class="line">DB_PASSWORD = &apos;bieng5Quah5aehe&apos;Connection to 10.63.242.196 closed.</span><br></pre></td></tr></table></figure>
<h2 id="Charm-Store"><a href="#Charm-Store" class="headerlink" title="Charm Store"></a>Charm Store</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt;&gt; layer-example/layer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">repo: git@github.com:zhhuabj/layer-example.git</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; layer-example/metadata.yaml&apos; &lt;&lt; EOF</span><br><span class="line">series:</span><br><span class="line">  - xenial</span><br><span class="line">  - bionic</span><br><span class="line">EOF</span><br><span class="line">charm proof layer-example</span><br><span class="line">charm build layer-example</span><br><span class="line">charm login  #https://discourse.juju.is/</span><br><span class="line">cd /tmp/charm-builds/layer-example</span><br><span class="line">charm push .</span><br><span class="line">juju deploy cs:~zhhuabj/example-0</span><br></pre></td></tr></table></figure>
<h2 id="OSM-charm"><a href="#OSM-charm" class="headerlink" title="OSM charm"></a>OSM charm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install charm --classic</span><br><span class="line">mkdir -p /bak/work/charms/layers</span><br><span class="line">export JUJU_REPOSITORY=/bak/work/charms</span><br><span class="line">export LAYER_PATH=$JUJU_REPOSITORY/layers</span><br><span class="line">cd $LAYER_PATH</span><br><span class="line">charm create simple</span><br><span class="line">cd simple</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;layer.yaml&apos; &lt;&lt;EOF</span><br><span class="line">includes: [&apos;layer:basic&apos;, &apos;layer:vnfproxy&apos;]</span><br><span class="line">options:</span><br><span class="line">    basic:</span><br><span class="line">        use_venv: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;metadata.yaml&apos; &lt;&lt;EOF</span><br><span class="line">name: simple</span><br><span class="line">summary: a simple vnf proxy charm</span><br><span class="line">maintainer: hua &lt;hua@localhost&gt;</span><br><span class="line">subordinate: false</span><br><span class="line">series: [&apos;xenial&apos;]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;actions.yaml&apos; &lt;&lt;EOF</span><br><span class="line">touch:</span><br><span class="line">  description: &quot;Touch a file on the VNF.&quot;</span><br><span class="line">  params:</span><br><span class="line">    filename:</span><br><span class="line">        description: &quot;The name of the file to touch.&quot;</span><br><span class="line">        type: string</span><br><span class="line">        default: &quot;&quot;</span><br><span class="line">  required:</span><br><span class="line">    - filename</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir -p actions</span><br><span class="line">sudo bash -c &apos;cat &gt;actions/touch&apos; &lt;&lt;EOF</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">import sys</span><br><span class="line">sys.path.append(&apos;lib&apos;)</span><br><span class="line">from charms.reactive import main, set_flag</span><br><span class="line">from charmhelpers.core.hookenv import action_fail, action_name</span><br><span class="line"></span><br><span class="line">set_flag(&apos;actions.&#123;&#125;&apos;.format(action_name()))</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">   main()</span><br><span class="line">except Exception as e:</span><br><span class="line">   action_fail(repr(e))</span><br><span class="line">EOF</span><br><span class="line">sudo chmod +x actions/touch</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;reactive/simple.py&apos; &lt;&lt;EOF</span><br><span class="line">from charmhelpers.core.hookenv import (</span><br><span class="line">     action_get,</span><br><span class="line">     action_fail,</span><br><span class="line">     action_set,</span><br><span class="line">     status_set,</span><br><span class="line">)</span><br><span class="line">from charms.reactive import (</span><br><span class="line">     clear_flag,</span><br><span class="line">     set_flag,</span><br><span class="line">     when,</span><br><span class="line">     when_not,</span><br><span class="line">)</span><br><span class="line">import charms.sshproxy</span><br><span class="line"># Set the charm’s state to active so the LCM knows it’s ready to work.</span><br><span class="line">@when_not(&apos;simple.installed&apos;)</span><br><span class="line">def install_simple_proxy_charm():</span><br><span class="line">     set_flag(&apos;simple.installed&apos;)</span><br><span class="line">     status_set(&apos;active&apos;, &apos;Ready!&apos;)</span><br><span class="line"># Define what to do when the `touch` primitive is invoked.</span><br><span class="line">@when(&apos;actions.touch&apos;)</span><br><span class="line">def touch():</span><br><span class="line">     err = &apos;&apos;</span><br><span class="line">     try:</span><br><span class="line">          filename = action_get(&apos;filename&apos;)</span><br><span class="line">          cmd = [&apos;touch &#123;&#125;&apos;.format(filename)]</span><br><span class="line">          result, err = charms.sshproxy._run(cmd)</span><br><span class="line">     except:</span><br><span class="line">         action_fail(&apos;command failed:&apos; + err)</span><br><span class="line">     else:</span><br><span class="line">         action_set(&#123;&apos;output&apos;: result&#125;)</span><br><span class="line">      finally:</span><br><span class="line">          clear_flag(&apos;actions.touch&apos;)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">charm build</span><br><span class="line"></span><br><span class="line">vnfd file</span><br><span class="line">vnfd:vnfd-catalog:</span><br><span class="line">    vnfd:</span><br><span class="line">    -   id: hackfest3charmed-vnf</span><br><span class="line">        name: hackfest3charmed-vnf</span><br><span class="line">        vnf-configuration:</span><br><span class="line">            juju:</span><br><span class="line">                charm: simple</span><br><span class="line">            initial-config-primitive:</span><br><span class="line">            -   seq: &apos;1&apos;</span><br><span class="line">                name: config</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: ssh-hostname</span><br><span class="line">                    value: &lt;rw_mgmt_ip&gt;</span><br><span class="line">                -   name: ssh-username</span><br><span class="line">                    value: ubuntu</span><br><span class="line">                -   name: ssh-password</span><br><span class="line">                    value: osm4u</span><br><span class="line">            -   seq: &apos;2&apos;</span><br><span class="line">                name: touch</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: filename</span><br><span class="line">                    value: &apos;/home/ubuntu/first-touch&apos;</span><br><span class="line">            config-primitive:</span><br><span class="line">            -   name: touch</span><br><span class="line">                parameter:</span><br><span class="line">                -   name: filename</span><br><span class="line">                    data-type: STRING</span><br><span class="line">                    default-value: &apos;/home/ubuntu/touched&apos;</span><br></pre></td></tr></table></figure>
<h2 id="Debug-it"><a href="#Debug-it" class="headerlink" title="Debug it"></a>Debug it</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p clear_flag run-default-upgrade-charm ; charms.reactive -p clear_flag ceph.create_pool.req.sent; hooks/update-status&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju run --unit gnocchi/2 -- &apos;hooks/shared-db-relation-changed&apos;</span><br><span class="line">juju status</span><br><span class="line">juju upgrade-charm gnocchi --revision 30</span><br><span class="line">https://paste.ubuntu.com/p/qPm5dtFtz2/</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- &apos;for flag in shared-db.connected shared-db.available shared-db.available.access_network shared-db.available.ssl; do charms.reactive -p clear_flag $flag; done&apos;</span><br><span class="line"></span><br><span class="line">#https://bugs.launchpad.net/juju/+bug/1891395/comments/4</span><br><span class="line">juju remove-relation vault:secrets kubernetes-master:vault-kv --force</span><br><span class="line">juju resolved vault/2 --no-retry  #make sure there no error state</span><br><span class="line">juju status --relation vault-kv   #make sure all relations have been removed</span><br><span class="line">juju run --unit vault/0 -- &apos;relation-ids shared-db&apos;</span><br><span class="line">juju add-relation vault:secrets kubernetes-master:vault-kv</span><br><span class="line"></span><br><span class="line">juju run --unit graylog/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;nagios_token&apos;)); print(charms.leadership.leader_get(&apos;nagios_token&apos;))&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[1] https://review.opendev.org/#/c/686584/3/src/reactive/gnocchi_handlers.py</span><br><span class="line">[2] https://review.opendev.org/#/c/700125/1/src/reactive/gnocchi_handlers.py</span><br><span class="line">[3] https://review.opendev.org/#/c/716545/4/src/reactive/gnocchi_handlers.py</span><br></pre></td></tr></table></figure>
<h2 id="sru"><a href="#sru" class="headerlink" title="sru"></a>sru</h2><p>fix needs to backport to stable backport, eg: <a href="https://review.opendev.org/#/c/758038" target="_blank" rel="external">https://review.opendev.org/#/c/758038</a><br>and stable backport is merged and available in 20.08 charm cs:octavia-28 (when?)</p>
<p>another example<br>1, merge the code into master(openstack-charmers-next) - <a href="https://review.opendev.org/#/c/755276/" target="_blank" rel="external">https://review.opendev.org/#/c/755276/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://jaas.ai/u/openstack-charmers-next</span><br><span class="line">https://jaas.ai/u/openstack-charmers-next/vault/118</span><br><span class="line">https://jaas.ai/vault</span><br><span class="line">hua@t440p:/bak/work/charms/vault$ git log |grep a38bf7 -A 2 |grep -E &apos;a38bf7|Date&apos;</span><br><span class="line">Merge: ae2d79f a38bf7c</span><br><span class="line">Date:   Wed Nov 4 12:36:34 2020 +0000</span><br><span class="line">commit a38bf7cbd265ab46357ea7f9e99f55d126da8fb2</span><br><span class="line">Date:   Wed Sep 30 17:45:43 2020 +0530</span><br></pre></td></tr></table></figure></p>
<p>2, Backport patch submitted to stable branch (eg: branch/20.10) according to <a href="https://docs.openstack.org/charm-guide/latest/release-schedule.html" target="_blank" rel="external">https://docs.openstack.org/charm-guide/latest/release-schedule.html</a><br>3, stable backport is merged and available in 20.10 charm cs:vault-42 - <a href="https://jaas.ai/vault" target="_blank" rel="external">https://jaas.ai/vault</a><br>4,  the patch is ready to be applied. When would be a suitable time to update the Octavia charm in your environment?<br>but when will get charm revision nubmer? Is it the moment when the code is merged into the git repository, or is it going to take a few days?     I think some one need to trigger -<br><a href="https://docs.openstack.org/charm-guide/latest/release-policy.html" target="_blank" rel="external">https://docs.openstack.org/charm-guide/latest/release-policy.html</a></p>
<h2 id="20201110更新-nagios-nrpe-ntp-charm流程"><a href="#20201110更新-nagios-nrpe-ntp-charm流程" class="headerlink" title="20201110更新 - nagios/nrpe/ntp charm流程"></a>20201110更新 - nagios/nrpe/ntp charm流程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">/etc/nagios/nrpe.d/check_ntpmon.py是由nrpe subordinate charm在render_nrpe_check_config中创建的。</span><br><span class="line"></span><br><span class="line"># nrpe subordinate charm has a nrpe-external-master relation</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-worker:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:monitors nagios:monitors</span><br><span class="line"></span><br><span class="line"># subordinate charm ntp deployed to the same principal (kubernetes-worker) also has a nrpe-external-master relation</span><br><span class="line">juju add-relation kubernetes-worker ntp</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line"></span><br><span class="line">ntp与nrpe都是kubernetest-worker的subordinate charm,  所以运行上面的“juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master”之后nrpe subordinate charm也会把它和ntp subordinate charm的check_ntpmon这个monitor一起搜索后通过render_nrpe_check_config写到/etc/nagios/nrpe.d/check_ntpmon.py</span><br><span class="line"></span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-ids nrpe-external-master&quot;</span><br><span class="line">nrpe-external-master:18</span><br><span class="line">nrpe-external-master:24</span><br><span class="line">juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:18&quot;</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:18&quot;</span><br><span class="line">kubernetes-worker/0</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-list -r nrpe-external-master:24&quot;</span><br><span class="line">ntp/1</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:18 - kubernetes-worker/0&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        node:</span><br><span class="line">          command: check_node</span><br><span class="line">        snap.kube-proxy.daemon:</span><br><span class="line">          command: check_snap.kube-proxy.daemon</span><br><span class="line">        snap.kubelet.daemon:</span><br><span class="line">          command: check_snap.kubelet.daemon</span><br><span class="line">primary: &quot;True&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:24 - ntp/1&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        ntpmon:</span><br><span class="line">          command: check_ntpmon</span><br><span class="line">primary: &quot;False&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line"></span><br><span class="line">class MonitorsRelation(helpers.RelationContext):</span><br><span class="line">...</span><br><span class="line">    def get_monitors(self):</span><br><span class="line">        all_monitors = Monitors()</span><br><span class="line">        monitors = [</span><br><span class="line">            self.get_principal_monitors(),</span><br><span class="line">            self.get_subordinate_monitors(),</span><br><span class="line">            self.get_user_defined_monitors(),</span><br><span class="line">        ]</span><br><span class="line">        for mon in monitors:</span><br><span class="line">            all_monitors.add_monitors(mon)</span><br><span class="line">        return all_monitors</span><br><span class="line"></span><br><span class="line">def render_nrpe_check_config(checkctxt):</span><br><span class="line">    &quot;&quot;&quot;Write nrpe check definition.&quot;&quot;&quot;</span><br><span class="line">    # Only render if we actually have cmd parameters</span><br><span class="line">    if checkctxt[&quot;cmd_params&quot;]:</span><br><span class="line">        render(</span><br><span class="line">            &quot;nrpe_command.tmpl&quot;,</span><br><span class="line">            &quot;/etc/nagios/nrpe.d/&#123;&#125;.cfg&quot;.format(checkctxt[&quot;cmd_name&quot;]),</span><br><span class="line">            checkctxt,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">这样会和下列升级路径产生竞争从而出现问题.</span><br><span class="line">ntp包含了layer-ntpmon会先有/opt/ntpmon-ntp-charm/check_ntpmon.cfg</span><br><span class="line">ntp upgrade之后调用update_nrpe_config, 会先调用charmhelpr的copy_nrpe_checks将/opt/ntpmon-ntp-charm/check_ntpmon.cfg写到/usr/local/lib/nagios/plugins/check_ntpmon.py</span><br><span class="line">然后copy_nrpe_checks会继续调用charmhelper中的NRPE#add_check然后调用NRPE#write最后调用Check#write这时去写/etc/nagios/nrpe.d/check_ntpmon.py发现不存在从而抛错。</span><br><span class="line"></span><br><span class="line">1, check_ntpmon.cfg is from layer-ntpmon (ntp charm includes it) and is copied to /opt/ntpmon-ntp-charm/check_ntpmon.cfg [3]</span><br><span class="line"></span><br><span class="line">hua@t440p:/bak/work/charms/ntp$ grep -r &apos;options&apos; layer.yaml -A 2</span><br><span class="line">options:</span><br><span class="line">    ntpmon:</span><br><span class="line">        install-dir: /opt/ntpmon-ntp-charm</span><br><span class="line"></span><br><span class="line"># https://git.launchpad.net/ntpmon/tree/reactive/ntpmon.py#n72</span><br><span class="line">@when_not(&apos;ntpmon.installed&apos;)</span><br><span class="line">def install_ntpmon():</span><br><span class="line">    install_dir = layer.options.get(&apos;ntpmon&apos;, &apos;install-dir&apos;)</span><br><span class="line">    if install_dir:</span><br><span class="line">        host.mkdir(os.path.dirname(install_dir))</span><br><span class="line">        host.rsync(&apos;src/&apos;, &apos;&#123;&#125;/&apos;.format(install_dir))</span><br><span class="line"></span><br><span class="line">2, ntp&apos;s upgrade-charm will set nrpe-external-master.available so then update_nrpe_config is called</span><br><span class="line"></span><br><span class="line">258 @when_all(&apos;nrpe-external-master.available&apos;, &apos;ntpmon.installed&apos;)</span><br><span class="line">259 @when_not(&apos;ntp.nrpe.configured&apos;)</span><br><span class="line">260 def update_nrpe_config():</span><br><span class="line">261     options = layer.options(&apos;ntpmon&apos;)</span><br><span class="line">262     if options is None or &apos;install-dir&apos; not in options:</span><br><span class="line">263         return</span><br><span class="line">265     nrpe.copy_nrpe_checks(nrpe_files_dir=options[&apos;install-dir&apos;])</span><br><span class="line"></span><br><span class="line">3, charmhelper&apos;s copy_nrpe_checks will copy /opt/ntpmon-ntp-charm/check_ntpmon.cfg to /usr/local/lib/nagios/plugins/check_ntpmon.py</span><br><span class="line"></span><br><span class="line">def copy_nrpe_checks(nrpe_files_dir=None):</span><br><span class="line">    ...</span><br><span class="line">    NAGIOS_PLUGINS = &apos;/usr/local/lib/nagios/plugins&apos;</span><br><span class="line">    for fname in glob.glob(os.path.join(nrpe_files_dir, &quot;check_*&quot;)):</span><br><span class="line">        if os.path.isfile(fname):</span><br><span class="line">            shutil.copy2(fname, os.path.join(NAGIOS_PLUGINS, os.path.basename(fname)))</span><br><span class="line"></span><br><span class="line">4, then update_nrpe_config continues to run charmhelper NRPE&apos;s add_check,</span><br><span class="line"></span><br><span class="line">258 @when_all(&apos;nrpe-external-master.available&apos;, &apos;ntpmon.installed&apos;)</span><br><span class="line">259 @when_not(&apos;ntp.nrpe.configured&apos;)</span><br><span class="line">260 def update_nrpe_config():</span><br><span class="line">    ...</span><br><span class="line">279     check_cmd = os.path.join(options[&apos;install-dir&apos;], &apos;check_ntpmon.py&apos;) + &apos; --check &apos; + &apos; &apos;.join(nagios_ntpmon_checks)</span><br><span class="line">280     unitdata.kv().set(&apos;check_cmd&apos;, check_cmd)</span><br><span class="line">281     nrpe_setup.add_check(</span><br><span class="line">282         check_cmd=check_cmd,</span><br><span class="line">283         description=&apos;Check NTPmon &#123;&#125;&apos;.format(current_unit),</span><br><span class="line">284         shortname=&quot;ntpmon&quot;,</span><br><span class="line">285     )</span><br><span class="line">286     nrpe_setup.write()</span><br><span class="line"></span><br><span class="line">here check_cmd should be:</span><br><span class="line"></span><br><span class="line">#juju config ntp nagios_ntpmon_checks</span><br><span class="line">/opt/ntpmon-ntp-charm/check_ntpmon.cfg --check offset peers reach sync proc vars</span><br><span class="line"></span><br><span class="line">We also saw the following context from sosreport, so there&apos;s no problem with this.</span><br><span class="line"></span><br><span class="line"># check ntpmon</span><br><span class="line"># The following header was added automatically by juju</span><br><span class="line"># Modifying it will affect nagios monitoring and alerting</span><br><span class="line"># servicegroups: juju</span><br><span class="line">command[check_ntpmon]=/opt/ntpmon-ntp-charm/check_ntpmon.py --check offset peers reach sync proc vars</span><br><span class="line"></span><br><span class="line">5, then update_nrpe_config continues to run charmhelper NRPE&apos;s write,</span><br><span class="line"></span><br><span class="line">class NRPE(object):</span><br><span class="line">    ...</span><br><span class="line">    nrpe_confdir = &apos;/etc/nagios/nrpe.d&apos;</span><br><span class="line">    def write(self):</span><br><span class="line">        ...</span><br><span class="line">        # check that the charm can write to the conf dir.  If not, then nagios</span><br><span class="line">        # probably isn&apos;t installed, and we can defer.</span><br><span class="line">        if not self.does_nrpe_conf_dir_exist():</span><br><span class="line">            return</span><br><span class="line">        for nrpecheck in self.checks:</span><br><span class="line">            nrpecheck.write(self.nagios_context, self.hostname, self.nagios_servicegroups)</span><br><span class="line"></span><br><span class="line">6, charmhelp NRPE&apos;s write invokes Check&apos;s write.</span><br><span class="line"></span><br><span class="line">class Check(object):</span><br><span class="line">    ...</span><br><span class="line">    def _get_check_filename(self):</span><br><span class="line">        return os.path.join(NRPE.nrpe_confdir, &apos;&#123;&#125;.cfg&apos;.format(self.command))</span><br><span class="line">    def write(self, nagios_context, hostname, nagios_servicegroups):</span><br><span class="line">        nrpe_check_file = self._get_check_filename()</span><br><span class="line">        with open(nrpe_check_file, &apos;w&apos;) as nrpe_check_config:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">原理搞清楚了，通过下列命令可以重现问题(直接运行“juju upgrade-charm ntp --revision 41”不知道为什么有时候不触发）</span><br><span class="line">juju remove-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag ntp.installed ; charms.reactive -p set_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line"></span><br><span class="line">==&gt; /var/log/juju/unit-ntp-2.log &lt;==</span><br><span class="line">2020-11-10 12:21:05 INFO juju-log Invoking reactive handler: reactive/ntp.py:112:install</span><br><span class="line">2020-11-10 12:21:06 INFO juju-log Installing [&apos;chrony&apos;] with options: [&apos;--option=Dpkg::Options::=--force-confold&apos;]</span><br><span class="line">2020-11-10 12:21:06 INFO juju-log Installing [&apos;facter&apos;, &apos;ntpdate&apos;, &apos;python3-psutil&apos;, &apos;virt-what&apos;] with options: [&apos;--option=Dpkg::Options::=--force-confold&apos;]</span><br><span class="line">2020-11-10 12:21:09 INFO juju-log Invoking reactive handler: reactive/ntp.py:179:config_changed</span><br><span class="line">2020-11-10 12:21:09 INFO juju-log Invoking reactive handler: reactive/ntp.py:258:update_nrpe_config</span><br><span class="line">2020-11-10 12:21:09 ERROR juju-log Hook error:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/__init__.py&quot;, line 74, in main</span><br><span class="line">    bus.dispatch(restricted=restricted_mode)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 390, in dispatch</span><br><span class="line">    _invoke(other_handlers)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 359, in _invoke</span><br><span class="line">    handler.invoke()</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charms/reactive/bus.py&quot;, line 181, in invoke</span><br><span class="line">    self._action(*args)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/charm/reactive/ntp.py&quot;, line 286, in update_nrpe_config</span><br><span class="line">    nrpe_setup.write()</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charmhelpers/contrib/charmsupport/nrpe.py&quot;, line 315, in write</span><br><span class="line">    self.nagios_servicegroups)</span><br><span class="line">  File &quot;/var/lib/juju/agents/unit-ntp-2/.venv/lib/python3.6/site-packages/charmhelpers/contrib/charmsupport/nrpe.py&quot;, line 196, in write</span><br><span class="line">    with open(nrpe_check_file, &apos;w&apos;) as nrpe_check_config:</span><br><span class="line">FileNotFoundError: [Errno 2] No such file or directory: &apos;/etc/nagios/nrpe.d/check_ntpmon.cfg&apos;</span><br><span class="line"></span><br><span class="line">发现只是nagios/0上的ntp/2才是error状态，而其他ntp units则是active的。显然是因为缺乏这个关系（juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master）导致。</span><br><span class="line">nagios/0*             active    idle   2        10.5.2.4        80/tcp          ready</span><br><span class="line">  ntp/2*              error    idle            10.5.2.4        123/udp         chrony: Ready</span><br><span class="line"></span><br><span class="line">所以要想恢复，得先把这个关系加上“juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master”之后，nrpe-external-master:24变成了nrpe-external-master:25</span><br><span class="line">$ juju run --unit nrpe/1 &quot;relation-get -r nrpe-external-master:25 - ntp/1&quot;</span><br><span class="line">egress-subnets: 10.5.2.192/32</span><br><span class="line">ingress-address: 10.5.2.192</span><br><span class="line">monitors: |</span><br><span class="line">  monitors:</span><br><span class="line">    remote:</span><br><span class="line">      nrpe:</span><br><span class="line">        ntpmon:</span><br><span class="line">          command: check_ntpmon</span><br><span class="line">primary: &quot;False&quot;</span><br><span class="line">private-address: 10.5.2.192</span><br><span class="line"></span><br><span class="line">最后运行下列命令将error状态修复好。</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line">juju resolved ntp/2</span><br><span class="line"></span><br><span class="line">环境搭建：</span><br><span class="line">juju add-model k8s stsstack/stsstack</span><br><span class="line">juju deploy kubernetes-core</span><br><span class="line">juju deploy nagios</span><br><span class="line">juju deploy nrpe</span><br><span class="line">juju deploy cs:ntp-39</span><br><span class="line">juju expose nagios</span><br><span class="line">juju add-relation nagios:monitors nrpe:monitors</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-master:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:nrpe-external-master kubernetes-worker:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:nrpe-external-master etcd:nrpe-external-master</span><br><span class="line">juju add-relation nrpe:general-info easyrsa:juju-info</span><br><span class="line">juju add-relation easyrsa:juju-info ntp:juju-info</span><br><span class="line">juju add-relation kubernetes-worker:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nagios:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju upgrade-charm ntp --revision 41</span><br><span class="line">juju run --unit ntp/2 -- &apos;charms.reactive -p clear_flag ntp.installed ; charms.reactive -p set_flag nrpe-external-master.available; hooks/update-status&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">juju add-model nagios stsstack/stsstack</span><br><span class="line">juju deploy ubuntu</span><br><span class="line">juju deploy nrpe</span><br><span class="line">juju deploy nagios</span><br><span class="line">juju deploy cs:ntp-39</span><br><span class="line">juju add-relation ubuntu nrpe</span><br><span class="line">juju add-relation nrpe:monitors nagios:monitors</span><br><span class="line">juju add-relation ubuntu ntp</span><br><span class="line">juju add-relation nagios:juju-info ntp:juju-info</span><br><span class="line">juju add-relation nrpe:nrpe-external-master ntp:nrpe-external-master</span><br><span class="line">juju upgrade-charm ntp --revision 41</span><br></pre></td></tr></table></figure>
<h2 id="20201114更新-如何获取vault中的cert-key"><a href="#20201114更新-如何获取vault中的cert-key" class="headerlink" title="20201114更新 - 如何获取vault中的cert/key"></a>20201114更新 - 如何获取vault中的cert/key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export VAULT_ADDR=&quot;http://10.5.0.27:8200&quot;</span><br><span class="line">vault status</span><br><span class="line">curl -s -H &quot;X-Vault-Token:$VAULT_TOKEN&quot; http://localhost:8200/v1/$pki_backend/certs/pem</span><br><span class="line"></span><br><span class="line">$ juju run --unit nova-cloud-controller/0 &quot;relation-list -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;)&quot;</span><br><span class="line">vault/0</span><br><span class="line">juju run --unit nova-cloud-controller/0 &quot;relation-get -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;) - vault/0&quot; |grep -E &apos;cert|key|ca&apos;</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;charm.vault.global-client-cert&apos;));&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># charm-nova-cloud-controller/blob/master/charmhelpers/contrib/openstack/cert_utils.py#install_certs is used to install cert/key</span><br><span class="line">vim vault/src/reactive/vault_handlers.py#publish_global_client_cert</span><br><span class="line">def publish_global_client_cert():</span><br><span class="line">      ...</span><br><span class="line">      bundle = vault_pki.generate_certificate(&apos;client&apos;, &apos;global-client&apos;, [], ttl, max_ttl)</span><br><span class="line">      unitdata.kv().set(&apos;charm.vault.global-client-cert&apos;, bundle)</span><br><span class="line">      ...</span><br><span class="line">      tls.set_client_cert(bundle[&apos;certificate&apos;], bundle[&apos;private_key&apos;])</span><br></pre></td></tr></table></figure>
<h2 id="20201114更新-k8s升级过程中出错"><a href="#20201114更新-k8s升级过程中出错" class="headerlink" title="20201114更新 - k8s升级过程中出错"></a>20201114更新 - k8s升级过程中出错</h2><p>k8s在升级过程中会有两个client_token，下面逻辑会导致有的master的token是旧的，有的是新的，这样，workers上的token也会有旧的有新的，从而有的有问题有的无问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/N &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/N&apos; for /0 and /4</span><br><span class="line">juju run --unit kubernetes-master/0 &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/0&apos; |grep client_token</span><br><span class="line">juju run --unit kubernetes-master/1 &apos;relation-get -r $(relation-ids kube-control) - kubernetes-master/1&apos; |grep client_token</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">This is the whole code process for the further diagnosis</span><br><span class="line"></span><br><span class="line">1, kubernetes-master leader will invoke create_tokens_and_sign_auth_requests to generate client_token and then call &apos;kube_control.sign_auth_request&apos;, while non-leader won&apos;t do it.</span><br><span class="line"></span><br><span class="line">        if kubelet_token and proxy_token and client_token:</span><br><span class="line">            kube_control.sign_auth_request(request[0], username,</span><br><span class="line">                                           kubelet_token, proxy_token,</span><br><span class="line">                                           client_token)</span><br><span class="line"></span><br><span class="line">https://github.com/freyes/charm-kubernetes-master/blob/master/reactive/kubernetes_master.py#L1273</span><br><span class="line"></span><br><span class="line">2, interface-kube-control&apos;s sign_auth_request will update &apos;creds&apos; for all relations like kubernetes-worker</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/provides.py#L95</span><br><span class="line"></span><br><span class="line">3, interface-kube-control will set the flag kube-control.auth.available after &apos;creds&apos; is set</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/requires.py#L37</span><br><span class="line"></span><br><span class="line">4, kubernetes-worker will run start_worker if kube-control.auth.available is set</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L592</span><br><span class="line"></span><br><span class="line">and check if creds is changed and run create_config</span><br><span class="line"></span><br><span class="line">    creds = db.get(&apos;credentials&apos;)</span><br><span class="line">    data_changed(&apos;kube-control.creds&apos;, creds)</span><br><span class="line">    create_config(servers[get_unit_number() % len(servers)], creds)</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L621</span><br><span class="line"></span><br><span class="line">5, kubernetes_worker will call kube_control.get_auth_credentials when kube-control.connected is set</span><br><span class="line"></span><br><span class="line">@when(&apos;kube-control.connected&apos;)</span><br><span class="line">def catch_change_in_creds(kube_control):</span><br><span class="line">    &quot;&quot;&quot;Request a service restart in case credential updates were detected.&quot;&quot;&quot;</span><br><span class="line">    nodeuser = &apos;system:node:&#123;&#125;&apos;.format(get_node_name().lower())</span><br><span class="line">    creds = kube_control.get_auth_credentials(nodeuser)</span><br><span class="line"></span><br><span class="line">https://github.com/charmed-kubernetes/charm-kubernetes-worker/blob/master/reactive/kubernetes_worker.py#L1205</span><br><span class="line"></span><br><span class="line">6, get_auth_credentials get creds from all leader and non-leader</span><br><span class="line"></span><br><span class="line">    def get_auth_credentials(self, user):</span><br><span class="line">        rx = &#123;&#125;</span><br><span class="line">        for unit in self.all_joined_units:</span><br><span class="line">            rx.update(unit.received.get(&apos;creds&apos;, &#123;&#125;))</span><br><span class="line"></span><br><span class="line">https://github.com/juju-solutions/interface-kube-control/blob/master/requires.py#L57-L58</span><br></pre></td></tr></table></figure>
<p>是应该运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/0 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;admin::gQL9NVtbxY1GCAyIg2xc36JwZ1sHOXm9&apos;&quot;</span><br><span class="line">juju run --unit kubernetes-master/5 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;admin::gQL9NVtbxY1GCAyIg2xc36JwZ1sHOXm9&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<p>还是清空它呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju run --unit kubernetes-master/0 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;&apos;&quot;</span><br><span class="line">juju run --unit kubernetes-master/5 &quot;relation-set --format=json -r kube-control:&lt;ID&gt; creds=&apos;&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<p>升级过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># Upgrade containerd charm</span><br><span class="line">$ juju upgrade-charm containerd --revision 88</span><br><span class="line"></span><br><span class="line"># Upgrade etcd charm</span><br><span class="line">If you want you can make an additional backup of etcd:</span><br><span class="line">$ juju run-action etcd/0 snapshot --wait</span><br><span class="line"></span><br><span class="line">$ juju scp etcd/0:/home/ubuntu/etcd-snapshots/&lt;filename&gt;.tar.gz .</span><br><span class="line"></span><br><span class="line">Perform the upgrade</span><br><span class="line">$ juju upgrade-charm etcd --revision 531</span><br><span class="line"></span><br><span class="line"># Upgrade easyrsa charm</span><br><span class="line">$ juju upgrade-charm easyrsa --revision 325</span><br><span class="line"></span><br><span class="line"># Upgrade canal charm</span><br><span class="line">$ juju upgrade-charm canal --revision 736</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master charm</span><br><span class="line">$ juju upgrade-charm kubernetes-master --revision 865</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker charm</span><br><span class="line">$ juju upgrade-charm kubernetes-worker --revision 692</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Make a backup</span><br><span class="line"></span><br><span class="line"># Set kubernetes-master to the 1.18 channel</span><br><span class="line">juju config kubernetes-master channel=1.18/stable</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master units, one at a time</span><br><span class="line">juju run-action kubernetes-master/0 upgrade</span><br><span class="line">juju run-action kubernetes-master/3 upgrade</span><br><span class="line">juju run-action kubernetes-master/4 upgrade</span><br><span class="line"></span><br><span class="line"># Set kubernetes-worker to the 1.18 channel</span><br><span class="line">juju config kubernetes-worker channel=1.18/stable</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker units, one at a time</span><br><span class="line">juju run-action kubernetes-worker/0 upgrade</span><br><span class="line">juju run-action kubernetes-worker/1 upgrade</span><br><span class="line">juju run-action kubernetes-worker/2 upgrade</span><br><span class="line">juju run-action kubernetes-worker/3 upgrade</span><br><span class="line"></span><br><span class="line">juju config etcd channel=&quot;3.4/stable&quot;</span><br><span class="line"></span><br><span class="line">juju upgrade-charm openstack-dashboard --revision 308</span><br><span class="line">juju upgrade-charm keystone --revision 319</span><br><span class="line"></span><br><span class="line">Once we have upgraded to 1.18, if we still have time, I would recommend that we upgrade some additional charms to take advantage of some bug fixes.</span><br><span class="line"></span><br><span class="line"># Make a backup</span><br><span class="line"></span><br><span class="line"># Upgrade containerd charm</span><br><span class="line">$ juju upgrade-charm containerd --revision 94</span><br><span class="line"></span><br><span class="line"># Upgrade etcd charm</span><br><span class="line">$ juju upgrade-charm etcd --revision 540</span><br><span class="line"></span><br><span class="line"># Upgrade easyrsa charm</span><br><span class="line">$ juju upgrade-charm easyrsa --revision 333</span><br><span class="line"></span><br><span class="line"># Upgrade canal charm</span><br><span class="line">$ juju upgrade-charm canal --revision 741</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-master charm</span><br><span class="line">$ juju upgrade-charm kubernetes-master --revision 891</span><br><span class="line"></span><br><span class="line"># Upgrade kubernetes-worker charm</span><br><span class="line">$ juju upgrade-charm kubernetes-worker --revision 704</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://osm.etsi.org/wikipub/index.php/Creating_your_VNF_Charm" target="_blank" rel="external">https://osm.etsi.org/wikipub/index.php/Creating_your_VNF_Charm</a><br>[2] <a href="https://cloud.garr.it/charms/create-and-deploy-charms/" target="_blank" rel="external">https://cloud.garr.it/charms/create-and-deploy-charms/</a><br>[3] <a href="https://discourse.juju.is/t/tutorial-charm-development-beginner-part-1/377" target="_blank" rel="external">https://discourse.juju.is/t/tutorial-charm-development-beginner-part-1/377</a><br>[4] <a href="https://discourse.juju.is/t/tutorial-charm-development-beginner-part-3/379" target="_blank" rel="external">https://discourse.juju.is/t/tutorial-charm-development-beginner-part-3/379</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/21/Integrate-k8s-with-cert-maanger-and-vault/" itemprop="url">Integrate k8s with cert-maanger and vault</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-21T18:50:34+08:00">
                2020-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-05-21<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">#install vault</span><br><span class="line">#https://ubuntu.com/kubernetes/docs/using-vault</span><br><span class="line">#https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-certificate-management.html</span><br><span class="line">#https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-vault.html</span><br><span class="line">#./generate-bundle.sh -s bionic --create-model --name k8s --run</span><br><span class="line">wget https://raw.githubusercontent.com/charmed-kubernetes/bundle/master/overlays/vault-pki-overlay.yaml</span><br><span class="line">./generate-bundle.sh -s bionic --name k8s</span><br><span class="line">juju add-model k8s &amp;&amp; juju deploy ... --overlay ./vault-pki-overlay.yaml ...</span><br><span class="line">juju status vault-ca</span><br><span class="line">$ cat vault-pki-overlay.yaml</span><br><span class="line">applications:</span><br><span class="line">  easyrsa: null</span><br><span class="line">  vault:</span><br><span class="line">    charm: cs:~openstack-charmers-next/vault</span><br><span class="line">    num_units: 1</span><br><span class="line">    options:</span><br><span class="line">      auto-generate-root-ca-cert: true</span><br><span class="line">  percona-cluster:</span><br><span class="line">    charm: cs:percona-cluster</span><br><span class="line">    num_units: 1</span><br><span class="line">relations:</span><br><span class="line">- - kubernetes-master:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - etcd:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - kubernetes-worker:certificates</span><br><span class="line">  - vault:certificates</span><br><span class="line">- - vault:shared-db</span><br><span class="line">  - percona-cluster:shared-db</span><br><span class="line"></span><br><span class="line">#install vault client</span><br><span class="line">juju expose vault</span><br><span class="line">sudo snap install vault</span><br><span class="line">#./tools/vault-unseal-and-authorise.sh</span><br><span class="line">export VAULT_ADDR=http://10.0.0.22:8200  #vault_ip is 10.0.0.22</span><br><span class="line">vault operator init -key-shares=5 -key-threshold=3</span><br><span class="line">vault operator unseal &lt;run-5-times-against-5-keys-created-by-vault-init-command&gt;</span><br><span class="line">export VAULT_TOKEN=&lt;root-key-created-by-vault-init-command&gt;</span><br><span class="line">export VAULT_TOKEN=s.etL4szXrqoFiud8NnBOyU1rk</span><br><span class="line">VAULT_TOKEN=&lt;root-key-created-by-vault-init-command&gt; vault token create --ttl=100m #give you a token to auth the charm</span><br><span class="line">juju run-action --wait vault/0 authorize-charm token=&lt;charm-token-not-root-token&gt;</span><br><span class="line"></span><br><span class="line">#can run again to re-generate-root-ca if you want when auto-generate-root-ca-cert=true</span><br><span class="line">juju run-action vault/0 disable-pki</span><br><span class="line">juju run-action vault/0 generate-root-ca max-ttl=&apos;2800h&apos; ttl=&apos;87598h&apos; # 3 months; 10 years - https://review.opendev.org/#/c/678161</span><br><span class="line"></span><br><span class="line"># [option]Upload the new certificate from the signed CSR in vault</span><br><span class="line">#NOTE: We may not need this step when using auto-generate-root-ca-cert=true to generate cert, only need to do for company&apos;s CA cert</span><br><span class="line">#how to generate ca and intermediate cert, pls see the appendix or https://www.cnblogs.com/adhzl/p/11577384.html</span><br><span class="line">#To upload the new certificate from the signed CSR in Vault, we also need to provide the whole CA chain.</span><br><span class="line">#The “pem” bundle needs to be a concatenation of : signed csr + intermediate CA + root CA.</span><br><span class="line">#The root-ca bundle needs to include the intermediate CA + root CA. The order is important.</span><br><span class="line">#juju config vault ssl-ca=&quot;$(cat ./intermediate/certs/ca-chain.cert.pem | base64 )&quot; \</span><br><span class="line">#                  ssl-cert=&quot;$(cat ./intermediate/certs/client.quqi.com.cert.pem | base64 )&quot; \</span><br><span class="line">#                  ssl-key=&quot;$(cat ./intermediate/private/client.quqi.com.key.pem | base64 )&quot;</span><br><span class="line">juju run-action --wait vault/0 get-csr</span><br><span class="line">juju run-action vault-ca/leader upload-signed-csr pem=&quot;$(cat ./pem-bundle.pem | base64)&quot; root-ca=&quot;$(cat ./root-bundle.pem | base64 )&quot; allowed-domains=&apos;quqi.com&apos; allowed-subdomains=&apos;client.quqi.com&apos; allow-any-name=true --wait</span><br><span class="line"></span><br><span class="line">#Cert-Manager Role Creation</span><br><span class="line">bash -c &apos;cat &gt; ./policy-local.hcl&apos; &lt;&lt; EOF</span><br><span class="line">path &quot;charm-pki-local/issue/cert-manager&quot; &#123;</span><br><span class="line">  capabilities = [&quot;read&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span><br><span class="line">&#125;</span><br><span class="line">path &quot;charm-pki-local/sign/cert-manager&quot; &#123;</span><br><span class="line">  capabilities = [&quot;read&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ vault policy write cert-manager ./policy-local.hcl</span><br><span class="line">Error opening policy file: open /tmp/policy-local.hcl: no such file or directory</span><br><span class="line">cat policy-local.hcl  |vault policy write cert-manager -</span><br><span class="line">vault policy read cert-manager</span><br><span class="line"></span><br><span class="line">#Create the cert-manager role for Vault and associate the newly created policy with that role</span><br><span class="line">vault write auth/approle/role/cert-manager-role policies=cert-manager</span><br><span class="line"></span><br><span class="line">#Generate a role-id and secret-id.</span><br><span class="line">$ vault read auth/approle/role/cert-manager-role/role-id</span><br><span class="line">Key        Value</span><br><span class="line">---        -----</span><br><span class="line">role_id    e1239e02-056b-f963-a285-baaa42ae8c40</span><br><span class="line">$ vault write -f auth/approle/role/cert-manager-role/secret-id</span><br><span class="line">Key                   Value</span><br><span class="line">---                   -----</span><br><span class="line">secret_id             693e7657-a994-8435-2a80-df83aba23132</span><br><span class="line">secret_id_accessor    820eff6e-e52b-45a8-db59-9d393d3920fe</span><br><span class="line"></span><br><span class="line">#PKI Initialization</span><br><span class="line">#The Vault PKI is initialized automatically by the charm. To give access to cert-manager,</span><br><span class="line">#we need to create a permission for the role created by the policy.</span><br><span class="line">vault write charm-pki-local/roles/cert-manager allowed_domains=quqi.com allow_subdomains=true max_ttl=8760h allow_bare_domains=true allow_any_name=true</span><br><span class="line"></span><br><span class="line">#Install Cert-Manager</span><br><span class="line">kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.14.3/cert-manager.yaml</span><br><span class="line">kubectl get all -n cert-manager</span><br><span class="line"></span><br><span class="line">#configure certmanager</span><br><span class="line">#For k8s to authenticate to the external Vault, the cert-manager secret_id must be created as a k8s secret.</span><br><span class="line">#NOTE: The bolded secretID is the secret_id captured above encoded in base64. To encode in base64</span><br><span class="line">$ echo 693e7657-a994-8435-2a80-df83aba23132 |base64</span><br><span class="line">NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==</span><br><span class="line">bash -c &apos;cat &gt; cert-manager-vault-approle-ca.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">type: Opaque</span><br><span class="line">metadata:</span><br><span class="line">  name: cert-manager-vault-approle-ca</span><br><span class="line">  namespace: cert-manager</span><br><span class="line">data:</span><br><span class="line">  secretId: NjkzZTc2NTctYTk5NC04NDM1LTJhODAtZGY4M2FiYTIzMTMyCg==</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f cert-manager-vault-approle-ca.yaml</span><br><span class="line">kubectl get secrets -n cert-manager cert-manager-vault-approle-ca</span><br><span class="line"></span><br><span class="line">#configure certmanager</span><br><span class="line">#a certificate Issuer must be created within k8s to direct it to the Vault and identify the cert-manager role to match secret.</span><br><span class="line">bash -c &apos;cat &gt; vault-ca-issuer.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: cert-manager.io/v1alpha2</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: vault-issuer</span><br><span class="line">spec:</span><br><span class="line">  vault:</span><br><span class="line">    path: charm-pki-local/sign/cert-manager</span><br><span class="line">    server: http://10.0.0.22:8200</span><br><span class="line">    auth:</span><br><span class="line">      appRole:</span><br><span class="line">        path: approle</span><br><span class="line">        roleId: &quot;e1239e02-056b-f963-a285-baaa42ae8c40&quot;</span><br><span class="line">        secretRef:</span><br><span class="line">          name: cert-manager-vault-approle-ca</span><br><span class="line">          key: secretId</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f vault-ca-issuer.yaml</span><br><span class="line">kubectl get clusterissuer</span><br><span class="line"></span><br><span class="line">#Testing</span><br><span class="line">#NOTE: the ip must be one of the k8s workers ip in this model</span><br><span class="line">$ juju status kubernetes-worker/1 |grep started</span><br><span class="line">5        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE</span><br><span class="line">bash -c &apos;cat &gt; microbot-cert.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: cert-manager.io/v1alpha2</span><br><span class="line">kind: Certificate</span><br><span class="line">metadata:</span><br><span class="line">  name: microbot</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  secretName: microbot-cert-ca</span><br><span class="line">  issuerRef:</span><br><span class="line">    name: vault-ca-issuer</span><br><span class="line">    kind: ClusterIssuer</span><br><span class="line">  commonName: microbot.10.0.0.15.quqi.com</span><br><span class="line">  dnsNames:</span><br><span class="line">  -  microbot.10.0.0.15.quqi.com</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f microbot-cert.yaml</span><br><span class="line">kubectl get certs</span><br><span class="line"></span><br><span class="line">#Workload</span><br><span class="line">bash -c &apos;cat &gt; microbot-test.yaml&apos; &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: microbot</span><br><span class="line">  name: microbot</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: microbot</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: microbot</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: dontrebootme/microbot:v1</span><br><span class="line">        imagePullPolicy: &quot;&quot;</span><br><span class="line">        name: microbot</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /</span><br><span class="line">            port: 80</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccountName: &quot;&quot;</span><br><span class="line">status: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: microbot</span><br><span class="line">  labels:</span><br><span class="line">    app: microbot</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: microbot</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line"> name: microbot</span><br><span class="line"> labels:</span><br><span class="line">   app: microbot</span><br><span class="line">spec:</span><br><span class="line"> tls:</span><br><span class="line">   - hosts:</span><br><span class="line">     - microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model</span><br><span class="line">     secretName: microbot-cert</span><br><span class="line"> rules:</span><br><span class="line">   - host: microbot.10.0.0.15.quqi.com #the ip must be one of the k8s workers ip in this model</span><br><span class="line">     http:</span><br><span class="line">       paths:</span><br><span class="line">         - path: /</span><br><span class="line">           backend:</span><br><span class="line">             serviceName: microbot</span><br><span class="line">             servicePort: 8080</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f microbot-test.yaml</span><br><span class="line">kubectl get all</span><br><span class="line"></span><br><span class="line">#Enable NodePort for svc microbot</span><br><span class="line">$ kubectl get svc |grep microbot</span><br><span class="line">microbot     ClusterIP   10.152.183.135   &lt;none&gt;        8080/TCP   22m</span><br><span class="line">$ kubectl edit svc microbot</span><br><span class="line">service/microbot edited</span><br><span class="line">$ kubectl get svc microbot</span><br><span class="line">NAME       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">microbot   NodePort   10.152.183.135   &lt;none&gt;        8080:32765/TCP   28m</span><br><span class="line"></span><br><span class="line">#Enable security rule for icmp and the port 32765</span><br><span class="line">$ juju status kubernetes-worker/1 |grep started</span><br><span class="line">        started  10.0.0.15  cf5a2466-f034-481d-9541-8f0c5770c30b  bionic  nova  ACTIVE</span><br><span class="line">source ~/novarc</span><br><span class="line">openstack port list |grep 10.0.0.15</span><br><span class="line">openstack port show f3d147e1-2a00-496d-8184-302a825270fd |grep security_group_ids</span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol icmp --remote-ip 0.0.0.0/0</span><br><span class="line">openstack security group rule create 415241ed-6b97-4543-8b62-e1b38610dc7b --protocol tcp --remote-ip 0.0.0.0/0 --dst-port 32765</span><br><span class="line">ping 10.0.0.15</span><br><span class="line"></span><br><span class="line">curl --resolve microbot.10.0.0.15.quqi.com:32765:10.0.0.15 -k http://microbot.10.0.0.15.quqi.com:32765</span><br></pre></td></tr></table></figure>
<h2 id="appendix-create-key"><a href="#appendix-create-key" class="headerlink" title="appendix - create key"></a>appendix - create key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#https://www.dazhuanlan.com/2019/12/15/5df63aed10999</span><br><span class="line">#generate ca key pairs</span><br><span class="line">mkdir -p ca/&#123;private,certs,newcerts&#125; &amp;&amp; cd ca</span><br><span class="line">openssl genrsa -aes256 -passout pass:password -out private/ca.key.pem 4096</span><br><span class="line">chmod 400 private/ca.key.pem</span><br><span class="line">wget https://jamielinux.com/docs/openssl-certificate-authority/_downloads/root-config.txt -O openssl.cnf</span><br><span class="line">sed -i &quot;s,/root/ca,.,g&quot; openssl.cnf</span><br><span class="line">openssl req -config ./openssl.cnf -key private/ca.key.pem -new -x509 -days 7300 -sha256 -extensions v3_ca -passin pass:password \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.rootca/emailAddress=quqi@mail.com&quot; -out certs/ca.cert.pem</span><br><span class="line">chmod 444 certs/ca.cert.pem</span><br><span class="line">openssl x509 -noout -text -in certs/ca.cert.pem #verify</span><br><span class="line"></span><br><span class="line">#generate intermediate key pairs</span><br><span class="line">mkdir -p intermediate/&#123;certs,crl,csr,newcerts,private&#125;</span><br><span class="line">chmod 744 intermediate/private</span><br><span class="line">touch index.txt &amp;&amp; echo 1000 &gt; serial &amp;&amp; echo 1000 &gt; crlnumber</span><br><span class="line">openssl genrsa -aes256 -passout pass:password -out intermediate/private/intermediate.key.pem 4096</span><br><span class="line">chmod 400 intermediate/private/intermediate.key.pem</span><br><span class="line">cp ./openssl.cnf ./openssl-im.cnf</span><br><span class="line">#modify the following section of openssl-im.cnf file</span><br><span class="line">[ CA_default ]</span><br><span class="line">dir             = .</span><br><span class="line">private_key     = $dir/private/intermediate.key.pem</span><br><span class="line">certificate     = $dir/certs/intermediate.cert.pem</span><br><span class="line">crl             = $dir/crl/intermediate.crl.pem</span><br><span class="line">policy          = policy_loose</span><br><span class="line">openssl req -config ./openssl-im.cnf -new -sha256 -passin pass:password \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=quqi.com.imca/emailAddress=quqi@mail.com&quot; \</span><br><span class="line">     -key intermediate/private/intermediate.key.pem -out intermediate/csr/intermediate.csr.pem</span><br><span class="line">openssl ca -config ./openssl.cnf -extensions v3_intermediate_ca -days 3650 -notext -md sha256 -passin pass:password \</span><br><span class="line">     -in intermediate/csr/intermediate.csr.pem -out intermediate/certs/intermediate.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/intermediate.cert.pem</span><br><span class="line">openssl x509 -noout -text -in intermediate/certs/intermediate.cert.pem</span><br><span class="line">openssl verify -CAfile certs/ca.cert.pem intermediate/certs/intermediate.cert.pem</span><br><span class="line"></span><br><span class="line">#generate certificate chain</span><br><span class="line">cat intermediate/certs/intermediate.cert.pem certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/ca-chain.cert.pem</span><br><span class="line"></span><br><span class="line">#generate clinet.quqi.com key pairs</span><br><span class="line">openssl genrsa -out intermediate/private/client.quqi.com.key.pem 2048</span><br><span class="line">chmod 444 intermediate/private/client.quqi.com.key.pem</span><br><span class="line">openssl req -config ./openssl-im.cnf -key intermediate/private/client.quqi.com.key.pem \</span><br><span class="line">     -subj &quot;/C=CN/ST=BJ/O=STS/OU=quqi.com/CN=client.quqi.com/emailAddress=quqi@mail.com&quot; \</span><br><span class="line">     -new -sha256 -out intermediate/csr/client.quqi.com.csr.pem</span><br><span class="line">openssl ca -config ./openssl.cnf -extensions server_cert -days 3650 -notext -md sha256 -passin pass:password\</span><br><span class="line">     -in intermediate/csr/client.quqi.com.csr.pem -out intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">chmod 444 intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">openssl x509 -noout -text -in intermediate/certs/client.quqi.com.cert.pem</span><br><span class="line">openssl verify -CAfile intermediate/certs/ca-chain.cert.pem intermediate/certs/client.quqi.com.cert.pem</span><br></pre></td></tr></table></figure>
<h2 id="20201023-another-vault-problem"><a href="#20201023-another-vault-problem" class="headerlink" title="20201023 - another vault problem"></a>20201023 - another vault problem</h2><p>vault只能为intermediate ca产生csr，然后这个csr需要用ca签名．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">https://bugs.launchpad.net/vault-charm/+bug/1885576</span><br><span class="line">https://review.opendev.org/#/c/755276/</span><br><span class="line">https://launchpadlibrarian.net/500735722/lp1885576_reproducer</span><br><span class="line">./generate-bundle.sh -s bionic -r stein -n vault --dvr-snat --vault --run</span><br><span class="line">juju config vault auto-generate-root-ca-cert=false</span><br><span class="line">#juju ssh nova-compute/0 -- sudo apt --fix-broken install &amp;&amp; juju resolved nova-compute/0</span><br><span class="line">./tools/vault-unseal-and-authorise.sh</span><br><span class="line"></span><br><span class="line"># Generate CA and intermediate CA</span><br><span class="line">#DOMAIN=$(juju ssh keystone/0 -- hostname -f |sed s/[[:space:]]//g) &amp;&amp; echo $DOMAIN</span><br><span class="line">#openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out ca.crt -keyout ca.key -subj &quot;/C=US/ST=UK/L=London/O=Ubuntu/OU=IT/CN=CA&quot;</span><br><span class="line">#openssl genrsa -out $DOMAIN.key</span><br><span class="line">#openssl req -new -key $DOMAIN.key -out $DOMAIN.csr -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=$DOMAIN&quot;</span><br><span class="line">#openssl x509 -req -in $DOMAIN.csr -out $DOMAIN.crt -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -days 3650</span><br><span class="line">#openssl x509 -noout -text -in $DOMAIN.crt |grep CN</span><br><span class="line">#cat $DOMAIN.crt $DOMAIN.key &gt; $DOMAIN.pem</span><br><span class="line"></span><br><span class="line">dout=`mktemp -d`</span><br><span class="line">(</span><br><span class="line">cd $dout &amp;&amp; echo $dout</span><br><span class="line">mkdir -p demoCA/newcerts &amp;&amp; touch demoCA/index.txt &amp;&amp; touch demoCA/index.txt.attr</span><br><span class="line">openssl genrsa -passout pass:password -des3 -out ca.key 2048</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 365 -out ca.crt \</span><br><span class="line">    -subj &quot;/C=GB/ST=UK/L=London/O=Ubuntu/OU=Cloud/CN=quqi.com&quot;</span><br><span class="line">juju run-action --wait vault/leader get-csr \</span><br><span class="line">    country=GB \</span><br><span class="line">    province=UK \</span><br><span class="line">    organization=Ubuntu \</span><br><span class="line">    common-name=quqi.com \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .results | .output&apos; \</span><br><span class="line">  | tee csr.pem</span><br><span class="line">openssl ca -passin pass:password -cert $dout/ca.crt -keyfile $dout/ca.key \</span><br><span class="line">    -create_serial -batch -policy policy_anything -extensions v3_ca \</span><br><span class="line">    -in csr.pem -days 60 -out $dout/intermediate_ca.crt</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># Upload the CSR and it fails since it is signed for 60 days where as</span><br><span class="line"># the default-ttl used to generate certs using this certificate is 1 year</span><br><span class="line">juju run-action --wait vault/leader upload-signed-csr \</span><br><span class="line">    pem=&quot;$(base64 $dout/intermediate_ca.crt)&quot; root-ca=&quot;$(base64 $dout/ca.crt)&quot; \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .status&apos;</span><br><span class="line"></span><br><span class="line"># Change the default-ttl for less than 60 days,</span><br><span class="line">juju config vault default-ttl=1100h</span><br><span class="line"></span><br><span class="line">#  but it has no effect on the unit since the unit is in failed state.</span><br><span class="line"># so it needs this patch - https://review.opendev.org/#/c/755276/</span><br><span class="line">git clone https://github.com/openstack/charm-vault.git</span><br><span class="line">cd charm-vault/</span><br><span class="line">git fetch https://review.opendev.org/openstack/charm-vault refs/changes/76/755276/1 &amp;&amp; git checkout FETCH_HEAD</span><br><span class="line">cd src &amp;&amp; charm build   #need this step for reactive charm</span><br><span class="line">juju upgrade-charm vault --path /tmp/charm-builds/vault --force-units #use --force-units even in an error state</span><br><span class="line">juju run --unit vault/0 -- &apos;charms.reactive -p get_flags&apos;</span><br><span class="line">juju resolved vault/0  #trigger the state to &apos;active&apos;</span><br><span class="line">juju config vault default-ttl=1109h  #run again</span><br><span class="line"></span><br><span class="line"># Upload the CSR and expects the action to be successful since the default-ttl</span><br><span class="line"># is less than 60 days and required certs will be generated with ttl default-ttl value</span><br><span class="line">juju run-action --wait vault/leader upload-signed-csr \</span><br><span class="line">    pem=&quot;$(base64 $dout/intermediate_ca.crt)&quot; root-ca=&quot;$(base64 $dout/ca.crt)&quot; \</span><br><span class="line">    --format json \</span><br><span class="line">  | jq -r &apos;.[] | .status&apos;</span><br><span class="line"></span><br><span class="line">#another workaround, run in vault/0</span><br><span class="line">export VAULT_TOKEN=&lt;root_token&gt;</span><br><span class="line">export VAULT_ADDR=http://10.224.211.37:8200</span><br><span class="line">vault secrets tune -default-lease-ttl=2871h charm-pki-local/</span><br></pre></td></tr></table></figure></p>
<h2 id="20201114-如何从vault中读取证书"><a href="#20201114-如何从vault中读取证书" class="headerlink" title="20201114 如何从vault中读取证书"></a>20201114 如何从vault中读取证书</h2><p>vault read <path></path>应该可以用来读取证书，但不清楚如何获取path值啊，研究了半天未果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export VAULT_TOKEN=s.N80f2BMRgk9BWkEyaMfMNtNX</span><br><span class="line">vault secrets list -detailed</span><br><span class="line">vault auth list</span><br><span class="line"># vault pki engine - https://www.vaultproject.io/docs/secrets/pki</span><br><span class="line"># vault study - http://just4coding.com/2020/03/13/vault-introduction/</span><br><span class="line">vault read &lt;path&gt;</span><br></pre></td></tr></table></figure></p>
<p>但可以从juju方面获取它。例如nova-cloud-controller与vault的关系如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># charm-nova-cloud-controller/blob/master/charmhelpers/contrib/openstack/cert_utils.py#install_certs is used to install cert/key</span><br><span class="line">vim vault/src/reactive/vault_handlers.py#publish_global_client_cert</span><br><span class="line">def publish_global_client_cert():</span><br><span class="line">      ...</span><br><span class="line">      bundle = vault_pki.generate_certificate(&apos;client&apos;, &apos;global-client&apos;, [], ttl, max_ttl)</span><br><span class="line">      unitdata.kv().set(&apos;charm.vault.global-client-cert&apos;, bundle)</span><br><span class="line">      ...</span><br><span class="line">      tls.set_client_cert(bundle[&apos;certificate&apos;], bundle[&apos;private_key&apos;])</span><br></pre></td></tr></table></figure></p>
<p>所以应该有以下两种方法获取证书:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ juju run --unit nova-cloud-controller/0 &quot;relation-list -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;)&quot;</span><br><span class="line">vault/0</span><br><span class="line">juju run --unit nova-cloud-controller/0 &quot;relation-get -r $(juju run --unit nova-cloud-controller/0 &quot;relation-ids certificates&quot;) - vault/0&quot; |grep -E &apos;cert|key|ca&apos;</span><br><span class="line"></span><br><span class="line">juju run --unit vault/0 -- charm-env python3.6 -c &quot;import charms.leadership; from charmhelpers.core import host, hookenv, unitdata; print(unitdata.kv().get(&apos;charm.vault.global-client-cert&apos;));&quot;</span><br></pre></td></tr></table></figure></p>
<p>但似乎并没有获取它的必要，例如，如果证书采用文件系统存储的话，可以下列方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s bionic -r ussuri --create-model --name sslwithssl:stsstack --num-compute 1 --openstack-dashboard --nova-console --ssl</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=xxx/ssl/openstack-ssl-ussuri/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=spice</span><br><span class="line">juju config nova-cloud-controller console-ssl-cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config nova-cloud-controller console-ssl-key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>但如果采用vault来存储的话，只通过关系即可　（未测试）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s bionic -r ussuri --create-model --name sslwithssl:stsstack --num-compute 1 --openstack-dashboard --nova-console --vault</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">juju add-relation openstack-dashboard:certificates vault:certificates</span><br><span class="line">juju add-relation nova-cloud-controller:certificates vault:certificates</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/19/为什么dnsmasq服务总是重启/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/19/为什么dnsmasq服务总是重启/" itemprop="url">为什么dnsmasq服务总是重启</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-19T15:48:08+08:00">
                2020-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-05-19<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>最近, 是有点感觉到家里的网络有时有点慢, 特别有时候看网页时显示dns找不到,但马上在半秒之内又自动找着了成功显示页面. 能用也不算特别慢所以一直就没太注意这个事.<br>依平时的经验, 这种慢一般和dns有关, 所以今早就特地登录到路由器查看dnsmasq的状态. 检查了一遍配置啥的也没见异常, 但无意间发现dnsmasq的进程ID有时在变(不是很经常, 不容易观察出来).</p>
<h2 id="dnsmasq-exiting-on-receipt-of-SIGTERM"><a href="#dnsmasq-exiting-on-receipt-of-SIGTERM" class="headerlink" title="dnsmasq: exiting on receipt of SIGTERM"></a>dnsmasq: exiting on receipt of SIGTERM</h2><p>然后就想着将 dnmasq进程停掉, 然后以debug模式(-d)启动看看日志, 但是当运行了/etc/init.d/dnsma stop之后怎么也停不掉啊, 一会儿进程又自动启动了. 读代码发现openwrt的init脚本使用了procd, 但将所有procd相关的行全注释掉之后, 停掉了但还是马上就自动启动了.<br>然后发现是/etc/rc.common在自动启动, 接着就在反复测试过程中形成了下列的代码.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# cat /etc/init.d/dnsmasq</span><br><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=80</span><br><span class="line">start() &#123;</span><br><span class="line">      #/usr/sbin/dnsmasq --conf-dir=/tmp/dnsmasq.d --conf-file=/etc/dnsmasq.conf --user=dnsmasq --group=dnsmasq --server=114.114.114.114 -k &amp;</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line">stop() &#123;</span><br><span class="line">   killall dnsmasq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这时在前台以’/usr/sbin/dnsmasq –conf-dir=/tmp/dnsmasq.d –conf-file=/etc/dnsmasq.conf –user=dnsmasq –group=dnsmasq –server=114.114.114.114 -d’调试时发现dnsmasq进程自已会退出, 报这个错”dnsmasq: exiting on receipt of SIGTERM”<br>这时以为是dnsmasq程序有问题, 正在绝望之刻, 注意到了原因dnsmasq是被上面的stop杀死的. 通过/etc/init.d/dnsmasq stop根本停不住dnsmasq, 所以上面的stop函数中的killall dnsmasq在后台被定期运行, 这样就杀死了前台的debug dnsmasq进程.</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>搞清楚’dnsmasq: exiting on receipt of SIGTERM’发生的原因之后, 将脚本暂时改成下列丑陋的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">COLUMNS=999 ps -ef |grep dns</span><br><span class="line">oot@OpenWrt:~# cat /etc/init.d/dnsmasq</span><br><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=80</span><br><span class="line">SERVICE_USE_PID=1</span><br><span class="line">SERVICE_WRITE_PID=1</span><br><span class="line">SERVICE_DAEMONIZE=1</span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line"># Only use &apos;if pidof dnsmasq &gt;/dev/null&apos; will see more and more processes when upstream network is down so change to use awk&apos; NF</span><br><span class="line"># and in some system it gives me 0 when binary not running and in some systems it gives me NULL(nothing)</span><br><span class="line">if [ -z `pidof dnsmasq` ];then</span><br><span class="line">    ulimit -c unlimited</span><br><span class="line">    echo &quot;dnsmasq stopped, start it now ...&quot;</span><br><span class="line">    mkdir -p /var/lib/misc</span><br><span class="line">    service_start /usr/sbin/dnsmasq --conf-dir=/tmp/dnsmasq.ssr --conf-file=/etc/dnsmasq.conf --user=dnsmasq --group=dnsmasq \</span><br><span class="line">      --server=221.130.33.60 --listen-address=192.168.99.1,127.0.0.1 --dhcp-range=192.168.99.100,192.168.99.199,3650d \</span><br><span class="line">      --dhcp-option=3,192.168.99.1 --dhcp-option=option:dns-server,192.168.99.1 --cache-size=0</span><br><span class="line">elif [ $(pidof dnsmasq |awk &apos;&#123;print NF&#125;&apos;) -eq 1 ];then</span><br><span class="line">    echo &quot;dnsmasq is running&quot;</span><br><span class="line">else</span><br><span class="line">    echo &apos;upstream network is down&apos;</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">   #echo &apos;NOTE: we must not use &apos;killall dnsmasq&apos; to stop dnsmasq here because stop function always be called by rc.common periodically&apos;</span><br><span class="line">   #killall dnsmasq &gt;/dev/null</span><br><span class="line">   #service_stop /usr/sbin/dnsmasq</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#don&apos;t custom restart so that it can be always invoked automatically to run start()</span><br><span class="line">#restart() &#123;</span><br><span class="line">   #workaround to avoid killall dnamasq in stop() because do not know why restart is always invoked automatically</span><br><span class="line">   #echo &apos;hint: both stop and restart not work for dnsmasq service&apos;</span><br><span class="line">   #exit 0</span><br><span class="line">   #start</span><br><span class="line">   #sleep 1</span><br><span class="line">   #return</span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="server-can’t-find-xxx-my-salesforce-com-REFUSED"><a href="#server-can’t-find-xxx-my-salesforce-com-REFUSED" class="headerlink" title="server can’t find xxx.my.salesforce.com: REFUSED"></a>server can’t find xxx.my.salesforce.com: REFUSED</h2><p>另外, 解释白名单的dns没问题, 解析黑名单的dns也没问题, 但解析不在名单之内的dns时报’server can’t find xxx.my.salesforce.com: REFUSED’之类的错误时, 那是因为dnsmasq命令中没有添加–server=114.114.114.114</p>
<h2 id="cache-size-0"><a href="#cache-size-0" class="headerlink" title="cache-size=0"></a>cache-size=0</h2><p>–cache-size=0避免使用使用dnsmasq的缓存</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">85</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
