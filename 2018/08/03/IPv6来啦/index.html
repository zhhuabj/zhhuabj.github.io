<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="基础 - ND协议的三个位ND协议包中有三个位(Auto, Managed, Other)：  M bit (Managed Address Configuration), M bit如果是1,表示Clients要另外再去跟DHCPv6要IPv6 Prefix O bit (Other Configuration), O bit如果是1,表示Clients要去跟DHCPv6要DNS(RDNSS)等">
<meta property="og:type" content="article">
<meta property="og:title" content="IPv6来啦">
<meta property="og:url" content="http://yoursite.com/2018/08/03/IPv6来啦/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="基础 - ND协议的三个位ND协议包中有三个位(Auto, Managed, Other)：  M bit (Managed Address Configuration), M bit如果是1,表示Clients要另外再去跟DHCPv6要IPv6 Prefix O bit (Other Configuration), O bit如果是1,表示Clients要去跟DHCPv6要DNS(RDNSS)等">
<meta property="og:updated_time" content="2019-01-25T09:50:53.610Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IPv6来啦">
<meta name="twitter:description" content="基础 - ND协议的三个位ND协议包中有三个位(Auto, Managed, Other)：  M bit (Managed Address Configuration), M bit如果是1,表示Clients要另外再去跟DHCPv6要IPv6 Prefix O bit (Other Configuration), O bit如果是1,表示Clients要去跟DHCPv6要DNS(RDNSS)等">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/03/IPv6来啦/"/>





  <title>IPv6来啦 | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/03/IPv6来啦/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">IPv6来啦</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-03T16:01:05+08:00">
                2018-08-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="基础-ND协议的三个位"><a href="#基础-ND协议的三个位" class="headerlink" title="基础 - ND协议的三个位"></a>基础 - ND协议的三个位</h2><p>ND协议包中有三个位(Auto, Managed, Other)：</p>
<ul>
<li>M bit (Managed Address Configuration), M bit如果是1,表示Clients要另外再去跟DHCPv6要IPv6 Prefix</li>
<li>O bit (Other Configuration), O bit如果是1,表示Clients要去跟DHCPv6要DNS(RDNSS)等其他信息<br>这样：</li>
<li>slaas, Stateless autoconfiguration, A=1, M=0, O=0, 主机將只得到Router給的 Prefix, 无法取得DNS等资讯, 其他必须自己填写.</li>
<li>dhcpv6-stateful, A=0, M=1, O=1, 所有信息（IPv6 prefix, DNS等)都通过DHCPv6获得,客戶端主要使用UDP port 546, 而服務器端使用 UDP port 547</li>
<li>dhcpv6-stateless,A=1, M=0, O=1, 除了使用RA裡面的Prefix,其他如DNS等等信息会由DHCPv6 取得.<h2 id="基础-Neutron-IPv6"><a href="#基础-Neutron-IPv6" class="headerlink" title="基础 - Neutron IPv6"></a>基础 - Neutron IPv6</h2>Neutron中有两个重要属性来支持IPv6 (ipv6_address_mode 与 ipv6_ra_mode):</li>
<li>ipv6_ra_mode, 如果设置表示由Neutron来使用radvd来模拟软件IPv6路由器, 如果不设置表示使用外部IPv6路由器</li>
<li>ipv6_address_mode, 对应上述ND协议中的三个位(Auto, Managed, Other), 例如: 对于dhcpv6-stateless, 3比特应该是: A=1, M=0, O=1.</li>
</ul>
<p>下面是创建一个使用外部IPv6路由器并使用dhcpv6-stateless的例子:<br>neutron net-create –provider:network_type flat –provider:physical_network physnet1 –router:external=True ext_net<br>neutron subnet-create ext_net –name external-subnet-v6 –ip_version 6 –ipv6_address_mode dhcpv6-stateless –allocation-pool start=2001:db8:0:1::2,end=2001:db8:0:1:ffff:ffff:ffff:ffff 2001:db8:0:1::/64</p>
<h2 id="基础-Ubuntu中手工配置IPv6的注意点"><a href="#基础-Ubuntu中手工配置IPv6的注意点" class="headerlink" title="基础 - Ubuntu中手工配置IPv6的注意点"></a>基础 - Ubuntu中手工配置IPv6的注意点</h2><p>Ubuntu中配置IPv6可以采用network-manager, 也可采用在/etc/network/interface中手工配置, 也可以使用最新的netplan. 这里描述的是采用手工配置的方法.<br>先看一个遇到的实际问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">下面配置不work</span><br><span class="line">iface eth0 inet6 auto</span><br><span class="line">   # use SLAAC to get global IPv6 address from the router</span><br><span class="line">   # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">   up sleep 5</span><br><span class="line">   dhcp 1</span><br><span class="line">   autoconf 1</span><br><span class="line">   accept_ra 2</span><br><span class="line"></span><br><span class="line">下列配置work</span><br><span class="line">iface eth0 inet6 static</span><br><span class="line">address 2001:192:168:99::135</span><br><span class="line">   gateway 2001:192:168:99::1</span><br><span class="line">   netmask 64</span><br><span class="line">且改成network-manager也work, 这是为什么呢?</span><br><span class="line"></span><br><span class="line">测试方法是:</span><br><span class="line">#it will flush link-local address as well</span><br><span class="line">#ip addr flush br-eth0</span><br><span class="line"># avoid the error: can&apos;t get a link-local address</span><br><span class="line">sudo ip link set dev eth0 down</span><br><span class="line">sudo ip link set dev eth0 up</span><br><span class="line">ifdown br-eth0</span><br><span class="line">ifup --force --verbose br-eth0</span><br></pre></td></tr></table></figure></p>
<p>采用”ifup –force –verbose br-eth0”命令看到的错误是”can’t get a link-local address”.<br>为什么static模式与network-manager模式没有这个错误呢? 原来是这两者默认执行了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br></pre></td></tr></table></figure></p>
<p>并且之前Linux网桥br-eth0上一直没有IPv6地址的原因也是这个, 且上面”sudo ip link set dev eth0 up”这句也会自动设置disable_ipv6=0, 但不会对br-eth0作同样的设置.<br>所以添加”up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6”后问题解决, 完整配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@node1:~# cat /etc/network/interfaces</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">auto br-eth0</span><br><span class="line">iface br-eth0 inet static</span><br><span class="line">    address 192.168.99.124/24</span><br><span class="line">    gateway 192.168.99.1</span><br><span class="line">    bridge_ports eth0</span><br><span class="line">    dns-nameservers 192.168.99.1</span><br><span class="line">    bridge_stp on</span><br><span class="line">    bridge_fd 0</span><br><span class="line">    bridge_maxwait 0</span><br><span class="line">    up echo -n 0 &gt; /sys/devices/virtual/net/$IFACE/bridge/multicast_snooping</span><br><span class="line"># for stateless it&apos;s &apos;inet6 auto&apos;, for stateful it&apos;s &apos;inet6 dhcp&apos;</span><br><span class="line">iface br-eth0 inet6 auto</span><br><span class="line">    #iface eth0 inet6 static</span><br><span class="line">    #address 2001:192:168:99::135</span><br><span class="line">    #gateway 2001:192:168:99::1</span><br><span class="line">    #netmask 64</span><br><span class="line">    # use SLAAC to get global IPv6 address from the router</span><br><span class="line">    # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">    # sleep 5 is due a bug and &apos;dhcp 1&apos; indicates that info should be obtained from dhcpv6 server for stateless</span><br><span class="line">    up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br><span class="line">    up sleep 5</span><br><span class="line">    autoconf 1</span><br><span class="line">    accept_ra 2</span><br><span class="line">    dhcp 1</span><br></pre></td></tr></table></figure></p>
<p>此外, 最好设置accept_ra=2, 因为经常会遇到自动配置的IPv6地址丢失或者不能获取的问题。一般情况是都是启用了IPv6转发功能(sudo sysctl -w net.ipv6.conf.all.forwarding=1)引起的。<br>为了配置IPv6 address和default gateway, client/host都会默认去listen或者solicit RA广播, 并且host作为router时会忽略RA, 这由accept_ra设置:</p>
<ul>
<li>0 Do not accept RouterAdvertisements.</li>
<li>1 Accept Router Advertisements if forwarding is disabled.</li>
<li>2 Overrule forwarding behavior. Accept Router Advertisements  even if forwarding is enabled.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv6.conf.all.forwarding=1</span><br><span class="line">sudo sysctl -w net.ipv6.conf.all.accept_ra=2</span><br><span class="line">sudo sysctl -w net.ipv6.conf.br-lan.disable_ipv6=0</span><br><span class="line">#echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="IPv6中的防火墙"><a href="#IPv6中的防火墙" class="headerlink" title="IPv6中的防火墙"></a>IPv6中的防火墙</h2><p>IPv6 Router端:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># Clear all ip6tables rules</span><br><span class="line">ip6tables -t nat -X</span><br><span class="line">ip6tables -t nat -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t nat -P POSTROUTING ACCEPT</span><br><span class="line">ip6tables -t nat -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -F</span><br><span class="line">ip6tables -t mangle -X</span><br><span class="line">ip6tables -t mangle -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t mangle -P INPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -P FORWARD ACCEPT</span><br><span class="line">ip6tables -t mangle -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -P POSTROUTING ACCEPT</span><br><span class="line">ip6tables -F</span><br><span class="line">ip6tables -X</span><br><span class="line">ip6tables -P FORWARD ACCEPT</span><br><span class="line">ip6tables -P INPUT ACCEPT</span><br><span class="line">ip6tables -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t raw -F</span><br><span class="line">ip6tables -t raw -X</span><br><span class="line">ip6tables -t raw -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t raw -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"># Default DROP rules</span><br><span class="line">ip6tables -P INPUT   DROP</span><br><span class="line">ip6tables -P OUTPUT  ACCEPT</span><br><span class="line">ip6tables -P FORWARD DROP</span><br><span class="line"></span><br><span class="line"># Allow established connections</span><br><span class="line">ip6tables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">ip6tables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"># For IPv6</span><br><span class="line"># it&apos;s not required due to ipv6-icmp</span><br><span class="line"># sudo ip6tables -A INPUT -p udp --dport 547 -j ACCEPT</span><br><span class="line">#ip6tables -A INPUT -p icmpv6 --icmpv6-type echo-request -j ACCEPT</span><br><span class="line">ip6tables -A INPUT -p ipv6-icmp -j ACCEPT</span><br><span class="line">ip6tables -A FORWARD -p ipv6-icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Ajust MTU</span><br><span class="line">ip6tables -t mangle -A POSTROUTING -o pppoe-wan -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</span><br></pre></td></tr></table></figure></p>
<p>IPv6 Client端:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip6tables -t filter -A INPUT -p udp -m udp --sport 547 --dport 546 -j ACCEPT</span><br><span class="line">ip6tables -t filter -A INPUT -p ipv6-icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line"># or security group</span><br><span class="line">https://bugs.launchpad.net/neutron/+bug/1335984</span><br><span class="line">openstack security group rule create $secgroup --protocol udp --dst-port 546 --ethertype IPv6</span><br><span class="line">openstack security group rule create $secgroup --protocol icmpv6 --ethertype IPv6</span><br><span class="line"></span><br><span class="line"># Flow based firewall</span><br><span class="line">hard_timeout=0,idle_timeout=0,priority=4,udp,tp_dst=546/0xffff,table=32,tp_src=547/0xffff,nw_src=fe80::f816:3eff:fea3:ec40,actions=learn(table=33,priority=5,hard_timeout=120,eth_type=0x800,nw_proto=17,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],NXM_OF_IP_SRC[]=NXM_OF_IP_DST[],NXM_OF_UDP_SRC[]=NXM_OF_UDP_DST[], NXM_OF_UDP_DST[]=NXM_OF_UDP_SRC[],output:NXM_OF_IN_PORT[]),normal</span><br></pre></td></tr></table></figure></p>
<p>另外, 别忘了禁用掉ufw或者SELinux之类的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br></pre></td></tr></table></figure></p>
<h2 id="Statefull-DHCPv6"><a href="#Statefull-DHCPv6" class="headerlink" title="Statefull DHCPv6"></a>Statefull DHCPv6</h2><p>采用isc-dhcp-server搭建DHCPv6 Server:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/</span><br><span class="line">hua@t440p:~$ ip addr show eth0 |grep inet6 |grep global</span><br><span class="line">    inet6 2001:192:168:99::430/128 scope global</span><br><span class="line">echo &apos;Acquire::ForceIPv4 &quot;true&quot;;&apos; | sudo tee /etc/apt/apt.conf.d/99force-ipv4</span><br><span class="line">sudo apt install isc-dhcp-server</span><br><span class="line">grep -v ^# /etc/dhcp/dhcpd6.conf</span><br><span class="line">sudo cp /etc/dhcp/dhcpd6.conf /etc/dhcp/dhcpd6.conf_bak</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">authoritative;</span><br><span class="line">default-lease-time 14400;</span><br><span class="line">max-lease-time 86400;</span><br><span class="line">log-facility local7;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">    option dhcp6.name-servers 2001:4860:4860::8888, 2001:4860:4860::8844;</span><br><span class="line">    option dhcp6.domain-search &quot;quqi.com&quot;;</span><br><span class="line">    range6 2001:192:168:99::100 2001:192:168:99::199;</span><br><span class="line">    range6 2001:192:168:99::/64 temporary;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo touch /var/lib/dhcp/dhcpd6.leases</span><br><span class="line">sudo /usr/sbin/dhcpd -6 -d -cf /etc/dhcp/dhcpd6.conf eth0</span><br><span class="line">sudo chown dhcpd:dhcpd /var/lib/dhcp/dhcpd6.leases</span><br><span class="line">sudo service isc-dhcp-server6 restart</span><br></pre></td></tr></table></figure></p>
<p>然后记得照上节说的设置DHCPv6 Server与Client上的防火墙规则. 接着在另一台机器上作client测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># need to use &apos;inet6 dhcp&apos; in client side for statefull DHCPv6</span><br><span class="line">iface br-eth0 inet6 dhcp</span><br><span class="line">    #iface eth0 inet6 static</span><br><span class="line">    #address 2001:192:168:99::135</span><br><span class="line">    #gateway 2001:192:168:99::1</span><br><span class="line">    #netmask 64</span><br><span class="line">    # use SLAAC to get global IPv6 address from the router</span><br><span class="line">    # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">    # sleep 5 is due a bug and &apos;dhcp 1&apos; indicates that info should be obtained from dhcpv6 server for stateless</span><br><span class="line">    up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br><span class="line">    up sleep 5</span><br><span class="line">    autoconf 1</span><br><span class="line">    accept_ra 2</span><br><span class="line">    dhcp 1</span><br><span class="line"></span><br><span class="line"># test command</span><br><span class="line">dhclient -6 -d br-eth0</span><br><span class="line"></span><br><span class="line"># verity</span><br><span class="line">hua@node1:~$ sudo tcpdump -ni eth0 ip6 host fe80::d5a3:10a3:6161:5b2e</span><br><span class="line">12:44:00.868609 IP6 fe80::d5a3:10a3:6161:5b2e.547 &gt; fe80::fa32:e4ff:febe:87cd.546: dhcp6 advertise</span><br><span class="line">12:44:01.946548 IP6 fe80::d5a3:10a3:6161:5b2e.547 &gt; fe80::fa32:e4ff:febe:87cd.546: dhcp6 reply</span><br><span class="line">root@node1:~# cat /etc/resolv.conf</span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 211.136.17.107</span><br><span class="line">#nameserver 114.114.114.114</span><br><span class="line">#nameserver 223.5.5.5</span><br><span class="line">nameserver 2001:4860:4860::8888</span><br><span class="line">nameserver 2001:4860:4860::8844</span><br><span class="line">nameserver 2001:db8::1:6a1:51ff:fe8a:2ca7</span><br><span class="line">search quqi.com lan</span><br></pre></td></tr></table></figure>
<p>另外, 使用BIND9的例子可参见 - <a href="https://jochen.kirstaetter.name/enabling-dns-for-ipv6-infrastructure/" target="_blank" rel="external">https://jochen.kirstaetter.name/enabling-dns-for-ipv6-infrastructure/</a></p>
<h2 id="SLAAC-Stateless-Address-Auto-Configuration"><a href="#SLAAC-Stateless-Address-Auto-Configuration" class="headerlink" title="SLAAC (Stateless Address Auto Configuration)"></a>SLAAC (Stateless Address Auto Configuration)</h2><p>radvd来提供RA部分, SLAAC只有RA部分. RA只能设置IPv6 prefix与DNS (RDNSS).<br>Historically the software package radvd was commonly used for just the RA-part of this. But dnsmasq offers a more complete setup.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv6.conf.all.forwarding=1</span><br><span class="line">sudo ip addr add 2001:db8:0:1::1/64 dev eth0</span><br><span class="line">sudo apt-get install radvd</span><br><span class="line">$ cat /etc/radvd.conf</span><br><span class="line">    interface eth0</span><br><span class="line">    &#123;</span><br><span class="line">       AdvSendAdvert on;</span><br><span class="line">       prefix 2001:db8:0:1::/64</span><br><span class="line">       &#123;</span><br><span class="line">            AdvOnLink on;</span><br><span class="line">            AdvAutonomous on;</span><br><span class="line">       &#125;;</span><br><span class="line">       #Send DNS Server setting</span><br><span class="line">       #RDNSS fd5d:12c9:2201:1::2&#123;</span><br><span class="line">    &#125;;</span><br><span class="line">sudo /etc/init.d/radvd restart</span><br><span class="line">sudo ip6tables -F</span><br><span class="line"></span><br><span class="line">neutron subnet-create --ip-version=6 --name=ext-v6-subnet --gateway 2001:db8:0:1::1 --allocation-pool start=2001:db8:0:1::5,end=2001:db8:0:1:ffff:ffff:ffff:fffe --disable-dhcp ext_net 2001:db8:0:1::/64</span><br><span class="line">neutron net-create private</span><br><span class="line">neutron subnet-create --ip-version=6 --name=private_v6_subnet --ipv6-address-mode=slaac --ipv6-ra-mode=slaac private 2001:db8:0:2::/64</span><br><span class="line">neutron router-interface-add provider-router private_v6_subnet</span><br></pre></td></tr></table></figure></p>
<h2 id="SLAAS-with-Stateless-DHCPv6"><a href="#SLAAS-with-Stateless-DHCPv6" class="headerlink" title="SLAAS with Stateless DHCPv6"></a>SLAAS with Stateless DHCPv6</h2><p>Stateless意味着:</p>
<ul>
<li>radvd提供RA (AdvManagedFlag=off)</li>
<li>client使用radvd RA提供的IPv6 prefix配置IPv6 address</li>
<li>client的其他信息如DNS等从DHCPv6获得<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; /etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">interface eth0</span><br><span class="line">&#123;</span><br><span class="line">    AdvSendAdvert on;</span><br><span class="line">    MinRtrAdvInterval 30;</span><br><span class="line">    MaxRtrAdvInterval 100;</span><br><span class="line">    AdvManagedFlag off;</span><br><span class="line">    AdvOtherConfigFlag on;</span><br><span class="line">    prefix 2001:192:168:99::/64</span><br><span class="line">    &#123;</span><br><span class="line">        AdvOnLink on;</span><br><span class="line">        AdvAutonomous on;</span><br><span class="line">        AdvRouterAddr off;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/radvd.conf&apos; &lt;&lt;EOF</span><br><span class="line">default-lease-time 600;</span><br><span class="line">max-lease-time 7200;</span><br><span class="line">log-facility local7;</span><br><span class="line">option dhcp6.name-servers 2001:4860:4860::8888;</span><br><span class="line">option dhcp6.domain-search &quot;&quot;;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="SLAAS-with-Statefull-DHCPv6"><a href="#SLAAS-with-Statefull-DHCPv6" class="headerlink" title="SLAAS with Statefull DHCPv6"></a>SLAAS with Statefull DHCPv6</h2><p>Statefull意味着:</p>
<ul>
<li>radvd不提供RA (AdvManagedFlag=on)</li>
<li>client使用DHCPv6去配置IPv6 address</li>
<li>client的其他信息如DNS等也从DHCPv6获得<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; /etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">interface eth0</span><br><span class="line">&#123;</span><br><span class="line">    AdvSendAdvert on;</span><br><span class="line">    MinRtrAdvInterval 30;</span><br><span class="line">    MaxRtrAdvInterval 100;</span><br><span class="line">    AdvManagedFlag on;</span><br><span class="line">    AdvOtherConfigFlag on;</span><br><span class="line">    prefix 2001:192:168:99::/64</span><br><span class="line">    &#123;</span><br><span class="line">        AdvOnLink on;</span><br><span class="line">        AdvAutonomous on;</span><br><span class="line">        AdvRouterAddr off;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">authoritative;</span><br><span class="line">default-lease-time 14400;</span><br><span class="line">max-lease-time 86400;</span><br><span class="line">log-facility local7;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">    option dhcp6.name-servers 2001:4860:4860::8888, 2001:4860:4860::8844;</span><br><span class="line">    option dhcp6.domain-search &quot;quqi.com&quot;;</span><br><span class="line">    range6 2001:192:168:99::100 2001:192:168:99::199;</span><br><span class="line">    range6 2001:192:168:99::/64 temporary;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="bastion上安装radvd产生的后果"><a href="#bastion上安装radvd产生的后果" class="headerlink" title="bastion上安装radvd产生的后果"></a>bastion上安装radvd产生的后果</h2><p>bastion是openstack over openstack测试环境中underlying openstack提供的一台虚机, 用于安装juju继续部署上层openstack.<br>忽然在bastion上运行juju add-model或者juju deploy偶尔(不是次次)将会出现下列问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR failed to create environ: authentication failed.: authentication failed</span><br><span class="line">caused by: requesting token: failed executing the request http://10.230.19.53:5000/v3/auth/tokens</span><br><span class="line">caused by: Post http://10.230.19.53:5000/v3/auth/tokens: dial tcp 10.230.19.53:5000: i/o timeout</span><br></pre></td></tr></table></figure></p>
<p>刚开始怀疑snap会自动升级juju版本到最新版本的原因, 其实不是. 接着发现从bastion连controller (juju ssh 0 -m controller)时偶尔会断线, 接着使用下列命令发现偶尔有timeout出现确认了这个假设.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while true; do nc -w 1 -vz 10.230.19.53 5000; sleep 1; done</span><br></pre></td></tr></table></figure></p>
<p>接着在underlying openstack中看到了下列日志:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000s of [484018.924930] IPv6: qr-0166579a-c8: IPv6 duplicate address 2001:192:168:99:f816:3eff:fec9:783 used by fa:16:3e:c9:07:83 detected!</span><br></pre></td></tr></table></figure></p>
<p>才得知是在bastion上运行了radvd的原因, 一种原因是tenant network (zhhuabj_admin_net)做了HA的, 各vrrp节点上的keepalived由于没有配置这个未被管理的IPv6网段, 所以各vrrp节点上都被分配了相同的IPv6地址(2001:192:168:99:f816:3eff:fec9:783), 这样会引起keepalived不快会发生迁移导致tenant网络不稳定. 解决办法设想的是再创建一个non-HA的tenant network, 然后在这个network上开一台虚机上跑radvd, 上层的openstack环境也使用这个network.<br>但这里似乎不是这原因, 就是bastion上分配了ipv6地址导致连juju时ipv4/ipv6 fallback似乎有点问题导致网络时而中断.</p>
<p>另外, security group会禁止在虚机上提供DHCPv6服务(禁止从547到546的traffic),也有MAC/IP匹配防欺骗的rules等. 所以如果想使用这个openstack-over-openstack环境上做openstack使用外部stateless router的实验的话, 最好通过底层juju的use-default-secgroup=false (<a href="https://github.com/juju/juju/blob/2.5/provider/openstack/config.go#L20)禁用底层的security" target="_blank" rel="external">https://github.com/juju/juju/blob/2.5/provider/openstack/config.go#L20)禁用底层的security</a> group.</p>
<p>之前还遇到了一个在bastion上安装radvd造成无法登录bastion的问题, 那是因为在l3-agent上分配了两个网卡, 并且将这两个网卡都plug进了一个网桥中, 结果这个网卡从radvd处发生广播风暴导致无法登录bastion.</p>
<h2 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h2><p>用户想根据外部物理IPv6 stateless router定义的IPv6网络, 虚机分配了IP, 但是网卡上去没配置.<br>下面我们在一个openstack over openstack环境上模拟这种测试.<br>首先, 我们不能直接在bastion上安装radvd, 因为这会导致basion上也分配到IPv6后造成bastion和juju通信有问题. 所以想要在openstack over openstack环境上继续安装radvd模拟外部路由器的话需要做特殊处理. 那就是创建一个单独的ipv6 tenant router, 在这个router里创建一个虚机安装radvd, 并且在上层openstack环境里使用flat定义IPv6网络(这样它就和radvd在同一个IPv6网络了).<br>1, 第一步, 需要创建一个单独的router, 并且要确保定义network时禁用underlying的security group.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">source ~/novarc</span><br><span class="line">#openstack router create --centralized --no-ha --description &quot;for radvd&quot; zhhuabj_router_radvd</span><br><span class="line">openstack router create zhhuabj_router_radvd</span><br><span class="line"># remember to disable security group for underlying openstack network</span><br><span class="line">openstack network create --disable-port-security radvd-net</span><br><span class="line">openstack subnet create --subnet-range 10.10.0.0/24 --network radvd-net --allocation-pool start=10.10.0.50,end=10.10.0.100 --gateway 10.10.0.1 radvd-subnet</span><br><span class="line">openstack router add subnet zhhuabj_router_radvd radvd-subnet</span><br><span class="line">openstack router set --external-gateway ext_net zhhuabj_router_radvd</span><br></pre></td></tr></table></figure></p>
<p>2, 第二步, 创建一个虚机安装radvd来模拟外部路由器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source ~/novarc</span><br><span class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --image auto-sync/ubuntu-bionic-18.04-amd64-server-20190122-disk1.img --flavor m1.small --key-name mykey --network=radvd-net ip6router</span><br><span class="line">openstack floating ip create ext_net</span><br><span class="line">openstack server add floating ip ip6router 10.230.65.104</span><br></pre></td></tr></table></figure></p>
<p>注意, 这里虽然做的是stateless IPv6的实验, 但这里并不需要安装DHCPv6服务器, 因为openstack已经帮我们创建好了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nobody   22883     1  0 06:45 ?        00:00:00 dnsmasq --no-hosts --no-resolv --strict-order --except-interface=lo --pid-file=/var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/pid --dhcp-hostsfile=/var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/host --addn-hosts=/var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/addn_hosts --dhcp-optsfile=/var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/opts --dhcp-leasefile=/var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/leases --dhcp-match=set:ipxe,175 --bind-interfaces --interface=ns-9b88221a-86 --dhcp-range=set:tag0,2001:192:168:99::,static,64,86400s --dhcp-option-force=option:mtu,1500 --dhcp-lease-max=16777216 --conf-file=/etc/neutron/dnsmasq.conf --domain=openstacklocal</span><br><span class="line">ubuntu@juju-a09725-xenial-mitaka-5:~$ sudo cat /var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/opts</span><br><span class="line">tag:tag0,option6:domain-search,openstacklocalubuntu@juju-a09725-xenial-mitaka-5:~$ sudo cat /var/lib/neutron/dhcp/0aed25cf-b578-460d-9f4c-10d2fbe40179/addn_hosts</span><br><span class="line">2001:192:168:99:f816:3eff:fe1f:95ba	host-2001-192-168-99-f816-3eff-fe1f-95ba.openstacklocal host-2001-192-168-99-f816-3eff-fe1f-95ba</span><br><span class="line">2001:192:168:99:f816:3eff:fe6f:121f	host-2001-192-168-99-f816-3eff-fe6f-121f.openstacklocal host-2001-192-168-99-f816-3eff-fe6f-121f</span><br></pre></td></tr></table></figure></p>
<p>下面为了知识完备性, 如果一定要自己去创建外部Stateless DHCPv6的话, 可以这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y isc-dhcp-server</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">default-lease-time 600;</span><br><span class="line">max-lease-time 7200;</span><br><span class="line">log-facility local7;</span><br><span class="line">option dhcp6.name-servers 2001:4860:4860::8888;</span><br><span class="line">option dhcp6.domain-search &quot;&quot;;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo service isc-dhcp-server6 restart</span><br></pre></td></tr></table></figure></p>
<p>第三步, 创建上层openstack<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh --series xenial --release mitaka</span><br><span class="line">juju add-model xenial-mitaka</span><br><span class="line">juju deploy ./b/openstack.yaml</span><br><span class="line">~/stsstack-bundles/openstack/novarc</span><br></pre></td></tr></table></figure></p>
<p>第四步, 因为上层openstack环境需要定义flat network, 所以它实际使用了br-data, 那么需要为计算节点与网络节点的br-data添加一个外部网络.<br>ens3(VM) tap55f99960-ba(compute) -&gt; qbr55f99960-ba -&gt; qvb55f99960-ba(qbr) -&gt; qvo55f99960-ba(br-int) -&gt; br-data -&gt; ens7 - &gt; external<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">source ~/novarc</span><br><span class="line">nova interface-attach $(nova list |grep $(juju ssh neutron-gateway/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show radvd-net -c id -f value)</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ovs-vsctl add-port br-data ens7</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ifconfig ens7 up</span><br><span class="line">nova interface-attach $(nova list |grep $(juju ssh nova-compute/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show radvd-net -c id -f value)</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-port br-data ens7</span><br><span class="line">juju ssh nova-compute/0 -- sudo ifconfig ens7 up</span><br><span class="line"></span><br><span class="line">source ~/stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create --provider:network_type flat --provider:physical_network physnet1 --router:external=True ipv6_net</span><br><span class="line">neutron subnet-create ipv6_net --name ipv6_subnet --ip_version 6 --ipv6_address_mode dhcpv6-stateless --allocation-pool start=2001:192:168:99::2,end=2001:192:168:99:ffff:ffff:ffff:ffff 2001:192:168:99::/64</span><br><span class="line">openstack router create myrouter</span><br><span class="line">openstack router add subnet myrouter ipv6_subnet</span><br><span class="line">#openstack router set --external-gateway ext_net myrouter</span><br></pre></td></tr></table></figure></p>
<p>第五步,创建一个虚机用以充当IPv6 client, 这里注意一定要为Ipv6定义flat的网络, 另外, 额外定义了一个ipv4网络目的是为了让虚机完成metadata功能我们容易ssh进去调试.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">source ~/stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create --provider:network_type flat --provider:physical_network physnet1 --router:external=True ipv6_net</span><br><span class="line">neutron subnet-create ipv6_net --name ipv6_subnet --ip_version 6 --ipv6_address_mode dhcpv6-stateless --allocation-pool start=2001:192:168:99::2,end=2001:192:168:99:ffff:ffff:ffff:ffff 2001:192:168:99::/64</span><br><span class="line">openstack router create myrouter</span><br><span class="line">openstack router add subnet myrouter ipv6_subnet</span><br><span class="line">#openstack router set --external-gateway ext_net myrouter</span><br><span class="line"></span><br><span class="line"># create another ipv4 network to make metadata feature pass</span><br><span class="line">openstack network create ipv4-net</span><br><span class="line">openstack subnet create --subnet-range 10.11.0.0/24 --network ipv4-net --allocation-pool start=10.11.0.50,end=10.11.0.100 --gateway 10.11.0.1 ipv4-subnet</span><br><span class="line">openstack router add subnet myrouter ipv4-subnet</span><br><span class="line"></span><br><span class="line">openstack image create --disk-format=raw --container-format=bare xenial --file /home/ubuntu/images/xenial-server-cloudimg-amd64-disk1.img</span><br><span class="line">openstack security group rule create default --protocol tcp --remote-ip 0.0.0.0/0 --dst-port 22</span><br><span class="line">openstack security group rule create default --protocol icmp --remote-ip 0.0.0.0/0</span><br><span class="line">openstack security group rule list default</span><br><span class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --image xenial --flavor m1.small --key-name mykey --network=ipv4-net --network=ipv6_net ip6client</span><br></pre></td></tr></table></figure></p>
<p>第六步, 虚机内部配置调试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">juju scp ~/.ssh/id_rsa* neutron-gateway/0:/home/ubuntu/.ssh/</span><br><span class="line">juju ssh neutron-gateway/0</span><br><span class="line">sudo ip netns exec qrouter-f6d50237-add3-4bda-b848-861bfa68c7a3 ssh -i ~/.ssh/id_rsa ubuntu@10.11.0.51 -v</span><br><span class="line"></span><br><span class="line">sudo vim /etc/network/interfaces.d/50-cloud-init.cfg</span><br><span class="line">iface ens3 inet6 auto</span><br><span class="line">    up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br><span class="line">    up sleep 5</span><br><span class="line">    autoconf 1</span><br><span class="line">    accept_ra 2</span><br><span class="line">    dhcp 1</span><br><span class="line"></span><br><span class="line">sudo dhclient -6 -d ens3</span><br><span class="line">#sudo ifup --force --verbose ens3</span><br><span class="line"></span><br><span class="line"># debug, the fe80 address of ipv6 client is fe80::f816:3eff:fe6f:121f</span><br><span class="line">sudo tcpdump -ni ens3 ip6 host fe80::f816:3eff:fe6f:121f</span><br></pre></td></tr></table></figure></p>
<p>注意, 在给br-data添加外部网卡及停用外部DHCPv6(这样使用openstack dnsmasq提供的IPv6)后, 所以除ovs网桥以外的网卡(ens3(VM) tap55f99960-ba(compute) -&gt; qbr55f99960-ba -&gt; qvb55f99960-ba(qbr) -&gt; qvo55f99960-ba(br-int) -&gt; br-data -&gt; ens7 - &gt; external)均可以成功抓到下列包(注: 在ovs bridge上抓到的包没有dhcp6 advertise, 但这似乎没有影响到整体功能, 可能就是对ovs bridge使用tcpdump看不到dhcp6 advertise吧):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">07:44:01.209860 IP6 fe80::f816:3eff:fe6f:121f.546 &gt; ff02::1:2.547: dhcp6 solicit</span><br><span class="line">07:44:01.213087 IP6 fe80::f816:3eff:fe1f:95ba.547 &gt; fe80::f816:3eff:fe6f:121f.546: dhcp6 advertise</span><br><span class="line">07:44:02.294432 IP6 fe80::f816:3eff:fe6f:121f.546 &gt; ff02::1:2.547: dhcp6 solicit</span><br><span class="line">07:44:02.296687 IP6 fe80::f816:3eff:fe1f:95ba.547 &gt; fe80::f816:3eff:fe6f:121f.546: dhcp6 advertise</span><br><span class="line">07:44:04.399586 IP6 fe80::f816:3eff:fe6f:121f.546 &gt; ff02::1:2.547: dhcp6 solicit</span><br><span class="line">07:44:04.401203 IP6 fe80::f816:3eff:fe1f:95ba.547 &gt; fe80::f816:3eff:fe6f:121f.546: dhcp6 advertise</span><br><span class="line">07:44:05.035467 IP6 :: &gt; ff02::1:ffe0:75b0: ICMP6, neighbor solicitation, who has 2001:192:168:99:f816:3eff:fee0:75b0, length 32</span><br><span class="line">07:44:05.036112 IP6 2001:192:168:99:f816:3eff:fee0:75b0 &gt; ff02::1: ICMP6, neighbor advertisement, tgt is 2001:192:168:99:f816:3eff:fee0:75b0, length 32</span><br><span class="line">07:44:08.665018 IP6 fe80::f816:3eff:fe6f:121f.546 &gt; ff02::1:2.547: dhcp6 solicit</span><br><span class="line">07:44:08.666282 IP6 fe80::f816:3eff:fe1f:95ba.547 &gt; fe80::f816:3eff:fe6f:121f.546: dhcp6 advertise</span><br><span class="line">07:44:13.668128 IP6 fe80::f816:3eff:fe1f:95ba &gt; fe80::f816:3eff:fe6f:121f: ICMP6, neighbor solicitation, who has fe80::f816:3eff:fe6f:121f, length 32</span><br><span class="line">07:44:13.668187 IP6 fe80::f816:3eff:fe6f:121f &gt; fe80::f816:3eff:fe1f:95ba: ICMP6, neighbor advertisement, tgt is fe80::f816:3eff:fe6f:121f, length 24</span><br></pre></td></tr></table></figure></p>
<p>测试结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip6client:~$ ip addr show ens3 |grep inet6</span><br><span class="line">    inet6 2001:192:168:99:f816:3eff:fe6f:121f/64 scope global mngtmpaddr dynamic</span><br><span class="line">    inet6 fe80::f816:3eff:fe6f:121f/64 scope link</span><br><span class="line">ubuntu@ip6client:~$ ping6 2001:192:168:99:f816:3eff:fe1f:95ba</span><br><span class="line">PING 2001:192:168:99:f816:3eff:fe1f:95ba(2001:192:168:99:f816:3eff:fe1f:95ba) 56 data bytes</span><br><span class="line">64 bytes from 2001:192:168:99:f816:3eff:fe1f:95ba: icmp_seq=1 ttl=64 time=3.80 ms</span><br><span class="line">ubuntu@juju-a09725-xenial-mitaka-5:~$ sudo ip netns exec qdhcp-0aed25cf-b578-460d-9f4c-10d2fbe40179 ping6 2001:192:168:99:f816:3eff:fe6f:121f</span><br><span class="line">PING 2001:192:168:99:f816:3eff:fe6f:121f(2001:192:168:99:f816:3eff:fe6f:121f) 56 data bytes</span><br><span class="line">64 bytes from 2001:192:168:99:f816:3eff:fe6f:121f: icmp_seq=1 ttl=64 time=2.97 ms</span><br></pre></td></tr></table></figure></p>
<h2 id="附件-防火墙及流表"><a href="#附件-防火墙及流表" class="headerlink" title="附件 - 防火墙及流表"></a>附件 - 防火墙及流表</h2><p>实际上, security group的默认规则是不影响虚机使用外部IPv6路由器获取RA的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line">root@juju-a09725-xenial-mitaka-7:~# sudo ovs-ofctl dump-flows br-data</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0xa53ad21731e554e6, duration=10484.383s, table=0, n_packets=247, n_bytes=25966, idle_age=2619, priority=4,in_port=1,dl_vlan=2 actions=strip_vlan,NORMAL</span><br><span class="line"> cookie=0xa53ad21731e554e6, duration=168851.241s, table=0, n_packets=39, n_bytes=4126, idle_age=7795, hard_age=65534, priority=2,in_port=1 actions=drop</span><br><span class="line"> cookie=0xa53ad21731e554e6, duration=168852.108s, table=0, n_packets=1803, n_bytes=173620, idle_age=18, hard_age=65534, priority=0 actions=NORMAL</span><br><span class="line"></span><br><span class="line">root@juju-a09725-xenial-mitaka-7:~# sudo ovs-ofctl dump-flows br-int</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10493.212s, table=0, n_packets=0, n_bytes=0, idle_age=10493, priority=10,icmp6,in_port=3,icmp_type=136 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10487.634s, table=0, n_packets=39, n_bytes=3058, idle_age=2630, priority=10,icmp6,in_port=4,icmp_type=136 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10492.928s, table=0, n_packets=384, n_bytes=16128, idle_age=26, priority=10,arp,in_port=3 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10487.502s, table=0, n_packets=0, n_bytes=0, idle_age=10491, priority=10,arp,in_port=4 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=168862.878s, table=0, n_packets=0, n_bytes=0, idle_age=65534, hard_age=65534, priority=2,in_port=1 actions=drop</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10493.495s, table=0, n_packets=31789, n_bytes=2827279, idle_age=0, priority=9,in_port=3 actions=resubmit(,25)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10488.022s, table=0, n_packets=208, n_bytes=22908, idle_age=2632, priority=9,in_port=4 actions=resubmit(,25)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10495.768s, table=0, n_packets=1803, n_bytes=173620, idle_age=30, priority=3,in_port=1,vlan_tci=0x0000 actions=mod_vlan_vid:2,NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=168864.656s, table=0, n_packets=32596, n_bytes=2637470, idle_age=0, hard_age=65534, priority=0 actions=NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=168864.535s, table=23, n_packets=0, n_bytes=0, idle_age=65534, hard_age=65534, priority=0 actions=drop</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10493.351s, table=24, n_packets=0, n_bytes=0, idle_age=10493, priority=2,icmp6,in_port=3,icmp_type=136,nd_target=fe80::f816:3eff:feb9:b96a actions=NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10487.892s, table=24, n_packets=3, n_bytes=234, idle_age=2778, priority=2,icmp6,in_port=4,icmp_type=136,nd_target=2001:192:168:99:f816:3eff:fe6f:121f actions=NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10487.762s, table=24, n_packets=36, n_bytes=2824, idle_age=2630, priority=2,icmp6,in_port=4,icmp_type=136,nd_target=fe80::f816:3eff:fe6f:121f actions=NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10493.068s, table=24, n_packets=384, n_bytes=16128, idle_age=26, priority=2,arp,in_port=3,arp_spa=10.11.0.51 actions=resubmit(,25)</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=168864.420s, table=24, n_packets=0, n_bytes=0, idle_age=65534, hard_age=65534, priority=0 actions=drop</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10493.780s, table=25, n_packets=32173, n_bytes=2843407, idle_age=0, priority=2,in_port=3,dl_src=fa:16:3e:b9:b9:6a actions=NORMAL</span><br><span class="line"> cookie=0x8a5790f2d6b535e6, duration=10488.305s, table=25, n_packets=208, n_bytes=22908, idle_age=2632, priority=2,in_port=4,dl_src=fa:16:3e:6f:12:1f actions=NORMAL</span><br><span class="line"></span><br><span class="line">root@juju-a09725-xenial-mitaka-7:~# ip6tables-save</span><br><span class="line"># Generated by ip6tables-save v1.6.0 on Fri Jan 25 09:47:42 2019</span><br><span class="line">*raw</span><br><span class="line">:PREROUTING ACCEPT [3823:312730]</span><br><span class="line">:OUTPUT ACCEPT [47:3376]</span><br><span class="line">:neutron-openvswi-OUTPUT - [0:0]</span><br><span class="line">:neutron-openvswi-PREROUTING - [0:0]</span><br><span class="line">-A PREROUTING -j neutron-openvswi-PREROUTING</span><br><span class="line">-A OUTPUT -j neutron-openvswi-OUTPUT</span><br><span class="line">-A neutron-openvswi-PREROUTING -m physdev --physdev-in qvb55f99960-ba -j CT --zone 2</span><br><span class="line">-A neutron-openvswi-PREROUTING -m physdev --physdev-in tap55f99960-ba -j CT --zone 2</span><br><span class="line">-A neutron-openvswi-PREROUTING -m physdev --physdev-in qvbb2d4fa47-0e -j CT --zone 1</span><br><span class="line">-A neutron-openvswi-PREROUTING -m physdev --physdev-in tapb2d4fa47-0e -j CT --zone 1</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jan 25 09:47:42 2019</span><br><span class="line"># Generated by ip6tables-save v1.6.0 on Fri Jan 25 09:47:42 2019</span><br><span class="line">*mangle</span><br><span class="line">:PREROUTING ACCEPT [3852:314932]</span><br><span class="line">:INPUT ACCEPT [288:24080]</span><br><span class="line">:FORWARD ACCEPT [2054:171782]</span><br><span class="line">:OUTPUT ACCEPT [93:6580]</span><br><span class="line">:POSTROUTING ACCEPT [1588:128442]</span><br><span class="line">:neutron-openvswi-FORWARD - [0:0]</span><br><span class="line">:neutron-openvswi-INPUT - [0:0]</span><br><span class="line">:neutron-openvswi-OUTPUT - [0:0]</span><br><span class="line">:neutron-openvswi-POSTROUTING - [0:0]</span><br><span class="line">:neutron-openvswi-PREROUTING - [0:0]</span><br><span class="line">:neutron-openvswi-scope - [0:0]</span><br><span class="line">-A PREROUTING -j neutron-openvswi-PREROUTING</span><br><span class="line">-A INPUT -j neutron-openvswi-INPUT</span><br><span class="line">-A FORWARD -j neutron-openvswi-FORWARD</span><br><span class="line">-A OUTPUT -j neutron-openvswi-OUTPUT</span><br><span class="line">-A POSTROUTING -j neutron-openvswi-POSTROUTING</span><br><span class="line">-A neutron-openvswi-PREROUTING -j neutron-openvswi-scope</span><br><span class="line">-A neutron-openvswi-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jan 25 09:47:42 2019</span><br><span class="line"># Generated by ip6tables-save v1.6.0 on Fri Jan 25 09:47:42 2019</span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [186:15512]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [7:776]</span><br><span class="line">:neutron-filter-top - [0:0]</span><br><span class="line">:neutron-openvswi-FORWARD - [0:0]</span><br><span class="line">:neutron-openvswi-INPUT - [0:0]</span><br><span class="line">:neutron-openvswi-OUTPUT - [0:0]</span><br><span class="line">:neutron-openvswi-i55f99960-b - [0:0]</span><br><span class="line">:neutron-openvswi-ib2d4fa47-0 - [0:0]</span><br><span class="line">:neutron-openvswi-local - [0:0]</span><br><span class="line">:neutron-openvswi-o55f99960-b - [0:0]</span><br><span class="line">:neutron-openvswi-ob2d4fa47-0 - [0:0]</span><br><span class="line">:neutron-openvswi-s55f99960-b - [0:0]</span><br><span class="line">:neutron-openvswi-scope - [0:0]</span><br><span class="line">:neutron-openvswi-sg-chain - [0:0]</span><br><span class="line">:neutron-openvswi-sg-fallback - [0:0]</span><br><span class="line">-A INPUT -j neutron-openvswi-INPUT</span><br><span class="line">-A FORWARD -j neutron-filter-top</span><br><span class="line">-A FORWARD -j neutron-openvswi-FORWARD</span><br><span class="line">-A OUTPUT -j neutron-filter-top</span><br><span class="line">-A OUTPUT -j neutron-openvswi-OUTPUT</span><br><span class="line">-A neutron-filter-top -j neutron-openvswi-local</span><br><span class="line">-A neutron-openvswi-FORWARD -j neutron-openvswi-scope</span><br><span class="line">-A neutron-openvswi-FORWARD -m physdev --physdev-out tap55f99960-ba --physdev-is-bridged -m comment --comment &quot;Direct traffic from the VM interface to the security group chain.&quot; -j neutron-openvswi-sg-chain</span><br><span class="line">-A neutron-openvswi-FORWARD -m physdev --physdev-in tap55f99960-ba --physdev-is-bridged -m comment --comment &quot;Direct traffic from the VM interface to the security group chain.&quot; -j neutron-openvswi-sg-chain</span><br><span class="line">-A neutron-openvswi-FORWARD -m physdev --physdev-out tapb2d4fa47-0e --physdev-is-bridged -m comment --comment &quot;Direct traffic from the VM interface to the security group chain.&quot; -j neutron-openvswi-sg-chain</span><br><span class="line">-A neutron-openvswi-FORWARD -m physdev --physdev-in tapb2d4fa47-0e --physdev-is-bridged -m comment --comment &quot;Direct traffic from the VM interface to the security group chain.&quot; -j neutron-openvswi-sg-chain</span><br><span class="line">-A neutron-openvswi-INPUT -m physdev --physdev-in tap55f99960-ba --physdev-is-bridged -m comment --comment &quot;Direct incoming traffic from VM to the security group chain.&quot; -j neutron-openvswi-o55f99960-b</span><br><span class="line">-A neutron-openvswi-INPUT -m physdev --physdev-in tapb2d4fa47-0e --physdev-is-bridged -m comment --comment &quot;Direct incoming traffic from VM to the security group chain.&quot; -j neutron-openvswi-ob2d4fa47-0</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 130 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 131 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 132 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 135 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 136 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -m state --state RELATED,ESTABLISHED -m comment --comment &quot;Direct packets associated with a known session to the RETURN chain.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -s fe80::f816:3eff:fe1f:95ba/128 -p udp -m udp --sport 547 -m udp --dport 546 -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -m set --match-set NIPv6e50abcfd-5bdb-462d-aa21- src -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -p ipv6-icmp -j RETURN</span><br><span class="line">-A neutron-openvswi-i55f99960-b -m state --state INVALID -m comment --comment &quot;Drop packets that appear related to an existing connection (e.g. TCP ACK/FIN) but do not have an entry in conntrack.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-i55f99960-b -m comment --comment &quot;Send unmatched traffic to the fallback chain.&quot; -j neutron-openvswi-sg-fallback</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 130 -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 131 -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 132 -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 135 -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 136 -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -m state --state RELATED,ESTABLISHED -m comment --comment &quot;Direct packets associated with a known session to the RETURN chain.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -m set --match-set NIPv6e50abcfd-5bdb-462d-aa21- src -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -p ipv6-icmp -j RETURN</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -m state --state INVALID -m comment --comment &quot;Drop packets that appear related to an existing connection (e.g. TCP ACK/FIN) but do not have an entry in conntrack.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-ib2d4fa47-0 -m comment --comment &quot;Send unmatched traffic to the fallback chain.&quot; -j neutron-openvswi-sg-fallback</span><br><span class="line">-A neutron-openvswi-o55f99960-b -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 131 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 135 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 143 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -j neutron-openvswi-s55f99960-b</span><br><span class="line">-A neutron-openvswi-o55f99960-b -p ipv6-icmp -m icmp6 --icmpv6-type 134 -m comment --comment &quot;Drop IPv6 Router Advts from VM Instance.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-o55f99960-b -p ipv6-icmp -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -p udp -m udp --sport 546 -m udp --dport 547 -m comment --comment &quot;Allow DHCP client traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -p udp -m udp --sport 547 -m udp --dport 546 -m comment --comment &quot;Prevent DHCP Spoofing by VM.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-o55f99960-b -m state --state RELATED,ESTABLISHED -m comment --comment &quot;Direct packets associated with a known session to the RETURN chain.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -j RETURN</span><br><span class="line">-A neutron-openvswi-o55f99960-b -m state --state INVALID -m comment --comment &quot;Drop packets that appear related to an existing connection (e.g. TCP ACK/FIN) but do not have an entry in conntrack.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-o55f99960-b -m comment --comment &quot;Send unmatched traffic to the fallback chain.&quot; -j neutron-openvswi-sg-fallback</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 131 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 135 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -s ::/128 -d ff02::/16 -p ipv6-icmp -m icmp6 --icmpv6-type 143 -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -p ipv6-icmp -m icmp6 --icmpv6-type 134 -m comment --comment &quot;Drop IPv6 Router Advts from VM Instance.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -p ipv6-icmp -m comment --comment &quot;Allow IPv6 ICMP traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -p udp -m udp --sport 546 -m udp --dport 547 -m comment --comment &quot;Allow DHCP client traffic.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -p udp -m udp --sport 547 -m udp --dport 546 -m comment --comment &quot;Prevent DHCP Spoofing by VM.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -m state --state RELATED,ESTABLISHED -m comment --comment &quot;Direct packets associated with a known session to the RETURN chain.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -j RETURN</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -m state --state INVALID -m comment --comment &quot;Drop packets that appear related to an existing connection (e.g. TCP ACK/FIN) but do not have an entry in conntrack.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-ob2d4fa47-0 -m comment --comment &quot;Send unmatched traffic to the fallback chain.&quot; -j neutron-openvswi-sg-fallback</span><br><span class="line">-A neutron-openvswi-s55f99960-b -s 2001:192:168:99:f816:3eff:fe6f:121f/128 -m mac --mac-source FA:16:3E:6F:12:1F -m comment --comment &quot;Allow traffic from defined IP/MAC pairs.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-s55f99960-b -s fe80::f816:3eff:fe6f:121f/128 -m mac --mac-source FA:16:3E:6F:12:1F -m comment --comment &quot;Allow traffic from defined IP/MAC pairs.&quot; -j RETURN</span><br><span class="line">-A neutron-openvswi-s55f99960-b -m comment --comment &quot;Drop traffic without an IP/MAC allow rule.&quot; -j DROP</span><br><span class="line">-A neutron-openvswi-sg-chain -m physdev --physdev-out tap55f99960-ba --physdev-is-bridged -m comment --comment &quot;Jump to the VM specific chain.&quot; -j neutron-openvswi-i55f99960-b</span><br><span class="line">-A neutron-openvswi-sg-chain -m physdev --physdev-in tap55f99960-ba --physdev-is-bridged -m comment --comment &quot;Jump to the VM specific chain.&quot; -j neutron-openvswi-o55f99960-b</span><br><span class="line">-A neutron-openvswi-sg-chain -m physdev --physdev-out tapb2d4fa47-0e --physdev-is-bridged -m comment --comment &quot;Jump to the VM specific chain.&quot; -j neutron-openvswi-ib2d4fa47-0</span><br><span class="line">-A neutron-openvswi-sg-chain -m physdev --physdev-in tapb2d4fa47-0e --physdev-is-bridged -m comment --comment &quot;Jump to the VM specific chain.&quot; -j neutron-openvswi-ob2d4fa47-0</span><br><span class="line">-A neutron-openvswi-sg-chain -j ACCEPT</span><br><span class="line">-A neutron-openvswi-sg-fallback -m comment --comment &quot;Default drop rule for unmatched traffic.&quot; -j DROP</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jan 25 09:47:42 2019</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-a09725-xenial-mitaka-7:~# ovs-vsctl show</span><br><span class="line">4c7ed97c-a113-48c5-840c-252bb0027f19</span><br><span class="line">    Bridge br-ex</span><br><span class="line">        Port br-ex</span><br><span class="line">            Interface br-ex</span><br><span class="line">                type: internal</span><br><span class="line">    Bridge br-int</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port &quot;qvob2d4fa47-0e&quot;</span><br><span class="line">            tag: 1</span><br><span class="line">            Interface &quot;qvob2d4fa47-0e&quot;</span><br><span class="line">        Port &quot;qvo55f99960-ba&quot;</span><br><span class="line">            tag: 2</span><br><span class="line">            Interface &quot;qvo55f99960-ba&quot;</span><br><span class="line">        Port patch-tun</span><br><span class="line">            Interface patch-tun</span><br><span class="line"></span><br><span class="line">root@juju-a09725-xenial-mitaka-7:~# ip addr show</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8958 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether fa:16:3e:d5:28:84 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.5.0.4/16 brd 10.5.255.255 scope global ens3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fed5:2884/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: fan-252: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8908 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 62:59:80:9b:95:91 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 252.0.4.1/8 scope global fan-252</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6059:80ff:fe9b:9591/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: ftun0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8908 qdisc noqueue master fan-252 state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether 62:59:80:9b:95:91 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::6059:80ff:fe9b:9591/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1</span><br><span class="line">    link/ether 32:5b:19:f0:ed:6d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">8: br-int: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1458 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/ether 62:64:d4:23:dd:43 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::6064:d4ff:fe23:dd43/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: br-ex: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1</span><br><span class="line">    link/ether 66:87:20:0d:38:4e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">10: br-data: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/ether a2:e0:9f:bb:06:46 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 2001:192:168:99:a0e0:9fff:febb:646/64 scope global mngtmpaddr dynamic</span><br><span class="line">       valid_lft 82152sec preferred_lft 10152sec</span><br><span class="line">    inet6 fe80::a0e0:9fff:febb:646/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: br-tun: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/ether 1e:29:d4:32:d7:43 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::1c29:d4ff:fe32:d743/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">12: gre0@NONE: &lt;NOARP&gt; mtu 1476 qdisc noop state DOWN group default qlen 1</span><br><span class="line">    link/gre 0.0.0.0 brd 0.0.0.0</span><br><span class="line">13: gretap0@NONE: &lt;BROADCAST,MULTICAST&gt; mtu 1462 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">14: gre_sys@NONE: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 65490 qdisc pfifo_fast master ovs-system state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether ae:90:21:f5:b5:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::ac90:21ff:fef5:b58c/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">15: qbrb2d4fa47-0e: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1458 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether ae:48:8e:e0:62:fc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">16: qvob2d4fa47-0e@qvbb2d4fa47-0e: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1458 qdisc noqueue master ovs-system state UP group default qlen 1000</span><br><span class="line">    link/ether 0a:4c:b6:39:72:ed brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::84c:b6ff:fe39:72ed/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: qvbb2d4fa47-0e@qvob2d4fa47-0e: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1458 qdisc noqueue master qbrb2d4fa47-0e state UP group default qlen 1000</span><br><span class="line">    link/ether ae:48:8e:e0:62:fc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::ac48:8eff:fee0:62fc/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">18: qbr55f99960-ba: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether ce:fb:c8:4f:5f:cc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">19: qvo55f99960-ba@qvb55f99960-ba: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master ovs-system state UP group default qlen 1000</span><br><span class="line">    link/ether 1a:a0:dc:19:6c:e2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::18a0:dcff:fe19:6ce2/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">20: qvb55f99960-ba@qvo55f99960-ba: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master qbr55f99960-ba state UP group default qlen 1000</span><br><span class="line">    link/ether ce:fb:c8:4f:5f:cc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::ccfb:c8ff:fe4f:5fcc/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">21: tapb2d4fa47-0e: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1458 qdisc pfifo_fast master qbrb2d4fa47-0e state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether fe:16:3e:b9:b9:6a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc16:3eff:feb9:b96a/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">22: tap55f99960-ba: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master qbr55f99960-ba state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether fe:16:3e:6f:12:1f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::fc16:3eff:fe6f:121f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: ens7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master ovs-system state UP group default qlen 1000</span><br><span class="line">    link/ether fa:16:3e:41:29:bf brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::f816:3eff:fe41:29bf/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=patch-int&#125;</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                type: internal</span><br><span class="line">        Port int-br-data</span><br><span class="line">            Interface int-br-data</span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=phy-br-data&#125;</span><br><span class="line">    Bridge br-tun</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port patch-int</span><br><span class="line">            Interface patch-int</span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=patch-tun&#125;</span><br><span class="line">        Port &quot;gre-0a05000b&quot;</span><br><span class="line">            Interface &quot;gre-0a05000b&quot;</span><br><span class="line">                type: gre</span><br><span class="line">                options: &#123;df_default=&quot;true&quot;, in_key=flow, local_ip=&quot;10.5.0.4&quot;, out_key=flow, remote_ip=&quot;10.5.0.11&quot;&#125;</span><br><span class="line">        Port br-tun</span><br><span class="line">            Interface br-tun</span><br><span class="line">                type: internal</span><br><span class="line">    Bridge br-data</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port &quot;ens7&quot;</span><br><span class="line">            Interface &quot;ens7&quot;</span><br><span class="line">        Port phy-br-data</span><br><span class="line">            Interface phy-br-data</span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=int-br-data&#125;</span><br><span class="line">        Port br-data</span><br><span class="line">            Interface br-data</span><br><span class="line">                type: internal</span><br><span class="line">    ovs_version: &quot;2.5.5&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://asdkda.github.io/2016/02/05/ipv6/" target="_blank" rel="external">http://asdkda.github.io/2016/02/05/ipv6/</a><br>[2] <a href="http://tldp.org/HOWTO/html_single/Linux+IPv6-HOWTO/#idp57787920" target="_blank" rel="external">http://tldp.org/HOWTO/html_single/Linux+IPv6-HOWTO/#idp57787920</a><br>[3] <a href="https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/" target="_blank" rel="external">https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/</a><br>[4] <a href="https://www.slideshare.net/shixiongshang1/ipv6-case-study-v26" target="_blank" rel="external">https://www.slideshare.net/shixiongshang1/ipv6-case-study-v26</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/13/用OpenSSL做自签名的证书/" rel="next" title="用OpenSSL做自签名的证书">
                <i class="fa fa-chevron-left"></i> 用OpenSSL做自签名的证书
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/03/也谈wifi断流问题/" rel="prev" title="也谈wifi断流问题">
                也谈wifi断流问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础-ND协议的三个位"><span class="nav-number">1.</span> <span class="nav-text">基础 - ND协议的三个位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基础-Neutron-IPv6"><span class="nav-number">2.</span> <span class="nav-text">基础 - Neutron IPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基础-Ubuntu中手工配置IPv6的注意点"><span class="nav-number">3.</span> <span class="nav-text">基础 - Ubuntu中手工配置IPv6的注意点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv6中的防火墙"><span class="nav-number">4.</span> <span class="nav-text">IPv6中的防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Statefull-DHCPv6"><span class="nav-number">5.</span> <span class="nav-text">Statefull DHCPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SLAAC-Stateless-Address-Auto-Configuration"><span class="nav-number">6.</span> <span class="nav-text">SLAAC (Stateless Address Auto Configuration)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SLAAS-with-Stateless-DHCPv6"><span class="nav-number">7.</span> <span class="nav-text">SLAAS with Stateless DHCPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SLAAS-with-Statefull-DHCPv6"><span class="nav-number">8.</span> <span class="nav-text">SLAAS with Statefull DHCPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bastion上安装radvd产生的后果"><span class="nav-number">9.</span> <span class="nav-text">bastion上安装radvd产生的后果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际案例"><span class="nav-number">10.</span> <span class="nav-text">实际案例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-防火墙及流表"><span class="nav-number">11.</span> <span class="nav-text">附件 - 防火墙及流表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">12.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
