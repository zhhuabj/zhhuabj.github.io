<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07) OpenStack Charm如何支持SSLOpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoi">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenStack SSL">
<meta property="og:url" content="http://yoursite.com/2018/02/07/OpenStack-SSL/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07) OpenStack Charm如何支持SSLOpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoi">
<meta property="og:updated_time" content="2021-01-27T03:57:26.180Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenStack SSL">
<meta name="twitter:description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07) OpenStack Charm如何支持SSLOpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoi">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/02/07/OpenStack-SSL/"/>





  <title>OpenStack SSL | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/OpenStack-SSL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OpenStack SSL</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-07T13:25:04+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-02-07)</strong></p>
<h2 id="OpenStack-Charm如何支持SSL"><a href="#OpenStack-Charm如何支持SSL" class="headerlink" title="OpenStack Charm如何支持SSL"></a>OpenStack Charm如何支持SSL</h2><p>OpenStack Charm需为每个OpenStack服务配置证书（/var/lib/keystone/juju_ssl/, /usr/local/share/ca-certificates/)与https endpoint，同时也会生成/etc/apache2/ssl/keystone配置。</p>
<ol>
<li><p>一种方式有证书就直接指定证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">juju config &lt;openstack-charm&gt; os-admin-hostname=&apos;X.xxx.com&apos; os-public-hostname=&apos;X.xxx.com&apos; os-internal-hostname=&apos;X.xxx.com&apos; ssl_ca=&apos;$cat ~/ssl_ca.crt&apos; ssl_cert=&apos;$cat ~/ssl_cert.crt&apos; ssl_key=&apos;&apos;$cat ~/ssl_key.key&apos;</span><br><span class="line">juju config keystone ssl_ca | base64 --decode &gt; keystone_CA.crt</span><br><span class="line">we can see that the .crt file is expired:</span><br><span class="line"># cat keystone_CA.crt | openssl x509 -noout -enddate</span><br><span class="line">notAfter=Dec 20 16:04:05 2019 GMT</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式是由charm来自动生成证书。如果用户没有指定ssl_cert与ssl_key，那么is_cert_provided_in_config=False，charm将自动生成证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def is_cert_provided_in_config():</span><br><span class="line">    cert = config(&apos;ssl_cert&apos;)</span><br><span class="line">    key = config(&apos;ssl_key&apos;)</span><br><span class="line">    return bool(cert and key)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体命令如下，也可参考：<a href="https://paste.ubuntu.com/26533565/" target="_blank" rel="external">https://paste.ubuntu.com/26533565/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">NOTE:  vboth use-https=true and https-serveice-endpoints=true are only used self-signed cert - https://review.opendev.org/#/c/555028/</span><br><span class="line"># deprecation - https://review.openstack.org/#/c/560915/</span><br><span class="line"># now we can use：xxx.sh -s xenial -r queens --create-model --name ssl:stsstack --num-compute 1 --openstack-dashboard --ssl --nova-console --run</span><br><span class="line"></span><br><span class="line">juju config keystone use-https=true</span><br><span class="line">juju config keystone https-service-endpoints=true</span><br><span class="line">tree /var/lib/keystone/juju_ssl/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/keystone/</span><br><span class="line">grep -r &apos;ssl&apos; /etc/nova/  #on nova node</span><br><span class="line">select * from endpoint;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-ids identity-service&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-list -r identity-service:13&quot;</span><br><span class="line">juju run --unit keystone/0 &quot;relation-get -r identity-service:13 - nova-cloud-controller/0&quot;</span><br><span class="line"></span><br><span class="line">export OS_REGION_NAME=RegionOne</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_PASSWORD=openstack</span><br><span class="line">export OS_AUTH_URL=https://10.5.0.28:5000/v2.0</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">openstack --insecure endpoint list</span><br><span class="line">openstack --insecure server list</span><br><span class="line">openstack --insecure --debug server list</span><br><span class="line">openstack --insecure --debug volume list</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-HA-Charm如何支持SSL"><a href="#OpenStack-HA-Charm如何支持SSL" class="headerlink" title="OpenStack HA Charm如何支持SSL"></a>OpenStack HA Charm如何支持SSL</h2><p>如果如nova-cloud-controller服务前又运行了下列命令添加了HA服务时呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju add-unit nova-cloud-controller -n 2</span><br><span class="line">juju deploy hacluster ncc-hacluster --series xenial</span><br><span class="line">juju add-relation nova-cloud-controller ncc-hacluster</span><br><span class="line">juju config nova-cloud-controller vip=10.5.104.1</span><br></pre></td></tr></table></figure></p>
<p>corosync将通过下列配置将VIP=10.5.104.1创建在juju-2f3cc6-mitaka-10上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# crm status</span><br><span class="line">Last updated: Wed Feb  7 04:18:31 2018		Last change: Wed Feb  7 04:09:33 2018 by hacluster via crmd on juju-2f3cc6-mitaka-10</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: juju-2f3cc6-mitaka-6 (version 1.1.14-70404b0) - partition with quorum</span><br><span class="line">3 nodes and 4 resources configured</span><br><span class="line">Online: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> Resource Group: grp_nova_vips</span><br><span class="line">     res_nova_ens3_vip	(ocf::heartbeat:IPaddr2):	Started juju-2f3cc6-mitaka-10</span><br><span class="line"> Clone Set: cl_nova_haproxy [res_nova_haproxy]</span><br><span class="line">     Started: [ juju-2f3cc6-mitaka-10 juju-2f3cc6-mitaka-11 juju-2f3cc6-mitaka-6 ]</span><br><span class="line"></span><br><span class="line">root@juju-2f3cc6-mitaka-10:~# ip addr show ens3 |grep 10.5.104.1</span><br><span class="line">    inet 10.5.104.1/16 brd 10.5.255.255 scope global secondary ens3</span><br></pre></td></tr></table></figure></p>
<p>同时，三个HA节点上的haproxy的配置(/etc/haproxy/haproxy.cfg)将创建代理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend tcp-in_nova-api-os-compute</span><br><span class="line">    bind *:8774</span><br><span class="line">    bind :::8774</span><br><span class="line">    acl net_10.5.0.15 dst 10.5.0.15/255.255.0.0</span><br><span class="line">    use_backend nova-api-os-compute_10.5.0.15 if net_10.5.0.15</span><br><span class="line">    default_backend nova-api-os-compute_10.5.0.15</span><br><span class="line">backend nova-api-os-compute_10.5.0.15</span><br><span class="line">    balance leastconn</span><br><span class="line">    server nova-cloud-controller-1 10.5.0.15:8764 check</span><br><span class="line">    server nova-cloud-controller-0 10.5.0.37:8764 check</span><br><span class="line">    server nova-cloud-controller-2 10.5.0.52:8764 check</span><br></pre></td></tr></table></figure></p>
<p>最重要的是，三个HA节点上Apache都将设置代理“RequestHeader set X-Forwarded-Proto “https””，完整的配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@juju-2f3cc6-mitaka-10:~# cat /etc/apache2/sites-available/openstack_https_frontend.conf</span><br><span class="line">Listen 8764</span><br><span class="line">&lt;VirtualHost 10.5.0.15:8764&gt;</span><br><span class="line">    ServerName 10.5.104.1</span><br><span class="line">    SSLEngine on</span><br><span class="line">    SSLProtocol +TLSv1 +TLSv1.1 +TLSv1.2</span><br><span class="line">    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!EXP:!LOW:!MEDIUM</span><br><span class="line">    SSLCertificateFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    # See LP 1484489 - this is to support &lt;= 2.4.7 and &gt;= 2.4.8</span><br><span class="line">    SSLCertificateChainFile /etc/apache2/ssl/nova/cert_10.5.104.1</span><br><span class="line">    SSLCertificateKeyFile /etc/apache2/ssl/nova/key_10.5.104.1</span><br><span class="line">    ProxyPass / http://localhost:8754/</span><br><span class="line">    ProxyPassReverse / http://localhost:8754/</span><br><span class="line">    ProxyPreserveHost on</span><br><span class="line">    RequestHeader set X-Forwarded-Proto &quot;https&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">    Order deny,allow</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="OpenStack-Horizon和Apache代理之间如何支持SSL"><a href="#OpenStack-Horizon和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack Horizon和Apache代理之间如何支持SSL"></a>OpenStack Horizon和Apache代理之间如何支持SSL</h2><p>openstack horizon使用了Django框架，Django中有如下代码（<a href="https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），" target="_blank" rel="external">https://github.com/django/django/blob/2.0.2/django/http/request.py#L191），</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property</span><br><span class="line">def scheme(self):</span><br><span class="line">    if settings.SECURE_PROXY_SSL_HEADER:</span><br><span class="line">        try:</span><br><span class="line">            header, value = settings.SECURE_PROXY_SSL_HEADER</span><br><span class="line">        except ValueError:</span><br><span class="line">            raise ImproperlyConfigured(</span><br><span class="line">                &apos;The SECURE_PROXY_SSL_HEADER setting must be a tuple containing two values.&apos;</span><br><span class="line">            )</span><br><span class="line">        if self.META.get(header) == value:</span><br><span class="line">            return &apos;https&apos;</span><br><span class="line">    return self._get_scheme()</span><br></pre></td></tr></table></figure>
<p>它会根据django中是否配置了SECURE_PROXY_SSL_HEADER，然后比较和header中传过来的SECURE_PROXY_SSL_HEADER(self.META.get(header))是否相等, 若相等才返回https给前端代理。所以这说明需要做两件事情：</p>
<ol>
<li>一是在django的conf/global_settings.py模板中配置： SECURE_PROXY_SSL_HEADER = (‘HTTP_X_FORWARDED_PROTO’, ‘https’)</li>
<li>二是前端代理apache中的配置传过来名为X-Forwarded-Proto的header: RequestHeader set X-Forwarded-Proto “https”<br>更多见： <a href="https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/" target="_blank" rel="external">https://design.canonical.com/2015/08/django-behind-a-proxy-fixing-absolute-urls/</a></li>
</ol>
<h2 id="OpenStack其他工程和Apache代理之间如何支持SSL"><a href="#OpenStack其他工程和Apache代理之间如何支持SSL" class="headerlink" title="OpenStack其他工程和Apache代理之间如何支持SSL"></a>OpenStack其他工程和Apache代理之间如何支持SSL</h2><p>至于其它openstack工程如nova则需要使用olso.middleware中的http_proxy_to_wsgi.py(<a href="https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto" target="_blank" rel="external">https://github.com/openstack/oslo.middleware/blob/stable/ocata/oslo_middleware/http_proxy_to_wsgi.py)用于解析前端代理apache传过来的X-Forwarded-Proto</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># World before RFC7239</span><br><span class="line">forwarded_proto = req.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">if forwarded_proto:</span><br><span class="line">    req.environ[&apos;wsgi.url_scheme&apos;] = forwarded_proto</span><br></pre></td></tr></table></figure></p>
<p>nova-api中再根据wsgi.url_scheme（<a href="https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443" target="_blank" rel="external">https://github.com/openstack/nova/blob/stable/ocata/nova/api/openstack/urlmap.py）决定是使用80还是ssl的443</a><br><strong>注意: 感觉是nova-api再转发或调用其他服务时如果没X-Forwarded-Proto的话, 之前的https就变成http了.</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if environ[&apos;wsgi.url_scheme&apos;] == &apos;http&apos;:</span><br><span class="line">    port = &apos;80&apos;</span><br><span class="line">else:</span><br><span class="line">    port = &apos;443&apos;</span><br></pre></td></tr></table></figure></p>
<p>配置http_proxy_to_wsgi的方法是在/etc/nova/api-paste.ini中添加http_proxy_to_wsgi（ eg: <a href="https://bugs.launchpad.net/keystone/+bug/1590608" target="_blank" rel="external">https://bugs.launchpad.net/keystone/+bug/1590608</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[composite:openstack_compute_api_v21]</span><br><span class="line">use = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line">noauth2 = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit noauth2 osapi_compute_app_v21</span><br><span class="line">keystone = cors http_proxy_to_wsgi compute_req_id faultwrap sizelimit authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line">[filter:http_proxy_to_wsgi]</span><br><span class="line">paste.filter_factory = oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory</span><br></pre></td></tr></table></figure>
<h2 id="附录-原生OpenStack配置SSL的方法"><a href="#附录-原生OpenStack配置SSL的方法" class="headerlink" title="附录 - 原生OpenStack配置SSL的方法"></a>附录 - 原生OpenStack配置SSL的方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1, Create ssl certifate</span><br><span class="line"></span><br><span class="line">$ sudo keystone-manage ssl_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">$ chown -R keystone:keystone /etc/keystone/ssl</span><br><span class="line">$ sudo ls /etc/keystone/ssl/certs</span><br><span class="line">01.pem	ca.pem	index.txt  index.txt.attr  index.txt.old  keystone.pem	openssl.conf  req.pem  serial  serial.old</span><br><span class="line">$ sudo ls /etc/keystone/ssl/private</span><br><span class="line">cakey.pem  keystonekey.pem</span><br><span class="line"></span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/cakey.pem 1024</span><br><span class="line">openssl req -new -x509 -extensions v3_ca -key /etc/keystone/ssl/private/cakey.pem -out /etc/keystone/ssl/certs/ca.pem -days 3650 -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl genrsa -out /etc/keystone/ssl/private/keystonekey.pem 1024</span><br><span class="line">openssl req -key /etc/keystone/ssl/private/keystonekey.pem -new -out /etc/keystone/ssl/certs/req.pem -config /etc/keystone/ssl/certs/openssl.conf -subj /C=US/ST=Unset/L=Unset/O=Unset/CN=localhost</span><br><span class="line">openssl ca -batch -out /etc/keystone/ssl/certs/keystone.pem -config /etc/keystone/ssl/certs/openssl.conf -days 3650d -cert /etc/keystone/ssl/certs/ca.pem -keyfile /etc/keystone/ssl/private/cakey.pem -infiles /etc/keystone/ssl/certs/req.pem</span><br><span class="line"></span><br><span class="line">2, Keystone ssl configuration</span><br><span class="line"></span><br><span class="line"># vi /etc/keystone/keystone.conf</span><br><span class="line">[signing]</span><br><span class="line">certfile = /var/lib/keystone/juju_ssl/pki/certs/signing_cert.pem</span><br><span class="line">keyfile = /var/lib/keystone/juju_ssl/pki/privates/signing_key.pem</span><br><span class="line">ca_certs = /var/lib/keystone/juju_ssl/pki/certs/ca.pem</span><br><span class="line">ca_key = /var/lib/keystone/juju_ssl/pki/certs/ca_key.pem</span><br><span class="line"></span><br><span class="line">export OS_AUTH_URL=https://&#123;keystoneHost&#125;:5000/v2.0</span><br><span class="line"></span><br><span class="line"># create new https endpoint</span><br><span class="line">keystone endpoint-create</span><br><span class="line">--service keystone --region RegionOne --publicurl</span><br><span class="line">https://&#123;keystoneHost&#125;:5000/v2.0 --internalurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0 --adminurl</span><br><span class="line">https://&#123;keystoneHost&#125;:35357/v2.0</span><br><span class="line"></span><br><span class="line"># delete old http endpoint</span><br><span class="line">keystone –-insecure endpoint-delete &#123;old endpoint id&#125;</span><br><span class="line"></span><br><span class="line">3, Nova ssl configuration</span><br><span class="line"></span><br><span class="line"># configure nova to use https to connect keystone</span><br><span class="line"># vi /etc/nova/api-paste.ini</span><br><span class="line">auth_uri = https://10.1.0.92:5000/v2.0</span><br><span class="line">auth_protocol = https</span><br><span class="line">insecure = True</span><br><span class="line"></span><br><span class="line">service openstack-nova-api restart</span><br><span class="line">service openstack-nova-compute restart</span><br><span class="line">service openstack-nova-scheduler restart</span><br><span class="line">service openstack-nova-cert restart</span><br><span class="line">service openstack-nova-conductor restart</span><br><span class="line">service openstack-nova-consoleauth restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vi /etc/nova/nova.conf [DEFAULT]</span><br><span class="line">enabled_ssl_apis=osapi_compute</span><br><span class="line">ssl_cert_file=/etc/nova/ssl/keystone.pem</span><br><span class="line">ssl_key_file=/etc/nova/ssl/keystonekey.pem</span><br><span class="line"></span><br><span class="line"># test it, at this time other component has not be configured to use https, so use --insecure</span><br><span class="line">nova --insecure hypervisor-list</span><br><span class="line"></span><br><span class="line"># copy ssl certifate for nova</span><br><span class="line"># mkdir /etc/nova/ssl</span><br><span class="line"># cp /etc/keystone/ssl/certs/keystone.pem /etc/nova/ssl/</span><br><span class="line"># cp /etc/keystone/ssl/private/keystonekey.pem /etc/nova/ssl/</span><br><span class="line"># chown -R nova:nova /etc/nova/ssl/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># create new https endpoint for nova</span><br><span class="line"># keystone --insecure</span><br><span class="line">endpoint-create --service nova --region RegionOne --publicurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --internalurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot; --adminurl</span><br><span class="line">&quot;https://&#123;novaHost&#125;:8774/v2/%(tenant_id)s&quot;</span><br></pre></td></tr></table></figure>
<h2 id="20200831更新"><a href="#20200831更新" class="headerlink" title="20200831更新"></a>20200831更新</h2><p>目前自动产生证书的代码已经被删除（<a href="https://review.openstack.org/#/c/560915/），所以只能自定义证书．可以通过下列命令快速搭建ssl" target="_blank" rel="external">https://review.openstack.org/#/c/560915/），所以只能自定义证书．可以通过下列命令快速搭建ssl</a> + horizon + novnc环境.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl:stsstack --num-compute 1 --openstack-dashboard --ssl --nova-console</span><br><span class="line">#modify ./b/ssl/o/nova-console.yaml for the error &apos;relation [&quot;nova-cloud-controller&quot; &quot;memcached&quot;] is defined more than once&apos;</span><br><span class="line">./generate-bundle.sh --name ssl:stsstack --replay --run</span><br></pre></td></tr></table></figure></p>
<p>但是novarc有点问题，source之后只能运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nova --insecure hypervisor-list</span><br></pre></td></tr></table></figure></p>
<p>要想去掉–insecure，还需要：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export OS_CACERT=/home/xxx/openstack/ssl/openstack-ssl/results/cacert.pem</span><br></pre></td></tr></table></figure>
<p>但依然有点问题，唯独horizon没有添加ssl支持，继续：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">ssl_results=/home/ubuntu/stsstack-bundles/openstack/ssl/openstack-ssl/results</span><br><span class="line">juju config openstack-dashboard ssl_ca=`base64 $&#123;ssl_results&#125;/cacert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_cert=`base64 $&#123;ssl_results&#125;/servercert.pem| tr -d &apos;\n&apos;`</span><br><span class="line">juju config openstack-dashboard ssl_key=`base64 $&#123;ssl_results&#125;/serverkey.pem| tr -d &apos;\n&apos;`</span><br></pre></td></tr></table></figure></p>
<p>最后开内网v皮恩之后，访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sshuttle --python=/usr/bin/python2.7 -r ubuntu@bastion 10.5.0.0/16 -D</span><br><span class="line">https://10.5.2.147  #make sure not use proxy, admin_domain/admin/openstack</span><br></pre></td></tr></table></figure></p>
<h2 id="20210127更新-ssl-amp-vault"><a href="#20210127更新-ssl-amp-vault" class="headerlink" title="20210127更新 - ssl &amp; vault"></a>20210127更新 - ssl &amp; vault</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">./generate-bundle.sh -s xenial -r queens --create-model --name ssl:stsstack --num-compute 1 --openstack-dashboard --nova-console --vault</span><br><span class="line">./generate-bundle.sh --name ssl:stsstack --replay --run</span><br><span class="line">./tools/vault-unseal-and-authorise.sh</span><br><span class="line">juju config openstack-dashboard enforce-ssl=true</span><br><span class="line">juju add-relation openstack-dashboard:certificates vault:certificates</span><br><span class="line">juju config nova-cloud-controller console-access-protocol=novnc</span><br><span class="line">./configure</span><br><span class="line">source novarc</span><br><span class="line">openstack --insecure endpoint list</span><br><span class="line">openstack endpoint list</span><br><span class="line">./tools/instance_launch.sh 1 bionic</span><br><span class="line">#add &apos;socks-proxy 127.0.0.1 7078&apos; into openxxx.conf then start it by &apos;openxxx --config xxx.conf --daemon&apos;</span><br><span class="line">#sudo sshuttle --python=/usr/bin/python2.7 -r ubuntu@bastion 10.5.0.0/16 10.0.0.0/16 -l 0.0.0.0:0 -D</span><br><span class="line">#access horizon (NOTE: don&apos;t proxy it in SwitchOmega), and don&apos;t run sshuttle in bastion as well</span><br><span class="line">#https://10.5.2.248  admin_domain/admin/openstack</span><br><span class="line">nova get-vnc-console bionic-032738 novnc</span><br><span class="line">nmap --script ssl-enum-ciphers -p 6080 10.5.1.161</span><br><span class="line"></span><br><span class="line">nova-cloud-controller/0</span><br><span class="line">#https://bugs.launchpad.net/ubuntu/+source/python-eventlet/+bug/1904988</span><br><span class="line">echo &apos;deb http://archive.ubuntu.com/ubuntu/ xenial-proposed restricted main multiverse universe&apos; |sudo tee -a /etc/apt/sources.list</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt-cache policy python-eventlet</span><br><span class="line">sudo apt-get install python-eventlet/xenial-proposed</span><br><span class="line">sudo systemctl restart nova-novncproxy</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/openstack$ nmap --script ssl-enum-ciphers -p 6080 10.5.1.161 |grep -i tlsv</span><br><span class="line">|   TLSv1.0:</span><br><span class="line">|   TLSv1.1:</span><br><span class="line">|   TLSv1.2:</span><br></pre></td></tr></table></figure>
<h2 id="备份网址"><a href="#备份网址" class="headerlink" title="备份网址"></a>备份网址</h2><p><a href="https://zhhuabj.github.io/2018/02/07/OpenStack-SSL/" target="_blank" rel="external">https://zhhuabj.github.io/2018/02/07/OpenStack-SSL/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/06/Set-up-juju-development-env/" rel="next" title="Set up juju development env">
                <i class="fa fa-chevron-left"></i> Set up juju development env
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/09/Libvirt支持的三种CPU模式与热迁移-by-Joshua/" rel="prev" title="Libvirt支持的三种CPU模式与热迁移(by Joshua)">
                Libvirt支持的三种CPU模式与热迁移(by Joshua) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">101</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenStack-Charm如何支持SSL"><span class="nav-number">1.</span> <span class="nav-text">OpenStack Charm如何支持SSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenStack-HA-Charm如何支持SSL"><span class="nav-number">2.</span> <span class="nav-text">OpenStack HA Charm如何支持SSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenStack-Horizon和Apache代理之间如何支持SSL"><span class="nav-number">3.</span> <span class="nav-text">OpenStack Horizon和Apache代理之间如何支持SSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenStack其他工程和Apache代理之间如何支持SSL"><span class="nav-number">4.</span> <span class="nav-text">OpenStack其他工程和Apache代理之间如何支持SSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录-原生OpenStack配置SSL的方法"><span class="nav-number">5.</span> <span class="nav-text">附录 - 原生OpenStack配置SSL的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20200831更新"><span class="nav-number">6.</span> <span class="nav-text">20200831更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20210127更新-ssl-amp-vault"><span class="nav-number">7.</span> <span class="nav-text">20210127更新 - ssl & vault</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#备份网址"><span class="nav-number">8.</span> <span class="nav-text">备份网址</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
