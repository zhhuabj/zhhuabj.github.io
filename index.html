<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/01/Thinkpad-T440p安装Linux的种种问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/01/Thinkpad-T440p安装Linux的种种问题/" itemprop="url">Thinkpad T440p安装Linux的种种问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-01T10:27:18+08:00">
                2021-02-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2014-05-08<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>(<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )<br>Thinkpad T440p里使用了一些最新的硬件，这些硬件厂商对Linux高度不兼容, 下面是安装ubuntu 14.04与win8双系统时遇到的一些问题。<br>1, 要在BIOS（F1键）里disable掉UEFI Security Boot特性, 之前按F12选usb进行安装。<br>   UEFI是下一代的BIOS，它内操置了一些操作系统的公钥，操作系统要用私钥签名，UEFI硬件用公钥检测操作系统的完整性，可信才加载系统。<br>本来是一个很好的技术，但是被微软给滥用了。微软先强制将它自己的公钥加到UEFI DB中，然后再要求厂商预安装Win8之后强制厂商将UEFI Security Boot特性打开，这样就无法安装其他没有公钥的操作系统了，然后强制其它厂商向微软申请公钥，也不允许用户自定义公钥文件。对于一些支持win8的移动硬件，微软甚至都强制不提供disable UEFI Security Boot的开关界面。<br>2, Thinkpad T440p使用了Realtek公司的rtl8192ee 10ec:818b网卡，<br>   root@laptop:/home/hua# lspci -nn |grep Wireless<br>   04:00.0 Network controller [0280]: Realtek Semiconductor Co., Ltd. RTL8192EE PCIe Wireless Network Adapter [10ec:818b]<br>   Realtek公司却没有提供相应的Linux驱动（附录一是一个极不稳定的驱动，基本没法用），也就是目前：<br>   有固件：/lib/firmware/rtlwifi/rtl8192eefw.bin<br>   但无驱动：/lib/modules/3.13.0-24-generic/kernel/drivers/net/wireless/rtlwifi/rtl8192ee/rtl8192ee.ko<br>   Realtec公司的rtl8192ee驱动将出现在linux 3.16版本的内核里，3.16内核目前还没有出，实在没办法解决，只好先又买了个TL-WN725N USB无线网卡对付着用。<br>3, Thinkpad T440p除了主板里的集成显卡以外，还有一个nvidia的显卡，默认使用的是开源的bumblebee驱动，我遇到的会造成这两种问题：<br>   一是例如执行lspci命令之后都会造成所有的usb设备都无法用，如usb网卡，如usb数标。<br>   二是由于acpi call失败造成无法正常关机，且每次造成磁盘数据损坏导致在开机时需要修复</p>
<p>   三是合上电脑再打开桌面消失</p>
<p>   四是发热厉害</p>
<p>   五是不安装它可能启动ubuntu不成功，需要在grub中临时将quiet splash改成nomodeset即可，将nvidea驱动安装后就不需要了。<br>   网上有人遇到了和我一样的问题，见：<a href="https://github.com/Bumblebee-Project/bbswitch/issues/78，但它的办法是在仍然用bumblebee驱动的前提下寻求解决（见附录二），我是直接安装nvidia" target="_blank" rel="external">https://github.com/Bumblebee-Project/bbswitch/issues/78，但它的办法是在仍然用bumblebee驱动的前提下寻求解决（见附录二），我是直接安装nvidia</a> linux驱动（值得一提的是，nvidia也是一个起初对linux极不友好的一家公司，linux之父在公开场合还曾经骂地这家公司，见：<a href="http://www.ithome.com/html/it/19249.htm，但是现在居然有nvidia" target="_blank" rel="external">http://www.ithome.com/html/it/19249.htm，但是现在居然有nvidia</a> linux驱动了，赞一个）。<br>  sudo apt-get purge bumblebee*<br>  sudo apt-get purge libvdpau-va-gl12  sudo apt-get install nvidia-319 nvidia-settings-319 nvidia-prime</p>
<p>20140709更新：</p>
<p>安装nvidia驱动后在移动电脑时桌面lightadm很容易死，可进控制台（ctrl + alt + f1)后通过apport-cli命令收集日志，或者查看/var/crash的相关日志发现是lightadm crash了，现在的做法是禁用掉nvidia的一切驱动，切换到intel的集成显卡，在/etc/default/grub中更新下列一行，然后更新grub</p>
<p>GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash rdblacklist=nouveau i965.modeset=1 nouveau.modeset”</p>
<p>另外我也更新了kernel到3.14.1-031401-generic</p>
<p>附录一，目前极不稳定的一个rtl8192ee linux驱动<br>参考：<a href="http://ubuntuforums.org/showthread.php?t=2198221" target="_blank" rel="external">http://ubuntuforums.org/showthread.php?t=2198221</a><br>wget <a href="http://netbook-remix.archive.canonical.com/updates/pool/public/o/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms_0017.1016.2013~sutton1.tar.gz" target="_blank" rel="external">http://netbook-remix.archive.canonical.com/updates/pool/public/o/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms_0017.1016.2013~sutton1.tar.gz</a><br>sudo modprobe rtl8192ee<br>sudo modprobe -rv rtl8192ee<br>sudo modprobe -v rtl8192ee swenc=1 fwlps=0 ips=0</p>
<p>附录二，仍使用开源的nvidia驱动nouveau的前提下解决acpi问题<br>git clone <a href="https://github.com/mkottman/acpi_call" target="_blank" rel="external">https://github.com/mkottman/acpi_call</a><br>cd acpi_call<br>make<br>sudo cp acpi_call.ko /lib/modules/<code>uname -r</code>/kernel/drivers/acpi<br>sudo depmod -a<br>sudo modprobe acpi_call<br>Create a script with the following in it (e.g. at /usr/local/bin/disable_nvidia.sh, remember chmod +x it):</p>
<p>#!/bin/sh<br>echo “_SB.PCI0.PEG.VID._DSM {0xF8,0xD8,0x86,0xA4,0xDA,0x0B,0x1B,0x47,0x60,0x42,0xA6,0xB5,0xBE,0xE0} 0x100 0x1A {0x1,0x0,0x0,0x3}” &gt;/proc/acpi/call<br>echo “_SB.PCI0.PEG.VID.GPOF” &gt;/proc/acpi/call<br>exit 0<br>Call the script from /etc/rc.local<br>Add rdblacklist=nouveau i965.modeset=1 nouveau.modeset to the GRUB_CMDLINE_LINUX_DEFAULT flags in /etc/default/grub, also for full KVM support (e.g. better brightness control etc.) I’ve found adding acpi_osi=\”!Windows 2012\” helps too.<br>run sudo update-grub</p>
<p>2014-06-21更新：</p>
<p>解决办法已经出来了，见：</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578</a></p>
<p>2014-07-29更新：</p>
<p>有些型号的机器即使像上面disable UEFI Security Boot特性也是安装不了的，那是因为遇到了一个UEFI的bug，原因如下：</p>
<p>Some EFI-based computers, including some HPs, have broken EFIs that<br>don’t accept anything but the fallback boot loader<br>(EFI/boot/bootx64.efi on the EFI System Partition) or the Windows boot<br>loader (EFI/Microsoft/boot/bootmgfw.efi on the ESP). If yours suffers<br>from this defect, you’ll need to copy EFI/ubuntu/grubx64.efi (or<br>EFI/ubuntu/shimx64.efi, if Secure Boot is active) to one or both of<br>those names. (If Secure Boot is active, also copy<br>EFI/ubuntu/grubx64.efi to the same directory where you copy GRUB, but<br>keep its filename as grubx64.efi).</p>
<p>Note that I’m assuming you’re doing an Ubuntu-only installation. If<br>you want to dual-boot with Windows, you’ve got to copy ITS boot loader<br>to another name and tweak GRUB to find Windows there. This starts to<br>get complex, so the Boot Repair tool<br>(<a href="https://help.ubuntu.com/community/Boot-Repair" target="_blank" rel="external">https://help.ubuntu.com/community/Boot-Repair</a>) may be helpful. It’s<br>got an option to do all this on its Advanced page.</p>
<p>Alternatively, you could install  rEFInd<br>(<a href="http://www.rodsbooks.com/refind" target="_blank" rel="external">http://www.rodsbooks.com/refind</a>) to one of those “magic” locations –<br>but the installation script won’t install there by default, so you’ll<br>need to do it manually or juggle filenames afterwards. (The<br>mvrefind.sh script can help with that.)</p>
<p>2014-12-01更新：</p>
<p>现在ubuntu 14.10默认的内核版本里已经有该网卡的驱动了，我已经用上了，挺好使的。见： <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578</a></p>
<p>2015-03-02更新, 解决一crash问题：</p>
<p>之前一直感觉系统容易忽然死机，可能一周一次，没去管它。但今天居然邪门到一个小时内死机6次，不得不深度介入了。根据观察，感觉是Chrome的时候容易死，使用“watch sensors” （需安装sudo dpkg -l |grep sensors 软件包）查看cpu温度在打开chrome之非常容易从56度升到八十几度。于是，不启动chrome，观察两小时，ok，不死机。于是google关键字”ubuntu 14.10 chrome crash”， 非常幸运，找到一个bug （<a href="https://bugs.launchpad.net/ubuntu/+source/mesa/+bug/1377220" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/mesa/+bug/1377220</a> ），原来是chrome新增加了一个根据gpu加速的新特性，针对intel gpu加速不了，退到软加速了，从而导致全局crash的问题。解决办法：修改文件/usr/share/applications/google-chrome.desktop， 将”Exec=/usr/bin/google-chrome-stable”修改成” Exec=env LIBGL_DRI3_DISABLE=1 /usr/bin/google-chrome-stable”即可。</p>
<p>2015-03-03， 像上面那样修改之后，使用htop命令还能看到chrome时不时有gpu字眼的进程蹦出来，这时候温度会上升，于是升级了内核为3.40版本，<a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/</a></p>
<p>20180216更新 - 禁用蓝牙键盘的休眠功能</p>
<p><a href="https://unix.stackexchange.com/questions/177998/bluetooth-mouse-disconnects" target="_blank" rel="external">https://unix.stackexchange.com/questions/177998/bluetooth-mouse-disconnects</a></p>
<p>sudo sed -i ‘s/#IdleTimeout=30/IdleTimeout=0/‘ /etc/bluetooth/input.conf</p>
<p>#$ cat /etc/udev/rules.d/91-local.rules</p>
<p>#ACTION==”add”, SUBSYSTEM==”bluetooth”, ATTR{product}==”Microsoft Bluetooth Mouse        “, ATTR{power/control}=”on”</p>
<p>#sudo udevadm control –reload-rules</p>
<p>sudo apt-get install pulseaudio-module-bluetooth<br>killall pulseaudio<br>rfkill list<br>rfkill unblock xx</p>
<p>20180822更新 - chrome花屏问题</p>
<p>昨晚将ubuntu 16.04升级到ubuntu 18.04之后, 今早发现使用chrome时有轻微花屏, 网上搜索了好多网页都不能解决问题, 最后发现了这个网页(<a href="https://blog.csdn.net/u010665691/article/details/44114119)解决了问题" target="_blank" rel="external">https://blog.csdn.net/u010665691/article/details/44114119)解决了问题</a>. 即在chrome的高级设置中将’Use hardware acceleration when available’前的勾去掉.</p>
<p>20181017更新 - IBM小红点TrackPoint休眠后左键失效问题</p>
<p>注: 其实下面的方法一个也不使, 真正解决问题的是这条命令: </p>
<p>gsettings set org.gnome.desktop.peripherals.touchpad click-method disabled</p>
<p>自从将Ubuntu从16.04升级到18.04之后, 在电脑休眠之后会发现小红点左键失效, 今天终于解决这个头疼的问题. 方法如下:</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1791427" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1791427</a><br><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1788928" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1788928</a></p>
<p>1, comment the line ‘blacklist i2c_i80’ from the file /etc/modprobe.d/blacklist.conf due to the lp bug #1786574</p>
<p>2, configure the management tool tlp not to autosuspend usb<br>$ grep -r ‘USB_AUTO’ /etc/default/tlp<br>USB_AUTOSUSPEND=0<br>USB_AUTOSUSPEND_DISABLE_ON_SHUTDOWN=1</p>
<p>3, upgrade libinput from the page <a href="https://launchpad.net/ubuntu/+source/libinput" target="_blank" rel="external">https://launchpad.net/ubuntu/+source/libinput</a><br>wget <a href="https://launchpad.net/ubuntu/+archive/primary/+files/libinput-bin_1.12.1-1_amd64.deb" target="_blank" rel="external">https://launchpad.net/ubuntu/+archive/primary/+files/libinput-bin_1.12.1-1_amd64.deb</a><br>wget <a href="https://launchpad.net/ubuntu/+archive/primary/+files/libinput10_1.12.1-1_amd64.deb" target="_blank" rel="external">https://launchpad.net/ubuntu/+archive/primary/+files/libinput10_1.12.1-1_amd64.deb</a><br>sudo dpkg -i libinput*</p>
<p>4, <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1560723" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1560723</a></p>
<p>$ sudo chmod 755 /lib/systemd/system-sleep/trackpad<br>$ cat /lib/systemd/system-sleep/trackpad</p>
<p>#!/bin/sh<br>if [ “${1}” == “post” ]; then<br>  echo -n none &gt; /sys/devices/platform/i8042/serio1/drvctl<br>  sleep 1<br>  echo -n reconnect &gt; /sys/devices/platform/i8042/serio1/drvctl<br>fi</p>
<p>5, <a href="https://medium.com/@pck/ubuntu-18-04-fix-for-right-click-not-working-touchpad-issues-40037ff249e1" target="_blank" rel="external">https://medium.com/@pck/ubuntu-18-04-fix-for-right-click-not-working-touchpad-issues-40037ff249e1</a><br>sudo apt install gnome-tweak-tool<br>$ gsettings get org.gnome.desktop.peripherals.touchpad click-method<br>‘fingers’<br>gsettings set org.gnome.desktop.peripherals.touchpad click-method disabled<br>It equals run the command ‘gnome-tweaks’, navigate to the “Keyboard &amp; Mouse” sub-menu in the left menu, and select “Area” from the the touchpad’s “Click Emulation” menu in the right side panel.<br>Also configure Touchpad disable when typing - <a href="https://askubuntu.com/questions/1052665/touchpad-not-getting-disabled-while-typing-on-thinkpad-e450-with-ubuntu-18-04" target="_blank" rel="external">https://askubuntu.com/questions/1052665/touchpad-not-getting-disabled-while-typing-on-thinkpad-e450-with-ubuntu-18-04</a></p>
<p>20201107更新</p>
<p>chrome上网慢用fast.com测速在30K到18M之间不稳定，而用firefox总有69M，但重启机器后，chrome恢复到94M左右。</p>
<p>20210201更新</p>
<p>机器太慢，报：</p>
<p>Feb 1 09:36:48 t440p gnome-shell[3675]: libinput error: client bug: timer event25 debounce: scheduled expiry is in the past (-6ms), your system is too slow</p>
<p>perf data显示它和chrom有关，故设置：</p>
<p>chrome://settings/?search=hardware selects ‘Use hardware acceleration when available’<br>chrome://flags/#disable-accelerated-video-decode selects ‘Hardware-accelerated video decode’</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/30/OpenStack-MTU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/30/OpenStack-MTU/" itemprop="url">OpenStack MTU</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-30T10:31:56+08:00">
                2021-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需要设置mtu的设备类型"><a href="#需要设置mtu的设备类型" class="headerlink" title="需要设置mtu的设备类型"></a>需要设置mtu的设备类型</h2><p>openstack中总共有6种网络设备需要设置mtu:</p>
<ul>
<li>物理交换机和路由, eg: 5000， 手工设置</li>
<li>物理网卡, eg: 5000， nova vif根据network.mtu设置（见最后一节）</li>
<li>隧道接口, eg: 4958, nova vif根据network.mtu设置（见最后一节）</li>
<li>虚机接口, eg: 4958, nova vif根据network.mtu设置（见最后一节）</li>
<li>虚机与br-int之间的peer口由l2-agent中的ovs_use_veth, use_veth_interconnection, veth_mtu三个参数控制。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if self.use_veth_interconnection:</span><br><span class="line">    # enable veth to pass traffic</span><br><span class="line">    int_veth.link.set_up()</span><br><span class="line">    phys_veth.link.set_up()</span><br><span class="line">    if self.veth_mtu:</span><br><span class="line">        # set up mtu size for veth interfaces</span><br><span class="line">        int_veth.link.set_mtu(self.veth_mtu)</span><br><span class="line">        phys_veth.link.set_mtu(self.veth_mtu)</span><br><span class="line">else:</span><br><span class="line">    # associate patch ports to pass traffic</span><br><span class="line">    self.int_br.set_db_attribute(&apos;Interface&apos;, int_if_name,</span><br><span class="line">                                 &apos;options&apos;, &#123;&apos;peer&apos;: phys_if_name&#125;)</span><br><span class="line">    br.set_db_attribute(&apos;Interface&apos;, phys_if_name,</span><br><span class="line">                        &apos;options&apos;, &#123;&apos;peer&apos;: int_if_name&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>虚机里面的虚机网卡, eg: 4958， 如果network中有mtu值，则用于设置dnsmasq。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mtu = getattr(self.network, &apos;mtu&apos;, 0)</span><br><span class="line">if mtu &gt; 0:</span><br><span class="line">    cmd.append(&apos;--dhcp-option-force=option:mtu,%d&apos; % mtu)</span><br></pre></td></tr></table></figure>
<h2 id="四个和mtu相关的配置"><a href="#四个和mtu相关的配置" class="headerlink" title="四个和mtu相关的配置"></a>四个和mtu相关的配置</h2><ol>
<li>Flat/VLAN：Minimum of (global_physnet_mtu or physical_network_mtus)</li>
<li>GRE: Minimum of (global_physnet_mtu, path_mtu) subtract 42</li>
<li>VXLAN: Minimum of (global_physnet_mtu, path_mtu) subtract 50</li>
</ol>
<p>一个例子(neutron.conf)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In the neutron.conf file:</span><br><span class="line">[DEFAULT]</span><br><span class="line">global_physnet_mtu = 9000</span><br><span class="line"></span><br><span class="line">In the openvswitch_agent.ini file:</span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = provider1:eth1,provider2:eth2,provider3:eth3</span><br><span class="line"></span><br><span class="line">In the ml2_conf.ini file:</span><br><span class="line">[ml2]</span><br><span class="line">physical_network_mtus = provider2:4000,provider3:1500</span><br><span class="line">path_mtu = 9000</span><br></pre></td></tr></table></figure>
<ol>
<li>physical_network_mtus，仅用于flat与vlan，用于设置物理网络</li>
<li>path_mtu, tenant网络最大可能的mtu，下段代码位于type_tunnel中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_mtu(self, physical_network=None):</span><br><span class="line">    seg_mtu = super(_TunnelTypeDriverBase, self).get_mtu()</span><br><span class="line">    mtu = []</span><br><span class="line">    if seg_mtu &gt; 0:</span><br><span class="line">        mtu.append(seg_mtu)</span><br><span class="line">    if cfg.CONF.ml2.path_mtu &gt; 0:</span><br><span class="line">        mtu.append(cfg.CONF.ml2.path_mtu)</span><br><span class="line">    version = cfg.CONF.ml2.overlay_ip_version</span><br><span class="line">    ip_header_length = p_const.IP_HEADER_LENGTH[version]</span><br><span class="line">    return min(mtu) - ip_header_length if mtu else 0</span><br></pre></td></tr></table></figure>
<ol>
<li>global_physnet_mtu, tenant网络默认的mtu，下列代码中的mtus是来自min(physical_network_mtus, min(path_mtu) - ip_header_length）， get_deployment_physnet_mtu来自global_physnet_mtu，如果没定义physical_network_mtus，则使用默认值global_physnet_mtu，然后用它设置network对象的mtu字段。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">max_mtu = min(mtus) if mtus else p_utils.get_deployment_physnet_mtu()</span><br><span class="line">net_mtu = network_db.get(&apos;mtu&apos;)</span><br><span class="line"># if mtu is not set in database, use the maximum possible</span><br><span class="line">return net_mtu or max_mtu</span><br></pre></td></tr></table></figure>
<ol>
<li>network_device_mtu, 位于os-vif包中，network中没有mtu值时（neutron net-show <net> |grep mtu），用它来决定虚机接口</net></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def _get_mtu(self, vif):</span><br><span class="line">    if vif.network and vif.network.mtu:</span><br><span class="line">        return vif.network.mtu</span><br><span class="line">    return self.config.network_device_mtu</span><br></pre></td></tr></table></figure>
<h2 id="nova-vif"><a href="#nova-vif" class="headerlink" title="nova vif"></a>nova vif</h2><p>上面的参数最终算出了network.mtu, nova vif (LibvirtGenericVIFDriver)需要根据这个值去设置上述的物理网卡，隧道接口，虚机接口的mtu值。但是最新代码似乎没有为ovs类型的虚拟接口设置mtu，这应该是一个bug。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>手动给ovs port设置mtu的命令如下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl --columns=mtu_request list interface</span><br><span class="line">ovs-vsctl set Interface tapddcb4e7e-88 mtu_request=1501</span><br></pre></td></tr></table></figure>
<ol>
<li>检查mtu命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -M do -i 1 -c 2 -s 5000 10.230.56.18</span><br></pre></td></tr></table></figure>
<h2 id="metadata中的mtu问题"><a href="#metadata中的mtu问题" class="headerlink" title="metadata中的mtu问题"></a>metadata中的mtu问题</h2><p>有时候　iptables -t mangle -A PREROUTING -i ns-+ -p tcp –dport 80 -j CHECKSUM –checksum-fill<br>有时候　<a href="https://review.opendev.org/c/openstack/neutron/+/656359" target="_blank" rel="external">https://review.opendev.org/c/openstack/neutron/+/656359</a><br>有时候用了dpdk口，有时候用的却是bridge口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tshark -r ns-43cbdb54-9b &apos;ip.addr==169.254.169.254&apos;</span><br><span class="line">237 86.852258 10.243.164.13 → 169.254.169.254 TCP 74 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999115463 TSecr=0 WS=128</span><br><span class="line">242 87.868631 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999116479 TSecr=0 WS=128</span><br><span class="line">248 89.884108 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999118495 TSecr=0 WS=128</span><br><span class="line">263 94.012172 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999122623 TSecr=0 WS=128</span><br><span class="line">$ tshark -r ns-4ae73fdc-5f &apos;ip.addr==169.254.169.254&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://blog.csdn.net/quqi99/article/details/15029501" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/15029501</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/30/使用OVS-DPDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/30/使用OVS-DPDK/" itemprop="url">使用OVS DPDK</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-30T10:17:17+08:00">
                2021-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-04-07<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>硬件要求<br>网卡得支持DPDK，见：<a href="http://dpdk.org/doc/nics" target="_blank" rel="external">http://dpdk.org/doc/nics</a></p>
<p>CPU得支持DPDK, 测试命令：cat  /proc/cpuinfo |grep pdpe1gb</p>
<p>不一定非要支持DPDK硬件的网卡才能做实验，因为DPDK也支持virtio dpdk driver.</p>
<p>打开大页支持<br>hua@node1:~$ cat  /etc/default/grub |grep GRUB_CMDLINE_LINUX<br>GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash intel_iommu=on pci=assign-busses”<br>GRUB_CMDLINE_LINUX=”transparent_hugepage=never hugepagesz=2M hugepages=64 default_hugepagesz=2M”</p>
<p>vi /etc/fstab<br>nodev /mnt/huge hugetlbfs pagesize=2MB 0 0</p>
<p>sudo update-grub<br>sudo mkdir -p /mnt/huge<br>sudo reboot<br>hua@node1:~$ cat /proc/meminfo |grep HugePages_<br>HugePages_Total:       64<br>HugePages_Free:        64<br>HugePages_Rsvd:        0</p>
<p>HugePages_Surp:        0</p>
<p>hua@node1:~$ grep Hugepagesize /proc/meminfo<br>Hugepagesize:       2048 kB</p>
<p>配置网卡使用uio_pci_generic驱动,  #注意：实验发现，对于sr-iov网卡，此处必须是PF，PF试验成功，VF试验不成功。所以虚机可以使用PF去做DPDK port，也可以直接直通方式使用VF。</p>
<p>至于PF的驱动，可以使用ixgbe，也可以使用DPDK PF driver；对于VF的驱动，可以使用ixgbefv，也可以使用DPDK VF driver. 如果要使用DPDK PF driver需在grub中加上iommu=pt.</p>
<p>它们之间也可以通信：</p>
<p>hua@node1:~$  sudo modprobe uio_pci_generic</p>
<p>hua@node1:~$ sudo dpdk_nic_bind –status</p>
<h1 id="Network-devices-using-DPDK-compatible-driver"><a href="#Network-devices-using-DPDK-compatible-driver" class="headerlink" title="Network devices using DPDK-compatible driver"></a>Network devices using DPDK-compatible driver</h1><none>

<h1 id="Network-devices-using-kernel-driver"><a href="#Network-devices-using-kernel-driver" class="headerlink" title="Network devices using kernel driver"></a>Network devices using kernel driver</h1><p>0000:00:19.0 ‘Ethernet Connection I217-V’ if=eth0 drv=e1000e unused=uio_pci_generic <em>Active</em><br>0000:05:00.0 ‘82576 Gigabit Network Connection’ if=eth1 drv=igb unused=uio_pci_generic <em>Active</em><br>0000:05:00.1 ‘82576 Gigabit Network Connection’ if=eth2 drv=igb unused=uio_pci_generic <em>Active</em></p>
<h1 id="Other-network-devices"><a href="#Other-network-devices" class="headerlink" title="Other network devices"></a>Other network devices</h1><p>0000:06:10.0 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.1 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.2 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.3 ‘82576 Virtual Function’ unused=uio_pci_generic</p>
<p>hua@node1:~$ sudo dpdk_nic_bind -b uio_pci_generic 0000:05:00.0<br>Routing table indicates that interface 0000:05:00.0 is active. Not modifying</p>
<p>hua@node1:~$ sudo ifconfig eth1 down<br>hua@node1:~$ sudo dpdk_nic_bind -b uio_pci_generic 0000:05:00.0</p>
<p>hua@node1:~$ sudo dpdk_nic_bind –status</p>
<h1 id="Network-devices-using-DPDK-compatible-driver-1"><a href="#Network-devices-using-DPDK-compatible-driver-1" class="headerlink" title="Network devices using DPDK-compatible driver"></a>Network devices using DPDK-compatible driver</h1><p>0000:05:00.0 ‘82576 Gigabit Network Connection’ drv=uio_pci_generic unused=</p>
<h1 id="Network-devices-using-kernel-driver-1"><a href="#Network-devices-using-kernel-driver-1" class="headerlink" title="Network devices using kernel driver"></a>Network devices using kernel driver</h1><p>0000:00:19.0 ‘Ethernet Connection I217-V’ if=eth0 drv=e1000e unused=uio_pci_generic <em>Active</em><br>0000:05:00.1 ‘82576 Gigabit Network Connection’ if=eth2 drv=igb unused=uio_pci_generic <em>Active</em></p>
<h1 id="Other-network-devices-1"><a href="#Other-network-devices-1" class="headerlink" title="Other network devices"></a>Other network devices</h1><p>0000:06:10.1 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.3 ‘82576 Virtual Function’ unused=uio_pci_generic</p>
<p>配置OVS使用DPDK<br>hua@node1:~$ cat /etc/default/openvswitch-switch |grep DPDK<br>DPDK_OPTS=’–dpdk -c 0x1 -n 2’</p>
<p>hua@node1:~$ sudo update-alternatives –set ovs-vswitchd /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk<br>update-alternatives: using /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk to provide /usr/sbin/ovs-vswitchd (ovs-vswitchd) in manual mode</p>
<p>hua@node1:~$ sudo stop openvswitch-switch; sudo start openvswitch-switch</p>
<p>hua@node1:~$ cat /var/log/openvswitch/ovs-ctl.log |grep dpdk</p>
<p>有一个bug设置了DPDK_OPTS不生效，见：<a href="https://bugs.launchpad.net/ubuntu/+source/openvswitch-dpdk/+bug/1547463，" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/openvswitch-dpdk/+bug/1547463，</a> 做了这些改动：</p>
<p>vi /etc/default/openvswitch-switch<br>DPDK_OPTS=’–dpdk -c 0x1 -n 4’</p>
<p>vi /etc/init/openvswitch-switch.conf</p>
<h1 id="To-enable-openvswitch-dpdk"><a href="#To-enable-openvswitch-dpdk" class="headerlink" title="To enable openvswitch-dpdk"></a>To enable openvswitch-dpdk</h1><p>  if test X”$DPDK_OPTS” != X; then<br>    set “$@” DPDK_OPTS=”$DPDK_OPTS”<br>  fi</p>
<p>vi /usr/share/openvswitch/scripts/ovs-ctl<br>            set ovs-vswitchd<br>                if test X”$DPDK_OPTS” != X; then<br>                        set “$@” $DPDK_OPTS –<br>                fi<br>                set “$@” unix:”$DB_SOCK”</p>
<p>但在/var/log/openvswitch/ovs-ctl.log中仍然发现了下列错误，估计是ovs-vswitchd (Open vSwitch) 2.4.0版本（dpkg -l openvswitch-switch-dpdk）不支持–dpdk-opts参数吧。 </p>
<p>/usr/share/openvswitch/scripts/ovs-ctl: unknown option “–dpdk-opts=-c 0x1 -n 4” (use –help for help)</p>
<p>为避免上述ovs的bug，我们改用下列三个命令启动：</p>
<p>sudo restart openvswitch-switch</p>
<p>sudo killall ovs-vswitchd</p>
<p>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach</p>
<p>or</p>
<p>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 –socket-mem 128,0 – unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info –mlockall –no-chdir –log-file=/var/log/openvswitch/ovs-vswitchd.log –pidfile=/var/run/openvswitch/ovs-vswitchd.pid –detach –monitor</p>
<p>但仍然有下列错误。估计是保留的大页数目太少所致，后来将GRUB_CMDLINE_LINUX=”transparent_hugepage=never hugepagesz=2M hugepages=64 default_hugepagesz=2M”中的hugepages从4改成64这个错误就翻过去了。</p>
<p>hua@node1:~$ sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach<br>2016-04-07T11:48:03Z|00001|dpdk|INFO|No -cuse_dev_name provided - defaulting to vhost-net<br>EAL: Detected lcore 0 as core 0 on socket 0<br>EAL: Detected lcore 1 as core 1 on socket 0<br>EAL: Detected lcore 2 as core 2 on socket 0<br>EAL: Detected lcore 3 as core 3 on socket 0<br>EAL: Support maximum 128 logical core(s) by configuration.<br>EAL: Detected 4 lcore(s)<br>EAL: No free hugepages reported in hugepages-1048576kB<br>EAL: Setting up memory…<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f8609a00000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x400000 bytes<br>EAL: Virtual area found at 0x7f8609400000 (size = 0x400000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f8609000000 (size = 0x200000)<br>EAL: Requesting 4 pages of size 2MB from socket 0<br>EAL: rte_eal_common_log_init(): cannot create log_history mempool<br>PANIC in rte_eal_init():<br>Cannot init logs<br>7: [ovs-vswitchd() [0x40b053]]<br>6: [/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf5) [0x7f860acc9ec5]]<br>5: [ovs-vswitchd() [0x40a059]]<br>4: [ovs-vswitchd() [0x639db1]]<br>3: [ovs-vswitchd() [0x43f7ad]]<br>2: [ovs-vswitchd() [0x407bad]]<br>1: [ovs-vswitchd() [0x444e58]]</p>
<p>hua@node1:~$ sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach<br>2016-04-07T13:57:08Z|00001|dpdk|INFO|No -cuse_dev_name provided - defaulting to vhost-net<br>EAL: Detected lcore 0 as core 0 on socket 0<br>EAL: Detected lcore 1 as core 1 on socket 0<br>EAL: Detected lcore 2 as core 2 on socket 0<br>EAL: Detected lcore 3 as core 3 on socket 0<br>EAL: Support maximum 128 logical core(s) by configuration.<br>EAL: Detected 4 lcore(s)<br>EAL: No free hugepages reported in hugepages-1048576kB<br>EAL: VFIO modules not all loaded, skip VFIO support…<br>EAL: Setting up memory…<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72a00000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72600000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72200000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x1a00000 bytes<br>EAL: Virtual area found at 0x7f2f70600000 (size = 0x1a00000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f70200000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x5c00000 bytes<br>EAL: Virtual area found at 0x7f2f6a400000 (size = 0x5c00000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f6a000000 (size = 0x200000)<br>EAL: Requesting 64 pages of size 2MB from socket 0<br>EAL: TSC frequency is ~3292375 KHz<br>EAL: Master lcore 0 is ready (tid=74e2bb40;cpuset=[0])<br>PMD: ENICPMD trace: rte_enic_pmd_init<br>EAL: PCI device 0000:05:00.0 on NUMA socket -1<br>EAL:   probe driver: 8086:10c9 rte_igb_pmd<br>EAL:   PCI memory mapped at 0x7f2f72c00000<br>EAL:   PCI memory mapped at 0x7f2f72c20000<br>EAL:   PCI memory mapped at 0x7f2f72c60000<br>PMD: eth_igb_dev_init(): port_id 0 vendorID=0x8086 deviceID=0x10c9<br>EAL: PCI device 0000:05:00.1 on NUMA socket -1<br>EAL:   probe driver: 8086:10c9 rte_igb_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>EAL: PCI device 0000:06:10.1 on NUMA socket -1<br>EAL:   probe driver: 8086:10ca rte_igbvf_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>EAL: PCI device 0000:06:10.3 on NUMA socket -1<br>EAL:   probe driver: 8086:10ca rte_igbvf_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>Zone 0: name:<malloc_s0_heap_0>, phys:0xd6c00000, len:0xb00000, virt:0x7f2f70600000, socket_id:0, flags:0<br>Zone 1: name:<rg_mp_log_history>, phys:0x2200000, len:0x2080, virt:0x7f2f72a00000, socket_id:0, flags:0<br>Zone 2: name:<mp_log_history>, phys:0xd7700000, len:0x28a0c0, virt:0x7f2f71100000, socket_id:0, flags:0<br>Zone 3: name:<rte_eth_dev_data>, phys:0x2202080, len:0x1f400, virt:0x7f2f72a02080, socket_id:0, flags:0<br>2016-04-07T13:57:09Z|00002|ovs_numa|INFO|Discovered 4 CPU cores on NUMA node 0<br>2016-04-07T13:57:09Z|00003|ovs_numa|INFO|Discovered 1 NUMA nodes and 4 CPU cores<br>2016-04-07T13:57:09Z|00004|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connecting…<br>VHOST_CONFIG: socket created, fd:17<br>VHOST_CONFIG: bind to vhost-net<br>2016-04-07T13:57:09Z|00005|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connected<br>2016-04-07T13:57:09Z|00006|ofproto_dpif|INFO|system@ovs-system: Datapath supports recirculation<br>2016-04-07T13:57:09Z|00007|ofproto_dpif|INFO|system@ovs-system: MPLS label stack length probed as 1<br>2016-04-07T13:57:09Z|00008|ofproto_dpif|INFO|system@ovs-system: Datapath supports unique flow ids<br>2016-04-07T13:57:09Z|00009|bridge|INFO|bridge br-ex: added interface br-ex on port 65534<br>2016-04-07T13:57:09Z|00010|bridge|INFO|bridge br-ex: added interface qg-5786befb-c3 on port 1<br>2016-04-07T13:57:09Z|00011|bridge|INFO|bridge br-tun: added interface patch-int on port 1<br>2016-04-07T13:57:09Z|00012|bridge|INFO|bridge br-tun: added interface br-tun on port 65534<br>2016-04-07T13:57:09Z|00013|bridge|INFO|bridge br-int: added interface tap140d04f3-58 on port 22<br>2016-04-07T13:57:09Z|00014|bridge|INFO|bridge br-int: added interface tap6a12dfe3-40 on port 20<br>2016-04-07T13:57:09Z|00015|bridge|INFO|bridge br-int: added interface tap1ea7e391-73 on port 21<br>2016-04-07T13:57:09Z|00016|bridge|INFO|bridge br-int: added interface tapdc1b7683-4e on port 14<br>2016-04-07T13:57:09Z|00017|bridge|INFO|bridge br-int: added interface patch-tun on port 182<br>2016-04-07T13:57:09Z|00018|bridge|INFO|bridge br-int: added interface tap23e3a388-68 on port 11<br>2016-04-07T13:57:09Z|00019|bridge|INFO|bridge br-int: added interface int-br-phy on port 1<br>2016-04-07T13:57:09Z|00020|bridge|INFO|bridge br-int: added interface tap935ec68a-1a on port 12<br>2016-04-07T13:57:09Z|00021|bridge|INFO|bridge br-int: added interface tap2ca9e4a0-67 on port 7<br>2016-04-07T13:57:09Z|00022|bridge|INFO|bridge br-int: added interface tapcc6c6a9e-f2 on port 13<br>2016-04-07T13:57:09Z|00023|bridge|INFO|bridge br-int: added interface tap4751f42a-65 on port 10<br>2016-04-07T13:57:09Z|00024|bridge|INFO|bridge br-int: added interface br-int on port 65534<br>2016-04-07T13:57:09Z|00025|bridge|INFO|bridge br-int: added interface tapdde9820f-58 on port 9<br>2016-04-07T13:57:09Z|00026|bridge|WARN|could not open network device br100 (No such device)<br>2016-04-07T13:57:09Z|00027|bridge|INFO|bridge br-phy: added interface phy-br-phy on port 3<br>2016-04-07T13:57:09Z|00028|bridge|INFO|bridge br-phy: added interface br-phy on port 65534<br>2016-04-07T13:57:09Z|00029|bridge|INFO|bridge br-ex: using datapath ID 0000de7e48588f4c<br>2016-04-07T13:57:09Z|00030|connmgr|INFO|br-ex: added service controller “punix:/var/run/openvswitch/br-ex.mgmt”<br>2016-04-07T13:57:09Z|00031|bridge|INFO|bridge br-tun: using datapath ID 00007a84c20ae149<br>2016-04-07T13:57:09Z|00032|connmgr|INFO|br-tun: added service controller “punix:/var/run/openvswitch/br-tun.mgmt”<br>2016-04-07T13:57:09Z|00033|bridge|INFO|bridge br-int: using datapath ID 00008e56b225c748<br>2016-04-07T13:57:09Z|00034|connmgr|INFO|br-int: added service controller “punix:/var/run/openvswitch/br-int.mgmt”<br>2016-04-07T13:57:09Z|00035|bridge|INFO|bridge br-phy: using datapath ID 00000255fc61864b<br>2016-04-07T13:57:09Z|00036|connmgr|INFO|br-phy: added service controller “punix:/var/run/openvswitch/br-phy.mgmt”<br>2016-04-07T13:57:09Z|00001|ofproto_dpif_upcall(handler15)|INFO|received packet on unassociated datapath port 0</rte_eth_dev_data></mp_log_history></rg_mp_log_history></malloc_s0_heap_0></p>
<p>测试<br>sudo ovs-vsctl ovsbr0 br-int<br>sudo ovs-vsctl set bridge ovsbr0 datapath_type=netdev</p>
<p>sudo ovs-vsctl add-port ovsbr0 dpdk0 – set Interface dpdk0 type=dpdk  #Port name shoud begin with dpdk</p>
<p>给虚机创建普通ovs port:</p>
<p>sudo ovs-vsctl add-port ovsbr0 intP1 – set Interface intP1 type=internal<br>sudo ip addr add 192.168.10.129/24 dev intP1<br>sudo ip link set dev intP1 up<br>sudo tcpdump -i intP1​</p>
<p>或给虚机创建vhost-user port:</p>
<p>sudo ovs-vsctl add-port ovsbr0 vhost-user2 – set Interface vhost-user2 type=dpdkvhostuser</p>
<p>虚机使用vhost-user port</p>
<p>sudo qemu-system-x86_64 -enable-kvm -m 128 -smp 2 \<br>    -chardev socket,id=char0,path=/var/run/openvswitch/vhost-user1 \<br>    -netdev type=vhost-user,id=mynet1,chardev=char0,vhostforce \<br>    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \<br>    -object memory-backend-file,id=mem,size=128M,mem-path=/mnt/huge,share=on \<br>    -numa node,memdev=mem -mem-prealloc \<br>    -net user,hostfwd=tcp::10021-:22 -net nic \<br>    /bak/images/openstack_demo.img</p>
<p>Inside VM: sudo ifconfig eth0 192.168.9.108/24</p>
<p>使用vhost-user方式可如下图所示：</p>
<p>dpdk-virtio-net</p>
<p>与Neutron的集成</p>
<p>​</p>
<p>nova已经支持vhost-user与hugepages特性，显然在nova.conf应该打开。</p>
<h1 id="then-the-OVS-ML2-driver-will-use-the-vhost-user-VIF-type-and-pass-the-necessary-binding-details-to-use-OVS-DPDK-and-vhost-user-sockets"><a href="#then-the-OVS-ML2-driver-will-use-the-vhost-user-VIF-type-and-pass-the-necessary-binding-details-to-use-OVS-DPDK-and-vhost-user-sockets" class="headerlink" title="then the OVS ML2 driver will use the vhost-user VIF type and pass the necessary binding details to use OVS+DPDK and vhost-user sockets."></a>then the OVS ML2 driver will use the vhost-user VIF type and pass the necessary binding details to use OVS+DPDK and vhost-user sockets.</h1><p>[OVS]<br>datapath_type=netdev<br>vhostuser_socket_dir=/var/run/openvswitch<br>[libvirt]<br>use_hugepages = True</p>
<p>另外，应该手工创建上述的ovsbr0，然后在/etc/neutron/plugins/ml2/ml2_conf.ini指定使用ovsbr0作为provider network.</p>
<p>[ovs]<br>bridge_mappings = default:ovsbr0</p>
<p>dpdk与neutron集成的工程叫networking-ovs-dpdk，在devstack加下列一行可使用devstack创建ovs dpdk环境。</p>
<p>enable_plugin networking-ovs-dpdk <a href="https://github.com/openstack/networking-ovs-dpdk" target="_blank" rel="external">https://github.com/openstack/networking-ovs-dpdk</a> master</p>
<p>整个运行命令</p>
<p>sudo add-apt-repository cloud-archive:mitaka</p>
<p>sudo apt-get install openvswitch-switch-dpdk</p>
<p>sudo modprobe vfio-pci<br>sudo chmod a+x /dev/vfio<br>sudo chmod 0666 /dev/vfio/*<br>sudo ifconfig eth1 down<br>sudo dpdk_nic_bind -b vfio-pci eth1  #注意：实验发现，对于sr-iov网卡，此处必须是PF，PF试验成功，VF试验不成功。</p>
<p>find /sys/kernel/iommu_groups/ -type l<br>sudo sysctl -w vm.nr<em>hugepages=256<br>cat /proc/meminfo |grep HugePages</em></p>
<p>sudo restart openvswitch-switch<br>sudo update-alternatives –set ovs-vswitchd /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk<br>sudo killall ovs-vswitchd<br>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 –socket-mem 128,0 – unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info –mlockall –no-chdir –log-file=/var/log/openvswitch/ovs-vswitchd.log –pidfile=/var/run/openvswitch/ovs-vswitchd.pid –detach –monitor<br>ps -ef|grep dpdk</p>
<p>sudo qemu-system-x86_64 -enable-kvm -m 128 -smp 2 \<br>    -chardev socket,id=char0,path=/var/run/openvswitch/vhost-user1 \<br>    -netdev type=vhost-user,id=mynet1,chardev=char0,vhostforce \<br>    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \<br>    -object memory-backend-file,id=mem,size=128M,mem-path=/mnt/huge,share=on \<br>    -numa node,memdev=mem -mem-prealloc \<br>    -net user,hostfwd=tcp::10021-:22 -net nic \<br>    /bak/images/openstack_demo.img</p>
<p>Inside VM: sudo ifconfig eth0 192.168.9.108/24</p>
<p>附录1,编译DPDK源码并运行单个应用<br>git clone git://dpdk.org/dpdk<br>export DPDK_DIR=/bak/linux/dpdk<br>export DPDK_BUILD=$DPDK_DIR/x86_64-ivshmem-linuxapp-gcc/<br>export RTE_TARGET=x86_64-ivshmem-linuxapp-gcc<br>export EXTRA_CFLAGS=”-ggdb -ffunction-sections -O0”                                       #设置调试选项<br>echo ‘CONFIG_RTE_BUILD_COMBINE_LIBS=y’ &gt;&gt; ./config/common_linuxapp   #编译成单个文件</p>
<p>echo ‘CONFIG_RTE_LIBRTE_VHOST=y’ &gt;&gt; ./config/common_linuxapp   </p>
<p>sudo make config T=x86_64-ivshmem-linuxapp-gcc </p>
<p>sudo make install T=x86_64-ivshmem-linuxapp-gcc                                                #使用共享内存ivshmem模式</p>
<p>cd x86_64-ivshmem-linuxapp-gcc/<br>EXTRA_CFLAGS=”-g -O0” make -j4</p>
<p>sudo modprobe uio<br>sudo insmod x86_64-ivshmem-linuxapp-gcc/kmod/igb_uio.ko                                #DPDK只能使用igb_uio和vfio-pci两种驱动</p>
<p>cd lib/librte_vhost/eventfd_link/<br>make<br>sudo insmod eventfd_link.ko<br>sudo python tools/dpdk_nic_bind.py –status<br>sudo python tools/dpdk_nic_bind.py -b igb_uio 0000:05:00.0</p>
<p>#sudo python tools/dpdk_nic_bind.py -b uio_pci_generic 0000:05:00.0</p>
<p>cd examples/helloworld/<br>make<br>sudo ./build/helloworld -c 0xf -n 4 –socket-mem=32</p>
<p>gdb ./build/helloworld<br>(gdb) run -c 0xf -n 4 –socket-mem=32</p>
<p>#integrate ovs with dpdk</p>
<p>git clone <a href="https://github.com/openvswitch/ovs.git" target="_blank" rel="external">https://github.com/openvswitch/ovs.git</a><br>cd /bak/linux/ovs<br>export OVS_DIR=<code>pwd</code><br>./boot.sh<br>./configure –with-dpdk=”$DPDK_DIR/x86_64-ivshmem-linuxapp-gcc/“ –enable-ssl CFLAGS=”-g -O0”<br>make ‘CFLAGS=-g -O0 -march=native’ -j4</p>
<p>参考<br>[1] <a href="https://software.intel.com/en-us/blogs/2015/06/09/building-vhost-user-for-ovs-today-using-dpdk-200" target="_blank" rel="external">https://software.intel.com/en-us/blogs/2015/06/09/building-vhost-user-for-ovs-today-using-dpdk-200</a></p>
<p>[2] <a href="http://dpdk.readthedocs.org/en/v2.2.0/linux_gsg/index.html" target="_blank" rel="external">http://dpdk.readthedocs.org/en/v2.2.0/linux_gsg/index.html</a></p>
<p>[3] <a href="http://blog.csdn.net/xy010902100449/article/details/47282937" target="_blank" rel="external">http://blog.csdn.net/xy010902100449/article/details/47282937</a></p>
<p>[4] <a href="http://openvswitch.org/support/dist-docs/INSTALL.DPDK.md.txt" target="_blank" rel="external">http://openvswitch.org/support/dist-docs/INSTALL.DPDK.md.txt</a></p>
<p>[5] <a href="https://software.intel.com/en-us/articles/using-open-vswitch-with-dpdk-for-inter-vm-nfv-applications" target="_blank" rel="external">https://software.intel.com/en-us/articles/using-open-vswitch-with-dpdk-for-inter-vm-nfv-applications</a></p>
<p>[6] <a href="https://raw.githubusercontent.com/xsited/ssg/master/scripts/build_ovs_dpdk.sh" target="_blank" rel="external">https://raw.githubusercontent.com/xsited/ssg/master/scripts/build_ovs_dpdk.sh</a></p>
<p>[7] <a href="http://www.ran-lifshitz.com/2015/06/17/open-vswitch-netdev-dpdk-with-vhost-user-support/" target="_blank" rel="external">http://www.ran-lifshitz.com/2015/06/17/open-vswitch-netdev-dpdk-with-vhost-user-support/</a></p>
<p>[8] DPDK编程指南</p>
</none>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/28/OpenStack中的防火墙/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/28/OpenStack中的防火墙/" itemprop="url">OpenStack中的防火墙</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-28T12:37:28+08:00">
                2021-01-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>OpenStack中的防火墙 ( by quqi99 )
</code></pre><p>作者：张华  发表于：2012-4-10<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>iptables提供了全面的协议状态跟踪、数据包的应用层检查、速率限制、过滤策略。</p>
<p>iptables策略是由一组有序的规则建立的，它告诉内核该如何处理数据包。而规则应用于表中的一个链，链是一个规则集。</p>
<p>iptable 的概念从大到小是：iptables &gt; tables &gt; chains &gt; rules</p>
<p>表，表描述了iptables的功用大类，共有4个内置表：filter,nat, mangle,raw。</p>
<p>filter, 默认表，有三个重要的内置链：INPUT, OUTPUT, FORWARD</p>
<p>nat，网络地址转换表，三个链，PREROUTING (DNAT), POSTROUTING（SNAT)，OUTPUT（用于本地包的NAT)</p>
<p>mangle, 用于包的修改，　PREOUTING, OUTPUT, FORWARD, INPUT, POSTROUTING</p>
<p>raw, 用于配置免除, PREROUTING, OUTPUT</p>
<p>下图显示了这些内置链的关系:</p>
<p>iptables包处理流程图如下：</p>
<p>例如：openstack中的floating-ips就是根据SNAT与DNAT规则实现的：</p>
<p>iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j SNAT –to-source 9.123.25.13<br>iptables -t nat -A PREROUTING -d 9.123.25.13 -j DNAT –to-destination 172.16.1.2</p>
<p><a href="http://blog.csdn.net/bill_lee_sh_cn/article/details/4401896" target="_blank" rel="external">http://blog.csdn.net/bill_lee_sh_cn/article/details/4401896</a></p>
<p>匹配，即条件，每个iptables规则都包含一级匹配以及一个目标，后者告诉ipatables对于符合规则的数据包应该采取什么动作。最重要的iptables匹配如下：</p>
<p>–source (-s ), 配置源IP地址或网络</p>
<p>–destination (-d), 匹配目标IP或网络</p>
<p>–protocol (-p), 匹配IP值</p>
<p>–in-interface (-i), 流入接口（如,eth0)</p>
<p>–out-interface (-o), 输出接口</p>
<p>–state，匹配一组连接状态</p>
<p>–string, 匹配应用层数据字节序列</p>
<p>–comment,在内核内存中为一个规则关联多达256个节字的注释数据</p>
<p>目标，即动作，它们用于在数据包匹配一条规则时触发的一个动作。如下：</p>
<p>ACCEPT, 充许数据包通过</p>
<p>DROP，丢弃数据包，不响应报文</p>
<p>REJECT, 丢弃数据包，响应报文</p>
<p>LOG，记录数据包信息到syslog</p>
<p>RETURN，在调用链中继续处理数据包</p>
<p>除了内置链以外，还可以自定义链表，自定义链表的一般过程是：</p>
<p>1, 创建一个新链表，iptables-t filter -N newchain</p>
<p>2, 往新链表中添加rules，iptables-t filter -A newchain -s 192.168.75.129 -j DROP</p>
<p>3, 通过-j参数使用自定义的链，iptables-A INPUT -j newchain</p>
<p>Neutron使用了自定义链，分包装链与非包装链两类，区别在于是否对链表添加组件名重新包装</p>
<p>(这样定名的目的是为了不和系统中其他应用设置的防火墙规则混淆）：</p>
<p>１）包装链，链名需要通过组件名重新包装，如neutron-l3-agent组件定义的OUTPUT链叫neutron-l3-agent-OUTPUT，也意味着，Neutron不会用内置链OUTPUT，它必须跳转到对应的包装链（iptables-t filter OUTPUT -j neutron-l3-agent-OUTPUT）</p>
<p>２）非包装链，链名没有用组件名包装，例如，neutron-filter-top就是位于FOWARD和OUTPUT顶部的非包装链，用于在不同OpenStack组件共享的链，</p>
<p>neutron-filter-top链的内容是：</p>
<p>iptables -t filter -N neutron-filter-top</p>
<p>iptables -t filter -A FORWARD -jneutron-filter-top</p>
<p>iptables -t filter -A OUTPUT -j neutron-filter-top</p>
<p>再添加一个包装链neutron-l3-agent-local，接管非包装链neutron-filter-top</p>
<p>iptables -t filter -N neutron-l3-agent-local</p>
<p>iptables -t filter -A neutron-filter-top -jneutron-l3-agent-local</p>
<p>对于IPv4,IPv6，Neutron为filter和nat两张表里的INPUT,FORWARD, OUTPUT三个内置链都定义了相应的包装链：</p>
<p>iptables -t filter -A INPUT -jneutron-l3-agent-INPUT</p>
<p>iptables -t filter -A FORWARD -jneutron-l3-agent-FORWARD</p>
<p>iptables -t filter -A OUTPUT -jneutron-l3-agent-OUTPUT</p>
<p>iptables -t nat -A INPUT -j neutron-l3-agent-INPUT</p>
<p>iptables -t nat -A FORWARD -jneutron-l3-agent-FORWARD</p>
<p>iptables -t nat -A OUTPUT -jneutron-l3-agent-OUTPUT</p>
<p>还定义了一个名为neutron-postrouting-bottom的非包装类，用于POSTOURING链之后：</p>
<p>iptables -t filter -N neutron-postrouting-bottom</p>
<p>iptables -t filter -A POSTROUTING -jneutron-postrouting-bottom</p>
<p>在neutron-postrouting-bottom链后再定义两个snat(neutron-l3-agent-snat）的包装类：</p>
<p>iptables -t filter -N neutron-l3-agent-snat</p>
<p>iptables -t filter -A neutron-postrouting-bottom-j neutron-l3-agent-snat</p>
<p>iptables -t filter -N neutron-l3-agent-float-snat</p>
<p>iptables -t filter -A neutron-postrouting-bottom-j neutron-l3-agent-float-snat</p>
<p>最后定义sg-fallback包装链</p>
<p>iptables -t filter -N neutron-l3-agent-sg-fallback</p>
<p>iptables -t filter -Aneutron-l3-agent-sg-fallback -j DROP</p>
<p>所以这些初始化链的关系是：</p>
<p>OpenStack为我们准备好了上面的包装链与非包装链，再添加添加防火墙规则的时候，就不要再往内置链上添加了，而是直接添加到包装链与非包装链上，我们来看一下怎么用吧（这些内容来自永生的博客，写得真不错，做笔记到这里了，<a href="http://www.ibm.com/developerworks/cn/cloud/library/cl-openstack-network/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/cloud/library/cl-openstack-network/index.html</a> )</p>
<p>１）元数据，</p>
<p>VM首先访问l3-agent节点上的网关，而l3-agent节点（dhcp-agent节点也会干这事）会在9697端口上启动neutron-ns-metadata-proxy代理，下面的iptables rules保证包通过(注意:　如果存在命名空间这些规则就在命名空间里)。</p>
<p>cirros$ ip route get 169.254.169.254<br>169.254.169.254 via 10.0.1.1 dev eth0  src 10.0.1.3</p>
<p>sudo ip netns exec qrouter-b0d4cbde-84c8-4883-a953-1d11bcc3c99b iptables-save | grep 169.254<br>-A neutron-vpn-agen-inbound -s 169.254.169.254/32 -j ACCEPT<br>-A neutron-vpn-agen-outbound -d 169.254.169.254/32 -j ACCEPT<br>-A neutron-vpn-agen-PREROUTING -d 169.254.169.254/32 -p tcp -m tcp –dport 80 -j REDIRECT –to-ports 9697  #对于dhcp-agent的metdata代理没有这一条语句，直接使用80端口<br>169.254.169.254/32 -p tcp -m tcp –dport 80 -j REDIRECT –to-ports 9697  #对于dhcp-agent的metdata代理没有这一条语句，直接使用80端口</p>
<p>ubuntu@neutron-gateway:~$ sudo ip netns exec qrouter-02c71d17-8186-4fde-8bfc-ee0bea0d44ba ss -sl4tp  | grep 9697<br>LISTEN     0      128                     <em>:9697                     </em>:<em>        users:((“neutron-ns-meta”,58682,6))<br>9697                     </em>:*        users:((“neutron-ns-meta”,58682,6))</p>
<p>ubuntu@neutron-gateway:~$ sudo ip netns exec qrouter-02c71d17-8186-4fde-8bfc-ee0bea0d44ba ps -f –pid 58682 | fold -w82 -s<br>UID        PID  PPID  C STIME TTY          TIME CMD<br>neutron  58682     1  0 Jun18 ?        00:00:48 /usr/bin/python<br>/usr/bin/neutron-ns-metadata-proxy<br>–pid_file=/var/lib/neutron/external/pids/02c71d17-8186-4fde-8bfc-ee0bea0d44ba.pid<br> –metadata_proxy_socket=/var/lib/neutron/metadata_proxy<br>–router_id=02c71d17-8186-4fde-8bfc-ee0bea0d44ba –state_path=/var/lib/neutron<br>–metadata_port=9697 –metadata_proxy_user=109 –metadata_proxy_group=113<br>–log-file=neutron-ns-metadata-proxy-02c71d17-8186-4fde-8bfc-ee0bea0d44ba.log<br>–log-dir=/var/log/neutron<br>9697 –metadata_proxy_user=109 –metadata_proxy_group=113<br>–log-file=neutron-ns-metadata-proxy-02c71d17-8186-4fde-8bfc-ee0bea0d44ba.log<br>–log-dir=/var/log/neutron</p>
<p>ubuntu@neutron-gateway:~$ ps -f –pid 26859 | fold -w 80 -s<br>UID        PID  PPID  C STIME TTY          TIME CMD<br>neutron  26859 26747  2 Jun16 ?        2-23:44:43 /usr/bin/python<br>/usr/bin/neutron-metadata-agent –config-file=/etc/neutron/neutron.conf<br>–config-file=/etc/neutron/metadata_agent.ini<br>–log-file=/var/log/neutron/neutron-metadata-agent.log<br>/var/log/neutron/neutron-metadata-agent.log<br>ubuntu@neutron-gateway:~$ sudo ss -slxp | grep metadata_proxy<br>u_str  LISTEN     0      128    /var/lib/neutron/metadata_proxy 1460916               * 0<br>  users:((“neutron-metadat”,26859,5),(“neutron-metadat”,26858,5),(“neutron-metadat”,26857,5),(“neutron-metadat”,26856,5),<br>(“neutron-metadat”,26855,5),(“neutron-metadat”,26854,5),(“neutron-metadat”,26853,5),(“neutron-metadat”,26852,5),<br>(“neutron-metadat”,26747,5))<br>26859,5),(“neutron-metadat”,26858,5),(“neutron-metadat”,26857,5),(“neutron-metadat”,26856,5),<br>(“neutron-metadat”,26855,5),(“neutron-metadat”,26854,5),(“neutron-metadat”,26853,5),(“neutron-metadat”,26852,5),<br>(“neutron-metadat”,26747,5))</p>
<p>然后neutron-ns-metadata-proxy代理会通过http协议访问neutron metadata-agent，所以169.254.169.254应该是配置在metadata-agent节点的lo口上。且neutron metadata-agent的机器上应该将169.254.169.254 DNAT到实际布置metadata service的机器nova_metadata_ip (/etc/neutron/meatadata_agent.ini)上，如172.16.1.122 。（所以当nova-api与metadata agent不在同一机器上时，在metadata agent机器上应该配置metadata_host配置）</p>
<p>同时，在nova-api机器上要放行这类包。</p>
<p>-A nova-network-POSTROUTING -s 10.0.0.0/8 -d 172.16.1.122/32 -j ACCEPT</p>
<p>l3-agent上会为每一个namespace下的router创建一个neutron-ns-metadata-proxy进程(虚机和nova-api的路由不同才需要代理),  将请求元数据服务VM的源IP通过设置X-Forwarded-For, X-Neutron-Router-ID, X-Neutron-Network-ID 传给metadata_agent从而解决识别不同namespace下虚机的问题, 然后metadata-agent根据源IP找到port的相关信息(调用nova-api时需要这个port-id之类的信息来识别虚机, X-Forwarded-For , X-Instance-ID, X-Tenant-ID, X-Instance-ID-Signature). neutron-ns-metadata-proxy通过本地的unix-socket再交给本机的metadata-agent, 本机的metadata-agent再通过配置文件中的nova-metadata_host找到本机的nova-metadata-api.</p>
<p>如果使用外部网关，要使用metadata也应该启动dhcp-agent, 即： </p>
<p>/etc/neutron/dhcp_agent.ini:<br>  enable_metadata_network = True<br>  enable_isolated_metadata = True</p>
<p>/neutron/l3_agent.ini:<br>  enable_metadata_proxy = False<br>有时候还要在nova.conf中设置use_forwarded_for = True. 这样虚机里会通过dhcp static host特性自动添加一条路由（ip route add 169.254.169.254/32 via 10.20.0.5  ）， 然后在dhcp节点的qdhcp-XXX名空间的dhcp port应该同时具有两个IP （例如一个10.20.0.5, 一个是169.254.169.254），它会启动neutron-ns-metadata-proxy(它是隔离网络，此时的metadata_port是80,不是9697,不需要9697的那条iptables rule), 后面neutron-metadata-agent的部分和前面一样。</p>
<h1 id="ps-f-–pid-27409-fold-s-w-82-pid可通过ip-netns-exec-qdhcp-XXX-netstat-4-anpt-命令查看"><a href="#ps-f-–pid-27409-fold-s-w-82-pid可通过ip-netns-exec-qdhcp-XXX-netstat-4-anpt-命令查看" class="headerlink" title="ps -f –pid 27409 | fold -s -w 82        #pid可通过ip netns exec qdhcp-XXX netstat -4 -anpt 命令查看"></a>ps -f –pid 27409 | fold -s -w 82        #pid可通过ip netns exec qdhcp-XXX netstat -4 -anpt 命令查看</h1><p>UID PID PPID C STIME TTY TIME CMD<br>root 27409 1 0 17:47 ? 00:00:00 python<br>/usr/bin/neutron-ns-metadata-proxy<br>–pid_file=/var/lib/neutron/external/pids/01cce415-8e2b-4096-92b5-7acc67163d79.pid<br>–network_id=01cce415-8e2b-4096-92b5-7acc67163d79 –state_path=/var/lib/neutron<br>–metadata_port=80 –debug –verbose<br>–log-file=neutron-ns-metadata-proxy01cce415-8e2b-4096-92b5-7acc67163d79.log<br>–log-dir=/var/log/neutron </p>
<p>所以使用dhcp-agent的metadata代理时，必须是隔离网络（neutron subnet-create net1 172.17.17.0/24 –no-gateway –name=sub1），如果不是隔离网络可以考虑设置force_metadata=True.</p>
<p>有时候即想用物理路由器，还不想使用dhcp-agent，并且还想使用metadata那该怎么办？ 好说，那必须启动l3-agent（如它的IP是10.0.0.1），那么物理路由器的IP必须是不同的IP如10.0.0.254。这样用下列静态路由将到169.254.169.254的走l3-agent上的namespace metadata proxy，其他流量走物理路由器。具体见： <a href="https://kimizhang.wordpress.com/2014/11/11/how-to-use-meta-data-service-for-vm-with-provider-network/" target="_blank" rel="external">https://kimizhang.wordpress.com/2014/11/11/how-to-use-meta-data-service-for-vm-with-provider-network/</a></p>
<p>neutron subnet-create –name test-subnet –gateway 10.0.0.1  \<br>–host-route destination=169.254.169.254/32,nexthop=10.0.0.1 \<br>–host-route destination=0.0.0.0/0,nexthop=10.0.0.254 test-net 10.0.0.0/24</p>
<p>默认的security group会为每个port产生嗅探规则(即只允许匹配的ip, mac对的流量通过, 对于负载均衡或者 SLAC IPv6地址的port, 可能一个port(只有一个mac)但有多个IP, 所以可以通过allowed-address-pairs这个扩展来允许任何源IP的流量通过. 那我们可以用ipv6的本地链路地址LLAddr来查询上面的port呢, 于是有了BP, <a href="https://blueprints.launchpad.net/neutron/+spec/metadata-find-instance-by-lladdr" target="_blank" rel="external">https://blueprints.launchpad.net/neutron/+spec/metadata-find-instance-by-lladdr</a> ,  但是又有一种情况, 不同namespace下可能允许出现相关的mac地址的(overlapping mac), 这样根据mac地址将查询出两个port出来,</p>
<p>用源IP及network_id (不同的tenant下是可以存在的subnet的）去查询port可能会有一个问题(找port是为了找到虚机的device_id和tenant_id信息）, 如纯IPv6环境（一个同MAC的port会有多个IPv6地址)，如虚机从外部获取IP时IP根本就不在port的fixed_ip字段里, 这样就会造成找不到port从而找不着device_id从而造成metadata服务不可用。(当然,可以通过allowed-address-pairs扩展将169.254.0.0/16加入虚机的port security里). 这种情况是不是可以用config-driver这种离线的元数据配置服务去代替在线的metadata服务. 或者搞一个所谓的serial port配置在fixed_ip list的源IP专门去读在线的metadata服务.</p>
<p>config-driver虚机注入见: <a href="http://niusmallnan.github.io/_build/html/_templates/openstack/vm_first_boot_fast.html" target="_blank" rel="external">http://niusmallnan.github.io/_build/html/_templates/openstack/vm_first_boot_fast.html</a>, 即把nova boot传来的元数据写到iso中, 虚机启动时自动挂载iso, 然后init-cloud从光驱里读元数据并设置</p>
<p>cat &lt;&lt; EOF &gt; user-data </p>
<p>#cloud-config<br>user: ubuntu<br>password: ubuntu<br>chpasswd: { expire: False }<br>EOF<br>openstack server create –wait –image <image name=""> –flavor m1.medium –key-name <keynam> –nic net-id=<net-id> testvm –user-data ./user-data –config-drive true </net-id></keynam></image></p>
<p>allowed-address-pairs见： <a href="http://blog.csdn.net/matt_mao/article/details/19417451" target="_blank" rel="external">http://blog.csdn.net/matt_mao/article/details/19417451</a></p>
<p>默认为每一个虚机生成的反欺骗规则如下，这样VM的流量才能出去与外界通信。同样，metadata服务响应的流量要出来其源IP是169.254.0.0/16，也应为其添加allowed-address-pairs后流量才能出去。</p>
<p>对于ipv6同样会有一个port有多个ipv6地址的情况，所以_select_ra_ips_for_network_ids方法就是使用ipv6的本地链路地址去为做网关的虚机生成默认的反欺骗规则从而允许其他虚机发过来的RA广播进来。</p>
<p>arget          prot    opt    in     out          source           destination</p>
<p>RETURN     all     –      <em>        </em>          <vm-ip>           0.0.0.0/0           MAC FA:16:3E:38:38:90<br>DROP          all     –      <em>        </em>          0.0.0.0/0            0.0.0.0/0</vm-ip></p>
<p>2)访问dmz规则，FLAGS.dmz_cidr定义了一个dmz列表,虚机应该能访问它，例本例的dmz列表为:10.0.128.0/24</p>
<p>-Anova-network-POSTROUTING -s 10.0.0.0/8 -d 10.0.128.0/24 -j ACCEPT</p>
<p>3)两个虚机互通，从一个子网且不是DNAT的连接放行。</p>
<p>-Anova-network-POSTROUTING -s 10.0.0.0/8 -d 10.0.0.0/8 -m conntrack !–ctstate DNAT</p>
<p>-j ACCEPT</p>
<p>４）SNAT规则，例如从10.0.0.0/8虚机内网网络出去的包将源目址修改为外网IP9.123.1.12</p>
<p>-A nova-network-snat -s10.0.0.0/8 -j SNAT –to-source 9.123.1.122</p>
<p>5)创建网桥要做的事</p>
<p>1，网络节点，转发流量，充当网关</p>
<p>-A nova-network-FORWARD -i br100 -j ACCEPT<br>-A nova-network-FORWARD -o br100 -j ACCEPT<br>2, 若是计算节点要允许虚机与网络节点以及其他计算节点上的虚机相连<br>-A nova-compute-FORWARD -i br100 -j ACCEPT<br>-A nova-compute-FORWARD -o br100 -j ACCEPT<br>若是计算节点要允许虚机与网络节点以及其他计算节点上的虚机相连<br>-A nova-compute-FORWARD -i br100 -j ACCEPT<br>-A nova-compute-FORWARD -o br100 -j ACCEPT<br>３,支持dhcp(67)和dns(53)</p>
<p>-A nova-network-INPUT -i br100 -p udp -m udp –dport 67 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p tcp -m tcp –dport 67 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p udp -m udp –dport 53 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p tcp -m tcp –dport 53 -j ACCEPT<br>４，所以每个虚机的链和规则如下图：</p>
<p>４，所以每个虚机的链和规则如下图：</p>
<p>相应的, neutron l2 agent上的规则如下：</p>
<p>neutron l2 agent上的iptables设置，当它发现有新增tap设备时，就会从DB中取出和tap设备关联的port信息来设置vlan及security group（调用plugin的security_group_rules_for_devices方法获取port的安全组规则信息，规则信息里面已经考虑了允许dhcp, address_pair等）相关设置。每个port对应两条链(iX-XXXX和oX-XXXX), 下面只显示iX-XXXX的作为例子，oX-XXXX的依此类推。实现了这些功能：</p>
<pre><code>prepares, updates, removes firewall filters （准备、更新和删除防火墙过滤器）
drops all packets by default （默认丢弃所有包）
prevents IP spoofing based on port&apos;s mac address (compatible with allowed_address_pairs extension) （防 IP 欺骗）
allows incoming DHCP and ICMPv6 RA （允许进入虚机的 DHCP 包和 ICMPV6 RA）
blocks outgoing DHCP （禁止出虚机的 DHCP 包）
drops INVALID packets （丢弃无效状态的包）
allows stateful, established connections （允许有状态的并且已建立的连接，比如允许进来的 ICMP 的时候，从外面 ping 虚机时虚机的响应包是可以返回的）
converts security group rules to iptables rules (IPv4, IPv6, TCP, UDP, ICMP, ICMPv6) （将用户配置的规则转化为 iptables 规则）
multiple TCP/UDP ports per iptables rule using multiport module
支持 IPV4 和 IPV6
</code></pre><p>相应的链如下：</p>
<p>-N neutron-filter-top<br>-N neutron-openvswi-FORWARD #neutorn 定义的 FORWARD 链<br>-N neutron-openvswi-INPUT   #Neutron 定义的 INPUT 链<br>-N neutron-openvswi-OUTPUT  #Neutron 定义的 OUTPUT 链<br>-N neutron-openvswi-i6e3f2eda-3 #处理进入该虚机的网络包<br>-N neutron-openvswi-local<br>-N neutron-openvswi-o6e3f2eda-3 #处理出该虚机的网络包<br>-N neutron-openvswi-s6e3f2eda-3 #处理出该虚机的网络包的防IP欺骗<br>-N neutron-openvswi-sg-chain<br>-N neutron-openvswi-sg-fallback<br>-A INPUT -j neutron-openvswi-INPUT #将 INPUT 链转到 neutron 的 INPUT 链<br>-A FORWARD -j neutron-filter-top<br>-A FORWARD -j neutron-openvswi-FORWARD #将 FORWARD 链转到 neutorn 的 forward 链<br>-A OUTPUT -j neutron-filter-top<br>-A OUTPUT -j neutron-openvswi-OUTPUT   #将 OUTPUT 链转到 neutron 的 output 链<br>-A neutron-filter-top -j neutron-openvswi-local</p>
<p>-A neutron-openvswi-FORWARD -m physdev –physdev-out tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-sg-chain #处理进入虚机的数据包<br>-A neutron-openvswi-FORWARD -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-sg-chain  #处理出虚机的数据包<br>-A neutron-openvswi-INPUT -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-o6e3f2eda-3 #处理出虚机的数据包</p>
<p>#处理进虚机的包<br>-A neutron-openvswi-i6e3f2eda-3 -m state –state INVALID -j DROP                               #丢弃无效连接<br>-A neutron-openvswi-i6e3f2eda-3 -m state –state RELATED,ESTABLISHED -j RETURN                 #允许已建立的连接<br>-A neutron-openvswi-i6e3f2eda-3 -s 10.0.0.7/32 -p udp -m udp –sport 67 –dport 68 -j RETURN #允许 DHCP 服务器 10.0.0.3 的返回包<br>-A neutron-openvswi-i6e3f2eda-3 -s 10.0.0.2/32 -p udp -m udp –sport 67 –dport 68 -j RETURN #允许 DHCP 服务器 10.0.0.2 的返回包<br>-A neutron-openvswi-i6e3f2eda-3 -j neutron-openvswi-sg-fallback                                #其余包交给 fallback 链处理     </p>
<p>#处理出虚机的包<br>-A neutron-openvswi-o6e3f2eda-3 -p udp -m udp –sport 68 –dport 67 -j RETURN   #允许 DHCP 访问<br>-A neutron-openvswi-o6e3f2eda-3 -j neutron-openvswi-s6e3f2eda-3                 #防止 IP 欺骗<br>-A neutron-openvswi-o6e3f2eda-3 -p udp -m udp –sport 67 –dport 68 -j DROP     #不允许对外提供 DHCP 服务<br>-A neutron-openvswi-o6e3f2eda-3 -m state –state INVALID -j DROP                #禁止无效连接<br>-A neutron-openvswi-o6e3f2eda-3 -m state –state RELATED,ESTABLISHED -j RETURN  #允许已建立的连接<br>-A neutron-openvswi-o6e3f2eda-3 -j neutron-openvswi-sg-fallback                 #其余交给 fallback 链处理</p>
<p>#防 IP 欺骗规则：防止该虚机被利用来做 IP 欺骗攻击。<br>-A neutron-openvswi-s6e3f2eda-3 -s 10.0.0.14/32 -m mac –mac-source FA:16:3E:F3:1E:C0 -j RETURN #允许从虚机发出的MAC 和IP 同虚机的 MAC 和 IP 的包<br>-A neutron-openvswi-s6e3f2eda-3 -j DROP                                                           #禁止其余包</p>
<p>-A neutron-openvswi-sg-chain -m physdev –physdev-out tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-i6e3f2eda-3 #处理进入虚机的包<br>-A neutron-openvswi-sg-chain -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-o6e3f2eda-3  #处理出虚机的包</p>
<p>-A neutron-openvswi-sg-chain -j ACCEPT<br>-A neutron-openvswi-sg-fallback -j DROP #丢弃其它包</p>
<p>l3-agent 上FWaaS 相关设置：</p>
<p>-A neutron-l3-agent-iv4XXXXXXXX-XXXX -m state –state INVALID -j DROP<br>-A neutron-l3-agent-iv4XXXXXXXX-XXXX -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A neutron-l3-agent-iv4XXXXXXXX-XXXX … -j ACCEPT/DROP</p>
<p>-A neutron-l3-agent-ov4XXXXXXXX-XXXX -m state –state INVALID -j DROP<br>-A neutron-l3-agent-ov4XXXXXXXX-XXXX -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A neutron-l3-agent-ov4XXXXXXXX-XXXX … -j ACCEPT/DROP</p>
<p>-A neutron-l3-agent-FORWARD -i qr-+ -j neutron-l3-agent-iv4XXXXXXXX-XXXX<br>-A neutron-l3-agent-FORWARD -o qr-+ -j neutron-l3-agent-ov4XXXXXXXX-XXXX<br>-A neutron-l3-agent-FORWARD -o qr-+ -j neutron-l3-agent-fwaas-default-policy<br>-A neutron-l3-agent-FORWARD -i qr-+ -j neutron-l3-agent-fwaas-default-policy</p>
<p>5,nova-api一开始会在filter表内创建一个规则允许他人能访问它（如nova-api的ip是：　172.16.1.122)</p>
<p>-A nova-api-INPUT -d 172.16.1.122/32 -p tcp -m tcp –dport 8775 -j ACCEPT<br>6, 浮动ip即外网ip设置在网络节点的外网网卡上<br>nova-manage floating create –ip_range=192.168.1.232/30<br>Nova floating-ip-create<br>nova add-floating-ip 8f773639-c04f-4885-9349-ac7d6a799843 192.168.1.233</p>
<p>-A nova-network-OUTPUT -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-PREROUTING -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-float-snat -s 10.10.10.2/32 -j SNAT –to-source 192.168.1.233<br>6，如果想ping一个虚机的话，需设置一个安全组规则（nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0），它将产生如下防炎墙rules. 请记住，在此 nova-compute 主机上，针对每个实例必须有一个特定链；其内的规则只允许来自固定子集内的 IP 的流量。<br>-A nova-compute-inst-1 -p icmp -j ACCEPT<br>浮动ip即外网ip设置在网络节点的外网网卡上<br>nova-manage floating create –ip_range=192.168.1.232/30<br>Nova floating-ip-create<br>nova add-floating-ip 8f773639-c04f-4885-9349-ac7d6a799843 192.168.1.233</p>
<p>-A nova-network-OUTPUT -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-PREROUTING -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-float-snat -s 10.10.10.2/32 -j SNAT –to-source 192.168.1.233<br>6，如果想ping一个虚机的话，需设置一个安全组规则（nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0），它将产生如下防炎墙rules. 请记住，在此 nova-compute 主机上，针对每个实例必须有一个特定链；其内的规则只允许来自固定子集内的 IP 的流量。<br>-A nova-compute-inst-1 -p icmp -j ACCEPT</p>
<p>Neutron防火墙的定义位于：</p>
<p>vi/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini</p>
<p>[securitygroup]</p>
<p>firewall_driver =neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</p>
<p>既然neutron的OVSHybridIptablesFirewallDriver接管了计算节点上的防火墙，所以应该确保nova-compute的nova.conf配置：</p>
<p>[DEFAULT]</p>
<p>firewall_driver =nova.virt.firewall.NoopFirewallDriver</p>
<p>查看Neutron中定义防火墙信息命令如下：</p>
<p>[hua@laptop devstack]$ ip netns list</p>
<p>qrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7</p>
<p>qdhcp-8779fa7c-d8ea-4827-a15d-3c7f56cb3ac0</p>
<p>[hua@laptop devstack]$ sudo ip netns execqrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7 iptables-save</p>
<p>[hua@laptop devstack]$ sudo ip netns execqrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7 iptables-restore</p>
<p>下面是这篇文章《利用raw表实现iptables调试》<a href="http://blog.youlingman.info/debugging-iptables-with-raw-table/" target="_blank" rel="external">http://blog.youlingman.info/debugging-iptables-with-raw-table/</a> 中的内容。</p>
<p>关于上面的这个图，先要说一个很重要的说法，上图显示，netfilter实际上既可以在L2层过滤，也可以在L3层过滤的。</p>
<p>所以在网桥中一般会有下面的参数，即要求iptables不对bridge的数据进行处理：</p>
<h1 id="cat-gt-gt-etc-sysctl-conf-lt-lt-EOF"><a href="#cat-gt-gt-etc-sysctl-conf-lt-lt-EOF" class="headerlink" title="cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF"></a>cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</h1><p>  net.bridge.bridge-nf-call-ip6tables = 0<br>  net.bridge.bridge-nf-call-iptables = 0<br>  net.bridge.bridge-nf-call-arptables = 0<br>  EOF</p>
<h1 id="sysctl-p-etc-sysctl-conf"><a href="#sysctl-p-etc-sysctl-conf" class="headerlink" title="sysctl -p /etc/sysctl.conf"></a>sysctl -p /etc/sysctl.conf</h1><p>或者改用下面的方法解决：</p>
<p> iptables -t raw -I PREROUTING -i BRIDGE -s x.x.x.x -j NOTRACK.</p>
<p>如果net.bridge.bridge-nf-call-iptables＝1，也就意味着二层的网桥在转发包时也会被iptables的FORWARD规则所过滤，这样就会出现L3层的iptables rules去过滤L2的帧的问题（packets don’t cross nat table twice, In the bridging process, you don’t know the outgoing interface so the previous rule doesn’t work. He needs the interface because he’s using MASQUERADE. In the routing process, the packets go to iptables but they never cross NAT tables because the packet already crossed the table in the bridging process.<a href="http://www.woitasen.com.ar/2011/09/confusion-using-iptables-nat-and-bridge/），所以涉及一些dnat" target="_blank" rel="external">http://www.woitasen.com.ar/2011/09/confusion-using-iptables-nat-and-bridge/），所以涉及一些dnat</a>, snat就不生效了，举个例子，具体表现在openstack中就是metadata服务不好使了。这个说法可参见：<a href="https://bugzilla.redhat.com/show_bug.cgi?id=512206" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=512206</a></p>
<p>所以这样下面的规则也就失效了，所以<a href="http://blog.youlingman.info/debugging-iptables-with-raw-table/这个文章上的作者调试iptables的方法挺好，但实际上网络为什么不通的问题实质没有找准。" target="_blank" rel="external">http://blog.youlingman.info/debugging-iptables-with-raw-table/这个文章上的作者调试iptables的方法挺好，但实际上网络为什么不通的问题实质没有找准。</a></p>
<p>-A quantum-l3-agent-POSTROUTING ! -i qg-91757ded-c4 ! -o qg-91757ded-c4 -m conntrack ! –ctstate DNAT -j ACCEPT</p>
<p>还有一种等价于上面bridge-nf-call-iptables的做法，即iptables允许bridge上的数据直接转发</p>
<h1 id="iptables-I-FORWARD-m-physdev-–physdev-is-bridged-j-ACCEPT"><a href="#iptables-I-FORWARD-m-physdev-–physdev-is-bridged-j-ACCEPT" class="headerlink" title="iptables -I FORWARD -m physdev –physdev-is-bridged -j ACCEPT"></a>iptables -I FORWARD -m physdev –physdev-is-bridged -j ACCEPT</h1><h1 id="service-iptables-save"><a href="#service-iptables-save" class="headerlink" title="service iptables save"></a>service iptables save</h1><h1 id="service-iptables-restart"><a href="#service-iptables-restart" class="headerlink" title="service iptables restart"></a>service iptables restart</h1><p>physdev是二层的东西，三层的接口用-i来匹配，但二层的需要用physdev模块的physdev-in这个match了。</p>
<p>下列配置抓取所有经过本机的ICMP包：</p>
<p>iptables -t raw -A OUTPUT -p icmp -j TRACE<br>iptables -t raw -A PREROUTING -p icmp -j TRACE<br>modprobe ipt_LOG<br>调试信息记录在/var/log/message文件中</p>
<p>其他：</p>
<p>打开一个端口：</p>
<p>iptables -I INPUT -i eth0 -p tcp –dport 16509 -j ACCEPT<br>iptables  -I OUTPUT -o eth0 -p tcp –sport 16509 -j ACCEPT<br>sudo iptables-save &gt; /tmp/ipt.save<br>cat /tmp/ipt.save | sudo iptables-restore<br>lsof -i:16509</p>
<p>2014-04-25添加：</p>
<p>如果使用neutron中的security group的话，配置如下：</p>
<p>1, /etc/nova/nova.conf:<br>libvirt_vif_driver = nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver<br>linuxnet_interface_driver =nova.network.linux_net.LinuxOVSInterfaceDriver<br>security_group_api = neutron<br>firewall_driver = nova.virt.firewall.NoopFirewallDriver<br>2, /etc/neutron/ovs_neutron_plugin.ini:<br>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</p>
<p>Allowed Address Pairs Extenstion, 除了默认的防火墙, 还有其他什么ip可以穿过, 这样实例就可以用任意的源IP来访问外部网络</p>
<p>资料：</p>
<p>Linux网络路由表处理及钩子（Iptables and Ebtables） <a href="http://blog.chinaunix.net/uid-23741326-id-3573470.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-23741326-id-3573470.html</a></p>
<p>metadata, <a href="http://techbackground.blogspot.jp/2013/06/metadata-via-quantum-router.html" target="_blank" rel="external">http://techbackground.blogspot.jp/2013/06/metadata-via-quantum-router.html</a></p>
<p><a href="https://vietstack.wordpress.com/2014/09/27/introduction-of-metadata-service-in-openstack/" target="_blank" rel="external">https://vietstack.wordpress.com/2014/09/27/introduction-of-metadata-service-in-openstack/</a></p>
<p><a href="http://techbackground.blogspot.ie/2013/06/metadata-via-quantum-router.html" target="_blank" rel="external">http://techbackground.blogspot.ie/2013/06/metadata-via-quantum-router.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/25/k8s-Canal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/25/k8s-Canal/" itemprop="url">k8s Canal</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-25T16:51:16+08:00">
                2021-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2021-01-25<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>如OpenStack中的Secrity Group可以用来在传统服务应用架构中来实现层与层这的网络访问规则，但对于容器化的服务场景，一个容器一个应用粒度更小，且主机节点的个数和 IP地址都 是快速变化的，这样分层防火墙的思路不再可行。Calico就是这样一个工具，通过修改每个节点上的iptables与路由来实现容器间数据的路由和访问控制，并通过etcd协调节点配置信息。 K8s Network Policy可使用Calico作为CNI实现隔离性，只有匹配规则的流量才能进入pod，同理只有匹配规则的流量才可以离开pod。<br>Canal是Flannel与Calico的结合，访问控制部分由Calico(calico-node -felix)实现, 网络部分仍由Flannel实现(Calico有BGP路由与IPIP隧道两种，Flannel则有Vxlan隧道)。<br>Calico的网络规则的用法可参见(<a href="https://www.open-open.com/news/view/1a7c496" target="_blank" rel="external">https://www.open-open.com/news/view/1a7c496</a>), k8s通过CNI集成Canal能使用Calico实现的网络规则部分，但用法是怎样的呢(可参见－<a href="https://www.jianshu.com/p/331235d8bcbb）：" target="_blank" rel="external">https://www.jianshu.com/p/331235d8bcbb）：</a></p>
<ul>
<li>通过kubectl client创建NetworkPolicy资源</li>
<li>calico的policy-controller(calico-kube-controllers集成了calicoctl用于写policy)监听networkpolicy资源，获取到后写入calico的etcd数据库</li>
<li>node上calico-felix从etcd数据库中获取policy资源，调用iptables做相应配置。</li>
</ul>
<p>Calico policy架构<br><img src="https://img-blog.csdnimg.cn/20210126153921730.png#pic_center" alt=""></p>
<p>在node上最终生成的最终iptables如下：<br><img src="https://img-blog.csdnimg.cn/20210126153850128.png#pic_center" alt="在这里插入图片描述"></p>
<h2 id="测试环境信息"><a href="#测试环境信息" class="headerlink" title="测试环境信息"></a>测试环境信息</h2><p>kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1的IP如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-master/0*      active    idle   3        10.5.2.205      6443/tcp        Kubernetes master running.</span><br><span class="line">  canal/2*                active    idle            10.5.2.205                      Flannel subnet 10.1.49.1/24</span><br><span class="line">  containerd/2*           active    idle            10.5.2.205                      Container runtime available</span><br><span class="line">kubernetes-worker/0*      active    idle   4        10.5.3.197      80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  canal/0                 active    idle            10.5.3.197                      Flannel subnet 10.1.94.1/24</span><br><span class="line">  containerd/0            active    idle            10.5.3.197                      Container runtime available</span><br><span class="line">kubernetes-worker/1       active    idle   5        10.5.4.4        80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  canal/1                 active    idle            10.5.4.4                        Flannel subnet 10.1.3.1/24</span><br><span class="line">  containerd/1            active    idle            10.5.4.4                        Container runtime available</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE    IP          NODE                NOMINATED NODE   READINESS GATES</span><br><span class="line">ubuntu-debug-794979f648-4dj8w   1/1     Running   1          118m   10.1.3.14   juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ubuntu-debug-794979f648-fwdmv   1/1     Running   1          118m   10.1.94.7   juju-11ff05-k8s-4   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="canal中的flannel提供pod-to-pod通信"><a href="#canal中的flannel提供pod-to-pod通信" class="headerlink" title="canal中的flannel提供pod-to-pod通信"></a>canal中的flannel提供pod-to-pod通信</h2><p>flannel内的tunnel网段是10.1.0.0/16，vxlan类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.5.1.44:2379 get /coreos.com/network/config</span><br><span class="line">&#123;&quot;Network&quot;: &quot;10.1.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>flannel为kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1分配的subnet分别是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.5.1.44:2379 ls /coreos.com/network/subnets/</span><br><span class="line">/coreos.com/network/subnets/10.1.94.0-24 (kubernetes-worker/0)</span><br><span class="line">/coreos.com/network/subnets/10.1.3.0-24  (kubernetes-worker/1)</span><br><span class="line">/coreos.com/network/subnets/10.1.49.0-24 (kubernetes-master/0)</span><br></pre></td></tr></table></figure></p>
<p>flannel是根据subnet.env分配的，kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1均应有下列配置，下面只是粘出了kubernetes-worker/0上的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# cat /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.1.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.1.94.1/24</span><br><span class="line">FLANNEL_MTU=8908</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip addr show flannel.1 |grep global</span><br><span class="line">    inet 10.1.94.0/32 scope global flannel.1</span><br></pre></td></tr></table></figure></p>
<p>防火墙应该允许该子网的流量进入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#on kubernetes-worker/0, it should ALLOW 10.1.94.0/24</span><br><span class="line">root@juju-11ff05-k8s-4:~# iptables-save |grep 10.1.94 |grep POST</span><br><span class="line">-A POSTROUTING ! -s 10.1.0.0/16 -d 10.1.94.0/24 -j RETURN</span><br><span class="line"># iptables -t nat -nvL |grep &apos;Chain POSTROUTING&apos; -A9</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1447 packets, 89820 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 1885  119K KUBE-POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span><br><span class="line">    8   460 fan-egress  all  --  *      *       252.0.0.0/8          0.0.0.0/0</span><br><span class="line">  183 11249 RETURN     all  --  *      *       10.1.0.0/16          10.1.0.0/16</span><br><span class="line">    6   360 MASQUERADE  all  --  *      *       10.1.0.0/16         !224.0.0.0/4</span><br><span class="line">    0     0 RETURN     all  --  *      *      !10.1.0.0/16          10.1.94.0/24</span><br><span class="line">    0     0 MASQUERADE  all  --  *      *      !10.1.0.0/16          10.1.0.0/16</span><br></pre></td></tr></table></figure></p>
<p>另外，底层docker或contained也应该将etcd中为每个节点配置的subnet加载进去：</p>
<ul>
<li>如果使用docker, 容器内的流量会先到docker0, 然后根据下列路由到flannel.1</li>
<li>如果使用containerd，是通过下列的/etc/cni/net.d/10-canal.conflist文件将subnet设置进flannel的。<h2 id="canal中的Calico-Felix提供网络访问规则"><a href="#canal中的Calico-Felix提供网络访问规则" class="headerlink" title="canal中的Calico/Felix提供网络访问规则"></a>canal中的Calico/Felix提供网络访问规则</h2>本来calico的felix（通过calico-node -felix运行）是运行在每个节点上负责配置路由及网络访问规则的，现在路由这块不做还是由Flannel来做，所以主要用到felix的网络访问规则。calio的felix的访问规则这块由下列iptables实现(详见Calico网络模型 - <a href="https://www.cnblogs.com/menkeyi/p/11364977.html)，但尚不清楚canal有没有作其他更改。" target="_blank" rel="external">https://www.cnblogs.com/menkeyi/p/11364977.html)，但尚不清楚canal有没有作其他更改。</a><br><img src="https://img-blog.csdnimg.cn/2021012519223249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# route -n |grep flannel</span><br><span class="line">10.1.3.0        10.1.3.0        255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.49.0       10.1.49.0       255.255.255.0   UG    0      0        0 flannel.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>接着流量会被封装成vxlan tunnel送到对方endpoint.<br>Calico如何管网络策略的还没研究清楚(我估计上节中的充许防火墙规则就是这块设置的，当然只是猜测)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# ip addr show |grep cali -A1</span><br><span class="line">6: cali8215eb6fd4a@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-262d6f97-ad60-b48b-85e1-ee180b620c30</span><br><span class="line">--</span><br><span class="line">7: cali105686d7bac@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-09304b68-97b3-c72b-2bd6-b47d9f626890</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.5.0.1        0.0.0.0         UG    100    0        0 ens3</span><br><span class="line">10.1.3.0        10.1.3.0        255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.49.0       10.1.49.0       255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.94.6       0.0.0.0         255.255.255.255 UH    0      0        0 cali105686d7bac</span><br><span class="line">10.1.94.7       0.0.0.0         255.255.255.255 UH    0      0        0 cali8215eb6fd4a</span><br><span class="line">10.5.0.0        0.0.0.0         255.255.0.0     U     0      0        0 ens3</span><br><span class="line">169.254.169.254 10.5.0.1        255.255.255.255 UGH   100    0        0 ens3</span><br><span class="line">252.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 fan-252</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-09304b68-97b3-c72b-2bd6-b47d9f626890 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-262d6f97-ad60-b48b-85e1-ee180b620c30 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ctr c ls</span><br><span class="line">CONTAINER      IMAGE                                              RUNTIME</span><br><span class="line">calico-node    rocks.canonical.com:443/cdk/calico/node:v3.10.1    io.containerd.runc.v2</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns</span><br><span class="line">cni-09304b68-97b3-c72b-2bd6-b47d9f626890 (id: 1)</span><br><span class="line">cni-262d6f97-ad60-b48b-85e1-ee180b620c30 (id: 0)</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-09304b68-97b3-c72b-2bd6-b47d9f626890 ip addr show |grep eth0</span><br><span class="line">3: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    inet 10.1.94.6/32 scope global eth0</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-262d6f97-ad60-b48b-85e1-ee180b620c30 ip addr show |grep eth0</span><br><span class="line">3: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    inet 10.1.94.7/32 scope global eth0</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# cat /etc/cni/net.d/10-canal.conflist</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;cdk-canal&quot;,</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;calico&quot;,</span><br><span class="line">      &quot;etcd_endpoints&quot;: &quot;https://10.5.1.44:2379&quot;,</span><br><span class="line">      &quot;etcd_key_file&quot;: &quot;/opt/calicoctl/etcd-key&quot;,</span><br><span class="line">      &quot;etcd_cert_file&quot;: &quot;/opt/calicoctl/etcd-cert&quot;,</span><br><span class="line">      &quot;etcd_ca_cert_file&quot;: &quot;/opt/calicoctl/etcd-ca&quot;,</span><br><span class="line">      &quot;log_level&quot;: &quot;info&quot;,</span><br><span class="line">      &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.1.94.1/24&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;policy&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;k8s&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;kubeconfig&quot;: &quot;/root/cdk/kubeconfig&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">      &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125;,</span><br><span class="line">      &quot;snat&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="iptables提供Service-to-Pod通信"><a href="#iptables提供Service-to-Pod通信" class="headerlink" title="iptables提供Service-to-Pod通信"></a>iptables提供Service-to-Pod通信</h2><p>以dashboard为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services -A |grep kubernetes-dashboard</span><br><span class="line">kubernetes-dashboard              dashboard-metrics-scraper                ClusterIP   10.152.183.92    &lt;none&gt;        8000/TCP                 3d22h</span><br><span class="line">kubernetes-dashboard              kubernetes-dashboard                     ClusterIP   10.152.183.89    &lt;none&gt;        443/TCP                  3d22h</span><br><span class="line">$ kubectl describe --namespace kubernetes-dashboard service kubernetes-dashboard |grep -E &apos;IPs|Endpoints|Port&apos;</span><br><span class="line">IPs:               10.152.183.89</span><br><span class="line">Port:              &lt;unset&gt;  443/TCP</span><br><span class="line">TargetPort:        8443/TCP</span><br><span class="line">Endpoints:         10.1.3.16:8443</span><br><span class="line">$ kubectl get pods -A -o wide |grep dashboard</span><br><span class="line">kubernetes-dashboard              dashboard-metrics-scraper-74757fb5b7-9rqxd                1/1     Running   1          3d22h   10.1.3.17    juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard              kubernetes-dashboard-64f87676d4-s26bs                     1/1     Running   1          3d22h   10.1.3.16    juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# iptables-save |grep kubernetes-dashboard</span><br><span class="line">-A KUBE-SEP-LGG4MZT3C2GWQFZG -s 10.1.3.17/32 -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-LGG4MZT3C2GWQFZG -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -m tcp -j DNAT --to-destination 10.1.3.17:8000</span><br><span class="line">-A KUBE-SEP-RMJCCMAWKQ3DCGZP -s 10.1.3.16/32 -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-RMJCCMAWKQ3DCGZP -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -m tcp -j DNAT --to-destination 10.1.3.16:8443</span><br><span class="line">-A KUBE-SERVICES ! -s 10.1.0.0/16 -d 10.152.183.92/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper cluster IP&quot; -m tcp --dport 8000 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -d 10.152.183.92/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper cluster IP&quot; -m tcp --dport 8000 -j KUBE-SVC-Z6GDYMWE5TV2NNJN</span><br><span class="line">-A KUBE-SERVICES ! -s 10.1.0.0/16 -d 10.152.183.89/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard cluster IP&quot; -m tcp --dport 443 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -d 10.152.183.89/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard cluster IP&quot; -m tcp --dport 443 -j KUBE-SVC-CEZPIJSAUFW5MYPQ</span><br><span class="line">-A KUBE-SVC-CEZPIJSAUFW5MYPQ -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -j KUBE-SEP-RMJCCMAWKQ3DCGZP</span><br><span class="line">-A KUBE-SVC-Z6GDYMWE5TV2NNJN -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -j KUBE-SEP-LGG4MZT3C2GWQFZG</span><br></pre></td></tr></table></figure></p>
<h2 id="相关服务"><a href="#相关服务" class="headerlink" title="相关服务"></a>相关服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status flannel</span><br><span class="line">systemctl status calico-node.service</span><br><span class="line">systemctl status snap.kubelet.daemon.service</span><br></pre></td></tr></table></figure>
<h2 id="附录-一个客户问题"><a href="#附录-一个客户问题" class="headerlink" title="附录 - 一个客户问题"></a>附录 - 一个客户问题</h2><p>一个客户有一个k8s over vSphere managed by juju 环境，报告使用    goldpinger发现pod间网络不通。<br>先是遇到问题<a href="https://bugs.launchpad.net/juju/+bug/1831244，juju" target="_blank" rel="external">https://bugs.launchpad.net/juju/+bug/1831244，juju</a> controllers与vSphere之间存在用户名和密码的问题，这样”juju status –format yaml”能看到controller处于suspended状态（注意：只有带–format yaml才能看到得）。<br>解决1831244之后就可以正常创建新节点了，将那个失败的keycloak pod迁移到新节点，问题依然存在，’kubectl logs’看到keycloak失败原因是： ‘Caused by: java.net.UnknownHostException: postgres’<br>显然，keycloak依赖于postgres service, 存在dns问题。<br>coredns并没有从旧节新移到新节点，旧节点上存在一个问题, canal的flannel使用的subnet(/run/flannel/subnet.env)与canal的calico使用的subnet(/etc/cni/net.d/10-canal.conflist)不一致，这样导致旧节点上的iptables下列倒数第二行就弄错了，没有充许flannel的数据包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grep -A9 &quot;Chain POSTROUTING&quot; sos_commands/networking/iptables_-t_nat_-nvL</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">pkts bytes target prot opt in out source destination</span><br><span class="line">1411K 88M cali-POSTROUTING all -- * * 0.0.0.0/0 0.0.0.0/0 /* cali:O3lYWMrLQYEMJtB5 */</span><br><span class="line">1378K 86M CNI-HOSTPORT-MASQ all -- * * 0.0.0.0/0 0.0.0.0/0 /* CNI portfwd requiring masquerade */</span><br><span class="line">1376K 86M KUBE-POSTROUTING all -- * * 0.0.0.0/0 0.0.0.0/0 /* kubernetes postrouting rules */</span><br><span class="line">800K 50M RETURN all -- * * 172.17.240.0/20 172.17.240.0/20</span><br><span class="line">0 0 MASQUERADE all -- * * 172.17.240.0/20 !224.0.0.0/4</span><br><span class="line">0 0 RETURN all -- * * !172.17.240.0/20 172.17.247.0/24</span><br><span class="line">521K 31M MASQUERADE all -- * * !172.17.240.0/20 172.17.240.0/20</span><br></pre></td></tr></table></figure></p>
<p>下列语句可以查询etcd中每个节点的subnet配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju run -u kubernetes-worker/&lt;N&gt; etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.1.234.195:2379,https://10.1.234.196:2379,https://10.1.234.203:2379 ls /coreos.com/network/subnets/</span><br></pre></td></tr></table></figure></p>
<p>需要先从etcd里删除它　－　rm /coreos.com/network/subnets/172.17.247.0-24<br>然后重它systemctl restart flannel.service, 接着将 /run/flannel/subnet.env的subnet更新为正确的subnet, 之后通过“ip a s flannel.1 ”确认。最后：<br>systemctl restart calico-node.service<br>systemctl restart snap.kubelet.daemon.service</p>
<h2 id="calicoctl测试"><a href="#calicoctl测试" class="headerlink" title="calicoctl测试"></a>calicoctl测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">juju ssh kubernetes-worker/0 -- sudo -s</span><br><span class="line">#https://docs.projectcalico.org/getting-started/clis/calicoctl/install</span><br><span class="line">curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.17.1/calicoctl</span><br><span class="line">cp calicoctl /usr/bin/ &amp;&amp; chmod +x /usr/bin/calicoctl</span><br><span class="line">#copy env variable like ETCD_ENDPOINTS from the output of &apos;ps -ef |grep calicoctl&apos;</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get networkPolicy</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get globalNetworkPolicy</span><br><span class="line"></span><br><span class="line">k8s networkpolicy - https://docs.projectcalico.org/security/kubernetes-network-policy</span><br><span class="line">calico networkpolicy - https://docs.projectcalico.org/security/calico-network-policy</span><br><span class="line">cat &lt;&lt; EOF | sudo tee calicoPolicyTest.yaml</span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: GlobalNetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-circle-blue</span><br><span class="line">spec:</span><br><span class="line">  selector: k8s-app == &apos;kubernetes-dashboard&apos;</span><br><span class="line">  ingress:</span><br><span class="line">  - action: Deny</span><br><span class="line">    protocol: TCP</span><br><span class="line">    destination:</span><br><span class="line">      ports:</span><br><span class="line">      - 22</span><br><span class="line">EOF</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get globalNetworkPolicy</span><br><span class="line">#go to the worker which dashboard pos is on (kubectl get pod -A -o wide |grep dash)</span><br><span class="line">iptables-save |grep 2222</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210127200046326.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://courses.academy.tigera.io/courses/course-v1:tigera+CCO-L1+CCO-L1-2020/course/" target="_blank" rel="external">https://courses.academy.tigera.io/courses/course-v1:tigera+CCO-L1+CCO-L1-2020/course/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/23/ebpf-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/23/ebpf-study/" itemprop="url">ebpf study</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-23T09:38:20+08:00">
                2021-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-01-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="动态追踪工具比较"><a href="#动态追踪工具比较" class="headerlink" title="动态追踪工具比较"></a>动态追踪工具比较</h2><p>为了追踪内核或用户空间的事件，Dtrace和SystemTap都会把用户传入的追踪处理函数（一般称为 Action），关联到被称为探针的检测点上。这些探针，实际上也就是各种动态追踪技术所依赖的事件源。<br>在这些探针的基础上，Linux 也提供了一系列的动态追踪机制，比如内核内的ftrace、perf、eBPF等。内核外的SystemTap等。</p>
<ul>
<li>ftrace，侧重于函数跟踪，但最早用于函数跟踪，现在又扩展支持了各种事件跟踪功能。ftrace通过debugfs以普通文件的形式，向用户空间提供访问接口。这样，不需要额外的工具，你就可以通过挂载点（通常为/sys/kernel/debug/tracing 目录）内的文件读写，来跟 ftrace 交互，跟踪内核或者应用程序的运行事件。</li>
<li>perf,侧重于性能分析，是一种最简单的静态跟踪机制。通过perf，应用程序可以利用PMU、tracepoint和内核中的计数器来进行性能统计。</li>
<li>eBPF则在BPFBerkeley Packet Filter）的基础上扩展而来，不仅支持事件跟踪机制，还可以通过自定义的 BPF代码（使用 C 语言）来自由扩展。所以，eBPF实际上就是常驻于内核的运行时，可以说就是Linux版的DTrace。</li>
<li>SystemTap不像Dtrace并没有常驻内核的运行时，它需要先把脚本编译为内核模块，然后再插入到内核中执行。这也导致SystemTap启动比较缓慢，并且依赖于完整的调试符号表。ftrace和perf的功能已经比较丰富了，不过，它们有一个共同的缺陷，那就是它们只是DSL不够灵活，没法像DTrace那样通过脚本自由扩展。eBPF就是Linux版的 DTrace，可以通过C语言自由扩展（这些扩展通过 LLVM 转换为 BPF字节码后，加载到内核中执行）。</li>
<li>SystemTap, 在eBPF出现之前，SystemTap是最接近DTrace的动态追踪机制，不过在很长时间都游离于内核之外，且是以内核模块运行。</li>
<li>sysdig，主要用于容器的动态追踪，sysdig = strace + tcpdump + htop + iftop + lsof + docker inspect + ebpf<h2 id="常用动态追踪场景和工具"><a href="#常用动态追踪场景和工具" class="headerlink" title="常用动态追踪场景和工具"></a>常用动态追踪场景和工具</h2></li>
<li>内核函数跟踪: ftrace, trace-cmd</li>
<li>CPU性能分析和堆栈解析： perf, 火焰图</li>
<li>4.x内核跟踪内核或应用程序函数或事件： ebpf, bcctools, systemtap</li>
<li>Docker容器应用性能分析: sysdig</li>
</ul>
<h2 id="libbcc"><a href="#libbcc" class="headerlink" title="libbcc"></a>libbcc</h2><p>libbcc(sudo apt install bpfcc-tools)和libbpf库是bcc的前身, 这两个库提供了使用BPF程序对事件进行观测的函数. bpftrace是另一个基于DSL的前端工具。<br><img src="https://img-blog.csdnimg.cn/2021012309290472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>且BCC源代码库中提供了70多个BPF现成工具:</p>
<p><img src="https://img-blog.csdnimg.cn/20210123092923580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>例如（详见 - <a href="https://www.howtoing.com/bcc-best-linux-performance-monitoring-tools/" target="_blank" rel="external">https://www.howtoing.com/bcc-best-linux-performance-monitoring-tools/</a> )：</p>
<ul>
<li>execsnoop -t 通过跟踪execve系统调用可以知道一个程序正在调用其他哪些进程。</li>
<li>statsnoop, 跟踪stat系统调用</li>
<li>biotop, biosnoop</li>
<li>tcpconnect, 跟踪tcp连接.</li>
</ul>
<h2 id="BPFTool"><a href="#BPFTool" class="headerlink" title="BPFTool"></a>BPFTool</h2><p>BPFTool是一个管理BPF程序和映射的内核工具。下面讲解如何安装它。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#install hwe kernel</span><br><span class="line">sudo add-apt-repository ppa:canonical-kernel-team/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install linux-image-generic-hwe-20.04</span><br><span class="line">sudo reboot</span><br><span class="line"></span><br><span class="line">#install bcc-tools - on bionic</span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD</span><br><span class="line">echo &quot;deb https://repo.iovisor.org/apt/$(lsb_release -cs) $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/iovisor.list</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install bcc-tools libbcc-examples python3-bcc</span><br><span class="line">ls /usr/share/bcc/tools</span><br><span class="line"></span><br><span class="line"># install bcc-tools - on focal, at the moment the iovisor doesn’t have a release for focal, so you have to use bionic</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/bcc-lua_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/bcc-tools_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/python-bcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/python3-bcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/libbcc-examples_0.10.0-34.git.6836168f_amd64.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/libbcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">sudo apt install ./libbcc_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./python-bcc_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./bcc-tools_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./bcc-lua_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./libbcc-examples_0.10.0-34.git.6836168f_amd64.deb -y</span><br><span class="line"></span><br><span class="line">sudo apt install linux-headers-$(uname -r) linux-tools-$(uname -r) -y</span><br><span class="line"></span><br><span class="line">#install hwe kernel source linux-source-5.4.0 and build bpftool (bpftool is for viewing and manipulating BPF objects)</span><br><span class="line">sudo apt install build-essential binutils-dev libelf-dev -y</span><br><span class="line">#unment deb-src line in /etc/apt/sources.list.d/canonical-kernel-team-ubuntu-ppa-bionic.list</span><br><span class="line">VER=$(uname -r |awk -F &quot;-&quot; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">sudo apt-cache policy linux-source-$VER</span><br><span class="line">sudo apt install linux-source-$VER  #linux-source-5.4.0</span><br><span class="line">mkdir -p /bak/build/hwe &amp;&amp; cd /bak/build/hwe</span><br><span class="line">cp /usr/src/linux-source-$&#123;VER&#125;/linux-source-$&#123;VER&#125;.tar.bz2 .</span><br><span class="line">tar vxf linux-source-$&#123;VER&#125;.tar.bz2</span><br><span class="line">make -C ./linux-source-$&#123;VER&#125;/tools/bpf/bpftool</span><br><span class="line">sudo cp ./linux-source-$&#123;VER&#125;/tools/bpf/bpftool/bpftool /usr/local/bin/</span><br><span class="line">bpftool --version</span><br><span class="line"></span><br><span class="line">#DEMO</span><br><span class="line">#The perf subcommand shows BPF programs attached via perf_event_open()</span><br><span class="line">sudo bpftool perf</span><br><span class="line">#The prog show subcommand lists all programs (not just those that are perf_event_open() based)</span><br><span class="line">sudo bpftool prog show</span><br><span class="line">#Each BPF program can be printed/dumped via it&apos;s ID</span><br><span class="line">#the xlated mode prints the BPF instructions translated to assembly, linum mode can used to included source file num info.</span><br><span class="line">#opcodes modifier can be used to include the BPF instruction opcodes</span><br><span class="line">#visual modifier can be used to emit control flow graph info in DOT/GraphViz format (dot -Tpng -Elen=2.5 xx.dot -o xx.png)</span><br><span class="line">sudo bpftool prog dump xlated id &lt;ID&gt; linum</span><br><span class="line">#jited subcommand shows the machine code for the processor that is executed</span><br><span class="line">sudo bpftool prog dump jited id &lt;ID&gt;</span><br><span class="line">#while tcpdump can emit BPF instructions with -d, bpftrace can do the same thing with -v</span><br><span class="line">sudo tcpdump -nni eth0 &apos;tcp port 80&apos; -d &gt; test.bt</span><br><span class="line">#this file must be saved at home dir to avoid &apos;No such file or directory&apos; when using snap</span><br><span class="line">sudo /snap/bin/bpftrace -v test.bt</span><br></pre></td></tr></table></figure></p>
<h2 id="Running-ebpf-examples-and-writing-the-pure-C-ebpf"><a href="#Running-ebpf-examples-and-writing-the-pure-C-ebpf" class="headerlink" title="Running ebpf examples and writing the pure C ebpf"></a>Running ebpf examples and writing the pure C ebpf</h2><p>ebpf是bpf的扩展，相比bpf添加了更多的寄存器，特别充许通过mapping将事件/数据(FD)从内核态往用户态或在ebpf程序之前共享从而扩大的bpf的使用场景。<br><img src="https://img-blog.csdnimg.cn/20210123093623710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#good doc - https://www.ebpf.top/post/ebpf_c_env/</span><br><span class="line">sudo apt install libncurses5-dev build-essential git make libelf-dev clang llvm strace tar bpfcc-tools linux-headers-$(uname -r) gcc-multilib  flex  bison libssl-dev binutils-dev -y</span><br><span class="line">VER=$(uname -r |awk -F &quot;-&quot; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">mkdir -p /bak/build/kernel &amp;&amp; cd /bak/build/kernel</span><br><span class="line">cp /usr/src/linux-source-$&#123;VER&#125;/linux-source-$&#123;VER&#125;.tar.bz2 .</span><br><span class="line">tar vxf linux-source-$&#123;VER&#125;.tar.bz2</span><br><span class="line">cd linux-source-$&#123;VER&#125;</span><br><span class="line">#make defconfig &amp;&amp; make menuconfig</span><br><span class="line">cp -v /boot/config-$(uname -r) .config</span><br><span class="line">make headers_install</span><br><span class="line">make scripts  #fix the error &apos;scripts/mod/modpost: not found&apos;</span><br><span class="line"># for the error &apos;./include/linux/spinlock.h:60:10: fatal error: &apos;asm/mmiowb.h&apos; file not found&apos;</span><br><span class="line">sudo find / -name &apos;mmiowb.h&apos;</span><br><span class="line">#mkdir -p include/asm</span><br><span class="line">#sudo cp /usr/src/linux-headers-5.4.0-60-generic/arch/x86/include/generated/asm/* include/asm</span><br><span class="line">#compile bpf exmaple</span><br><span class="line">#make oldconfig &amp;&amp; make prepare</span><br><span class="line">#make M=samples/bpf clean</span><br><span class="line">make M=samples/bpf</span><br><span class="line">ls samples/bpf/</span><br><span class="line"></span><br><span class="line">cd /bak/build/kernel/linux-source-5.4.0/samples/bpf</span><br><span class="line">cat &lt;&lt; EOF | sudo tee hello_kern.c</span><br><span class="line">#include &lt;linux/bpf.h&gt;</span><br><span class="line">#define SEC(NAME) __attribute__((section(NAME), used))</span><br><span class="line"></span><br><span class="line">SEC(&quot;tracepoint/syscalls/sys_enter_execve&quot;)</span><br><span class="line">int bpf_prog(void *ctx)&#123;</span><br><span class="line">	char msg[] = &quot;Hello BPF!\n&quot;;</span><br><span class="line">	bpf_trace_printk(msg, sizeof(msg));</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char _license[] SEC(&quot;license&quot;) = &quot;GPL&quot;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee hello_user.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;bpf_load.h&quot;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)&#123;</span><br><span class="line">	if(load_bpf_file(&quot;hello_kern.o&quot;)!=0)&#123;</span><br><span class="line">		printf(&quot;The kernel didn&apos;t load BPF program\n&quot;);</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	read_trace_pipe();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#use Makefile to compile them</span><br><span class="line">vim /bak/build/kernel/linux-source-5.4.0/samples/bpf/Makefile</span><br><span class="line">hostprogs-y += hello</span><br><span class="line">hello-objs := bpf_load.o hello_user.o</span><br><span class="line">always += hello_kern.o</span><br><span class="line"></span><br><span class="line">cd ../../ &amp;&amp; make M=samples/bpf V=1</span><br><span class="line">llvm-objdump -S -no-show-raw-insn hello_kern.o</span><br><span class="line">cd sample/bfp &amp;&amp; ./hello</span><br><span class="line">hua@node1:/bak/build/kernel/linux-source-5.4.0$ ls samples/bpf/hello*</span><br><span class="line">samples/bpf/hello  samples/bpf/hello_kern.c  samples/bpf/hello_kern.o  samples/bpf/hello_user.c  samples/bpf/hello_user.o</span><br><span class="line"></span><br><span class="line">#or use clang and gcc to compile instead of Makefile</span><br><span class="line">clang -I/usr/src/linux-headers-$(uname -r)/include -I/usr/include/x86_64-linux-gnu \</span><br><span class="line">-O2 -target bpf  -c hello_kern.c -o hello_kern.o</span><br><span class="line">gcc \</span><br><span class="line">    -I /usr/include/x86_64-linux-gnu \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/arch/x86/include/generated \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/include \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/arch/x86/include  \</span><br><span class="line">    -O2 -Wall -g -lelf -lbpf \</span><br><span class="line">    -o hello_user hello_user.c bpf_load.c</span><br></pre></td></tr></table></figure>
<h2 id="Using-BPF-USDT-to-trace-Python-OpenStack"><a href="#Using-BPF-USDT-to-trace-Python-OpenStack" class="headerlink" title="Using BPF USDT to trace Python/OpenStack"></a>Using BPF USDT to trace Python/OpenStack</h2><p>see <a href="https://zhhuabj.blog.csdn.net/article/details/112633898" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/112633898</a></p>
<h2 id="BPFTrace-example-bcache-debug"><a href="#BPFTrace-example-bcache-debug" class="headerlink" title="BPFTrace example - bcache debug"></a>BPFTrace example - bcache debug</h2><p><img src="https://img-blog.csdnimg.cn/20210123093257219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>详见：<a href="https://blog.csdn.net/loy_184548/article/details/104624854" target="_blank" rel="external">https://blog.csdn.net/loy_184548/article/details/104624854</a><br>BPFTrace充许你使用DSL编写BPF程序，是一个类似于DTrace的替代品，与用C语言或其他工具直接编写BPF程序相比，使用BPFTrace的优势之一是它提供了很多内置功能，无须自己实现，比如聚合信息和创建直方图。另一方面，它的编程能力有限。<br>下面的@代表映射<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee bcache_io_lat.bt</span><br><span class="line">#include &lt;linux/bio.h&gt;</span><br><span class="line"></span><br><span class="line">kprobe:cached_dev_make_request</span><br><span class="line">&#123;</span><br><span class="line">   @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:bio_endio /@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line"> if(((struct bio *)arg0)-&gt;bi_opf &amp; 1) &#123;</span><br><span class="line">    @write = hist(nsecs - @start[arg0]); delete(@start[arg0]);</span><br><span class="line"> &#125;</span><br><span class="line"> else &#123;</span><br><span class="line">    @read = hist(nsecs - @start[arg0]); delete(@start[arg0]);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart apparmor</span><br><span class="line">sudo dpkg-reconfigure apparmor</span><br><span class="line">sudo snap install bpftrace --devmode</span><br><span class="line">sudo snap connect bpftrace:system-trace</span><br><span class="line">#this file must be saved at home dir to avoid &apos;No such file or directory&apos; when using snap</span><br><span class="line">sudo /snap/bin/bpftrace bcache_io_lat.bt</span><br></pre></td></tr></table></figure></p>
<h2 id="XDP"><a href="#XDP" class="headerlink" title="XDP"></a>XDP</h2><p>XDP使用于ACL，在网络包进入网卡还未进行内核前就判断是ACCEPT还是TROP还是REDIRECT.<br><img src="https://img-blog.csdnimg.cn/2021012309374782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#https://sysdig.com/blog/let-light-sysdig-adds-container-visibility/</span><br><span class="line">#https://sysdig.com/blog/digging-into-kubernetes-with-sysdig/</span><br><span class="line">sudo apt install linux-headers-$(uname -r) sysdig -y</span><br><span class="line">sudo sysdig -c lscontainers</span><br><span class="line">sudo sysdig -c topcontainers_cpu -pc  #cpu</span><br><span class="line">sudo sysdig -c topprocs_net -pc       #net</span><br><span class="line">sudo sysdig -pc -c topconns           #socket</span><br><span class="line">sudo sysdig -c topcontainers_file     #disk</span><br><span class="line">sudo sysdig -pc -c topprocs_file      #disk io</span><br><span class="line">#new connection on container calico-node (sudo ctr c ls)</span><br><span class="line">sudo sysdig -p&quot;%fd.name&quot; container.name=calico-node and evt.type=accept</span><br><span class="line">#send and receive data on 80 port of container calico-node</span><br><span class="line">sudo sysdig -A -cecho_fds container.name=calico-node and fd.port=80</span><br><span class="line">#view the activity of a file (regardless of which container it belongs to)</span><br><span class="line">sudo sysdig -pc -c echo_fds &quot;fd.name=/etc/passwd&quot;</span><br><span class="line">#io spectrogram</span><br><span class="line">sudo sysdig -c spectrogram fd.type=file and container.name=calico-node</span><br><span class="line">#data traffic between containers</span><br><span class="line">#kubectl exec -ti ubuntu-debug-794979f648-4dj8w ping 10.1.94.7</span><br><span class="line">sudo sysdig -pc -A -c echo_fds &quot;fd.ip=10.1.3.14 and fd.ip=10.1.94.7&quot;</span><br><span class="line"></span><br><span class="line">sysdig -l | grep k8s</span><br><span class="line">sudo modprobe sysdig-probe &amp;&amp; ls /dev/sysdig0</span><br><span class="line">sudo sysdig -k https://10.5.0.104:443 -chttptop k8s.svc.name=postgresql</span><br></pre></td></tr></table></figure>
<h2 id="appedix-trace-cmd-check-if-sequential-cutoff-was-hit"><a href="#appedix-trace-cmd-check-if-sequential-cutoff-was-hit" class="headerlink" title="appedix - trace-cmd - check if sequential_cutoff was hit"></a>appedix - trace-cmd - check if sequential_cutoff was hit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo trace-cmd record -e bcache:bcache_bypass_sequential</span><br><span class="line">sudo trace-cmd report &gt; output.file</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/21/Debug-OpenvSwitch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/21/Debug-OpenvSwitch/" itemprop="url">Debug OpenvSwitch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-21T14:57:58+08:00">
                2021-01-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-12-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># will stop service</span><br><span class="line">sysctl kernel.core_pattern</span><br><span class="line">sudo service apport start force_start=1 enabled=1</span><br><span class="line">grep enabled /etc/default/apport</span><br><span class="line">sudo killall -SIGSEGV ovs-vswitchd</span><br><span class="line">sudo cat /var/log/apport.log</span><br><span class="line"></span><br><span class="line"># won&apos;t stop service</span><br><span class="line">gdb -ex &quot;set pagination 0&quot; -ex &quot;thread apply all bt&quot; -batch -p $(pidof ovs-vswitchd) #for call trace</span><br><span class="line">gcore $(pidof ovs-vswitchd)</span><br><span class="line">sudo apt install openvswitch-dbg cgdb</span><br><span class="line">#cgdb $(which ovs-vswitchd) $(pidof ovs-vswitchd)</span><br><span class="line">cgdb ovs-vswitchd /var/crash/_usr_lib_openvswitch-switch_ovs-vswitchd.0.crash</span><br></pre></td></tr></table></figure>
<h2 id="Debug-Log"><a href="#Debug-Log" class="headerlink" title="Debug Log"></a>Debug Log</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># log level: emer，err，warn，info，dbg,OFF</span><br><span class="line"># log type: console, syslog, file</span><br><span class="line">sudo ovs-appctl vlog/list |grep vswitchd</span><br><span class="line">sudo ovs-appctl vlog/set vswitchd:file:dbg</span><br><span class="line">sudo ovs-appctl vlog/set vswitchd:file:OFF</span><br><span class="line">sudo ovs-appctl vlog/set ANY:ANY:dbg</span><br><span class="line"></span><br><span class="line"># use this one, we can see the realtime log</span><br><span class="line">sudo ovs-appctl vlog/set ANY:file:dbg</span><br><span class="line">tail -f /var/log/openvswitch/ovs-vswitchd.log</span><br></pre></td></tr></table></figure>
<h2 id="CLI-Usage"><a href="#CLI-Usage" class="headerlink" title="CLI Usage"></a>CLI Usage</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#网桥状态</span><br><span class="line">ovs-vsctl show</span><br><span class="line">#网桥查询</span><br><span class="line">ovs-vsctl list-br</span><br><span class="line">#端口查询</span><br><span class="line">ovs-vsctl list-ports br-int</span><br><span class="line">#接口查询</span><br><span class="line">ovs-vsctl list-ifaces br-int</span><br><span class="line">#端口、接口归属查询</span><br><span class="line">ovs-vsctl port-to-br tap30580aa5-b0</span><br><span class="line">ovs-vsctl iface-to-br tap30580aa5-b0</span><br><span class="line">#查询网桥流表</span><br><span class="line">ovs-ofctl dump-flows br-int</span><br><span class="line">#查询网桥信息</span><br><span class="line">ovs-ofctl show br-int</span><br><span class="line">#Datapath统计信息查询：hit表示datapath命中数，missed未命中，lost表示没有传递到用户空间就丢弃了</span><br><span class="line">ovs-dpctl show</span><br><span class="line">#查询端口详细统计信息</span><br><span class="line">ovs-dpctl show -s</span><br><span class="line">#指定端口统计信息</span><br><span class="line">ovs-ofctl dump-ports br-int 1</span><br><span class="line">#网桥转发规则</span><br><span class="line">ovs-appctl fdb/show br-int</span><br><span class="line"></span><br><span class="line">#日志查询</span><br><span class="line">ovsdb-tool show-log -m /var/lib/openvswitch/conf.db</span><br><span class="line"></span><br><span class="line">#流表匹配</span><br><span class="line">ovs-appctl ofproto/trace br-tun dl_vlan=1</span><br></pre></td></tr></table></figure>
<h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* On compute node</span><br><span class="line">tcpdump -vvv -neli tapd76aea08-db port 67 or port 68 or arp -w `hostname`-tapd76aea08-db-vmport.pcap</span><br><span class="line"></span><br><span class="line">* On dhcp-agent</span><br><span class="line">sudo ip netns exec qdhcp-2be2d2e6-a691-49fb-b260-c4e8abe86fd7 tcpdump -neli any port 67 or port 68 or arp -w `hostname`-dhcpport.pcap</span><br><span class="line"></span><br><span class="line">* Run dhclient &lt;interface&gt; on the VM</span><br><span class="line">Check if the instance got IP or not</span><br></pre></td></tr></table></figure>
<h2 id="Flow-Debug-ovs-stat"><a href="#Flow-Debug-ovs-stat" class="headerlink" title="Flow Debug - ovs-stat"></a>Flow Debug - ovs-stat</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"># https://snapcraft.io/ovs-stat</span><br><span class="line">juju ssh nova-compute/0 -- sudo -s</span><br><span class="line">#sudo snap install snapd --edge</span><br><span class="line">sudo snap install ovs-stat</span><br><span class="line"></span><br><span class="line"># for analysing ovs itself</span><br><span class="line">sudo snap connect ovs-stat:openvswitch</span><br><span class="line">sudo snap connect ovs-stat:network-control</span><br><span class="line"></span><br><span class="line"># for analysing sosreport ovs data where sosreport is on a seperate filesystem</span><br><span class="line">#sudo snap connect ovs-stat:removable-media</span><br><span class="line"></span><br><span class="line">#sudo ovs-stat -p /tmp/results --tree ./sosreport-015 --openstack</span><br><span class="line">sudo ovs-stat -p /tmp/results --tree --openstack</span><br><span class="line"></span><br><span class="line">root@juju-7c33c2-bionic-7:~# readlink -f /tmp/snap.ovs-stat/tmp/results/juju-7c33c2-bionic-7/ovs/bridges/br-int/ports/*</span><br><span class="line">/tmp/snap.ovs-stat/tmp/results/juju-7c33c2-bionic-7/ovs/ports/int-br-data</span><br><span class="line">/tmp/snap.ovs-stat/tmp/results/juju-7c33c2-bionic-7/ovs/ports/patch-tun</span><br><span class="line">/tmp/snap.ovs-stat/tmp/results/juju-7c33c2-bionic-7/ovs/ports/tapcdda0c13-5e</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;openstack.ports&quot;</span><br><span class="line">int-br-data  patch-int  patch-tun  phy-br-data  tapcdda0c13-5e  vxlan-0a05008d</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;openstack.bridge br-int&quot;</span><br><span class="line">int-br-data     patch-tun       tapcdda0c13-5e</span><br><span class="line"></span><br><span class="line">#demo help</span><br><span class="line">root@juju-7c33c2-bionic-7:~# sudo ls /tmp/snap.ovs-stat/tmp/results</span><br><span class="line">juju-7c33c2-bionic-7</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;&quot;</span><br><span class="line">Choose one of the following:</span><br><span class="line">ofproto-trace</span><br><span class="line">openstack</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;openstack&quot;</span><br><span class="line">Choose one of the following:</span><br><span class="line">openstack.bridge</span><br><span class="line">openstack.bridge.ports</span><br><span class="line">openstack.bridges</span><br><span class="line">openstack.bridges.list</span><br><span class="line">openstack.dvr</span><br><span class="line">openstack.l2pop</span><br><span class="line">openstack.local-vlans</span><br><span class="line">openstack.local-vlans.info</span><br><span class="line">openstack.port</span><br><span class="line">openstack.port.flows</span><br><span class="line">openstack.port.info</span><br><span class="line">openstack.port.list</span><br><span class="line">openstack.ports</span><br><span class="line">openstack.ports.list</span><br><span class="line"></span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;openstack.port tapcdda0c13-5e&quot;</span><br><span class="line">Port tapcdda0c13-5e:</span><br><span class="line">  - bridge: br-int</span><br><span class="line">  - id: 6</span><br><span class="line">  - local-vlan: 3</span><br><span class="line">  - mac address: fe:16:3e:c4:58:9c</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;openstack.l2pop 3&quot;</span><br><span class="line">10.5.0.141</span><br><span class="line"></span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;ofproto-trace&quot;</span><br><span class="line">Choose one of the following:</span><br><span class="line">ofproto-trace.port</span><br><span class="line">ofproto-trace.port.all</span><br><span class="line">root@juju-7c33c2-bionic-7:~# ovs-stat -p /tmp/results --host juju-7c33c2-bionic-7 --query &quot;ofproto-trace.port tapcdda0c13-5e&quot;</span><br><span class="line">IMPORTANT: it looks like this port is attached to a vm so mac address has been converted from fe:16:3e:c4:58:9c to fa:16:3e:c4:58:9c</span><br><span class="line">[arp]</span><br><span class="line">sudo ovs-appctl ofproto/trace br-int in_port=6,arp,arp_spa=192.168.21.7,dl_src=fa:16:3e:c4:58:9c</span><br><span class="line">[icmp]</span><br><span class="line">sudo ovs-appctl ofproto/trace br-int in_port=6,ip,nw_proto=1,nw_src=192.168.21.7,nw_dst=1.1.1.1,dl_src=fa:16:3e:c4:58:9c</span><br><span class="line">[dhcp]</span><br><span class="line">sudo ovs-appctl ofproto/trace br-int udp,in_port=6,dl_src=fa:16:3e:c4:58:9c,dl_dst=ff:ff:ff:ff:ff:ff,nw_src=0.0.0.0,nw_dst=255.255.255.255,udp_src=68,udp_dst=67</span><br><span class="line">[vm-to-vm]</span><br><span class="line">sudo ovs-appctl ofproto/trace br-int in_port=6,tcp,dl_src=fa:16:3e:c4:58:9c,dl_dst=MAC_OF_REMOTE_INSTANCE</span><br><span class="line">sudo ovs-appctl ofproto/trace br-int in_port=6,dl_vlan=3,dl_src=fa:16:3e:c4:58:9c,dl_dst=MAC_OF_REMOTE_INSTANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-7c33c2-bionic-7:~# sudo ovs-appctl ofproto/trace br-int in_port=6,arp,arp_spa=192.168.21.7,dl_src=fa:16:3e:c4:58:9c</span><br><span class="line">Flow: arp,in_port=6,vlan_tci=0x0000,dl_src=fa:16:3e:c4:58:9c,dl_dst=00:00:00:00:00:00,arp_spa=192.168.21.7,arp_tpa=0.0.0.0,arp_op=0,arp_sha=00:00:00:00:00:00,arp_tha=00:00:00:00:00:00</span><br><span class="line">bridge(&quot;br-int&quot;)</span><br><span class="line">----------------</span><br><span class="line"> 0. priority 0, cookie 0xe1185b8d7fdb39b4</span><br><span class="line">    goto_table:60</span><br><span class="line">60. in_port=6, priority 100, cookie 0xe1185b8d7fdb39b4</span><br><span class="line">    set_field:0x6-&gt;reg5</span><br><span class="line">    set_field:0x3-&gt;reg6</span><br><span class="line">    resubmit(,71)</span><br><span class="line">71. arp,reg5=0x6,in_port=6,dl_src=fa:16:3e:c4:58:9c,arp_spa=192.168.21.7, priority 95, cookie 0xe1185b8d7fdb39b4</span><br><span class="line">    resubmit(,94)</span><br><span class="line">94. priority 1, cookie 0xe1185b8d7fdb39b4</span><br><span class="line">    NORMAL</span><br><span class="line">     -&gt; no learned MAC for destination, flooding</span><br><span class="line"></span><br><span class="line">    bridge(&quot;br-tun&quot;)</span><br><span class="line">    ----------------</span><br><span class="line">         0. in_port=1, priority 1, cookie 0x95591ec120b6fb4b</span><br><span class="line">            goto_table:2</span><br><span class="line">         2. dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, priority 0, cookie 0x95591ec120b6fb4b</span><br><span class="line">            goto_table:20</span><br><span class="line">        20. priority 0, cookie 0x95591ec120b6fb4b</span><br><span class="line">            goto_table:22</span><br><span class="line">        22. dl_vlan=3, priority 1, cookie 0x95591ec120b6fb4b</span><br><span class="line">            pop_vlan</span><br><span class="line">            set_field:0x4d1-&gt;tun_id</span><br><span class="line">            output:3</span><br><span class="line">             -&gt; output to kernel tunnel</span><br><span class="line"></span><br><span class="line">bridge(&quot;br-data&quot;)</span><br><span class="line">-----------------</span><br><span class="line"> 0. in_port=1, priority 2, cookie 0xf521d3d0416ecc5b</span><br><span class="line">    drop</span><br><span class="line"></span><br><span class="line">Final flow: arp,reg5=0x6,reg6=0x3,in_port=6,vlan_tci=0x0000,dl_src=fa:16:3e:c4:58:9c,dl_dst=00:00:00:00:00:00,arp_spa=192.168.21.7,arp_tpa=0.0.0.0,arp_op=0,arp_sha=00:00:00:00:00:00,arp_tha=00:00:00:00:00:00</span><br><span class="line">Megaflow: pkt_mark=0,recirc_id=0,ct_state=-trk,eth,arp,in_port=6,vlan_tci=0x0000/0x1fff,dl_src=fa:16:3e:c4:58:9c,dl_dst=00:00:00:00:00:00,arp_spa=192.168.21.7</span><br><span class="line">Datapath actions: set(tunnel(tun_id=0x4d1,src=10.5.2.207,dst=10.5.0.141,ttl=64,tp_dst=4789,flags(df|key))),6,push_vlan(vid=3,pcp=0),1</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/16/WIP-Start-my-first-kernel-journey/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/16/WIP-Start-my-first-kernel-journey/" itemprop="url">(WIP)Start my first kernel journey</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-16T18:58:40+08:00">
                2021-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-03-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>在内核大神gavin同学的帮助下，我开始了人生中第一件和kernel相关的work， 在HP DL360p Gen8服务器上运行OpenStack时发生crash。</p>
<p>先排除APIC问题<br>APIC(Advanced Programmable Interrupt Controller)是用来管理中断的（另一个ACPI是用来管理电源的, Advanced Configuration and Power Interface)。<br>大家知道，I/O设备可以通过DMA(Direct Memory Access)直接存取内存地址（称为DMA地址，也称为Bus address)。最开始，这个DMA地址都是物理内存地址，并且要求只能是一块连续的地址，而且还要求必须是低位地址，极不灵活，也不能适应虚拟机的需要，所以DMAR(DMA remapping)也就出现了，IOMMU硬件负责操作DMA remapping操作在I/O设备访问的DMA地址翻译成实际的物理内存地址，并做检查访问权限的操作实现隔离。<br>当CPU访问一个在地址翻译表中不存在的DMA地址时就会触发一个fault，内核会判断这个是合法还是非法地址，如果是合法地址就分配相应的物理内存并建立从物理地址到虚拟地址的翻译项，如果是非法地址就会给进程发个signal产生core dump。所以这些fault有些是recoverable，有些是non-recoverable，所以IOMMU就利用中断的方式呼唤内核（中断服务程序是dmar_fault)。<br>DMAR的初始化操作是内核使用alloc_iommu函数根据ACPI中的dmar table进行的，每一个表项对应一个dmar设备，名称从dmar0开始依次递增。<br>每个CPU可能会有自己单独的中断控制器（也叫LOCAL APIC，每个CPU一个，处理LOCAL I/O设备的中断，外部I/O设备的中断也是先经I/O APIC再经LOCAL APIC到达处理器, 也可以不经过I/O APIC直接到LOCAL APIC这叫MSI，跨处理器之间的中断Inter-processor interrupts(IPIs)， APIC定时器中断，性能监测计数器的中断，温度传感器中断，APIC内部中断等)，也有一个共用的叫I/O APIC（通常一个机器一个），特性处理。<br>APIC按时期可分为3个版本，APIC, xAPIC与x2APIC。xAPIC中的寄存器是通过内存映射到一段物理地址，在x2APIC模式中，取消了内存映射方式来读取APIC的寄存器，而是采用了MSR的方式。MSR的全写是Model-specific register(每个型号特有的寄存器)这样的好处是不用再担心内存地址的冲突问题。<br>实际上，内核是从BIOS里读取的dmar table，而HP Gen8的BIOS程序是有问题的，它从APIC里读到的dmar table是坏的（通常在系统日志里会报“Your BIOS is broken; DMAR reported at address”）。<br>Driver是OS的一部分(运行在主机的CPU)，Firmware是设备一部分（设备用的镜像，由内核将fireware加载到内存然后由Driver传送到设备上运行在设备里的CPU上), Driver在初始化时可以调用Fireware的request_firmware等接口。<br>在BIOS不支持x2apic的时候内核已经开始支持它了，这会造成问题，所以BIOS检查DMAR的x2apic标志退出内核的x2apic模式，内核也要从代码上支持这种退出（git log 41750d3， intremap=no_x2apic_optout表示内核忽略这种退出)。</p>
<p>&lt;Gen8，硬件不支持x2apic, 内核也就不会用xapic，正确</p>
<blockquote>
<p>Gen8, 硬件支持x2apic, 内核也会用xapic。<br>=Gen8，硬件支持x2apic, 但BIOS没有正确传递dmar table给内核，故内核需做如下设置禁用x2apic，但是Fireware依然使用x2apic，所以内核可能Crash，也可能一些其他奇怪的问题出现。</p>
<h1 id="let-X2APIC-enabled-with-IRQ-remapping，-so-it-only-differs-from-xapic-in-IRQ-remapping"><a href="#let-X2APIC-enabled-with-IRQ-remapping，-so-it-only-differs-from-xapic-in-IRQ-remapping" class="headerlink" title="let X2APIC enabled with IRQ remapping， so it only differs from xapic in IRQ remapping"></a>let X2APIC enabled with IRQ remapping， so it only differs from xapic in IRQ remapping</h1><p>“intel_idle.max_cstate=0 intremap=no_x2apic_optout”<br>OR</p>
<h1 id="disable-X2APIC-AND-IRQ-remapping-will-use-xapic-instead-of-x2apic"><a href="#disable-X2APIC-AND-IRQ-remapping-will-use-xapic-instead-of-x2apic" class="headerlink" title="disable X2APIC AND IRQ remapping, will use xapic instead of x2apic"></a>disable X2APIC AND IRQ remapping, will use xapic instead of x2apic</h1><p>“intel_idle.max_cstate=0 nox2apic intermap=off”     </p>
</blockquote>
<p>禁用C状态<br>闲置时保持低电压状态的处理理的闲置状态称为”C状态“，C0是正常状态，级别高于它状态可以省电，但调度到这省电状态的CPU时延迟时间会略微加长。所以对于某些特殊不需要省电的应用可以禁用它（意味着数据中心的温度升高） 。内核包含了针对Intel处理器C状态的驱动程序（称为intel_idel)，因为它是内核的，所以即使BIOS设置禁用C状态仍然会生效。所以应该使用核心参数intel_idle.max_cstate=0来禁用intel_idle驱动程序，这样，内核将恢复为由BIOS提供的ACPI表开层C状态控制。</p>
<p>General Protection Fault<br>Oops显示为general protection fault。内核发生了污染（make Tainted: G D, P代表私有驱动加载，F代表模块强制加载，R代表模块强制卸载，M代表机器检查，B代表检测到错误页，’GD’ means that some module was not licensed as GPL and that a crash or BUG() occurred. 具体地见：<a href="http://lxr.free-electrons.com/source/Documentation/oops-tracing.txt)，所以的进程在35号CPU上被执行，发生问题的代码是（RIP" target="_blank" rel="external">http://lxr.free-electrons.com/source/Documentation/oops-tracing.txt)，所以的进程在35号CPU上被执行，发生问题的代码是（RIP</a> = kmem_cache_alloc_trace+0x5e/0x140 OR RIP = <strong>kmalloc+0x7b/0x190）。<br>(gdb) list *(</strong>kmalloc+0x7b)<br>0xffffffff8116611b is in __kmalloc (/build/buildd/linux-3.2.0/mm/slub.c:2325).<br>2320 <em> 3. If they were not changed replace tid and freelist<br>2321 </em><br>2322 <em> Since this is without lock semantics the protection is only against<br>2323 </em> code executing on this cpu <em>not</em> from access by other cpus.<br>2324 */<br>2325 if (unlikely(!irqsafe_cpu_cmpxchg_double(<br>2326 s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>2327 object, tid,<br>2328 get_freepointer_safe(s, object), next_tid(tid)))) { </p>
<p>(gdb) list <em>(kmem_cache_alloc_trace+0x5e)<br>0xffffffff8116657e is in kmem_cache_alloc_trace (/build/buildd/linux-3.2.0/mm/slub.c:2325).<br>2320 </em> 3. If they were not changed replace tid and freelist<br>2321 <em><br>2322 </em> Since this is without lock semantics the protection is only against<br>2323 <em> code executing on this cpu </em>not<em> from access by other cpus.<br>2324 </em>/<br>2325 if (unlikely(!irqsafe_cpu_cmpxchg_double(<br>2326 s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>2327 object, tid,<br>2328 get_freepointer_safe(s, object), next_tid(tid)))) { </p>
<p>上面两个地址的输出都指向同一函数irqsafe_cpu_cmpxchg_double， 通过objdump函数查看它的机器码如下：<br>0xffffffff81166576 &lt;+86&gt;: mov (%r12),%rsi<br>0xffffffff8116657e &lt;+94&gt;: mov 0x0(%r13,%rax,1),%rbx ### R13 = UPPER HALF OF BASE POINTER<br>0xffffffff81166583 &lt;+99&gt;: mov %r13,%rax<br>0xffffffff81166586 &lt;+102&gt;: callq 0xffffffff8131cb20 ### CALL </p>
<p>继续查看函数0xffffffff8131cb20的机器码：<br>(gdb) x/30i 0xffffffff8131cb20 ### CALLED<br>0xffffffff8131cb20: pushfq ### PUSH RFLAGS into stack<br>0xffffffff8131cb21: cli ### <strong><strong> CLEAR INTERRUPT FLAG </strong></strong><br>0xffffffff8131cb22: cmp %gs:(%rsi),%rax </p>
<p>所以调用顺序应该如下，猜测极有可能是因为在35号CPU上执行local_irq_save时发生了general protection fault。<br>irqsafe_cpu_cmpxchg_double (#define) -&gt;<br>irqsafe_generic_cpu_cmpxchg_double (#define) -&gt;<br>local_irq_save(#define)-&gt;… </p>
<p>通过crash找源码<br>上面是通过gdb找的源码，直接通过如下的gdb vmlinux找到源码是/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:2412， 想继续看源码需要将源码安装在提示的位置/build/buildd/linux-lts-trusty-3.13.0。<br>gdb /mnt/ddeb-3.13.0-34.60/usr/lib/debug/boot/vmlinux-3.13.0-45-generic<br>Reading symbols from /mnt/ddeb-3.13.0-34.60/usr/lib/debug/boot/vmlinux-3.13.0-45-generic…done.<br>(gdb) list *(kmem_cache_alloc_trace+0x5e)<br>0xffffffff811af2de is in kmem_cache_alloc_trace (/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:2412).<br>2407 /build/buildd/linux-lts-trusty-3.13.0/mm/slub.c: No such file or directory</p>
<p>那样太麻烦，我们来看一下如何通过crash找错误的源码：</p>
<p>crash&gt; dis kmem_cache_alloc_trace+0x7c<br>0xffffffff811af2fc <kmem_cache_alloc_trace+0x7c>:       mov    0x0(%r13,%rax,1),%rbx</kmem_cache_alloc_trace+0x7c></p>
<p>ubuntu@server-2e5cbffc-ed54-465b-9934-f8681dba8c21:/mnt/73670$ addr2line 0xffffffff811af2fc -e /mnt/ddeb-3.13.0-34.60/usr/lib/debug/boot/vmlinux-3.13.0-45-generic -f -i<br>get_freepointer<br>/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:260<br>get_freepointer_safe<br>/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:275<br>slab_alloc_node<br>/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:2416<br>slab_alloc<br>/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:2455<br>kmem_cache_alloc_trace<br>/build/buildd/linux-lts-trusty-3.13.0/mm/slub.c:2472</p>
<p>cmpxchg原子操作<br>看看上面的irqsafe_generic_cpu_cmpxchg_double中的cmpxchg是什么，当多个线程往同一个链表头里插入数据时容易发生同步问题，采用悲观锁的开销太大，可以采用乐观锁重试直至不发生同步为止：<br>do{<br>  old_head = queue-&gt;head;<br>  new_head-&gt;next = old_head;<br>  if (old_head == queue-&gt;head){<br>    queue-&gt;head = new_head;<br>  }<br>}while(queue-&gt;head != new_head)<br>但问题是上面的第4与第5行无法保证原子操作，CPU的cas/cmpxchg指令正是来干这件事让其原子化。具体参见：<a href="http://blog.chinaunix.net/uid-24830931-id-3487817.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-24830931-id-3487817.html</a><br>R = cmpxchg(A, C, B) </p>
<pre><code>- Assign A = B if A == C
- Return A at the time of the call, unconditionally
</code></pre><p>使用cmpxchg指令改写之后的代码如下：<br>do{<br>  old_head = queue-&gt;head;<br>  new_head-&gt;next = old_head;<br>  val=cmpxchg(&amp;queue-&gt;head, old_head, new_head);<br>}while(val!=old_head)</p>
<p>cmpxchg_double<br>根据irqsafe_cpu_cmpxchg_double中的cmpxchg_double搜到（git log)一个bug（git show cdcd62986），可使用参数”intel_idle.max_cstate=0 nox2apic intremap=off”在linux3.8内核中试试。</p>
<p>slab &amp; slub的区别<br>见：<a href="http://events.linuxfoundation.org/images/stories/pdf/klf2012_kim.pdf" target="_blank" rel="external">http://events.linuxfoundation.org/images/stories/pdf/klf2012_kim.pdf</a><br>slab用于传统机器，slob用于嵌入式系统，slub用于大型系统。<br>fast-path，从per-cpu的freelist列表上分配叫fast-path<br>slow-path，从per-cpu的cpu slab（跨cpu了）或partial slabs列表分配叫slow-path<br>very slow-path, 从per-node（跨numa节点了）上分配或加锁分配叫very slow-path.<br>this_cpu_cmpxchg_double用于避免中断，cmpxchg_double用于避免用锁。<br>slub对slab的改进便是：内核的slab_alloc方法就是使用上面的cmpxchg原子操作原理使用乐观锁的方式往slab的freelist里插slub对象（因为执行插这个链表的动态是可能多个CPU在进程调度的）。</p>
<p>排除中断服务程序中由特权级产生的General Protection Fault<br>如果处理过程将在被中断任务同一个特权级上运行，那么：处理器把EFLAGS、CS和EIP寄存器的当前值保存在当前堆栈上。<br>如果异常会产生一个错误号，那么该错误号也会被最后压入新栈中。为了从中断处理过程中返回，处理过程必须使用IRET指令。IRET指令与RET指令类似，但IRET还会把保存的寄存器内容恢复到EFLAGS 中。不过只有当CPL是0时才会恢复EFLAGS中的IOPL字段，并且只有当当前特权级CPL不大于IOPL(I/O Privilege Level in FLAGS register)时，IF标志才会被改变。如果当调用中断处理过程时发生了堆栈切换，那么在返回时IRET指令会切换到原来的堆栈。当CPL&gt;IOPL时便会产生General Protection Fault。CS:0010的地址位数显示在内核态，EFLAGS = 00010282 (Decimal) == 0010 1000 0010 1010 (Binary). IOPL = Bits 12 and 13 from EFLAGS = 10. 所以排除这种特级级产生的General Protection Fault<br>0xffffffff8131cb20: pushfq ### PUSH RFLAGS into stack<br>0xffffffff8131cb21: cli ### <strong><strong> CLEAR INTERRUPT FLAG </strong></strong><br>…<br>Nov 27 18:34:52 sgsxeris001 kernel: [521055.548034] RIP: 0010:[<ffffffff8116616e>] [<ffffffff8116616e>] kmem_cache_alloc_trace+0x5e/0x140<br>Nov 27 18:34:52 sgsxeris001 kernel: [521055.548191] RSP: 0018:ffff883f6f035d98 EFLAGS: 00010282<br>…<br>Nov 27 18:34:52 sgsxeris001 kernel: [521055.548820] CS: 0010 DS: 002b ES: 002b CR0: 000000008005003b </ffffffff8116616e></ffffffff8116616e></p>
<p>“per-cpu”内存是否毁坏<br>内核使用per-cpu为每一个CPU都生成一个变量的副本避免加锁，并充分利用cpu硬件的缓存提升性能。所有CPU的静态per-cpu通过DEFINE_PER_CPU定义在一个特殊的段里。动态per-cpu变量仍然使用页机制。下面显示似乎是free list指针在per-cpu kmem缓存中毁坏了(3.13.0-45-generic有问题，3.13.0-46无问题）， 其中kmem的-S参数代表显示slab缓存信息：<br>crash&gt; kmem -S | grep -i invalid<br>kmem: invalid kernel virtual address: ffff00088fec6500 type: “get_freepointer”<br>kmem: invalid kernel virtual address: ffff0008569645a0  type: “get_freepointer”</p>
<p>继续使用内核参数slub_debug=PU,kmalloc-32,apparmor=0检测(CONFIG_DEBUG_SLAB, 为便于调试，在每个对象可以添加SLAB_RED_ZONE，添加这块内存的最后使用者SLAB_STORE_USER，且用SLAB_POISON初始化对象。当slab出错时，在没有redzone时会在系统日志里将缓存名称与对象开始地址打印出来，若有redzone会将缓存名称、对象开始地址、最后用户、对象的内容、对象前后的信息打印出来)，它一旦检测到slab错误后，内核将丢弃old slab page并且重新分配新的，用它将更难于产生crash(不用这个参数的话得用到这个非法地址后才会panic, 可以使用slab_debug=PUC参数，C代表内核在下一次alocation/free时检测到它为非法地址就panic)，但是可以从它的dmesg信息中找到一些有用的东西进一步分析。</p>
<p>其它类似于slab_debug的内存检测工具有：kmemcheck, kasan(v4.0-rc1)</p>
<p>Kasan是什么<br>用户空间使用AddressSanitizer (Asan), ThreadSanitizer and MemorySanitizer， 这些工具现在是gcc和clang编译器的一部分，内核空间使用Kasan。<br>SLUB_DEBUG/DEBUG_SLAB, Can detect some out-of-bounds and use-after-free accesses， Can’t detect out-of-bounds reads， Detects bugs only on allocation / freeing in some cases<br>DEBUG_PAGEALLOC， Unmaps freed pages from address space， Can detect some use-after-free accesses， Detects use-after-free only when the whole page is unused<br>kmemcheck， Detects use-after-free accesses and uninitialized-memory-reads， Causes page fault on each memory access (slow)<br>KASan(Kernel Address Sanitizer, A dynamic memory error detector for the linux kernel), can detect both out-of-bound and use-after-free errors， Based on compiler instrumentation， Detects out-of-bounds for both writes and reads， Has strong use-after-free detection， Detects bugs at the point of occurrence， Prints informative reports, well replace kmemcheck, Asan will unlikely replace debug slab and pagealloc that can be enabled at runtime. kmemcheck couldn’t work on several CPUs but KASan doesn’t have such limitation.<br><a href="https://gitlab.com/veo-labs/linux/commit/0b24becc810dc3be6e3f94103a866f214c282394" target="_blank" rel="external">https://gitlab.com/veo-labs/linux/commit/0b24becc810dc3be6e3f94103a866f214c282394</a><br>KSan使用1/8的内核内存用做shadow memory(memory中的每8 bytes在shadow memory都映射了1 byte, bit0-0代表这8个bytes都是合法的，哪个bit为1就代表哪个bit不合法, 不同的负数代表不同的非法内存含义如redzones, freed memory)，并使用下列的直接映射方法和memory关联(KASAN_SHADOW_SCALE_SHIFT=3)。<br> unsigned long kasan_mem_to_shadow(unsigned long addr)<br>     {<br>                return (addr &gt;&gt; KASAN_SHADOW_SCALE_SHIFT) + KASAN_SHADOW_OFFSET;<br>     }<br>需要一个特别的编译器将特别的call(<strong>asan_load*(addr, </strong>asan_store*(addr))放在每个以1,2,4,8或16开始的memory前面去检查内存访问是法合法。所以使用它的性能损耗分inline compiler instrumentation and simple linear shadow memory两部分，用户空间的Asan慢2倍左右，内核空间慢10~30%左右。<br>安装，使用CONFIG_KASAN编译后的内核插入test_kasan模块(sudo insmod /lib/modules/4.4.0-9-generic/kernel/lib/test_kasan.ko)。如何分析输出见：<a href="https://www.kernel.org/doc/Documentation/kasan.txt" target="_blank" rel="external">https://www.kernel.org/doc/Documentation/kasan.txt</a></p>
<p>使用crash分析core dump文件<br>$ cat crash-start.sh<br>exec crash –mod /mnt/ddeb-3.13.0-34.60/usr/lib/debug/lib/modules/3.13.0-45-generic/ /mnt/ddeb-3.13.0-34.60/usr/lib/debug/boot/vmlinux-3.13.0-45-generic dump.201502181928</p>
<p>crash&gt; sys |grep KERNEL<br>      KERNEL: /mnt/ddeb-3.13.0-34.60/usr/lib/debug/boot/vmlinux-3.13.0-45-generic</p>
<p>crash&gt; set<br>    PID: 47656<br>COMMAND: “make”<br>   TASK: ffff880115fa3000  [THREAD_INFO: ffff881f136ec000]<br>    CPU: 14<br>  STATE: TASK_RUNNING (PANIC)</p>
<p>crash&gt; ps -a |grep 47656<br>PID: 47656  TASK: ffff880115fa3000  CPU: 14  COMMAND: “make”<br>ps: cannot access user stack address: 7ffff54eead3<br>ps: no user stack</p>
<p>crash&gt; vtop -c 47656 7ffff54eead3<br>VIRTUAL     PHYSICAL<br>7ffff54eead3  5d6e73ad3       </p>
<p>   PML: f82e7c7f8 =&gt; 14fb42067<br>   PUD: 14fb42ff8 =&gt; fda9b9067<br>   PMD: fda9b9d50 =&gt; fdd61d067<br>   PTE: fdd61d770 =&gt; 80000005d6e73865<br>  PAGE: 5d6e73000</p>
<pre><code>PTE         PHYSICAL   FLAGS
</code></pre><p>80000005d6e73865  5d6e73000  (PRESENT|USER|ACCESSED|DIRTY|NX)</p>
<pre><code>VMA           START       END     FLAGS FILE
</code></pre><p>ffff880fe7c34240 7ffff54cd000 7ffff54f2000 100173 </p>
<pre><code>PAGE         PHYSICAL      MAPPING       INDEX CNT FLAGS
</code></pre><p>ffffea00175b9cc0  5d6e73000 ffff8813d0b6e341 7fffffffb  1 2ffff000008006c referenced,uptodate,lru,active,swapbacked</p>
<p>crash&gt; task |grep  sp<br>    sp0 = 0xffff881f136ee000,<br>    sp = 0xffff881f136edf58,<br>    usersp = 0x7ffff54ea970,<br>crash&gt; rd 0xffff881f136edf58 -e 0xffff881f136ee000<br>ffff881f136edf58:  00007ffff54ea80c 0000000002474696   ..N……FG…..<br>ffff881f136edf68:  0000000002474692 00000000026029c0   .FG……)<code>.....
ffff881f136edf78:  00007ffff54ea8b0 0000000000000000   ..N.............
ffff881f136edf88:  0000000000000246 756265642f343431   F.......144/debu
ffff881f136edf98:  2e322e3170735f33 6e69622f37327970   3_sp1.2.py27/bin
ffff881f136edfa8:  000000000000003b ffffffffffffffff   ;...............
ffff881f136edfb8:  00000000026029c0 0000000002603e80   .)</code>……&gt;`…..<br>ffff881f136edfc8:  00007ffff54ea80c 000000000000003b   ..N…..;…….<br>ffff881f136edfd8:  00002b8eeccad427 0000000000000033   ‘….+..3…….<br>ffff881f136edfe8:  0000000000000246 00007ffff54ea138   F…….8.N…..<br>ffff881f136edff8:  000000000000002b                    +…….</p>
<p>crash&gt; files<br>PID: 47656  TASK: ffff880115fa3000  CPU: 14  COMMAND: “make”<br>ROOT: /    CWD: /…../development@2/secure_vm<br> FD       FILE            DENTRY           INODE       TYPE PATH<br>  0 ffff880fde784d00 ffff880daee9c900 ffff880fd3614470 FIFO<br>  1 ffff881223615400 ffff881293e6c180 ffff881fe5ea7d78 FIFO<br>  2 ffff881223615400 ffff881293e6c180 ffff881fe5ea7d78 FIFO<br>  3 ffff881f13757a00 ffff880191c16d80 ffff880fd3612da0 FIFO </p>
<p>crash&gt; kmem -S |grep invalid<br>kmem: invalid kernel virtual address: ffff00088fec6500  type: “get_freepointer”<br>kmem: invalid kernel virtual address: ffff00088fec6500  type: “get_freepointer”</p>
<p>crash&gt; struct kmem_cache<br>struct kmem_cache {<br>    struct kmem_cache_cpu <em>cpu_slab;<br>    unsigned long flags;<br>    unsigned long min_partial;<br>    int size;<br>    int object_size;<br>    int offset;<br>    int cpu_partial;<br>    struct kmem_cache_order_objects oo;<br>    struct kmem_cache_order_objects max;<br>    struct kmem_cache_order_objects min;<br>    gfp_t allocflags;<br>    int refcount;<br>    void (</em>ctor)(void <em>);<br>    int inuse;<br>    int align;<br>    int reserved;<br>    const char </em>name;<br>    struct list_head list;<br>    struct kobject kobj;<br>    struct memcg_cache_params <em>memcg_params;<br>    int max_attr_size;<br>    int remote_node_defrag_ratio;<br>    struct kmem_cache_node </em>node[64];<br>}<br>SIZE: 0x2c8<br>crash&gt; struct kmem_cache.offset<br>struct kmem_cache {<br>   [0x20] int offset;<br>}</p>
<h1 id="disable-apparmor-GRUB-CMDLINE-LINUX-DEFAULT-”quiet-splash-apparmor-0”"><a href="#disable-apparmor-GRUB-CMDLINE-LINUX-DEFAULT-”quiet-splash-apparmor-0”" class="headerlink" title="disable apparmor, GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash apparmor=0”"></a>disable apparmor, GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash apparmor=0”</h1><p>crash&gt; bt -l<br>PID: 47656  TASK: ffff880115fa3000  CPU: 14  COMMAND: “make”</p>
<p> #0 [ffff881f136ed960] machine_kexec at ffffffff8104d9a1<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/machine_kexec_64.c: 266</p>
<p> #1 [ffff881f136ed9d0] crash_kexec at ffffffff810ec218<br>    /build/buildd/linux-lts-trusty-3.13.0/kernel/kexec.c: 1099</p>
<p> #2 [ffff881f136edaa0] oops_end at ffffffff81765ec8<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/dumpstack.c: 230</p>
<p> #3 [ffff881f136edad0] die at ffffffff81018648<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/dumpstack.c: 310</p>
<p> #4 [ffff881f136edb00] do_general_protection at ffffffff817657c0<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/traps.c: 304</p>
<p> #5 [ffff881f136edb30] general_protection at ffffffff817650c8<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/entry_64.S: 1514<br>    [exception RIP: kmem_cache_alloc_trace+0x7c]<br>    RIP: ffffffff811af2fc  RSP: ffff881f136edbe8  RFLAGS: 00010282<br>    RAX: 0000000000000000  RBX: ffff880fff410830  RCX: 0000000000b735a1<br>    RDX: 0000000000b735a0  RSI: 00000000000080d0  RDI: 0000000000016240<br>    RBP: ffff881f136edc38   R8: ffff88203f896240   R9: ffffffff8132906a<br>    R10: 8080808080808080  R11: 0000000000000000  R12: ffff880fff403c00<br>    R13: ffff00088fec6500  R14: 00000000000080d0  R15: ffff880fff403c00<br>    ORIG_RAX: ffffffffffffffff  CS: 0010  SS: 0018</p>
<p> #6 [ffff881f136edc40] apparmor_file_alloc_security at ffffffff8132906a<br>    /build/buildd/linux-lts-trusty-3.13.0/security/apparmor/include/file.h: 61</p>
<p> #7 [ffff881f136edc70] security_file_alloc at ffffffff812e9c56<br>    /build/buildd/linux-lts-trusty-3.13.0/security/security.c: 691</p>
<p> #8 [ffff881f136edc80] get_empty_filp at ffffffff811cc8c0<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/file_table.c: 130</p>
<p> #9 [ffff881f136edcb0] path_openat at ffffffff811da2b8<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/namei.c: 3169</p>
<p>#10 [ffff881f136edd70] do_filp_open at ffffffff811db5c3<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/namei.c: 3238</p>
<p>#11 [ffff881f136ede40] open_exec at ffffffff811d1ec5<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/exec.c: 767</p>
<p>#12 [ffff881f136edea0] do_execve_common at ffffffff811d242b<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/exec.c: 1500</p>
<p>#13 [ffff881f136edf10] do_execve at ffffffff811d26b8<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/exec.c: 1586</p>
<p>#14 [ffff881f136edf20] sys_execve at ffffffff811d293d<br>    /build/buildd/linux-lts-trusty-3.13.0/fs/exec.c: 1688</p>
<p>#15 [ffff881f136edf50] stub_execve at ffffffff8176ded9<br>    /build/buildd/linux-lts-trusty-3.13.0/arch/x86/kernel/entry_64.S: 870<br>    RIP: 00002b8eeccad427  RSP: 00007ffff54ea138  RFLAGS: 00000246<br>    RAX: 000000000000003b  RBX: 0000000000000000  RCX: ffffffffffffffff<br>    RDX: 00000000026029c0  RSI: 0000000002603e80  RDI: 00007ffff54ea80c<br>    RBP: 00007ffff54ea8b0   R8: 6e69622f37327970   R9: 2e322e3170735f33<br>    R10: 756265642f343431  R11: 0000000000000246  R12: 00000000026029c0<br>    R13: 0000000002474692  R14: 0000000002474696  R15: 00007ffff54ea80c<br>    ORIG_RAX: 000000000000003b  CS: 0033  SS: 002b</p>
<p>crash&gt; dis kmem_cache_alloc_trace+0x7c<br>0xffffffff811af2fc <kmem_cache_alloc_trace+0x7c>:       mov    0x0(%r13,%rax,1),%rbx</kmem_cache_alloc_trace+0x7c></p>
<p>crash&gt; dis kmem_cache_alloc_trace<br>0xffffffff811af280 <kmem_cache_alloc_trace>:    nopl   0x0(%rax,%rax,1)<br>0xffffffff811af285 <kmem_cache_alloc_trace+0x5>:        push   %rbp<br>0xffffffff811af286 <kmem_cache_alloc_trace+0x6>:        mov    %rsp,%rbp<br>0xffffffff811af289 <kmem_cache_alloc_trace+0x9>:        push   %r15<br>0xffffffff811af28b <kmem_cache_alloc_trace+0xb>:        mov    %rdi,%r15<br>0xffffffff811af28e <kmem_cache_alloc_trace+0xe>:        push   %r14<br>0xffffffff811af290 <kmem_cache_alloc_trace+0x10>:       mov    %esi,%r14d<br>0xffffffff811af293 <kmem_cache_alloc_trace+0x13>:       push   %r13<br>0xffffffff811af295 <kmem_cache_alloc_trace+0x15>:       push   %r12<br>0xffffffff811af297 <kmem_cache_alloc_trace+0x17>:       push   %rbx<br>0xffffffff811af298 <kmem_cache_alloc_trace+0x18>:       sub    $0x28,%rsp<br>0xffffffff811af29c <kmem_cache_alloc_trace+0x1c>:       mov    0xb65ece(%rip),%eax        # 0xffffffff81d15170 <gfp_allowed_mask><br>0xffffffff811af2a2 <kmem_cache_alloc_trace+0x22>:       mov    %rdx,-0x40(%rbp)<br>0xffffffff811af2a6 <kmem_cache_alloc_trace+0x26>:       mov    0x8(%rbp),%r9<br>0xffffffff811af2aa <kmem_cache_alloc_trace+0x2a>:       and    %esi,%eax<br>0xffffffff811af2ac <kmem_cache_alloc_trace+0x2c>:       test   $0x10,%al<br>0xffffffff811af2ae <kmem_cache_alloc_trace+0x2e>:       je     0xffffffff811af2bd <kmem_cache_alloc_trace+0x3d><br>0xffffffff811af2b0 <kmem_cache_alloc_trace+0x30>:       mov    %r9,-0x50(%rbp)<br>0xffffffff811af2b4 <kmem_cache_alloc_trace+0x34>:       callq  0xffffffff81760d30 <_cond_resched><br>0xffffffff811af2b9 <kmem_cache_alloc_trace+0x39>:       mov    -0x50(%rbp),%r9<br>0xffffffff811af2bd <kmem_cache_alloc_trace+0x3d>:       nopl   0x0(%rax,%rax,1)<br>0xffffffff811af2c2 <kmem_cache_alloc_trace+0x42>:       mov    %r15,%r12<br>0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45>:       mov    (%r12),%r8<br>0xffffffff811af2c9 <kmem_cache_alloc_trace+0x49>:       add    %gs:0xcce8,%r8<br>0xffffffff811af2d2 <kmem_cache_alloc_trace+0x52>:       mov    0x8(%r8),%rdx<br>0xffffffff811af2d6 <kmem_cache_alloc_trace+0x56>:       mov    (%r8),%r13<br>0xffffffff811af2d9 <kmem_cache_alloc_trace+0x59>:       mov    0x10(%r8),%rax<br>0xffffffff811af2dd <kmem_cache_alloc_trace+0x5d>:       test   %r13,%r13<br>0xffffffff811af2e0 <kmem_cache_alloc_trace+0x60>:       je     0xffffffff811af440 <kmem_cache_alloc_trace+0x1c0><br>0xffffffff811af2e6 <kmem_cache_alloc_trace+0x66>:       test   %rax,%rax<br>0xffffffff811af2e9 <kmem_cache_alloc_trace+0x69>:       je     0xffffffff811af440 <kmem_cache_alloc_trace+0x1c0><br>0xffffffff811af2ef <kmem_cache_alloc_trace+0x6f>:       movslq 0x20(%r12),%rax<br>0xffffffff811af2f4 <kmem_cache_alloc_trace+0x74>:       mov    (%r12),%rdi<br>0xffffffff811af2f8 <kmem_cache_alloc_trace+0x78>:       lea    0x1(%rdx),%rcx<br>0xffffffff811af2fc <kmem_cache_alloc_trace+0x7c>:       mov    0x0(%r13,%rax,1),%rbx<br>0xffffffff811af301 <kmem_cache_alloc_trace+0x81>:       mov    %r13,%rax<br>0xffffffff811af304 <kmem_cache_alloc_trace+0x84>:       cmpxchg16b %gs:(%rdi)<br>0xffffffff811af309 <kmem_cache_alloc_trace+0x89>:       sete   %al<br>0xffffffff811af30c <kmem_cache_alloc_trace+0x8c>:       test   %al,%al<br>0xffffffff811af30e <kmem_cache_alloc_trace+0x8e>:       je     0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af310 <kmem_cache_alloc_trace+0x90>:       movslq 0x20(%r12),%rax<br>0xffffffff811af315 <kmem_cache_alloc_trace+0x95>:       prefetcht0 (%rbx,%rax,1)<br>0xffffffff811af319 <kmem_cache_alloc_trace+0x99>:       test   %r13,%r13<br>0xffffffff811af31c <kmem_cache_alloc_trace+0x9c>:       jne    0xffffffff811af418 <kmem_cache_alloc_trace+0x198><br>0xffffffff811af322 <kmem_cache_alloc_trace+0xa2>:       movslq 0x18(%r15),%r15<br>0xffffffff811af326 <kmem_cache_alloc_trace+0xa6>:       mov    0x8(%rbp),%rax<br>0xffffffff811af32a <kmem_cache_alloc_trace+0xaa>:       mov    %rax,-0x48(%rbp)<br>0xffffffff811af32e <kmem_cache_alloc_trace+0xae>:       mov    %r15,-0x38(%rbp)<br>0xffffffff811af332 <kmem_cache_alloc_trace+0xb2>:       nopl   0x0(%rax,%rax,1)<br>0xffffffff811af337 <kmem_cache_alloc_trace+0xb7>:       add    $0x28,%rsp<br>0xffffffff811af33b <kmem_cache_alloc_trace+0xbb>:       mov    %r13,%rax<br>0xffffffff811af33e <kmem_cache_alloc_trace+0xbe>:       pop    %rbx<br>0xffffffff811af33f <kmem_cache_alloc_trace+0xbf>:       pop    %r12<br>0xffffffff811af341 <kmem_cache_alloc_trace+0xc1>:       pop    %r13<br>0xffffffff811af343 <kmem_cache_alloc_trace+0xc3>:       pop    %r14<br>0xffffffff811af345 <kmem_cache_alloc_trace+0xc5>:       pop    %r15<br>0xffffffff811af347 <kmem_cache_alloc_trace+0xc7>:       pop    %rbp<br>0xffffffff811af348 <kmem_cache_alloc_trace+0xc8>:       retq<br>0xffffffff811af349 <kmem_cache_alloc_trace+0xc9>:       nopl   0x0(%rax)<br>0xffffffff811af350 <kmem_cache_alloc_trace+0xd0>:       test   $0x800,%r14d<br>0xffffffff811af357 <kmem_cache_alloc_trace+0xd7>:       mov    %r15,%r12<br>0xffffffff811af35a <kmem_cache_alloc_trace+0xda>:       jne    0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af360 <kmem_cache_alloc_trace+0xe0>:       mov    %gs:0xb7e0,%eax<br>0xffffffff811af368 <kmem_cache_alloc_trace+0xe8>:       test   $0x1fff00,%eax<br>0xffffffff811af36d <kmem_cache_alloc_trace+0xed>:       jne    0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af373 <kmem_cache_alloc_trace+0xf3>:       mov    %gs:0xb800,%rax<br>0xffffffff811af37c <kmem_cache_alloc_trace+0xfc>:       cmpq   $0x0,0x2a8(%rax)<br>0xffffffff811af384 <kmem_cache_alloc_trace+0x104>:      je     0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af38a <kmem_cache_alloc_trace+0x10a>:      testb  $0x20,0x16(%rax)<br>0xffffffff811af38e <kmem_cache_alloc_trace+0x10e>:      jne    0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af394 <kmem_cache_alloc_trace+0x114>:      mov    0x8(%rax),%rdx<br>0xffffffff811af398 <kmem_cache_alloc_trace+0x118>:      mov    0x10(%rdx),%rdx<br>0xffffffff811af39c <kmem_cache_alloc_trace+0x11c>:      and    $0x4,%edx<br>0xffffffff811af39f <kmem_cache_alloc_trace+0x11f>:      jne    0xffffffff811af45b <kmem_cache_alloc_trace+0x1db><br>0xffffffff811af3a5 <kmem_cache_alloc_trace+0x125>:      mov    %r14d,%esi<br>0xffffffff811af3a8 <kmem_cache_alloc_trace+0x128>:      mov    %r15,%rdi<br>0xffffffff811af3ab <kmem_cache_alloc_trace+0x12b>:      mov    %r9,-0x50(%rbp)<br>0xffffffff811af3af <kmem_cache_alloc_trace+0x12f>:      callq  0xffffffff811bc810 <__memcg_kmem_get_cache><br>0xffffffff811af3b4 <kmem_cache_alloc_trace+0x134>:      mov    -0x50(%rbp),%r9<br>0xffffffff811af3b8 <kmem_cache_alloc_trace+0x138>:      mov    %rax,%r12<br>0xffffffff811af3bb <kmem_cache_alloc_trace+0x13b>:      jmpq   0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af3c0 <kmem_cache_alloc_trace+0x140>:      mov    0xb43989(%rip),%rbx        # 0xffffffff81cf2d50 <__tracepoint_kmalloc+0x30><br>0xffffffff811af3c7 <kmem_cache_alloc_trace+0x147>:      test   %rbx,%rbx<br>0xffffffff811af3ca <kmem_cache_alloc_trace+0x14a>:      je     0xffffffff811af40d <kmem_cache_alloc_trace+0x18d><br>0xffffffff811af3cc <kmem_cache_alloc_trace+0x14c>:      mov    (%rbx),%rax<br>0xffffffff811af3cf <kmem_cache_alloc_trace+0x14f>:      lea    0x10(%rbx),%r15<br>0xffffffff811af3d3 <kmem_cache_alloc_trace+0x153>:      mov    %rbx,%r12<br>0xffffffff811af3d6 <kmem_cache_alloc_trace+0x156>:      nopw   %cs:0x0(%rax,%rax,1)<br>0xffffffff811af3e0 <kmem_cache_alloc_trace+0x160>:      mov    0x8(%r12),%rdi<br>0xffffffff811af3e5 <kmem_cache_alloc_trace+0x165>:      add    $0x10,%r12<br>0xffffffff811af3e9 <kmem_cache_alloc_trace+0x169>:      mov    %r14d,%r9d<br>0xffffffff811af3ec <kmem_cache_alloc_trace+0x16c>:      mov    -0x38(%rbp),%r8<br>0xffffffff811af3f0 <kmem_cache_alloc_trace+0x170>:      mov    -0x40(%rbp),%rcx<br>0xffffffff811af3f4 <kmem_cache_alloc_trace+0x174>:      mov    %r13,%rdx<br>0xffffffff811af3f7 <kmem_cache_alloc_trace+0x177>:      mov    -0x48(%rbp),%rsi<br>0xffffffff811af3fb <kmem_cache_alloc_trace+0x17b>:      callq  *%rax<br>0xffffffff811af3fd <kmem_cache_alloc_trace+0x17d>:      mov    %r12,%rax<br>0xffffffff811af400 <kmem_cache_alloc_trace+0x180>:      sub    %rbx,%rax<br>0xffffffff811af403 <kmem_cache_alloc_trace+0x183>:      mov    -0x10(%r15,%rax,1),%rax<br>0xffffffff811af408 <kmem_cache_alloc_trace+0x188>:      test   %rax,%rax<br>0xffffffff811af40b <kmem_cache_alloc_trace+0x18b>:      jne    0xffffffff811af3e0 <kmem_cache_alloc_trace+0x160><br>0xffffffff811af40d <kmem_cache_alloc_trace+0x18d>:      jmpq   0xffffffff811af337 <kmem_cache_alloc_trace+0xb7><br>0xffffffff811af412 <kmem_cache_alloc_trace+0x192>:      nopw   0x0(%rax,%rax,1)<br>0xffffffff811af418 <kmem_cache_alloc_trace+0x198>:      test   $0x8000,%r14d<br>0xffffffff811af41f <kmem_cache_alloc_trace+0x19f>:      je     0xffffffff811af322 <kmem_cache_alloc_trace+0xa2><br>0xffffffff811af425 <kmem_cache_alloc_trace+0x1a5>:      movslq 0x1c(%r12),%rdx<br>0xffffffff811af42a <kmem_cache_alloc_trace+0x1aa>:      xor    %esi,%esi<br>0xffffffff811af42c <kmem_cache_alloc_trace+0x1ac>:      mov    %r13,%rdi<br>0xffffffff811af42f <kmem_cache_alloc_trace+0x1af>:      callq  0xffffffff81387bf0 <__memset><br>0xffffffff811af434 <kmem_cache_alloc_trace+0x1b4>:      jmpq   0xffffffff811af322 <kmem_cache_alloc_trace+0xa2><br>0xffffffff811af439 <kmem_cache_alloc_trace+0x1b9>:      nopl   0x0(%rax)<br>0xffffffff811af440 <kmem_cache_alloc_trace+0x1c0>:      mov    %r9,%rcx<br>0xffffffff811af443 <kmem_cache_alloc_trace+0x1c3>:      mov    $0xffffffff,%edx<br>0xffffffff811af448 <kmem_cache_alloc_trace+0x1c8>:      mov    %r14d,%esi<br>0xffffffff811af44b <kmem_cache_alloc_trace+0x1cb>:      mov    %r12,%rdi<br>0xffffffff811af44e <kmem_cache_alloc_trace+0x1ce>:      callq  0xffffffff81750117 <__slab_alloc><br>0xffffffff811af453 <kmem_cache_alloc_trace+0x1d3>:      mov    %rax,%r13<br>0xffffffff811af456 <kmem_cache_alloc_trace+0x1d6>:      jmpq   0xffffffff811af319 <kmem_cache_alloc_trace+0x99><br>0xffffffff811af45b <kmem_cache_alloc_trace+0x1db>:      testb  $0x1,0x5f1(%rax)<br>0xffffffff811af462 <kmem_cache_alloc_trace+0x1e2>:      je     0xffffffff811af3a5 <kmem_cache_alloc_trace+0x125><br>0xffffffff811af468 <kmem_cache_alloc_trace+0x1e8>:      jmpq   0xffffffff811af2c5 <kmem_cache_alloc_trace+0x45><br>0xffffffff811af46d <kmem_cache_alloc_trace+0x1ed>:      nopl   (%rax)</kmem_cache_alloc_trace+0x1ed></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x1e8></kmem_cache_alloc_trace+0x125></kmem_cache_alloc_trace+0x1e2></kmem_cache_alloc_trace+0x1db></kmem_cache_alloc_trace+0x99></kmem_cache_alloc_trace+0x1d6></kmem_cache_alloc_trace+0x1d3></__slab_alloc></kmem_cache_alloc_trace+0x1ce></kmem_cache_alloc_trace+0x1cb></kmem_cache_alloc_trace+0x1c8></kmem_cache_alloc_trace+0x1c3></kmem_cache_alloc_trace+0x1c0></kmem_cache_alloc_trace+0x1b9></kmem_cache_alloc_trace+0xa2></kmem_cache_alloc_trace+0x1b4></__memset></kmem_cache_alloc_trace+0x1af></kmem_cache_alloc_trace+0x1ac></kmem_cache_alloc_trace+0x1aa></kmem_cache_alloc_trace+0x1a5></kmem_cache_alloc_trace+0xa2></kmem_cache_alloc_trace+0x19f></kmem_cache_alloc_trace+0x198></kmem_cache_alloc_trace+0x192></kmem_cache_alloc_trace+0xb7></kmem_cache_alloc_trace+0x18d></kmem_cache_alloc_trace+0x160></kmem_cache_alloc_trace+0x18b></kmem_cache_alloc_trace+0x188></kmem_cache_alloc_trace+0x183></kmem_cache_alloc_trace+0x180></kmem_cache_alloc_trace+0x17d></kmem_cache_alloc_trace+0x17b></kmem_cache_alloc_trace+0x177></kmem_cache_alloc_trace+0x174></kmem_cache_alloc_trace+0x170></kmem_cache_alloc_trace+0x16c></kmem_cache_alloc_trace+0x169></kmem_cache_alloc_trace+0x165></kmem_cache_alloc_trace+0x160></kmem_cache_alloc_trace+0x156></kmem_cache_alloc_trace+0x153></kmem_cache_alloc_trace+0x14f></kmem_cache_alloc_trace+0x14c></kmem_cache_alloc_trace+0x18d></kmem_cache_alloc_trace+0x14a></kmem_cache_alloc_trace+0x147></__tracepoint_kmalloc+0x30></kmem_cache_alloc_trace+0x140></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x13b></kmem_cache_alloc_trace+0x138></kmem_cache_alloc_trace+0x134></__memcg_kmem_get_cache></kmem_cache_alloc_trace+0x12f></kmem_cache_alloc_trace+0x12b></kmem_cache_alloc_trace+0x128></kmem_cache_alloc_trace+0x125></kmem_cache_alloc_trace+0x1db></kmem_cache_alloc_trace+0x11f></kmem_cache_alloc_trace+0x11c></kmem_cache_alloc_trace+0x118></kmem_cache_alloc_trace+0x114></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x10e></kmem_cache_alloc_trace+0x10a></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x104></kmem_cache_alloc_trace+0xfc></kmem_cache_alloc_trace+0xf3></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0xed></kmem_cache_alloc_trace+0xe8></kmem_cache_alloc_trace+0xe0></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0xda></kmem_cache_alloc_trace+0xd7></kmem_cache_alloc_trace+0xd0></kmem_cache_alloc_trace+0xc9></kmem_cache_alloc_trace+0xc8></kmem_cache_alloc_trace+0xc7></kmem_cache_alloc_trace+0xc5></kmem_cache_alloc_trace+0xc3></kmem_cache_alloc_trace+0xc1></kmem_cache_alloc_trace+0xbf></kmem_cache_alloc_trace+0xbe></kmem_cache_alloc_trace+0xbb></kmem_cache_alloc_trace+0xb7></kmem_cache_alloc_trace+0xb2></kmem_cache_alloc_trace+0xae></kmem_cache_alloc_trace+0xaa></kmem_cache_alloc_trace+0xa6></kmem_cache_alloc_trace+0xa2></kmem_cache_alloc_trace+0x198></kmem_cache_alloc_trace+0x9c></kmem_cache_alloc_trace+0x99></kmem_cache_alloc_trace+0x95></kmem_cache_alloc_trace+0x90></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x8e></kmem_cache_alloc_trace+0x8c></kmem_cache_alloc_trace+0x89></kmem_cache_alloc_trace+0x84></kmem_cache_alloc_trace+0x81></kmem_cache_alloc_trace+0x7c></kmem_cache_alloc_trace+0x78></kmem_cache_alloc_trace+0x74></kmem_cache_alloc_trace+0x6f></kmem_cache_alloc_trace+0x1c0></kmem_cache_alloc_trace+0x69></kmem_cache_alloc_trace+0x66></kmem_cache_alloc_trace+0x1c0></kmem_cache_alloc_trace+0x60></kmem_cache_alloc_trace+0x5d></kmem_cache_alloc_trace+0x59></kmem_cache_alloc_trace+0x56></kmem_cache_alloc_trace+0x52></kmem_cache_alloc_trace+0x49></kmem_cache_alloc_trace+0x45></kmem_cache_alloc_trace+0x42></kmem_cache_alloc_trace+0x3d></kmem_cache_alloc_trace+0x39></_cond_resched></kmem_cache_alloc_trace+0x34></kmem_cache_alloc_trace+0x30></kmem_cache_alloc_trace+0x3d></kmem_cache_alloc_trace+0x2e></kmem_cache_alloc_trace+0x2c></kmem_cache_alloc_trace+0x2a></kmem_cache_alloc_trace+0x26></kmem_cache_alloc_trace+0x22></gfp_allowed_mask></kmem_cache_alloc_trace+0x1c></kmem_cache_alloc_trace+0x18></kmem_cache_alloc_trace+0x17></kmem_cache_alloc_trace+0x15></kmem_cache_alloc_trace+0x13></kmem_cache_alloc_trace+0x10></kmem_cache_alloc_trace+0xe></kmem_cache_alloc_trace+0xb></kmem_cache_alloc_trace+0x9></kmem_cache_alloc_trace+0x6></kmem_cache_alloc_trace+0x5></kmem_cache_alloc_trace></p>
<p>slab_alloc的代码<br>/*</p>
<ul>
<li>Inlined fastpath so that allocation functions (kmalloc, kmem_cache_alloc)</li>
<li>have the fastpath folded into their functions. So no function call</li>
<li>overhead for requests that can be satisfied on the fastpath.<br>*</li>
<li>The fastpath works by first checking if the lockless freelist can be used.</li>
<li>If not then __slab_alloc is called for slow processing.<br>*</li>
<li>Otherwise we can simply pick the next object from the lockless free list.<br><em>/<br>static __always_inline void </em>slab_alloc_node(struct kmem_cache <em>s,<br>gfp_t gfpflags, int node, unsigned long addr)<br>{<br>void **object;<br>struct kmem_cache_cpu </em>c;<br>struct page *page;<br>unsigned long tid;</li>
</ul>
<p>if (slab_pre_alloc_hook(s, gfpflags))<br>return NULL;</p>
<p>s = memcg_kmem_get_cache(s, gfpflags);<br>redo:<br>/*</p>
<ul>
<li>Must read kmem_cache cpu data via this cpu ptr. Preemption is</li>
<li>enabled. We may switch back and forth between cpus while</li>
<li>reading from one cpu area. That does not matter as long</li>
<li>as we end up on the original cpu again when doing the cmpxchg.<br>*</li>
<li>Preemption is disabled for the retrieval of the tid because that</li>
<li>must occur from the current processor. We cannot allow rescheduling</li>
<li>on a different processor between the determination of the pointer</li>
<li>and the retrieval of the tid.<br>*/<br>preempt_disable();<br>c = __this_cpu_ptr(s-&gt;cpu_slab);</li>
</ul>
<p>/*</p>
<ul>
<li>The transaction ids are globally unique per cpu and per operation on</li>
<li>a per cpu queue. Thus they can be guarantee that the cmpxchg_double</li>
<li>occurs on the right processor and that there was no operation on the</li>
<li>linked list in between.<br>*/<br>tid = c-&gt;tid;<br>preempt_enable();</li>
</ul>
<p>object = c-&gt;freelist;<br>page = c-&gt;page;<br>if (unlikely(!object || !node_match(page, node)))<br>object = __slab_alloc(s, gfpflags, node, addr, c);</p>
<p>else {<br>void *next_object = get_freepointer_safe(s, object);   #但是这句是在对应numa节点之下per-cpu数据，不会和下面的this_cpu_cmpxchg_double产生冲突</p>
<p>/*</p>
<ul>
<li>The cmpxchg will only match if there was no additional</li>
<li>operation and if we are on the right processor.<br>*</li>
<li>The cmpxchg does the following atomically (without lock</li>
<li>semantics!)</li>
<li><ol>
<li>Relocate first pointer to the current per cpu area.</li>
</ol>
</li>
<li><ol>
<li>Verify that tid and freelist have not been changed</li>
</ol>
</li>
<li><ol>
<li>If they were not changed replace tid and freelist<br>*</li>
</ol>
</li>
<li>Since this is without lock semantics the protection is only</li>
<li>against code executing on this cpu <em>not</em> from access by</li>
<li>other cpus.<br>*/<br>if (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>object, tid,<br>next_object, next_tid(tid)))) {</li>
</ul>
<p>note_cmpxchg_failure(“slab_alloc”, s, tid);<br>goto redo;<br>}<br>prefetch_freepointer(s, next_object);<br>stat(s, ALLOC_FASTPATH);<br>}</p>
<p>if (unlikely(gfpflags &amp; __GFP_ZERO) &amp;&amp; object)<br>memset(object, 0, s-&gt;object_size);</p>
<p>slab_post_alloc_hook(s, gfpflags, object);</p>
<p>return object;<br>}</p>
<p>代码解释见：<a href="http://blog.chinaunix.net/uid-26859697-id-5498373.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-26859697-id-5498373.html</a><br>this_cpu_cmpxchg_double()原子指令操作。该原子操作主要做了三件事情：1）重定向首指针指向当前CPU的空间；2）判断tid和freelist未被修改；3）如果未被修改，也就是相等，确信此次slab分配未被CPU迁移，接着将新的tid和freelist数据覆盖过去以更新。<br>具体将this_cpu_cmpxchg_double()的功能展开用C语言表述就是:<br>if ((<strong>this_cpu_ptr(s-&gt;cpu_slab-&gt;freelist) == object) &amp;&amp; (</strong>this_cpu_ptr(s-&gt;cpu_slab-&gt;tid) == tid))<br>{<br>    <strong>this_cpu_ptr(s-&gt;cpu_slab-&gt;freelist) = next_object;
    </strong>this_cpu_ptr(s-&gt;cpu_slab-&gt;tid) = next_tid(tid);<br>    return true;<br>}<br>else<br>{<br>    return false;<br>}</p>
<p>CONFIG_DEBUG_PAGEALLOC参数<br>下面发现错误的get_freepointer函数里有CONFIG_DEBUG_PAGEALLOC（debug_pagealloc=1），我们来研究一下这个参数CONFIG_DEBUG_PAGEALLOC。<br>static inline void <em>get_freepointer_safe(struct kmem_cache </em>s, void <em>object)<br>{<br>void </em>p;</p>
<p>#ifdef CONFIG_DEBUG_PAGEALLOC<br>probe_kernel_read(&amp;p, (void **)(object + s-&gt;offset), sizeof(p));</p>
<p>#else<br>p = get_freepointer(s, object);</p>
<p>#endif<br>return p;<br>}</p>
<p>见：<a href="https://lwn.net/Articles/321595/，" target="_blank" rel="external">https://lwn.net/Articles/321595/，</a> 它不能检测read非法内存，只能检测write非法内存，并且要好长一段时间写到那里才发生。</p>
<p>per-cpu数据的内核抢占问题<br>同步有两层：一层是不同cpu之间的，第二层是相同cpu之间的(虽然get_freepointer_safe作为per-cpu的数据无论什么时候都不会被其他cpu执行，但是this_cpu_cmpxchg_double作为乐观锁是有可能不执行freelist/tid更新的（进程调度到同一CPU上执行了slab对象的free操作），这时候乐观执行 get_freepointer_safe就会访问错误内存地址了)。第一种不同cpu之间的情形已经采用per-cpu机制自动做了，但是第二种相同cpu之间在不禁止进程抢占的情形下仍然是有可能发生同步问题的，那内核是怎么做到的呢？<br>static <strong>always_inline void slab_free(struct kmem_cache <em>s,<br>struct page </em>page, void *x, unsigned long addr){<br>…<br>redo:<br>preempt_disable();<br>c = </strong>this_cpu_ptr(s-&gt;cpu_slab);<br>tid = c-&gt;tid;<br>preempt_enable();</p>
<p>if (likely(page == c-&gt;page)) {<br>set_freepointer(s, object, c-&gt;freelist);</p>
<p>static <strong>always_inline void <em>slab_alloc_node(struct kmem_cache </em>s,<br>gfp_t gfpflags, int node, unsigned long addr){<br>…<br>redo:<br>preempt_disable();<br>c = </strong>this_cpu_ptr(s-&gt;cpu_slab);<br>tid = c-&gt;tid;<br>preempt_enable();</p>
<p>object = c-&gt;freelist;<br>page = c-&gt;page;<br>if (unlikely(!object || !node_match(page, node)))<br>object = __slab_alloc(s, gfpflags, node, addr, c);<br>else {<br>void *next_object = get_freepointer_safe(s, object);</p>
<p>slab_alloc_node与slab_free获取freelist是禁止抢占了的，是成对出现的，应该内核没同步这方面的问题</p>
<p>Kasan检查<br>内核排查似乎没有问题，有可能是应用层使用slab时先free再引用出的问题，但仅从crash无法找到是哪个应用造成的，还得结合kasan来继续追查（DEBUG_PAGELLOC这些参数对read无效，仅对write有效，所以真正crash时离发生内存错误的时间较远，参考价值不大），kasan更加实时。kasan结果如下：<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>[230056.938787] ==================================================================<br>[230056.938834] BUG: KASan: out of bounds access in isolate_migratepages_range+0x663/0xb30 at addr ffff880279cc76d1<br>[230056.938869] Read of size 8 by task cc1/27473<br>[230056.938887] =============================================================================<br>[230056.938915] BUG anon_vma (Not tainted): kasan: bad access detected<br>[230056.938936] —————————————————————————–<br>[230056.938936]<br>[230056.938970] Disabling lock debugging due to kernel taint<br>[230056.938981] INFO: Allocated in anon_vma_prepare+0x189/0x250 age=7323 cpu=16 pid=31029<br>[230056.939012] <strong>slab_alloc+0x4f8/0x560<br>[230056.939029] kmem_cache_alloc+0x18b/0x1e0<br>[230056.939047] anon_vma_prepare+0x189/0x250<br>[230056.939065] do_wp_page+0x837/0xb10<br>[230056.939081] handle_mm_fault+0x884/0x1160<br>[230056.939102] </strong>do_page_fault+0x218/0x750<br>[230056.939119] do_page_fault+0x1a/0x70<br>[230056.939135] page_fault+0x28/0x30<br>[230056.939154] INFO: Freed in <strong>put_anon_vma+0x69/0xe0 age=8588 cpu=4 pid=29418<br>[230056.939212] </strong>slab_free+0x2ab/0x3f0<br>[230056.939260] kmem_cache_free+0x1c1/0x200<br>[230056.939307] <strong>put_anon_vma+0x69/0xe0<br>[230056.939355] unlink_anon_vmas+0x2a8/0x320<br>[230056.939402] free_pgtables+0x50/0x1c0<br>[230056.939450] exit_mmap+0xca/0x1e0<br>[230056.939496] mmput+0x82/0x1b0<br>[230056.939541] do_exit+0x391/0x1060<br>[230056.939587] do_group_exit+0x86/0x130<br>[230056.939633] SyS_exit_group+0x1d/0x20<br>[230056.939681] system_call_fastpath+0x1a/0x1f<br>[230056.939729] INFO: Slab 0xffffea0009e73100 objects=43 used=30 fp=0xffff880279cc67a8 flags=0x2ffff0000004080<br>[230056.939820] INFO: Object 0xffff880279cc7658 @offset=13912 fp=0xffff880279cc7c38<br>[230056.939820]<br>[230056.939939] Bytes b4 ffff880279cc7648: 10 00 00 00 5b 17 00 00 ef 25 6b 03 01 00 00 00 ….[….%k…..<br>[230056.940031] Object ffff880279cc7658: 58 76 cc 79 02 88 ff ff 00 00 00 00 00 00 00 00 Xv.y…………<br>[230056.940123] Object ffff880279cc7668: 00 00 00 00 5a 5a 5a 5a 70 76 cc 79 02 88 ff ff ….ZZZZpv.y….<br>[230056.940214] Object ffff880279cc7678: 70 76 cc 79 02 88 ff ff 01 00 00 00 03 00 00 00 pv.y…………<br>[230056.940306] Object ffff880279cc7688: 58 76 cc 79 02 88 ff ff b8 2a 20 31 02 88 ff ff Xv.y…..* 1….<br>[230056.940400] CPU: 8 PID: 27473 Comm: cc1 Tainted: G B 3.13.0-76-generic #120hf00073670v20160120b0h5d3e6ab<br>[230056.940406] Hardware name: Cisco Systems Inc UCSC-C220-M3L/UCSC-C220-M3L, BIOS C220M3.2.0.3.0.080120140402 08/01/2014<br>[230056.940410] ffffea0009e73100 ffff880736bbf750 ffffffff81a6e195 ffff8804e881b840<br>[230056.940422] ffff880736bbf780 ffffffff81244c1d ffff8804e881b840 ffffea0009e73100<br>[230056.940431] ffff880279cc7658 ffffea001aa99c98 ffff880736bbf7a8 ffffffff8124ad66<br>[230056.940440] Call Trace:<br>[230056.940450] [<ffffffff81a6e195>] dump_stack+0x45/0x56<br>[230056.940458] [<ffffffff81244c1d>] print_trailer+0xfd/0x170<br>[230056.940466] [<ffffffff8124ad66>] object_err+0x36/0x40<br>[230056.940474] [<ffffffff8124cd29>] kasan_report_error+0x1e9/0x3a0<br>[230056.940484] [<ffffffff8125d9f8>] ? memcg_check_events+0x28/0x380<br>[230056.940491] [<ffffffff81221c2d>] ? rmap_walk+0x32d/0x340<br>[230056.940499] [<ffffffff8124d390>] kasan_report+0x40/0x50<br>[230056.940506] [<ffffffff81205ee3>] ? isolate_migratepages_range+0x663/0xb30<br>[230056.940513] [<ffffffff8124c019>] </ffffffff8124c019></ffffffff81205ee3></ffffffff8124d390></ffffffff81221c2d></ffffffff8125d9f8></ffffffff8124cd29></ffffffff8124ad66></ffffffff81244c1d></ffffffff81a6e195></strong>asan_load8+0x69/0xa0<br>[230056.940521] [<ffffffff81205ee3>] isolate_migratepages_range+0x663/0xb30<br>[230056.940531] [<ffffffff811dc5e7>] ? zone_watermark_ok+0x57/0x70<br>[230056.940538] [<ffffffff812067c6>] compact_zone+0x416/0x700<br>[230056.940545] [<ffffffff81206b45>] compact_zone_order+0x95/0x100<br>[230056.940553] [<ffffffff81207002>] try_to_compact_pages+0x102/0x1a0<br>[230056.940562] [<ffffffff811e21e6>] <strong>alloc_pages_direct_compact+0x96/0x290<br>[230056.940570] [<ffffffff811e2d5e>] </ffffffff811e2d5e></strong>alloc_pages_nodemask+0x97e/0xc40<br>[230056.940578] [<ffffffff8123ce24>] alloc_pages_vma+0xb4/0x200<br>[230056.940587] [<ffffffff812572ca>] do_huge_pmd_anonymous_page+0x13a/0x490<br>[230056.940594] [<ffffffff8120f072>] ? do_numa_page+0x192/0x200<br>[230056.940602] [<ffffffff81210c07>] handle_mm_fault+0x267/0x1160<br>[230056.940610] [<ffffffff81a7d028>] <strong>do_page_fault+0x218/0x750<br>[230056.940618] [<ffffffff8121aead>] ? do_mmap_pgoff+0x47d/0x500<br>[230056.940627] [<ffffffff811fd699>] ? vm_mmap_pgoff+0xa9/0xd0<br>[230056.940635] [<ffffffff81a7d57a>] do_page_fault+0x1a/0x70<br>[230056.940642] [<ffffffff81a785a8>] page_fault+0x28/0x30<br>[230056.940645] Memory state around the buggy address:<br>[230056.940696] ffff880279cc7580: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.940780] ffff880279cc7600: fc fc fc fc fc fc fc fc fc fc fc 00 00 00 00 00<br>[230056.940865] &gt;ffff880279cc7680: 00 00 00 fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.940947] ^<br>[230056.941001] ffff880279cc7700: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.941085] ffff880279cc7780: fc fc fc fc fc fc fc fc fc fc 00 00 00 00 00 00<br>[230056.941167] ==================================================================<br>[230056.941250] ==================================================================<br>[230056.941336] BUG: KASan: out of bounds access in balloon_page_isolate+0x6a/0x1d0 at addr ffff880279cc76d1<br>[230056.941426] Read of size 8 by task cc1/27473<br>[230056.941473] =============================================================================<br>[230056.941560] BUG anon_vma (Tainted: G B ): kasan: bad access detected<br>[230056.941642] —————————————————————————–<br>[230056.941642]<br>[230056.941764] INFO: Allocated in anon_vma_prepare+0x189/0x250 age=7323 cpu=16 pid=31029<br>[230056.941850] </ffffffff81a785a8></ffffffff81a7d57a></ffffffff811fd699></ffffffff8121aead></strong>slab_alloc+0x4f8/0x560<br>[230056.941898] kmem_cache_alloc+0x18b/0x1e0<br>[230056.941946] anon_vma_prepare+0x189/0x250<br>[230056.941993] do_wp_page+0x837/0xb10<br>[230056.942039] handle_mm_fault+0x884/0x1160<br>[230056.942087] <strong>do_page_fault+0x218/0x750<br>[230056.942134] do_page_fault+0x1a/0x70<br>[230056.942180] page_fault+0x28/0x30<br>[230056.942228] INFO: Freed in </strong>put_anon_vma+0x69/0xe0 age=8588 cpu=4 pid=29418<br>[230056.942286] <strong>slab_free+0x2ab/0x3f0<br>[230056.942333] kmem_cache_free+0x1c1/0x200<br>[230056.942381] </strong>put_anon_vma+0x69/0xe0<br>[230056.942428] unlink_anon_vmas+0x2a8/0x320<br>[230056.942476] free_pgtables+0x50/0x1c0<br>[230056.942523] exit_mmap+0xca/0x1e0<br>[230056.942567] mmput+0x82/0x1b0<br>[230056.942611] do_exit+0x391/0x1060<br>[230056.942657] do_group_exit+0x86/0x130<br>[230056.942703] SyS_exit_group+0x1d/0x20<br>[230056.942750] system_call_fastpath+0x1a/0x1f<br>[230056.942798] INFO: Slab 0xffffea0009e73100 objects=43 used=30 fp=0xffff880279cc67a8 flags=0x2ffff0000004080<br>[230056.942889] INFO: Object 0xffff880279cc7658 @offset=13912 fp=0xffff880279cc7c38<br>[230056.942889]<br>[230056.943006] Bytes b4 ffff880279cc7648: 10 00 00 00 5b 17 00 00 ef 25 6b 03 01 00 00 00 ….[….%k…..<br>[230056.943098] Object ffff880279cc7658: 58 76 cc 79 02 88 ff ff 00 00 00 00 00 00 00 00 Xv.y…………<br>[230056.943190] Object ffff880279cc7668: 00 00 00 00 5a 5a 5a 5a 70 76 cc 79 02 88 ff ff ….ZZZZpv.y….<br>[230056.943281] Object ffff880279cc7678: 70 76 cc 79 02 88 ff ff 01 00 00 00 03 00 00 00 pv.y…………<br>[230056.943372] Object ffff880279cc7688: 58 76 cc 79 02 88 ff ff b8 2a 20 31 02 88 ff ff Xv.y…..* 1….<br>[230056.943465] CPU: 8 PID: 27473 Comm: cc1 Tainted: G B 3.13.0-76-generic #120hf00073670v20160120b0h5d3e6ab<br>[230056.943470] Hardware name: Cisco Systems Inc UCSC-C220-M3L/UCSC-C220-M3L, BIOS C220M3.2.0.3.0.080120140402 08/01/2014<br>[230056.943473] ffffea0009e73100 ffff880736bbf710 ffffffff81a6e195 ffff8804e881b840<br>[230056.943482] ffff880736bbf740 ffffffff81244c1d ffff8804e881b840 ffffea0009e73100<br>[230056.943491] ffff880279cc7658 ffffea001aa99c98 ffff880736bbf768 ffffffff8124ad66<br>[230056.943500] Call Trace:<br>[230056.943507] [<ffffffff81a6e195>] dump_stack+0x45/0x56<br>[230056.943515] [<ffffffff81244c1d>] print_trailer+0xfd/0x170<br>[230056.943523] [<ffffffff8124ad66>] object_err+0x36/0x40<br>[230056.943530] [<ffffffff8124cd29>] kasan_report_error+0x1e9/0x3a0<br>[230056.943537] [<ffffffff8124d390>] kasan_report+0x40/0x50<br>[230056.943544] [<ffffffff812075fa>] ? balloon_page_isolate+0x6a/0x1d0<br>[230056.943551] [<ffffffff8124c019>] <strong>asan_load8+0x69/0xa0<br>[230056.943558] [<ffffffff8124d390>] ? kasan_report+0x40/0x50<br>[230056.943565] [<ffffffff812075fa>] balloon_page_isolate+0x6a/0x1d0<br>[230056.943572] [<ffffffff8124c019>] ? </ffffffff8124c019></ffffffff812075fa></ffffffff8124d390></strong>asan_load8+0x69/0xa0<br>[230056.943579] [<ffffffff81206315>] isolate_migratepages_range+0xa95/0xb30<br>[230056.943587] [<ffffffff811dc5e7>] ? zone_watermark_ok+0x57/0x70<br>[230056.943594] [<ffffffff812067c6>] compact_zone+0x416/0x700<br>[230056.943602] [<ffffffff81206b45>] compact_zone_order+0x95/0x100<br>[230056.943609] [<ffffffff81207002>] try_to_compact_pages+0x102/0x1a0<br>[230056.943617] [<ffffffff811e21e6>] <strong>alloc_pages_direct_compact+0x96/0x290<br>[230056.943625] [<ffffffff811e2d5e>] </ffffffff811e2d5e></strong>alloc_pages_nodemask+0x97e/0xc40<br>[230056.943633] [<ffffffff8123ce24>] alloc_pages_vma+0xb4/0x200<br>[230056.943641] [<ffffffff812572ca>] do_huge_pmd_anonymous_page+0x13a/0x490<br>[230056.943649] [<ffffffff8120f072>] ? do_numa_page+0x192/0x200<br>[230056.943656] [<ffffffff81210c07>] handle_mm_fault+0x267/0x1160<br>[230056.943664] [<ffffffff81a7d028>] __do_page_fault+0x218/0x750<br>[230056.943672] [<ffffffff8121aead>] ? do_mmap_pgoff+0x47d/0x500<br>[230056.943680] [<ffffffff811fd699>] ? vm_mmap_pgoff+0xa9/0xd0<br>[230056.943687] [<ffffffff81a7d57a>] do_page_fault+0x1a/0x70<br>[230056.943694] [<ffffffff81a785a8>] page_fault+0x28/0x30<br>[230056.943698] Memory state around the buggy address:<br>[230056.943748] ffff880279cc7580: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.943832] ffff880279cc7600: fc fc fc fc fc fc fc fc fc fc fc 00 00 00 00 00<br>[230056.943917] &gt;ffff880279cc7680: 00 00 00 fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.943999] ^<br>[230056.944053] ffff880279cc7700: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>[230056.944138] ffff880279cc7780: fc fc fc fc fc fc fc fc fc fc 00 00 00 00 00 00<br>[230056.944220] ==================================================================</ffffffff81a785a8></ffffffff81a7d57a></ffffffff811fd699></ffffffff8121aead></ffffffff81a7d028></ffffffff81210c07></ffffffff8120f072></ffffffff812572ca></ffffffff8123ce24></ffffffff811e21e6></ffffffff81207002></ffffffff81206b45></ffffffff812067c6></ffffffff811dc5e7></ffffffff81206315></ffffffff8124c019></ffffffff812075fa></ffffffff8124d390></ffffffff8124cd29></ffffffff8124ad66></ffffffff81244c1d></ffffffff81a6e195></ffffffff81a7d028></ffffffff81210c07></ffffffff8120f072></ffffffff812572ca></ffffffff8123ce24></ffffffff811e21e6></ffffffff81207002></ffffffff81206b45></ffffffff812067c6></ffffffff811dc5e7></ffffffff81205ee3></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/16/Compile-old-non-existing-UCA-packages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/16/Compile-old-non-existing-UCA-packages/" itemprop="url">Compile old non-existing UCA packages</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-16T18:57:18+08:00">
                2021-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2016-08-05<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br><a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</strong></p>
<p>For example, we want to use qemu 1:2.2+dfsg-5expubuntu9.6~cloud0, but those packages don’t exist anymore in UCA.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-cache madison qemu-system</span><br><span class="line">qemu-system | 1:2.5+dfsg-5ubuntu10.2~cloud0 | http://ubuntu-cloud.archive.canonical.com/ubuntu/ trusty-updates/mitaka/main amd64 Packages</span><br><span class="line">qemu-system | 1:2.2+dfsg-5expubuntu9.7~cloud5 | http://ppa.launchpad.net/ubuntu-cloud-archive/kilo-staging/ubuntu/ trusty/main amd64 Packages</span><br><span class="line">qemu-system | 2.0.0+dfsg-2ubuntu1.26 | http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages</span><br><span class="line">qemu-system | 2.0.0+dfsg-2ubuntu1.26 | http://security.ubuntu.com/ubuntu/ trusty-security/main amd64 Packages</span><br><span class="line">qemu-system | 2.0.0~rc1+dfsg-0ubuntu3 | http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages</span><br><span class="line">      qemu | 2.0.0~rc1+dfsg-0ubuntu3 | http://archive.ubuntu.com/ubuntu/ trusty/main Sources</span><br><span class="line">      qemu | 2.0.0+dfsg-2ubuntu1.26 | http://archive.ubuntu.com/ubuntu/ trusty-updates/main Sources</span><br><span class="line">      qemu | 2.0.0+dfsg-2ubuntu1.26 | http://security.ubuntu.com/ubuntu/ trusty-security/main Sources</span><br><span class="line">      qemu | 1:2.2+dfsg-5expubuntu9.7~cloud5 | http://ppa.launchpad.net/ubuntu-cloud-archive/kilo-staging/ubuntu/ trusty/main Sources</span><br></pre></td></tr></table></figure></p>
<p>But we can compile them by ourself.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+packages?field.name_filter=qemu&amp;field.status_filter=superseded&amp;field.series_filter=</span><br><span class="line">wget https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz</span><br><span class="line">wget https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</span><br><span class="line">wget https://launchpad.net/~ubuntu-cloud-archive/+archive/ubuntu/kilo-staging/+files/qemu_2.2+dfsg.orig.tar.xz</span><br><span class="line">dpkg-source -x qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</span><br><span class="line">cd qemu-2.2+dfsg/</span><br><span class="line">sudo apt-get install gnupg pbuilder ubuntu-dev-tools bzr-builddeb apt-file devscripts</span><br><span class="line">sudo apt-add-repository ppa:ubuntu-cloud-archive/kilo-staging</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get build-dep qemu</span><br><span class="line">dpkg-checkbuilddeps</span><br><span class="line">DEB_BUILD_OPTIONS=nocheck debuild -us -uc</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">qemu-2.2+dfsg</span><br><span class="line">qemu_2.2+dfsg-5expubuntu9.6~cloud0_amd64.build</span><br><span class="line">qemu_2.2+dfsg-5expubuntu9.6~cloud0_amd64.changes</span><br><span class="line">qemu_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu_2.2+dfsg-5expubuntu9.6~cloud0.debian.tar.gz</span><br><span class="line">qemu_2.2+dfsg-5expubuntu9.6~cloud0.dsc</span><br><span class="line">qemu_2.2+dfsg.orig.tar.xz</span><br><span class="line">qemu-guest-agent_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-kvm_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-arm_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-common_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-mips_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-misc_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-ppc_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-sparc_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-system-x86_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-user_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-user-binfmt_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-user-static_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br><span class="line">qemu-utils_2.2+dfsg-5expubuntu9.6~cloud0_amd64.deb</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/16/Perform-a-bisect-test-to-identify-the-kernel-problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/16/Perform-a-bisect-test-to-identify-the-kernel-problem/" itemprop="url">Perform a bisect test to identify the kernel problem</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-16T18:56:00+08:00">
                2021-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>作者：张华 发表于：2016-12-15<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</em></p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>sriov在Xenial上不work, <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1633634" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1633634</a></p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>先测Xenial最新的Ubuntu Kernel 4.4.0.57.60 (sudo apt-cache policy linux-image-generic-lts-xenial)。如果它没有问题，说明Upstream Kernel中的fixed patch已经被backport到了Ubuntu Xenial Kernel；如果它也有问题，一般需要在Upstream Kernel里bisect</li>
<li><p>初略扫描代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</span><br><span class="line">git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git</span><br><span class="line">git log --tags --simplify-by-decoration --pretty=&quot;format:%ci %d&quot;</span><br><span class="line">#git log v3.13..v4.4 --oneline --no-merges |wc -l</span><br><span class="line">git log --since=&quot;2015-06-21 22:05:43&quot; --before=&quot;2015-07-05 11:01:52&quot; --oneline --no-merges |wc -l</span><br><span class="line">#filter by commit&apos;s author date rather than commit date, commit date may change when merging branch</span><br><span class="line">git log --since=&quot;2015-06-21 22:05:43&quot; --before=&quot;2015-07-05 11:01:52&quot; --format=&quot;%ad %h %s&quot; --date=iso --no-merges &gt; diff</span><br><span class="line">#Unfortunately, &apos;git log b953c0d..d770e55&apos; or &apos;git log tag1..tag2&apos; is not guaranteed to work</span><br><span class="line">#because those commits may be in different branches.</span><br><span class="line">#&apos;..&apos; means all of the commits that are in the v4.2-rc1 branch, but aren’t in the v4.1 branch</span><br><span class="line">#git log --no-merges --oneline v4.1..v4.2-rc1 &gt; diff</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Upstream Kernel (<a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/)中继续bisect确定问题出在4.1和4.2-rc1之间" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/)中继续bisect确定问题出在4.1和4.2-rc1之间</a>. 参考：<a href="https://wiki.ubuntu.com/KernelTeam/GitKernelBuild" target="_blank" rel="external">https://wiki.ubuntu.com/KernelTeam/GitKernelBuild</a> (<strong>注：下列的命令只是针对Upstream Kernel</strong>, 对ubuntu Kernel的编译方法可见： <a href="https://blog.csdn.net/quqi99/article/details/50745614" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/50745614</a>) </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git bisect start</span><br><span class="line">git bisect bad v4.2-rc1</span><br><span class="line">git bisect good v4.1</span><br><span class="line"></span><br><span class="line">git checkout bisect/bad</span><br><span class="line">#git bisect log &gt; bisectlog</span><br><span class="line">git bisect reset</span><br><span class="line">#git bisect replay bisectlog</span><br><span class="line"></span><br><span class="line">sudo apt-get install git build-essential kernel-package fakeroot libncurses5-dev libssl-dev ccache</span><br><span class="line">cp /boot/config-`uname -r` .config   #or make menuconfig </span><br><span class="line">make localmodconfig                  #speed compiling time for test by just using existing module config</span><br><span class="line">make clean</span><br><span class="line">yes &apos;&apos; | make oldconfig              #bring the config file up to date.</span><br><span class="line">make -j `getconf _NPROCESSORS_ONLN` deb-pkg LOCALVERSION=-custom</span><br><span class="line">#make drivers/usb/ehci.ko            #just build a module</span><br></pre></td></tr></table></figure>
</li>
<li><p>(optional) sriov test method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/cmdline </span><br><span class="line">BOOT_IMAGE=/boot/vmlinuz-4.1.36-040136-generic root=UUID=70f8e4d5-1773-4bb9-9dcc-f46ac966ebac ro pci-stub.ids=8086:10ca apparmor=0 intel_iommu=pt intel_iommu=on pci=assign-busses</span><br><span class="line"></span><br><span class="line">ln -s /etc/apparmor.d/usr.sbin.libvirtd  /etc/apparmor.d/disable/</span><br><span class="line">ln -s /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper  /etc/apparmor.d/disable/</span><br><span class="line">apparmor_parser -R  /etc/apparmor.d/usr.sbin.libvirtd</span><br><span class="line">apparmor_parser -R  /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper</span><br><span class="line"></span><br><span class="line">sudo dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">sudo lspci |grep 82576</span><br><span class="line">sudo virsh nodedev-list --tree </span><br><span class="line">find /sys/kernel/iommu_groups/ -type l</span><br><span class="line"></span><br><span class="line">readlink -f /sys/bus/pci/devices/0000:07:10.2/iommu_group</span><br><span class="line">echo 0000:07:10.2 &gt; /sys/bus/pci/devices/0000:07:10.2/driver/unbind</span><br><span class="line">echo 0000:07:10.2 &gt; /sys/bus/pci/drivers/vfio-pci/bind</span><br><span class="line">echo &quot;8086 10ca&quot; &gt; /sys/bus/pci/drivers/vfio-pci/new_id</span><br><span class="line"></span><br><span class="line">sudo tailf /var/log/libvirt/qemu/openstack.log</span><br><span class="line">sudo virsh attach-device openstack /root/new-device.xml --live --config</span><br><span class="line">$ sudo cat /root/new-device.xml</span><br><span class="line">&lt;hostdev mode=&apos;subsystem&apos; type=&apos;pci&apos; managed=&apos;yes&apos;&gt;</span><br><span class="line"> &lt;source&gt;</span><br><span class="line">   &lt;address domain=&apos;0x0000&apos; bus=&apos;0x07&apos; slot=&apos;0x10&apos; function=&apos;0x3&apos;/&gt;</span><br><span class="line"> &lt;/source&gt;</span><br><span class="line">&lt;/hostdev&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fixed patch找到了的SRU问题，Upstream Kernel有LTS(<a href="https://www.kernel.org/category/releases.html" target="_blank" rel="external">https://www.kernel.org/category/releases.html</a>), Ubuntu Kernel也有LTS(<a href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack)。" target="_blank" rel="external">https://wiki.ubuntu.com/Kernel/LTSEnablementStack)。</a><br>a) 如对于Xenial, Ubuntu Kernel是v4.4, 而v4.4也是Upstream LTS Kernel，所以需要将Fixed patch先backport到Upstream Kernel v4.4，而Ubuntu LTS Kernel会定期从Upstream LTS Kernel里拉，所以就不需要backport到Ubuntu kernel了。<br>b) 如对于trusty, Ubuntu Kernel是3.13, 该版本不是Upstream LTS Kernel，故需直接backport到Ubuntu Kernel v3.13即可（<a href="https://wiki.ubuntu.com/KernelTeam/KernelUpdates）" target="_blank" rel="external">https://wiki.ubuntu.com/KernelTeam/KernelUpdates）</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel" target="_blank" rel="external">https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel</a><br>[2] <a href="https://wiki.ubuntu.com/Kernel/Dev/KernelGitGuide" target="_blank" rel="external">https://wiki.ubuntu.com/Kernel/Dev/KernelGitGuide</a><br>[3] <a href="https://wiki.edubuntu.org/Kernel/Dev/KernelBugFixing" target="_blank" rel="external">https://wiki.edubuntu.org/Kernel/Dev/KernelBugFixing</a><br>[4] <a href="https://wiki.ubuntu.com/KernelTeam/KernelUpdates" target="_blank" rel="external">https://wiki.ubuntu.com/KernelTeam/KernelUpdates</a><br>[5] <a href="https://wiki.ubuntu.com/Kernel/Dev/StablePatchFormat" target="_blank" rel="external">https://wiki.ubuntu.com/Kernel/Dev/StablePatchFormat</a><br>[6] <a href="https://wiki.ubuntu.com/KernelTeam/GitKernelBuild" target="_blank" rel="external">https://wiki.ubuntu.com/KernelTeam/GitKernelBuild</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">96</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
