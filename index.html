<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/13/恢复系统记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/13/恢复系统记录/" itemprop="url">恢复系统记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-13T09:26:11+08:00">
                2020-11-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2017-02-09<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</strong></p>
<p>今天系统又无故crash并无法启动了，折腾了一下午，记录一下。</p>
<p>突然运行“sudo apt-get update”时发生错误，一看是写保护，所以运行”sudo mount -o rw,remount /“, 但是系统报”unknown filesystem”，接着就crash了。</p>
<p>重启后出现了grub resue界面，试图通过下列命令恢复grub时仍然报”unknown filesystem”错误。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ls (hd1,msdos5)</span><br><span class="line">set root=(hd1,msdos5)</span><br><span class="line">set prefix=(hd1,5)/boot/grub</span><br><span class="line">lsmod normal</span><br><span class="line">normal</span><br><span class="line"></span><br><span class="line">sudo update-grub</span><br><span class="line">sudo grub-install /dev/sdb</span><br></pre></td></tr></table></figure></p>
<p>通过usb启动盘启动后运行“sudo fsck.ext4 -y /dev/sda9”之后上面磁盘的问题是解决了，也出现了登录界面，但是却无法登录，原本想通过下列命令重置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -fr ~/.cache/compizconfig-1</span><br><span class="line">sudo rm -fr ~/.Xauthority</span><br><span class="line">sudo apt-get install --reinstall ubuntu-desktop unity compizconfig-settings-manager</span><br><span class="line">sudo dconf reset -f /org/compiz/</span><br><span class="line">setsid unity</span><br><span class="line">sudo rm -fr .cache/</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://kuring.me/ref/x_window/X_client_server_example.svg.png</span><br><span class="line">linux itself –&gt; X Server(xorg|wayland) &lt;- [X Protocol] -&gt; unity-greeter -&gt; Display Manager(GDM|lightdm, login GUI, /etc/X11/default-display-manager, or sudo dpkg-reconfigure lightdm) -&gt; Desktop Manager(GNOME, KDE) -&gt; X Application(eg: xclock)</span><br><span class="line">1, ctrl+alt+fn [n: 1-12]: used to switch virtual control console, 1-6 is used for linux (eg: echo $DISPLAY &amp;&amp; xclock -display :0 &amp;&amp; DISPLAY=:0 xclock)</span><br><span class="line">2, startx process (login -&gt; bash -&gt; startx -&gt; xinit -&gt; X -&gt; ck-xinit-session -&gt; gnome-session), xinit is used to start X Server software.</span><br><span class="line">3, &apos;init 5&apos; is used to restart X window</span><br></pre></td></tr></table></figure>
<p>但是发现/var/lib/dpkg目录不存在了，另外也有其他很多程序出现少文件的问题，不是我删除的，应该是fsck命令没有全部正确恢复inode吧。这种情况只能重装操作系统了，将所有工作需要的应用都安装好后也做了一个备份（dd if=/dev/sdb conv=sync,noerror bs=64K | gzip -c  &gt; /images/working_os_bak.img.gz）， 今后再出问题时希望通过命令（gunzip -c /images/working_os_bak.img.gz | dd of=/dev/sdb conv=sync,noerror bs=64K）能快速恢复操作系统和所需要的应用吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># dd if=/dev/sdb conv=sync,noerror bs=64K | gzip -c  &gt; /images/working_os_bak.img.gz</span><br><span class="line">1831575+1 records in</span><br><span class="line">1831576+0 records out</span><br><span class="line">120034164736 bytes (120 GB, 112 GiB) copied, 914.123 s, 131 MB/s</span><br><span class="line"></span><br><span class="line">$ ll /images/working_os_bak.img.gz -h</span><br><span class="line">-rw-r--r-- 1 root root 4.7G Feb  9 17:36 /images/working_os_bak.img.gz</span><br></pre></td></tr></table></figure>
<p>硬盘损坏看起来像：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;- - -&quot; &gt; /sys/class/scsi_host/host0/scan</span><br><span class="line"></span><br><span class="line">#Unused HDD</span><br><span class="line">Mar  1 10:24:28 node1 kernel: [ 2697.930058] ata3: hard resetting link</span><br><span class="line">Mar  1 10:24:28 node1 kernel: [ 2698.245478] ata3: SATA link down (SStatus 0 SControl 300)</span><br><span class="line">Mar  1 10:24:28 node1 kernel: [ 2698.245490] ata3: EH complete</span><br><span class="line"></span><br><span class="line">#Good HDD</span><br><span class="line">Mar  1 10:23:43 node1 kernel: [ 2652.763243] ata1: hard resetting link</span><br><span class="line">Mar  1 10:23:43 node1 kernel: [ 2653.077298] ata1: SATA link up 6.0 Gbps (SStatus 133 SControl 300)</span><br><span class="line">Mar  1 10:23:43 node1 kernel: [ 2653.097249] ata1.00: configured for UDMA/133</span><br><span class="line">Mar  1 10:23:43 node1 kernel: [ 2653.097251] ata1: EH complete</span><br><span class="line"></span><br><span class="line">#Bad HDD</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696088] ata2.00: exception Emask 0x0 SAct 0x80000 SErr 0x0 action 0x6 frozen</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696098] ata2.00: failed command: READ FPDMA QUEUED</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696108] ata2.00: cmd 60/10:98:b0:bd:3c/00:00:a6:00:00/40 tag 19 ncq 8192 in</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696108]          res 40/00:00:00:00:00/00:00:00:00:00/00 Emask 0x4 (timeout)</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696113] ata2.00: status: &#123; DRDY &#125;</span><br><span class="line">Feb 28 16:00:30 node1 kernel: [  231.696119] ata2: hard resetting link</span><br><span class="line">Feb 28 16:00:36 node1 kernel: [  237.059963] ata2: link is slow to respond, please be patient (ready=0)</span><br><span class="line">Feb 28 16:00:40 node1 kernel: [  241.707975] ata2: COMRESET failed (errno=-16)</span><br><span class="line">Feb 28 16:00:40 node1 kernel: [  241.707980] ata2: hard resetting link</span><br><span class="line">Feb 28 16:00:46 node1 kernel: [  247.067970] ata2: link is slow to respond, please be patient (ready=0)</span><br></pre></td></tr></table></figure></p>
<p>换硬盘不需要重装系统，将fstab文件修改一下即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LABEL=&quot;images&quot; /images         ext4    defaults        0       2</span><br><span class="line">LABEL=&quot;bak&quot; /bak         ext4    defaults        0       2</span><br><span class="line">192.168.99.122:/Public /nas nfs noauto,x-systemd.automount,x-systemd.device-timeout=10,timeo=14,x-systemd.idle-timeout=1min 0 0</span><br></pre></td></tr></table></figure></p>
<h2 id="201923更新-解决login-loop问题"><a href="#201923更新-解决login-loop问题" class="headerlink" title="201923更新 - 解决login loop问题"></a>201923更新 - 解决login loop问题</h2><p>反复出现登录界面, 根据下列流程, 似乎问题只可能出现在gnome这块出问题了才会回到lightdm的登录界面处.<br>linux itself –&gt; X Server(xorg|wayland) &lt;- [X Protocol] -&gt; unity-greeter -&gt; Display Manager(GDM|lightdm, login GUI, /etc/X11/default-display-manager, or sudo dpkg-reconfigure lightdm) -&gt; Desktop Manager(GNOME, KDE) -&gt; X Application(eg: xclock)<br>搜索kern.log的Call strace确认问题与nvidia驱动相关:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> 733 Nov 16 22:47:03 localhost kernel: [    1.896228] Could not determine valid watermarks for inherited state</span><br><span class="line"> 734 Nov 16 22:47:03 localhost kernel: [    1.896290] WARNING: CPU: 2 PID: 183 at /build/linux-O4X9pa/linux-4.15.0/drivers/gpu/d</span><br><span class="line"> 735 Nov 16 22:47:03 localhost kernel: [    1.896293] Modules linked in: nvidia_drm(POE) nvidia_modeset(POE) nvidia(POE) rtsx_pc</span><br><span class="line"> 736 Nov 16 22:47:03 localhost kernel: [    1.896309] CPU: 2 PID: 183 Comm: systemd-udevd Tainted: P           OE    4.15.0-68-g</span><br><span class="line"> 737 Nov 16 22:47:03 localhost kernel: [    1.896311] Hardware name: LENOVO 20AN002LCD/20AN002LCD, BIOS GLET64WW (2.18 ) 12/18/2</span><br><span class="line"> 738 Nov 16 22:47:03 localhost kernel: [    1.896342] RIP: 0010:intel_modeset_init+0xfcf/0x1010 [i915]</span><br><span class="line"></span><br><span class="line">748 Nov 16 22:47:03 localhost kernel: [    1.896362] Call Trace:</span><br><span class="line"> 749 Nov 16 22:47:03 localhost kernel: [    1.896389]  i915_driver_load+0xa73/0xe60 [i915]</span><br><span class="line"> 750 Nov 16 22:47:03 localhost kernel: [    1.896414]  i915_pci_probe+0x42/0x70 [i915]</span><br><span class="line"> 751 Nov 16 22:47:03 localhost kernel: [    1.896418]  local_pci_probe+0x47/0xa0</span><br><span class="line"> 752 Nov 16 22:47:03 localhost kernel: [    1.896421]  pci_device_probe+0x10e/0x1c0</span><br><span class="line"> 753 Nov 16 22:47:03 localhost kernel: [    1.896424]  driver_probe_device+0x30c/0x490</span><br><span class="line"> 754 Nov 16 22:47:03 localhost kernel: [    1.896426]  __driver_attach+0xcc/0xf0</span><br><span class="line"> 755 Nov 16 22:47:03 localhost kernel: [    1.896429]  ? driver_probe_device+0x490/0x490</span><br><span class="line"> 756 Nov 16 22:47:03 localhost kernel: [    1.896431]  bus_for_each_dev+0x70/0xc0</span><br><span class="line"> 757 Nov 16 22:47:03 localhost kernel: [    1.896433]  driver_attach+0x1e/0x20</span><br><span class="line"> 758 Nov 16 22:47:03 localhost kernel: [    1.896436]  bus_add_driver+0x1c7/0x270</span><br><span class="line"> 759 Nov 16 22:47:03 localhost kernel: [    1.896438]  ? 0xffffffffc041b000</span><br><span class="line"> 760 Nov 16 22:47:03 localhost kernel: [    1.896440]  driver_register+0x60/0xe0</span><br><span class="line"> 761 Nov 16 22:47:03 localhost kernel: [    1.896442]  ? 0xffffffffc041b000</span><br><span class="line"> 762 Nov 16 22:47:03 localhost kernel: [    1.896444]  __pci_register_driver+0x5a/0x60</span><br><span class="line"> 763 Nov 16 22:47:03 localhost kernel: [    1.896465]  i915_init+0x5c/0x5f [i915]</span><br></pre></td></tr></table></figure>
<p>升级nvidia驱动从nvidia-driver-390到435看是否能解决问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">deb http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu bionic main</span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys FCAE110B1118213C</span><br><span class="line">sudo apt purge nvidia-driver-390 &amp;&amp; sudo apt autoremove &amp;&amp; sudo apt install nvidia-driver-435</span><br></pre></td></tr></table></figure></p>
<p>也可以试试:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://launchpad.net/~canonical-kernel-team/+archive/ubuntu/ppa</span><br><span class="line">sudo apt upgrade-dist</span><br><span class="line">sudo add-apt-repository ppa:canonical-kernel-team/ppa</span><br><span class="line">#can install the latest hwe kernel by using above ppa</span><br><span class="line">sudo apt install --install-recommends linux-generic-hwe-18.04 xserver-xorg-hwe-18.04</span><br></pre></td></tr></table></figure></p>
<p>20200203更 , 还是不行, 用下列方法重装了desktop再观察:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /var/lib/apt/lists/lock</span><br><span class="line">sudo rm /var/lib/dpkg/lock</span><br><span class="line">sudo rm /var/lib/dpkg/lock-frontend</span><br><span class="line">sudo dpkg --configure -a</span><br><span class="line">sudo apt clean</span><br><span class="line">sudo apt update --fix-missing</span><br><span class="line">sudo apt install -f</span><br><span class="line">sudo dpkg --configure -a</span><br><span class="line">sudo apt upgrade</span><br><span class="line">sudo apt dist-upgrade</span><br><span class="line"></span><br><span class="line">sudo apt purge *unity*</span><br><span class="line">sudo apt purge *gnome*</span><br><span class="line">sudo apt autoremove</span><br><span class="line">sudo apt-get install --reinstall ubuntu-desktop</span><br><span class="line">sudo update-grub</span><br><span class="line">sudo apt install gdm3</span><br><span class="line">sudo dpkg-reconfigure gdm3</span><br><span class="line"></span><br><span class="line">#Install Gnome and set it as default</span><br><span class="line">sudo apt install gnome-session</span><br><span class="line">sudo update-alternatives --config gdm3.css</span><br><span class="line">sudo reboot</span><br><span class="line">#Switch to a Windows-like Taskbar - https://vitux.com/how-to-get-the-windows-look-feel-on-ubuntu/</span><br><span class="line">sudo apt install gnome-shell-extensions gnome-shell-extension-dash-to-panel gnome-tweaks adwaita-icon-theme-full</span><br><span class="line"></span><br><span class="line">#Install windows-style desktop Cinnamon, but it&apos;s bluetooth doesn&apos;t work</span><br><span class="line">sudo add-apt-repository ppa:embrosyn/cinnamon</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install cinnamon</span><br><span class="line">#sudo apt remove --autoremove cinnamon cinnamon-desktop-data</span><br><span class="line">#sudo add-apt-repository --remove ppa:embrosyn/cinnamon</span><br></pre></td></tr></table></figure>
<p>20201113更新，切换到使用wayland再试试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:~$ grep -r &apos;Wayland&apos; /etc/gdm3/custom.conf</span><br><span class="line">WaylandEnable=true</span><br><span class="line">sudo systemctl restart gdm3</span><br><span class="line">hua@t440p:~$ echo $XDG_SESSION_TYPE</span><br><span class="line">wayland</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/12/解决ssh-server偶尔连不上或者发现网络连接初始很慢的状况/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/12/解决ssh-server偶尔连不上或者发现网络连接初始很慢的状况/" itemprop="url">解决ssh server偶尔连不上或者发现网络连接初始很慢的状况</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-12T11:35:06+08:00">
                2020-11-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<p>今天花了近一天时间解决了一个恶心的问题，回过头看来当然很简单了，但要记录一下。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>我将办公用的台式机搬到了客厅，今后打算每天在笔记本上通过ssh连接到台式机办公。但是发生ssh连接老断，刚开始以为是ssh keepalive的问题，照着这个博客（<a href="http://blog.csdn.net/quqi99/article/details/51434248）配置后仍然无效。ssh连接断了之后，到台式机上查看发现网络是好的，重启台式机上的网络和ssh服务仍然无效，但重启笔记本上的网络服务就好了。大概五六分钟发生一次吧。" target="_blank" rel="external">http://blog.csdn.net/quqi99/article/details/51434248）配置后仍然无效。ssh连接断了之后，到台式机上查看发现网络是好的，重启台式机上的网络和ssh服务仍然无效，但重启笔记本上的网络服务就好了。大概五六分钟发生一次吧。</a></p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>家里的tplink摄像头指定了固定IP 192.168.99.123，不知道为什么openwrt路由器将这个已占用的IP分配给了台式机。因为摄像头长期没用了，这个IP也ping不通，并且dnsmasq的/tmp/dhcp.leases配置文件中显示的这个IP都是和台式机的hostname在一起的，所以刚开始就没有想到这个重要的问题。</p>
<p>1, 当在台式机上ping网关时，居然第一次要停顿11秒，但第二次之后就正常了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hua@node1:~$ time ping -c 1 192.168.99.1</span><br><span class="line">PING 192.168.99.1 (192.168.99.1): 56 data bytes</span><br><span class="line">--- 192.168.99.1 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line">real	0m11.012s</span><br><span class="line">user	0m0.000s</span><br><span class="line">sys	0m0.000s</span><br></pre></td></tr></table></figure></p>
<p>2, 台式机给网关发消息，台式机通过arp广播要网关的mac地址，网关向台式机返回arp响应，但这个响应被错误的发到摄像头的mac f0:7d:68:0c:90:40之上，所以当问题发生时，路由器抓包到了大量的下列消息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# tcpdump -i br-lan  -e -n &apos;icmp&apos; and src host 192.168.99.123</span><br><span class="line">14:10:30.449983 f8:32:e4:be:87:cd &gt; 04:a1:51:8a:2c:a7, ethertype IPv4 (0x0800), length 98: 192.168.99.123 &gt; 192.168.99.1: ICMP echo request, id 9604, seq 0, length 64</span><br><span class="line">14:10:33.403550 f0:7d:68:0c:90:40 &gt; 04:a1:51:8a:2c:a7, ethertype IPv4 (0x0800), length 118: 192.168.99.123 &gt; 85.199.214.101: ICMP 192.168.99.123 udp port 123 unreachable, length 84</span><br></pre></td></tr></table></figure></p>
<p>3, 台式机因为等不到arp请求，从而停顿。</p>
<p>使用“ip -s -s neigh flush all”命令清台式机与路由器arp cache均无效，在台式机上运行arp请求会很慢。</p>
<p>后来给台式机更换其他IP就好了.</p>
<p>我看到的这个问题的影响如下：<br>1, 当笔记本采用ssh连接到台式机上，也就会时不时发生停顿现象<br>2, 使用apt update时会第一次连接时像断了一样，但后面又好了</p>
<h2 id="附录：Ubuntu下的远程桌面与X转发"><a href="#附录：Ubuntu下的远程桌面与X转发" class="headerlink" title="附录：Ubuntu下的远程桌面与X转发"></a>附录：Ubuntu下的远程桌面与X转发</h2><p>上面解决了ssh连接办公的问题，下面将远程桌面一并解决。</p>
<p>Ubuntu下有一个默认的vino-server, 可在”Desktop Sharing”中开启，另外，需要运行dconf-editor将org-&gt;gnome-&gt;desktop-&gt;remote-access中的requre-encryption去掉，最后使用Remmina Remote Desktop Client选择vnc协议输入“IP :0”登录。不过，这种自带的Vino-Server方式有一个最显著的缺点：那就是当你重启机器之后，必须首先到远程服务器那边登录机器，进入系统（相当于创建了一个Session）之后，才能在本地使用远程桌面连接这个远程服务器。所以我们改使用vnc4server。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install vnc4server xvnc4viewer</span><br><span class="line">vncpasswd</span><br><span class="line"># First time to run it to generate ~/.vnc</span><br><span class="line">vncserver :2</span><br><span class="line">ll ~/.vnc/</span><br><span class="line">vncserver -kill :2</span><br><span class="line"># Second time to run it after modifying ~/.vnc</span><br><span class="line">sudo apt install mate-session-manager</span><br><span class="line">echo &apos;exec /usr/bin/mate-session &amp;&apos; &gt;&gt; ~/.vnc/xstartup</span><br><span class="line">vncserver :2 -geometry 1280x680 -alwaysshared</span><br><span class="line">Client Side: vncviewer node1:2</span><br></pre></td></tr></table></figure>
<p>运行”ssh -vvv -X -o ForwardX11=yes node1“时报错”X11 forwarding request failed on channel 0“， 这是因为出于安全原因，OpenSSH默认将X11转发请求绑定到本地回环地址上，并且在DISPLAY环境变量中将主机名设置为“localhost”。在这样的设定下，一些 X11客户端不能正确处理X11转发，这会导致报告中的错误。要解决这个问题，在/etc/ssh/sshd配置文件中加入下面这几行，它可以将X11转发请求绑定到外网卡地址上。<br>X11Forwarding yes<br>X11UseLocalhost no<br>如果远程主机的SSH服务禁止了IPv6，那么X11转发失败的错误也有可能发生。故还需要添加： AddressFamily inet</p>
<h2 id="20191220更新-另一个例子"><a href="#20191220更新-另一个例子" class="headerlink" title="20191220更新 - 另一个例子"></a>20191220更新 - 另一个例子</h2><p><img src="https://img-blog.csdnimg.cn/20191220175958218.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly96aGh1YWJqLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">客户有两个external的dmz网络172.21.8.0/24与193.169.205.0/24</span><br><span class="line">两个neutron vrouter, dmzrouterinternal接172.21.8.0/24(qg-xxx=172.21.8.87), dmzroutereexternal接193.169.205.0/24</span><br><span class="line">dmzrouterinternal接一个subnet(192.168.4.1), 这样创建一个测试VM=192.168.4.199 FIP=172.21.8.85</span><br><span class="line">一个外部物理路由器有172.21.8.1与193.169.205.1, 外部路由器上接一个外部dns服务器(193.169.205.141)</span><br><span class="line">问题是VM无法ping 193.169.205.141, 抓包看到ARP reply到达了dmzrouterinternal却被drop掉了</span><br><span class="line">15:26:20.634541 ARP, Request who-has 193.169.205.141 tell 172.21.8.87, length 28</span><br><span class="line">15:26:20.634810 ARP, Reply 193.169.205.141 is-at 00:15:5d:2d:d9:2c (oui Unknown), length 46</span><br><span class="line"></span><br><span class="line">发现它有这些路由:</span><br><span class="line"># ip netns exec qrouter-ffd74122-45b4-4155-b585-fe62b2d3edd4 ip route</span><br><span class="line">default via 172.21.8.1 dev qg-d84aed2a-34</span><br><span class="line">172.21.8.0/24 dev qg-d84aed2a-34 proto kernel scope link src 172.21.8.87</span><br><span class="line">192.168.4.0/24 dev qr-3c248a21-06 proto kernel scope link src 192.168.4.1</span><br><span class="line">193.169.205.0/24 dev qg-d84aed2a-34 scope link</span><br><span class="line"></span><br><span class="line">显然问题是这条路由&apos;193.169.205.0/24 dev qg-d84aed2a-34 scope link&apos;造成dmzrouterinternal与externaldns直连:</span><br><span class="line">ping之前, 看到193.169.205.141 at 00:00:0c:9f:f0:2c, 00:00:0c:9f:f0:2c是172.21.8.1的mac</span><br><span class="line"># arp -a</span><br><span class="line">? (192.168.4.42) at fa:16:3e:79:07:f0 [ether] on qr-3c248a21-06</span><br><span class="line">? (193.169.205.141) at 00:00:0c:9f:f0:2c [ether] on qg-d84aed2a-34</span><br><span class="line">当ping时, tcpdump收到ARP reply里的mac是00:15:5d:2d:d9:2c, 而不是00:00:0c:9f:f0:2c, 所以drop掉.</span><br><span class="line"></span><br><span class="line">如果临时运行下列命令, 也能ping通, 但一会儿这个arp就会过期, 问题就会再次重现, 所以解决的办法是删除这条路由(193.169.205.0/24 dev qg-d84aed2a-34 scope link)</span><br><span class="line">arp -d 193.169.205.141</span><br><span class="line">arp -i qg-d84aed2a-34 -s 193.169.205.141 02:00:5e:10:de:14</span><br><span class="line"></span><br><span class="line">下面做一个实验, 用一个neutron vrouter externalrouter来模拟外部物理路由器.</span><br><span class="line">./generate-bundle.sh -s bionic -r stein --num-compute 2</span><br><span class="line"></span><br><span class="line">openstack router create externalrouter</span><br><span class="line">openstack network create dmzexternalnet --external</span><br><span class="line">openstack network create dmzinternalnet --external</span><br><span class="line">openstack subnet create --subnet-range 172.21.8.0/24 --network dmzinternalnet --allocation-pool start=172.21.8.86,end=172.21.8.100 --gateway 172.21.8.1 dmzsubnetinternal</span><br><span class="line">openstack subnet create --subnet-range 193.169.205.0/24 --network dmzexternalnet --allocation-pool start=193.169.205.87,end=193.169.205.100 --gateway 193.169.205.1 dmzsubnetexternal</span><br><span class="line">openstack router add subnet externalrouter dmzsubnetinternal</span><br><span class="line">openstack router add subnet externalrouter dmzsubnetexternal</span><br><span class="line"></span><br><span class="line">#注:也可以不创建两个network, 只创建一个network, 然后将两个subnet都加到这个network, 在和router关联时特殊处理, 如:</span><br><span class="line">openstack router create --disable --centralized --ha dmzrouterinternal</span><br><span class="line">openstack router add subnet dmzrouterinternal dmztenantinternalsubnet</span><br><span class="line">openstack router set --external-gateway dmznet --fixed-ip subnet=dmzsubnetinternal,ip-address=172.21.8.87 dmzrouterinternal</span><br><span class="line">openstack router set --enable dmzrouterinternal</span><br><span class="line"></span><br><span class="line">openstack router create dmzrouterinternal</span><br><span class="line">openstack router set --external-gateway dmzinternalnet dmzrouterinternal</span><br><span class="line">openstack network create tenantnet</span><br><span class="line">openstack subnet create --subnet-range 192.168.4.0/24 --network tenantnet --allocation-pool start=192.168.4.87,end=192.168.4.100 --gateway 192.168.4.1 tenantsubnet</span><br><span class="line">openstack router add subnet dmzrouterinternal tenantsubnet</span><br><span class="line"></span><br><span class="line">openstack router create dmzrouterexternal</span><br><span class="line">openstack router set --external-gateway dmzexternalnet dmzrouterexternal</span><br><span class="line"></span><br><span class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --wait --image cirros2 --flavor m1.small --key-name mykey --network=$(openstack network show dmzexternalnet -c id -f value) externaldns</span><br><span class="line">openstack server create --wait --image cirros2 --flavor m1.small --key-name mykey --network=$(openstack network show tenantnet -c id -f value) i1</span><br><span class="line">dmzinternalnet=$(openstack network show dmzinternalnet -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $dmzinternalnet -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address 192.168.4.100 --port $(openstack port list --fixed-ip ip-address=192.168.4.100 -c id -f value)</span><br><span class="line"></span><br><span class="line">$ openstack server list</span><br><span class="line">+--------------------------------------+-------------+--------+--------------------------------------+---------+----------+</span><br><span class="line">| ID                                   | Name        | Status | Networks                             | Image   | Flavor   |</span><br><span class="line">+--------------------------------------+-------------+--------+--------------------------------------+---------+----------+</span><br><span class="line">| 3a1d1c70-6165-4060-ad78-9c67717e61e8 | externaldns | ACTIVE | dmzexternalnet=193.169.205.99        | cirros2 | m1.small |</span><br><span class="line">| 89b497c0-f236-4df4-8293-18f44547e239 | i1          | ACTIVE | tenantnet=192.168.4.100, 172.21.8.95 | cirros2 | m1.small |</span><br><span class="line">+--------------------------------------+-------------+--------+--------------------------------------+---------+----------+</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~/stsstack-bundles/openstack$ openstack router list</span><br><span class="line">+--------------------------------------+-------------------+--------+-------+----------------------------------+-------------+-------+</span><br><span class="line">| ID                                   | Name              | Status | State | Project                          | Distributed | HA    |</span><br><span class="line">+--------------------------------------+-------------------+--------+-------+----------------------------------+-------------+-------+</span><br><span class="line">| 09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 | dmzrouterinternal | ACTIVE | UP    | e2402e56ee0a4c31904e46b5c01c80f8 | False       | False |</span><br><span class="line">| 8320db06-5a9d-46fb-8af6-5c7b974ff7a9 | externalrouter    | ACTIVE | UP    | e2402e56ee0a4c31904e46b5c01c80f8 | False       | False |</span><br><span class="line">| ef19ea38-13e0-416a-9ce1-ac25c8aba9c0 | dmzrouterexternal | ACTIVE | UP    | e2402e56ee0a4c31904e46b5c01c80f8 | False       | False |</span><br><span class="line">+--------------------------------------+-------------------+--------+-------+----------------------------------+-------------+-------+</span><br><span class="line"></span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 ip route add 193.169.205.0/24 dev qg-e6cd9397-b8 scope link</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 ip route</span><br><span class="line">default via 172.21.8.1 dev qg-e6cd9397-b8</span><br><span class="line">172.21.8.0/24 dev qg-e6cd9397-b8 proto kernel scope link src 172.21.8.92</span><br><span class="line">192.168.4.0/24 dev qr-e4d7b70a-14 proto kernel scope link src 192.168.4.1</span><br><span class="line">193.169.205.0/24 dev qg-e6cd9397-b8 scope link</span><br><span class="line">$ ping 193.169.205.99 -c 1</span><br><span class="line">...</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"></span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 arp -d 193.169.205.99</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 arp -i qg-e6cd9397-b8 -s 193.169.205.99 fa:16:3e:7b:af:d6</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 arp -a</span><br><span class="line">? (172.21.8.1) at fa:16:3e:0f:87:da [ether] on qg-e6cd9397-b8</span><br><span class="line">? (193.169.205.99) at fa:16:3e:7b:af:d6 [ether] PERM on qg-e6cd9397-b8</span><br><span class="line">? (192.168.4.100) at fa:16:3e:5d:2f:5b [ether] on qr-e4d7b70a-14</span><br><span class="line">? (172.21.8.87) at fa:16:3e:a1:c2:e4 [ether] on qg-e6cd9397-b8</span><br><span class="line">$ ping 193.169.205.99 -c 1</span><br><span class="line">...</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 ip route del 193.169.205.0/24 dev qg-e6cd9397-b8 scope link</span><br><span class="line">$ ping 193.169.205.99 -c 1</span><br><span class="line">PING 193.169.205.99 (193.169.205.99): 56 data bytes</span><br><span class="line">64 bytes from 193.169.205.99: seq=0 ttl=62 time=11.998 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 arp -a</span><br><span class="line">? (172.21.8.1) at fa:16:3e:0f:87:da [ether] on qg-e6cd9397-b8</span><br><span class="line">? (192.168.4.100) at fa:16:3e:5d:2f:5b [ether] on qr-e4d7b70a-14</span><br><span class="line">? (172.21.8.87) at fa:16:3e:a1:c2:e4 [ether] on qg-e6cd9397-b8</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-09ac17b3-c1ec-4d47-b70a-9f6e3ae98004 ip route</span><br><span class="line">default via 172.21.8.1 dev qg-e6cd9397-b8</span><br><span class="line">172.21.8.0/24 dev qg-e6cd9397-b8 proto kernel scope link src 172.21.8.92</span><br><span class="line">192.168.4.0/24 dev qr-e4d7b70a-14 proto kernel scope link src 192.168.4.1</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-8320db06-5a9d-46fb-8af6-5c7b974ff7a9 arp -a</span><br><span class="line">? (172.21.8.92) at fa:16:3e:d5:36:a6 [ether] on qr-0912ab72-90</span><br><span class="line">? (193.169.205.87) at fa:16:3e:09:83:10 [ether] on qr-6fa183e9-a6</span><br><span class="line">? (172.21.8.86) at fa:16:3e:89:ce:85 [ether] on qr-0912ab72-90</span><br><span class="line">? (193.169.205.99) at fa:16:3e:7b:af:d6 [ether] on qr-6fa183e9-a6</span><br><span class="line">? (172.21.8.95) at fa:16:3e:d5:36:a6 [ether] on qr-0912ab72-90</span><br><span class="line">? (172.21.8.87) at fa:16:3e:a1:c2:e4 [ether] on qr-0912ab72-90</span><br><span class="line">root@juju-a7ddde-stein-5:~# ip netns exec qrouter-8320db06-5a9d-46fb-8af6-5c7b974ff7a9 ip route</span><br><span class="line">172.21.8.0/24 dev qr-0912ab72-90 proto kernel scope link src 172.21.8.1</span><br><span class="line">193.169.205.0/24 dev qr-6fa183e9-a6 proto kernel scope link src 193.169.205.1</span><br></pre></td></tr></table></figure></p>
<h2 id="20201112更新"><a href="#20201112更新" class="headerlink" title="20201112更新"></a>20201112更新</h2><p>ssh这次失去连接，是因为台式机上的虚机使用mavtap时不小心将bridge改成了passthough导致虚机启动时失去网络.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/12/SSH连接总是定期断掉的解决办法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/12/SSH连接总是定期断掉的解决办法/" itemprop="url">SSH连接总是定期断掉的解决办法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-12T10:04:27+08:00">
                2020-11-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-05-17<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</p>
<p>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>SSH连接总是隔一段时间没有输入时就断开，解决办法如下：</p>
<p>服务端配置<br>sudo vi /etc/ssh/sshd_config<br>ClientAliveInterval 60     #服务端主动向客户端请求响应的间隔<br>ClientAliveCountMax 10    #服务器发出请求后客户端没有响应的次数达到一定值就自动断开<br>sudo restart ssh</p>
<p>客户端配置<br>sudo vi /etc/ssh/ssh_config  #或~/.ssh/config</p>
<pre><code>TCPKeepAlive yes
ServerAliveInterval 15
ServerAliveCountMax 6
StrictHostKeyChecking no
ForwardAgent yes
Compression yes

 IPQoS throughput
</code></pre><p>或</p>
<p>ssh -i <key-file> IPQoS=throughput -o StrictHostKeyChecking=no -o TCPKeepAlive=yes -o ServerAliveInterval=30 ubuntu@<ip></ip></key-file></p>
<p>上面方式任选一种，我选客户端配置方式。</p>
<p>20200316更新, 如果ssh总是断时也得考虑使用白名单模式时是否将某些IP排除了.</p>
<p>20200902更新, 如果使用Compression yes会被墙看上, 会时不时ssh断掉, 去掉Compression即可.</p>
<p>20201016更新, 到国外的ssh连接总断, 除了ISP QoS外, 还试试在sshd.conf中添加:</p>
<p>UseDNS no</p>
<p>GSSAPIAuthentication no</p>
<p>20201028更新，</p>
<p>这次应该是找到了ssh总断的根源，因为bastion上安装了devstack所以在并行运行’opestack image set”时ssh会中断．所以习惯很重要，不能乱安装东西．</p>
<p>#openstack image set –property $p=${props[$p]} $img_name</p>
<p>openstack image set –property $p=${props[$p]} $img_name &amp;</p>
<p>另外，使用压缩传输数据：</p>
<p>#strings /usr/sbin/sshd |egrep “chacha|aes”<br>scp -p -C -o ‘IPQoS throughput’  -c chacha20-poly1305@openssh.com win10.img hua@node1:/images/</p>
<p>20201112更新</p>
<p>ssh总断的原因是因为机器上为反复重启virtualbox导致chrome会通过fast.com测速变得只有十几K, virutalbox改成了kvm现在观察了几天似乎这个问题消失了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/09/在KVM中运行win10虚机/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/09/在KVM中运行win10虚机/" itemprop="url">在KVM中运行win10虚机</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-09T09:55:35+08:00">
                2020-11-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2015-12-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )<br>KVM默认不支持windows 10，需要做一些设置：<br>1, sudo usermod -a -G vboxusers hua<br>2, 修改下列配置使KVM支持windows 10所需的PAE、NX、SSE2特性。PAE支持32位处理器可以访问4GB以上物理内存功能版本的Windows，并且它是NX的先决条件。NX可让处理器帮助保护电脑免受恶意软件的攻击。SSE2（一项使用已久的关于处理器的标准）是一套由越来越多的第三方应用和驱动程序使用的指令集。<br>   cpu model: core2duo<br>   cpu features: nx=require<br>   nic: rtl8139 to e1000</p>
<p>在ubuntu上制作win 10 usb启动盘的工具：</p>
<p>sudo add-apt-repository ppa:gezakovacs/ppa<br>sudo apt-get update<br>sudo apt-get install unetbootin</p>
<p>后续的工作是采用SR-IOV与USB直通，待续。</p>
<p>20200603更新　－　virtualbox中安装win10</p>
<p>立刻仅支持windows所以需要一个windows虚机，ubuntu 20.04上的kvm安装win10报错一时半会解不了，换成virtualbox</p>
<p>安装　－　<a href="https://www.oracle.com/virtualization/technologies/vm/downloads/virtualbox-downloads.html#extpack" target="_blank" rel="external">https://www.oracle.com/virtualization/technologies/vm/downloads/virtualbox-downloads.html#extpack</a></p>
<p>在虚机中若想使用host上的摄像头，还得安装上面链接中的ExtPack, 这样在启动虚机之后在devices -&gt; webcams菜单就能使用host的摄像头了．</p>
<p>在虚机中若想使用host上的麦克风和音箱怎么办？　在’devices -&gt; audio”菜单中将’audio output’与’audio input’都选上即可．</p>
<p>鼠标在虚机与host机上无缝切换，　在’devices -&gt; insert guest cd’然后在虚机里打开cd安装驱动即可．</p>
<p>全屏切换　host + F,  host是指right ctrl键，进入全屏退出全屏都是它．</p>
<p>20201109更新 - kvm安装win10<br>之前virtualbox安装的win10在开关多次之后，会造成这样一个问题，在chrome上使用fast.com测速时会降到几十K到12M之间，</p>
<p>而同时在firefox上测速能达到69M左右，在重启机器之后chrome上的测速又能恢复到92M。</p>
<p>所以不敢再继续使用virtualbox了，改用KVM吧。</p>
<p>1, 直接将之前的virtualbox镜像转成kvm的 -　qemu-img convert -p -f vdi -O raw win10.vdi win10.img</p>
<p>2, 导入镜像创建虚机时注意一点，在”Choose the operating system you are installing”处输入win搜索windows时没有win10的版本，需勾选”Include end of life operating systems“才出来。</p>
<p>3, 第一次默认安装对硬盘和网卡均使用默认驱动。</p>
<ol>
<li>安装完启动win10后在里面下载安装virtualbox驱动 - <a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso" target="_blank" rel="external">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso</a></li>
</ol>
<p>5, 此时只能将网卡驱动改为virtio(也可以改成mapvtap + virtio)重启机器可以进win10</p>
<p>6, 但此时若将硬盘也改为virtio驱动会报错的。因为硬盘里还根本没有iscsi-virtio驱动啊。解决办法是在硬盘默认驱动进入win10后，</p>
<p>   再添加第二块virtio驱动这样iscsi-virtio就装在硬盘了。这时再重启就可以了。见：　<a href="https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio" target="_blank" rel="external">https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio</a></p>
<p>7, 使用spice这样声音和麦克就都用了。注：如果不将网络与硬盘改为virtio驱动，在likeshuo使用音频会有延时听不清楚。</p>
<p>8, 可使用spice redirect usb特性将集成视频卡加到虚机，注意：选错usb可能造成蓝牙键盘失去连接。</p>
<p>９，”rsync -avztur –progress /bak/* /mnt/share/“, /mnt/share是一块iscis盘，bak缺空间，第１步转换后的win10硬盘在iscsi盘上，但之前加了–delete参数导制被删除转了两遍。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/08/使用iSCSI挂载QNAP存储/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/08/使用iSCSI挂载QNAP存储/" itemprop="url">使用iSCSI挂载QNAP存储</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-08T15:16:38+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2015-12-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>QNAP服务端<br>系统设置 -&gt; 存储空间总管 -&gt; iSCSI选项卡<br>入口管理: 启动iSCSI目标服务<br>iSCSI目标管理：创建一个iSCSI目标并挂载一个iSCSI LUN<br>  iqn.2004-04.com.qnap:ts-212p:iscsi.quqiSCSI.d5ad13<br>  目标名称：quqiSCSI<br>  目标别名：quqiSCSI<br>  启用CHAP认证：username/password<br>  动态配置：quqiSCSI, 800G</p>
<p>在qnap中文件将存储于：/share/HDA_DATA/.@iscsi.img/iSCSI-quqiSCSI-56809a35.000</p>
<p>OpenWRT服务端<br>opkg install tgt<br>dd if=/dev/zero of=/mnt/sda1/images/sdb_for_t440p.raw bs=1M count=80000</p>
<p>vi /etc/config/tgt<br>config target 1<br>       option name ‘iqn.2018-05.com.quqi99:sdb_for_t440p’<br>       option allow 192.168.99.0/24<br>config lun 1_1</p>
<h1 id="option-readonly-0"><a href="#option-readonly-0" class="headerlink" title="option readonly 0"></a>option readonly 0</h1><pre><code>option device /mnt/sda1/images/sdb_for_t440p.raw
</code></pre><p>/etc/init.d/tgt enable<br>/etc/init.d/tgt restart<br>20201105更新 - 但现在报这个错误：　tgt: Failed to create target，　运行’tgtd  -f -d -D’显示Segmentation fault</p>
<p>iSCSI Initiator客户端<br>hua@node1:~$ sudo /etc/init.d/open-iscsi start</p>
<p>hua@node1:~$ sudo update-rc.d -f open-iscsi remove<br> Removing any system startup links for /etc/init.d/open-iscsi …<br>   /etc/rc0.d/K81open-iscsi<br>   /etc/rc0.d/S45open-iscsi<br>   /etc/rc1.d/K81open-iscsi<br>   /etc/rc6.d/K81open-iscsi<br>hua@node1:~$ sudo update-rc.d open-iscsi start 20 2 3 4 5 . stop 20 0 1 6 .<br>update-rc.d: warning:  start runlevel arguments (2 3 4 5) do not match open-iscsi Default-Start values (S)<br> Adding system startup for /etc/init.d/open-iscsi …<br>   /etc/rc0.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc1.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc6.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc2.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc3.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc4.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc5.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>hua@node1:~$ sudo update-rc.d open-iscsi enable<br>update-rc.d: warning:  start runlevel arguments (none) do not match open-iscsi Default-Start values (S)<br>update-rc.d: warning:  stop runlevel arguments (none) do not match open-iscsi Default-Stop values (0 1 6)<br> Enabling system startup links for /etc/init.d/open-iscsi …<br> Removing any system startup links for /etc/init.d/open-iscsi …<br>   /etc/rc0.d/K20open-iscsi<br>   /etc/rc1.d/K20open-iscsi<br>   /etc/rc2.d/S20open-iscsi<br>   /etc/rc3.d/S20open-iscsi<br>   /etc/rc4.d/S20open-iscsi<br>   /etc/rc5.d/S20open-iscsi<br>   /etc/rc6.d/K20open-iscsi<br> Adding system startup for /etc/init.d/open-iscsi …<br>   /etc/rc0.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc1.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc6.d/K20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc2.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc3.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc4.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>   /etc/rc5.d/S20open-iscsi -&gt; ../init.d/open-iscsi<br>hua@node1:~$ sudo sysv-rc-conf –list open-iscsi<br>open-iscsi   0:off    1:off    2:on    3:on    4:on    5:on    6:off</p>
<p>vi /etc/iscsi/iscsid.conf<br>node.startup = automatic<br>node.session.auth.authmethod = CHAP<br>node.session.auth.username = username<br>node.session.auth.password = password</p>
<p>hua@node1:~$ sudo iscsiadm -m discovery -t st -p 192.168.99.122<br>192.168.99.122:3260,1 iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13<br>10.8.0.1:3260,1 iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13</p>
<p>hua@node1:~$ sudo cat /etc/iscsi/initiatorname.iscsi<br>InitiatorName=iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13</p>
<p>hua@node1:~$ sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13 -p 192.168.99.122 –op new<br>New iSCSI node [tcp:[hw=,ip=,net_if=,iscsi_if=default] 192.168.99.122,3260,-1 iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13] added</p>
<p>hua@node1:~$ sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13 -p 192.168.99.122 –login<br>Logging in to [iface: default, target: iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13, portal: 192.168.99.122,3260] (multiple)<br>Login to [iface: default, target: iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13, portal: 192.168.99.122,3260] successful.<br>hua@node1:~$ sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13 -p 192.168.99.122 –op update -n node.startup -v automatic</p>
<p>hua@node1:~$ ls -l /dev/disk/by-path/ip-192.168.99.122\:3260-iscsi-iqn.2004-04.com.qnap\:ts-212p\:iscsi.quqiscsi.d5ad13-lun-0<br>lrwxrwxrwx 1 root root 9 Dec 28 10:22 /dev/disk/by-path/ip-192.168.99.122:3260-iscsi-iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13-lun-0 -&gt; ../../sdb</p>
<p>hua@node1:~$ cat /sys/class/iscsi_host/host16/device/session11/iscsi_session/session11/targetname<br>iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13</p>
<p>hua@node1:~$ sudo cat /etc/udev/rules.d/55-openiscsi.rules<br>KERNEL==”sd*”, BUS==”scsi”, PROGRAM=”/etc/udev/scripts/iscsidev.sh %b”,SYMLINK+=”iscsi/%c”</p>
<p>hua@node1:~$ sudo cat /etc/udev/scripts/iscsidev.sh</p>
<p>#!/bin/sh</p>
<h1 id="FILE-etc-udev-scripts-iscsidev-sh"><a href="#FILE-etc-udev-scripts-iscsidev-sh" class="headerlink" title="FILE: /etc/udev/scripts/iscsidev.sh"></a>FILE: /etc/udev/scripts/iscsidev.sh</h1><p>BUS=${1}<br>HOST=${BUS%%:<em>}<br>[ -e /sys/class/iscsi_host ] || exit 1<br>file=”/sys/class/iscsi_host/host${HOST}/device/session</em>/iscsi_session*/targetname”<br>target_name=$(cat ${file})</p>
<h1 id="This-is-not-an-open-scsi-drive"><a href="#This-is-not-an-open-scsi-drive" class="headerlink" title="This is not an open-scsi drive"></a>This is not an open-scsi drive</h1><p>if [ -z “${target_name}” ]; then<br>  exit 1<br>fi<br>echo “${target_name##*.}”</p>
<p>hua@node1:~$ sudo fdisk -l<br>…<br>Disk /dev/sdb: 859.0 GB, 858993459200 bytes<br>255 heads, 63 sectors/track, 104433 cylinders, total 1677721600 sectors<br>Units = sectors of 1 * 512 = 512 bytes<br>Sector size (logical/physical): 512 bytes / 512 bytes<br>I/O size (minimum/optimal): 1048576 bytes / 1048576 bytes<br>Disk identifier: 0x00000000</p>
<p>Disk /dev/sdb doesn’t contain a valid partition table</p>
<p>hua@node1:~$ sudo mkfs.ext4 /dev/sdb<br>mke2fs 1.42.9 (4-Feb-2014)<br>/dev/sdb is entire device, not just one partition!<br>Proceed anyway? (y,n) y<br>Discarding device blocks: done<br>Filesystem label=<br>OS type: Linux<br>Block size=4096 (log=2)<br>Fragment size=4096 (log=2)<br>Stride=256 blocks, Stripe width=256 blocks<br>52428800 inodes, 209715200 blocks<br>10485760 blocks (5.00%) reserved for the super user<br>First data block=0<br>Maximum filesystem blocks=4294967296<br>6400 block groups<br>32768 blocks per group, 32768 fragments per group<br>8192 inodes per group<br>Superblock backups stored on blocks:<br>    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,<br>    4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968,<br>    102400000</p>
<p>Allocating group tables: done<br>Writing inode tables: done<br>Creating journal (32768 blocks): done<br>Writing superblocks and filesystem accounting information: done</p>
<p>hua@node1:~$ sudo mkdir /qnap<br>hua@node1:~$ sudo mount -t ext4 /dev/sdb /qnap<br>hua@node1:~$ df -h |grep sdb<br>/dev/sdb        788G   69M  748G   1% /qnap</p>
<p>hua@node1:~$ sudo tune2fs -l /dev/sdb |grep UUID<br>Filesystem UUID:          30aa3ef9-698b-41c2-9637-dc79be91eb79</p>
<p>hua@node1:~$ sudo cat /etc/fstab |grep sdb<br>/dev/sdb    /qnap    ext4    defaults,auto,_netdev    0    0</p>
<p>hua@hua-ThinkPad-T440p:/bak$ sudo mount -t ext4 /dev/sdb /qnap<br>mount: /dev/sdb is already mounted or /qnap busy<br>hua@hua-ThinkPad-T440p:/bak$ sudo multipath -ll<br>36001405abdafa5bd00cbd4d1ad9498d1 dm-0 QNAP,iSCSI Storage<br>size=800G features=’0’ hwhandler=’0’ wp=rw<br><code>-+- policy=&#39;round-robin 0&#39; prio=1 status=active</code>- 6:0:0:0 sdb 8:16 active ready running<br>hua@hua-ThinkPad-T440p:/bak$ sudo multipath -F<br>hua@hua-ThinkPad-T440p:/bak$ sudo multipath -ll<br>hua@hua-ThinkPad-T440p:/bak$ sudo mount -t ext4 /dev/sdb /qnap<br>自动挂载<br>可参考： <a href="https://blog.csdn.net/bing_g/article/details/51279427" target="_blank" rel="external">https://blog.csdn.net/bing_g/article/details/51279427</a></p>
<p>写了个脚本如下：</p>
<p>cat /etc/auto.iscsi</p>
<p>#!/bin/bash</p>
<p>IQN=”iqn.2018-05.com.quqi99:sdb_for_t440p”<br>IP=”192.168.99.1”<br>PORT=”3260”<br>LUN=”1”<br>OPTS=”-nocheck,ro,fstype=ext4”</p>
<p>if iscsiadm -m session | grep “$IQN”; then<br>  echo node exists<br>else<br>  iscsiadm -m node -T “$IQN” -p “$IP” –login 1&gt;&amp;2<br>fi</p>
<h1 id="Let-udev-settle-before-we-try-to-look-up-the-block-device"><a href="#Let-udev-settle-before-we-try-to-look-up-the-block-device" class="headerlink" title="Let udev settle before we try to look up the block device."></a>Let udev settle before we try to look up the block device.</h1><p>sleep 1</p>
<h1 id="Figure-out-the-block-device-using-the-udev-symlink"><a href="#Figure-out-the-block-device-using-the-udev-symlink" class="headerlink" title="Figure out the block device using the udev symlink."></a>Figure out the block device using the udev symlink.</h1><p>DEV_LINK=<code>readlink /dev/disk/by-path/ip-${IP}:${PORT}-iscsi-${IQN}-lun-${LUN}</code><br>DEV_NODE=<code>basename $DEV_LINK</code><br>DEV_FULL=”/dev/$DEV_NODE”</p>
<h1 id="Return-the-magic-to-automount"><a href="#Return-the-magic-to-automount" class="headerlink" title="Return the magic to automount"></a>Return the magic to automount</h1><p>echo “${OPTS} :${DEV_FULL}${LUN}”<br>sudo mount -t ext4 ${DEV_FULL} /bak_openwrt/</p>
<p>遇到的问题<br>1, 多出来的10.8.0.1:3260这个Portal连不上会导致开机时超时非常慢，得删除它。</p>
<p>hua@node2:~$ sudo iscsiadm -m discoverydb -P1<br>SENDTARGETS:<br>DiscoveryAddress: 192.168.99.122,3260<br>Target: iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13<br>Portal: 192.168.99.122:3260,1<br>Iface Name: default<br>Portal: 10.8.0.1:3260,1<br>Iface Name: default<br>DiscoveryAddress: aa.quqi.com,3260<br>iSNS:<br>No targets found.<br>STATIC:<br>Target: iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13<br>Portal: aa.quqi.com:3260,-1<br>Iface Name: default<br>FIRMWARE:<br>No targets found.</p>
<p>hua@node2:~$ sudo iscsiadm -m discoverydb -t st -p 10.8.0.1,3260 -o delete<br>iscsiadm: Discovery record [10.8.0.1,3260] not found.<br>hua@node2:~$ sudo iscsiadm -m discoverydb -t st -p 10.8.0.1:3260 -o delete<br>iscsiadm: Discovery record [10.8.0.1,3260] not found</p>
<p>hua@node2:~$ sudo iscsiadm -m discoverydb -P1<br>SENDTARGETS:<br>DiscoveryAddress: 192.168.99.122,3260<br>Target: iqn.2004-04.com.qnap:ts-212p:iscsi.quqiscsi.d5ad13<br>Portal: 192.168.99.122:3260,1<br>Iface Name: default<br>DiscoveryAddress: veryhua2006.myqnapcloud.com,3260<br>iSNS:<br>No targets found.<br>STATIC:<br>No targets found.<br>FIRMWARE:<br>No targets found.</p>
<p>2, 遇到这个类似的问题（<a href="http://forum.open-e.com/showthread.php?1262-Problem-synchronize-data-using-2-initiator-1-target），即多个iscsi" target="_blank" rel="external">http://forum.open-e.com/showthread.php?1262-Problem-synchronize-data-using-2-initiator-1-target），即多个iscsi</a> client连向同一个iscsi server时，在共享存储上写入新内容了，iscsi client需要先umount再mount才能更新。似乎没有自动地sync</p>
<p>20200413更新<br>遇到一个问题，ssh与nfs都可以用，但是访问portal登录时输入用户名和密码后无反应无跳转也不报错。下载固件( <a href="https://www.qnap.com.cn/zh-cn/download?model=ts-212p&amp;category=firmware" target="_blank" rel="external">https://www.qnap.com.cn/zh-cn/download?model=ts-212p&amp;category=firmware</a> ) 使用qfinder pro重刷即可。多等一会，不会损坏nfs数据。</p>
<p>20201108更新 - 群晖上使用iscsi<br>sudo apt install open-iscsi -y<br>sudo iscsiadm -m discoverydb -P1</p>
<h1 id="etc-iscsi-iscsid-conf-for-CHAP-username-password"><a href="#etc-iscsi-iscsid-conf-for-CHAP-username-password" class="headerlink" title="/etc/iscsi/iscsid.conf for CHAP username/password"></a>/etc/iscsi/iscsid.conf for CHAP username/password</h1><p>#sudo bash -c ‘cat &gt; /etc/iscsi/initiatorname.iscsi’ &lt;&lt; EOF<br>cat &lt;&lt; EOF | sudo tee /etc/iscsi/initiatorname.iscsi<br>InitiatorName=iqn.2020-11.com.quqi:catdisk.share<br>EOF</p>
<h1 id="discover-target"><a href="#discover-target" class="headerlink" title="discover target"></a>discover target</h1><p>sudo iscsiadm -m discovery -t sendtargets -p 192.168.2.108</p>
<h1 id="confirm-status-after-discovery"><a href="#confirm-status-after-discovery" class="headerlink" title="confirm status after discovery"></a>confirm status after discovery</h1><p>sudo iscsiadm -m node -o show</p>
<h1 id="login-to-the-target"><a href="#login-to-the-target" class="headerlink" title="login to the target"></a>login to the target</h1><h1 id="sudo-iscsiadm-m-node-–login"><a href="#sudo-iscsiadm-m-node-–login" class="headerlink" title="sudo iscsiadm -m node –login"></a>sudo iscsiadm -m node –login</h1><p>sudo iscsiadm -m node -T iqn.2020-11.com.quqi:catdisk.share -p 192.168.2.108 –login</p>
<h1 id="confirm-the-established-session"><a href="#confirm-the-established-session" class="headerlink" title="confirm the established session"></a>confirm the established session</h1><p>sudo iscsiadm -m session -o show<br>cat /proc/partitions  #or fdisk -l<br>sudo gdisk /dev/sdc  #n,[enter],[enter],[enter],[enter],t,8300,p,w,Y<br>sudo parted /dev/sdc print<br>sudo mkfs.ext4 /dev/sdc1<br>sudo mount /dev/sdc1 /mnt/share/<br>sudo lsblk<br>sudo blkid</p>
<h1 id="use-autofs"><a href="#use-autofs" class="headerlink" title="use autofs"></a>use autofs</h1><p>cat &lt;&lt; EOF | sudo tee -a /etc/auto.master<br>/-      auto.direct<br>EOF<br>cat &lt;&lt; EOF | sudo tee -a /etc/auto.direct</p>
<p>#/cat    -fstype=nfs,rw,rsize=32768,wsize=32768,vers=3,username=admin,password=xxx     192.168.2.108:/volume1/bak</p>
<p>#/nas    -fstype=nfs4,rsize=32768,wsize=32768     192.168.2.103:/Publicj</p>
<h1 id="DEV-NAME-readlink-dev-disk-by-path-ip-192-168-2-108-3260-iscsi-iqn-2020-11-com-quqi-catdisk-share-lun-1-xargs-basename"><a href="#DEV-NAME-readlink-dev-disk-by-path-ip-192-168-2-108-3260-iscsi-iqn-2020-11-com-quqi-catdisk-share-lun-1-xargs-basename" class="headerlink" title="DEV_NAME=$(readlink /dev/disk/by-path/ip-192.168.2.108\:3260-iscsi-iqn.2020-11.com.quqi\:catdisk.share-lun-1 |xargs basename)"></a>DEV_NAME=$(readlink /dev/disk/by-path/ip-192.168.2.108\:3260-iscsi-iqn.2020-11.com.quqi\:catdisk.share-lun-1 |xargs basename)</h1><p>/mnt/share    -fstype=ext4,rw,nosuid,nodev    :/dev/sdc1<br>EOF</p>
<h1 id="or-use-fstab"><a href="#or-use-fstab" class="headerlink" title="or use fstab"></a>or use fstab</h1><p>sudo bash -c ‘cat &gt;&gt;/etc/fstab’ &lt;&lt;EOF<br>/dev/sdc1     /mnt/share   ext4  defaults,auto,_netdev  0  0<br>EOF<br>sudo mount -a</p>
<p>sudo iscsiadm -m node -T iqn.2020-11.com.quqi:catdisk.share -p 192.168.2.108 –op update -n node.startup -v automatic<br>sudo systemctl enable open-iscsi</p>
<p>20201109更新　- 使用samba<br>openwrt上的samba server<br>1, set samba share - <a href="http://192.168.99.1/cgi-bin/luci/admin/nas/samba" target="_blank" rel="external">http://192.168.99.1/cgi-bin/luci/admin/nas/samba</a><br>2, smbpasswd -a root  #root/password<br>3, cat /etc/samba/smb.conf  &amp;&amp; cat /etc/samba/smbpasswd &amp;&amp; ps |grep -E ‘smbd|nmbd’<br>4, root@OpenWrt:~# cat /etc/samba/smb.conf<br>[global]<br>    netbios name = OpenWrt<br>    display charset = UTF-8</p>
<pre><code>#interfaces = lo br-lan
server string = OpenWrt
unix charset = UTF-8
workgroup = WORKGROUP
bind interfaces only = yes
deadtime = 30
enable core files = no
local master = yes
map to guest = Bad User
max protocol = SMB2
min receivefile size = 16384
null passwords = yes
passdb backend = smbpasswd
    # run &apos;smbpasswd root&apos; to set pass for &apos;root&apos;, we also need to comment &apos;invalid users=root&apos;
    #invalid users = root
security = user
    smb passwd file = /etc/samba/smbpasswd
socket options = TCP_NODELAY IPTOS_LOWDELAY
use sendfile = yes
</code></pre><p>[share]<br>    path = /mnt/sdc2<br>    read only = no<br>    guest ok = yes<br>    create mask = 0666<br>    directory mask = 0777<br>    browseable = yes</p>
<p>5, windows client: \192.168.2.47\share, 开机自动挂载可: 计算机-&gt;映射网络驱动器<br>6, Linux client<br>smbclient -L //192.168.2.47 -U root%password<br>smbclient //192.168.2.47/share -U root%password -c “ls”<br>sudo apt install cifs-utils -y<br>dmesg  #To use the less secure SMB1 dialect to access old servers which do not support SMB3 (or SMB2.1) specify vers=1.0 on mount<br>sudo mount -t cifs -o username=root,password=password,vers=1.0 //192.168.2.47/share /mnt/smb<br>autofs: /mnt/smb    -fstype=cifs,rw,username=root,password=password,vers=1.0,file_mode=0777,dir_mode=0777 ://192.168.2.47/share</p>
<p>目前规划<br>QNAP NAS(2T)的nfs仍通过autofs作工作之用，且做为照片主备分入口<br>OpenWrt上的4T硬盘，划分出/dev/sdc1(2T)定期通过crontab用rsync从QNAP同步备份数据.<br>OpenWrt上的/dev/sdc2(1T)做SMB在win与android电视之间共享孩子要看的视频<br>OpenWRT上的tgt iscsi server不work, 其余sdc3(500G)与sdc4(226G)备用<br>CATDISK(1T)上刷了群晖，做了两块iSCSI, iqn.2020-11.com.quqi:catdisk.share(500G)给Linux用，iqn.2020-10.com.quqi:catdisk.win(200G)给win10用<br>CATDIST(100G)上还有一个windisk nfs (\192.168.2.108\volume1\windisk)<br>CATDIST也通过ssh备份一些极其重要的小数据如毕业证</p>
<p>/nas    -fstype=nfs4,rsize=32768,wsize=32768     192.168.2.103:/Public</p>
<h1 id="DEV-NAME-readlink-dev-disk-by-path-ip-192-168-2-108-3260-iscsi-iqn-2020-11-com-quqi-catdisk-share-lun-1-xargs-basename-1"><a href="#DEV-NAME-readlink-dev-disk-by-path-ip-192-168-2-108-3260-iscsi-iqn-2020-11-com-quqi-catdisk-share-lun-1-xargs-basename-1" class="headerlink" title="DEV_NAME=$(readlink /dev/disk/by-path/ip-192.168.2.108\:3260-iscsi-iqn.2020-11.com.quqi\:catdisk.share-lun-1 |xargs basename)"></a>DEV_NAME=$(readlink /dev/disk/by-path/ip-192.168.2.108\:3260-iscsi-iqn.2020-11.com.quqi\:catdisk.share-lun-1 |xargs basename)</h1><p>/mnt/nasbak    -fstype=ext4,rw,nosuid,nodev    :/dev/sdc1<br>/mnt/smbwin    -fstype=cifs,rw,username=root,password=password,vers=1.0,file_mode=0777,dir_mode=0777 ://192.168.2.47/share<br>/nfswin    -fstype=nfs,rw,rsize=32768,wsize=32768,vers=3,username=quqi99,password=xxx     192.168.2.108:/volume1/windisk</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/04/使用rsync同步数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/04/使用rsync同步数据/" itemprop="url">使用rsync同步数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T21:15:27+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2015-12-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )<br>急需使用rsync在家里的多台机器上同步相片。</p>
<p>sudo apt-get  install  rsync<br>sudo update-rc.d -f rsync remove<br>sudo update-rc.d rsync start 20 2 3 4 5 . stop 20 0 1 6 .<br>sudo update-rc.d rsync enable<br>hua@node1:~$ sudo sysv-rc-conf –list rsync<br>rsync        0:off    1:off    2:on    3:on    4:on    5:on    6:off</p>
<p>这时候就可以在一台机器上同步目录了(rsync server运行在qnap上，统一在qnap上修改，rsync client定时运行下列命令即可让客户端的文件夹与服务端同步，以服务端为准）:</p>
<p>rsync -avzur –progress –delete /bak/tmp/qnap/ /qnap/<br>rsync -avzur –progress –delete –password-file=/etc/rsync.secret  /bak/tmp/qnap/ /qnap/</p>
<p>在多台机器上同步目录：</p>
<p>rsync -rave “ssh -p 22 -l hua” -avzur –progress –delete 192.168.99.124:/qnap/ /qnap/<br>等价于：rsync -avzur –progress –delete hua@192.168.99.124:/qnap/ /qnap/</p>
<p>也可以配置使用::qnap使用下列配置文件/etc/rsyncd.conf中的[qnap]模块：</p>
<p>sudo rsync -avrzP hua@192.168.99.124::qnap qnap</p>
<p>hua@node1:~$ sudo rsync –list-only hua@192.168.99.124::<br>++++++++++++++++++++++++++++++++++++++++++++++<br>Welcome to use quqi rsync services!<br>++++++++++++++++++++++++++++++++++++++++++++++</p>
<p>qnap               This is qnap backup data</p>
<p>配置[qnap]模块的步骤如下：</p>
<p>sudo touch /etc/rsyncd.conf<br>sudo touch /etc/rsyncd.motd<br>hua@node1:~$ sudo cat /etc/rsyncd.motd<br>++++++++++++++++++++++++++++++++++++++++++++++<br>Welcome to use quqi rsync services!<br>++++++++++++++++++++++++++++++++++++++++++++++<br>sudo touch /etc/rsyncd.secrets<br>hua@node1:~$ sudo cat /etc/rsyncd.secrets<br>hua:Passw0rd<br>sudo chmod 600 /etc/rsyncd.secrets<br>sudo chown root:root /etc/rsyncd.secrets<br>hua@node1:~$ sudo cat /etc/default/rsync |grep ‘RSYNC_ENABLE’<br>RSYNC_ENABLE=true</p>
<p>sudo /etc/init.d/rsync restart<br>sudo iptables -A INPUT -p tcp -m state –state NEW  -m tcp –dport 873 -j ACCEPT<br>vi /etc/rsyncd.conf<br>pid file = /var/run/rsyncd.pid<br>port = 873<br>address = 192.168.99.124</p>
<p>#usermod -g root hua<br>uid = hua<br>gid = root<br>use chroot = yes<br>read only = yes<br>hosts allow=192.168.99.0/255.255.255.0 10.0.1.0/255.255.255.0<br>hosts deny=*<br>max connections = 5<br>motd file = /etc/rsyncd.motd<br>log file = /var/log/rsync.log</p>
<p>#transfer logging = yes<br>log format = %t %a %m %f %b<br>syslog facility = local3<br>timeout = 300</p>
<p>[qnap]<br>path = /qnap<br>list=yes             # 可以使用rsync –list-only hua@192.168.99.124::命令列出目录<br>ignore errors<br>auth users = hua,root<br>secrets file = /etc/rsyncd.secrets<br>comment = This is qnap backup data<br>exclude = tmp/  test/</p>
<p>最后，我实际上是这样处理的，我有一个qnap，一个台式机，一个笔记本，对于一些相片啥的想多存储几份别一个机器哪天坏了丢了。</p>
<p>1, 由于iscsi上一个bug，一个client对qnap上的iscsi server写了之后，没法实时更新在另一个client上（必须先umount再mount一下才行）， 并且qnap的iscsi采用一个大的虚拟文件存储的，这都不是我想要的。所以最后只使用了qnap上的nfs将相片存储了一份。</p>
<p>2, 台式机因为IP固定开机自动mount (sudo mount -t nfs -o vers=3 192.168.99.122:/Public /bak/qnap), 另外直接复制了一份到/bak/qnap_local目录防止rsync操作失误毁坏数据。</p>
<p>3, 笔记本因为经常外出IP不固定，外出时使用/bak/qnap_local目录的内容，在家需要同步时手工同步：</p>
<p>   sudo mount -t nfs -o vers=3 192.168.99.122:/Public /bak/qnap<br>   cd ~ &amp;&amp; rsync -avzurP –exclude ‘doc’ –exclude ‘photo’ –exclude ‘media’  –progress –delete /bak/qnap/ /bak/qnap_local</p>
<p>4, 平时在家办公统一从台式机上写/bak/qnap目录将数据直接写到qnap上。手机等移动设备通过qnap ftp访问数据。</p>
<p>20171031更新：</p>
<p>最后的方案是：</p>
<p>1， 使用autos先将nas上的nfs共享目录共享到台式机（注： nfs共离目录无法使用inotify)：</p>
<p>hua@node1:~$ grep -r ‘auto.direct’ /etc/auto.master<br>/-      auto.direct        –timeout 60<br>hua@node1:~$ cat /etc/auto.direct<br>/nas    -fstype=nfs4,rsize=32768,wsize=32768     192.168.99.122:/Public</p>
<p>2, 然后直接手动运行下列两个命令：</p>
<p>rsync -avztur –progress –delete  /nas/doc/  /bak/doc<br>rsync -avztur –progress –delete  /nas/photo/  /bak/photo</p>
<p>20201104更新 - nas往openwrt同步数据</p>
<p>rsync can work in two different mode, rsync over rsync (873, rsyncd) and rsync over ssh, see <a href="https://serverfault.com/questions/827633/confused-about-rsync-port-873-and-nas" target="_blank" rel="external">https://serverfault.com/questions/827633/confused-about-rsync-port-873-and-nas</a><br>we use rsync over ssh mode here.</p>
<h1 id="openwrt-192-168-2-47-192-168-99-1"><a href="#openwrt-192-168-2-47-192-168-99-1" class="headerlink" title="openwrt (192.168.2.47, 192.168.99.1)"></a>openwrt (192.168.2.47, 192.168.99.1)</h1><p>opkg install rsync</p>
<h1 id="nas-192-168-2-103-push-data-into-openwrt-192-168-2-47"><a href="#nas-192-168-2-103-push-data-into-openwrt-192-168-2-47" class="headerlink" title="nas (192.168.2.103) push data into openwrt(192.168.2.47)"></a>nas (192.168.2.103) push data into openwrt(192.168.2.47)</h1><h1 id="don’t-use-rsync"><a href="#don’t-use-rsync" class="headerlink" title="don’t use rsync"></a>don’t use rsync</h1><p>cd /share/HDA_DATA/Public/test &amp;&amp; touch test1 &amp;&amp; touch test2 &amp;&amp; touch test3<br>ssh root@192.168.2.47 “tee -a /etc/dropbear/authorized_keys” &lt; ~/.ssh/id_rsa.pub<br>rsync -avztur –progress –delete –exclude ‘test/test1’ –exclude ‘test/test2’ /share/HDA_DATA/Public/test root@192.168.2.47:/mnt/sdb1/<br>rsync -avztur –progress –delete –exclude ‘test1’ –exclude ‘test2’ /share/HDA_DATA/Public/test/ root@192.168.2.47:/mnt/sdb1/<br>rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /share/HDA_DATA/Public/ root@192.168.2.47:/mnt/sdb1/<br>contab -e<br>0 1 <em> </em> * /usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /share/HDA_DATA/Public/ root@192.168.2.47:/mnt/sdb1/</p>
<p>或者在openwrt端做:</p>
<p>mkdir ~/.ssh<br>dropbearkey -t rsa -f ~/.ssh/id_rsa<br>dropbearkey -y -f ~/.ssh/id_rsa |sed -n 2p &gt; ~/.ssh/id_rsa.pub</p>
<h1 id="https-community-onion-io-topic-2538-resolved-ssh-from-omega-to-linux-server-without-password-9"><a href="#https-community-onion-io-topic-2538-resolved-ssh-from-omega-to-linux-server-without-password-9" class="headerlink" title="https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9"></a><a href="https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9" target="_blank" rel="external">https://community.onion.io/topic/2538/resolved-ssh-from-omega-to-linux-server-without-password/9</a></h1><p>ln -s ~/.ssh/id_rsa ~/.ssh/id_dropbear<br>chmod 700 ~/.ssh<br>touch ~/.ssh/authorized_keys &amp;&amp; chmod 644 ~/.ssh/authorized_keys<br>ssh admin@192.168.2.103 “tee -a /root/.ssh/authorized_keys” &lt; ~/.ssh/id_rsa.pub<br>/usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ admin@192.168.2.103:/share/HDA_DATA/Public/ /mnt/sdb1/</p>
<p>但这无论从nas还是从openwrt运行rsync都由于nas太慢大概只有4M左右，可能提升速度最好的办法是先将nas通过nfs映射到openwrt然后再拷．这样速度能达到30M</p>
<p>opkg install nfs-utils<br>showmount -e 192.168.2.103<br>/usr/bin/mount -t nfs 192.168.2.103:Public /mnt/nas -o proto=tcp -o nolock -o vers=4<br>/usr/bin/rsync -avztur –progress –delete –exclude ‘windisk’ –exclude ‘media’ /mnt/nas/ /mnt/sdc1/<br>但是我担心将mount放到fstab时当nas有问题时也影响openwrt的启动，所以我将上面命令放在rc.local中.<br>root@OpenWrt:~# cat /etc/init.d/done</p>
<p>#!/bin/sh /etc/rc.common</p>
<h1 id="Copyright-C-2006-OpenWrt-org"><a href="#Copyright-C-2006-OpenWrt-org" class="headerlink" title="Copyright (C) 2006 OpenWrt.org"></a>Copyright (C) 2006 OpenWrt.org</h1><p>START=95<br>boot() {<br>    mount_root done<br>    rm -f /sysupgrade.tgz &amp;&amp; sync</p>
<pre><code># process user commands
[ -f /etc/rc.local ] &amp;&amp; {
    sh /etc/rc.local
}

# set leds to normal state
. /etc/diag.sh
set_state done
</code></pre><p>}<br>并且crontab也在openwrt这边做．这样速度达到了30M</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/04/Install-OpenStack-on-MAAS-Nodes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/04/Install-OpenStack-on-MAAS-Nodes/" itemprop="url">Install OpenStack on MAAS Nodes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T16:23:01+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>作者：张华 发表于：2016-11-09<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</em></p>
<p>1, Prepare MAAS Nodes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y maas-cli</span><br><span class="line">echo &apos;&lt;key-in-&lt;MAASIP&gt;/MAAS/r/account/prefs/api-keys&gt;&apos; &gt; ~/maas-apikey</span><br><span class="line">maas login admin http://10.230.56.2/MAAS `cat ~/maas-apikey`</span><br><span class="line">maas admin tags read</span><br><span class="line"></span><br><span class="line"># https://juju.is/docs/maas-cloud</span><br><span class="line">sudo bash -c &apos;cat &gt; /tmp/mymmas.yaml&apos; &lt;&lt; EOF</span><br><span class="line">clouds:</span><br><span class="line">   mymmas:</span><br><span class="line">      type: maas</span><br><span class="line">      auth-types: [oauth1]</span><br><span class="line">      endpoint: http://&lt;MAASIP&gt;/MAAS</span><br><span class="line">EOF</span><br><span class="line">juju remove-cloud --local mymmas</span><br><span class="line">juju add-cloud --local mymmas /tmp/mymmas.yaml</span><br><span class="line">juju list-clouds</span><br><span class="line">juju show-cloud mymmas --local</span><br><span class="line">sudo bash -c &apos;cat &gt; /tmp/credential.yaml&apos; &lt;&lt; EOF</span><br><span class="line">credentials:</span><br><span class="line">  mymmas:</span><br><span class="line">    zhhuabj:</span><br><span class="line">      auth-type: oauth1</span><br><span class="line">      maas-oauth: &lt;key-in-&lt;MAASIP&gt;/MAAS/r/account/prefs/api-keys&gt;</span><br><span class="line">EOF</span><br><span class="line">juju remove-credential --local mymmas zhhuabj</span><br><span class="line">juju add-credential --local mymmas -f /tmp/credential.yaml</span><br><span class="line">juju credentials --local</span><br><span class="line">juju show-credential --local mymmas zhhuabj</span><br><span class="line">cat ~/.local/share/juju/credentials.yaml</span><br><span class="line"></span><br><span class="line">juju bootstrap --debug segmaas --no-gui --config image-stream=daily --config default-series=focal --constraints=&quot;tags=virtual&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">juju export-bundle --filename /tmp/sriov.yaml   #seg-bundles</span><br><span class="line">series: bionic</span><br><span class="line">applications:</span><br><span class="line">  glance:</span><br><span class="line">    charm: cs:~openstack-charmers-next/glance-423</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  keystone:</span><br><span class="line">    charm: cs:~openstack-charmers-next/keystone-508</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      admin-password: openstack</span><br><span class="line">      debug: true</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  mysql:</span><br><span class="line">    charm: cs:~openstack-charmers-next/percona-cluster-376</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      innodb-buffer-pool-size: 512M</span><br><span class="line">      max-connections: 1000</span><br><span class="line">      root-password: admin</span><br><span class="line">      sst-password: admin</span><br><span class="line">  neutron-api:</span><br><span class="line">    charm: local:bionic/neutron-api-0</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      enable-sriov: true</span><br><span class="line">      flat-network-providers: physnet1</span><br><span class="line">      neutron-security-groups: true</span><br><span class="line">      supported-pci-vendor-devs: 14e4:16af 8086:1515 8086:1528</span><br><span class="line">      verbose: true</span><br><span class="line">      vlan-ranges: &quot;&quot;</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  neutron-openvswitch:</span><br><span class="line">    charm: local:bionic/neutron-openvswitch-0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      enable-local-dhcp-and-metadata: true</span><br><span class="line">      enable-sriov: true</span><br><span class="line">      sriov-device-mappings: physnet1:eno50</span><br><span class="line">      verbose: true</span><br><span class="line">      vlan-ranges: &quot;&quot;</span><br><span class="line">  nova-cloud-controller:</span><br><span class="line">    charm: local:bionic/nova-cloud-controller-501</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      network-manager: Neutron</span><br><span class="line">      verbose: true</span><br><span class="line">      worker-multiplier: 0.25</span><br><span class="line">  nova-compute:</span><br><span class="line">    charm: local:bionic/nova-compute-133</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - &quot;1&quot;</span><br><span class="line">    options:</span><br><span class="line">      debug: true</span><br><span class="line">      pci-passthrough-whitelist: &apos;[&#123;&quot;devname&quot;:&quot;eno50&quot;, &quot;physical_network&quot;:&quot;physnet1&quot;&#125;]&apos;</span><br><span class="line">      verbose: true</span><br><span class="line">  ntp:</span><br><span class="line">    charm: cs:ntp-41</span><br><span class="line">  rabbitmq-server:</span><br><span class="line">    charm: cs:~openstack-charmers-next/rabbitmq-server-379</span><br><span class="line">    num_units: 1</span><br><span class="line">    to:</span><br><span class="line">    - lxd:0</span><br><span class="line">machines:</span><br><span class="line">  &quot;0&quot;:</span><br><span class="line">    constraints: tags=buneary</span><br><span class="line">  &quot;1&quot;:</span><br><span class="line">    constraints: tags=duduo</span><br><span class="line">  &quot;2&quot;:</span><br><span class="line">    constraints: tags=virtual</span><br><span class="line">    series: bionic</span><br><span class="line">relations:</span><br><span class="line">- - keystone:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - nova-cloud-controller:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - glance:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - neutron-api:identity-service</span><br><span class="line">  - keystone:identity-service</span><br><span class="line">- - neutron-openvswitch:neutron-plugin-api</span><br><span class="line">  - neutron-api:neutron-plugin-api</span><br><span class="line">- - neutron-api:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - neutron-api:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - glance:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - glance:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-cloud-controller:image-service</span><br><span class="line">  - glance:image-service</span><br><span class="line">- - nova-cloud-controller:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - neutron-openvswitch:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-cloud-controller:shared-db</span><br><span class="line">  - mysql:shared-db</span><br><span class="line">- - nova-cloud-controller:neutron-api</span><br><span class="line">  - neutron-api:neutron-api</span><br><span class="line">- - nova-compute:amqp</span><br><span class="line">  - rabbitmq-server:amqp</span><br><span class="line">- - nova-compute:image-service</span><br><span class="line">  - glance:image-service</span><br><span class="line">- - nova-cloud-controller:cloud-compute</span><br><span class="line">  - nova-compute:cloud-compute</span><br><span class="line">- - nova-compute:neutron-plugin</span><br><span class="line">  - neutron-openvswitch:neutron-plugin</span><br><span class="line">- - ntp:juju-info</span><br><span class="line">  - nova-compute:juju-info</span><br></pre></td></tr></table></figure>
<p>2, Upload the image</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://api.jujucharms.com/charmstore/v5/openstack-base/archive</span><br><span class="line">source novarc</span><br><span class="line">wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1511.qcow2</span><br><span class="line">glance image-create --name centos --disk-format qcow2 --container-format bare --file ./CentOS-7-x86_64-GenericCloud-1511.qcow2 --progress</span><br></pre></td></tr></table></figure>
<p>3, Create the network<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: can use seg-bundles instead</span><br><span class="line">neutron net-create private --provider:network_type gre --provider:segmentation_id 1012</span><br><span class="line">neutron subnet-create --allocation-pool start=192.168.21.22,end=192.168.21.122 --gateway 192.168.21.1 private 192.168.21.0/24 --enable_dhcp=True --name private_subnet</span><br><span class="line"></span><br><span class="line">neutron net-create ext_net -- --router:external=True --provider:network_type flat --provider:physical_network physnet1</span><br><span class="line">neutron subnet-create --allocation-pool start=10.230.56.100,end=10.230.56.104 --gateway 10.230.56.1 ext_net 10.230.56.100/21 --enable_dhcp=False --name ext_net_subnet</span><br><span class="line"></span><br><span class="line">neutron router-create provider-router</span><br><span class="line">EXT_NET_ID=$(neutron net-list |grep &apos; ext_net &apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">ROUTER_ID=$(neutron router-list |grep &apos; provider-router &apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">SUBNET_ID=$(neutron subnet-list |grep &apos;192.168.21.0/24&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">neutron router-interface-add $ROUTER_ID $SUBNET_ID</span><br><span class="line">neutron router-gateway-set $ROUTER_ID $EXT_NET_ID</span><br><span class="line">#neutron router-gateway-clear provider-router</span><br><span class="line">#neutron router-interface-delete provider-router private_subnet</span><br><span class="line">#nova floating-ip-delete 10.230.56.101</span><br><span class="line">#neutron subnet-delete ext_net_subnet</span><br><span class="line">#neutron subnet-delete private_subnet</span><br><span class="line">#neutron net-delete ext_net</span><br><span class="line">#neutron net-delete private</span><br><span class="line">#neutron router-delete provider-router</span><br></pre></td></tr></table></figure></p>
<p>4, Boot the VM<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">neutron security-group-rule-create --protocol icmp --direction ingress default</span><br><span class="line">neutron security-group-rule-create --protocol tcp --port-range-min 22 --port-range-max 22 --direction ingress default</span><br><span class="line">nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">nova service-list</span><br><span class="line">nova hypervisor-list</span><br><span class="line">nova boot --poll --key-name mykey --image centos --flavor 2 --nic net-id=$(neutron net-list |grep &apos;private&apos; |awk &apos;&#123;print $2&#125;&apos;) --availability-zone nova:node2 i2</span><br><span class="line">nova floating-ip-create</span><br><span class="line">nova floating-ip-associate i2 10.230.56.104</span><br><span class="line">ssh -i mykey centos@10.230.56.104 -v #dd if=/dev/urandom of=/var/tmp/live_mig_test bs=4M count=1000  #~/.local/share/juju/ssh/juju_id_rsa</span><br><span class="line">nova live-migration --block-migrate i2 voltorb</span><br><span class="line">#sudo virsh --connect qemu+ssh://node2/system list</span><br><span class="line">#LIBVIRT_DEBUG=1 virsh migrate --verbose --live --copy-storage-all instance-0000000d qemu+ssh://voltorb/system 2&gt;&amp;1 &gt; debug.log</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/30/Play-with-OVN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/30/Play-with-OVN/" itemprop="url">Play with OVN</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-30T16:06:55+08:00">
                2020-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华  发表于：2019-11-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>OVN is the replacement of Neutron, so we need to have a look at OVN.</p>
<p>Refer - <a href="https://zhhuabj.blog.csdn.net/article/details/42773417" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/42773417</a></p>
<h2 id="Basic-ovn-L2-test"><a href="#Basic-ovn-L2-test" class="headerlink" title="Basic ovn L2 test"></a>Basic ovn L2 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#controller node has ovn-central(northbound and southbound db), but compute node (local ovn-controller) doesn&apos;t have it</span><br><span class="line">sudo apt install -y openvswitch-switch ovn-common ovn-controller-vtep ovn-docker ovn-host ovn-central</span><br><span class="line"></span><br><span class="line">#In controller, enable remote access, tell OVN southbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-sbctl set-connection ptcp:6642</span><br><span class="line">#In controller, for the time being don&apos;t need to tell OVN northbound db to accept TCP connections from ovn-controllers</span><br><span class="line">sudo ovn-nbctl set-connection ptcp:6641</span><br><span class="line">$ netstat -lntp | grep  664</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp        0      0 0.0.0.0:6642            0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:6640          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:6641            0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line">#In controller, create logical switch and ports:</span><br><span class="line">sudo ovn-nbctl ls-add sw</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp1 &quot;00:00:00:00:00:01 10.0.0.1&quot;</span><br><span class="line">sudo ovn-nbctl lsp-add sw sp2</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sp2 &quot;00:00:00:00:00:02 10.0.0.2&quot;</span><br><span class="line">sudo ovn-nbctl show</span><br><span class="line"></span><br><span class="line">#In compute node, make ovn-controller connect to southbound db, and create test</span><br><span class="line">#external_ids:ovn-remote=&quot;tcp:&lt;remote-controller-ip&gt;:6642&quot; external_ids:ovn-encap-ip=&lt;my-ip-used-for-endpoint&gt;</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm1&quot;</span><br><span class="line">sudo ip link add sp1_l type veth peer name sp1_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp1_l  #sudo ovs-vsctl add-br br-int -- set Bridge br-int fail-mode=secure</span><br><span class="line">sudo ovs-vsctl set interface sp1_l external_ids:iface-id=sp1</span><br><span class="line">sudo ip link set sp1_l up</span><br><span class="line">sudo ip netns add sp1</span><br><span class="line">sudo ip link set sp1_r netns sp1</span><br><span class="line">sudo ip netns exec sp1 ip link set sp1_r up</span><br><span class="line">sudo ip netns exec sp1 ip addr add 10.0.0.1/24 dev sp1_r</span><br><span class="line">sudo ip netns exec sp1 ip link set dev sp1_r address 00:00:00:00:00:01</span><br><span class="line"></span><br><span class="line">#or run the following command on another machine instead</span><br><span class="line">sudo ovs-vsctl set open_vswitch . external_ids:ovn-remote=&quot;tcp:localhost:6642&quot; external_ids:ovn-encap-ip=localhost \</span><br><span class="line">external_ids:ovn-encap-type=&quot;geneve&quot; external_ids:system-id=&quot;vm2&quot;</span><br><span class="line">sudo ip link add sp2_l type veth peer name sp2_r</span><br><span class="line">sudo ovs-vsctl add-port br-int sp2_l</span><br><span class="line">sudo ovs-vsctl set interface sp2_l external_ids:iface-id=sp2</span><br><span class="line">sudo ip link set sp2_l up</span><br><span class="line">sudo ip netns add sp2</span><br><span class="line">sudo ip link set sp2_r netns sp2</span><br><span class="line">sudo ip netns exec sp2 ip link set sp2_r up</span><br><span class="line">sudo ip netns exec sp2 ip addr add 10.0.0.2/24 dev sp2_r</span><br><span class="line">sudo ip netns exec sp2 ip link set dev sp2_r address 00:00:00:00:00:02</span><br><span class="line"></span><br><span class="line">#test</span><br><span class="line">$ sudo ip netns exec sp1 ping 10.0.0.2 -c 1</span><br><span class="line">PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.318 ms</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch a28291a4-bea9-445f-af0f-cae65c04e9f7 (sw)</span><br><span class="line">    port sp2</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:02 10.0.0.2&quot;]</span><br><span class="line">    port sp1</span><br><span class="line">        addresses: [&quot;00:00:00:00:00:01 10.0.0.1&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-sbctl show</span><br><span class="line">Chassis vm2</span><br><span class="line">    hostname: node1</span><br><span class="line">    Encap geneve</span><br><span class="line">        ip: localhost</span><br><span class="line">        options: &#123;csum=&quot;true&quot;&#125;</span><br><span class="line">    Port_Binding sp2</span><br><span class="line">    Port_Binding sp1</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl lsp-del sp1</span><br><span class="line">sudo ovn-nbctl lsp-del sp2</span><br><span class="line">sudo ovn-nbctl ls-del sw</span><br><span class="line">sudo ip netns del sp1</span><br><span class="line">sudo ip netns del sp2</span><br><span class="line">sudo ovs-vsctl del-port br-int sp1_l</span><br><span class="line">sudo ovs-vsctl del-port br-int sp2_l</span><br></pre></td></tr></table></figure>
<h2 id="Basic-ovs-flow-test"><a href="#Basic-ovs-flow-test" class="headerlink" title="Basic ovs flow test"></a>Basic ovs flow test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -itd --name i1 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo docker run -itd --name i2 --net=none ubuntu:20.04 /bin/bash</span><br><span class="line">sudo ovs-vsctl add-br br-int</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i1 --ipaddress=192.168.1.2/24</span><br><span class="line">sudo ovs-docker add-port br-int eth0 i2 --ipaddress=192.168.1.3/24</span><br><span class="line">sudo docker exec -it i1 bash</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line">sudo ovs-vsctl list interface d15c80f8359d4_l</span><br><span class="line">#when doing test in the two machines</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.122 options:key=flow</span><br><span class="line">#sudo ovs-vsctl add-port br-int vxlan1 -- set interface vxlan1 type=vxlan options:remote_ip=192.168.99.123 options:key=flow</span><br><span class="line"></span><br><span class="line">#test 1 - delete flow</span><br><span class="line">$ sudo ovs-ofctl dump-flows br-int</span><br><span class="line"> cookie=0x0, duration=563.338s, table=0, n_packets=6, n_bytes=364, priority=0 actions=NORMAL</span><br><span class="line">sudo ovs-ofctl del-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br><span class="line"></span><br><span class="line">#test 2 - add flow</span><br><span class="line">$ sudo ovs-vsctl list interface d15c80f8359d4_l |grep ofport</span><br><span class="line">ofport              : 3</span><br><span class="line">$ sudo ovs-vsctl list interface 85023af15d0c4_l |grep ofport</span><br><span class="line">ofport              : 4</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=1,in_port=3,actions=output:4&quot;</span><br><span class="line">sudo ovs-ofctl add-flow br-int &quot;priority=2,in_port=4,actions=output:3&quot;</span><br><span class="line">sudo ovs-ofctl dump-flows br-int</span><br><span class="line">sudo docker exec -it i1 ping 192.168.1.3</span><br></pre></td></tr></table></figure>
<h2 id="ovn-L3-test"><a href="#ovn-L3-test" class="headerlink" title="ovn L3 test"></a>ovn L3 test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#create two vSwitches</span><br><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-port1 &quot;50:54:00:00:00:01 192.168.0.2&quot;</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl ls-add sw1</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 sw1-port1</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw1-port1 &quot;50:54:00:00:00:03 11.0.0.2&quot;</span><br><span class="line"></span><br><span class="line">#create a vRouter, and connect two vSwitches to it</span><br><span class="line">sudo ovn-nbctl lr-add lr0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp0 00:00:00:00:ff:01 192.168.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 lrp0-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp0-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp0-attachment 00:00:00:00:ff:01</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp0-attachment router-port=lrp0</span><br><span class="line"></span><br><span class="line">sudo ovn-nbctl lrp-add lr0 lrp1 00:00:00:00:ff:02 11.0.0.1/24</span><br><span class="line">sudo ovn-nbctl lsp-add sw1 lrp1-attachment</span><br><span class="line">sudo ovn-nbctl lsp-set-type lrp1-attachment router</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses lrp1-attachment 00:00:00:00:ff:02</span><br><span class="line">sudo ovn-nbctl lsp-set-options lrp1-attachment router-port=lrp1</span><br><span class="line"></span><br><span class="line">hua@node1:~$ sudo ovn-nbctl show</span><br><span class="line">switch 25c77c44-9be4-434b-8b38-e325d4c2b044 (sw0)</span><br><span class="line">    port lrp0-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:01&quot;]</span><br><span class="line">        router-port: lrp0</span><br><span class="line">    port sw0-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:01 192.168.0.2&quot;]</span><br><span class="line">switch 0b33e823-577b-4c76-a661-c3bd358624cc (sw1)</span><br><span class="line">    port lrp1-attachment</span><br><span class="line">        type: router</span><br><span class="line">        addresses: [&quot;00:00:00:00:ff:02&quot;]</span><br><span class="line">        router-port: lrp1</span><br><span class="line">    port sw1-port1</span><br><span class="line">        addresses: [&quot;50:54:00:00:00:03 11.0.0.2&quot;]</span><br><span class="line">router cd8095b3-287f-4e0c-af3d-a10a089f977c (lr0)</span><br><span class="line">    port lrp1</span><br><span class="line">        mac: &quot;00:00:00:00:ff:02&quot;</span><br><span class="line">        networks: [&quot;11.0.0.1/24&quot;]</span><br><span class="line">    port lrp0</span><br><span class="line">        mac: &quot;00:00:00:00:ff:01&quot;</span><br><span class="line">        networks: [&quot;192.168.0.1/24&quot;]</span><br><span class="line">hua@node1:~$ sudo ovn-trace --minimal sw0 &apos;inport == &quot;sw0-port1&quot; &amp;&amp; eth.src == 50:54:00:00:00:01 &amp;&amp; ip4.src == 192.168.0.2 &amp;&amp; eth.dst == 00:00:00:00:ff:01 &amp;&amp; ip4.dst == 11.0.0.2 &amp;&amp; ip.ttl == 64&apos;</span><br><span class="line"># ip,reg14=0x1,vlan_tci=0x0000,dl_src=50:54:00:00:00:01,dl_dst=00:00:00:00:ff:01,nw_src=192.168.0.2,nw_dst=11.0.0.2,nw_proto=0,nw_tos=0,nw_ecn=0,nw_ttl=64</span><br><span class="line">ip.ttl--;</span><br><span class="line">eth.src = 00:00:00:00:ff:02;</span><br><span class="line">eth.dst = 50:54:00:00:00:03;</span><br><span class="line">output(&quot;sw1-port1&quot;);</span><br><span class="line"></span><br><span class="line"># reset</span><br><span class="line">sudo ovn-nbctl ls-del sw0</span><br><span class="line">sudo ovn-nbctl ls-del sw1</span><br><span class="line">sudo ovn-nbctl lr-del lr0</span><br></pre></td></tr></table></figure>
<p>其他见文档　OVN Routing and ovn-trace　－　<a href="http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/" target="_blank" rel="external">http://dani.foroselectronica.es/ovn-routing-and-ovn-trace-550/</a></p>
<h2 id="ovn-dhcp"><a href="#ovn-dhcp" class="headerlink" title="ovn dhcp"></a>ovn dhcp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#create dhcp port</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 sw0-dhcpport</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">#sudo ovn-nbctl lsp-set-port-security sw0-dhcpport &quot;02:ac:10:ff:01:30 192.168.0.3&quot;</span><br><span class="line">options=&quot;$(sudo ovn-nbctl create DHCP_Options cidr=192.168.0.0/24 \</span><br><span class="line">options=&quot;\&quot;server_id\&quot;=\&quot;192.168.0.10\&quot; \&quot;server_mac\&quot;=\&quot;02:ac:10:ff:01:29\&quot; \</span><br><span class="line">\&quot;lease_time\&quot;=\&quot;3600\&quot; \&quot;router\&quot;=\&quot;192.168.0.10\&quot;&quot;)&quot;</span><br><span class="line">echo &quot;DHCP options is: &quot; $options</span><br><span class="line">sudo ovn-nbctl lsp-set-dhcpv4-options sw0-dhcpport $options</span><br><span class="line">sudo ovn-nbctl dhcp-options-list</span><br><span class="line">sudo ovn-nbctl lsp-get-dhcpv4-options sw0-dhcpport</span><br><span class="line"></span><br><span class="line">#create test vm</span><br><span class="line">sudo ip netns add nsi3</span><br><span class="line">sudo ovs-vsctl add-port br-int i3 -- set interface i3 type=internal</span><br><span class="line">sudo ip link set i3 address 02:ac:10:ff:01:30</span><br><span class="line">sudo ip link set i3 netns nsi3</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=sw0-i3</span><br><span class="line"></span><br><span class="line">#get ip address via dhcp</span><br><span class="line">sudo ip netns exec nsi3 dhclient i3</span><br><span class="line">sudo ip netns exec nsi3 ip addr show i3</span><br><span class="line">sudo ip netns exec nsi3 ip route show</span><br></pre></td></tr></table></figure>
<h2 id="OVN-vRouter"><a href="#OVN-vRouter" class="headerlink" title="OVN vRouter"></a>OVN vRouter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo ovn-nbctl ls-add sw0</span><br><span class="line">sudo ovn-nbctl lsp-add sw0 outs-wan</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses outs-wan unknown</span><br><span class="line">sudo ovn-nbctl lsp-set-type outs-wan localnet</span><br><span class="line">sudo ovn-nbctl lsp-set-options outs-wan network_name=wanNet</span><br><span class="line"></span><br><span class="line">sudo ovs-vsctl add-br br-eth</span><br><span class="line">sudo ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=wanNet:br-eth</span><br><span class="line">sudo ovs-vsctl add-port br-eth eth0</span><br><span class="line">sudo ip link set br-eth up</span><br><span class="line">sudo ip addr add 192.168.66.111/23 dev br-eth</span><br><span class="line"></span><br><span class="line">#associated VM&apos;s port to bridge</span><br><span class="line">sudo ovs-vsctl set Interface i3 external_ids:iface-id=i3</span><br></pre></td></tr></table></figure>
<h2 id="OVN-SNAT-DNAT"><a href="#OVN-SNAT-DNAT" class="headerlink" title="OVN SNAT/DNAT"></a>OVN SNAT/DNAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#fixed-ip: 10.0.1.103  FIP: 192.168.99.122</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;snat&quot; logical_ip=10.0.1.0/24 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br><span class="line">ovn-nbctl -- --id=@nat create nat type=&quot;dnat_and_snat&quot; logical_ip=10.0.1.103 external_ip=192.168.99.122 -- add logical_router gateway_route nat @nat</span><br></pre></td></tr></table></figure>
<h2 id="一个问题，如何从ovn网关ping其他机器"><a href="#一个问题，如何从ovn网关ping其他机器" class="headerlink" title="一个问题，如何从ovn网关ping其他机器"></a>一个问题，如何从ovn网关ping其他机器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">如下，以前non-ovn环境下，可以从l3-agent上的qrouter-xxx上通过GW(192.168.21.1)来ping servic vm IP (192.168.21.39), 但现在ovn情况下无namespace了，该如何来做这件事呢？</span><br><span class="line">router ca47f4c3-3379-475a-ab80-fac4062e0a3e (neutron-ab4310a3-09b9-4638-8f7c-3873bc9b4c47) (aka provider-router)</span><br><span class="line">    port lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        mac: &quot;fa:16:3e:0e:f8:f5&quot;</span><br><span class="line">        networks: [&quot;192.168.21.1/24&quot;]</span><br><span class="line">    ...</span><br><span class="line">switch a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 (neutron-0f409568-561e-4e33-89ea-2814faa44add) (aka private)</span><br><span class="line">    port 3f382ff5-7601-4bec-a687-e964adadefc2</span><br><span class="line">        addresses: [&quot;fa:16:3e:f1:fa:a5 192.168.21.237&quot;]</span><br><span class="line">    port 38d6c6f7-8a64-406d-94bb-c550eb50427d</span><br><span class="line">        type: localport</span><br><span class="line">        addresses: [&quot;fa:16:3e:8d:0b:5b 192.168.21.2&quot;]</span><br><span class="line">    port c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">        type: router</span><br><span class="line">        router-port: lrp-c6ffc24d-9213-4e31-80e2-f68107f9aad1</span><br><span class="line">    port 18ce4590-453a-4152-97b9-eafb3523047d (aka octavia-lb-6058a336-3922-468f-9f70-8e34bd14e195)</span><br><span class="line">        type: virtual</span><br><span class="line">        addresses: [&quot;fa:16:3e:ce:84:fd 192.168.21.39&quot;]</span><br><span class="line"></span><br><span class="line">这样，来做一个pingvm</span><br><span class="line">sudo ovn-nbctl lsp-add a14b3c9a-b5f8-43f2-9ac8-18e58d9f1887 pingvm</span><br><span class="line">sudo ovn-nbctl lsp-set-addresses pingvm &quot;40:44:00:00:00:01 192.168.21.122&quot;</span><br><span class="line"></span><br><span class="line">在计算节点中继续：</span><br><span class="line">sudo ovs-vsctl add-port br-int pingvm -- set Interface pingvm type=internal -- set Interface pingvm external_ids:iface-id=pingvm</span><br><span class="line">sudo ip netns add pingvm</span><br><span class="line">sudo ip link set pingvm netns pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm address 40:44:00:00:00:01</span><br><span class="line">sudo ip netns exec pingvm ip addr add 192.168.21.122/24 dev pingvm</span><br><span class="line">sudo ip netns exec pingvm ip link set pingvm up</span><br><span class="line">sudo ip netns exec pingvm ip route add default via 192.168.21.1</span><br><span class="line"></span><br><span class="line">测试, 上面实验可能ping不了，因为应该用octavia的管理IP，但这不妨碍，思路如此．</span><br><span class="line">sudo ip netns exec pingvm ping 192.168.21.39</span><br><span class="line">sudo ip netns exec pingvm ssh 192.168.21.39</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/28/ssh总断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/28/ssh总断/" itemprop="url">ssh总断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-28T19:43:30+08:00">
                2020-10-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-28<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>公司服务器今天升级了，结果遇到了一个问题，登录在该服务器上的bastion虚机在运行 一个名为configure的脚本的下列代码时总是中断．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">set_img_properties ()</span><br><span class="line">&#123;</span><br><span class="line">    img_name=$1</span><br><span class="line">    img_version=$2</span><br><span class="line">    img_file=$3</span><br><span class="line"></span><br><span class="line">    ts=`stat ~/images/$img_file| sed -rn &apos;s/Modify:\s+([[:digit:]-]+)\s+.+/\1/p&apos;| tr -d &apos;-&apos;`</span><br><span class="line">    declare -A props=( [architecture]=x86_64</span><br><span class="line">                       [os_distro]=&apos;ubuntu&apos;</span><br><span class="line">                       [os_version]=$img_version</span><br><span class="line">                       [version_name]=&quot;$ts&quot;</span><br><span class="line">                       [product_name]=&quot;com.ubuntu.cloud:server:$&#123;img_version&#125;:amd64&quot;</span><br><span class="line">    )</span><br><span class="line">    for p in $&#123;!props[@]&#125;; do</span><br><span class="line">      openstack image set --property $p=$&#123;props[$p]&#125; $img_name &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br></pre></td></tr></table></figure></p>
<p>ssh中断之后，只能重启bastion才能解决．<br>因为一直没有问题，只是今天服务器升级才遇到问题，所以没想别的，只是要求同事也测了一下，他没遇到问题．<br>接着，以为是mtu问题，将mtu从8930改为1450依旧有问题．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 ping -O -M do -s 8930 10.5.0.8</span><br><span class="line">ip netns exec qrouter-1c6f53cf-9b6d-4794-ae8e-61ad1b8e4042 nc -vz 10.5.0.8 22</span><br></pre></td></tr></table></figure></p>
<p>所以就以为是底层openstack有问题，但我没有底层openstack的管理权限，所以只好找有权限的同事帮忙，最后确定没有这方面的问题．<br>最后，就是怀疑bastion这台虚机有问题了．发现里面什么时候安装了devstack，删除devstack后，正常了．<br>但为什么之前一又没问题呢？在有devstack的情况下，代码作下列更改问题也消失．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img &amp;</span><br><span class="line">set_img_properties bionic 18.04 bionic-server-cloudimg-amd64.img</span><br></pre></td></tr></table></figure></p>
<p>devstack这些东西不要乱在机器上装啊，习惯要好．上了一大课．</p>
<p>另外，如果ssh连接慢的话，可以尝试在sshd.conf中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UseDNS no</span><br><span class="line">GSSAPIAuthentication no</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/22/如何将国外的ftp气象大数据下载回来/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/22/如何将国外的ftp气象大数据下载回来/" itemprop="url">如何将国外的ftp气象大数据下载回来</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-22T20:49:19+08:00">
                2020-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-10-22<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>由于运营商对non-http流量限速，从国外ftp下载大数据将变得异常艰难．目前采用的方法如下：</p>
<p>1, 国外虚机上安装curlftpfs将ftp站点镜像到/mnt/ftp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curlftpfs -y</span><br><span class="line">#sudo fusermount -zu /mnt/ftp</span><br><span class="line">sudo mkdir -p /mnt/ftp &amp;&amp; sudo chown -R $USER /mnt/ftp</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt;/etc/fstab&apos; &lt;&lt;EOF</span><br><span class="line">curlftpfs#@ftp.hycom.org/datasets/global/GLBa0.08_rect/data /mnt/ftp fuse defaults,rw,allow_other,uid=1000,gid=1000,_netdev 0 0</span><br><span class="line">EOF</span><br><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure></p>
<p>2, 安装nginx指向/mnt/ftp将ftp变http<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx -y</span><br><span class="line">sudo vim /etc/nginx/sites-available/default</span><br><span class="line">        #root /var/www/html;</span><br><span class="line">        root /mnt/ftp;</span><br><span class="line">        location / &#123;</span><br><span class="line">                try_files $uri $uri/ =404;</span><br><span class="line">                autoindex on;</span><br><span class="line">                autoindex_exact_size off;</span><br><span class="line">                autoindex_localtime on;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>3, 国内采用下列命令下载．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -c -m http://3.18.xx.xx</span><br><span class="line">#rsync -avztur -e &quot;ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.aws/xxx.pem&quot; --progress ubuntu@3.18.xx.xx:/mnt/ftp .</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
