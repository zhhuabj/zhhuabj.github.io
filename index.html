<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>技术并艺术着</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">
  
    <link rel="alternate" href="/atom.xml" title="技术并艺术着" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">技术并艺术着</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">张华的技术博客 - blog.csdn.net/quqi99</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-How-to-make-pure-text-presentation-ppt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/24/How-to-make-pure-text-presentation-ppt/" class="article-date">
  <time datetime="2019-12-24T10:13:57.000Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/24/How-to-make-pure-text-presentation-ppt/">How to make pure text presentation/ppt</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="vim-more"><a href="#vim-more" class="headerlink" title="vim + more"></a>vim + more</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^L                   #press i to enter edit mode, then press Ctrl+L to inut ^L</span><br><span class="line">more -p  test.txt</span><br><span class="line"></span><br><span class="line">:set textwidth=70</span><br><span class="line">#for the existing lines</span><br><span class="line">v</span><br><span class="line">gq</span><br></pre></td></tr></table></figure>
<h2 id="markdown-marp"><a href="#markdown-marp" class="headerlink" title="markdown/marp"></a>markdown/marp</h2><p><a href="https://web.marp.app/" target="_blank" rel="external">https://web.marp.app/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- page_number: true --&gt;</span><br><span class="line"></span><br><span class="line"># 一级标题</span><br><span class="line">## 二级标题</span><br><span class="line">**重点**</span><br><span class="line"></span><br><span class="line">- 列表1</span><br><span class="line">- 列表2</span><br><span class="line"></span><br><span class="line">![](图片url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">Next Page</span><br></pre></td></tr></table></figure>
<h2 id="查看本地md文件"><a href="#查看本地md文件" class="headerlink" title="查看本地md文件"></a>查看本地md文件</h2><p>sudo pip install markdownserver<br>cd onedir then run:  sudo markdownserver<br>then visit: <a href="http://localhost:8009/index.md" target="_blank" rel="external">http://localhost:8009/index.md</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/24/How-to-make-pure-text-presentation-ppt/" data-id="ck4jppqqu000088bp0touhs3e" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-How-to-test-Neutron-VRRP-HA-rapidly" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/" class="article-date">
  <time datetime="2019-11-09T05:03:23.000Z" itemprop="datePublished">2019-11-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/">How to test Neutron VRRP HA rapidly</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：张华  发表于：2015-12-09<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</p>
<p>(<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>neutron vrrp ha still do not support conntrack feature now.</p>
<p>1, Setting up test environment</p>
<p>juju add-model queens-vrrp<br>juju deploy ./b/openstack.yaml</p>
<p>juju add-unit neutron-gateway<br>juju ssh neutron-gateway/1 – hostname<br>source ~/novarc &amp;&amp; nova interface-attach $(openstack server list -f value |awk ‘/juju-4262ae-queens-vrrp-10/ {print $1}’) –net-id=$(openstack network list -f value |awk ‘/ zhhuabj_admin_net / {print $1}’)<br>juju ssh neutron-gateway/1 – sudo ovs-vsctl add-port br-data ens7<br>juju ssh neutron-gateway/1 – sudo ifconfig ens7 up<br>juju config neutron-api overlay-network-type=vxlan<br>juju config neutron-api enable-l3ha=true</p>
<p>./configure<br>source ~/stsstack-bundles/novarc<br>./tools/instance_launch.sh 1 xenial<br>./tools/sec_groups.sh</p>
<p>fix_ip=$(openstack server list -f value |awk ‘/xenial/ {print $4}’ |awk -F ‘=’ ‘{print $2}’)<br>public_network=$(openstack network show ext_net -f value -c id)<br>fip=$(openstack floating ip create $public_network -f value -c floating_ip_address)<br>openstack floating ip set $fip –fixed-ip-address $fix_ip –port $(openstack port list –fixed-ip ip-address=$fix_ip -c id -f value)</p>
<h1 id="update-the-existing-router-as-ha-router"><a href="#update-the-existing-router-as-ha-router" class="headerlink" title="update the existing router as ha router"></a>update the existing router as ha router</h1><p>#ROUTER_ID=$(neutron router-show provider-router -c id -f value)</p>
<p>#neutron router-update $ROUTER_ID –admin_state_up=false ; neutron router-update $ROUTER_ID –ha=true; neutron router-update $ROUTER_ID –admin_state_up=true</p>
<p>#AGENT_ID=$(neutron l3-agent-list-hosting-router $ROUTER_ID |grep active |awk -F ‘|’ ‘{print $2}’)</p>
<p>#neutron l3-agent-router-remove $AGENT_ID $ROUTER_ID</p>
<p>#neutron l3-agent-router-add $AGENT_ID $ROUTER_ID</p>
<h1 id="enable-dvr"><a href="#enable-dvr" class="headerlink" title="enable dvr"></a>enable dvr</h1><p>#juju config neutron-api l2-population=false enable-l3ha=true</p>
<p>#neutron router-update –admin-state-up False provider-router</p>
<p>#neutron router-update provider-router –distributed True –ha=True</p>
<p>#neutron router-update –admin-state-up True provider-router</p>
<h1 id="test-patch-https-review-opendev-org-c-601533"><a href="#test-patch-https-review-opendev-org-c-601533" class="headerlink" title="test patch - https://review.opendev.org/#/c/601533/"></a>test patch - <a href="https://review.opendev.org/#/c/601533/" target="_blank" rel="external">https://review.opendev.org/#/c/601533/</a></h1><p>git clone <a href="https://github.com/openstack/charm-neutron-gateway.git" target="_blank" rel="external">https://github.com/openstack/charm-neutron-gateway.git</a> neutron-gateway<br>cd neutron-gateway/<br>git fetch <a href="https://review.opendev.org/openstack/charm-neutron-gateway" target="_blank" rel="external">https://review.opendev.org/openstack/charm-neutron-gateway</a> refs/changes/33/601533/1 &amp;&amp; git format-patch -1 –stdout FETCH_HEAD &gt; lp1732154.patch<br>git checkout master<br>patch -p1 &lt; lp1732154.patch<br>juju upgrade-charm neutron-gateway –path $PWD</p>
<p>wget <a href="https://gist.githubusercontent.com/dosaboy/cf8422f16605a76affa69a8db47f0897/raw/8e045160440ecf0f9dc580c8927b2bff9e9139f6/check_router_vrrp_transitions.sh" target="_blank" rel="external">https://gist.githubusercontent.com/dosaboy/cf8422f16605a76affa69a8db47f0897/raw/8e045160440ecf0f9dc580c8927b2bff9e9139f6/check_router_vrrp_transitions.sh</a><br>chmod +x check_router_vrrp_transitions.sh<br>./check_router_vrrp_transitions.sh</p>
<p>ubuntu@juju-4262ae-queens-vrrp-5:~$ bash check_router_vrrp_transitions.sh<br>Analysing keepalived vrrp transitions…1 active vrouters found (total 1):<br>router=b8d4435b-bd83-46fd-a828-6d8a0b52d23a (current=false, vrid=VR_1, pid=16716, first=Apr-23-01:48:20, last=Apr-23-01:57:05) had 2 transition(s)<br>router=b8d4435b-bd83-46fd-a828-6d8a0b52d23a (current=true, vrid=VR_1, pid=24269, first=Apr-23-02:22:16, last=Apr-23-02:22:28) had 2 transition(s) (state=MASTER)</p>
<p>Done.</p>
<p>ubuntu@zhhuabj-bastion:~$ juju ssh neutron-gateway/0 – sudo cat /var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/ha_check_script_1.sh</p>
<p>#!/bin/bash -eu<br>ip a | grep fe80::f816:3eff:fe2d:db49 || exit 0<br>ping -c 1 -w 1 10.5.0.1 1&gt;/dev/null || exit 1</p>
<p>ubuntu@zhhuabj-bastion:~$ juju ssh neutron-gateway/0 – cat /var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/keepalived.conf<br>global_defs {<br>    notification_email_from neutron@openstack.local<br>    router_id neutron<br>}</p>
<p>vrrp_script ha_health_check_1 {<br>    script “/var/lib/neutron/ha_confs/b8d4435b-bd83-46fd-a828-6d8a0b52d23a/ha_check_script_1.sh”<br>    interval 30<br>    fall 2<br>    rise 2<br>}</p>
<p>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-c172aff0-67<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_delay 60<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-c172aff0-67<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-c172aff0-67<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aa1ed68a-d0<br>        10.5.150.2/32 dev qg-aa1ed68a-d0<br>        192.168.21.1/24 dev qr-00aa8199-1d<br>        fe80::f816:3eff:fe2d:db49/64 dev qr-00aa8199-1d scope link<br>        fe80::f816:3eff:feeb:a6de/64 dev qg-aa1ed68a-d0 scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aa1ed68a-d0<br>    }<br>    track_script {<br>        ha_health_check_1<br>    }<br>}</p>
<p>Some important configurations in neutron.conf are as below:<br>l3_ha = True<br>max_l3_agents_per_router = 2<br>min_l3_agents_per_router = 2<br>allow_automatic_l3agent_failover = False</p>
<p>2, Future Work &amp; Limitations<br><a href="http://assafmuller.com/2014/08/16/layer-3-high-availability/" target="_blank" rel="external">http://assafmuller.com/2014/08/16/layer-3-high-availability/</a><br><a href="http://blog.aaronorosen.com/implementing-high-availability-instances-with-neutron-using-vrrp/" target="_blank" rel="external">http://blog.aaronorosen.com/implementing-high-availability-instances-with-neutron-using-vrrp/</a></p>
<p>TCP connection tracking – With the current implementation, TCP sessions are broken on failover. The idea is to use conntrackd in order to replicate the session states across HA routers, so that when the failover finishes, TCP sessions will continue where they left off.<br>Where is the master instance hosted? As it is now it is impossible for the admin to know which network node is hosting the master instance of a HA router. The plan is for the agents to report this information and for the server to expose it via the API.<br>Evacuating an agent – Ideally bringing down a node for maintenance should cause all of the HA router instances on said node to relinquish their master states, speeding up the failover process.<br>Notifying L2pop of VIP movements – Consider the IP/MAC of the router on a tenant network. Only the master instance will actually have the IP configured, but the same Neutron port and same MAC will show up on all participating network nodes. This might have adverse effects on the L2pop mechanism driver, as it expects a MAC address in a single location in the network. The plan to solve this deficiency is to send an RPC message from the agent whenever it detects a VRRP state change, so that when a router becomes the master, the controller is notified, which can then update the L2pop state.<br>FW, VPN and LB as a service integration. Both DVR and L3 HA have issues integrating with the advanced services, and a more serious look will be taken during the Kilo cycle.<br>One HA network per tenant. This implies a limit of 255 HA routers per tenant, as each router takes up a VRID, and the VRRP protocol allows 255 distinct VRID values in a single broadcast domain.</p>
<p>3, Test steps and data</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ neutron net-list<br>+————————————–+—————————————————-+——————————————————-+<br>| id                                   | name                                               | subnets                                               |<br>+————————————–+—————————————————-+——————————————————-+<br>| 70773c83-08fe-4efe-b601-4f04522d867f | ext_net                                            | 6aed68fb-be4a-4a33-b53e-c2b742ac9985 10.5.0.0/16      |<br>| 98e10e32-13eb-48ee-b265-4ae0e449b6e5 | private                                            | b6afcd08-f3b6-4224-a125-3befa4b34a63 192.168.21.0/24  |<br>| bc699825-19e1-4bf6-a0cf-fe90251ad391 | HA network tenant b31bb0f325fd4ec291a5a65d3dc11a63 | 20173269-0eb4-4f3f-9557-807c69f6e258 169.254.192.0/18 |<br>+————————————–+—————————————————-+——————————————————-+</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ neutron router-list<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>| id                                   | name            | external_gateway_info                                                                                                                                                                  |<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>| dd74a4c6-8320-40d6-b3b1-232e578cb6c7 | provider-router | {“network_id”: “70773c83-08fe-4efe-b601-4f04522d867f”, “enable_snat”: true, “external_fixed_ips”: [{“subnet_id”: “6aed68fb-be4a-4a33-b53e-c2b742ac9985”, “ip_address”: “10.5.150.0”}]} |<br>+————————————–+—————–+—————————————————————————————————————————————————————————————-+<br>ubuntu@zhhuabj-bastion:~/neutron-gateway-ha$ neutron l3-agent-list-hosting-router provider-router<br>+————————————–+————————-+—————-+——-+<br>| id                                   | host                    | admin_state_up | alive |<br>+————————————–+————————-+—————-+——-+<br>| 99ca5ee5-33b6-43da-86e2-df1f16fbd7cb | juju-zhhuabj-machine-23 | True           | :-)   |<br>| c95e33d5-b080-458c-8adb-d15bafc16bfb | juju-zhhuabj-machine-12 | True           | :-)   |<br>+————————————–+————————-+—————-+——-+</p>
<p>ubuntu@zhhuabj-bastion:~/openstack-charm-testing$ nova list<br>+————————————–+——+——–+————+————-+———————————-+<br>| ID                                   | Name | Status | Task State | Power State | Networks                         |<br>+————————————–+——+——–+————+————-+———————————-+<br>| ebfe6140-580c-43dd-b582-5e708eba58d8 | i1   | ACTIVE | -          | Running     | private=192.168.21.5, 10.5.150.1 |<br>+————————————–+——+——–+————+————-+———————————-+</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>2: ha-786d2e2f-a8: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:f5:c4:16 brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.2/18 brd 169.254.255.255 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>    inet 169.254.0.1/24 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fef5:c416/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.21.1/24 scope global qr-de8b99fa-7c<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe9f:a31b/64 scope link<br>       valid_lft forever preferred_lft forever<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff<br>    inet 10.5.150.0/16 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet 10.5.150.1/32 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe13:a924/64 scope link<br>       valid_lft forever preferred_lft forever</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>2: ha-37f7144e-02: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:04:b4:ce brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.1/18 brd 169.254.255.255 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe04:b4ce/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.5.0.1        0.0.0.0         UG    0      0        0 qg-aeb51a1d-32<br>10.5.0.0        0.0.0.0         255.255.0.0     U     0      0        0 qg-aeb51a1d-32<br>169.254.0.0     0.0.0.0         255.255.255.0   U     0      0        0 ha-786d2e2f-a8<br>169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-786d2e2f-a8<br>192.168.21.0    0.0.0.0         255.255.255.0   U     0      0        0 qr-de8b99fa-7c</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-37f7144e-02</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ ps -ef|grep ha<br>root        71     2  0 06:55 ?        00:00:00 [charger_manager]<br>neutron   5597     1  0 08:14 ?        00:00:00 /usr/bin/python /usr/bin/neutron-keepalived-state-change –router_id=dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –namespace=qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –conf_dir=/var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –monitor_interface=ha-786d2e2f-a8 –monitor_cidr=169.254.0.1/24 –pid_file=/var/lib/neutron/external/pids/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.monitor.pid –state_path=/var/lib/neutron –user=108 –group=112<br>root      5649     1  0 08:14 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp<br>root     11780  5649  0 09:02 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ ps -ef |grep ha<br>root        71     2  0 07:09 ?        00:00:00 [charger_manager]<br>root      6060 32207  0 09:02 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp<br>neutron  32142     1  0 08:14 ?        00:00:00 /usr/bin/python /usr/bin/neutron-keepalived-state-change –router_id=dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –namespace=qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –conf_dir=/var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7 –monitor_interface=ha-37f7144e-02 –monitor_cidr=169.254.0.1/24 –pid_file=/var/lib/neutron/external/pids/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.monitor.pid –state_path=/var/lib/neutron –user=108 –group=112<br>root     32207     1  0 08:14 ?        00:00:00 keepalived -P -f /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf -p /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid -r /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7.pid-vrrp</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/state<br>master<br>ubuntu@juju-zhhuabj-machine-12:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf<br>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-786d2e2f-a8<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_repeat 5<br>    garp_master_refresh 10<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-786d2e2f-a8<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-786d2e2f-a8<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aeb51a1d-32<br>        10.5.150.1/32 dev qg-aeb51a1d-32<br>        192.168.21.1/24 dev qr-de8b99fa-7c<br>        fe80::f816:3eff:fe13:a924/64 dev qg-aeb51a1d-32 scope link<br>        fe80::f816:3eff:fe9f:a31b/64 dev qr-de8b99fa-7c scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aeb51a1d-32<br>    }<br>}</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/state<br>backup<br>ubuntu@juju-zhhuabj-machine-23:~$ sudo cat /var/lib/neutron/ha_confs/dd74a4c6-8320-40d6-b3b1-232e578cb6c7/keepalived.conf<br>vrrp_instance VR_1 {<br>    state BACKUP<br>    interface ha-37f7144e-02<br>    virtual_router_id 1<br>    priority 50<br>    garp_master_repeat 5<br>    garp_master_refresh 10<br>    nopreempt<br>    advert_int 2<br>    track_interface {<br>        ha-37f7144e-02<br>    }<br>    virtual_ipaddress {<br>        169.254.0.1/24 dev ha-37f7144e-02<br>    }<br>    virtual_ipaddress_excluded {<br>        10.5.150.0/16 dev qg-aeb51a1d-32<br>        10.5.150.1/32 dev qg-aeb51a1d-32<br>        192.168.21.1/24 dev qr-de8b99fa-7c<br>        fe80::f816:3eff:fe13:a924/64 dev qg-aeb51a1d-32 scope link<br>        fe80::f816:3eff:fe9f:a31b/64 dev qr-de8b99fa-7c scope link<br>    }<br>    virtual_routes {<br>        0.0.0.0/0 via 10.5.0.1 dev qg-aeb51a1d-32<br>    }<br>}</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ifconfig ha-786d2e2f-a8 down</p>
<p>ubuntu@juju-zhhuabj-machine-12:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state UNKNOWN group default<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>2: ha-786d2e2f-a8: <broadcast,multicast> mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000<br>    link/ether fa:16:3e:f5:c4:16 brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.2/18 brd 169.254.255.255 scope global ha-786d2e2f-a8<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast></loopback,up,lower_up></p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 ip addr show<br>1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state UNKNOWN group default<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host<br>       valid_lft forever preferred_lft forever<br>2: ha-37f7144e-02: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:04:b4:ce brd ff:ff:ff:ff:ff:ff<br>    inet 169.254.192.1/18 brd 169.254.255.255 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet 169.254.0.1/24 scope global ha-37f7144e-02<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe04:b4ce/64 scope link<br>       valid_lft forever preferred_lft forever<br>3: qr-de8b99fa-7c: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:9f:a3:1b brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.21.1/24 scope global qr-de8b99fa-7c<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe9f:a31b/64 scope link<br>       valid_lft forever preferred_lft forever<br>4: qg-aeb51a1d-32: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:13:a9:24 brd ff:ff:ff:ff:ff:ff<br>    inet 10.5.150.0/16 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet 10.5.150.1/32 scope global qg-aeb51a1d-32<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::f816:3eff:fe13:a924/64 scope link<br>       valid_lft forever preferred_lft forever</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></loopback,up,lower_up></p>
<p>ubuntu@zhhuabj-bastion:~/neutron-gateway-ha$ ping 10.5.150.1<br>PING 10.5.150.1 (10.5.150.1) 56(84) bytes of data.<br>64 bytes from 10.5.150.1: icmp_seq=1 ttl=63 time=5.00 ms<br>64 bytes from 10.5.150.1: icmp_seq=2 ttl=63 time=1.69 ms</p>
<p>ubuntu@juju-zhhuabj-machine-23:~$ sudo ip netns exec qrouter-dd74a4c6-8320-40d6-b3b1-232e578cb6c7 tcpdump -n -i ha-37f7144e-02<br>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<br>listening on ha-37f7144e-02, link-type EN10MB (Ethernet), capture size 65535 bytes<br>03:59:45.723931 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:47.724833 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:49.727033 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:51.726947 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:53.728466 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:55.730700 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:57.731620 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>03:59:59.733136 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:01.734053 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:03.734711 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:05.737778 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:07.737146 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:09.739794 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:11.739332 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:13.740744 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:15.742741 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:17.744151 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:19.745413 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:21.746639 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:23.748244 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:25.750017 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:27.751713 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:29.752460 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:31.753797 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:33.755248 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:35.757904 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:37.759372 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:39.760449 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:41.761482 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:43.762326 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:45.764282 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:47.763669 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:49.764741 IP 169.254.192.2 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:56.570867 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:00:58.572437 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572504 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572542 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572581 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572609 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:00:58.572665 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:00.573412 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:02.574520 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:03.573747 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573850 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573898 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573948 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:03.573993 ARP, Request who-has 169.254.0.1 (ff:ff:ff:ff:ff:ff) tell 169.254.0.1, length 28<br>04:01:04.575330 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:06.576547 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:08.577765 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:10.578863 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:12.579946 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:14.581031 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:16.582120 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:18.583161 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:20.584254 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:22.585400 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:24.586493 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:26.587590 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:28.588677 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:30.589448 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:32.590557 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:34.591728 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:36.592887 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:38.594052 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:40.595402 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:42.596719 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:44.597883 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:46.599080 IP 169.254.192.1 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 50, authtype none, intvl 2s, length 20<br>04:01:48.600390 IP 169.2</p>
<p>20160304更新</p>
<p>Keepalived有一个bug，在配置改变时会做一个不必要的dns查询操作(可使用命令ip netns exec qrouter-xxx  tcpdump -vvv -s 0 -l -n port 53查看），如果qrouter-名空间无法访问dns服务器的话会造成master节点在做dns查询时block一分钟左右，这个时间backup结点会变成master节点。见Bug:</p>
<p> <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1181592" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1181592</a> </p>
<p><a href="https://bugs.launchpad.net/neutron/+bug/1511722" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1511722</a></p>
<p>Workaround是添加hostname:</p>
<p>dig A $(hostname) | grep -A1 “ANSWER SEC” | tail -n 1 | awk ‘{print $NF “ “ $1}’ | sed -e ‘s/.$//g’  &gt;&gt;/etc/hosts ;   grep $(hostname) /etc/hosts || echo “Failure setting up the hostname entry”</p>
<p>另一些bug (ha接口已经变成active之后再加keepalived, 这样neutron-keepalived-state-change进程的’ip netns exec xxx ip -o monitor address’感知到ha-xxx口的变化后通知neutron-server将router变成master): </p>
<p>20171215更新</p>
<p>一个实际的case，遇到了multi-active或者全部是standby的问题，问题最后查出来包括：</p>
<p>1, l3-agent上的router过多时在syslog中会看到如下错误，除了按下列的步骤增大ulimit，也可能需要设置ovs_vsctl_timeout=60 (20111108更新, of_inactivity_probe也是一个参数, 见- <a href="https://review.opendev.org/#/c/660074/" target="_blank" rel="external">https://review.opendev.org/#/c/660074/</a>) (20111109更新, 另一个参数是mac-table-size, <a href="https://bugs.launchpad.net/neutron/+bug/1775797)，另外将ovs将cpu核绑定" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1775797)，另外将ovs将cpu核绑定</a><br>“hostname ovs-vswitchd: ovs|1762125|netlink_socket|ERR|fcntl: Too many open files”<br>sudo lsof -p 2279  #the file num opened by a process<br>sudo prlimit -p 2279 –nofile=131070  #If need to persistence it, pls modify /etc/security/limits.d/ovs.conf</p>
<p>cat /etc/security/limits.d/ovs.conf</p>
<p>root soft nofile 131070<br>root hard nofile 1048576 </p>
<p>2, rabbitmq cluster有性能问题，暂时改一non-cluster rabbitmq</p>
<p>3, 修改后，router的状态并不会自己同时，因为如果之前是rabbitmq的问题，neutron-keepalived-state-change通过ip monitor监控到vrrp vip变化的event丢失，rabbitmq恢复后，这个event可能不会再发一遍（<a href="https://github.com/openstack/neutron/blob/stable/ocata/neutron/agent/l3/keepalived_state_change.py#L71）所以也需要重启l3-agent" target="_blank" rel="external">https://github.com/openstack/neutron/blob/stable/ocata/neutron/agent/l3/keepalived_state_change.py#L71）所以也需要重启l3-agent</a></p>
<p>4， 下面这些fixed patches也都是必须的</p>
<p><a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a><br><a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a><br><a href="https://review.openstack.org/#/c/454657/" target="_blank" rel="external">https://review.openstack.org/#/c/454657/</a><br><a href="https://review.openstack.org/522792" target="_blank" rel="external">https://review.openstack.org/522792</a>       (ocata)</p>
<p><a href="https://review.openstack.org/#/c/522641" target="_blank" rel="external">https://review.openstack.org/#/c/522641</a></p>
<p>节点down了，其他节点升级成master， 但是old master节点的ha port在DB里可能仍然是active状态，l3-agent重启后就会仍然spawn keepalived进程从而导致同时出现两个master节点。可以在l3-agent重启时将all ha ports的状态重置成DOWN解决。<br>见：<a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a> ， 它在fetch_and_sync_all_routers(状态为AGENT_REVIVED才运行, agent周期性失去心跳时才为此状态) -&gt; get_router_ids()中将所有ha ports设置成DOWN，<br>但有时候l3-agent无法及时报告心跳信息时，其agent的状态会被设置成AGENT_REVIVED，然后触发上面的将ha ports设置成DOWN, 然后l3-agent需要反复的处理同一个router发现它是ha_ports并且是active状态就enable_keepalived，这样l3-agent与l2-agent的负担都重反过来更加加重AGENT_REVIVED状态。所以需要将设置成DOWN的状态在重启l3-agent时才做一次（<strong>init</strong> -&gt; get_service_plugin_list -&gt; _update_ha_network_port_status)，见： <a href="https://review.openstack.org/#/c/522792/" target="_blank" rel="external">https://review.openstack.org/#/c/522792/</a><br>另一个原因： 如果先重启l3-agent再重启l2-agent, 在ovs-l2-agent还没将ha port准备好变成active状态之前，l3-agent就不应该处理ha_port并生成了keepalived实例。见：<a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a><br>ha_vrrp_health_check_interval选项支持ping GW然后实现主备切换。见：<a href="https://review.openstack.org/#/c/454657" target="_blank" rel="external">https://review.openstack.org/#/c/454657</a></p>
<p>当router很多时，可能也需要增大ha_vrrp_advert_int (lp: 1749425), 也需要设置mhash_entries=16000000 mphash_entries=16000000 (lp: 1376958)</p>
<p>Neutron-vrrp itself bug</p>
<p>keepalived instances should not be handled if ha ports are NOT ready (like first restart l3-agent then restart l2-agent) - <a href="https://review.openstack.org/#/c/357458/" target="_blank" rel="external">https://review.openstack.org/#/c/357458/</a></p>
<p>Master restart so slave will switch to new master, but old master doesn’t switch to slave because it’s initial DB status is active, so initial DB status should be set into standby, this patch do so when agent’s status is  AGENT_REVIVED - <a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a></p>
<p>Lots of VRRP problem is comprehensive problem, not caused by neutron-vrrp itself:</p>
<p>Keepalived’s bug</p>
<p>Dns problem causes slave be unable to switch to master - <a href="https://bugs.launchpad.net/neutron/+bug/1511722" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1511722</a></p>
<p>Neutron’s inappropriate settings</p>
<p>Performance problem caused by the small ovs_vsctl_timeout</p>
<p>Any performance problems can lead to vrrp problem as well. For example:</p>
<p>rabbitmq’s performance problem can cause l3-agent’s heartbeat not to be sent to neutron-api, then neutron-api will think agent has been dead (AGENT_REVIVED) so it will set the initial status into standby by using above fix (<a href="https://review.openstack.org/#/c/470905/" target="_blank" rel="external">https://review.openstack.org/#/c/470905/</a>). So this patch just set initial status into standby when restarting l3-agent instead of  AGENT_REVIVED - <a href="https://review.openstack.org/#/c/522792/" target="_blank" rel="external">https://review.openstack.org/#/c/522792/</a></p>
<p>Performance problem lead to vrrp can not be sent out in a short ha_vrrp_health_check_interval - <a href="https://review.openstack.org/#/c/454657" target="_blank" rel="external">https://review.openstack.org/#/c/454657</a></p>
<p>Performance problem caused by small mhash_entries - <a href="https://bugs.launchpad.net/charms/+source/neutron-gateway/+bug/1376958" target="_blank" rel="external">https://bugs.launchpad.net/charms/+source/neutron-gateway/+bug/1376958</a></p>
<p>Performance problem caused by ulimit and Others …</p>
<p>20180815更新</p>
<p>采用上面种种方法后仍然可能出现multiple master的问题，我们来分析一下原因：</p>
<p>openstack vrrp相关的进程有两个， 一个是neutron-keepalived-state-change is spawned由ha_router#initialize()初始化， 一个是keepalived由ha_router#process()初始化。</p>
<p>并且_process_added_router会调用neutron-keepalived-state-change, _process_updated_router会调用keepalived<br>l3_agent#_process_routers_loop -&gt; _process_router_update -&gt; _process_router_if_compatible -&gt; _process_added_router -&gt; ha_router#initialize()<br>l3_agent#_process_routers_loop -&gt; _process_router_update -&gt; _process_router_if_compatible -&gt; _process_updated_router -&gt; ha_router#process()</p>
<p>这种正常情况会保证neutron-keepalived-state-change先于keepalived进程启动 ( 20190320更新, 这个问题, 可以这样解决, 在neutron-keepalived-state-change启动之后根据节点上若有keepalived设置的vip就设置初始状态为master, 否则为slave - <a href="https://github.com/openstack/neutron/commit/5bcca13f4a58ee5541ae81a45b89f783194f1279" target="_blank" rel="external">https://github.com/openstack/neutron/commit/5bcca13f4a58ee5541ae81a45b89f783194f1279</a> )(<a href="https://bugs.launchpad.net/neutron/+bug/1818614)，并且这两个进程都被process_monitor.register方法注册进了external_process.py，" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1818614)，并且这两个进程都被process_monitor.register方法注册进了external_process.py，</a> 一旦这两个进程挂掉的后它会通过external_process.py#_respawn_action保证重启，但重启是没顺序的。比如，keepalived进程刚死， neutron-keepalived-state-change进程还没来得及通过MQ更新DB之前它也挂掉的话， 这时其他节点已经变成master了， 在这台节点上的这些进程再重启的时候也由因为认为它是master（根本原因在于keepalived没有提供一个查询当时谁是master的api，这样可以在每个节点上的keepalived启动时都先调用这个api检查一下有没有master，有master的话说明状态不一致就将自己变成backup啊。如用在master上运行下列命令很容易重现问题:</p>
<p>r=909c6b55-9bc6-476f-9d28-c32d031c41d7<br>pkill -f “/usr/bin/neutron-keepalived-state-change –router_id=$r”<br>sudo pkill -f “/var/lib/neutron/ha_confs/$r/keepalived.conf”</p>
<p>但这种问题只是在DB中看到multiple masters (neutron l3-agent-list-hosting-router provider-router), 在keepalived层面是正常的(sudo ip netns exec qdhcp-ab1a14d8-3b97-4e5e-9150-081c4afa5729 ping 192.168.21.1)</p>
<p><a href="https://review.openstack.org/#/c/273546" target="_blank" rel="external">https://review.openstack.org/#/c/273546</a> 这个patch通过ha_vrrp_health_check_interval提供了另外一种解决multiple master的办法，每个节点都定期ping网节，ping不通的话就说明出现multiple master了， 并且keepalived会根据ha_vrrp_health_check_interval重新选举直至选出新master为止。但是它依然有几个问题:</p>
<p>1, 它是ping外网网关10.5.0.1, 而不是tenant网关192.168.21.1, 所以它对解决上面问题依然无效.</p>
<p>2, 它本身有问题, 会造成VRRP状态反复的切换 - <a href="https://bugs.launchpad.net/neutron/+bug/1793102" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1793102</a></p>
<p>这个问题包括两个层面, 第一个是neutron db层面, 这是neutron的设计缺陷造成的, neutron没有调用keepalived获得状态, 而是通过ip monitor去维护状态, 这样必然有可能失去同步从而造成neutron这边看到多个master(如同时kill掉keepalived与neutron-keepalived-state-change进程), 但这点如果keepalived层面没有问题不会造成网络不通的问题, 顶多视觉上看到多个master但这点在下一次vrrp transition后也会回归正常； 另一个层面是keepalived的问题 - 应该是和这个相关 - <a href="https://github.com/acassen/keepalived/commit/e90a633c34fbe6ebbb891aa98bf29ce579b8b45c" target="_blank" rel="external">https://github.com/acassen/keepalived/commit/e90a633c34fbe6ebbb891aa98bf29ce579b8b45c</a></p>
<p>另一个问题, 下列脚本因为未在外层for循环中添加sleep会造成这个bug (<a href="https://bugs.launchpad.net/neutron/+bug/1823314)描述的问题" target="_blank" rel="external">https://bugs.launchpad.net/neutron/+bug/1823314)描述的问题</a>, 同一个tenant下的所有HA routers的vr_id相同, 这样一台host上就只可能启动这些HA routers中的某一个, 其余的就都启动不了.</p>
<p>#!/bin/bash</p>
<p>routers=$@</p>
<p>routers_scrubbed=$(echo $routers | sed -e ‘s/,/ /g’)</p>
<p>#routers=”87d2302b-77cb-44dc-80cd-7de61edb8482</p>
<p>#9bbb7f94-955e-4f52-be5b-53e502e421be</p>
<p>#b4465e79-2346-46c2-ab32-95f586578ce1</p>
<p>#c51db509-3edb-415f-90c7-1eae0af67bd2</p>
<p>#c6fb1d6f-9ee8-4f8f-b9fe-81b6422c63a5</p>
<p>#cad767e8-c003-49e0-8c7a-d5bcb5c86251”</p>
<p>all_l3_agents=$(neutron agent-list -f value | awk ‘/l3-agent/ {print $1}’)</p>
<p>for router in ${routers_scrubbed}<br>do<br>   agents=$(neutron l3-agent-list-hosting-router -f value ${router})<br>   agent_count=$(echo “${agents}”| wc -l)<br>   active_agents=$(echo “${agents}” | awk ‘/active/ {print $1}’)<br>   standby_agents=$(echo “${agents}” | awk ‘/standby/ {print $1}’)<br>   active_agents_count=$(echo “${agents}” | grep active | wc -l)<br>   echo “Agents: ${agent_count}, ${active_agents_count} active”<br>   if [ “${active_agents_count}” -gt “1” ]<br>   then<br>       echo “Bad router found, fixing”<br>       for bump_agent in $active_agents<br>       do<br>           echo “Bumping l3 agent ${bump_agent} for router ${router}”<br>           neutron l3-agent-router-remove “${bump_agent}” “${router}”<br>           neutron l3-agent-router-add “${bump_agent}” “${router}”<br>           echo “Waiting 3 seconds between router bumping”<br>           sleep 3<br>       done<br>   elif [ “${active_agents_count}” -lt “1” ]<br>   then<br>       echo “Dead router found, fixing”</p>
<pre><code># drop all agents, then add all agents
for bump_agent in $all_l3_agents
do
    echo &quot;Bumping l3 agent ${bump_agent} for router ${router}&quot;
    neutron l3-agent-router-remove &quot;${bump_agent}&quot; &quot;${router}&quot;
    neutron l3-agent-router-add &quot;${bump_agent}&quot; &quot;${router}&quot;
done
</code></pre><p>   fi<br>done<br>20190609更新</p>
<p>遇到新问题, 客户反应, 如两个ha gateway (gw1, gw2), 如果gw1是master, gw2是slave, 没问题. 但换过来就出问题, 后来通过抓包:</p>
<p>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 tcpdump -i any -w out.pcap arp or icmp<br>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 ip n<br>sudo ovs-tcpdump -i br-int “(arp or icmp) and net 192.168.100.0/24 and ether host fa:16:3e:51:a6:8a” -p ovs_tcpdump_capture.pcap<br>tshark -r attachments/ovs_tcpdump_port_br-int_00189699.pcap | grep duplicate<br>sudo ovs-tcpdump -e -i br-int “(arp or icmp)” -w ovs_tcpdump_port_br-int.pcap<br>sudo ovs-tcpdump -e -i tapebd2a710-3a “arp or icmp” -w ovs_tcpdump_port_ebd2a710-3a.pcap<br>watch -n 1 ‘sudo ovs-ofctl dump-flows br-tun| grep <mac addr="" of="" vm="" with="" ip="" 192.168.100.6="">‘<br>sudo ip netns exec qrouter-8126dc65-4fbe-4f22-ae77-1e3b7916b085 arping -I qr-ebd2a710-3a 192.168.100.6</mac></p>
<p>发现计算节点上有下列两条流表:</p>
<p>cookie=0xc47b830f360f3102, duration=262107.239s, table=20, n_packets=166506, n_bytes=8374732, idle_age=3, hard_age=65534, priority=2,dl_vlan=4,dl_dst=fa:16:3e:51:a6:8a actions=strip_vlan,load:0x1-&gt;NXM_NX_TUN_ID[],output:46<br>cookie=0xc47b830f360f3102, duration=2138996.306s, table=20, n_packets=3039, n_bytes=331269, hard_timeout=300, idle_age=65534, hard_age=0, priority=1,vlan_tci=0x0004/0x0fff,dl_dst=fa:16:3e:51:a6:8a actions=load:0-&gt;NXM_OF_VLAN_TCI[],load:0x1-&gt;NXM_NX_TUN_ID[],output:48 </p>
<p>显然删去第一条就好了:</p>
<p>ovs-ofctl del-flows br-tun “table=20,priority=2,dl_vlan=4,dl_dst=fa:16:3e:51:a6:8a”</p>
<p>可为什么会这样呢? 这条流表是l2pop里的, 这行被加的, 明明是在non-ha时才加啊 - <a href="https://github.com/openstack/neutron/blob/stable/queens/neutron/plugins/ml2/drivers/l2pop/mech_driver.py#L323" target="_blank" rel="external">https://github.com/openstack/neutron/blob/stable/queens/neutron/plugins/ml2/drivers/l2pop/mech_driver.py#L323</a></p>
<p>原因是数据库, 下列记录的device_owner不是network:ha_router_replicated_interface</p>
<p>select device_owner,id,name,network_id,mac_address,device_id from ports where mac_address=”fa:16:3e:51:a6:8a”<br>select device_owner,id,name,network_id,mac_address,device_id from ports where device_owner=”network:ha_router_replicated_interface”</p>
<p>device_owner    id    name    network_id    mac_address    device_id<br>network:router_interface    ebd2a710-3a94-466c-98e8-4b436fbb4b43        591b004e-d640-4df6-bee1-01fc2c38f166    fa:16:3e:51:a6:8a    8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>解决办法:</p>
<p>openstack router set –disable 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –no-ha 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –ha 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>openstack router set –enable 8126dc65-4fbe-4f22-ae77-1e3b7916b085<br>20191105更新</p>
<p>又一个相关bug - <a href="https://bugs.launchpad.net/ubuntu/+source/openvswitch/+bug/1839592" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/openvswitch/+bug/1839592</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/" data-id="ck4jppqr3000488bp17qfj9da" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Perf火焰图" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/08/Perf火焰图/" class="article-date">
  <time datetime="2019-11-08T07:17:52.000Z" itemprop="datePublished">2019-11-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/08/Perf火焰图/">Perf火焰图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="Install-perf"><a href="#Install-perf" class="headerlink" title="Install perf"></a>Install perf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:canonical-kernel-team/ppa</span><br><span class="line">sudo apt install linux-tools-$(uname -r)</span><br></pre></td></tr></table></figure>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul>
<li>火焰图看最宽的那条, 最宽的显示最耗时的, 上下最高则表示调用深度最长</li>
<li>如若抓应用态的(如ovs)则应添加” –call-graph dwarf “ 参数, ovs最好也安装符号表</li>
<li>如ovs隔六七秒就死, 可以使用它来抓这六七秒内的调用栈 - sudo perf record -a –call-graph dwarf – sleep 12</li>
</ul>
<h2 id="Perf-Flame-Graph"><a href="#Perf-Flame-Graph" class="headerlink" title="Perf Flame Graph"></a>Perf Flame Graph</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/cobblau/FlameGraph</span><br><span class="line">sudo perf record --call-graph dwarf -p $(pidof qemu-system-x86_64)</span><br><span class="line">sudo perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl &gt; process.svg</span><br></pre></td></tr></table></figure>
<h2 id="分解"><a href="#分解" class="headerlink" title="分解"></a>分解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo perf record -F 99 -g -- sleep 30 $(pidof qemu-system-x86_64)</span><br><span class="line">sudo perf report -n --stdio</span><br><span class="line">sudo perf script | gzip &gt; out.perf01.gz</span><br><span class="line">git clone https://github.com/cobblau/FlameGraph</span><br><span class="line">; http://svgshare.com can be used to share svg</span><br><span class="line">sudo perf script | ./FlameGraph/stackcollapse-perf.pl | sed &apos;/cpu_idle/d;s/\[unknown\];//g&apos; | ./FlameGraph/flamegraph.pl --width 1000 &gt; perf.svg</span><br><span class="line">google-chrome-stable ./perf.svg</span><br></pre></td></tr></table></figure>
<h2 id="其他一"><a href="#其他一" class="headerlink" title="其他一"></a>其他一</h2><p>参考： <a href="https://github.com/bboymimi/perf-utils" target="_blank" rel="external">https://github.com/bboymimi/perf-utils</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># To get the all CPUs profiling callstack from user space to kernel space (both kernel and user space)</span><br><span class="line">sudo perf record -a --call-graph dwarf</span><br><span class="line"># To get the all CPUs profiling of kernel space callstack (just kernel space)</span><br><span class="line">sudo perf record -a -g</span><br><span class="line">git clone https://github.com/bboymimi/perf-utils.git</span><br><span class="line">sudo ./perf-utils/easy-flamegraph.sh -i perf.data</span><br><span class="line">google-chrome-stable ./perf-output/2018-01-04_14:18:15.perf.data.svg</span><br></pre></td></tr></table></figure></p>
<h2 id="其他二"><a href="#其他二" class="headerlink" title="其他二"></a>其他二</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Enable the sysrq</span><br><span class="line">sudo sysctl -w kernel.sysrq=1</span><br><span class="line"># Dump all active tasks stack - https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html</span><br><span class="line">echo l | sudo tee /proc/sysrq-trigger</span><br><span class="line"># Dumps tasks that are in uninterruptable (blocked) state.</span><br><span class="line">echo p | sudo tee /proc/sysrq-trigger</span><br><span class="line"># Performance profiling and get the flame-graph to see if there is</span><br><span class="line">any performance bottleneck when the problem happened</span><br><span class="line">git clone git://kernel.ubuntu.com/gavinguo/perf-production.git</span><br><span class="line">sudo perf record -a -g sleep 5</span><br><span class="line">sudo ./easy-flamegraph.sh -i ./perf.data -t</span><br></pre></td></tr></table></figure>
<p><strong>Profile Java with Perf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Profile Java with Perf</span><br><span class="line"># https://cloud.tencent.com/developer/article/1416234</span><br><span class="line"># https://my.oschina.net/u/150599/blog/3023394</span><br><span class="line">sudo apt install -y linux-tools-common linux-tools-generic bindfs</span><br><span class="line">mkdir /tmp/containerrootfs</span><br><span class="line">PID=$(docker inspect --format &#123;&#123;.State.Pid&#125;&#125; cas1)</span><br><span class="line">sudo perf record -g -p $PID</span><br><span class="line">sudo perf report</span><br><span class="line">#fix symbols in container</span><br><span class="line">cp perf.data /tmp/containerrootfs/</span><br><span class="line">bindfs /proc/$PID/root /tmp/containerrootfs</span><br><span class="line">perf report --symfs /tmp/containerrootfs</span><br><span class="line">umount /tmp/containerrootfs</span><br><span class="line"></span><br><span class="line"># install java</span><br><span class="line">sudo apt install -y openjdk-8-jdk</span><br><span class="line">dpkg-query -L openjdk-8-jdk</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64</span><br><span class="line"># install perf-map-agent to help generate symbols with FlameGraph</span><br><span class="line">sudo apt install -y cmake pkg-config libfuse-dev libfuse2 autoconf</span><br><span class="line">git clone https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">export FLAMEGRAPH_DIR=/home/ubuntu/FlameGraph</span><br><span class="line">git clone https://github.com/jvm-profiling-tools/perf-map-agent.git</span><br><span class="line">cd perf-map-agent/</span><br><span class="line">cmake .</span><br><span class="line">make</span><br><span class="line">sudo bin/create-links-in /usr/local/bin</span><br><span class="line"></span><br><span class="line"># Use perf-java-flames (</span><br><span class="line"># Need to add one jvm option in java process: -XX:+PreserveFramePointer</span><br><span class="line">perf-java-flames $PID -g</span><br><span class="line">#perf-java-record-stack $PID -g</span><br><span class="line">chromium-browser /bak/work/perf-map-agent/flamegraph-10286.svg</span><br></pre></td></tr></table></figure>
<p><strong>上下文切换高</strong><br>启用sar，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install sysstat</span><br><span class="line">sudo sed -i &apos;s/^ENABLED=&quot;false&quot;/ENABLED=&quot;true&quot;/&apos; /etc/default/sysstat</span><br><span class="line">sudo sed -i &apos;s/^5-55\/10/*\/2/&apos; /etc/cron.d/sysstat</span><br><span class="line">sudo systemctl restart sysstat</span><br></pre></td></tr></table></figure></p>
<p>后可以观测如上文文切换过高<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00:00:01       proc/s   cswch/s</span><br><span class="line">Average:       143.82  59339.01</span><br></pre></td></tr></table></figure></p>
<p>可以搜索火焰图（用户态内核态一起收集)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://kernel.ubuntu.com/gavinguo/perf-production.git</span><br><span class="line">cd perf-production</span><br><span class="line">sudo perf record -a --call-graph dwarf sleep 5</span><br><span class="line">sudo ./easy-flamegraph.sh -i ./perf.data -t</span><br></pre></td></tr></table></figure></p>
<p>也可以使用pidstat -w 1来确定哪个进程的上下文切换高， 或者:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://serverfault.com/questions/190049/find-out-which-task-is-generating-a-lot-of-context-switches-on-linux</span><br><span class="line">sudo perf record -e context-switches -a -g</span><br><span class="line"># then ctrl+c</span><br><span class="line">sudo perf report # inspect the result</span><br></pre></td></tr></table></figure></p>
<p><strong>Appendix - error - ERROR: No stack counts found </strong><br>遇到下面error是需要: sudo chown -R root:root perf.data, 必须使用root用户, 而非它说的普通用户.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:/bak/work/perf-utils$ sudo ./easy-flamegraph.sh perf.data  -f</span><br><span class="line">Use the /bak/work/perf-utils/perf.data as the source of the FlameGraph.</span><br><span class="line">File /bak/work/perf-utils/perf.data not owned by current user or root (use -f to override)</span><br><span class="line">ERROR: No stack counts found</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" target="_blank" rel="external">http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/08/Perf火焰图/" data-id="ck4jppqr7000888bpp2xppkqn" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用apt-mirror和simplestreams搭建本地源" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/06/使用apt-mirror和simplestreams搭建本地源/" class="article-date">
  <time datetime="2019-11-06T09:49:49.000Z" itemprop="datePublished">2019-11-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/06/使用apt-mirror和simplestreams搭建本地源/">使用apt-mirror和simplestreams搭建本地源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>你懂的，国内环境访问ubuntu-cloud.archive.canonical.com会非常慢(注： 其实下列方法可以同步UA, UCA, PPA)，本文将使用apt-mirror搭建一个本地apt服务器以提升办公效率。</p>
<ul>
<li>archive.ubuntu.com                   (UA, can use <a href="http://mirrors.cloud.tencent.com/ubuntu/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu/</a> instead)</li>
<li>security.ubuntu.com                  (UA, can use <a href="http://mirrors.cloud.tencent.com/ubuntu/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu/</a> instead)</li>
<li>ubuntu-cloud.archive.canonical.com (UCA)</li>
<li>images.maas.io                       (juju , lxd, maas)</li>
<li>cloud-images.ubuntu.com              (juju , lxd, maas, <a href="http://mirrors.cloud.tencent.com/ubuntu-cloud-images/" target="_blank" rel="external">http://mirrors.cloud.tencent.com/ubuntu-cloud-images/</a> instead)</li>
<li>streams.canonical.com                (juju , lxd, maas)<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br><span class="line">sudo apt -y install apache2 apt-mirror</span><br><span class="line">mkdir -p /images/xenial-repo</span><br><span class="line"></span><br><span class="line">$ cat /etc/apt/mirror.list</span><br><span class="line">############# config ##################</span><br><span class="line">#</span><br><span class="line">set base_path /images/xenial-repo</span><br><span class="line">#set defaultarch amd64</span><br><span class="line">#</span><br><span class="line"># set mirror_path  $base_path/mirror</span><br><span class="line"># set skel_path    $base_path/skel</span><br><span class="line"># set var_path     $base_path/var</span><br><span class="line"># set cleanscript $var_path/clean.sh</span><br><span class="line"># set defaultarch  &lt;running host architecture&gt;</span><br><span class="line"># set postmirror_script $var_path/postmirror.sh</span><br><span class="line"># set run_postmirror 0</span><br><span class="line">set nthreads     30</span><br><span class="line">set _tilde 0</span><br><span class="line">#</span><br><span class="line">############# end config ##############</span><br><span class="line"></span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-proposed main restricted universe multiverse</span><br><span class="line">#deb http://cn.archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-proposed main restricted universe multiverse</span><br><span class="line">#deb-src http://archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">#see http://ubuntu-cloud.archive.canonical.com/ubuntu/dists/xenial-updates/</span><br><span class="line">deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/ocata main</span><br><span class="line">#deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/queens main</span><br><span class="line"></span><br><span class="line">#clean http://archive.ubuntu.com/ubuntu</span><br><span class="line">clean http://ubuntu-cloud.archive.canonical.com/ubuntu</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /images/xenial-repo/var/postmirror.sh</span><br><span class="line">sudo apt-mirror</span><br></pre></td></tr></table></figure>
<p>或者运行“sudo crontab -e”添加下列crob在每天四点半运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 4    * * *    root    /usr/bin/apt-mirror &gt;&gt; /var/log/apt-mirror.log</span><br></pre></td></tr></table></figure></p>
<h2 id="配置Apache"><a href="#配置Apache" class="headerlink" title="配置Apache"></a>配置Apache</h2><p>Apache的已有配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo grep -r &apos;DocumentRoot&apos; /etc/apache2/sites-available/000-default.conf</span><br><span class="line">        DocumentRoot /var/www/html</span><br><span class="line"></span><br><span class="line">$ grep -r &apos;/var/www/&apos; /etc/apache2/apache2.conf -A 4</span><br><span class="line">&lt;Directory /var/www/&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">	AllowOverride All</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>创建软链及注意一个关键易犯问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /images/xenial-repo  /var/www/html/apt-mirror</span><br><span class="line">sudo chown -R www-data:www-data /images</span><br><span class="line">sudo service apache2 reload</span><br></pre></td></tr></table></figure>
<p>注：上面这一句”chown -R www-data:www-data /images”异常关键，网上几乎所有能搜寻的答案全部是关于添加’Options FollowSymLinks’的，其实如上/etc/apache2/apache2.conf文件中已经包含该设置。apache 2.4使用的目录的用户名和组必须全部是www-data，否则/var/log/apache2/error.log会报这个错误“Symbolic link not allowed or link target not accessible”（WEB页上看到的错误是‘You don’t have permission to access”）。可用该命令“sudo -u www-data ls /var/www/html/apt-mirror”验证它是否成功。之前我一直在这个地方犯错是因为我执行的是“chown -R www-data:www-data /images/xenial-repo”，这样导致仍然无法顺利执行““sudo -u www-data ls /var/www/html/apt-mirror”命令。<br>也可创建/etc/apache2/sites-available/ubuntu-mirror.conf使用VirtualHost同时支持对UA, UCA, PPT的同步：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-repo.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/archive.ubuntu.com/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-archive.ubuntu.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-archive.ubuntu.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-cloudrepo.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/ubuntu-cloud.archive.canonical.com/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-cloudarchive.canonical.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-cloudarchive.canonical.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName your-ppa.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/apt-mirror/mirror/ppa.launchpad.net/</span><br><span class="line"></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-ppaarchive.canonical.com-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-ppaarchive.canonical.com-access.log combined</span><br><span class="line"></span><br><span class="line">    &lt;Directory /var/spool/apt-mirror/&gt;</span><br><span class="line"></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p>
<p>或要支持ssl，再添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SSLCACertificatePath /etc/ssl/certs</span><br><span class="line">SSLCertificateFile /etc/pki/tls/certs/mirror.crt</span><br><span class="line">SSLEngine On</span><br><span class="line">SSLCertificateKeyFile /etc/pki/tls/private/mirror.key</span><br></pre></td></tr></table></figure>
<p>之后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a2enmod ssl</span><br><span class="line">a2ensite *</span><br><span class="line">systemctl restart apache2</span><br></pre></td></tr></table></figure></p>
<h2 id="使用它"><a href="#使用它" class="headerlink" title="使用它"></a>使用它</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/apt/sources.list.d/mymirror.list</span><br><span class="line">cat &gt; /etc/apt/sources.list.d/mymirror.list &lt;&lt;EOF</span><br><span class="line">#deb http://node1/apt-mirror/mirror/cn.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://node1/apt-mirror/mirror/ubuntu-cloud.archive.canonical.com/ubuntu/ xenial-updates/ocata main</span><br><span class="line">EOF</span><br><span class="line">rm -rf /etc/apt/sources.list.d/cloudarchive-ocata.list*</span><br><span class="line">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 5EDB1B62EC4926EA</span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>
<h2 id="20171101更新"><a href="#20171101更新" class="headerlink" title="20171101更新"></a>20171101更新</h2><p>此次apt update慢的原因最后通过”Software &amp; Update -&gt; Ubuntu Software -&gt; Download from Other - Select Best Server”将之前的mirrors.aliyun.com改成mirrors.yun-idc.com就好了。之前各种源也都换过，为什么这次行了具体原因不明待下次遇到了待查。</p>
<h2 id="20171115更新"><a href="#20171115更新" class="headerlink" title="20171115更新"></a>20171115更新</h2><p>今天在安装libvirt0时总是发生包依赖问题（libvirt0: Depends: libxen-4.6 (&gt;=4.6.5) but 4.6.0-1ubuntu4.3 is to be installed)，原来是mirrors.aliyun.com的问题，这个源更新不及时会造成众多问题。<br><strong>为了克服这种更新不及时造成的问题，看样子还是最好别搭私有源和使用国内源，所以换回官方源</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://nova.clouds.archive.ubuntu.com/ubuntu/ xenial-security main restricted universe multiverse</span><br></pre></td></tr></table></figure></p>
<h2 id="20191106更新-搭建simplestreams本地源"><a href="#20191106更新-搭建simplestreams本地源" class="headerlink" title="20191106更新 - 搭建simplestreams本地源"></a>20191106更新 - 搭建simplestreams本地源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install simplestreams</span><br><span class="line">sudo mkdir -p /var/spool/sstreams/maas &amp;&amp; sudo chown -R $USER /var/spool/sstreams/maas</span><br><span class="line"></span><br><span class="line">#MAAS images simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/maas</span><br><span class="line">sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1  https://images.maas.io/ephemeral-v3/daily/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos;</span><br><span class="line">sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1  https://images.maas.io/ephemeral-v3/daily/ $workdir &apos;os~(grub*|pxelinux)&apos;</span><br><span class="line"></span><br><span class="line">#Use MAAS images simplestreams</span><br><span class="line">maas root boot-source update 1 url=https://maas-images.yourdomain.com/ keyring_filename=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg</span><br><span class="line">maas root domains create name=&quot;yourdomain.com&quot;</span><br><span class="line">maas root dnsresources create fqdn=&quot;maas-images.yourdomain.com&quot; ip_addresses=&lt;your-mirror-ip&gt;  #orconfigure the mirror in infra.yaml</span><br><span class="line"></span><br><span class="line">#Juju agents simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/juju</span><br><span class="line">sstream-mirror --no-verify --progress --max=2 --path=streams/v1/index2.sjson https://streams.canonical.com/juju/tools/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;version~(2.6)&apos;</span><br><span class="line"></span><br><span class="line">#Use Juju agents simplestreams</span><br><span class="line">#let juju know where to get contrainers from, or defined it in juju-model-default.yaml</span><br><span class="line">juju model-config container-image-stream=released container-image-metadata-url=https://lxd-images.yourdomain.com/ image-metadata-url=https://lxd-images.yourdomain.com</span><br><span class="line">#let juju know where to fetach the agents, or defined it in juju-model-default.yaml</span><br><span class="line">juju model-config agent-metadata-url=https://juju-agents.yourdomain.com/ agent-stream=released</span><br><span class="line"></span><br><span class="line">#LXD and KVM images simplestreams</span><br><span class="line">workdir=/var/spool/sstreams/lxdkvm</span><br><span class="line">sudo sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1 --path=streams/v1/index.json https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line">sudo sstream-mirror --keyring=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg --progress --max=1 --path=streams/v1/index.sjson https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line">https://cloud-images.ubuntu.com/releases/ $workdir &apos;arch=amd64&apos; &apos;release~(bionic)&apos; &apos;ftype~(lxd.tar.xz|squashfs|root.tar.xz|root.tar.gz|disk1.img|.json|.sjson)&apos;</span><br><span class="line"></span><br><span class="line">sudo apt install apache2 -y</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/apache2/sites-available/sstreams-mirror.conf</span><br><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">    ServerName maas-images.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/maas</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-maas-images-error.log</span><br><span class="line">     CustomLog /var/log/apache2/mirror-maas-images-access.log combined</span><br><span class="line">     &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">     Options Indexes FollowSymLinks</span><br><span class="line">     AllowOverride None</span><br><span class="line">     Require all granted</span><br><span class="line">     &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName lxdkvm-images.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/lxdkvm</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-lxdkvm-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-lxdkvm-access.log combined</span><br><span class="line">    &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName juju-agents.yourdomain.com</span><br><span class="line">    DocumentRoot /var/spool/sstreams/juju</span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLog /var/log/apache2/mirror-juju-error.log</span><br><span class="line">    CustomLog /var/log/apache2/mirror-juju-access.log combined</span><br><span class="line">    &lt;Directory /var/spool/sstreams/&gt;</span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/06/使用apt-mirror和simplestreams搭建本地源/" data-id="ck4jppqrt000y88bpo1qdlxac" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-k8s-http-https-nginx-ingress" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/05/k8s-http-https-nginx-ingress/" class="article-date">
  <time datetime="2019-11-05T04:02:18.000Z" itemprop="datePublished">2019-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/05/k8s-http-https-nginx-ingress/">k8s http/https nginx ingress</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>作者：张华 发表于：2019-11-05<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="https://zhhuabj.blog.csdn.net" target="_blank" rel="external">https://zhhuabj.blog.csdn.net</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x-forwarded-proto里. 所以在L7 LB模式中, 并没有将tcp连接透传给nginx-ingress. <strong>NOTE: 这块可以使用”curl -H ‘X-Forwarded-Proto: https’ -H ‘X-Forwsarded-Host: newhost’ 192.168.99.135:8000”模拟代替.</strong></li>
<li>nginx-ingress, 默认的nginx-ingress里使用(proxy_set_header X-Forwarded-Proto $pass_access_scheme;)与(proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;)获取的是L7 LB的IP作为client ip, 以及将L7</li>
<li>LB访问的scheme作为scheme. 这里应该改从header里取(http_x_forwarded_proto). backend, 如果backend利用了x-forwarded-*这些header来构造redirect url的话, 如果没有获取到x-forwarded-proto时, 它如果要继续转发(Http Redirect)的话, 可以就会出现url问题.</li>
</ul>
<p>Client与nginx-ingress之间可以配置https，此时nginx-ignress与backends仍然可以配置http, ssl termination, ssl passthrough三种模式。若Client前面还有L7 LB那就是四种模式：</p>
<ul>
<li>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination https (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS” or nginx.ingress.kubernetes.io/secure-backends: “true”)</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl passthrough https (–enable-ssl-passthrough and nginx.ingress.kubernetes.io/ssl-passthrough: “true”)</li>
<li>client –(HTTPs)–&gt; L7 LB –(use-forwarded-headers=true, X-Forwarded-Proto=https)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl termination with F5 - <a href="https://bugs.launchpad.net/bugs/1842286" target="_blank" rel="external">https://bugs.launchpad.net/bugs/1842286</a><h2 id="http-ingress"><a href="#http-ingress" class="headerlink" title="http ingress"></a>http ingress</h2>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">juju scp kubernetes-master/0:config ~/.kube/config</span><br><span class="line">#juju run-action etcd/0 health --wait</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line">kubectl get services --namespace=ingress-nginx-kubernetes-worker default-http-backend-kubernetes-worker -o yaml</span><br><span class="line">kubectl get daemonset --namespace=ingress-nginx-kubernetes-worker nginx-ingress-controller-kubernetes-worker -o yaml</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">        - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">        - --enable-ssl-chain-completion=False</span><br><span class="line">        - --enable-ssl-passthrough=False</span><br><span class="line"></span><br><span class="line">#deploy http ingress</span><br><span class="line">kubectl run nginx --image=nginx --port 80</span><br><span class="line">kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-test.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-service</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: &quot;quqi.com&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ./ingress-test.yaml</span><br><span class="line">kubectl describe ingresses ingress-service</span><br><span class="line">kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">$ kubectl describe service nginx</span><br><span class="line">IP:                       10.152.183.250</span><br><span class="line">Port:                     &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  31463/TCP</span><br><span class="line">Endpoints:                10.1.60.3:80</span><br><span class="line">$ juju status |grep worker/0</span><br><span class="line">kubernetes-worker/0*      active    idle   4        10.5.0.53       80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line"></span><br><span class="line">#curl http(s)://&lt;worker-ip&gt;:NodePort&gt;/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ssl-termination-http"><a href="#ssl-termination-http" class="headerlink" title="ssl termination http"></a>ssl termination http</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http<br>ssl termination可参见：<a href="https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/" target="_blank" rel="external">https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/</a><br>在k8s中， 如果nginx-ingress前面还有LB如F5的话，nginx-ingress并不是和client直接相连的，client传给F5的链接里的https标记会最终设置成X-Forwarded-Proto=https, 所以nginx-ingress这端需要在configmap中设置use-forwarded-headers=true(kubectl -n ingress-nginx-kubernetes-worker edit cm nginx-configura<br>tion), If true, nginx-ingress passes the incoming X-Forwarded-* (eg: X-Forwarded-Proto) headers to upstreams. Use this option when nginx is behind another L7 proxy / LB that is setting these headers.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">kubectl create secret tls ingress-ssl-secret --cert=server.crt --key=server.key</span><br><span class="line">kubectl describe secret ingress-ssl-secret</span><br><span class="line">kubectl run nginx --image=nginx --port 80 --expose</span><br><span class="line"></span><br><span class="line"># 将ingress controller pods定义service对外暴露NodePort (NOTE: 下面namespace应该用default) -</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32080</span><br><span class="line">    - name: https</span><br><span class="line">      port: 443</span><br><span class="line">      targetPort: 443</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32443</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-w98fm -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 2.txt</span><br><span class="line">vimdiff 1.txt 2.txt</span><br><span class="line">#https://paste.ubuntu.com/p/8yV7RZJ9D7/</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure></p>
<p>如果nginx-ingress和backend总是采用https的话， ingress定义时需添加annotation：nginx.ingress.kubernetes.io/secure-backends: “true”<br>或者使用附录中的tomcat容器也行。</p>
<h2 id="ssl-termination-with-HTTPS-backend"><a href="#ssl-termination-with-HTTPS-backend" class="headerlink" title="ssl termination with HTTPS backend"></a>ssl termination with HTTPS backend</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”  or nginx.ingress.kubernetes.io/secure-backends: “true”)<br>后端需要做一个https测试应用： <a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>新版本需添加：nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”， 旧版本使用：nginx.ingress.kubernetes.io/secure-backends: “true”,<br>下面是制作一个https测试应用的步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line"></span><br><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;simple-https-server.py&apos; &lt;&lt;EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import ssl</span><br><span class="line">httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 443), SimpleHTTPServer.SimpleHTTPRequestHandler)</span><br><span class="line">httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">httpd.serve_forever()</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;index.html&apos; &lt;&lt;EOF</span><br><span class="line">Hello world!</span><br><span class="line">EOF</span><br><span class="line">nohup sudo python simple-https-server.py &amp;</span><br><span class="line">curl --resolve ssltest.quqi.com:443:192.168.99.135 --cacert ./server.pem https://ssltest.quqi.com</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;Dockerfile&apos; &lt;&lt;EOF</span><br><span class="line">FROM python:2.7-alpine</span><br><span class="line">ADD simple-https-server.py /</span><br><span class="line">ADD index.html /</span><br><span class="line">ADD server.pem /</span><br><span class="line">RUN apk update &amp;&amp; apk add bash</span><br><span class="line">RUN pip install simple_http_server</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./simple-https-server.py&quot; ]</span><br><span class="line">EOF</span><br><span class="line">#sudo docker run -it --rm --name simple-https-server -v &quot;$PWD&quot;:/root -w /root python:2.7-alpine python simple-https-server.py</span><br><span class="line"></span><br><span class="line">sudo apt install docker.io -y</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/default/docker&apos; &lt;&lt;EOF</span><br><span class="line">DOCKER_OPTS=&quot;--insecure-registry $DOCKER_OPTS --insecure-registry registry.mirrors.aliyuncs.com&quot;</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/docker/daemon.json&apos; &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https://6kx4zyno.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line">sudo docker build -t simple-https-server .</span><br><span class="line">sudo docker tag simple-https-server zhhuabj/simple-https-server</span><br><span class="line">sudo docker image rm simple-https-server</span><br><span class="line">sudo docker history zhhuabj/simple-https-server</span><br><span class="line">#sudo docker run -d --rm --name simple-https-server zhhuabj/simple-https-server</span><br><span class="line">#sudo docker inspect simple-https-server |grep IPAddress</span><br><span class="line">#curl --resolve ssltest.quqi.com:443:172.17.0.2 --cacert server.pem https://ssltest.quqi.com</span><br><span class="line">#sudo docker rm simple-https-server --force</span><br><span class="line">proxychains4 sudo docker login</span><br><span class="line">sudo docker push zhhuabj/simple-https-server</span><br><span class="line"></span><br><span class="line">#don&apos;t know why image always doesn&apos;t update even if using --image-pul-policy=Always, so:</span><br><span class="line">sudo docker pull zhhuabj/simple-https-server</span><br><span class="line">sudo docker tag zhhuabj/simple-https-server zhhuabj/simple-https-server:withbash</span><br><span class="line">sudo docker push zhhuabj/simple-https-server:withbash</span><br><span class="line">#debug, containerd operation</span><br><span class="line">sudo ctr --namespace k8s.io containers ls</span><br><span class="line">sudo ctr --namespace k8s.io images ls</span><br><span class="line"></span><br><span class="line">kubectl run simple-https-server --image=zhhuabj/simple-https-server:withbash --image-pull-policy=Always --port 443</span><br><span class="line">kubectl expose deployment simple-https-server --port=443 --target-port=443</span><br><span class="line">kubectl describe service simple-https-server</span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl --resolve ssltest.quqi.com:31750:10.5.0.26 --cacert server.pem https://ssltest.quqi.com:31750</span><br></pre></td></tr></table></figure></p>
<p>继续测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;ingress-simple-https-server.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-simple-https-server</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: simple-https-server</span><br><span class="line">          servicePort: 443</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-simple-https-server.yaml</span><br><span class="line"></span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k</span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k -I -L</span><br><span class="line">telnet 10.5.0.40 32443</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker describe service ingress-nginx</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 --cacert server.pem https://ssltest.quqi.com:32443</span><br><span class="line"></span><br><span class="line">kubectl exec -ti simple-https-server-84d588fcb4-9sxsh -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- cat /etc/nginx/nginx.conf grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line"># NOTE: Wrong usage</span><br><span class="line">#kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 3.txt</span><br><span class="line">Error from server (NotFound): pods &quot;pod&quot; not found  #need to re-install env</span><br></pre></td></tr></table></figure></p>
<h2 id="ssl-passthrough"><a href="#ssl-passthrough" class="headerlink" title="ssl passthrough"></a>ssl passthrough</h2><p>ssl passthrough可参见：<a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>ssl passthrough时由于使用tcp不做https拆包取不到https相关字段，但nginx提供了preread on特性在握手阶段读取domain, 这样可实现SNI - 见： <a href="https://www.jianshu.com/p/c86a94b14137" target="_blank" rel="external">https://www.jianshu.com/p/c86a94b14137</a><br>在k8s中，需要启动controller时添加–enable-ssl-passthrough标志, ssl passthrough only works on layer 4 (TCP) and not on layer 7 (HTTP), 同时ingress定义时添加annotation：nginx.ingress.kubernetes.io/ssl-passthrough: “true”， 另外测试时应指明key:<br>curl –resolve ssltest.quqi.com:443:10.5.0.8 –cacert server.pem <a href="https://ssltest.quqi.com" target="_blank" rel="external">https://ssltest.quqi.com</a></p>
<h2 id="k8s-ingress-前端再加F7-LB"><a href="#k8s-ingress-前端再加F7-LB" class="headerlink" title="k8s ingress 前端再加F7 LB"></a>k8s ingress 前端再加F7 LB</h2><p>1, 编辑configmap添加内容：<br>kubectl edit cm –namespace=ingress-nginx-kubernetes-worker nginx-configuration<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  use-forwarded-headers: &quot;true&quot;</span><br></pre></td></tr></table></figure></p>
<p>2, Set up L7 LB in front of ingress-controller<br>sudo apt install haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#install haproxy in bastion</span><br><span class="line">sudo apt install haproxy -y</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/haproxy/haproxy.cfg&apos; &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     2048</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    tune.ssl.default-dh-param 2048</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option forwardfor</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">   mode http</span><br><span class="line">   bind 10.5.0.8:80</span><br><span class="line">   reqadd X-Forwarded-Proto:\ http</span><br><span class="line">   default_backend https-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind 10.5.0.8:443 ssl crt /home/ubuntu/sslkey/server.pem ca-file /home/ubuntu/sslkey/ca.crt</span><br><span class="line">    reqadd X-Forwarded-Proto:\ https</span><br><span class="line">    default_backend https-routers</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    balance roundrobin</span><br><span class="line">    cookie SERVERID insert indirect nocache</span><br><span class="line">    #http-request set-header Host ssltest.quqi.com</span><br><span class="line">    server s1 10.5.0.40:32443 check check-ssl ssl verify none</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl stop haproxy</span><br><span class="line">haproxy -vv</span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg -c</span><br><span class="line">sudo haproxy -f /etc/haproxy/haproxy.cfg -V</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 https://ssltest.quqi.com:32443 --cacert ~/sslkey/server.pem</span><br><span class="line">curl https://10.5.0.8 -k</span><br><span class="line">curl --resolve ssltest.quqi.com:443:10.5.0.8 https://ssltest.quqi.com:443 --cacert ~/sslkey/server.pem</span><br></pre></td></tr></table></figure>
<p>如果需要ssl双向认证, 可将上面的” server s1 10.5.0.40:32443 check check-ssl ssl verify none”改为(but it doesn’t work now):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#two-day authenication, but it doesn&apos;t work - https://blog.csdn.net/yin_slin/article/details/81130723</span><br><span class="line">openssl genrsa -passout pass:password -out client.key</span><br><span class="line">openssl req -new -key client.key -out client.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=10.5.0.8&quot;</span><br><span class="line">openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 3650</span><br><span class="line">openssl pkcs12 -export -inkey client.key -in client.crt -certfile ca.crt -passout pass:password -out client.p12</span><br><span class="line">echo y | keytool -importcert -alias ca -file ca.crt -keystore client-trust.jks -storepass password</span><br><span class="line">echo y | keytool -importcert -alias client -file client.crt -keystore client-trust.jks -storepass password</span><br></pre></td></tr></table></figure></p>
<h2 id="支持X-FORWARDED-PROTO转发的应用"><a href="#支持X-FORWARDED-PROTO转发的应用" class="headerlink" title="支持X_FORWARDED_PROTO转发的应用"></a>支持X_FORWARDED_PROTO转发的应用</h2><p>要继续测试nginx-ingress未传X_FORWARDED_PROTO的影响的话, 需要构建这么一个测试应用, 它要使用X_FORWARDED_PROTO来构建url来做跳转. (或者应用前再搞一级nginx代理之类的作跳转?)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-django -y</span><br><span class="line">python -m django --version</span><br><span class="line">django-admin startproject mysite</span><br><span class="line">cd mysite</span><br><span class="line">sed -i &quot;s,ALLOWED_HOSTS = \[\],ALLOWED_HOSTS = \[&apos;*&apos;\],g&quot; mysite/settings.py</span><br><span class="line">sed -i &quot;s,DEBUG = True,DEBUG = False,g&quot; mysite/settings.py</span><br><span class="line">echo &quot;SECURE_PROXY_SSL_HEADER = (&apos;HTTP_X_FORWARDED_PROTO&apos;, &apos;https&apos;)&quot; &gt;&gt; mysite/settings.py</span><br><span class="line"></span><br><span class="line">#Note: To properly simulate a HTTPS connection in Django, you should also set an environment variable HTTPS=on.</span><br><span class="line">HTTPS=on python manage.py runserver 192.168.99.135:8000</span><br><span class="line">lynx http://192.168.99.135:8000/</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee mysite/sslmiddleware.py</span><br><span class="line"># refer https://github.com/rdegges/django-sslify.git</span><br><span class="line">try:</span><br><span class="line">    # Python 2.x</span><br><span class="line">    from urlparse import urlsplit, urlunsplit</span><br><span class="line">except ImportError:</span><br><span class="line">    # Python 3.x</span><br><span class="line">    from urllib.parse import urlsplit</span><br><span class="line">    from urllib.parse import urlunsplit</span><br><span class="line"></span><br><span class="line">from django.conf import settings</span><br><span class="line">from django.http import HttpResponsePermanentRedirect</span><br><span class="line">from django.http import HttpResponse, HttpResponseRedirect</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    # Django 1.10</span><br><span class="line">    from django.utils.deprecation import MiddlewareMixin</span><br><span class="line">except ImportError:</span><br><span class="line">    # Django &lt;1.10</span><br><span class="line">    class MiddlewareMixin(object):</span><br><span class="line">        def __init__(self, get_response=None):</span><br><span class="line">            self.get_response = get_response</span><br><span class="line">            super(MiddlewareMixin, self).__init__()</span><br><span class="line"></span><br><span class="line">        def __call__(self, request):</span><br><span class="line">            response = None</span><br><span class="line">            if hasattr(self, &apos;process_request&apos;):</span><br><span class="line">                response = self.process_request(request)</span><br><span class="line">            if not response:</span><br><span class="line">                response = self.get_response(request)</span><br><span class="line">            if hasattr(self, &apos;process_response&apos;):</span><br><span class="line">                response = self.process_response(request, response)</span><br><span class="line">            return response</span><br><span class="line"></span><br><span class="line">import logging</span><br><span class="line">logger = logging.getLogger(&apos;router&apos;)</span><br><span class="line"></span><br><span class="line">class SSLMiddleware(MiddlewareMixin):</span><br><span class="line"></span><br><span class="line">    def process_request(self, request):</span><br><span class="line">        url = request.build_absolute_uri(request.get_full_path())</span><br><span class="line">        forwarded_proto = request.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">        #forwarded_proto = request.META.get(&quot;HTTP_X_FORWARDED_PROTO&quot;, &quot;&quot;)</span><br><span class="line">        if forwarded_proto:</span><br><span class="line">            url_split = urlsplit(url)</span><br><span class="line">            scheme = &apos;https&apos; if url_split.scheme == &apos;http&apos; else url_split.scheme</span><br><span class="line">            url_secure_split = (scheme, &quot;%s:%d&quot; % (url_split.hostname or &apos;&apos;, 443)) + url_split[2:]</span><br><span class="line">            #secure_url = url.replace(&quot;http://&quot;, &quot;https://&quot;)</span><br><span class="line">            secure_url = urlunsplit(url_secure_split)</span><br><span class="line">        #print(url)</span><br><span class="line">        #print(forwarded_proto)</span><br><span class="line">        #print(secure_url)</span><br><span class="line">        #return HttpResponsePermanentRedirect(secure_url)</span><br><span class="line">        return HttpResponseRedirect(secure_url)</span><br><span class="line"></span><br><span class="line">    def process_response(self,request,response):</span><br><span class="line">        #print(&apos;response:&apos;)</span><br><span class="line">        print(response)</span><br><span class="line">        return response</span><br><span class="line">EOF</span><br><span class="line">add the line &apos;mysite.middleware.SSLMiddleware&apos;, into MIDDLEWARE item in settings.py, NOTE: Make sure this middleware is the first middleware class listed, as this will ensure that if a user makes an insecure request (over HTTP)</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; http://192.168.99.135:8000</span><br><span class="line">$ python manage.py runserver 192.168.99.135:8000</span><br><span class="line">...</span><br><span class="line">Starting development server at http://192.168.99.135:8000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Location: https://192.168.99.135:443/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[13/Nov/2019 11:16:31] &quot;GET / HTTP/1.1&quot; 302 0</span><br></pre></td></tr></table></figure></p>
<p>改良型的应用如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee simple-http-server.py</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># NOTE: Need to make chrome stop redirect from http to https when using chrome for test</span><br><span class="line"># Go to chrome://net-internals/#hsts , enter 192.168.99.135 under Delete domain security policies and press the Delete button.</span><br><span class="line"># Go to chrome://settings/clearBrowserData,  tick the box Cached images and files and press click the button Clear data.</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import os, io, shutil</span><br><span class="line">import ssl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):</span><br><span class="line"></span><br><span class="line">    def do_GET(self):</span><br><span class="line">        #SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)</span><br><span class="line">        scheme = self.headers.get(&apos;X-Forwarded-Proto&apos;,&apos;&apos;)</span><br><span class="line">        serverip = self.headers.get(&apos;X-Forwarded-Host&apos;,&apos;localhost&apos;)</span><br><span class="line">        port = self.headers.get(&apos;X-Forwarded-Port&apos;,&apos;443&apos;)</span><br><span class="line">        clientip = self.headers.get(&apos;X-Forwarded-For&apos;,&apos;localhost&apos;)</span><br><span class="line">        if scheme == &apos;https&apos;:</span><br><span class="line">            # 301 will redirect with a GET request even if you sent a POST request</span><br><span class="line">            self.send_response(301)</span><br><span class="line">            #url_secure_split = (scheme, &quot;%s:%d&quot; % (serverip, port)) + self.path</span><br><span class="line">            new_url = &apos;%s%s%s%s%s%s&apos; % (scheme, &apos;://&apos;, serverip, &apos;:&apos;, port, self.path)</span><br><span class="line">            self.send_header(&apos;Location&apos;, new_url)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(&quot;redirect url to %s&quot; % (new_url))</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line">        else:</span><br><span class="line">            self.send_response(200)</span><br><span class="line">            #self.send_header(&apos;Content-type&apos;,&apos;text/html&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 8000), MyHandler)</span><br><span class="line">    #httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">    httpd.serve_forever()</span><br><span class="line">except KeyboardInterrupt:</span><br><span class="line">    print(&apos;^C received, shutting down server&apos;)</span><br><span class="line">    httpd.socket.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpHost: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: http</span><br><span class="line">X-Forwsarded-Host: newhost</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpsredirect url to https://localhost:443/Host: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: https</span><br><span class="line">X-Forwsarded-Host: newhost</span><br></pre></td></tr></table></figure>
<h2 id="Appendix-tomcat-container"><a href="#Appendix-tomcat-container" class="headerlink" title="Appendix - tomcat container"></a>Appendix - tomcat container</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;tomcat-deploy.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    port: 8080</span><br><span class="line">  - name: ajp</span><br><span class="line">    targetPort: 8009</span><br><span class="line">    port: 8009</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: tomcat:9.0-jre8-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: ajp</span><br><span class="line">          containerPort: 8009</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f tomcat-deploy.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-tomcat.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat</span><br><span class="line">          servicePort: 8080</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-tomcat.yaml</span><br><span class="line"></span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
<h2 id="Apendix-a-haproxy-example"><a href="#Apendix-a-haproxy-example" class="headerlink" title="Apendix - a haproxy example"></a>Apendix - a haproxy example</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:80</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: http</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: https</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend ssl-in</span><br><span class="line">    mode tcp</span><br><span class="line">    reqirep ^Host: 10.5.0.53:4443 Host: ssltest.quqi.com</span><br><span class="line">    bind :4443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    default_backend tcp-routers</span><br><span class="line"></span><br><span class="line">backend http-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:80 check inter 1000</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:443 check inter 1000</span><br><span class="line"></span><br><span class="line">backend tcp-routers</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:4443 check inter 1000</span><br><span class="line"> reqirep ^Host: external-address:4443 Host: loggregator.internal-address:4443</span><br></pre></td></tr></table></figure>
<p>```</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://ju.outofmemory.cn/entry/359682" target="_blank" rel="external">http://ju.outofmemory.cn/entry/359682</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/05/k8s-http-https-nginx-ingress/" data-id="ck4jppqrj000n88bpxrotlsr2" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenStack开发过程中常用Git操作场景" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/14/OpenStack开发过程中常用Git操作场景/" class="article-date">
  <time datetime="2019-10-14T09:06:30.000Z" itemprop="datePublished">2019-10-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/14/OpenStack开发过程中常用Git操作场景/">OpenStack开发过程中常用Git操作场景</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>  OpenStack开发过程中常用Git操作场景( by quqi99 )</p>
<p>作者：张华  发表于：2013-07-23<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br><a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<pre><code>    Git是一个分布式的代码管理库，linux之父开发，用了三年多了，直观感受的优点如下：

一是真正的分布式，既不用担心哪天服务器坏了代码丢失了，也不用担心像中美之间网速慢啊或断网什么的影响开发，因为本地就是一个代码库。
二是体积小，对存储进行了优化。
三是速度快，因为比较的是哈希。
四是差异比较算法很智能，能到达行级，甚至一行中的列级。
五是支持对二进制的差异比较，如一个Word文档什么的。
六是其它。。。


    虽然对原理也算熟，用得也算多，但一段时间不用还是容易忘，下面记下一些日常工作场景常用到的命令：
</code></pre><p>场景一：如何往社区提交一个Bug<br>      安装git： sudo yum install git git-review<br>     下载代码：git clone <a href="https://github.com/openstack/neutron.git" target="_blank" rel="external">https://github.com/openstack/neutron.git</a></p>
<p>1    通过ssh-keygen命令创建密钥, 然后在“<a href="https://review.openstack.org/#/settings/ssh-keys" target="_blank" rel="external">https://review.openstack.org/#/settings/ssh-keys</a> 界面设置public key.<br>2    运行“git review -s”命令设置git-review, 这步会在.git/config文件中添加一个名为gerrit的远程分支ssh://zhhuabj@review.openstack.org:29418/openstack/neutron.git，并且可以通过ssh访问：ssh -p 29418 review.openstack.org)<br>      如果报“Permission denied (publickey)”这样的错的话，简单运行”ssh-add”命令将ssh key添加到ssh agent即可</p>
<pre><code>还有一种可能是用户弄错了，ssh -i zhhuabj_lcy01.pem ubuntu@162.213.**  -vvv
</code></pre><p>3   如果想要修改一个bug时，先创建一个本地分支,<br>      git checkout -b task/132002<br>4  写完代码之后，也得运行一下pep8测试吧<br>      pep8 –count –repeat –show-source .  或者     ./run_tests.sh -p -N<br>5  或者也运行一下单元测试吧<br>      nosetests -s -v test_backend_sql.py  &amp;&amp; nosetests -s -v test_db_plugin:TestNetworksV2.test_list_shared_networks_with_non_admin_user<br>      或者 python -m testtools.run neutron.tests.unit.test_security_groups_rpc<br>      或者 python setup.py testr –slowest –testr-args=’–subunit  neutron.tests.unit.test_security_groups_rpc’ |  subunit2pyunit<br>      或者 ./run_test.sh -N testtools.run neutron.tests.unit.test_security_groups_rpc<br>6  提交代码到本地库<br>      git add -u (修改的文件）， 若创建了新文件 git add -i<br>      git commit<br>      提交信息的格式一般如下，一般分三段，第一段是标准说清楚你要做什么，如果你在改hyper-v模块最好有hyper-v的字眼，这样大家在收到邮件时只看标题就知道你在做什么了，这很重要；第二段简短描述；第三段一般使用“Fixed bug #161317”，＃号很重要，这样会自动在gerrit上链接到bug上。<br>      Add documentation for upgrading hyperv OpenStack compute node</p>
<pre><code>This guide covers how to upgrade and configure hyperv OpenStack
compute node from Grizzly to Havana

Fixed bug #161317
如果是延用上次提交的信息使用命令：git commit --amend
</code></pre><p>7  本来在git review通过后gerrit会自动rebase到master分支的，但是有冲突的话没人帮你改，所以自己在git review前最好在本地做一个rebase操作，有冲突及时改：<br>      git rebase master  有冲突再解决冲突之后继续执行：git rebase –continue<br>8  提交代码评审<br>      git review 或者 git review master</p>
<pre><code>这时会在gerrit服务器上创建一个本地分支：refs/for/master/task/132002, 如果上面改bug时不建分支的话，这里就变成了: refs/for/master，下一个人提交直接就被冲掉了。
</code></pre><p>9 如果社区上的jenkins出错，确定不是你自己的代码造成的，可以回复“recheck no bug” 触发重新检查，或者”recheck bug ###”</p>
<p>10 说说依赖提交，例如如果一个patch在社区已经被很多人+1了，但这时候有人希望提交一个相关的其他patch, 你当然不想破坏这么多已经+1的成果，所以你会希望再提一个patch但它会依赖前一个patch。注意两点：生成一个新的gerrit评审页是由Change-Id决定的；而是否在一个评审页上产生一个新的change set去破坏+1是由commit id决定的。所以只要保证前一个patch的commit id不变就行了，然后在这个基础上再提交一个patch再git review即可。当然，在git review之前最好先git rebase一下，不然如果本地git rebase的话就会产生一个新的commit id这样同样会产生一个新的change set，不过gerrit还比较智能，那些+1会自动添加上（Automatically re-added by Gerrit trivial rebase detection script.），　一个例子见：<a href="https://review.openstack.org/#/c/51375/" target="_blank" rel="external">https://review.openstack.org/#/c/51375/</a></p>
<p>场景二：如何rebase代码<br>git rebase用于在一个分支中合并另一分支，举个例子，一家公司想要用OpenStack做二次开发的话，<br>在公司内部的git库里创建了三个分支：my-master, my-grizzly, my-havana<br>OpenStack的git库里的分支叫：    github-master, github-grizzly, github-havana<br>现在大家把内部代码都提交在my-havana分支，那么也需要时不时将社区的github-havana的代码rebase合并到my-havana分支中<br>1，首先在.git/config里要有两个remote分支，一个指向内部的版本库，一个指向github的版本库，如.git/config的相应配置如下：<br>[core]<br>        repositoryformatversion = 0<br>        filemode = true<br>        bare = false<br>        logallrefupdates = true<br>[remote “my-origin”]<br>        fetch = +refs/heads/<em>:refs/remotes/my-origin/</em><br>        url = git://<your_ip>/neutron.git<br>[remote “github-origin”]<br>        fetch = +refs/heads/<em>:refs/remotes/github-origin/</em><br>        url = <a href="https://github.com/openstack/neutron.git" target="_blank" rel="external">https://github.com/openstack/neutron.git</a><br>[branch “master”]<br>        remote = my-origin<br>        merge = refs/heads/master<br>[branch “my-havana”]<br>        remote = my-origin<br>        merge = refs/heads/my-havana<br>[branch “my-grizzly”]<br>        remote = my-origin<br>        merge = refs/heads/my-grizzly<br>2, 更新上面所有的remote分支 git remote update<br>3, 因为是要将社区的havana分支的代码同步到自己havana分支，所以为两个远程分支创建对应的本地分支<br>   git checkout -b github-havana github/stable/havana<br>   git checkout -b my-havana origin/my-havana<br>4, 合并，成功后应该用git log -1能看到一个新的合并提交。如果有冲突的话就解决冲突再git merge next<br>   git checkout my-havana<br>   git merget github-havana<br>5, 运行单元测试<br>  tox –recreate -e py27,pep8<br>  ./run_tests.sh -V -f<br>6, 用-n参数(dry-run)测试提交, 提交到名为my-origin的远程分支的my-havana分支中：<br>   git push -n my-origin HEAD:refs/heads/my-havana<br>   若没有问题的话真正提交：<br>   git push  my-origin HEAD:refs/heads/my-havana</your_ip></p>
<p>场景三：cherry pick代码<br>例如，一个社区bug 1161195被提交到master分支, 社区没有批准进stable-havana分支，或者来不及等它进，这时候公司内部要求进my-havana分支的话，可以将这个bug通过cherry pick合并过来。<br>1, 为这个任务创建一个bug.<br>   git checkout stable-havana<br>   git pull<br>   git checkout -b bug/1161195<br>2, 在社区找到bug 1161195的代码提交id, 如:5f3fa391ed499750ad68ad5b000b4e2e0a86978e<br>   可以通过 git log |grep -B 30 <commit-id>查看确认<br>3, 在bug/1161195分支上执行cherry pick命令：<br>   git cherry-pick -s  -x  <commit-id><br>4, 提交代码评审<br>   git commit or git commit –amend<br>   git review stable-havana</commit-id></commit-id></p>
<p>另一个例子：</p>
<p>git clone <a href="https://github.com/openstack/charm-ceilometer" target="_blank" rel="external">https://github.com/openstack/charm-ceilometer</a><br>git checkout stable/16.07 </p>
<h1 id="come-from-lauchpad-page"><a href="#come-from-lauchpad-page" class="headerlink" title="come from lauchpad page"></a>come from lauchpad page</h1><p>git fetch git://git.openstack.org/openstack/charm-ceilometer refs/changes/00/375100/1 &amp;&amp; git cherry-pick FETCH_HEAD</p>
<p>git review stable/18.07</p>
<p>场景四：将git产生的patch变成和svn兼容</p>
<p>#!/bin/sh<br>#</p>
<h1 id="git-svn-diff"><a href="#git-svn-diff" class="headerlink" title="git-svn-diff"></a>git-svn-diff</h1><h1 id="Generate-an-SVN-compatible-diff-against-the-tip-of-the-tracking-branch"><a href="#Generate-an-SVN-compatible-diff-against-the-tip-of-the-tracking-branch" class="headerlink" title="Generate an SVN-compatible diff against the tip of the tracking branch"></a>Generate an SVN-compatible diff against the tip of the tracking branch</h1><p>REV=<code>git svn find-rev $(git rev-list --date-order --max-count=1 master)</code><br>git diff –no-prefix $(git rev-list –date-order –max-count=1 master) $<em> |sed -e “s/^+++ .</em>/&amp; (working copy)/“ \<br>-e “s/^— .<em>/&amp; (revision $REV)/“ \<br>-e “s/^diff –git [^[:space:]]</em>/Index:/“ -e “s/^index.*/===================================================================/“</p>
<p>在本机上创建一个共享的git库：</p>
<p>sudo groupadd git<br>sudo useradd -d /home/git -m -g git git<br>sudo passwd git<br>su - git<br>mkdir /home/git/patent.git<br>cd patent.git/<br>git init –bare –shared</p>
<h1 id="test-in-another-directory"><a href="#test-in-another-directory" class="headerlink" title="test in another directory"></a>test in another directory</h1><p>cd /bak/tmp<br>git clone git@9.123.136.122:/home/git/patent.git<br>cd patent<br>cp test.doc .<br>git add test.doc<br>git commit -m “init commit”<br>git push origin master</p>
<p>这时候肯定是希望大家通过git用户可以访问git库，但又不希望他们通过ssh登录这台机器，所以修改/etc/passwd文件，</p>
<p>将     “  git:x:502:503::/home/git:/bin/bash ”</p>
<p>改成：git:x:502:503::/home/git:/usr/bin/git-shell</p>
<p>这时候还需要将每个客户端的公钥加到/home/git/.ssh/authorized_keys文件里，公钥可以通过ssh-keygen -t rsa生成。</p>
<p>场景五，使用git命令操作bzr与hg</p>
<p>sudo apt-get install mercurial python-hglib<br>wget <a href="https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg" target="_blank" rel="external">https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg</a><br>wget <a href="https://raw.githubusercontent.com/felipec/git-remote-bzr/master/git-remote-bzr" target="_blank" rel="external">https://raw.githubusercontent.com/felipec/git-remote-bzr/master/git-remote-bzr</a><br>sudo chmod 755 ./git-remote-<em><br>sudo mv git-remote-</em> /usr/bin</p>
<p>examples:<br>git clone “bzr::lp:ubuntu/ifupdown”<br>git clone “bzr::lp:debian/ifupdown”<br>git clone “hg::<a href="http://anonscm.debian.org/hg/collab-maint/ifupdown/" target="_blank" rel="external">http://anonscm.debian.org/hg/collab-maint/ifupdown/</a>“</p>
<p>场景六，依赖提交</p>
<p>有一种情况，我向社区同时提交了两个有依赖的提交，在本地提交这两个提交之后直接git review即可。<br>现在前一个提交（假设提交id为：187f）要修改，怎么办呢？<br>a, git rebase 187f^ –interactive， 回到要修改的提交的前一个点上<br>b, 修改那个提交，最后git commit –amend<br>c, git rebase –continue, 继续变基并且返回到原来的HEAD处<br>如果中间出现“interactive rebase already started”， 用“git rebase -i –abort”命令重来。</p>
<p>场景七, 在lp上创建私有git仓库, 并使用lp评审代码</p>
<p>git clone <a href="https://git.launchpad.net/layer-snap" target="_blank" rel="external">https://git.launchpad.net/layer-snap</a></p>
<p>git remote set-url –push origin no_push</p>
<h1 id="注意，这里有一个坑，下面链接不应该有-git，并且layer-snap必须和lp里实际的工程名字相同。"><a href="#注意，这里有一个坑，下面链接不应该有-git，并且layer-snap必须和lp里实际的工程名字相同。" class="headerlink" title="注意，这里有一个坑，下面链接不应该有+git，并且layer-snap必须和lp里实际的工程名字相同。"></a>注意，这里有一个坑，下面链接不应该有+git，并且layer-snap必须和lp里实际的工程名字相同。</h1><p>#如果有+git的话，提交PR时， 原本指定target是<a href="https://git.launchpad.net/layer-snap，" target="_blank" rel="external">https://git.launchpad.net/layer-snap，</a> 但它会自动变回~zhhuabj/+git/layer-snap:master</p>
<p>#并且可能会报这种错误”’~zhhuabj/+git/layer-snap:lp1847574 is not mergeable into layer-snap:master’“</p>
<h1 id="git-remote-add-zhhuabj-git-ssh-zhhuabj-git-launchpad-net-zhhuabj-git-layer-snap"><a href="#git-remote-add-zhhuabj-git-ssh-zhhuabj-git-launchpad-net-zhhuabj-git-layer-snap" class="headerlink" title="git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/+git/layer-snap"></a>git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/+git/layer-snap</h1><p>git remote add zhhuabj git+ssh://zhhuabj@git.launchpad.net/~zhhuabj/layer-snap<br>git push –set-upstream zhhuabj master  #then you will see the new repo in <a href="https://code.launchpad.net/~zhhuabj/+git" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/+git</a></p>
<p>git remote -v<br>git branch -a<br>git fetch –all<br>git fetch –all –prune</p>
<p>#git fetch origin</p>
<p>#git checkout master</p>
<p>#git rebase origin/master</p>
<p>git checkout -b lp1847574<br>git commit -m ‘test’<br>git commit –amend -author=’Hua <xxx.mail.com>‘<br>git push –set-upstream zhhuabj lp1847574</xxx.mail.com></p>
<h1 id="Propose-for-merging-https-code-launchpad-net-zhhuabj-git-layer-snap-ref-lp1847574"><a href="#Propose-for-merging-https-code-launchpad-net-zhhuabj-git-layer-snap-ref-lp1847574" class="headerlink" title="Propose for merging - https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574"></a>Propose for merging - <a href="https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574" target="_blank" rel="external">https://code.launchpad.net/~zhhuabj/+git/layer-snap/+ref/lp1847574</a></h1><h1 id="zhhuabj-git-layer-snap-lp1847574-gt-layer-snap-master"><a href="#zhhuabj-git-layer-snap-lp1847574-gt-layer-snap-master" class="headerlink" title="~zhhuabj/+git/layer-snap:lp1847574 -&gt; layer-snap:master"></a>~zhhuabj/+git/layer-snap:lp1847574 -&gt; layer-snap:master</h1><p>#target repository -&gt; other: ~openstack-charm-testers/xxxstack-bundles/+git/xxxstack-bundles<br>target repository -&gt; other: <a href="https://git.launchpad.net/layer-snap" target="_blank" rel="external">https://git.launchpad.net/layer-snap</a><br>target branch: refs/heads/master</p>
<p>场景八: 内核</p>
<p>git remote add xenial git://kernel.ubuntu.com/ubuntu/ubuntu-xenial.git<br>git fetch xenial<br>git log –no-merges –oneline xenial/hwe…xenial/master drivers/net/ethernet/mellanox/mlx5/</p>
<p>其它命令：</p>
<p>git reset HEAD~1                      撤销最后一次提交。<br>git reset –hard HEAD^             撤销最后一次提交并清除本地修改</p>
<p>git reset –hard Merge_Head  和服务器保持一致</p>
<p>git clean -dfx                               删除本地未在版本库的东西</p>
<p>git stash  &amp; git stash list &amp; git stash pop  暂存代码</p>
<p>git rebase -i –abort </p>
<p>git tag –contains af055e37a91d215d7174d0b84c86795ca81086a7</p>
<p>git branch -a –contains <sha1></sha1></p>
<p>git tag –contains <sha1></sha1></p>
<p>git grep smp_call_function_many</p>
<h1 id="refer-https-www-oreilly-com-library-view-git-pocket-guide-9781449327507-ch09-html"><a href="#refer-https-www-oreilly-com-library-view-git-pocket-guide-9781449327507-ch09-html" class="headerlink" title="refer https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html"></a>refer <a href="https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html" target="_blank" rel="external">https://www.oreilly.com/library/view/git-pocket-guide/9781449327507/ch09.html</a></h1><p>git log v4.13..master –oneline –no-merges kernel/smp.c</p>
<p>git log v4.13..master –grep=smp –oneline –no-merges kernel/smp.c</p>
<p>git log |grep Ibaf4385              一个patch只有一部分，另一部分肯定是被其他patch覆盖了， 可用’git log’查找   </p>
<p>git revert 7b60534</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/14/OpenStack开发过程中常用Git操作场景/" data-id="ck4jppqr5000688bppgv5x28c" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/22/Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently/" class="article-date">
  <time datetime="2019-08-22T03:50:03.000Z" itemprop="datePublished">2019-08-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/22/Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently/">Root Mi note lte with SuperSU without flashing TWRP Recovery permanently</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="作者：张华-发表于：2017-06-23"><a href="#作者：张华-发表于：2017-06-23" class="headerlink" title="作者：张华 发表于：2017-06-23"></a>作者：张华 发表于：2017-06-23</h2><p>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> ) ##</p>
<p>I have two Meizu MX4 ubuntu cellphones, now I will re-install Flyme or native google android on them. All softwares can be downloaded from the link: <a href="https://pan.baidu.com/s/1bpo0xbx" target="_blank" rel="external">https://pan.baidu.com/s/1bpo0xbx</a></p>
<p>1, Start MX4 Ubuntu, and enable ‘Developer Mode’ from ‘System Setting -&gt; About Cellphone’ menu.</p>
<p>2, Install the tools adb and fastboot from the link <a href="http://esausilva.com/wp-content/plugins/cimy-counter/cc_redirect.php?cc=platform-tools-linux&amp;fn=http://esausilva.com/misc/android/platform-tools-linux.tar.gz" target="_blank" rel="external">http://esausilva.com/wp-content/plugins/cimy-counter/cc_redirect.php?cc=platform-tools-linux&amp;fn=http://esausilva.com/misc/android/platform-tools-linux.tar.gz</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/bak/java/platform-tools:$PATH</span><br></pre></td></tr></table></figure>
<p>3, Make sure your cellphone can connect to compute (Ubuntu) via USB and adb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo lsusb |grep Meizu</span><br><span class="line">  Bus 003 Device 010: ID 2a45:0c02 Meizu Corp. MX Phone (MTP &amp; ADB)</span><br><span class="line">$ cat /etc/udev/rules.d/51-android.rules</span><br><span class="line">  SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;2a45&quot;, MODE=&quot;0666&quot;, SYMLINK+=&quot;android_adb&quot;</span><br><span class="line">$ cat ~/.android/adb_usb.ini</span><br><span class="line">  2a45</span><br><span class="line">$ sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</span><br><span class="line">$ adb kill-server &amp;&amp; adb start-server</span><br><span class="line">$ adb devices</span><br><span class="line">  List of devices attached</span><br><span class="line">  75HABLMCYUR3	device</span><br><span class="line">$ sudo apt-get install go-mtpfs mtp-tools gmtp</span><br><span class="line">$ sudo mtp-detect</span><br><span class="line">  libmtp version: 1.1.10</span><br><span class="line">  Listing raw device(s)</span><br><span class="line">  Device 0 (VID=2a45 and PID=0c02) is a Meizu MX Phone (MTP+ADB).</span><br><span class="line">  Found 1 device(s):</span><br><span class="line">  Meizu: MX Phone (MTP+ADB) (2a45:0c02) @ bus 3, dev 10</span><br></pre></td></tr></table></figure>
<p>4, Brush the thirty party recovery. Shutdown your cellphone, and press POWER + VOL-DOWN to enter fastboot mode. Use usb to connect cellphone and compute, than run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hua@node1:/bak/tools/mx4 $ fastboot flash recovery recovery.img</span><br><span class="line">sending &apos;recovery&apos; (10000 KB)...</span><br><span class="line">OKAY [  0.506s]</span><br><span class="line">writing &apos;recovery&apos;...</span><br><span class="line">OKAY [  0.410s]</span><br><span class="line">finished. total time: 0.916s</span><br></pre></td></tr></table></figure></p>
<p>5, Press POWER + VOL-UP to enter above recoerty, and Click ‘Install Zip -&gt; Install zip from sideload’, then run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hua@node1:/bak/java/platform-tools$ adb sideload update.zip</span><br><span class="line">sending: &apos;sideload&apos;  100%</span><br></pre></td></tr></table></figure>
<p>NOTE: if you want to install raw google android, just run ‘adb sideload cm-13.0-20160820-UNOFFICIAL-mx4.zip’ instead.</p>
<p>6, Reboot the cellphone. OK.</p>
<h2 id="附录-小米手机线刷开发版-国际版"><a href="#附录-小米手机线刷开发版-国际版" class="headerlink" title="附录 - 小米手机线刷开发版/国际版"></a>附录 - 小米手机线刷开发版/国际版</h2><p>现在, 小米不再允许行货和国际版互刷ROM, 它加入了防回滚保护（Anti-Rollback Protection）机制. 这意味着，如果手机当前处于较高的MIUI版本，降级刷机大概率会变砖。实测发现，行货机刷国际版ROM将卡死在Recovery界面，显示“this MIUI version can’t be installed on this device”。当然，想要绕过官方的限制也有办法，前提是解锁bootloader，然后用TWRP、fastboot或者MiFlash刷机。使用MiFlash时切记勾选“Clean All”，不要选“clean all and lock”。如果你不幸刷在国际版和国行版ROM之间刷机成砖，只有进入EDL（紧急下载）模式自救。然而，EDL模式仅对极为有限的小米账号开放权限。本文测试的手机是mi note lte不再之列.</p>
<p>1, 下载dev rom是virgo_images_5.12.4_20151126.0000.5_4.4_cn_eb14b0eb8d.tgz (<a href="http://pan.baidu.com/s/1bfGxVg" target="_blank" rel="external">http://pan.baidu.com/s/1bfGxVg</a>). rom里的内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ls virgo_images_5.12.4_20151126.0000.5_4.4_cn</span><br><span class="line">flash_all.bat  flash_all_except_data_storage.bat  flash_all_except_data_storage.sh  flash_all_except_storage.bat  flash_all_except_storage.sh  flash_all.sh  images  misc.txt</span><br><span class="line">$ ls virgo_images_5.12.4_20151126.0000.5_4.4_cn/images/</span><br><span class="line">8974_msimage.mbn  cache.img  emmc_appsboot.mbn  gpt_backup0.bin  gpt_main0.bin  MPRG8974.mbn  patch0.xml   rawprogram0.xml  rpm.mbn   sdi.mbn     tz.mbn</span><br><span class="line">boot.img          dummy.img  flash.xml          gpt_both0.bin    misc.img       NON-HLOS.bin  persist.img  recovery.img     sbl1.mbn  system.img  userdata.img</span><br><span class="line"></span><br><span class="line">$ cat flash_all.sh</span><br><span class="line">fastboot $* getvar product 2&gt;&amp;1 | grep &quot;^product: *MSM8974$&quot;</span><br><span class="line">if [ $? -ne 0 ] ; then echo &quot;Missmatching image and device&quot;; exit 1; fi</span><br><span class="line">fastboot $* getvar board_version 2&gt;&amp;1 | grep &quot;^board_version: *5.[^5]&quot;</span><br><span class="line">if [ $? -ne 0 ] ; then echo &quot;Missmatching board version&quot;; exit 1; fi</span><br><span class="line"></span><br><span class="line">fastboot $* flash tz `dirname $0`/images/tz.mbn</span><br><span class="line">fastboot $* flash dbi `dirname $0`/images/sdi.mbn</span><br><span class="line">fastboot $* flash sbl1 `dirname $0`/images/sbl1.mbn</span><br><span class="line">fastboot $* flash rpm `dirname $0`/images/rpm.mbn</span><br><span class="line">fastboot $* flash aboot `dirname $0`/images/emmc_appsboot.mbn</span><br><span class="line">fastboot $* erase boot</span><br><span class="line">fastboot $* erase DDR</span><br><span class="line">fastboot $* flash misc `dirname $0`/images/misc.img</span><br><span class="line">fastboot $* flash modem+modem1 `dirname $0`/images/NON-HLOS.bin</span><br><span class="line">fastboot $* flash system+system1 `dirname $0`/images/system.img</span><br><span class="line">fastboot $* flash cache `dirname $0`/images/cache.img</span><br><span class="line">fastboot $* flash userdata `dirname $0`/images/userdata.img</span><br><span class="line">fastboot $* flash recovery `dirname $0`/images/recovery.img</span><br><span class="line">fastboot $* flash boot+boot1 `dirname $0`/images/boot.img</span><br><span class="line">fastboot $* reboot</span><br></pre></td></tr></table></figure></p>
<p>2, 手机通过MTP模式连接电脑, 通过lsusb找到设备号为: Bus 003 Device 029: ID 2717:0360<br>3, adb连接手机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># sudo apt-get install android-tools-adb android-tools-fastboot</span><br><span class="line">$ cat /etc/udev/rules.d/51-android.rules</span><br><span class="line">SUBSYSTEM==&quot;usb&quot;, ATTR&#123;idVendor&#125;==&quot;2717&quot;, MODE=&quot;0666&quot;, SYMLINK+=&quot;android_adb&quot;</span><br><span class="line">sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</span><br><span class="line">adb kill-server &amp;&amp; adb start-server</span><br><span class="line">sudo mtp-detect</span><br><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">d6b38a3a	device</span><br></pre></td></tr></table></figure></p>
<p>如果不出来, 是需要 狂按”设置我的设备 -&gt; 全部参数 -&gt; MINU版本”进入开发者模式, 然后”设置 -&gt; 更多设置 -&gt; 开发者选项”打开USB调试”和”FASTBOOT刷机模式”<br>4, 和Meizu是一样的, 也是音量下+电源键进入fastboot模式, 不连电脑，音量下+电源键长按进入fastboot,USB线连接电脑. 注: 同样, 也是音量上+电源键可安装第三方recovery, 见 [5].<br>5, 刷机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x flash_all.sh</span><br><span class="line">./flash_all.sh</span><br><span class="line">#./flash_all_except_storage.sh  #clean cache, but not clean data</span><br></pre></td></tr></table></figure></p>
<p>6, 继续root, 刷机成功之后, 已经是开发版, 进入手机，安全中心 -&gt; 授权管理 -&gt; ROOT,反复确认后，手机会下载对应的ROOT包安装后重启。机后，安全中心 -&gt; 授权管理已经可以进入. 这时候就可以使用’adb root’了.</p>
<p>注: 遗憾地是, 机子刚好音量下键损坏, 这样借助如刷机精灵里的实用工具进入fastboot或recovery模式. 好吧, 又得整到windows上了. 照着文档[4]. (注: 其实不用转到windows, 直接在linux下使用”adb reboot bootloader”也可以重启至fastboot模式”<br>1, 安装小米助手, 当手机连上win7电脑时会自动安装驱动 - <a href="http://zhushou.xiaomi.com/" target="_blank" rel="external">http://zhushou.xiaomi.com/</a><br>2, 安装线刷工具 - <a href="http://bigota.d.miui.com/tools/MiPhone20141107.exe" target="_blank" rel="external">http://bigota.d.miui.com/tools/MiPhone20141107.exe</a><br>3, 线刷包解压 - <a href="http://pan.baidu.com/s/1bfGxVg" target="_blank" rel="external">http://pan.baidu.com/s/1bfGxVg</a><br>4, 安装刷机精灵, 使用里面的fastboot实用工具根本无法进入fastboot, 所以直接采用刷机精灵的一键刷机功能上传线刷包线刷. 但出错了, 说是刷入的版本比机子已有的版本低会线刷失败.<br>5, 但上一步一键刷机功能代替音量减键成功让手机进入了fastboot模式, 所以此时切换成小米的刷机工具再试, 结果小米的刷机工具也有bug, 报找不到远程分区.<br>6, 试图找到小米原生的线刷包恢复, 但官网上找不着.<br>7, 还好, 手机进入fastboot模式之后, 没有刷机成功, 只要手机还有电, 再重启还是进入的是flashboot模式, 这样避免了坏的音量键及进不了系统. 继续找啊找试啊试, 终于发现这个包是好的(Xiaomi_Mi_Note_LTE_V9.5.1.0.MXEMIFA_20180406.0000.00_Global_6.0_XFT.zip, <a href="https://firmwarefile.com/xiaomi-mi-note-lte" target="_blank" rel="external">https://firmwarefile.com/xiaomi-mi-note-lte</a> )<br>8, 这个网站(<a href="https://xiaomiflashtool.com/)下载的最新的xiaomiflashtool反而不行说找不着设备" target="_blank" rel="external">https://xiaomiflashtool.com/)下载的最新的xiaomiflashtool反而不行说找不着设备</a>. 注: 这个tool也可在driver菜单自动安装驱动.<br>9, 这样成功换上了Xiaomi_Mi_Note_LTE_V9.5.1.0.MXEMIFA_20180406.0000.00_Global_6.0_XFT.zip, 这似乎是国际稳定版哦.</p>
<p>如何将国际稳定版转成国际开发版呢? 再线刷一遍. 这次都在linux下进行.<br>1,Install Global Developer ROM for Redmi Note 4G<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># search in google by &apos;eveloper bigota.d.miui.com redmi note 4g -stable&apos;, and download fastboot rom - https://c.mi.com/thread-510369-1-0.html</span><br><span class="line">#NOTE: this recovery - http://bigota.d.miui.com/7.11.6/miui_MINoteGlobal_7.11.6_ce58816710_6.0.zip</span><br><span class="line">wget http://bigota.d.miui.com/7.11.6/virgo_global_images_7.11.6_20171106.0000.00_6.0_global_be457b58a3.tgz</span><br><span class="line">tar -xf virgo_global_images_7.11.6_20171106.0000.00_6.0_global_be457b58a3.tgz</span><br><span class="line">cd virgo_global_images_7.11.6_20171106.0000.00_6.0_global</span><br><span class="line">adb reboot bootloader</span><br><span class="line">chmod +x flash_all.sh</span><br><span class="line">./flash_all.sh</span><br><span class="line">运行./flash_all.sh相当于:</span><br><span class="line">#https://blog.csdn.net/quqi99/article/details/51636869</span><br><span class="line">fastboot flash boot boot.img</span><br><span class="line">fastboot flash recovery recovery.img</span><br><span class="line">fastboot erase system</span><br><span class="line">fastboot flash system system.img</span><br><span class="line">#fastboot flash userdata userdata.img</span><br><span class="line">#fastboot flash cache cache.img</span><br></pre></td></tr></table></figure></p>
<p>2, Custom TWRP for Xiaomi Redmi Note 4G (twrp-3.3.1-0-dior.img - <a href="https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html" target="_blank" rel="external">https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html</a>),<br>注: 目前小米也关闭了解锁功能(<a href="https://www.miui.com/unlock/index.html)不允许行货和国际版互刷ROM" target="_blank" rel="external">https://www.miui.com/unlock/index.html)不允许行货和国际版互刷ROM</a>, 小米增加了一段区域对照码, 想绕开限制, 只有先不互刷先解锁(即国行版先刷国内ROM骗过解锁), 然后再用TWRP, fastboot或mifalsh刷机.<br>但mi note lte无须解锁, 因为’fastboot oem device-info’显示’Device unloced: true”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adb reboot bootloader</span><br><span class="line">$ fastboot oem device-info</span><br><span class="line">...</span><br><span class="line">(bootloader) 	Device tampered: true</span><br><span class="line">(bootloader) 	Device unlocked: true</span><br><span class="line">(bootloader) 	Charger screen enabled: false</span><br><span class="line">(bootloader) 	Display panel:</span><br><span class="line">OKAY [  0.006s]</span><br><span class="line">finished. total time: 0.006s</span><br></pre></td></tr></table></figure></p>
<p>继续刷TWRP:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.twrp.me/dior/twrp-3.3.1-0-dior.img</span><br><span class="line">adb reboot bootloader              #enter fastboot mode</span><br><span class="line">#fastboot devices                     #just for case when locking BL lock</span><br><span class="line"># fastboot flash unlock unlock.key  #if need to unlock, eg https://www.techmesto.com/guide-unlock-bootloader-nokia-android-phones/</span><br><span class="line">#fastboot oem unlock</span><br><span class="line">fastboot flash recovery twrp-3.3.1-0-dior.img</span><br><span class="line">fastboot reboot</span><br></pre></td></tr></table></figure></p>
<p>但是上面刷了之后不work,, 刷了TWRP之后’adb reboot recovery’进入的还是Mi-Recovery 2.0.1模式, 官网说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://twrp.me/xiaomi/xiaomiredminote4gsinglesim.html</span><br><span class="line">Note many devices will replace your custom recovery automatically during first boot. To prevent this, use Google to find the proper key combo to enter recovery. After typing fastboot reboot, hold the key combo and boot to TWRP. Once TWRP is booted, TWRP will patch the stock ROM to prevent the stock ROM from replacing TWRP. If you don&apos;t follow this step, you will have to repeat the install.</span><br></pre></td></tr></table></figure></p>
<p>但运行完’fastboot reboot’再按音量上键+电源键根本就进不了recovery模式, 可能是我的音量键有问题的原因吧. 此路不通.这个网页说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.reddit.com/r/Xiaomi/comments/bdurg8/replace_mi_recovery_with_twrp/</span><br><span class="line">With the new protection you need to boot from adb to twrp, by fastboot boot twrp.img. When boot in twrp transfer the image and flash inside from twrp. Now, it will reboot on TWRP recovery.</span><br></pre></td></tr></table></figure></p>
<p>所以我们可以先’fastboot boot’来启动TWRP, 再将TWRP持久化. 但是试了很多多twrp版本都报下列错”dtb not found”.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ fastboot boot twrp-3.3.1-0-dior.img</span><br><span class="line">downloading &apos;boot.img&apos;...</span><br><span class="line">OKAY [  0.433s]</span><br><span class="line">booting...</span><br><span class="line">FAILED (remote: dtb not found)</span><br><span class="line">finished. total time: 0.449s</span><br></pre></td></tr></table></figure></p>
<p>无奈下载网页(<a href="http://en.miui.com/thread-213264-1-1.html" target="_blank" rel="external">http://en.miui.com/thread-213264-1-1.html</a>) 或这个网页(<a href="http://en.miui.com/thread-628692-1-1.html)上提到的twrp均可成功" target="_blank" rel="external">http://en.miui.com/thread-628692-1-1.html)上提到的twrp均可成功</a>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot boot twrp.img</span><br></pre></td></tr></table></figure></p>
<p>但语言却不是英语看不懂啊, 没办法, 只好在网上找一个有图的, 照着大致的位置点了.<br><img src="https://img-blog.csdnimg.cn/20190822112723313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly96aGh1YWJqLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190822112742744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly96aGh1YWJqLmJsb2cuY3Nkbi5uZXQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上面需要事先将supersu下载放到手机上, 注意: 只有/sdcard/Download是可写的. (其他目录需要root权限运行”adb remount  #mount -o remount,rw /system”才行”.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push SR5-SuperSU-v2.82-SR5-20171001224502.zip /sdcard/Download/</span><br></pre></td></tr></table></figure>
<p>这样就完成了在不替换现有的mi-recovery的情况下同时又使用TWRP安装supersu, 可参考 - <a href="https://in.c.mi.com/thread-79402-1-1.html" target="_blank" rel="external">https://in.c.mi.com/thread-79402-1-1.html</a></p>
<p>3, 可选  - 本来正常情况TWRP能直接flash的话, 应该可以这样安装supersu的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reboot recovery        #enter recovery mode</span><br><span class="line">adb sideload adb sideload SR5-SuperSU-v2.82-SR5-20171001224502.zip</span><br></pre></td></tr></table></figure></p>
<p>4, 安装必要的软件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># use adb via wifi</span><br><span class="line">/su/bin/su root</span><br><span class="line">setprop service.adb.tcp.port 5555</span><br><span class="line">setprop persist.adb.tcp.port 5555</span><br><span class="line">start adbd</span><br><span class="line">adb connect 192.168.99.249:5555</span><br><span class="line">adb install Complete\ Linux\ Installer_v3.0\ BETA_apkpure.com.apk</span><br><span class="line"></span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line"></span><br><span class="line"># grep &apos;system&apos; /proc/mounts</span><br><span class="line">mount -o rw,remount -t ext4 /dev/block/platform/msm_sdcc.1/by-name/system /system</span><br><span class="line"></span><br><span class="line"># ssh server -  by install SSHDroid and use supersu to give it root</span><br><span class="line"></span><br><span class="line"># ssh client</span><br><span class="line">ln -s /data/data/berserker.android.apps.sshdroid/dropbear/ssh /system/bin/ssh</span><br><span class="line">chmod o+rx /system/bin/ssh</span><br><span class="line"></span><br><span class="line"># key</span><br><span class="line">cd /data/data/berserker.android.apps.sshdroid/dropbear/</span><br><span class="line">./dropbearkey -t rsa -f ../home/.ssh/id_rsa &gt; ../home/.ssh/id_rsa.pub</span><br><span class="line">cd /data/data/berserker.android.apps.sshdroid/home</span><br><span class="line">echo &apos;ssh hua@t440p -i ~/.ssh/id_rsa&apos; &gt; ./ssht440p.sh</span><br><span class="line">sh ssht440p.sh</span><br><span class="line"></span><br><span class="line"># use vi in adb shell, we don&apos;t need to add busybox prefix in ssh</span><br><span class="line">busybox vi /etc/hosts</span><br></pre></td></tr></table></figure></p>
<p>5, run ubuntu 18.04 on android by using linuxdeploy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#run ubuntu 18.04 on android by using linuxdeploy</span><br><span class="line">#https://www.maketecheasier.com/install-ubuntu-on-android-linux-deploy/</span><br><span class="line">wget https://github.com/meefik/busybox/releases/download/1.30.1/busybox-1.30.1-41.apk</span><br><span class="line">adb install busybox-1.30.1-41.apk  #install into /system/xbin</span><br><span class="line">wget https://github.com/meefik/linuxdeploy/releases/download/2.4.0/linuxdeploy-2.4.0-251.apk</span><br><span class="line">adb install linuxdeploy-2.4.0-251.apk</span><br><span class="line">adb install vnc_viewer_remote_desktop.apk</span><br><span class="line"></span><br><span class="line">#enter linuxdeploy</span><br><span class="line">telnet 192.168.99.249 5023</span><br><span class="line"></span><br><span class="line">#but hit the error: chroot: can&apos;t execute &apos;/bin/su&apos;: No such file or directory</span><br><span class="line">/su/bin/su root</span><br><span class="line">/data/user/0/ru.meefik.linuxdeploy/files/bin/linuxdeploy shell</span><br><span class="line">mkdir /data/local/mnt/&#123;dev,sys,proc&#125;</span><br><span class="line">#for d in dev sys proc; do mount -o bind /$d /data/local/mnt/$d; done</span><br><span class="line">#umount /data/local/mnt/&#123;dev,proc,sys&#125;</span><br><span class="line">chroot /data/local/mnt/ /bin/pwd</span><br><span class="line">ls /data/local/mnt/bin/su</span><br><span class="line"></span><br><span class="line">上面的chroot错误实际上是image文件没有创建的原因</span><br><span class="line">ls /data/data/ru.meefik.linuxdeploy/files/config/linux.conf</span><br><span class="line">rm -rf /sdcard/linux.img</span><br><span class="line">vi /data/user/0/ru.meefik.linuxdeploy/files/include/bootstrap/rootfs/deploy.sh</span><br><span class="line"></span><br><span class="line">20191012更新</span><br><span class="line">架构使用armhf，源使用http://mirrors.ustc.edu.cn/ubuntu-ports/时可以进入debootstrap了， 但是在lsb_base这步总是出错， 怀疑是科大的源有问题， 所以换成腾讯的源https://mirrors.cloud.tencent.com/ubuntu-ports/后可以debootstrap成功， 但是在chroot /data/local/mnt bin/su - root -c &apos;DEBIAN_FRONTEND=nointeractive apt-get install -yfq --no-install-recommends dbus&apos;这步也是相当地慢(才0.10k/s)，不得已， 又退回使用http://ports.ubuntu.com/ubuntu-ports/， 然后就成功了， 在手机上通过‘ssh ubuntu@localhost’登录bionic。</span><br><span class="line">1, 但ubuntu里的chrome仍然无法在外面使用，而使用android版本的chrome又无法打开SF, 试试microsoft edge</span><br><span class="line">2, 下面adb或者ssh两种方式连接手机</span><br><span class="line">/su/bin/su root</span><br><span class="line">setprop service.adb.tcp.port 5555</span><br><span class="line">setprop persist.adb.tcp.port 5555</span><br><span class="line">start adbd</span><br><span class="line">adb connect 192.168.99.249:5555</span><br><span class="line">adb devices</span><br><span class="line">3, 手机外接大屏幕的话，采用android中的”无线投屏&quot;或者在连接好adb之后运行“sudo snap install --channel=edge scrcpy &amp;&amp; scrcpy&quot;</span><br></pre></td></tr></table></figure></p>
<p>[1] <a href="https://news.mydrivers.com/1/596/596856.htm" target="_blank" rel="external">https://news.mydrivers.com/1/596/596856.htm</a><br>[2] <a href="http://en.miui.com/thread-140154-1-1.html" target="_blank" rel="external">http://en.miui.com/thread-140154-1-1.html</a><br>[3] <a href="http://www.miui.com/thread-9286730-1-1.html" target="_blank" rel="external">http://www.miui.com/thread-9286730-1-1.html</a><br>[4] <a href="https://mrxn.net/other/xiaominote-shuaji.html" target="_blank" rel="external">https://mrxn.net/other/xiaominote-shuaji.html</a><br>[5] <a href="http://en.miui.com/forum.php?mod=viewthread&amp;tid=279802" target="_blank" rel="external">http://en.miui.com/forum.php?mod=viewthread&amp;tid=279802</a><br>[6] <a href="http://www.miui.com/thread-9286730-1-1.html" target="_blank" rel="external">http://www.miui.com/thread-9286730-1-1.html</a><br>[7] <a href="https://www.getdroidtips.com/custom-rom-redmi-note-4g/" target="_blank" rel="external">https://www.getdroidtips.com/custom-rom-redmi-note-4g/</a><br>[8] <a href="https://www.getdroidtips.com/official-twrp-recovery-for-xiaomi-redmi-note-4g/" target="_blank" rel="external">https://www.getdroidtips.com/official-twrp-recovery-for-xiaomi-redmi-note-4g/</a><br>[9] <a href="https://mi-globe.com/miui-firmware-rom-builder/" target="_blank" rel="external">https://mi-globe.com/miui-firmware-rom-builder/</a><br>[10] <a href="https://xiaomi.eu/community/threads/9-8-15.51822/" target="_blank" rel="external">https://xiaomi.eu/community/threads/9-8-15.51822/</a><br>[11] <a href="https://aubykhan.wordpress.com/2013/07/21/android-tip-boot-into-twrp-or-cwm-recovery-without-flashing/" target="_blank" rel="external">https://aubykhan.wordpress.com/2013/07/21/android-tip-boot-into-twrp-or-cwm-recovery-without-flashing/</a><br>[11] <a href="https://qc5.androidfilehost.com/dl/hhcuqmQO_jb6GzZK8aDvbw/1566669181/24421527759888026/TWRP_virgo.zip" target="_blank" rel="external">https://qc5.androidfilehost.com/dl/hhcuqmQO_jb6GzZK8aDvbw/1566669181/24421527759888026/TWRP_virgo.zip</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/22/Root-Mi-note-lte-with-SuperSU-without-flashing-TWRP-Recovery-permanently/" data-id="ck4jppqrf000h88bp7bvky6xr" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-如何让OpenStack支持多个FIP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/24/如何让OpenStack支持多个FIP/" class="article-date">
  <time datetime="2019-04-24T12:24:20.000Z" itemprop="datePublished">2019-04-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/24/如何让OpenStack支持多个FIP/">如何让OpenStack支持多个FIP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2019-04-24)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>OpenStack可以支持多个公网IP吗?<br>OpenStack CLI不支持将同一个子网的多个FIPs分配给同一个fixed_ip的接口. 最简单的方法是直接分配FIP后手工配置在qrouter-xxx上, 并且手工做DNAT/SNAT. 但还有其他更好的方法吗?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be ip addr add 10.5.150.15 dev qg-60d62ebb-47</span><br><span class="line"></span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-OUTPUT -d 10.5.150.15/32 -j DNAT --to-destination 192.168.22.53</span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-PREROUTING -d 10.5.150.15/32 -j DNAT --to-destination 192.168.22.53</span><br><span class="line">sudo ip netns exec qrouter-9843a7c4-f1e7-4ea0-b031-c1a0428795be iptables -t nat -A neutron-l3-agent-float-snat -s 192.168.22.53/32 -j SNAT --to-source 10.5.150.15</span><br><span class="line"></span><br><span class="line">ubuntu@juju-54f223-pike-5:~$ ping 10.5.150.15</span><br><span class="line">PING 10.5.150.15 (10.5.150.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.15: icmp_seq=1 ttl=63 time=3.25 ms</span><br></pre></td></tr></table></figure>
<h2 id="创建多个tenant子网"><a href="#创建多个tenant子网" class="headerlink" title="创建多个tenant子网"></a>创建多个tenant子网</h2><p>创建多个tenant子网(fixed_ip), 将这些子网分配给VM, 然后再将多个FIP分别和这些tenant port关联. 结果是虚机内部多个网卡造成了不对称路由问题, 引入policy route之后解决了outbound的问题, 但仍然无法解决inbound的问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">step 1, created a test VM with the network private (192.168.21.0/24) and a fix_ip 192.168.21.5 and a FIP 10.5.150.2</span><br><span class="line"></span><br><span class="line">openstack server create --wait --image bionic --flavor m1.small --key-name mykey --nic net-id=e4074ac4-3c48-41f2-81e2-5a798468bf88 --min 1 --max 1 test</span><br><span class="line">fix_ip=&quot;192.168.21.5&quot;</span><br><span class="line">public_network=$(openstack network show ext_net -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $public_network -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address $fix_ip --port $(openstack port list --fixed-ip ip-address=$fix_ip -c id -f value)</span><br><span class="line"></span><br><span class="line">step 2, created another network private2 (192.168.22.0/24) and attach another interface into the test VM, then allocated a FIP (192.168.22.53) for it (192.168.22.51)</span><br><span class="line"></span><br><span class="line">openstack network create private2</span><br><span class="line">openstack subnet create --subnet-range 192.168.22.0/24 --network private2 --allocation-pool start=192.168.22.50,end=192.168.22.100 --gateway 192.168.22.1 priavte2-subnet</span><br><span class="line">openstack router add subnet provider-router priavte2-subnet</span><br><span class="line">nova interface-attach $(openstack server list -f value |awk &apos;/test/ &#123;print $1&#125;&apos;) --net-id=$(openstack network list -f value |awk &apos;/private2/ &#123;print $1&#125;&apos;)</span><br><span class="line">ssh ubuntu@10.5.150.2 -- sudo ifconfig ens5 up</span><br><span class="line"># then connection is disconnect because the default route moves from ens2 to ens5</span><br><span class="line">ssh ubuntu@10.5.150.2 -- dhcpclient ens5</span><br><span class="line"></span><br><span class="line">Finally it looks like - https://paste.ubuntu.com/p/yMJpJXYqDY/</span><br><span class="line"></span><br><span class="line">step 3, now the default gw is in ens5 so we can ping external inside test VM</span><br><span class="line"></span><br><span class="line">root@test:~# ping -I ens2 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.21.5 ens2: 56(84) bytes of data.</span><br><span class="line">root@test:~# ping -I ens5 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.22.53 ens5: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=3.34 ms</span><br><span class="line"></span><br><span class="line">step 4, outbound traffic works after adding policy router rules.</span><br><span class="line"></span><br><span class="line">echo &quot;1 t21&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip route add 192.168.21.0/24 dev ens2 src 192.168.21.5 table t21</span><br><span class="line">ip route add default via 192.168.21.5 dev ens2 table t21</span><br><span class="line">ip rule add from 192.168.21.5/24 table t21</span><br><span class="line"></span><br><span class="line">root@test:~# ping -I ens2 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.21.5 ens2: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=6.28 ms</span><br><span class="line">root@test:~# ping -I ens5 10.230.65.38</span><br><span class="line">PING 10.230.65.38 (10.230.65.38) from 192.168.22.53 ens5: 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.230.65.38: icmp_seq=1 ttl=62 time=4.90 ms</span><br><span class="line"></span><br><span class="line">step 5, but inbound traffic for two FIPs can&apos;t work at the same time</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping -c 1 10.5.150.2</span><br><span class="line">PING 10.5.150.2 (10.5.150.2) 56(84) bytes of data.</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping -c 1 10.5.150.8</span><br><span class="line">PING 10.5.150.8 (10.5.150.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.8: icmp_seq=1 ttl=63 time=3.41 ms</span><br></pre></td></tr></table></figure></p>
<h2 id="创建多个FIP子网"><a href="#创建多个FIP子网" class="headerlink" title="创建多个FIP子网"></a>创建多个FIP子网</h2><p>创建多个外部网络的方法也不可行, 因为多个外部网络意味着多个router, 但无法将一个tenant subnet添加到多个routers中去:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ neutron router-interface-add provider-router2 private_subnet</span><br><span class="line">IP address 192.168.21.1 already allocated in subnet ada0b5b0-6780-4131-b07b-cee7069eab8d</span><br><span class="line">Neutron server returns request_ids: [&apos;req-8110ac5c-94ca-4b15-bf72-e199b635aa6f&apos;]</span><br></pre></td></tr></table></figure></p>
<p>这样在为一个port关联多个FIPs时报下列错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ neutron floatingip-associate $(neutron floatingip-list |grep $fip2 |awk &apos;&#123;print $2&#125;&apos;) $(neutron port-list |grep $fix_ip |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">External network 30769889-a664-4d99-8035-047773d2031c is not reachable from subnet ada0b5b0-6780-4131-b07b-cee7069eab8d.  Therefore, cannot associate Port 7e8d017b-8e1d-4f8f-98cd-9de3fe52c687 with a Floating IP.</span><br><span class="line">Neutron server returns request_ids: [&apos;req-76951e0d-aff8-4106-826c-72d99fe03c2d&apos;]</span><br></pre></td></tr></table></figure></p>
<p>具体测试方法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Created another FIP network for test</span><br><span class="line"></span><br><span class="line"># first provides the physical network in the underlying OpenStack of sts-stack</span><br><span class="line">source ~/novarc</span><br><span class="line">openstack router create zhhuabj_router2</span><br><span class="line">openstack network create --disable-port-security zhhuabj_admin_net2</span><br><span class="line">openstack subnet create --subnet-range 10.10.0.0/24 --network zhhuabj_admin_net2 --allocation-pool start=10.10.0.50,end=10.10.0.100 --gateway 10.10.0.1 zhhuabj_admin_net2_subnet</span><br><span class="line">openstack router add subnet zhhuabj_router2 zhhuabj_admin_net2</span><br><span class="line">openstack router set --external-gateway zhhuabj_admin_net2 zhhuabj_router2</span><br><span class="line"></span><br><span class="line"># For convenience of management, add a ip address from this network into bastion</span><br><span class="line">source ~/novarc</span><br><span class="line">nova interface-attach $(nova list |grep zhhuabj-bastion |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">sudo ip addr add 10.10.0.58/24 dev ens9</span><br><span class="line">sudo ip link set dev ens9 up</span><br><span class="line"></span><br><span class="line"># then defines the flat provider network in the upper OpenStack of sts-stack</span><br><span class="line">juju deploy ./b/openstack.yaml</span><br><span class="line">./configre</span><br><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh neutron-gateway/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ovs-vsctl add-br br-data2</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ovs-vsctl add-port br-data2 ens7</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo ifconfig ens7 up</span><br><span class="line">juju config neutron-gateway bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-gateway data-port=&quot;br-data:fa:16:3e:45:fc:23 br-data2:ens7&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br><span class="line">juju ssh neutron-gateway/0 -- sudo systemctl restart neutron-openvswitch-agent.service</span><br><span class="line"></span><br><span class="line">source stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create --shared --router:external --provider:network_type flat --provider:physical_network physnet2 ext_net2</span><br><span class="line">neutron subnet-create --name ext_net2_subnet --gateway 10.10.0.1 --allocation-pool start=10.10.0.60,end=10.10.0.70 --disable-dhcp ext_net2 10.10.0.0/24</span><br><span class="line">neutron router-create provider-router2</span><br><span class="line">neutron router-gateway-set provider-router2 ext_net2</span><br><span class="line"># OpenStack doesn&apos;t support add the same subnet into multiple routers</span><br><span class="line"># neutron router-interface-add provider-router2 private_subnet</span><br><span class="line"></span><br><span class="line">ubuntu@zhhuabj-bastion:~$ neutron router-interface-add provider-router2 private_subnet</span><br><span class="line">IP address 192.168.21.1 already allocated in subnet ada0b5b0-6780-4131-b07b-cee7069eab8d</span><br><span class="line">Neutron server returns request_ids: [&apos;req-8110ac5c-94ca-4b15-bf72-e199b635aa6f&apos;]</span><br><span class="line"></span><br><span class="line"># Create a test VM and allocate two FIPs to it from two FIP pool</span><br><span class="line">./tools/instance_launch.sh 1 xenial</span><br><span class="line">./tools/sec_groups.sh</span><br><span class="line">fix_ip=$(openstack server list -f value |awk &apos;/xenial/ &#123;print $4&#125;&apos; |awk -F &apos;=&apos; &apos;&#123;print $2&#125;&apos; |awk -F &apos;,&apos; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">ext_net=$(openstack network show ext_net -f value -c id)</span><br><span class="line">fip=$(openstack floating ip create $ext_net -f value -c floating_ip_address)</span><br><span class="line">openstack floating ip set $fip --fixed-ip-address $fix_ip --port $(openstack port list --fixed-ip ip-address=$fix_ip -c id -f value)</span><br><span class="line">ext_net2=$(openstack network show ext_net2 -f value -c id)</span><br><span class="line">fip2=$(openstack floating ip create $ext_net2 -f value -c floating_ip_address)</span><br><span class="line">neutron floatingip-associate $(neutron floatingip-list |grep $fip2 |awk &apos;&#123;print $2&#125;&apos;) $(neutron port-list |grep $fix_ip |awk &apos;&#123;print $2&#125;&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="使用flat-provider-network"><a href="#使用flat-provider-network" class="headerlink" title="使用flat provider network"></a>使用flat provider network</h2><p>使用flat provider network, 虚机内虽然也有多个网卡, 但因为虚机内的网卡和虚机外的网卡属于同一相flat网络并不存在路径选择问题, 结果证明可行.<br>第一步, 继续需要为计算结点准备外部网卡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh nova-compute/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net2 -c id -f value)</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-br br-data2</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-port br-data2 ens7</span><br><span class="line">juju ssh nova-compute/0 -- sudo ifconfig ens7 up</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data2:ens7&quot;</span><br><span class="line">#juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br><span class="line"></span><br><span class="line">source ~/novarc &amp;&amp; nova interface-attach $(nova list |grep $(juju ssh nova-compute/0 -- hostname) |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show zhhuabj_admin_net -c id -f value)</span><br><span class="line">#juju ssh nova-compute/0 -- sudo ovs-vsctl add-br br-data</span><br><span class="line">juju ssh nova-compute/0 -- sudo ovs-vsctl add-port br-data ens9</span><br><span class="line">juju ssh nova-compute/0 -- sudo ifconfig ens9 up</span><br><span class="line">#juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9 br-data2:ens7&quot;</span><br><span class="line">#juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br></pre></td></tr></table></figure></p>
<p>第二步, 创建flat网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source ~/stsstack-bundles/openstack/novarc</span><br><span class="line">neutron net-create ext_net2 --provider:network_type flat --provider:physical_network physnet2 --router:external=True --shared</span><br><span class="line">neutron subnet-create --name ext_net2_subnet --enable_dhcp=False --allocation_pool start=10.10.0.60,end=10.10.0.70 --gateway=10.10.0.1 ext_net2 10.10.0.0/24</span><br></pre></td></tr></table></figure>
<p>第三步, 创建测试虚机, 记得使用一个tenant private network避免引入metadata的问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nova keypair-add --pub-key ~/.ssh/id_rsa.pub mykey</span><br><span class="line">openstack server create --wait --image xenial --flavor m1.small --key-name mykey --network=private i1</span><br><span class="line">nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net -c id -f value)</span><br><span class="line">nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net2 -c id -f value)</span><br></pre></td></tr></table></figure></p>
<p>第四步, 因为我们的外部网络都没有使用dhcp, 所以需要登录虚机手动设置IP.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks                                                       |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">| 45083dc2-c72e-4201-b35c-6d0f6ef3712a | i1   | ACTIVE | -          | Running     | ext_net=10.5.150.8; ext_net2=10.10.0.64; private=192.168.21.13 |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+----------------------------------------------------------------+</span><br><span class="line">juju ssh neutron-gateway/0</span><br><span class="line">sudo ip netns exec qrouter-8b597dd0-49b3-40e3-8e0e-c035d8535cae ssh -i /home/ubuntu/id_rsa ubuntu@192.168.21.13</span><br><span class="line">$ sudo ifconfig ens5 up</span><br><span class="line">$ sudo ifconfig ens6 up</span><br><span class="line">$ sudo ip addr add 10.5.150.8/16 dev ens5</span><br><span class="line">$ sudo ip addr add 10.10.0.64/24 dev ens6</span><br></pre></td></tr></table></figure>
<p>第五步, 测试.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ ping 10.5.150.8</span><br><span class="line">PING 10.5.150.8 (10.5.150.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.150.8: icmp_seq=1 ttl=64 time=5.07 ms</span><br><span class="line">ubuntu@zhhuabj-bastion:~$ ping 10.10.0.64</span><br><span class="line">PING 10.10.0.64 (10.10.0.64) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.0.64: icmp_seq=1 ttl=64 time=4.16 ms</span><br><span class="line"></span><br><span class="line">ubuntu@i1:~$ ping -c 1 10.10.0.58</span><br><span class="line">PING 10.10.0.58 (10.10.0.58) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.0.58: icmp_seq=1 ttl=64 time=2.21 ms</span><br><span class="line">ubuntu@i1:~$ ping -c 1 10.5.0.8</span><br><span class="line">PING 10.5.0.8 (10.5.0.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.5.0.8: icmp_seq=1 ttl=64 time=2.18 ms</span><br></pre></td></tr></table></figure></p>
<p>注: 若报下列这种错误, 是因为没有做第一步创建br-data2及相关的NIC.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@zhhuabj-bastion:~$ nova interface-attach $(nova list |grep i1 |awk &apos;&#123;print $2&#125;&apos;) --net-id=$(neutron net-show ext_net2 -c id -f value)</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">ERROR (ClientException): Unexpected API Error. Please report this at http://bugs.launchpad.net/nova/ and attach the Nova API log if possible.</span><br><span class="line">&lt;class &apos;PortBindingFailed_Remote&apos;&gt; (HTTP 500) (Request-ID: req-38c9faad-872c-43c4-921d-798b31bff548)</span><br></pre></td></tr></table></figure></p>
<h2 id="更近一步考虑"><a href="#更近一步考虑" class="headerlink" title="更近一步考虑"></a>更近一步考虑</h2><p>如果设置”juju config neutron-openvswitch enable-local-dhcp-and-metadata=True”这样可以省掉计算节点的网卡, 这样计算节点原先用于连l3-agent的网卡(现在不需要l3-agent了, 同时dhcp-agent与metadata-agent挪到了计算节点上)可以挪出来用于provider network. 所以对于flat之前的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=False</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data physnet2:br-data2&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9 br-data2:ens7&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1 physnet2&quot;</span><br></pre></td></tr></table></figure></p>
<p>变成了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=True</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9&quot;</span><br><span class="line">juju config neutron-api flat-network-providers=&quot;physnet1&quot;</span><br></pre></td></tr></table></figure></p>
<p>如果是vlan, 则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">juju config neutron-openvswitch enable-local-dhcp-and-metadata=True</span><br><span class="line">juju config neutron-openvswitch bridge-mappings=&quot;physnet1:br-data&quot;</span><br><span class="line">juju config neutron-openvswitch data-port=&quot;br-data:ens9&quot;</span><br><span class="line">juju config neutron-api vlan-ranges=&quot;physnet1:1000:2000&quot;</span><br><span class="line"># must configure external switch to truck mode to allow vlan 1000 to 2000</span><br><span class="line">neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1001</span><br><span class="line">neutron net-create net1 --provider:network_type vlan --provider:physical_network physnet1 --provider:segmentation_id 1002</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/24/如何让OpenStack支持多个FIP/" data-id="ck4jppqru000z88bpna75j25n" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-手机作为显示器及键鼠控制电脑棒" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/15/手机作为显示器及键鼠控制电脑棒/" class="article-date">
  <time datetime="2019-04-15T00:56:05.000Z" itemprop="datePublished">2019-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/15/手机作为显示器及键鼠控制电脑棒/">手机作为显示器及键鼠控制电脑棒</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2019-04-14)</strong></p>
<p>买了一款Intel compute stick core m3, 具有HDMI接口输出音频, 但如何使用手机临时地作为显示器及键盘鼠标控制它呢?</p>
<h2 id="屏幕共享-vnc-amp-teamviewer-amp-anydesk"><a href="#屏幕共享-vnc-amp-teamviewer-amp-anydesk" class="headerlink" title="屏幕共享 - vnc &amp; teamviewer &amp; anydesk"></a>屏幕共享 - vnc &amp; teamviewer &amp; anydesk</h2><p>windows上有一款叫spacedesk的软件, 电脑和手机上都安装它之后, 在同一个局域网可以很方便地从手机控制电脑棒.<br>Ubuntu上可以使用vnc, teamviewer, anydesk.</p>
<ul>
<li>ubuntu上安装VNC<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># https://medium.com/@aldo_mx/simplest-way-to-configure-vnc-server-in-xubuntu-16-04-lts-and-newer-6c0b3ae21fe5</span><br><span class="line">sudo apt-get install vino</span><br><span class="line">gsettings list-recursively org.gnome.Vino</span><br><span class="line"># some clients like TightVNC for Windows do not work with encryption anymore</span><br><span class="line"># because older protocols like SSLv3 and TLSv1 have been deprecated.</span><br><span class="line"># dconf-editor - ORG &gt; GNOME &gt; DESKTOP &gt; REMOTE ACCESS</span><br><span class="line">gsettings set org.gnome.Vino require-encryption false</span><br><span class="line"># activate at startup, or set &quot;Settings -&gt; Sharing -&gt; screen Sharing&quot; in ubuntu</span><br><span class="line">sudo cp /usr/share/applications/vino-server.desktop /etc/xdg/autostart/vino-server.desktop</span><br><span class="line"># #enable &quot;Application Autostart -&gt; Desktop Sharing(Gnome Desktop Sharing Server)&quot;</span><br><span class="line">xfce4-session-settings</span><br><span class="line">/usr/lib/vino/vino-server --sm-disable</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>需注意两点：一是要<strong>设置require-encryption=false</strong>, 二是手机上使用realvnc client时不应该登陆，因为没用realvnc server，而是用的vino server</p>
<ul>
<li>安装使用anydesk使用屏幕, 鼠标, 键盘.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.anydesk.com/linux/anydesk_4.0.1-1_amd64.deb</span><br><span class="line">sudo dpkg -i anydesk_4.0.1-1_amd64.deb</span><br><span class="line">sudo apt --fix-broken install</span><br><span class="line">sudo dpkg -i anydesk_4.0.1-1_amd64.deb</span><br><span class="line">sudo systemctl enable anydesk.service</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>最后, 设置anydesk, 设置允许随时连接查询, 并设置密码, 禁用掉声音传输.<br>但又遇到一个问题, 在笔记本上测试anydesk似乎没有问题. 但移到电脑棒上后, 电脑棒启动后经常无故死机. (<strong>无故死机的问题找到了, 一次是因为电源没插好接触不良, 另一次是应用了平时给手机充电的Type-A USB输出的充电器, 应该使用自带的APD亚源科技的Type-C输出口的充电器(输出则是5.2V 2.2A（Type-C对机身）、5V 0.9A（对两个Type-A）</strong>，这个问题真难查). 但仍然遇到一个问题 (手机上的anydesk发起连接时报: 连接已终止,. 状态: result_invalid_state，暂不清楚原因)</p>
<ul>
<li>切换为teamviewer, 也是遇到类似问题, 曾经成功过, 但之后手机上的teamviewer就一起报: teamviewer正在启动, 请稍候. （该问题原因已找到， 因为墙，用4G网络可以， 见： <a href="https://github.com/ywb94/openwrt-ssr/issues/31" target="_blank" rel="external">https://github.com/ywb94/openwrt-ssr/issues/31</a> 及 <a href="https://zvv.me/z/1366.html" target="_blank" rel="external">https://zvv.me/z/1366.html</a> ）</li>
</ul>
<p>还存在一个问题: **如果电脑棒不通过HDMI接口接一个显示器, 电脑棒重启之后通过远程桌面连接过去看到的是一屏黑色. 那是因为Linux服务器一般是不接显示器的，用ssh等文字界面连接管理即可, 可是有些软件需要GUI管理，若不接显示器，xwindows是默认无法启动的，从而导致vnc server连接失败, 可配置一块fake显示器解决:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># https://askubuntu.com/questions/453109/add-fake-display-when-no-monitor-is-plugged-in</span><br><span class="line">sudo apt-get install xserver-xorg-video-dummy</span><br><span class="line">sudo bash -c &apos;cat &gt; /usr/share/X11/xorg.conf.d/xorg.conf&apos; &lt;&lt;EOF</span><br><span class="line">Section &quot;Device&quot;</span><br><span class="line">    Identifier  &quot;Configured Video Device&quot;</span><br><span class="line">    Driver      &quot;dummy&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Monitor&quot;</span><br><span class="line">    Identifier  &quot;Configured Monitor&quot;</span><br><span class="line">    HorizSync 31.5-48.5</span><br><span class="line">    VertRefresh 50-70</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Screen&quot;</span><br><span class="line">    Identifier  &quot;Default Screen&quot;</span><br><span class="line">    Monitor     &quot;Configured Monitor&quot;</span><br><span class="line">    Device      &quot;Configured Video Device&quot;</span><br><span class="line">    DefaultDepth 24</span><br><span class="line">    SubSection &quot;Display&quot;</span><br><span class="line">    Depth 24</span><br><span class="line">    Modes &quot;1024x800&quot;</span><br><span class="line">    EndSubSection</span><br><span class="line">EndSection</span><br><span class="line">EOF</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure></p>
<p>但是使用上述的软件模拟的显示器, 会造成即使接了真显示器, 还是用得虚拟的, 所以不方便啊. 网上有硬件的Dummy HDMI可用.</p>
<h2 id="kdeconnect"><a href="#kdeconnect" class="headerlink" title="kdeconnect"></a>kdeconnect</h2><p>kdeconnect可以用来在ubuntu与androd之间双向传输数据, 例如电脑使用手机的键盘鼠标, 电脑与手机相互传输数据, 手机上的短信通知发给电脑显示.<br>直接在电脑与手机上安装kdeconnect即可使用.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install kdeconnect</span><br></pre></td></tr></table></figure></p>
<p>但kdeconnectd进程 (/etc/xdg/autostart/kdeconnectd.desktop)在ubuntu未登录之前是不会启动的, 所以禁用掉电脑棒的密码登录设置它为自动登录即可.</p>
<h2 id="gsconnect-gshell-extension"><a href="#gsconnect-gshell-extension" class="headerlink" title="gsconnect gshell extension"></a>gsconnect gshell extension</h2><p>gsconnect与kdeconnect是类似的东西, 它不依赖kde的一些包, 但它依赖Gnome desk与chrome, 电脑棒启动后没有自动启动chrome的话用不了. 所以实际我用的还是kdeconnect, 但这里记录使用gsconnect的过程.</p>
<ul>
<li>安装gnome-shell-extension与chrome-gnome-shell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gnome-shell --version</span><br><span class="line">sudo apt install gnome-shell-extensions</span><br><span class="line">sudo apt install chrome-gnome-shell</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>离个题, 例如想显示各个不同时区的team member的上班时间的话, 可以添加~/people.json将每个人的时区按下列格式添加进去即可.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim ~/people.json</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">      &quot;name&quot;: &quot;your name&quot;,</span><br><span class="line">      &quot;github&quot;: &quot;your lauchpd id&quot;,</span><br><span class="line">      &quot;city&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;tz&quot;: &quot;Asia/Shanghai&quot;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<ul>
<li>访问这个网址<a href="https://extensions.gnome.org/extension/1319/gsconnect/" target="_blank" rel="external">https://extensions.gnome.org/extension/1319/gsconnect/</a> 方便地安装gsconnect即可 (注意: 如果出错, 多半是因为没有在chrome里访问 chrome://extensions/ 将GNOME Shell integration打开的原因).</li>
<li>手机上在play里搜索安装KDE Connect, 并打开它, 和gsconnect为pair配对.</li>
<li>还可以支持电脑上Nautilus来mount手机上的文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-nautilus gir1.2-nautilus-3.0 sshfs</span><br><span class="line"># then send file to Android by first open the nautilus then right click one file &quot;Send to Mobile Device -&gt; Nokia&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/15/手机作为显示器及键鼠控制电脑棒/" data-id="ck4jppqry001288bp8b0yrlvn" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Set-ip-IPv6-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/18/Set-ip-IPv6-env/" class="article-date">
  <time datetime="2019-01-18T05:44:20.000Z" itemprop="datePublished">2019-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/18/Set-ip-IPv6-env/">Set ip IPv6 env</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基础-ND协议的三个位"><a href="#基础-ND协议的三个位" class="headerlink" title="基础 - ND协议的三个位"></a>基础 - ND协议的三个位</h2><p>ND协议包中有三个位(Auto, Managed, Other)：</p>
<ul>
<li>M bit (Managed Address Configuration), M bit如果是1,表示Clients要另外再去跟DHCPv6要IPv6 Prefix</li>
<li>O bit (Other Configuration), O bit如果是1,表示Clients要去跟DHCPv6要DNS(RDNSS)等其他信息<br>这样：</li>
<li>slaas, Stateless autoconfiguration, A=1, M=0, O=0, 主机將只得到Router給的 Prefix, 无法取得DNS等资讯, 其他必须自己填写.</li>
<li>dhcpv6-stateful, A=0, M=1, O=1, 所有信息（IPv6 prefix, DNS等)都通过DHCPv6获得,客戶端主要使用UDP port 546, 而服務器端使用 UDP port 547</li>
<li>dhcpv6-stateless,A=1, M=0, O=1, 除了使用RA裡面的Prefix,其他如DNS等等信息会由DHCPv6 取得.<h2 id="基础-Neutron-IPv6"><a href="#基础-Neutron-IPv6" class="headerlink" title="基础 - Neutron IPv6"></a>基础 - Neutron IPv6</h2>Neutron中有两个重要属性来支持IPv6 (ipv6_address_mode 与 ipv6_ra_mode):</li>
<li>ipv6_ra_mode, 如果设置表示由Neutron来使用radvd来模拟软件IPv6路由器, 如果不设置表示使用外部IPv6路由器</li>
<li>ipv6_address_mode, 对应上述ND协议中的三个位(Auto, Managed, Other), 例如: 对于dhcpv6-stateless, 3比特应该是: A=1, M=0, O=1.</li>
</ul>
<p>下面是创建一个使用外部IPv6路由器并使用dhcpv6-stateless的例子:<br>neutron net-create –provider:network_type flat –provider:physical_network physnet1 –router:external=True ext_net<br>neutron subnet-create ext_net –name external-subnet-v6 –ip_version 6 –ipv6_address_mode dhcpv6-stateless –allocation-pool start=2001:db8:0:1::2,end=2001:db8:0:1:ffff:ffff:ffff:ffff 2001:db8:0:1::/64</p>
<h2 id="基础-Ubuntu中手工配置IPv6的注意点"><a href="#基础-Ubuntu中手工配置IPv6的注意点" class="headerlink" title="基础 - Ubuntu中手工配置IPv6的注意点"></a>基础 - Ubuntu中手工配置IPv6的注意点</h2><p>Ubuntu中配置IPv6可以采用network-manager, 也可采用在/etc/network/interface中手工配置, 也可以使用最新的netplan. 这里描述的是采用手工配置的方法.<br>先看一个遇到的实际问题:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">下面配置不work</span><br><span class="line">iface eth0 inet6 auto</span><br><span class="line">   # use SLAAC to get global IPv6 address from the router</span><br><span class="line">   # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">   up sleep 5</span><br><span class="line">   dhcp 1</span><br><span class="line">   autoconf 1</span><br><span class="line">   accept_ra 2</span><br><span class="line"></span><br><span class="line">下列配置work</span><br><span class="line">iface eth0 inet6 static</span><br><span class="line">address 2001:192:168:99::135</span><br><span class="line">   gateway 2001:192:168:99::1</span><br><span class="line">   netmask 64</span><br><span class="line">且改成network-manager也work, 这是为什么呢?</span><br><span class="line"></span><br><span class="line">测试方法是:</span><br><span class="line">#it will flush link-local address as well</span><br><span class="line">#ip addr flush br-eth0</span><br><span class="line"># avoid the error: can&apos;t get a link-local address</span><br><span class="line">sudo ip link set dev eth0 down</span><br><span class="line">sudo ip link set dev eth0 up</span><br><span class="line">ifdown br-eth0</span><br><span class="line">ifup --force --verbose br-eth0</span><br></pre></td></tr></table></figure></p>
<p>采用”ifup –force –verbose br-eth0”命令看到的错误是”can’t get a link-local address”.<br>为什么static模式与network-manager模式没有这个错误呢? 原来是这两者默认执行了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br></pre></td></tr></table></figure></p>
<p>并且之前Linux网桥br-eth0上一直没有IPv6地址的原因也是这个, 且上面”sudo ip link set dev eth0 up”这句也会自动设置disable_ipv6=0, 但不会对br-eth0作同样的设置.<br>所以添加”up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6”后问题解决, 完整配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@node1:~# cat /etc/network/interfaces</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">auto br-eth0</span><br><span class="line">iface br-eth0 inet static</span><br><span class="line">    address 192.168.99.124/24</span><br><span class="line">    gateway 192.168.99.1</span><br><span class="line">    bridge_ports eth0</span><br><span class="line">    dns-nameservers 192.168.99.1</span><br><span class="line">    bridge_stp on</span><br><span class="line">    bridge_fd 0</span><br><span class="line">    bridge_maxwait 0</span><br><span class="line">    up echo -n 0 &gt; /sys/devices/virtual/net/$IFACE/bridge/multicast_snooping</span><br><span class="line"># for stateless it&apos;s &apos;inet6 auto&apos;, for stateful it&apos;s &apos;inet6 dhcp&apos;</span><br><span class="line">iface br-eth0 inet6 auto</span><br><span class="line">    #iface eth0 inet6 static</span><br><span class="line">    #address 2001:192:168:99::135</span><br><span class="line">    #gateway 2001:192:168:99::1</span><br><span class="line">    #netmask 64</span><br><span class="line">    # use SLAAC to get global IPv6 address from the router</span><br><span class="line">    # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">    # sleep 5 is due a bug and &apos;dhcp 1&apos; indicates that info should be obtained from dhcpv6 server for stateless</span><br><span class="line">    up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br><span class="line">    up sleep 5</span><br><span class="line">    autoconf 1</span><br><span class="line">    accept_ra 2</span><br><span class="line">    dhcp 1</span><br></pre></td></tr></table></figure></p>
<p>此外, 最好设置accept_ra=2, 因为经常会遇到自动配置的IPv6地址丢失或者不能获取的问题。一般情况是都是启用了IPv6转发功能(sudo sysctl -w net.ipv6.conf.all.forwarding=1)引起的。<br>为了配置IPv6 address和default gateway, client/host都会默认去listen或者solicit RA广播, 并且host作为router时会忽略RA, 这由accept_ra设置:</p>
<ul>
<li>0 Do not accept RouterAdvertisements.</li>
<li>1 Accept Router Advertisements if forwarding is disabled.</li>
<li>2 Overrule forwarding behavior. Accept Router Advertisements  even if forwarding is enabled.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv6.conf.all.forwarding=1</span><br><span class="line">sudo sysctl -w net.ipv6.conf.all.accept_ra=2</span><br><span class="line">sudo sysctl -w net.ipv6.conf.br-lan.disable_ipv6=0</span><br><span class="line">#echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="IPv6中的防火墙"><a href="#IPv6中的防火墙" class="headerlink" title="IPv6中的防火墙"></a>IPv6中的防火墙</h2><p>IPv6 Router端:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># Clear all ip6tables rules</span><br><span class="line">ip6tables -t nat -X</span><br><span class="line">ip6tables -t nat -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t nat -P POSTROUTING ACCEPT</span><br><span class="line">ip6tables -t nat -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -F</span><br><span class="line">ip6tables -t mangle -X</span><br><span class="line">ip6tables -t mangle -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t mangle -P INPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -P FORWARD ACCEPT</span><br><span class="line">ip6tables -t mangle -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t mangle -P POSTROUTING ACCEPT</span><br><span class="line">ip6tables -F</span><br><span class="line">ip6tables -X</span><br><span class="line">ip6tables -P FORWARD ACCEPT</span><br><span class="line">ip6tables -P INPUT ACCEPT</span><br><span class="line">ip6tables -P OUTPUT ACCEPT</span><br><span class="line">ip6tables -t raw -F</span><br><span class="line">ip6tables -t raw -X</span><br><span class="line">ip6tables -t raw -P PREROUTING ACCEPT</span><br><span class="line">ip6tables -t raw -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"># Default DROP rules</span><br><span class="line">ip6tables -P INPUT   DROP</span><br><span class="line">ip6tables -P OUTPUT  ACCEPT</span><br><span class="line">ip6tables -P FORWARD DROP</span><br><span class="line"></span><br><span class="line"># Allow established connections</span><br><span class="line">ip6tables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">ip6tables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"># For IPv6</span><br><span class="line"># it&apos;s not required due to ipv6-icmp</span><br><span class="line"># sudo ip6tables -A INPUT -p udp --dport 547 -j ACCEPT</span><br><span class="line">#ip6tables -A INPUT -p icmpv6 --icmpv6-type echo-request -j ACCEPT</span><br><span class="line">ip6tables -A INPUT -p ipv6-icmp -j ACCEPT</span><br><span class="line">ip6tables -A FORWARD -p ipv6-icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Ajust MTU</span><br><span class="line">ip6tables -t mangle -A POSTROUTING -o pppoe-wan -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</span><br></pre></td></tr></table></figure></p>
<p>IPv6 Client端:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip6tables -t filter -A INPUT -p udp -m udp --sport 547 --dport 546 -j ACCEPT</span><br><span class="line">ip6tables -t filter -A INPUT -p ipv6-icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line"># or security group</span><br><span class="line">https://bugs.launchpad.net/neutron/+bug/1335984</span><br><span class="line">openstack security group rule create $secgroup --protocol udp --dst-port 546 --ethertype IPv6</span><br><span class="line">openstack security group rule create $secgroup --protocol icmpv6 --ethertype IPv6</span><br><span class="line"></span><br><span class="line"># Flow based firewall</span><br><span class="line">hard_timeout=0,idle_timeout=0,priority=4,udp,tp_dst=546/0xffff,table=32,tp_src=547/0xffff,nw_src=fe80::f816:3eff:fea3:ec40,actions=learn(table=33,priority=5,hard_timeout=120,eth_type=0x800,nw_proto=17,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],NXM_OF_IP_SRC[]=NXM_OF_IP_DST[],NXM_OF_UDP_SRC[]=NXM_OF_UDP_DST[], NXM_OF_UDP_DST[]=NXM_OF_UDP_SRC[],output:NXM_OF_IN_PORT[]),normal</span><br></pre></td></tr></table></figure></p>
<p>另外, 别忘了禁用掉ufw或者SELinux之类的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br></pre></td></tr></table></figure></p>
<h2 id="Statefull-DHCPv6"><a href="#Statefull-DHCPv6" class="headerlink" title="Statefull DHCPv6"></a>Statefull DHCPv6</h2><p>采用isc-dhcp-server搭建DHCPv6 Server:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/</span><br><span class="line">hua@t440p:~$ ip addr show eth0 |grep inet6 |grep global</span><br><span class="line">    inet6 2001:192:168:99::430/128 scope global</span><br><span class="line">echo &apos;Acquire::ForceIPv4 &quot;true&quot;;&apos; | sudo tee /etc/apt/apt.conf.d/99force-ipv4</span><br><span class="line">sudo apt install isc-dhcp-server</span><br><span class="line">grep -v ^# /etc/dhcp/dhcpd6.conf</span><br><span class="line">sudo cp /etc/dhcp/dhcpd6.conf /etc/dhcp/dhcpd6.conf_bak</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">authoritative;</span><br><span class="line">default-lease-time 14400;</span><br><span class="line">max-lease-time 86400;</span><br><span class="line">log-facility local7;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">    option dhcp6.name-servers 2001:4860:4860::8888, 2001:4860:4860::8844;</span><br><span class="line">    option dhcp6.domain-search &quot;quqi.com&quot;;</span><br><span class="line">    range6 2001:192:168:99::100 2001:192:168:99::199;</span><br><span class="line">    range6 2001:192:168:99::/64 temporary;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo touch /var/lib/dhcp/dhcpd6.leases</span><br><span class="line">sudo /usr/sbin/dhcpd -6 -d -cf /etc/dhcp/dhcpd6.conf eth0</span><br><span class="line">sudo chown dhcpd:dhcpd /var/lib/dhcp/dhcpd6.leases</span><br><span class="line">sudo service isc-dhcp-server6 restart</span><br></pre></td></tr></table></figure></p>
<p>然后记得照上节说的设置DHCPv6 Server与Client上的防火墙规则. 接着在另一台机器上作client测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># need to use &apos;inet6 dhcp&apos; in client side for statefull DHCPv6</span><br><span class="line">iface br-eth0 inet6 dhcp</span><br><span class="line">    #iface eth0 inet6 static</span><br><span class="line">    #address 2001:192:168:99::135</span><br><span class="line">    #gateway 2001:192:168:99::1</span><br><span class="line">    #netmask 64</span><br><span class="line">    # use SLAAC to get global IPv6 address from the router</span><br><span class="line">    # we may not enable ipv6 forwarding, otherwise SLAAC gets disabled</span><br><span class="line">    # sleep 5 is due a bug and &apos;dhcp 1&apos; indicates that info should be obtained from dhcpv6 server for stateless</span><br><span class="line">    up echo 0 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</span><br><span class="line">    up sleep 5</span><br><span class="line">    autoconf 1</span><br><span class="line">    accept_ra 2</span><br><span class="line">    dhcp 1</span><br><span class="line"></span><br><span class="line"># test command</span><br><span class="line">dhclient -6 -d br-eth0</span><br><span class="line"></span><br><span class="line"># verity</span><br><span class="line">hua@node1:~$ sudo tcpdump -ni eth0 ip6 host fe80::d5a3:10a3:6161:5b2e</span><br><span class="line">12:44:00.868609 IP6 fe80::d5a3:10a3:6161:5b2e.547 &gt; fe80::fa32:e4ff:febe:87cd.546: dhcp6 advertise</span><br><span class="line">12:44:01.946548 IP6 fe80::d5a3:10a3:6161:5b2e.547 &gt; fe80::fa32:e4ff:febe:87cd.546: dhcp6 reply</span><br><span class="line">root@node1:~# cat /etc/resolv.conf</span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line">nameserver 192.168.99.1</span><br><span class="line">#nameserver 211.136.17.107</span><br><span class="line">#nameserver 114.114.114.114</span><br><span class="line">#nameserver 223.5.5.5</span><br><span class="line">nameserver 2001:4860:4860::8888</span><br><span class="line">nameserver 2001:4860:4860::8844</span><br><span class="line">nameserver 2001:db8::1:6a1:51ff:fe8a:2ca7</span><br><span class="line">search quqi.com lan</span><br></pre></td></tr></table></figure>
<p>另外, 使用BIND9的例子可参见 - <a href="https://jochen.kirstaetter.name/enabling-dns-for-ipv6-infrastructure/" target="_blank" rel="external">https://jochen.kirstaetter.name/enabling-dns-for-ipv6-infrastructure/</a></p>
<h2 id="SLAAC-Stateless-Address-Auto-Configuration"><a href="#SLAAC-Stateless-Address-Auto-Configuration" class="headerlink" title="SLAAC (Stateless Address Auto Configuration)"></a>SLAAC (Stateless Address Auto Configuration)</h2><p>radvd来提供RA部分, SLAAC只有RA部分. RA只能设置IPv6 prefix与DNS (RDNSS).<br>Historically the software package radvd was commonly used for just the RA-part of this. But dnsmasq offers a more complete setup.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv6.conf.all.forwarding=1</span><br><span class="line">sudo ip addr add 2001:db8:0:1::1/64 dev eth0</span><br><span class="line">sudo apt-get install radvd</span><br><span class="line">$ cat /etc/radvd.conf</span><br><span class="line">    interface eth0</span><br><span class="line">    &#123;</span><br><span class="line">       AdvSendAdvert on;</span><br><span class="line">       prefix 2001:db8:0:1::/64</span><br><span class="line">       &#123;</span><br><span class="line">            AdvOnLink on;</span><br><span class="line">            AdvAutonomous on;</span><br><span class="line">       &#125;;</span><br><span class="line">       #Send DNS Server setting</span><br><span class="line">       #RDNSS fd5d:12c9:2201:1::2&#123;</span><br><span class="line">    &#125;;</span><br><span class="line">sudo /etc/init.d/radvd restart</span><br><span class="line">sudo ip6tables -F</span><br><span class="line"></span><br><span class="line">neutron subnet-create --ip-version=6 --name=ext-v6-subnet --gateway 2001:db8:0:1::1 --allocation-pool start=2001:db8:0:1::5,end=2001:db8:0:1:ffff:ffff:ffff:fffe --disable-dhcp ext_net 2001:db8:0:1::/64</span><br><span class="line">neutron net-create private</span><br><span class="line">neutron subnet-create --ip-version=6 --name=private_v6_subnet --ipv6-address-mode=slaac --ipv6-ra-mode=slaac private 2001:db8:0:2::/64</span><br><span class="line">neutron router-interface-add provider-router private_v6_subnet</span><br></pre></td></tr></table></figure></p>
<h2 id="SLAAS-with-Stateless-DHCPv6"><a href="#SLAAS-with-Stateless-DHCPv6" class="headerlink" title="SLAAS with Stateless DHCPv6"></a>SLAAS with Stateless DHCPv6</h2><p>Stateless意味着:</p>
<ul>
<li>radvd提供RA (AdvManagedFlag=off)</li>
<li>client使用radvd RA提供的IPv6 prefix配置IPv6 address</li>
<li>client的其他信息如DNS等从DHCPv6获得<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; /etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">interface eth0</span><br><span class="line">&#123;</span><br><span class="line">    AdvSendAdvert on;</span><br><span class="line">    MinRtrAdvInterval 30;</span><br><span class="line">    MaxRtrAdvInterval 100;</span><br><span class="line">    AdvManagedFlag off;</span><br><span class="line">    AdvOtherConfigFlag on;</span><br><span class="line">    prefix 2001:192:168:99::/64</span><br><span class="line">    &#123;</span><br><span class="line">        AdvOnLink on;</span><br><span class="line">        AdvAutonomous on;</span><br><span class="line">        AdvRouterAddr off;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/radvd.conf&apos; &lt;&lt;EOF</span><br><span class="line">default-lease-time 600;</span><br><span class="line">max-lease-time 7200;</span><br><span class="line">log-facility local7;</span><br><span class="line">option dhcp6.name-servers 2001:4860:4860::8888;</span><br><span class="line">option dhcp6.domain-search &quot;&quot;;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="SLAAS-with-Statefull-DHCPv6"><a href="#SLAAS-with-Statefull-DHCPv6" class="headerlink" title="SLAAS with Statefull DHCPv6"></a>SLAAS with Statefull DHCPv6</h2><p>Statefull意味着:</p>
<ul>
<li>radvd不提供RA (AdvManagedFlag=on)</li>
<li>client使用DHCPv6去配置IPv6 address</li>
<li>client的其他信息如DNS等也从DHCPv6获得<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c &apos;cat &gt; /etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">interface eth0</span><br><span class="line">&#123;</span><br><span class="line">    AdvSendAdvert on;</span><br><span class="line">    MinRtrAdvInterval 30;</span><br><span class="line">    MaxRtrAdvInterval 100;</span><br><span class="line">    AdvManagedFlag on;</span><br><span class="line">    AdvOtherConfigFlag on;</span><br><span class="line">    prefix 2001:192:168:99::/64</span><br><span class="line">    &#123;</span><br><span class="line">        AdvOnLink on;</span><br><span class="line">        AdvAutonomous on;</span><br><span class="line">        AdvRouterAddr off;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/dhcp/dhcpd6.conf&apos; &lt;&lt;EOF</span><br><span class="line">authoritative;</span><br><span class="line">default-lease-time 14400;</span><br><span class="line">max-lease-time 86400;</span><br><span class="line">log-facility local7;</span><br><span class="line">subnet6 2001:192:168:99::/64 &#123;</span><br><span class="line">    option dhcp6.name-servers 2001:4860:4860::8888, 2001:4860:4860::8844;</span><br><span class="line">    option dhcp6.domain-search &quot;quqi.com&quot;;</span><br><span class="line">    range6 2001:192:168:99::100 2001:192:168:99::199;</span><br><span class="line">    range6 2001:192:168:99::/64 temporary;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="实际问题"><a href="#实际问题" class="headerlink" title="实际问题"></a>实际问题</h2><p>例如, 使用OpenStack根据外部IPv6 stateless router定义的IPv6网络, 虚机分配了IP, 但是网卡上去没配置, 一般地, 理论上问题出在:<br>1, 既然有外部路由器, Openstack CLI中不应该定义ipv6_ra_mode, 不指定ipv6_ra_mode, neutron就不会创建radvd, 那样就会直接使用外部的IPv6路由器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">neutron net-create IPv6 (vlan1809) --shared --provider:physical_network physnet2 --provider:network_type vlan --provider:segmentation_id 1809 --router:external True</span><br><span class="line">neutron subnet-create ipv6-pd --name external-subnet-v6 --ip_version 6 --ipv6_address_mode dhcp-stateless --allocation-pool start=2001:1284:ff:18::2,end=2001:1284:ff:18:ffff:ffff:ffff:ffff --dns-nameserver 2001:1284:ff02::243 2001:1284:ff:18::/64</span><br></pre></td></tr></table></figure></p>
<p>2, 外部IPv6路由器的防火墙规则打开了没:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo ip6tables -A INPUT -p icmpv6 -j ACCEPT</span><br><span class="line">sudo ip6tables -A OUTPUT -p icmpv6 -j ACCEPT</span><br><span class="line">sudo ip6tables -A FORWARD -p icmpv6 -j ACCEPT</span><br><span class="line">sudo ufw allow proto udp from fe80::/64 to any port 547</span><br><span class="line">sudo ufw disable</span><br></pre></td></tr></table></figure></p>
<p>3, 虚机这边虚机定义security group rule将其所有的计算节点上的防火墙规则打开:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://bugs.launchpad.net/neutron/+bug/1335984</span><br><span class="line"></span><br><span class="line">openstack security group rule create $secgroup --protocol udp --dst-port 546 --ethertype IPv6</span><br><span class="line">openstack security group rule create $secgroup --protocol icmpv6 --ethertype IPv6</span><br><span class="line"></span><br><span class="line">For iptables driver, above equals:</span><br><span class="line">ip6tables -t filter -A INPUT -p udp -m udp --sport 547 --dport 546 -j ACCEPT</span><br><span class="line">ip6tables -t filter -A INPUT -p ipv6-icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line">For ovs flow based driver, above equals:</span><br><span class="line">hard_timeout=0,idle_timeout=0,priority=4,udp,tp_dst=546/0xffff,table=32,tp_src=547/0xffff,nw_src=fe80::f816:3eff:fea3:ec40,actions=learn(table=33,priority=5,hard_timeout=120,eth_type=0x800,nw_proto=17,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],NXM_OF_IP_SRC[]=NXM_OF_IP_DST[],NXM_OF_UDP_SRC[]=NXM_OF_UDP_DST[], NXM_OF_UDP_DST[]=NXM_OF_UDP_SRC[],output:NXM_OF_IN_PORT[]),normal</span><br></pre></td></tr></table></figure></p>
<p>3, 外部路由器因为启用了forwarding应该设置accept_ra=2而不是accept_ra=1:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv6.conf.all.accept_ra=2</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://asdkda.github.io/2016/02/05/ipv6/" target="_blank" rel="external">http://asdkda.github.io/2016/02/05/ipv6/</a><br>[2] <a href="http://tldp.org/HOWTO/html_single/Linux+IPv6-HOWTO/#idp57787920" target="_blank" rel="external">http://tldp.org/HOWTO/html_single/Linux+IPv6-HOWTO/#idp57787920</a><br>[3] <a href="https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/" target="_blank" rel="external">https://jochen.kirstaetter.name/dhcpv6-ipv6-in-your-local-network/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/01/18/Set-ip-IPv6-env/" data-id="ck4jppqre000g88bpmq06h9e3" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/24/How-to-make-pure-text-presentation-ppt/">How to make pure text presentation/ppt</a>
          </li>
        
          <li>
            <a href="/2019/11/09/How-to-test-Neutron-VRRP-HA-rapidly/">How to test Neutron VRRP HA rapidly</a>
          </li>
        
          <li>
            <a href="/2019/11/08/Perf火焰图/">Perf火焰图</a>
          </li>
        
          <li>
            <a href="/2019/11/06/使用apt-mirror和simplestreams搭建本地源/">使用apt-mirror和simplestreams搭建本地源</a>
          </li>
        
          <li>
            <a href="/2019/11/05/k8s-http-https-nginx-ingress/">k8s http/https nginx ingress</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 张华<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>