<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="blog.csdn.net/quqi99">
<meta property="og:type" content="website">
<meta property="og:title" content="技术并艺术着">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="blog.csdn.net/quqi99">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="技术并艺术着">
<meta name="twitter:description" content="blog.csdn.net/quqi99">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/Fixing-thinkpad-bluetooth-keyboard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/02/Fixing-thinkpad-bluetooth-keyboard/" itemprop="url">Fixing thinkpad bluetooth keyboard</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-02T15:59:12+08:00">
                2021-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2019-03-30)</strong></p>
<p>为了保护颈椎, 已经习惯不用鼠标, 但是高度依赖于Thinkpad的小红点鼠标. 但是蓝牙经常性一个月会断一次, 断了之后很难连接上. 这次更奇葩了, 蓝牙灯也不灭, 键盘上也没有重置的键, 只好等到今天蓝牙键盘电池耗尽之后再试, 但是还是连不上, 错误为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mar 30 07:46:42 t440p bluetoothd[10079]: Can&apos;t get HIDP connection info</span><br><span class="line">Mar 30 07:46:43 t440p bluetoothd[10079]: connect error: Invalid exchange (52)</span><br><span class="line">Mar 30 07:46:50 t440p kernel: [240741.397564] Bluetooth: hci0: last event is not cmd complete (0x0f)</span><br></pre></td></tr></table></figure></p>
<p>在设置GUI里先删除这个蓝牙, 也报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mar 30 07:58:28 t440p gnome-control-c[9696]: Failed to remove device &apos;/org/bluez/hci1/dev_90_7F_61_00_23_C3&apos;: GDBus.Error:org.freedesktop.DBus.Error.ServiceUnknown: The name :1.505 was not provided by any .service files</span><br></pre></td></tr></table></figure></p>
<p>好吧, 通过下列命令删除, 再连接, 这次终于算成功了. 本博客将继续记录蓝牙今后遇到的所有连接问题.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">hua@t440p:$ bluetoothctl</span><br><span class="line">[NEW] Controller 00:15:00:CB:B0:FF t440p #2 [default]</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">[NEW] Device 04:F1:28:31:D2:10 Nokia 7</span><br><span class="line">[NEW] Controller 00:1A:7D:DA:71:13 t440p #1</span><br><span class="line">[NEW] Device 00:15:00:CB:B0:FF t440p</span><br><span class="line">[NEW] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">Agent registered</span><br><span class="line">[bluetooth]# list</span><br><span class="line">Controller 00:15:00:CB:B0:FF t440p #2 [default]</span><br><span class="line">Controller 00:1A:7D:DA:71:13 t440p #1</span><br><span class="line">[bluetooth]# devices</span><br><span class="line">Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">Device 04:F1:28:31:D2:10 Nokia 7</span><br><span class="line">[bluetooth]# info 90:7F:61:00:23:C3</span><br><span class="line">Device 90:7F:61:00:23:C3 (public)</span><br><span class="line">	Name: ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">	Alias: ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">	Class: 0x00000540</span><br><span class="line">	Icon: input-keyboard</span><br><span class="line">	Paired: yes</span><br><span class="line">	Trusted: no</span><br><span class="line">	Blocked: no</span><br><span class="line">	Connected: no</span><br><span class="line">	LegacyPairing: no</span><br><span class="line">[bluetooth]# remove 90:7F:61:00:23:C3</span><br><span class="line">[DEL] Device 90:7F:61:00:23:C3 ThinkPad Compact Bluetooth Keyboard with TrackPoint</span><br><span class="line">Device has been removed</span><br><span class="line">[bluetooth]# power on</span><br><span class="line">Changing power on succeeded</span><br></pre></td></tr></table></figure></p>
<p>一行命令搞定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#bt-device  -l |grep -i keyboard</span><br><span class="line">DEVICE_MAC=&apos;90:7F:61:00:23:C3&apos;</span><br><span class="line">&lt;&lt;&lt;&quot;connect $DEVICE_MAC&quot; bluetoothctl</span><br><span class="line">&lt;&lt;&lt;&quot;connect $DEVICE_MAC&quot; bluetoothctl &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>
<p>然后升级bluez到5.5版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dpkg --status bluez | grep &apos;^Version:&apos;</span><br><span class="line">sudo add-apt-repository ppa:bluetooth/bluez</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure></p>
<h2 id="解决suspend唤醒之后的usb问题"><a href="#解决suspend唤醒之后的usb问题" class="headerlink" title="解决suspend唤醒之后的usb问题"></a>解决suspend唤醒之后的usb问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#重启USB</span><br><span class="line">#!/bin/bash</span><br><span class="line">for I in $(ls /sys/bus/pci/drivers/xhci_hcd/|grep : ) ; do</span><br><span class="line">echo $I</span><br><span class="line">sudo echo $I &gt; /sys/bus/pci/drivers/xhci_hcd/unbind</span><br><span class="line">sudo echo $I &gt; /sys/bus/pci/drivers/xhci_hcd/bind</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">#https://itectec.com/ubuntu/ubuntu-wakes-from-suspend-immediately-when-bluetooth-device-disconnected/</span><br><span class="line">#通过重启USB让系统进入suspend之后马上又唤醒</span><br><span class="line">chmod a+x /lib/systemd/system-sleep/custom-xhci_hcd</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># Original script was using /bin/sh but shellcheck reporting warnings.</span><br><span class="line"></span><br><span class="line"># NAME: custom-xhci_hcd</span><br><span class="line"># PATH: /lib/systemd/system-sleep</span><br><span class="line"># CALL: Called from SystemD automatically</span><br><span class="line"># DESC: Suspend broken for USB3.0 as of Oct 25/2018 various kernels all at once</span><br><span class="line"></span><br><span class="line"># DATE: Oct 28 2018.</span><br><span class="line"></span><br><span class="line"># NOTE: From comment #61 at: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/522998</span><br><span class="line"></span><br><span class="line">TMPLIST=/tmp/xhci-dev-list</span><br><span class="line"></span><br><span class="line"># Original script was: case &quot;$&#123;1&#125;&quot; in hibernate|suspend)</span><br><span class="line"></span><br><span class="line">case $1/$2 in</span><br><span class="line">  pre/*)</span><br><span class="line">    echo &quot;$0: Going to $2...&quot;</span><br><span class="line">    echo -n &apos;&apos; &gt; $TMPLIST</span><br><span class="line">          for i in `ls /sys/bus/pci/drivers/xhci_hcd/ | egrep &apos;[0-9a-z]+\:[0-9a-z]+\:.*$&apos;`; do</span><br><span class="line">              # Unbind xhci_hcd for first device XXXX:XX:XX.X:</span><br><span class="line">               echo -n &quot;$i&quot; | tee /sys/bus/pci/drivers/xhci_hcd/unbind</span><br><span class="line">           echo &quot;$i&quot; &gt;&gt; $TMPLIST</span><br><span class="line">          done</span><br><span class="line">        ;;</span><br><span class="line">  post/*)</span><br><span class="line">    echo &quot;$0: Waking up from $2...&quot;</span><br><span class="line">    for i in `cat $TMPLIST`; do</span><br><span class="line">              # Bind xhci_hcd for first device XXXX:XX:XX.X:</span><br><span class="line">              echo -n &quot;$i&quot; | tee /sys/bus/pci/drivers/xhci_hcd/bind</span><br><span class="line">    done</span><br><span class="line">    rm $TMPLIST</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<p>如果想在系统在suspend时usb不suspend 还能继续供电的话可以修改/etc/tlp.conf添加:　USB_AUTOSUSPEND=0 即可</p>
<h2 id="让蓝牙不autosuspend或者通过蓝牙唤醒suspend系统-not-work"><a href="#让蓝牙不autosuspend或者通过蓝牙唤醒suspend系统-not-work" class="headerlink" title="让蓝牙不autosuspend或者通过蓝牙唤醒suspend系统(not work)"></a>让蓝牙不autosuspend或者通过蓝牙唤醒suspend系统(not work)</h2><p>现在的问题是不是唤醒之后蓝牙有问题，而是蓝牙无法唤醒suspend系统。我的问题如同的描述　－　<a href="https://unix.stackexchange.com/questions/609438/how-can-i-use-a-usb-keyboard-or-mouse-to-wake-from-suspend" target="_blank" rel="external">https://unix.stackexchange.com/questions/609438/how-can-i-use-a-usb-keyboard-or-mouse-to-wake-from-suspend</a><br>将下面语句添加到rc.local中去，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo enabled &gt; /sys/bus/usb/devices/3-11/power/wakeup</span><br></pre></td></tr></table></figure>
<p>或者使用udev，但都不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#lsusb -tv |grep btusb -A1</span><br><span class="line">vim /etc/udev/rules.d/80-persistent-usb.rules</span><br><span class="line">ACTION==&quot;add&quot;, SUBSYSTEM==&quot;usb&quot;, ATTRS&#123;idVendor&#125;==&quot;8087&quot;, ATTRS&#123;idProduct&#125;==&quot;07dc&quot; RUN+=&quot;/bin/sh -c &apos;echo enabled &gt; /sys/bus/usb/devices/3-11/power/wakeup&apos;&quot;</span><br><span class="line">sudo update-initramfs -u</span><br></pre></td></tr></table></figure></p>
<p>下面是不让蓝牙进入autosuspend的方法，但也不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lsusb -tv</span><br><span class="line">grep . /sys/bus/usb/devices/*/product</span><br><span class="line"></span><br><span class="line">root@t440p:~# grep -r &apos;auto&apos; /etc/rc.local</span><br><span class="line"># disable bluetooth&apos;s autosuspend - dmesg |grep blue</span><br><span class="line">echo -1 &gt;/sys/bus/usb/devices/3-11/power/autosuspend_delay_ms</span><br><span class="line"></span><br><span class="line">root@t440p:~# grep -r &apos;IdleTimeout&apos; /etc/bluetooth/input.conf</span><br><span class="line">IdleTimeout=0</span><br><span class="line">root@t440p:~# grep -r &apos;FastConnectable&apos; /etc/bluetooth/main.conf</span><br><span class="line">FastConnectable = true</span><br><span class="line"></span><br><span class="line">sudo systemctl restart bluetooth</span><br><span class="line">sudo systemctl suspend  #or sudo pm-suspend</span><br><span class="line"></span><br><span class="line">#https://blog.csdn.net/weixin_43971560/article/details/100591034</span><br><span class="line">sudo apt-get install --reinstall xserver-xorg-input-all</span><br></pre></td></tr></table></figure></p>
<p>下面的也不work<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># chmod a+x /usr/lib/pm-utils/sleep.d/45fixbluetoothwakeup</span><br><span class="line">#!/bin/bash</span><br><span class="line">case $1 in</span><br><span class="line">    hibernate)</span><br><span class="line">            echo &quot;Going to suspend to disk!&quot;</span><br><span class="line">            ;;</span><br><span class="line">    suspend)</span><br><span class="line">            /etc/init.d/bluetooth start</span><br><span class="line">            echo enabled &gt; /sys/bus/usb/devices/3-11/power/wakeup</span><br><span class="line">            /sbin/modprobe btusb</span><br><span class="line">            echo &quot;Suspending to RAM.&quot;</span><br><span class="line">            ;;</span><br><span class="line">    thaw)</span><br><span class="line">            echo &quot;Suspend to disk is now over!&quot;</span><br><span class="line">            ;;</span><br><span class="line">    resume)</span><br><span class="line">            /etc/init.d/bluetooth start</span><br><span class="line">            echo &quot;We are now resuming.&quot;</span><br><span class="line">            ;;</span><br><span class="line">    *)</span><br><span class="line">            echo &quot;Somebody is callin me totally wrong.&quot;</span><br><span class="line">            ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p>
<p>这个网页的方法（<a href="http://www.thedreaming.org/2020/11/13/ubuntu-mac-bluetooth-wake/）也不work" target="_blank" rel="external">http://www.thedreaming.org/2020/11/13/ubuntu-mac-bluetooth-wake/）也不work</a>, 它会交/sys/devices/pci0000:00/0000:00:14.0/usb3/3-11/power/wakeup设置成enabled, 它会让它一进入suspend马上就又唤醒了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">root@t440p:~# lsusb -tv |grep btusb -A1</span><br><span class="line">    |__ Port 11: Dev 5, If 0, Class=Wireless, Driver=btusb, 12M</span><br><span class="line">        ID 8087:07dc Intel Corp.</span><br><span class="line">    |__ Port 11: Dev 5, If 1, Class=Wireless, Driver=btusb, 12M</span><br><span class="line">        ID 8087:07dc Intel Corp.</span><br><span class="line">root@t440p:~# lsusb |grep 8087:07dc</span><br><span class="line">Bus 003 Device 005: ID 8087:07dc Intel Corp.</span><br><span class="line"></span><br><span class="line">root@t440p:~# lsusb -v -s 003:005 |grep &apos;id&apos;</span><br><span class="line">  idVendor           0x8087 Intel Corp.</span><br><span class="line">  idProduct          0x07dc</span><br><span class="line">root@t440p:~# lsusb -v -d 8087:07dc |grep -i bus</span><br><span class="line">Bus 003 Device 005: ID 8087:07dc Intel Corp.</span><br><span class="line"></span><br><span class="line">#DEVPATH is /devices/pci0000:00/0000:00:14.0/usb3/3-11</span><br><span class="line">root@t440p:~# udevadm info -q path -n /dev/bus/usb/003/005</span><br><span class="line">/devices/pci0000:00/0000:00:14.0/usb3/3-11</span><br><span class="line">root@t440p:~# udevadm info -a -p $(udevadm info -q path -n /dev/bus/usb/003/005)</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">root@t440p:~# cat /sys/devices/pci0000:00/0000:00:14.0/usb3/3-11/power/wakeup</span><br><span class="line">enabled</span><br><span class="line"></span><br><span class="line">https://blog.csdn.net/quqi99/article/details/78729252</span><br><span class="line">#  /usr/local/sbin/enable-wakeup /sys/devices/pci0000:00/0000:00:14.0/usb3/3-11/power/wakeup</span><br><span class="line">root@t440p:~# cat /etc/udev/rules.d/80-persistent-usb.rules</span><br><span class="line">SUBSYSTEM==&quot;usb&quot;, ATTRS&#123;idVendor&#125;==&quot;8087&quot;, ATTRS&#123;idProduct&#125;==&quot;07dc&quot; RUN+=&quot;/usr/local/sbin/enable-wakeup $env&#123;DEVPATH&#125;&quot;</span><br><span class="line">#don&apos;t forget to run: sudo update-initramfs -u</span><br><span class="line"># https://unix-memo.readthedocs.io/en/latest/udev.html</span><br><span class="line">#test it by: udevadm test /devices/pci0000:00/0000:00:14.0/usb3/3-11</span><br><span class="line"></span><br><span class="line">root@t440p:~# cat /usr/local/sbin/enable-wakeup</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line"># Script to enable a USB devices to be used to resume computer from sleep</span><br><span class="line">#</span><br><span class="line"># Depends on udevadm package</span><br><span class="line"># 09/05/2012 - V1.0 by Nicolas Bernaerts</span><br><span class="line"></span><br><span class="line"># if device has been removed, exit</span><br><span class="line">[ &quot;$ACTION&quot; = &quot;remove&quot; ] &amp;&amp; exit 0</span><br><span class="line"></span><br><span class="line"># set PATH as it is not set for udev scripts</span><br><span class="line">PATH=&quot;/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line"></span><br><span class="line"># set device SYSFS path</span><br><span class="line">DEVICE_SYSFS=&quot;/sys$1&quot;</span><br><span class="line">CURRENT_SYSFS=$DEVICE_SYSFS</span><br><span class="line"></span><br><span class="line"># get device product and vendor name from parent SYSFS</span><br><span class="line">DEVICE_VENDOR=`udevadm info --query=all -p &quot;$CURRENT_SYSFS/../&quot; | grep &quot;ID_VENDOR_ID=&quot; | cut -d &quot;=&quot; -f 2`</span><br><span class="line">DEVICE_PRODUCT=`udevadm info --query=all -p &quot;$CURRENT_SYSFS/../&quot; | grep &quot;ID_MODEL_ID=&quot; | cut -d &quot;=&quot; -f 2`</span><br><span class="line">DEVICE_LABEL=`lsusb | grep &quot;$&#123;DEVICE_VENDOR&#125;:$&#123;DEVICE_PRODUCT&#125;&quot; | sed &apos;s/^.*[0-9a-f]\:[0-9a-f]* \(.*\)$/\1/g&apos;`</span><br><span class="line"></span><br><span class="line"># loop thru the SYSFS path, up to PCI bus</span><br><span class="line">CARRY_ON=1</span><br><span class="line">while [ $CARRY_ON -eq 1 ]</span><br><span class="line">do</span><br><span class="line">  # get the first three letters of current SYSFS folder</span><br><span class="line">  FIRST_LETTERS=`basename $CURRENT_SYSFS | sed &apos;s/^\(...\).*$/\1/g&apos;`</span><br><span class="line"></span><br><span class="line">  # if current SYSFS is PCI bus, stop the loop</span><br><span class="line">  if [ &quot;$FIRST_LETTERS&quot; = &quot;pci&quot; ] || [ &quot;$FIRST_LETTERS&quot; = &quot;/&quot; ] ; then</span><br><span class="line">    CARRY_ON=0</span><br><span class="line"></span><br><span class="line">  # else,</span><br><span class="line">  else</span><br><span class="line">    # if possible, enable wakeup for current SYSFS</span><br><span class="line">    WAKEUP_FILE=&quot;$&#123;CURRENT_SYSFS&#125;/power/wakeup&quot;</span><br><span class="line">    if [ -f $WAKEUP_FILE ]; then</span><br><span class="line">      echo &quot;enabled&quot; &gt; $WAKEUP_FILE</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # go to father directory of current SYSFS</span><br><span class="line">    CURRENT_SYSFS=`dirname $CURRENT_SYSFS`</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># log the action</span><br><span class="line">LOG_HEADER=&quot;USB device $&#123;DEVICE_VENDOR&#125;:$&#123;DEVICE_PRODUCT&#125;&quot;</span><br><span class="line">logger &quot;$&#123;LOG_HEADER&#125; - Description : $&#123;DEVICE_LABEL&#125;&quot;</span><br><span class="line">logger &quot;$&#123;LOG_HEADER&#125; - SysFS path  : $&#123;DEVICE_SYSFS&#125;&quot;</span><br><span class="line">logger &quot;$&#123;LOG_HEADER&#125; - Device is enabled to handle suspend/resume&quot;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>下面两个设置了运行’systemctl suspend’后再敲蓝牙键盘不会有任何反应：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># grep . /sys/bus/usb/devices/*/power/wakeup</span><br><span class="line">echo enabled &gt; /sys/bus/usb/devices/3-11/power/wakeup</span><br><span class="line">echo enabled &gt; /sys/devices/pci0000:00/0000:00:14.0/usb3/3-11/power/wakeup</span><br></pre></td></tr></table></figure></p>
<p>下面设置了之后再suspend之后不敲蓝牙键盘也马上会wakeup无法使用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo enabled &gt; /sys/bus/usb/devices/usb3/power/wakeup</span><br></pre></td></tr></table></figure></p>
<p>看来目前使用蓝牙键盘唤醒suspend系统是不可能的了，放弃，将suspend改为1小时这样短途休息时不用suspend，第二天要唤醒时使用电源键或者专门买一个无线鼠标来专门用于唤醒。</p>
<h2 id="Another-post"><a href="#Another-post" class="headerlink" title="Another post"></a>Another post</h2><p><a href="https://blog.csdn.net/quqi99/article/details/103754977" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/103754977</a><br><a href="https://zhhuabj.blog.csdn.net/article/details/83109470" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/83109470</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://askubuntu.com/questions/822249/unpair-remove-bluetooth-devices-in-16-04-1-and-other-problems" target="_blank" rel="external">https://askubuntu.com/questions/822249/unpair-remove-bluetooth-devices-in-16-04-1-and-other-problems</a><br>[2] <a href="http://events17.linuxfoundation.org/sites/events/files/slides/Bluetooth%20on%20Modern%20Linux_0.pdf" target="_blank" rel="external">http://events17.linuxfoundation.org/sites/events/files/slides/Bluetooth%20on%20Modern%20Linux_0.pdf</a><br>[3] <a href="https://medium.com/@overcode/fixing-bluetooth-in-ubuntu-pop-os-18-04-d4b8dbf7ddd6" target="_blank" rel="external">https://medium.com/@overcode/fixing-bluetooth-in-ubuntu-pop-os-18-04-d4b8dbf7ddd6</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/Ubuntu-18-04安装全面战争三国游戏/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/02/Ubuntu-18-04安装全面战争三国游戏/" itemprop="url">Ubuntu 18.04安装全面战争三国游戏</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-02T12:30:47+08:00">
                2021-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2019-08-02<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository multiverse</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y libvulkan1 libvulkan-dev mesa-vulkan-drivers</span><br><span class="line">#sudo add-apt-repository ppa:graphics-drivers/ppa  #Use latest version</span><br><span class="line">sudo lshw -c display             #By default, the opensource nouveau driver is being used for Nvidia card.</span><br><span class="line">sudo ubuntu-drivers devices      #List available driver for your Nvidia card from the default Ubuntu repo.</span><br><span class="line">sudo ubuntu-drivers autoinstall  #Or run: sudo apt install nvidia-driver-390</span><br><span class="line">#sudo apt purge nvidia-*</span><br><span class="line">sudo shutdown -r now</span><br><span class="line">sudo lshw -c display</span><br><span class="line">prime-select query</span><br><span class="line"></span><br><span class="line">sudo prime-select intel</span><br><span class="line">sudo prime-select nvidia</span><br><span class="line">watch -n 1 nvidia-smi</span><br><span class="line"></span><br><span class="line">sudo cpupower -c all frequency-set -g performance</span><br><span class="line">echo &apos;GOVERNOR=&quot;performance&quot;&apos; | sudo tee /etc/default/cpufrequtils</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">sudo systemctl restart cpufrequtils</span><br><span class="line">sudo systemctl disable ondemand</span><br><span class="line"></span><br><span class="line">sudo apt install -y steam</span><br><span class="line">mkdir -p /game/.steam &amp;&amp; rm -rf ~/.steam &amp;&amp; ln -s /game/.steam ~/.steam</span><br><span class="line">steam</span><br><span class="line"></span><br><span class="line">#optimize the performance</span><br><span class="line">sudo add-apt-repository ppa:samoilov-lex/gamemode</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install -y gamemode</span><br><span class="line"># then open &apos;NVIDIA X Server Settings&apos; program, and set &apos;Enable FXAA&apos;</span><br><span class="line"></span><br><span class="line">https://support.feralinteractive.com/docs/zh_cn/threekingdomstw/1.0.4/linux/faqs/?access=zooevrj6xb&amp;utm_source=game_linux&amp;utm_medium=link&amp;utm_campaign=game_linux_threekingdomstw_support#i_linux_graphics_drivers</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/CPU-governor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/02/CPU-governor/" itemprop="url">CPU governor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-02T12:15:20+08:00">
                2021-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2019-04-25)</strong></p>
<h2 id="performance-and-powersave"><a href="#performance-and-powersave" class="headerlink" title="performance and powersave"></a>performance and powersave</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># we can set CPU governor in BIOS or Power Mangement Program or the following Linux commands</span><br><span class="line">sudo apt install cpufrequtils sysfsutils linux-tools-generic -y</span><br><span class="line"># all cpu info</span><br><span class="line">cpufreq-info</span><br><span class="line"># cpu info for just cpu0</span><br><span class="line">cpupower frequency-info</span><br><span class="line"># just set cpu0 to performance mode</span><br><span class="line">sudo cpufreq-set -g performance</span><br><span class="line"># set all cpu to powersave mode</span><br><span class="line">sudo cpupower -c all frequency-set -g powersave</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_min_freq</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq</span><br><span class="line">cat /proc/cpuinfo | grep -i &quot;cpu mhz&quot;</span><br><span class="line"></span><br><span class="line"># How to persistence these configurations</span><br><span class="line">sudo sed -i &apos;s/^GOVERNOR=.*/GOVERNOR=&quot;powersave&quot;/&apos;/etc/init.d/cpufrequtils</span><br><span class="line"># or</span><br><span class="line">echo &apos;GOVERNOR=&quot;powersave&quot;&apos; | sudo tee/etc/default/cpufrequtils</span><br><span class="line"></span><br><span class="line">sudo systemctl restart cpufrequtils</span><br><span class="line">sudo systemctl disable ondemand</span><br></pre></td></tr></table></figure>
<h2 id="userspace-and-ondemand"><a href="#userspace-and-ondemand" class="headerlink" title="userspace and ondemand"></a>userspace and ondemand</h2><p>This is because your system is using the new driver called intel_pstate. There are only two governors available when using this driver: powersave and performance.<br>The userspace governor is only available with the older acpi-cpufreq driver (which will be automatically used if you disable intel_pstate at boot time; you then set the governor/frequency with cpupower):</p>
<p>disable the current driver: add intel_pstate=disable to your kernel boot line<br>boot, then load the userspace module: modprobe cpufreq_userspace<br>set the governor: cpupower frequency-set –governor userspace<br>set the frequency: cpupower –cpu all frequency-set –freq 800MHz<br>NOTE:　还是要intel-pstate驱动吧，因为：</p>
<ul>
<li>intel_pstate驱动程序知道CPU工作方式的详细信息，并且比通用ACPI解决方案做得更好</li>
<li>intel_pstate仅提供两个调控器，powersave而performance。英特尔声称intel_pstate的“省电”速度比具有“性能”的通用acpi调速器快</li>
</ul>
<h2 id="openwrt-setting"><a href="#openwrt-setting" class="headerlink" title="openwrt setting"></a>openwrt setting</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for core in $(seq 0 &quot;$(($(getconf _NPROCESSORS_ONLN) - 1))&quot;); do</span><br><span class="line">echo &#123;performance|powersave&#125; &gt;/sys/devices/system/cpu/cpu$core/cpufreq/scaling_governor ;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/GSO-TSO-GRO等对VirtIO虚机的网络性能影响分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/02/GSO-TSO-GRO等对VirtIO虚机的网络性能影响分析/" itemprop="url">GSO/TSO/GRO等对VirtIO虚机的网络性能影响分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-02T09:57:34+08:00">
                2021-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-04-05<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</p>
<p>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>IP层叫分片，TCP/UDP层叫分段。网卡能做的事（TCP/UDP组包校验和分段，IP添加包头校验与分片）尽量往网卡做，网卡不能做的也尽量迟后分片（发送）或提前合并片（接收）来减少在网络栈中传输和处理的包数目，从而减少数据传输和上下文切换所需要的CPU计算时间。</p>
<p>发数据<br>TSO(TCP分段，TCP Segmentation Offload)在TCP处做，UFO(UDP分片，UDP Fragmentation Offload）因为UDP不支持分段所以移到下层的IP层做分片。TSO是使得网络协议栈能够将大块buffer推送至网卡，然后网卡执行分片工作，这样减轻了CPU 的负荷，但TSO需要硬件来实现分片功能；</p>
<p>GSO(Generic Segmentation Offload)比TSO更通用，基本思想就是尽可能的推迟数据分片直至发送到网卡驱动之前，如果硬件不支持TSO分段则由dev_hard_start_xmit中的dev_gso_segment先软件分段的segs赋值给skb-&gt;next（skb-&gt;next = segs）, 如果网卡硬件支持分段则直接将GSO大帧（skb-next)传给网卡驱动(dev_hard_start_xmit中的ndo_start_xmit)（所以它传给virtio驱动的是GSO大帧），然后继续进行IP分片后再发往网卡。GSO自动检测网卡支持特性， 硬件不支持也可以使用GSO它更通用（TSO一定需要硬件支持）。当打开GSO时，GSO会在xmit那块做GSO分片时调用TCP/UDP的回调函数自动添加TCP/UDP头（不使用GSO的只有第一个分片有TCP/UDP头，后面接着的分片是没有的，这也是为什么在虚机里打开TSO/GSO时对于隧道会多出一块数据的原因），然后再调IP层回调函数为每个分片添加IP头。<br>命令(ethtool -K eth0 tso|gso off|on)可打开或关闭网卡驱动的gso/tso特性：</p>
<p>1, 物理网卡不支持GSO时, 使用TSO时TCP分段在驱动处调用硬件做，不使用TSO时TCP分段在TCP协议处软件做。<br>2, 物理网卡不支持UFO时，使用GSO时在发送给驱动前一刻做，不使用GSO在IP层软件做。<br>3, 物理网卡不支持TSO时，使用GSO时在发送给驱动前一刻做，不使用GSO在TCP层软件做。</p>
<p>TSO与GSO的重要区别</p>
<p>1, TSO只有第一个分片有TCP头和IP头，接着的分段只有IP头。意味着第一个分段丢失，所有分段得重传。<br>2, GSO在分段时会调用TCP或UDP的回调函数(udp4_ufo_fragment)为每个分段都加上IP头，由于分段是通过mss设置的（mss由发送端设置），所以长度仍然可能超过mtu值，所以在IP层还得再分片(代码位于dev_hard_start_xmit)。</p>
<p>收数据<br>LRO(Large Receive Offload），TSO是发，LRO是收。将多个TCP分段聚合成一个skb结构，以减小上层协议栈的skb的开销。skb的数据保存在skb-&gt;data中，分段的数据保存在skb_shared_info-&gt;frag_list中。<br>GRO(Generic Receive Offloading)，GSO是发，GRO是收。LRO使用发送方和目的地IP地址，IP封包ID，L4协议三者来区分段，对于从同一个SNAT域的两个机器发向同一目的IP的两个封包可能会存在相同的IP封包ID（因为不是全局分配的ID），这样会有所谓的卷绕的bug。GRO采用发送方和目的地IP地址，源/目的端口，L4协议三者来区分作为改进。所以对于后续的驱动都应该使用GRO的接口，而不是LRO。另外，GRO也支持多协议。<br>1, 物理网卡不支持GRO时, 使用LRO在驱动处合并了多个skb一次性通过网络栈，对CPU负荷的减轻是显然的。<br>2, 物理网卡不支持LRO时，使用GRO在从驱动接收数据那一刻合并了多个skb一次性通过网络栈，对CPU负荷的减轻是显然的。</p>
<p>性能影响<br>性能依次是：客户机和宿主机GSO/TSO/UFO都打开 &gt; 客户机打开宿主机关闭 &gt; 客户机宿主机都关闭。</p>
<p>对TCP来说，在CPU资源充足的情况下，TSO/GSO 能带来的效果不大，但是在CPU资源不足的情况下，其带来的改观还是很大的。<br>对UDP来说，其改进效果一般，改进效果不超过20%。所以在VxLAN环境中，其实是可以把GSO关闭，从而避免它带来的一些潜在问题。</p>
<p>Offloading 带来的潜在问题<br>分段offloading可能会带来潜在的问题，比如网络传输的延迟latency，因为packets的大小的增加，大大增加了driver queue的容量（capacity）。比如说，系统一方面在使用大的packet size传输大量的数据，同时在运行许多的交换式应用（interactive application）。因为交互式应用会定时发送许多小的packet，这时候可能会应为这些小的packets被淹没在大的packets之中，需要等待较长的时间才能被处理，这可能会带来不可接受的延迟。在网络上也能看到一些建议，在使用这些offloading技术时如果发现莫名的网络问题，建议先将这些技术关闭后再看看情况有没有改变。</p>
<h1 id="ethtool-K-interface-gso-off"><a href="#ethtool-K-interface-gso-off" class="headerlink" title="ethtool -K interface gso off"></a>ethtool -K interface gso off</h1><h1 id="ethtool-K-interface-tso-off"><a href="#ethtool-K-interface-tso-off" class="headerlink" title="ethtool -K interface tso off"></a>ethtool -K interface tso off</h1><p>VirtIO<br>在guest中有virtio前端驱动, 如针对网络的virtio-net，和其他驱动如virtio-pci等共同经过virt-queue的notify的trap中断到主机的hypervisor中执行host中面向guest前端驱动的api接口与后端驱动(virtio-backend driver)。guest内核的rx0与tx0两个队列与host的rx与tx两个队列通过socket共享内存交换数据。</p>
<p>下面是如何打开virtqueue的调试功能</p>
<p>echo -n “func virtqueue_add +flmpt” | sudo tee /sys/kernel/debug/dynamic_debug/control<br>sudo cat /sys/kernel/debug/dynamic_debug/control | grep virtio<br>这样能看到 virtqueue_add() 函数的信息：<br>drivers/virtio/virtio_ring.c:294 [virtio_ring]virtqueue_add =pmflt “Added buffer head %i to %p\012”<br>drivers/virtio/virtio_ring.c:236 [virtio_ring]virtqueue_add =pmflt “Can’t add buf len %i - avail = %i\012”</p>
<p>vxlan的实现</p>
<p>从guest出来的tcp数据到达host的vxlan driver时会调用vxlan_xmit, 它的主要逻辑是获取 vxlan dev，然后为 sk_buff 中的每一个skb调用vxlan_xmit_skb方法, vlan_xmit_skb除了计算 tos，ttl，df，src_port，dst_port，md，flags等以外，也调用skb_set_inner_protocol(skb, htons(ETH_P_TEB))设置GSO参数。最后调用udp_tunnel_xmit_skb将skb传给udp tunnel协议栈继续处理。<br>这样也就进了IP层的ip_finish_output_gso，如果硬件支持，则由硬件调用linux内核中的UDP GSO函数（当有GSO时，由 UDP协议栈提供UDP分片逻辑而不是IP分片逻辑，这使得每个分片都有完整的UDP包头，然后继续IP层的GSO分片。所以GSO本身是对UFO的优化）；如果硬件不支持，则在进入device driver queue之前由linux内核调用UDP GSO分片函数，然后再一直往下到网卡。<br>static int ip_finish_output_gso(struct net <em>net, struct sock </em>sk,<br>struct sk_buff *skb, unsigned int mtu){<br>…</p>
<p>   #调用回调函数, 对于UDP则是调用UDP的gso_segment回调函数进行UDP GSO分段<br>   segs = skb_gso_segment(skb, features &amp; ~NETIF_F_GSO_MASK);<br>   …<br>do {<br>struct sk_buff *nskb = segs-&gt;next;<br>int err;<br>segs-&gt;next = NULL;</p>
<pre><code>#有必要则IP分片，因为UDP GSO是按照MSS进行，MSS还是有可能超过IP分段所使用的host物理网卡MTU
</code></pre><p>err = ip_fragment(net, sk, segs, mtu, ip_finish_output2);<br>if (err &amp;&amp; ret == 0)<br>ret = err;<br>segs = nskb;<br>} while (segs);</p>
<p>这里是udp_offload.c中定义的回调函数：<br>static const struct net_offload udpv4_offload = {<br>.callbacks = {<br>.gso_segment = udp4_ufo_fragment,<br>                …<br>},<br>};<br>可见，在整个过程中，有客户机上TCP协议层设置的skb_shinfo(skb)-&gt;gso_size始终保持不变为MSS，因此，在网卡中最终所做的针对UDP GSO数据报的GSO分片所依据的分片的长度还是根据skb_shinfo(skb)-&gt;gso_size的值即TCP MSS，所以vxlan协议有一个问题，即host的IP分片是根据geuest中TCP连接的MSS来进行的。</p>
<p>从geust到host的包流向</p>
<p>1, netif_needs_gso先判断网卡是否支持GSO（guest里的virtio nic肯定支持），if(unlikely(foo))认为foo通常为0， 所以如果网卡支持TSO时dev_gso_segment将返回0（skb-&gt;next==NULL)，也就是说，当guest网卡的GSO特性打开时，guest会直接将没有分段的GSO大帧传递到virtio-net driver中。<br>int dev_hard_start_xmit(struct sk_buff <em>skb, struct net_device </em>dev,<br>struct netdev_queue <em>txq)<br>{<br>…<br>if (netif_needs_gso(skb, features)) {<br>if (unlikely(dev_gso_segment(skb, features)))<br>goto out_kfree_skb;<br>if (skb-&gt;next)<br>goto gso;<br>}<br>gso:<br>do {<br>struct sk_buff </em>nskb = skb-&gt;next;<br>skb-&gt;next = nskb-&gt;next;<br>…<br>rc = ops-&gt;ndo_start_xmit(nskb, dev);<br>…<br>} while (skb-&gt;next);</p>
<p>static int dev_gso_segment(struct sk_buff <em>skb, netdev_features_t features)<br>{<br>struct sk_buff </em>segs;<br>segs = skb_gso_segment(skb, features);</p>
<p>/<em> Verifying header integrity only. </em>/<br>if (!segs)<br>return 0;<br>skb-&gt;next = segs;<br>DEV_GSO_CB(skb)-&gt;destructor = skb-&gt;destructor;<br>skb-&gt;destructor = dev_gso_skb_destructor;<br>return 0;<br>}</p>
<p>2, virtio_net.c中的如下代码定义了virtio-net driver的xmit函数为start_xmit，它会直接将这个GSO大帧通过vring(&lt;=64K)传给host上的virtio backend driver.<br>static const struct net_device_ops virtnet_netdev = {<br>        …<br>.ndo_start_xmit      = start_xmit,</p>
<p>3, 然后host上的tap和bridge都会原封不动动转发这个GSO大帧(payload, inner-tcp, inner-ip, inner-ethernet)。</p>
<p>4, host上的vxlan driver在原GSO大帧上添加vxlan帧头，从(payload, inner-tcp, inner-ip, inner-ethernet)变成(payload, inner-tcp, inner-ip, inner-ethernet, vxlan)。</p>
<p>5, 如果host不支持GSO，那么在host的IP层直接对外层的UDP分片，注意：只有第1个分片有UDP头，接下来的分片没有UDP头。<br>   分片1： payload, inner-tcp, inner-ip, inner-ethernet, vxlan，outer-udp, outer-ip<br>   分片2： payload, inner-tcp, inner-ip, inner-ethernet, vxlan，outer-ip</p>
<p>6, 如果host支持GSO，在host的dev_hard_start_xmit处（代码回到第1步），如果物理网卡支持TSO直接将大帧(payload, inner-tcp, inner-ip, inner-ethernet, vxlan)将给物理网卡的TSO去硬件分片。如果物理网卡不支持TSO将调用skb_gso_segment软件执行GSO。GSO由于会调用UDP的回调函数，但vxlan没有GSO回调函数，所以这里的GSO分片应该每一个分片都有UDP头部，但是只有第一个分片有vxlan头部。<br>   分片1： payload, inner-tcp, inner-ip, inner-ethernet, vxlan，outer-udp, outer-ip<br>   分片2： payload, inner-tcp, inner-ip, inner-ethernet，outer-udp, outer-ip</p>
<p>7, 但是host的物理网卡是根据mss(由sender确定，也就是guest设定,而不是由mtu设定）发给远端的。host打开GSO增加outer-udp时可能会造成包大于mss值从而继续在添加outer-ip时做ip分片。所以redhat的最佳实践要求关闭host机上的GSO特性。</p>
<p>从host到guest的包流向<br>1, 如果host上的GRO打开的话，host上的物理网卡要先将分片重组合并成一个大的GRO包。</p>
<p>2, 包在过路由器时，conntrack需要将分段重组后使用防火墙规则检查，为防止攻击，路由器会有定时器设置一段时间没有做完分段重组就会丢弃清理相应的内存资源，下面参数可以设置分段使用的内存量和<br>hua@node1:~$ cat /proc/sys/net/ipv4/ipfrag_high_thresh  #一旦达到最高内存分配值，其它分段将被丢弃，直到达到最低内存分配值。<br>4194304<br>hua@node1:~$ cat /proc/sys/net/ipv4/ipfrag_low_thresh<br>3145728<br>hua@node1:~$ cat /proc/sys/net/ipv4/ipfrag_time<br>30<br>具体到openstack的网络节点，数据流向是：<br>eth0(pysical nic for public network) -&gt; br-ex (maybe a linux bridge) -&gt; qg-XXX -&gt; qr-XXX -&gt; br-int (ovs bridge) -&gt; ovs-patch-ports -&gt; br-tun (for stt tunnel) -&gt; eth1(pysical nic for management network)<br>如eth0, eth1的mtu是9000的话，若host的GRO打开的话，eth0收到数据会会分段重组成一个大GRO帧：<br>1, 如果br-ex是linux bridge，且net.bridge.bridge-nf-call-arptables = 1，在br-ex上就会分段重组然后使用qg-xxx的mtu=1500再进行分片。<br>2, 即使br-ex不是linux bridge，eth0在重组后做完防火墙后再使用9000再重新分片， 再传到后面1500的虚拟设备又会重组。<br>所以如果mtu设置不当，还不如将host上的TSO/GSO/GRO关闭(Redhat这是这样推荐的），这样也不会造成一个大帧反复重组和分片的问题了。</p>
<p>另外就是路由器又和NAT搅和在一起的问题，由于在路由器上可能会重组再分片，路由器为了识别一个包属于哪一个分片，会使用&lt;发送方和接收方IP、IP分段ID，L4协议&gt;五元组来区分，由于SNAT在IP分段ID相同的话会出现来自NAT路由器背后不同机器上的分段的五元组相同的情况。所以后来GRO在TSO的基础上将这个五元组改为：&lt;发送方和接收方IP、TOS/协议字段，L4协议&gt;.</p>
<p>3, 在linux bridge上，如果net.bridge.bridge-nf-call-arptables = 1 ， netfilter conntrack为了做二层的防欺骗检查也需要先分片重组, 然后重新分片（此时分片采用出口NIC的MTU进行分片, 而从geust往host出时的分片采用的是来自guest的mss值）。故不想linux bridge有防火墙功能的话应该设置：<br>net.bridge.bridge-nf-call-arptables = 0<br>net.bridge.bridge-nf-call-ip6tables = 0<br>net.bridge.bridge-nf-call-iptables = 0</p>
<p>4, 另外，包在过路由器时，</p>
<p>5, 然后virtio继续将大帧传入guest.</p>
<p>VMware STT隧道<br>如果现在不是Linux + OVS bridge (ovs bridge支持STT，Linux Bridge不支持STT) + virtio， 而是VMware STT呢？有几个问题要搞清楚：<br>1, STT是加了伪装TCP头利用网卡的TSO特性硬件分片的，所以它走的是TCP，不是UDP（因为很多网卡不支持UDP的硬件分段）。<br>2, NSX Bridge是如何实现的，是否有类似于Linux中的net.bridge.bridge-nf-call-iptables, (tap -&gt; NSX bridge -&gt; ??? -&gt; dev_queue_xmit )<br>    这个网址（<a href="http://blog.scottlowe.org/learning-nvp-nsx/）有一堆关于nsx的介绍，nsx也是用了ovs的，bridge-nf-call-iptables只是linux" target="_blank" rel="external">http://blog.scottlowe.org/learning-nvp-nsx/）有一堆关于nsx的介绍，nsx也是用了ovs的，bridge-nf-call-iptables只是linux</a> bridge的特性，ovs bridge不存在这个特性。但nsx与neutron集成时可能仍然使用tap-&gt;qbr-&gt;qvb-&gt;qvr-&gt;br-int-&gt;ovs-patch-port-&gt;phy-br-eth0，在这里面qbr与phy-br-eth0均有可能是Linux Bridge.<br>3, NSX实现了virtio吗？<br>    上面已回答，nsx仍然使用ovs。virtio是qemu的特性，与nsx无关。</p>
<p>解决办法<br>链连[10]上说：<br>1, 若用隧道guest中设置mtu</p>
<p>2, echo 0 &gt; /proc/sys/net/bridge/bridge-nf-call-iptable (可选，如果有Linux Bridge的话）</p>
<p>3, 关闭host上的GSO, TSO, GRO (如果为使用conntract特性没有关闭bridge-nf-call-iptable的话）</p>
<p>4, 重点关注host机上物理网卡与Linux bridge上的mtu，其他的虚拟网卡的mtu可以默认设置很大如65000 (可选）</p>
<p>5, 也可以试试关闭tx与rx两个offload特性，sudo ethtool –offload eth0 rx off tx off sg off tso off， 注意：在tx与rx打开时，chksum是在硬件网卡处做的，tcpdump的输出“cksum 0x0a2b (incorrect -&gt; xxx”应该是正常的。</p>
<p>juju run –application nova-compute ‘for x in <code>ip netns | cut -f1 -d&quot; &quot;</code>; do ip netns exec $x bash -c “ip link list | sed -e \”s/2: (.<em>)@if.</em>/\1/;t;d\” | while read x; do ethtool –offload \$x rx off tx off sg off tso off; done”; done’</p>
<p>参考</p>
<p>[1] <a href="http://www.pagefault.info/?p=159" target="_blank" rel="external">http://www.pagefault.info/?p=159</a><br>[2] <a href="https://kris.io/2015/10/01/kvm-network-performance-tso-and-gso-turn-it-off/" target="_blank" rel="external">https://kris.io/2015/10/01/kvm-network-performance-tso-and-gso-turn-it-off/</a><br>[3] <a href="http://www.cnblogs.com/sammyliu/p/5227121.html" target="_blank" rel="external">http://www.cnblogs.com/sammyliu/p/5227121.html</a><br>[4] <a href="https://patchwork.ozlabs.org/patch/415791/" target="_blank" rel="external">https://patchwork.ozlabs.org/patch/415791/</a><br>[5] <a href="http://www.ibm.com/developerworks/cn/linux/l-virtio/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-virtio/</a><br>[6] <a href="http://www.cnblogs.com/sammyliu/p/5228581.html" target="_blank" rel="external">http://www.cnblogs.com/sammyliu/p/5228581.html</a><br>[7] <a href="http://royluo.org/2014/08/09/virtio-netdev-send/" target="_blank" rel="external">http://royluo.org/2014/08/09/virtio-netdev-send/</a><br>[8] <a href="https://markmc.fedorapeople.org/virtio-code-review/VirtioCodeReview.pdf" target="_blank" rel="external">https://markmc.fedorapeople.org/virtio-code-review/VirtioCodeReview.pdf</a></p>
<p>[9] <a href="http://blog.csdn.net/majieyue/article/details/7929398" target="_blank" rel="external">http://blog.csdn.net/majieyue/article/details/7929398</a></p>
<p>[10] <a href="https://ask.openstack.org/en/question/58607/poor-network-connection-issue-with-windows-instance/" target="_blank" rel="external">https://ask.openstack.org/en/question/58607/poor-network-connection-issue-with-windows-instance/</a></p>
<p>[11] <a href="https://sokratisg.net/2012/04/01/udp-tcp-checksum-errors-from-tcpdump-nic-hardware-offloading/" target="_blank" rel="external">https://sokratisg.net/2012/04/01/udp-tcp-checksum-errors-from-tcpdump-nic-hardware-offloading/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/01/Thinkpad-T440p安装Linux的种种问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/01/Thinkpad-T440p安装Linux的种种问题/" itemprop="url">Thinkpad T440p安装Linux的种种问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-01T10:27:18+08:00">
                2021-02-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2014-05-08<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>(<a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )<br>Thinkpad T440p里使用了一些最新的硬件，这些硬件厂商对Linux高度不兼容, 下面是安装ubuntu 14.04与win8双系统时遇到的一些问题。<br>1, 要在BIOS（F1键）里disable掉UEFI Security Boot特性, 之前按F12选usb进行安装。<br>   UEFI是下一代的BIOS，它内操置了一些操作系统的公钥，操作系统要用私钥签名，UEFI硬件用公钥检测操作系统的完整性，可信才加载系统。<br>本来是一个很好的技术，但是被微软给滥用了。微软先强制将它自己的公钥加到UEFI DB中，然后再要求厂商预安装Win8之后强制厂商将UEFI Security Boot特性打开，这样就无法安装其他没有公钥的操作系统了，然后强制其它厂商向微软申请公钥，也不允许用户自定义公钥文件。对于一些支持win8的移动硬件，微软甚至都强制不提供disable UEFI Security Boot的开关界面。<br>2, Thinkpad T440p使用了Realtek公司的rtl8192ee 10ec:818b网卡，<br>   root@laptop:/home/hua# lspci -nn |grep Wireless<br>   04:00.0 Network controller [0280]: Realtek Semiconductor Co., Ltd. RTL8192EE PCIe Wireless Network Adapter [10ec:818b]<br>   Realtek公司却没有提供相应的Linux驱动（附录一是一个极不稳定的驱动，基本没法用），也就是目前：<br>   有固件：/lib/firmware/rtlwifi/rtl8192eefw.bin<br>   但无驱动：/lib/modules/3.13.0-24-generic/kernel/drivers/net/wireless/rtlwifi/rtl8192ee/rtl8192ee.ko<br>   Realtec公司的rtl8192ee驱动将出现在linux 3.16版本的内核里，3.16内核目前还没有出，实在没办法解决，只好先又买了个TL-WN725N USB无线网卡对付着用。<br>3, Thinkpad T440p除了主板里的集成显卡以外，还有一个nvidia的显卡，默认使用的是开源的bumblebee驱动，我遇到的会造成这两种问题：<br>   一是例如执行lspci命令之后都会造成所有的usb设备都无法用，如usb网卡，如usb数标。<br>   二是由于acpi call失败造成无法正常关机，且每次造成磁盘数据损坏导致在开机时需要修复</p>
<p>   三是合上电脑再打开桌面消失</p>
<p>   四是发热厉害</p>
<p>   五是不安装它可能启动ubuntu不成功，需要在grub中临时将quiet splash改成nomodeset即可，将nvidea驱动安装后就不需要了。<br>   网上有人遇到了和我一样的问题，见：<a href="https://github.com/Bumblebee-Project/bbswitch/issues/78，但它的办法是在仍然用bumblebee驱动的前提下寻求解决（见附录二），我是直接安装nvidia" target="_blank" rel="external">https://github.com/Bumblebee-Project/bbswitch/issues/78，但它的办法是在仍然用bumblebee驱动的前提下寻求解决（见附录二），我是直接安装nvidia</a> linux驱动（值得一提的是，nvidia也是一个起初对linux极不友好的一家公司，linux之父在公开场合还曾经骂地这家公司，见：<a href="http://www.ithome.com/html/it/19249.htm，但是现在居然有nvidia" target="_blank" rel="external">http://www.ithome.com/html/it/19249.htm，但是现在居然有nvidia</a> linux驱动了，赞一个）。<br>  sudo apt-get purge bumblebee*<br>  sudo apt-get purge libvdpau-va-gl12  sudo apt-get install nvidia-319 nvidia-settings-319 nvidia-prime</p>
<p>20140709更新：</p>
<p>安装nvidia驱动后在移动电脑时桌面lightadm很容易死，可进控制台（ctrl + alt + f1)后通过apport-cli命令收集日志，或者查看/var/crash的相关日志发现是lightadm crash了，现在的做法是禁用掉nvidia的一切驱动，切换到intel的集成显卡，在/etc/default/grub中更新下列一行，然后更新grub</p>
<p>GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash rdblacklist=nouveau i965.modeset=1 nouveau.modeset”</p>
<p>另外我也更新了kernel到3.14.1-031401-generic</p>
<p>附录一，目前极不稳定的一个rtl8192ee linux驱动<br>参考：<a href="http://ubuntuforums.org/showthread.php?t=2198221" target="_blank" rel="external">http://ubuntuforums.org/showthread.php?t=2198221</a><br>wget <a href="http://netbook-remix.archive.canonical.com/updates/pool/public/o/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms_0017.1016.2013~sutton1.tar.gz" target="_blank" rel="external">http://netbook-remix.archive.canonical.com/updates/pool/public/o/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms/oem-wireless-rtl-92ce-92se-92de-8723ae-88ee-8723be-92ee-dkms_0017.1016.2013~sutton1.tar.gz</a><br>sudo modprobe rtl8192ee<br>sudo modprobe -rv rtl8192ee<br>sudo modprobe -v rtl8192ee swenc=1 fwlps=0 ips=0</p>
<p>附录二，仍使用开源的nvidia驱动nouveau的前提下解决acpi问题<br>git clone <a href="https://github.com/mkottman/acpi_call" target="_blank" rel="external">https://github.com/mkottman/acpi_call</a><br>cd acpi_call<br>make<br>sudo cp acpi_call.ko /lib/modules/<code>uname -r</code>/kernel/drivers/acpi<br>sudo depmod -a<br>sudo modprobe acpi_call<br>Create a script with the following in it (e.g. at /usr/local/bin/disable_nvidia.sh, remember chmod +x it):</p>
<p>#!/bin/sh<br>echo “_SB.PCI0.PEG.VID._DSM {0xF8,0xD8,0x86,0xA4,0xDA,0x0B,0x1B,0x47,0x60,0x42,0xA6,0xB5,0xBE,0xE0} 0x100 0x1A {0x1,0x0,0x0,0x3}” &gt;/proc/acpi/call<br>echo “_SB.PCI0.PEG.VID.GPOF” &gt;/proc/acpi/call<br>exit 0<br>Call the script from /etc/rc.local<br>Add rdblacklist=nouveau i965.modeset=1 nouveau.modeset to the GRUB_CMDLINE_LINUX_DEFAULT flags in /etc/default/grub, also for full KVM support (e.g. better brightness control etc.) I’ve found adding acpi_osi=\”!Windows 2012\” helps too.<br>run sudo update-grub</p>
<p>2014-06-21更新：</p>
<p>解决办法已经出来了，见：</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578</a></p>
<p>2014-07-29更新：</p>
<p>有些型号的机器即使像上面disable UEFI Security Boot特性也是安装不了的，那是因为遇到了一个UEFI的bug，原因如下：</p>
<p>Some EFI-based computers, including some HPs, have broken EFIs that<br>don’t accept anything but the fallback boot loader<br>(EFI/boot/bootx64.efi on the EFI System Partition) or the Windows boot<br>loader (EFI/Microsoft/boot/bootmgfw.efi on the ESP). If yours suffers<br>from this defect, you’ll need to copy EFI/ubuntu/grubx64.efi (or<br>EFI/ubuntu/shimx64.efi, if Secure Boot is active) to one or both of<br>those names. (If Secure Boot is active, also copy<br>EFI/ubuntu/grubx64.efi to the same directory where you copy GRUB, but<br>keep its filename as grubx64.efi).</p>
<p>Note that I’m assuming you’re doing an Ubuntu-only installation. If<br>you want to dual-boot with Windows, you’ve got to copy ITS boot loader<br>to another name and tweak GRUB to find Windows there. This starts to<br>get complex, so the Boot Repair tool<br>(<a href="https://help.ubuntu.com/community/Boot-Repair" target="_blank" rel="external">https://help.ubuntu.com/community/Boot-Repair</a>) may be helpful. It’s<br>got an option to do all this on its Advanced page.</p>
<p>Alternatively, you could install  rEFInd<br>(<a href="http://www.rodsbooks.com/refind" target="_blank" rel="external">http://www.rodsbooks.com/refind</a>) to one of those “magic” locations –<br>but the installation script won’t install there by default, so you’ll<br>need to do it manually or juggle filenames afterwards. (The<br>mvrefind.sh script can help with that.)</p>
<p>2014-12-01更新：</p>
<p>现在ubuntu 14.10默认的内核版本里已经有该网卡的驱动了，我已经用上了，挺好使的。见： <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1239578</a></p>
<p>2015-03-02更新, 解决一crash问题：</p>
<p>之前一直感觉系统容易忽然死机，可能一周一次，没去管它。但今天居然邪门到一个小时内死机6次，不得不深度介入了。根据观察，感觉是Chrome的时候容易死，使用“watch sensors” （需安装sudo dpkg -l |grep sensors 软件包）查看cpu温度在打开chrome之非常容易从56度升到八十几度。于是，不启动chrome，观察两小时，ok，不死机。于是google关键字”ubuntu 14.10 chrome crash”， 非常幸运，找到一个bug （<a href="https://bugs.launchpad.net/ubuntu/+source/mesa/+bug/1377220" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/mesa/+bug/1377220</a> ），原来是chrome新增加了一个根据gpu加速的新特性，针对intel gpu加速不了，退到软加速了，从而导致全局crash的问题。解决办法：修改文件/usr/share/applications/google-chrome.desktop， 将”Exec=/usr/bin/google-chrome-stable”修改成” Exec=env LIBGL_DRI3_DISABLE=1 /usr/bin/google-chrome-stable”即可。</p>
<p>2015-03-03， 像上面那样修改之后，使用htop命令还能看到chrome时不时有gpu字眼的进程蹦出来，这时候温度会上升，于是升级了内核为3.40版本，<a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/</a></p>
<p>20180216更新 - 禁用蓝牙键盘的休眠功能</p>
<p><a href="https://unix.stackexchange.com/questions/177998/bluetooth-mouse-disconnects" target="_blank" rel="external">https://unix.stackexchange.com/questions/177998/bluetooth-mouse-disconnects</a></p>
<p>sudo sed -i ‘s/#IdleTimeout=30/IdleTimeout=0/‘ /etc/bluetooth/input.conf</p>
<p>#$ cat /etc/udev/rules.d/91-local.rules</p>
<p>#ACTION==”add”, SUBSYSTEM==”bluetooth”, ATTR{product}==”Microsoft Bluetooth Mouse        “, ATTR{power/control}=”on”</p>
<p>#sudo udevadm control –reload-rules</p>
<p>sudo apt-get install pulseaudio-module-bluetooth<br>killall pulseaudio<br>rfkill list<br>rfkill unblock xx</p>
<p>20180822更新 - chrome花屏问题</p>
<p>昨晚将ubuntu 16.04升级到ubuntu 18.04之后, 今早发现使用chrome时有轻微花屏, 网上搜索了好多网页都不能解决问题, 最后发现了这个网页(<a href="https://blog.csdn.net/u010665691/article/details/44114119)解决了问题" target="_blank" rel="external">https://blog.csdn.net/u010665691/article/details/44114119)解决了问题</a>. 即在chrome的高级设置中将’Use hardware acceleration when available’前的勾去掉.</p>
<p>20181017更新 - IBM小红点TrackPoint休眠后左键失效问题</p>
<p>注: 其实下面的方法一个也不使, 真正解决问题的是这条命令: </p>
<p>gsettings set org.gnome.desktop.peripherals.touchpad click-method disabled</p>
<p>自从将Ubuntu从16.04升级到18.04之后, 在电脑休眠之后会发现小红点左键失效, 今天终于解决这个头疼的问题. 方法如下:</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1791427" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1791427</a><br><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1788928" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1788928</a></p>
<p>1, comment the line ‘blacklist i2c_i80’ from the file /etc/modprobe.d/blacklist.conf due to the lp bug #1786574</p>
<p>2, configure the management tool tlp not to autosuspend usb<br>$ grep -r ‘USB_AUTO’ /etc/default/tlp<br>USB_AUTOSUSPEND=0<br>USB_AUTOSUSPEND_DISABLE_ON_SHUTDOWN=1</p>
<p>3, upgrade libinput from the page <a href="https://launchpad.net/ubuntu/+source/libinput" target="_blank" rel="external">https://launchpad.net/ubuntu/+source/libinput</a><br>wget <a href="https://launchpad.net/ubuntu/+archive/primary/+files/libinput-bin_1.12.1-1_amd64.deb" target="_blank" rel="external">https://launchpad.net/ubuntu/+archive/primary/+files/libinput-bin_1.12.1-1_amd64.deb</a><br>wget <a href="https://launchpad.net/ubuntu/+archive/primary/+files/libinput10_1.12.1-1_amd64.deb" target="_blank" rel="external">https://launchpad.net/ubuntu/+archive/primary/+files/libinput10_1.12.1-1_amd64.deb</a><br>sudo dpkg -i libinput*</p>
<p>4, <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1560723" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1560723</a></p>
<p>$ sudo chmod 755 /lib/systemd/system-sleep/trackpad<br>$ cat /lib/systemd/system-sleep/trackpad</p>
<p>#!/bin/sh<br>if [ “${1}” == “post” ]; then<br>  echo -n none &gt; /sys/devices/platform/i8042/serio1/drvctl<br>  sleep 1<br>  echo -n reconnect &gt; /sys/devices/platform/i8042/serio1/drvctl<br>fi</p>
<p>5, <a href="https://medium.com/@pck/ubuntu-18-04-fix-for-right-click-not-working-touchpad-issues-40037ff249e1" target="_blank" rel="external">https://medium.com/@pck/ubuntu-18-04-fix-for-right-click-not-working-touchpad-issues-40037ff249e1</a><br>sudo apt install gnome-tweak-tool<br>$ gsettings get org.gnome.desktop.peripherals.touchpad click-method<br>‘fingers’<br>gsettings set org.gnome.desktop.peripherals.touchpad click-method disabled<br>It equals run the command ‘gnome-tweaks’, navigate to the “Keyboard &amp; Mouse” sub-menu in the left menu, and select “Area” from the the touchpad’s “Click Emulation” menu in the right side panel.<br>Also configure Touchpad disable when typing - <a href="https://askubuntu.com/questions/1052665/touchpad-not-getting-disabled-while-typing-on-thinkpad-e450-with-ubuntu-18-04" target="_blank" rel="external">https://askubuntu.com/questions/1052665/touchpad-not-getting-disabled-while-typing-on-thinkpad-e450-with-ubuntu-18-04</a></p>
<p>20201107更新</p>
<p>chrome上网慢用fast.com测速在30K到18M之间不稳定，而用firefox总有69M，但重启机器后，chrome恢复到94M左右。</p>
<p>20210201更新</p>
<p>机器太慢，报：</p>
<p>Feb 1 09:36:48 t440p gnome-shell[3675]: libinput error: client bug: timer event25 debounce: scheduled expiry is in the past (-6ms), your system is too slow</p>
<p>perf data显示它和chrom有关，故设置：</p>
<p>chrome://settings/?search=hardware selects ‘Use hardware acceleration when available’<br>chrome://flags/#disable-accelerated-video-decode selects ‘Hardware-accelerated video decode’</p>
<p>但上面没解决问题，真正解决问题的是disable GPU</p>
<p><a href="https://blog.csdn.net/weixin_39726131/article/details/111653527" target="_blank" rel="external">https://blog.csdn.net/weixin_39726131/article/details/111653527</a></p>
<p>chrome://settings/?search=hardware uncheck ‘Use hardware acceleration when available’<br>chrome://flags/ search ‘gpu’ then disable ‘Accelerated 2D canvas’  and ‘GPU rasterization’</p>
<p>shift + esc to see chrome task</p>
<p>Chrome 浏览器默认开启了“GPU 渲染”的特性，当开启了硬件加速选项之后，所有的 WEB 网页内容都会使用显卡 GPU 来进行解析渲染, 当GPU性能不好时反而慢，不如直接使用CPU</p>
<p>20210202更新 - GPU问题总结<br>shift + esc打开看到GPU Process在开hangout时cpu超100%，另外风扇响个不停(cpu温度从70多升到80多），这都是gpu性能差但chrome又强制打开了gpu硬件加速造成的，关闭gpu加速即可。</p>
<p><a href="https://blog.csdn.net/weixin_39866974/article/details/111653530" target="_blank" rel="external">https://blog.csdn.net/weixin_39866974/article/details/111653530</a></p>
<p>1, 打开chrome://flags/ 搜索GPU，disable掉所有和GPU相关的设置</p>
<p>２，在/usr/share/applications/google-chrome.desktop中添加参数：–disable-gpu –disable-software-rasterizer</p>
<p>20210224改用回到旧版本83.0.4103.116-1</p>
<p>wget <a href="https://www.slimjet.com/chrome/download-chrome.php?file=files%2F83.0.4103.116%2Fgoogle-chrome-stable_current_amd64.deb" target="_blank" rel="external">https://www.slimjet.com/chrome/download-chrome.php?file=files%2F83.0.4103.116%2Fgoogle-chrome-stable_current_amd64.deb</a><br>apt-cache policy google-chrome-stable<br>chrome://flags/   #search ‘gpu’ then reset all setting<br>sudo rm -rf /etc/apt/sources.list.d/google-chrome.list*  #disable auto update</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/30/OpenStack-MTU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/30/OpenStack-MTU/" itemprop="url">OpenStack MTU</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-30T10:31:56+08:00">
                2021-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需要设置mtu的设备类型"><a href="#需要设置mtu的设备类型" class="headerlink" title="需要设置mtu的设备类型"></a>需要设置mtu的设备类型</h2><p>openstack中总共有6种网络设备需要设置mtu:</p>
<ul>
<li>物理交换机和路由, eg: 5000， 手工设置</li>
<li>物理网卡, eg: 5000， nova vif根据network.mtu设置（见最后一节）</li>
<li>隧道接口, eg: 4958, nova vif根据network.mtu设置（见最后一节）</li>
<li>虚机接口, eg: 4958, nova vif根据network.mtu设置（见最后一节）</li>
<li>虚机与br-int之间的peer口由l2-agent中的ovs_use_veth, use_veth_interconnection, veth_mtu三个参数控制。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if self.use_veth_interconnection:</span><br><span class="line">    # enable veth to pass traffic</span><br><span class="line">    int_veth.link.set_up()</span><br><span class="line">    phys_veth.link.set_up()</span><br><span class="line">    if self.veth_mtu:</span><br><span class="line">        # set up mtu size for veth interfaces</span><br><span class="line">        int_veth.link.set_mtu(self.veth_mtu)</span><br><span class="line">        phys_veth.link.set_mtu(self.veth_mtu)</span><br><span class="line">else:</span><br><span class="line">    # associate patch ports to pass traffic</span><br><span class="line">    self.int_br.set_db_attribute(&apos;Interface&apos;, int_if_name,</span><br><span class="line">                                 &apos;options&apos;, &#123;&apos;peer&apos;: phys_if_name&#125;)</span><br><span class="line">    br.set_db_attribute(&apos;Interface&apos;, phys_if_name,</span><br><span class="line">                        &apos;options&apos;, &#123;&apos;peer&apos;: int_if_name&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>虚机里面的虚机网卡, eg: 4958， 如果network中有mtu值，则用于设置dnsmasq。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mtu = getattr(self.network, &apos;mtu&apos;, 0)</span><br><span class="line">if mtu &gt; 0:</span><br><span class="line">    cmd.append(&apos;--dhcp-option-force=option:mtu,%d&apos; % mtu)</span><br></pre></td></tr></table></figure>
<h2 id="四个和mtu相关的配置"><a href="#四个和mtu相关的配置" class="headerlink" title="四个和mtu相关的配置"></a>四个和mtu相关的配置</h2><ol>
<li>Flat/VLAN：Minimum of (global_physnet_mtu or physical_network_mtus)</li>
<li>GRE: Minimum of (global_physnet_mtu, path_mtu) subtract 42</li>
<li>VXLAN: Minimum of (global_physnet_mtu, path_mtu) subtract 50</li>
</ol>
<p>一个例子(neutron.conf)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In the neutron.conf file:</span><br><span class="line">[DEFAULT]</span><br><span class="line">global_physnet_mtu = 9000</span><br><span class="line"></span><br><span class="line">In the openvswitch_agent.ini file:</span><br><span class="line">[ovs]</span><br><span class="line">bridge_mappings = provider1:eth1,provider2:eth2,provider3:eth3</span><br><span class="line"></span><br><span class="line">In the ml2_conf.ini file:</span><br><span class="line">[ml2]</span><br><span class="line">physical_network_mtus = provider2:4000,provider3:1500</span><br><span class="line">path_mtu = 9000</span><br></pre></td></tr></table></figure>
<ol>
<li>physical_network_mtus，仅用于flat与vlan，用于设置物理网络</li>
<li>path_mtu, tenant网络最大可能的mtu，下段代码位于type_tunnel中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_mtu(self, physical_network=None):</span><br><span class="line">    seg_mtu = super(_TunnelTypeDriverBase, self).get_mtu()</span><br><span class="line">    mtu = []</span><br><span class="line">    if seg_mtu &gt; 0:</span><br><span class="line">        mtu.append(seg_mtu)</span><br><span class="line">    if cfg.CONF.ml2.path_mtu &gt; 0:</span><br><span class="line">        mtu.append(cfg.CONF.ml2.path_mtu)</span><br><span class="line">    version = cfg.CONF.ml2.overlay_ip_version</span><br><span class="line">    ip_header_length = p_const.IP_HEADER_LENGTH[version]</span><br><span class="line">    return min(mtu) - ip_header_length if mtu else 0</span><br></pre></td></tr></table></figure>
<ol>
<li>global_physnet_mtu, tenant网络默认的mtu，下列代码中的mtus是来自min(physical_network_mtus, min(path_mtu) - ip_header_length）， get_deployment_physnet_mtu来自global_physnet_mtu，如果没定义physical_network_mtus，则使用默认值global_physnet_mtu，然后用它设置network对象的mtu字段。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">max_mtu = min(mtus) if mtus else p_utils.get_deployment_physnet_mtu()</span><br><span class="line">net_mtu = network_db.get(&apos;mtu&apos;)</span><br><span class="line"># if mtu is not set in database, use the maximum possible</span><br><span class="line">return net_mtu or max_mtu</span><br></pre></td></tr></table></figure>
<ol>
<li>network_device_mtu, 位于os-vif包中，network中没有mtu值时（neutron net-show <net> |grep mtu），用它来决定虚机接口</net></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def _get_mtu(self, vif):</span><br><span class="line">    if vif.network and vif.network.mtu:</span><br><span class="line">        return vif.network.mtu</span><br><span class="line">    return self.config.network_device_mtu</span><br></pre></td></tr></table></figure>
<h2 id="nova-vif"><a href="#nova-vif" class="headerlink" title="nova vif"></a>nova vif</h2><p>上面的参数最终算出了network.mtu, nova vif (LibvirtGenericVIFDriver)需要根据这个值去设置上述的物理网卡，隧道接口，虚机接口的mtu值。但是最新代码似乎没有为ovs类型的虚拟接口设置mtu，这应该是一个bug。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>手动给ovs port设置mtu的命令如下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl --columns=mtu_request list interface</span><br><span class="line">ovs-vsctl set Interface tapddcb4e7e-88 mtu_request=1501</span><br></pre></td></tr></table></figure>
<ol>
<li>检查mtu命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -M do -i 1 -c 2 -s 5000 10.230.56.18</span><br></pre></td></tr></table></figure>
<h2 id="metadata中的mtu问题"><a href="#metadata中的mtu问题" class="headerlink" title="metadata中的mtu问题"></a>metadata中的mtu问题</h2><p>有时候　iptables -t mangle -A PREROUTING -i ns-+ -p tcp –dport 80 -j CHECKSUM –checksum-fill<br>有时候　<a href="https://review.opendev.org/c/openstack/neutron/+/656359" target="_blank" rel="external">https://review.opendev.org/c/openstack/neutron/+/656359</a><br>有时候用了dpdk口，有时候用的却是bridge口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tshark -r ns-43cbdb54-9b &apos;ip.addr==169.254.169.254&apos;</span><br><span class="line">237 86.852258 10.243.164.13 → 169.254.169.254 TCP 74 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999115463 TSecr=0 WS=128</span><br><span class="line">242 87.868631 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999116479 TSecr=0 WS=128</span><br><span class="line">248 89.884108 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999118495 TSecr=0 WS=128</span><br><span class="line">263 94.012172 10.243.164.13 → 169.254.169.254 TCP 74 [TCP Retransmission] 37500 → 80 [SYN] Seq=0 Win=26880 Len=0 MSS=8960 SACK_PERM=1 TSval=1999122623 TSecr=0 WS=128</span><br><span class="line">$ tshark -r ns-4ae73fdc-5f &apos;ip.addr==169.254.169.254&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://blog.csdn.net/quqi99/article/details/15029501" target="_blank" rel="external">https://blog.csdn.net/quqi99/article/details/15029501</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/30/使用OVS-DPDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/30/使用OVS-DPDK/" itemprop="url">使用OVS DPDK</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-30T10:17:17+08:00">
                2021-01-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：张华  发表于：2016-04-07<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>硬件要求<br>网卡得支持DPDK，见：<a href="http://dpdk.org/doc/nics" target="_blank" rel="external">http://dpdk.org/doc/nics</a></p>
<p>CPU得支持DPDK, 测试命令：cat  /proc/cpuinfo |grep pdpe1gb</p>
<p>不一定非要支持DPDK硬件的网卡才能做实验，因为DPDK也支持virtio dpdk driver.</p>
<p>打开大页支持<br>hua@node1:~$ cat  /etc/default/grub |grep GRUB_CMDLINE_LINUX<br>GRUB_CMDLINE_LINUX_DEFAULT=”quiet splash intel_iommu=on pci=assign-busses”<br>GRUB_CMDLINE_LINUX=”transparent_hugepage=never hugepagesz=2M hugepages=64 default_hugepagesz=2M”</p>
<p>vi /etc/fstab<br>nodev /mnt/huge hugetlbfs pagesize=2MB 0 0</p>
<p>sudo update-grub<br>sudo mkdir -p /mnt/huge<br>sudo reboot<br>hua@node1:~$ cat /proc/meminfo |grep HugePages_<br>HugePages_Total:       64<br>HugePages_Free:        64<br>HugePages_Rsvd:        0</p>
<p>HugePages_Surp:        0</p>
<p>hua@node1:~$ grep Hugepagesize /proc/meminfo<br>Hugepagesize:       2048 kB</p>
<p>配置网卡使用uio_pci_generic驱动,  #注意：实验发现，对于sr-iov网卡，此处必须是PF，PF试验成功，VF试验不成功。所以虚机可以使用PF去做DPDK port，也可以直接直通方式使用VF。</p>
<p>至于PF的驱动，可以使用ixgbe，也可以使用DPDK PF driver；对于VF的驱动，可以使用ixgbefv，也可以使用DPDK VF driver. 如果要使用DPDK PF driver需在grub中加上iommu=pt.</p>
<p>它们之间也可以通信：</p>
<p>hua@node1:~$  sudo modprobe uio_pci_generic</p>
<p>hua@node1:~$ sudo dpdk_nic_bind –status</p>
<h1 id="Network-devices-using-DPDK-compatible-driver"><a href="#Network-devices-using-DPDK-compatible-driver" class="headerlink" title="Network devices using DPDK-compatible driver"></a>Network devices using DPDK-compatible driver</h1><none>

<h1 id="Network-devices-using-kernel-driver"><a href="#Network-devices-using-kernel-driver" class="headerlink" title="Network devices using kernel driver"></a>Network devices using kernel driver</h1><p>0000:00:19.0 ‘Ethernet Connection I217-V’ if=eth0 drv=e1000e unused=uio_pci_generic <em>Active</em><br>0000:05:00.0 ‘82576 Gigabit Network Connection’ if=eth1 drv=igb unused=uio_pci_generic <em>Active</em><br>0000:05:00.1 ‘82576 Gigabit Network Connection’ if=eth2 drv=igb unused=uio_pci_generic <em>Active</em></p>
<h1 id="Other-network-devices"><a href="#Other-network-devices" class="headerlink" title="Other network devices"></a>Other network devices</h1><p>0000:06:10.0 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.1 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.2 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.3 ‘82576 Virtual Function’ unused=uio_pci_generic</p>
<p>hua@node1:~$ sudo dpdk_nic_bind -b uio_pci_generic 0000:05:00.0<br>Routing table indicates that interface 0000:05:00.0 is active. Not modifying</p>
<p>hua@node1:~$ sudo ifconfig eth1 down<br>hua@node1:~$ sudo dpdk_nic_bind -b uio_pci_generic 0000:05:00.0</p>
<p>hua@node1:~$ sudo dpdk_nic_bind –status</p>
<h1 id="Network-devices-using-DPDK-compatible-driver-1"><a href="#Network-devices-using-DPDK-compatible-driver-1" class="headerlink" title="Network devices using DPDK-compatible driver"></a>Network devices using DPDK-compatible driver</h1><p>0000:05:00.0 ‘82576 Gigabit Network Connection’ drv=uio_pci_generic unused=</p>
<h1 id="Network-devices-using-kernel-driver-1"><a href="#Network-devices-using-kernel-driver-1" class="headerlink" title="Network devices using kernel driver"></a>Network devices using kernel driver</h1><p>0000:00:19.0 ‘Ethernet Connection I217-V’ if=eth0 drv=e1000e unused=uio_pci_generic <em>Active</em><br>0000:05:00.1 ‘82576 Gigabit Network Connection’ if=eth2 drv=igb unused=uio_pci_generic <em>Active</em></p>
<h1 id="Other-network-devices-1"><a href="#Other-network-devices-1" class="headerlink" title="Other network devices"></a>Other network devices</h1><p>0000:06:10.1 ‘82576 Virtual Function’ unused=uio_pci_generic<br>0000:06:10.3 ‘82576 Virtual Function’ unused=uio_pci_generic</p>
<p>配置OVS使用DPDK<br>hua@node1:~$ cat /etc/default/openvswitch-switch |grep DPDK<br>DPDK_OPTS=’–dpdk -c 0x1 -n 2’</p>
<p>hua@node1:~$ sudo update-alternatives –set ovs-vswitchd /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk<br>update-alternatives: using /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk to provide /usr/sbin/ovs-vswitchd (ovs-vswitchd) in manual mode</p>
<p>hua@node1:~$ sudo stop openvswitch-switch; sudo start openvswitch-switch</p>
<p>hua@node1:~$ cat /var/log/openvswitch/ovs-ctl.log |grep dpdk</p>
<p>有一个bug设置了DPDK_OPTS不生效，见：<a href="https://bugs.launchpad.net/ubuntu/+source/openvswitch-dpdk/+bug/1547463，" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/openvswitch-dpdk/+bug/1547463，</a> 做了这些改动：</p>
<p>vi /etc/default/openvswitch-switch<br>DPDK_OPTS=’–dpdk -c 0x1 -n 4’</p>
<p>vi /etc/init/openvswitch-switch.conf</p>
<h1 id="To-enable-openvswitch-dpdk"><a href="#To-enable-openvswitch-dpdk" class="headerlink" title="To enable openvswitch-dpdk"></a>To enable openvswitch-dpdk</h1><p>  if test X”$DPDK_OPTS” != X; then<br>    set “$@” DPDK_OPTS=”$DPDK_OPTS”<br>  fi</p>
<p>vi /usr/share/openvswitch/scripts/ovs-ctl<br>            set ovs-vswitchd<br>                if test X”$DPDK_OPTS” != X; then<br>                        set “$@” $DPDK_OPTS –<br>                fi<br>                set “$@” unix:”$DB_SOCK”</p>
<p>但在/var/log/openvswitch/ovs-ctl.log中仍然发现了下列错误，估计是ovs-vswitchd (Open vSwitch) 2.4.0版本（dpkg -l openvswitch-switch-dpdk）不支持–dpdk-opts参数吧。 </p>
<p>/usr/share/openvswitch/scripts/ovs-ctl: unknown option “–dpdk-opts=-c 0x1 -n 4” (use –help for help)</p>
<p>为避免上述ovs的bug，我们改用下列三个命令启动：</p>
<p>sudo restart openvswitch-switch</p>
<p>sudo killall ovs-vswitchd</p>
<p>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach</p>
<p>or</p>
<p>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 –socket-mem 128,0 – unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info –mlockall –no-chdir –log-file=/var/log/openvswitch/ovs-vswitchd.log –pidfile=/var/run/openvswitch/ovs-vswitchd.pid –detach –monitor</p>
<p>但仍然有下列错误。估计是保留的大页数目太少所致，后来将GRUB_CMDLINE_LINUX=”transparent_hugepage=never hugepagesz=2M hugepages=64 default_hugepagesz=2M”中的hugepages从4改成64这个错误就翻过去了。</p>
<p>hua@node1:~$ sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach<br>2016-04-07T11:48:03Z|00001|dpdk|INFO|No -cuse_dev_name provided - defaulting to vhost-net<br>EAL: Detected lcore 0 as core 0 on socket 0<br>EAL: Detected lcore 1 as core 1 on socket 0<br>EAL: Detected lcore 2 as core 2 on socket 0<br>EAL: Detected lcore 3 as core 3 on socket 0<br>EAL: Support maximum 128 logical core(s) by configuration.<br>EAL: Detected 4 lcore(s)<br>EAL: No free hugepages reported in hugepages-1048576kB<br>EAL: Setting up memory…<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f8609a00000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x400000 bytes<br>EAL: Virtual area found at 0x7f8609400000 (size = 0x400000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f8609000000 (size = 0x200000)<br>EAL: Requesting 4 pages of size 2MB from socket 0<br>EAL: rte_eal_common_log_init(): cannot create log_history mempool<br>PANIC in rte_eal_init():<br>Cannot init logs<br>7: [ovs-vswitchd() [0x40b053]]<br>6: [/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf5) [0x7f860acc9ec5]]<br>5: [ovs-vswitchd() [0x40a059]]<br>4: [ovs-vswitchd() [0x639db1]]<br>3: [ovs-vswitchd() [0x43f7ad]]<br>2: [ovs-vswitchd() [0x407bad]]<br>1: [ovs-vswitchd() [0x444e58]]</p>
<p>hua@node1:~$ sudo ovs-vswitchd –dpdk -c 0x1 -n 2 – unix:/var/run/openvswitch/db.sock –pidfile –detach<br>2016-04-07T13:57:08Z|00001|dpdk|INFO|No -cuse_dev_name provided - defaulting to vhost-net<br>EAL: Detected lcore 0 as core 0 on socket 0<br>EAL: Detected lcore 1 as core 1 on socket 0<br>EAL: Detected lcore 2 as core 2 on socket 0<br>EAL: Detected lcore 3 as core 3 on socket 0<br>EAL: Support maximum 128 logical core(s) by configuration.<br>EAL: Detected 4 lcore(s)<br>EAL: No free hugepages reported in hugepages-1048576kB<br>EAL: VFIO modules not all loaded, skip VFIO support…<br>EAL: Setting up memory…<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72a00000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72600000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f72200000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x1a00000 bytes<br>EAL: Virtual area found at 0x7f2f70600000 (size = 0x1a00000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f70200000 (size = 0x200000)<br>EAL: Ask a virtual area of 0x5c00000 bytes<br>EAL: Virtual area found at 0x7f2f6a400000 (size = 0x5c00000)<br>EAL: Ask a virtual area of 0x200000 bytes<br>EAL: Virtual area found at 0x7f2f6a000000 (size = 0x200000)<br>EAL: Requesting 64 pages of size 2MB from socket 0<br>EAL: TSC frequency is ~3292375 KHz<br>EAL: Master lcore 0 is ready (tid=74e2bb40;cpuset=[0])<br>PMD: ENICPMD trace: rte_enic_pmd_init<br>EAL: PCI device 0000:05:00.0 on NUMA socket -1<br>EAL:   probe driver: 8086:10c9 rte_igb_pmd<br>EAL:   PCI memory mapped at 0x7f2f72c00000<br>EAL:   PCI memory mapped at 0x7f2f72c20000<br>EAL:   PCI memory mapped at 0x7f2f72c60000<br>PMD: eth_igb_dev_init(): port_id 0 vendorID=0x8086 deviceID=0x10c9<br>EAL: PCI device 0000:05:00.1 on NUMA socket -1<br>EAL:   probe driver: 8086:10c9 rte_igb_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>EAL: PCI device 0000:06:10.1 on NUMA socket -1<br>EAL:   probe driver: 8086:10ca rte_igbvf_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>EAL: PCI device 0000:06:10.3 on NUMA socket -1<br>EAL:   probe driver: 8086:10ca rte_igbvf_pmd<br>EAL:   Not managed by a supported kernel driver, skipped<br>Zone 0: name:<malloc_s0_heap_0>, phys:0xd6c00000, len:0xb00000, virt:0x7f2f70600000, socket_id:0, flags:0<br>Zone 1: name:<rg_mp_log_history>, phys:0x2200000, len:0x2080, virt:0x7f2f72a00000, socket_id:0, flags:0<br>Zone 2: name:<mp_log_history>, phys:0xd7700000, len:0x28a0c0, virt:0x7f2f71100000, socket_id:0, flags:0<br>Zone 3: name:<rte_eth_dev_data>, phys:0x2202080, len:0x1f400, virt:0x7f2f72a02080, socket_id:0, flags:0<br>2016-04-07T13:57:09Z|00002|ovs_numa|INFO|Discovered 4 CPU cores on NUMA node 0<br>2016-04-07T13:57:09Z|00003|ovs_numa|INFO|Discovered 1 NUMA nodes and 4 CPU cores<br>2016-04-07T13:57:09Z|00004|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connecting…<br>VHOST_CONFIG: socket created, fd:17<br>VHOST_CONFIG: bind to vhost-net<br>2016-04-07T13:57:09Z|00005|reconnect|INFO|unix:/var/run/openvswitch/db.sock: connected<br>2016-04-07T13:57:09Z|00006|ofproto_dpif|INFO|system@ovs-system: Datapath supports recirculation<br>2016-04-07T13:57:09Z|00007|ofproto_dpif|INFO|system@ovs-system: MPLS label stack length probed as 1<br>2016-04-07T13:57:09Z|00008|ofproto_dpif|INFO|system@ovs-system: Datapath supports unique flow ids<br>2016-04-07T13:57:09Z|00009|bridge|INFO|bridge br-ex: added interface br-ex on port 65534<br>2016-04-07T13:57:09Z|00010|bridge|INFO|bridge br-ex: added interface qg-5786befb-c3 on port 1<br>2016-04-07T13:57:09Z|00011|bridge|INFO|bridge br-tun: added interface patch-int on port 1<br>2016-04-07T13:57:09Z|00012|bridge|INFO|bridge br-tun: added interface br-tun on port 65534<br>2016-04-07T13:57:09Z|00013|bridge|INFO|bridge br-int: added interface tap140d04f3-58 on port 22<br>2016-04-07T13:57:09Z|00014|bridge|INFO|bridge br-int: added interface tap6a12dfe3-40 on port 20<br>2016-04-07T13:57:09Z|00015|bridge|INFO|bridge br-int: added interface tap1ea7e391-73 on port 21<br>2016-04-07T13:57:09Z|00016|bridge|INFO|bridge br-int: added interface tapdc1b7683-4e on port 14<br>2016-04-07T13:57:09Z|00017|bridge|INFO|bridge br-int: added interface patch-tun on port 182<br>2016-04-07T13:57:09Z|00018|bridge|INFO|bridge br-int: added interface tap23e3a388-68 on port 11<br>2016-04-07T13:57:09Z|00019|bridge|INFO|bridge br-int: added interface int-br-phy on port 1<br>2016-04-07T13:57:09Z|00020|bridge|INFO|bridge br-int: added interface tap935ec68a-1a on port 12<br>2016-04-07T13:57:09Z|00021|bridge|INFO|bridge br-int: added interface tap2ca9e4a0-67 on port 7<br>2016-04-07T13:57:09Z|00022|bridge|INFO|bridge br-int: added interface tapcc6c6a9e-f2 on port 13<br>2016-04-07T13:57:09Z|00023|bridge|INFO|bridge br-int: added interface tap4751f42a-65 on port 10<br>2016-04-07T13:57:09Z|00024|bridge|INFO|bridge br-int: added interface br-int on port 65534<br>2016-04-07T13:57:09Z|00025|bridge|INFO|bridge br-int: added interface tapdde9820f-58 on port 9<br>2016-04-07T13:57:09Z|00026|bridge|WARN|could not open network device br100 (No such device)<br>2016-04-07T13:57:09Z|00027|bridge|INFO|bridge br-phy: added interface phy-br-phy on port 3<br>2016-04-07T13:57:09Z|00028|bridge|INFO|bridge br-phy: added interface br-phy on port 65534<br>2016-04-07T13:57:09Z|00029|bridge|INFO|bridge br-ex: using datapath ID 0000de7e48588f4c<br>2016-04-07T13:57:09Z|00030|connmgr|INFO|br-ex: added service controller “punix:/var/run/openvswitch/br-ex.mgmt”<br>2016-04-07T13:57:09Z|00031|bridge|INFO|bridge br-tun: using datapath ID 00007a84c20ae149<br>2016-04-07T13:57:09Z|00032|connmgr|INFO|br-tun: added service controller “punix:/var/run/openvswitch/br-tun.mgmt”<br>2016-04-07T13:57:09Z|00033|bridge|INFO|bridge br-int: using datapath ID 00008e56b225c748<br>2016-04-07T13:57:09Z|00034|connmgr|INFO|br-int: added service controller “punix:/var/run/openvswitch/br-int.mgmt”<br>2016-04-07T13:57:09Z|00035|bridge|INFO|bridge br-phy: using datapath ID 00000255fc61864b<br>2016-04-07T13:57:09Z|00036|connmgr|INFO|br-phy: added service controller “punix:/var/run/openvswitch/br-phy.mgmt”<br>2016-04-07T13:57:09Z|00001|ofproto_dpif_upcall(handler15)|INFO|received packet on unassociated datapath port 0</rte_eth_dev_data></mp_log_history></rg_mp_log_history></malloc_s0_heap_0></p>
<p>测试<br>sudo ovs-vsctl ovsbr0 br-int<br>sudo ovs-vsctl set bridge ovsbr0 datapath_type=netdev</p>
<p>sudo ovs-vsctl add-port ovsbr0 dpdk0 – set Interface dpdk0 type=dpdk  #Port name shoud begin with dpdk</p>
<p>给虚机创建普通ovs port:</p>
<p>sudo ovs-vsctl add-port ovsbr0 intP1 – set Interface intP1 type=internal<br>sudo ip addr add 192.168.10.129/24 dev intP1<br>sudo ip link set dev intP1 up<br>sudo tcpdump -i intP1​</p>
<p>或给虚机创建vhost-user port:</p>
<p>sudo ovs-vsctl add-port ovsbr0 vhost-user2 – set Interface vhost-user2 type=dpdkvhostuser</p>
<p>虚机使用vhost-user port</p>
<p>sudo qemu-system-x86_64 -enable-kvm -m 128 -smp 2 \<br>    -chardev socket,id=char0,path=/var/run/openvswitch/vhost-user1 \<br>    -netdev type=vhost-user,id=mynet1,chardev=char0,vhostforce \<br>    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \<br>    -object memory-backend-file,id=mem,size=128M,mem-path=/mnt/huge,share=on \<br>    -numa node,memdev=mem -mem-prealloc \<br>    -net user,hostfwd=tcp::10021-:22 -net nic \<br>    /bak/images/openstack_demo.img</p>
<p>Inside VM: sudo ifconfig eth0 192.168.9.108/24</p>
<p>使用vhost-user方式可如下图所示：</p>
<p>dpdk-virtio-net</p>
<p>与Neutron的集成</p>
<p>​</p>
<p>nova已经支持vhost-user与hugepages特性，显然在nova.conf应该打开。</p>
<h1 id="then-the-OVS-ML2-driver-will-use-the-vhost-user-VIF-type-and-pass-the-necessary-binding-details-to-use-OVS-DPDK-and-vhost-user-sockets"><a href="#then-the-OVS-ML2-driver-will-use-the-vhost-user-VIF-type-and-pass-the-necessary-binding-details-to-use-OVS-DPDK-and-vhost-user-sockets" class="headerlink" title="then the OVS ML2 driver will use the vhost-user VIF type and pass the necessary binding details to use OVS+DPDK and vhost-user sockets."></a>then the OVS ML2 driver will use the vhost-user VIF type and pass the necessary binding details to use OVS+DPDK and vhost-user sockets.</h1><p>[OVS]<br>datapath_type=netdev<br>vhostuser_socket_dir=/var/run/openvswitch<br>[libvirt]<br>use_hugepages = True</p>
<p>另外，应该手工创建上述的ovsbr0，然后在/etc/neutron/plugins/ml2/ml2_conf.ini指定使用ovsbr0作为provider network.</p>
<p>[ovs]<br>bridge_mappings = default:ovsbr0</p>
<p>dpdk与neutron集成的工程叫networking-ovs-dpdk，在devstack加下列一行可使用devstack创建ovs dpdk环境。</p>
<p>enable_plugin networking-ovs-dpdk <a href="https://github.com/openstack/networking-ovs-dpdk" target="_blank" rel="external">https://github.com/openstack/networking-ovs-dpdk</a> master</p>
<p>整个运行命令</p>
<p>sudo add-apt-repository cloud-archive:mitaka</p>
<p>sudo apt-get install openvswitch-switch-dpdk</p>
<p>sudo modprobe vfio-pci<br>sudo chmod a+x /dev/vfio<br>sudo chmod 0666 /dev/vfio/*<br>sudo ifconfig eth1 down<br>sudo dpdk_nic_bind -b vfio-pci eth1  #注意：实验发现，对于sr-iov网卡，此处必须是PF，PF试验成功，VF试验不成功。</p>
<p>find /sys/kernel/iommu_groups/ -type l<br>sudo sysctl -w vm.nr<em>hugepages=256<br>cat /proc/meminfo |grep HugePages</em></p>
<p>sudo restart openvswitch-switch<br>sudo update-alternatives –set ovs-vswitchd /usr/lib/openvswitch-switch-dpdk/ovs-vswitchd-dpdk<br>sudo killall ovs-vswitchd<br>sudo ovs-vswitchd –dpdk -c 0x1 -n 2 –socket-mem 128,0 – unix:/var/run/openvswitch/db.sock -vconsole:emer -vsyslog:err -vfile:info –mlockall –no-chdir –log-file=/var/log/openvswitch/ovs-vswitchd.log –pidfile=/var/run/openvswitch/ovs-vswitchd.pid –detach –monitor<br>ps -ef|grep dpdk</p>
<p>sudo qemu-system-x86_64 -enable-kvm -m 128 -smp 2 \<br>    -chardev socket,id=char0,path=/var/run/openvswitch/vhost-user1 \<br>    -netdev type=vhost-user,id=mynet1,chardev=char0,vhostforce \<br>    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \<br>    -object memory-backend-file,id=mem,size=128M,mem-path=/mnt/huge,share=on \<br>    -numa node,memdev=mem -mem-prealloc \<br>    -net user,hostfwd=tcp::10021-:22 -net nic \<br>    /bak/images/openstack_demo.img</p>
<p>Inside VM: sudo ifconfig eth0 192.168.9.108/24</p>
<p>附录1,编译DPDK源码并运行单个应用<br>git clone git://dpdk.org/dpdk<br>export DPDK_DIR=/bak/linux/dpdk<br>export DPDK_BUILD=$DPDK_DIR/x86_64-ivshmem-linuxapp-gcc/<br>export RTE_TARGET=x86_64-ivshmem-linuxapp-gcc<br>export EXTRA_CFLAGS=”-ggdb -ffunction-sections -O0”                                       #设置调试选项<br>echo ‘CONFIG_RTE_BUILD_COMBINE_LIBS=y’ &gt;&gt; ./config/common_linuxapp   #编译成单个文件</p>
<p>echo ‘CONFIG_RTE_LIBRTE_VHOST=y’ &gt;&gt; ./config/common_linuxapp   </p>
<p>sudo make config T=x86_64-ivshmem-linuxapp-gcc </p>
<p>sudo make install T=x86_64-ivshmem-linuxapp-gcc                                                #使用共享内存ivshmem模式</p>
<p>cd x86_64-ivshmem-linuxapp-gcc/<br>EXTRA_CFLAGS=”-g -O0” make -j4</p>
<p>sudo modprobe uio<br>sudo insmod x86_64-ivshmem-linuxapp-gcc/kmod/igb_uio.ko                                #DPDK只能使用igb_uio和vfio-pci两种驱动</p>
<p>cd lib/librte_vhost/eventfd_link/<br>make<br>sudo insmod eventfd_link.ko<br>sudo python tools/dpdk_nic_bind.py –status<br>sudo python tools/dpdk_nic_bind.py -b igb_uio 0000:05:00.0</p>
<p>#sudo python tools/dpdk_nic_bind.py -b uio_pci_generic 0000:05:00.0</p>
<p>cd examples/helloworld/<br>make<br>sudo ./build/helloworld -c 0xf -n 4 –socket-mem=32</p>
<p>gdb ./build/helloworld<br>(gdb) run -c 0xf -n 4 –socket-mem=32</p>
<p>#integrate ovs with dpdk</p>
<p>git clone <a href="https://github.com/openvswitch/ovs.git" target="_blank" rel="external">https://github.com/openvswitch/ovs.git</a><br>cd /bak/linux/ovs<br>export OVS_DIR=<code>pwd</code><br>./boot.sh<br>./configure –with-dpdk=”$DPDK_DIR/x86_64-ivshmem-linuxapp-gcc/“ –enable-ssl CFLAGS=”-g -O0”<br>make ‘CFLAGS=-g -O0 -march=native’ -j4</p>
<p>参考<br>[1] <a href="https://software.intel.com/en-us/blogs/2015/06/09/building-vhost-user-for-ovs-today-using-dpdk-200" target="_blank" rel="external">https://software.intel.com/en-us/blogs/2015/06/09/building-vhost-user-for-ovs-today-using-dpdk-200</a></p>
<p>[2] <a href="http://dpdk.readthedocs.org/en/v2.2.0/linux_gsg/index.html" target="_blank" rel="external">http://dpdk.readthedocs.org/en/v2.2.0/linux_gsg/index.html</a></p>
<p>[3] <a href="http://blog.csdn.net/xy010902100449/article/details/47282937" target="_blank" rel="external">http://blog.csdn.net/xy010902100449/article/details/47282937</a></p>
<p>[4] <a href="http://openvswitch.org/support/dist-docs/INSTALL.DPDK.md.txt" target="_blank" rel="external">http://openvswitch.org/support/dist-docs/INSTALL.DPDK.md.txt</a></p>
<p>[5] <a href="https://software.intel.com/en-us/articles/using-open-vswitch-with-dpdk-for-inter-vm-nfv-applications" target="_blank" rel="external">https://software.intel.com/en-us/articles/using-open-vswitch-with-dpdk-for-inter-vm-nfv-applications</a></p>
<p>[6] <a href="https://raw.githubusercontent.com/xsited/ssg/master/scripts/build_ovs_dpdk.sh" target="_blank" rel="external">https://raw.githubusercontent.com/xsited/ssg/master/scripts/build_ovs_dpdk.sh</a></p>
<p>[7] <a href="http://www.ran-lifshitz.com/2015/06/17/open-vswitch-netdev-dpdk-with-vhost-user-support/" target="_blank" rel="external">http://www.ran-lifshitz.com/2015/06/17/open-vswitch-netdev-dpdk-with-vhost-user-support/</a></p>
<p>[8] DPDK编程指南</p>
</none>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/28/OpenStack中的防火墙/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/28/OpenStack中的防火墙/" itemprop="url">OpenStack中的防火墙</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-28T12:37:28+08:00">
                2021-01-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>OpenStack中的防火墙 ( by quqi99 )
</code></pre><p>作者：张华  发表于：2012-4-10<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明<br>( <a href="http://blog.csdn.net/quqi99" target="_blank" rel="external">http://blog.csdn.net/quqi99</a> )</p>
<p>iptables提供了全面的协议状态跟踪、数据包的应用层检查、速率限制、过滤策略。</p>
<p>iptables策略是由一组有序的规则建立的，它告诉内核该如何处理数据包。而规则应用于表中的一个链，链是一个规则集。</p>
<p>iptable 的概念从大到小是：iptables &gt; tables &gt; chains &gt; rules</p>
<p>表，表描述了iptables的功用大类，共有4个内置表：filter,nat, mangle,raw。</p>
<p>filter, 默认表，有三个重要的内置链：INPUT, OUTPUT, FORWARD</p>
<p>nat，网络地址转换表，三个链，PREROUTING (DNAT), POSTROUTING（SNAT)，OUTPUT（用于本地包的NAT)</p>
<p>mangle, 用于包的修改，　PREOUTING, OUTPUT, FORWARD, INPUT, POSTROUTING</p>
<p>raw, 用于配置免除, PREROUTING, OUTPUT</p>
<p>下图显示了这些内置链的关系:</p>
<p>iptables包处理流程图如下：</p>
<p>例如：openstack中的floating-ips就是根据SNAT与DNAT规则实现的：</p>
<p>iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j SNAT –to-source 9.123.25.13<br>iptables -t nat -A PREROUTING -d 9.123.25.13 -j DNAT –to-destination 172.16.1.2</p>
<p><a href="http://blog.csdn.net/bill_lee_sh_cn/article/details/4401896" target="_blank" rel="external">http://blog.csdn.net/bill_lee_sh_cn/article/details/4401896</a></p>
<p>匹配，即条件，每个iptables规则都包含一级匹配以及一个目标，后者告诉ipatables对于符合规则的数据包应该采取什么动作。最重要的iptables匹配如下：</p>
<p>–source (-s ), 配置源IP地址或网络</p>
<p>–destination (-d), 匹配目标IP或网络</p>
<p>–protocol (-p), 匹配IP值</p>
<p>–in-interface (-i), 流入接口（如,eth0)</p>
<p>–out-interface (-o), 输出接口</p>
<p>–state，匹配一组连接状态</p>
<p>–string, 匹配应用层数据字节序列</p>
<p>–comment,在内核内存中为一个规则关联多达256个节字的注释数据</p>
<p>目标，即动作，它们用于在数据包匹配一条规则时触发的一个动作。如下：</p>
<p>ACCEPT, 充许数据包通过</p>
<p>DROP，丢弃数据包，不响应报文</p>
<p>REJECT, 丢弃数据包，响应报文</p>
<p>LOG，记录数据包信息到syslog</p>
<p>RETURN，在调用链中继续处理数据包</p>
<p>除了内置链以外，还可以自定义链表，自定义链表的一般过程是：</p>
<p>1, 创建一个新链表，iptables-t filter -N newchain</p>
<p>2, 往新链表中添加rules，iptables-t filter -A newchain -s 192.168.75.129 -j DROP</p>
<p>3, 通过-j参数使用自定义的链，iptables-A INPUT -j newchain</p>
<p>Neutron使用了自定义链，分包装链与非包装链两类，区别在于是否对链表添加组件名重新包装</p>
<p>(这样定名的目的是为了不和系统中其他应用设置的防火墙规则混淆）：</p>
<p>１）包装链，链名需要通过组件名重新包装，如neutron-l3-agent组件定义的OUTPUT链叫neutron-l3-agent-OUTPUT，也意味着，Neutron不会用内置链OUTPUT，它必须跳转到对应的包装链（iptables-t filter OUTPUT -j neutron-l3-agent-OUTPUT）</p>
<p>２）非包装链，链名没有用组件名包装，例如，neutron-filter-top就是位于FOWARD和OUTPUT顶部的非包装链，用于在不同OpenStack组件共享的链，</p>
<p>neutron-filter-top链的内容是：</p>
<p>iptables -t filter -N neutron-filter-top</p>
<p>iptables -t filter -A FORWARD -jneutron-filter-top</p>
<p>iptables -t filter -A OUTPUT -j neutron-filter-top</p>
<p>再添加一个包装链neutron-l3-agent-local，接管非包装链neutron-filter-top</p>
<p>iptables -t filter -N neutron-l3-agent-local</p>
<p>iptables -t filter -A neutron-filter-top -jneutron-l3-agent-local</p>
<p>对于IPv4,IPv6，Neutron为filter和nat两张表里的INPUT,FORWARD, OUTPUT三个内置链都定义了相应的包装链：</p>
<p>iptables -t filter -A INPUT -jneutron-l3-agent-INPUT</p>
<p>iptables -t filter -A FORWARD -jneutron-l3-agent-FORWARD</p>
<p>iptables -t filter -A OUTPUT -jneutron-l3-agent-OUTPUT</p>
<p>iptables -t nat -A INPUT -j neutron-l3-agent-INPUT</p>
<p>iptables -t nat -A FORWARD -jneutron-l3-agent-FORWARD</p>
<p>iptables -t nat -A OUTPUT -jneutron-l3-agent-OUTPUT</p>
<p>还定义了一个名为neutron-postrouting-bottom的非包装类，用于POSTOURING链之后：</p>
<p>iptables -t filter -N neutron-postrouting-bottom</p>
<p>iptables -t filter -A POSTROUTING -jneutron-postrouting-bottom</p>
<p>在neutron-postrouting-bottom链后再定义两个snat(neutron-l3-agent-snat）的包装类：</p>
<p>iptables -t filter -N neutron-l3-agent-snat</p>
<p>iptables -t filter -A neutron-postrouting-bottom-j neutron-l3-agent-snat</p>
<p>iptables -t filter -N neutron-l3-agent-float-snat</p>
<p>iptables -t filter -A neutron-postrouting-bottom-j neutron-l3-agent-float-snat</p>
<p>最后定义sg-fallback包装链</p>
<p>iptables -t filter -N neutron-l3-agent-sg-fallback</p>
<p>iptables -t filter -Aneutron-l3-agent-sg-fallback -j DROP</p>
<p>所以这些初始化链的关系是：</p>
<p>OpenStack为我们准备好了上面的包装链与非包装链，再添加添加防火墙规则的时候，就不要再往内置链上添加了，而是直接添加到包装链与非包装链上，我们来看一下怎么用吧（这些内容来自永生的博客，写得真不错，做笔记到这里了，<a href="http://www.ibm.com/developerworks/cn/cloud/library/cl-openstack-network/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/cloud/library/cl-openstack-network/index.html</a> )</p>
<p>１）元数据，</p>
<p>VM首先访问l3-agent节点上的网关，而l3-agent节点（dhcp-agent节点也会干这事）会在9697端口上启动neutron-ns-metadata-proxy代理，下面的iptables rules保证包通过(注意:　如果存在命名空间这些规则就在命名空间里)。</p>
<p>cirros$ ip route get 169.254.169.254<br>169.254.169.254 via 10.0.1.1 dev eth0  src 10.0.1.3</p>
<p>sudo ip netns exec qrouter-b0d4cbde-84c8-4883-a953-1d11bcc3c99b iptables-save | grep 169.254<br>-A neutron-vpn-agen-inbound -s 169.254.169.254/32 -j ACCEPT<br>-A neutron-vpn-agen-outbound -d 169.254.169.254/32 -j ACCEPT<br>-A neutron-vpn-agen-PREROUTING -d 169.254.169.254/32 -p tcp -m tcp –dport 80 -j REDIRECT –to-ports 9697  #对于dhcp-agent的metdata代理没有这一条语句，直接使用80端口<br>169.254.169.254/32 -p tcp -m tcp –dport 80 -j REDIRECT –to-ports 9697  #对于dhcp-agent的metdata代理没有这一条语句，直接使用80端口</p>
<p>ubuntu@neutron-gateway:~$ sudo ip netns exec qrouter-02c71d17-8186-4fde-8bfc-ee0bea0d44ba ss -sl4tp  | grep 9697<br>LISTEN     0      128                     <em>:9697                     </em>:<em>        users:((“neutron-ns-meta”,58682,6))<br>9697                     </em>:*        users:((“neutron-ns-meta”,58682,6))</p>
<p>ubuntu@neutron-gateway:~$ sudo ip netns exec qrouter-02c71d17-8186-4fde-8bfc-ee0bea0d44ba ps -f –pid 58682 | fold -w82 -s<br>UID        PID  PPID  C STIME TTY          TIME CMD<br>neutron  58682     1  0 Jun18 ?        00:00:48 /usr/bin/python<br>/usr/bin/neutron-ns-metadata-proxy<br>–pid_file=/var/lib/neutron/external/pids/02c71d17-8186-4fde-8bfc-ee0bea0d44ba.pid<br> –metadata_proxy_socket=/var/lib/neutron/metadata_proxy<br>–router_id=02c71d17-8186-4fde-8bfc-ee0bea0d44ba –state_path=/var/lib/neutron<br>–metadata_port=9697 –metadata_proxy_user=109 –metadata_proxy_group=113<br>–log-file=neutron-ns-metadata-proxy-02c71d17-8186-4fde-8bfc-ee0bea0d44ba.log<br>–log-dir=/var/log/neutron<br>9697 –metadata_proxy_user=109 –metadata_proxy_group=113<br>–log-file=neutron-ns-metadata-proxy-02c71d17-8186-4fde-8bfc-ee0bea0d44ba.log<br>–log-dir=/var/log/neutron</p>
<p>ubuntu@neutron-gateway:~$ ps -f –pid 26859 | fold -w 80 -s<br>UID        PID  PPID  C STIME TTY          TIME CMD<br>neutron  26859 26747  2 Jun16 ?        2-23:44:43 /usr/bin/python<br>/usr/bin/neutron-metadata-agent –config-file=/etc/neutron/neutron.conf<br>–config-file=/etc/neutron/metadata_agent.ini<br>–log-file=/var/log/neutron/neutron-metadata-agent.log<br>/var/log/neutron/neutron-metadata-agent.log<br>ubuntu@neutron-gateway:~$ sudo ss -slxp | grep metadata_proxy<br>u_str  LISTEN     0      128    /var/lib/neutron/metadata_proxy 1460916               * 0<br>  users:((“neutron-metadat”,26859,5),(“neutron-metadat”,26858,5),(“neutron-metadat”,26857,5),(“neutron-metadat”,26856,5),<br>(“neutron-metadat”,26855,5),(“neutron-metadat”,26854,5),(“neutron-metadat”,26853,5),(“neutron-metadat”,26852,5),<br>(“neutron-metadat”,26747,5))<br>26859,5),(“neutron-metadat”,26858,5),(“neutron-metadat”,26857,5),(“neutron-metadat”,26856,5),<br>(“neutron-metadat”,26855,5),(“neutron-metadat”,26854,5),(“neutron-metadat”,26853,5),(“neutron-metadat”,26852,5),<br>(“neutron-metadat”,26747,5))</p>
<p>然后neutron-ns-metadata-proxy代理会通过http协议访问neutron metadata-agent，所以169.254.169.254应该是配置在metadata-agent节点的lo口上。且neutron metadata-agent的机器上应该将169.254.169.254 DNAT到实际布置metadata service的机器nova_metadata_ip (/etc/neutron/meatadata_agent.ini)上，如172.16.1.122 。（所以当nova-api与metadata agent不在同一机器上时，在metadata agent机器上应该配置metadata_host配置）</p>
<p>同时，在nova-api机器上要放行这类包。</p>
<p>-A nova-network-POSTROUTING -s 10.0.0.0/8 -d 172.16.1.122/32 -j ACCEPT</p>
<p>l3-agent上会为每一个namespace下的router创建一个neutron-ns-metadata-proxy进程(虚机和nova-api的路由不同才需要代理),  将请求元数据服务VM的源IP通过设置X-Forwarded-For, X-Neutron-Router-ID, X-Neutron-Network-ID 传给metadata_agent从而解决识别不同namespace下虚机的问题, 然后metadata-agent根据源IP找到port的相关信息(调用nova-api时需要这个port-id之类的信息来识别虚机, X-Forwarded-For , X-Instance-ID, X-Tenant-ID, X-Instance-ID-Signature). neutron-ns-metadata-proxy通过本地的unix-socket再交给本机的metadata-agent, 本机的metadata-agent再通过配置文件中的nova-metadata_host找到本机的nova-metadata-api.</p>
<p>如果使用外部网关，要使用metadata也应该启动dhcp-agent, 即： </p>
<p>/etc/neutron/dhcp_agent.ini:<br>  enable_metadata_network = True<br>  enable_isolated_metadata = True</p>
<p>/neutron/l3_agent.ini:<br>  enable_metadata_proxy = False<br>有时候还要在nova.conf中设置use_forwarded_for = True. 这样虚机里会通过dhcp static host特性自动添加一条路由（ip route add 169.254.169.254/32 via 10.20.0.5  ）， 然后在dhcp节点的qdhcp-XXX名空间的dhcp port应该同时具有两个IP （例如一个10.20.0.5, 一个是169.254.169.254），它会启动neutron-ns-metadata-proxy(它是隔离网络，此时的metadata_port是80,不是9697,不需要9697的那条iptables rule), 后面neutron-metadata-agent的部分和前面一样。</p>
<h1 id="ps-f-–pid-27409-fold-s-w-82-pid可通过ip-netns-exec-qdhcp-XXX-netstat-4-anpt-命令查看"><a href="#ps-f-–pid-27409-fold-s-w-82-pid可通过ip-netns-exec-qdhcp-XXX-netstat-4-anpt-命令查看" class="headerlink" title="ps -f –pid 27409 | fold -s -w 82        #pid可通过ip netns exec qdhcp-XXX netstat -4 -anpt 命令查看"></a>ps -f –pid 27409 | fold -s -w 82        #pid可通过ip netns exec qdhcp-XXX netstat -4 -anpt 命令查看</h1><p>UID PID PPID C STIME TTY TIME CMD<br>root 27409 1 0 17:47 ? 00:00:00 python<br>/usr/bin/neutron-ns-metadata-proxy<br>–pid_file=/var/lib/neutron/external/pids/01cce415-8e2b-4096-92b5-7acc67163d79.pid<br>–network_id=01cce415-8e2b-4096-92b5-7acc67163d79 –state_path=/var/lib/neutron<br>–metadata_port=80 –debug –verbose<br>–log-file=neutron-ns-metadata-proxy01cce415-8e2b-4096-92b5-7acc67163d79.log<br>–log-dir=/var/log/neutron </p>
<p>所以使用dhcp-agent的metadata代理时，必须是隔离网络（neutron subnet-create net1 172.17.17.0/24 –no-gateway –name=sub1），如果不是隔离网络可以考虑设置force_metadata=True.</p>
<p>有时候即想用物理路由器，还不想使用dhcp-agent，并且还想使用metadata那该怎么办？ 好说，那必须启动l3-agent（如它的IP是10.0.0.1），那么物理路由器的IP必须是不同的IP如10.0.0.254。这样用下列静态路由将到169.254.169.254的走l3-agent上的namespace metadata proxy，其他流量走物理路由器。具体见： <a href="https://kimizhang.wordpress.com/2014/11/11/how-to-use-meta-data-service-for-vm-with-provider-network/" target="_blank" rel="external">https://kimizhang.wordpress.com/2014/11/11/how-to-use-meta-data-service-for-vm-with-provider-network/</a></p>
<p>neutron subnet-create –name test-subnet –gateway 10.0.0.1  \<br>–host-route destination=169.254.169.254/32,nexthop=10.0.0.1 \<br>–host-route destination=0.0.0.0/0,nexthop=10.0.0.254 test-net 10.0.0.0/24</p>
<p>默认的security group会为每个port产生嗅探规则(即只允许匹配的ip, mac对的流量通过, 对于负载均衡或者 SLAC IPv6地址的port, 可能一个port(只有一个mac)但有多个IP, 所以可以通过allowed-address-pairs这个扩展来允许任何源IP的流量通过. 那我们可以用ipv6的本地链路地址LLAddr来查询上面的port呢, 于是有了BP, <a href="https://blueprints.launchpad.net/neutron/+spec/metadata-find-instance-by-lladdr" target="_blank" rel="external">https://blueprints.launchpad.net/neutron/+spec/metadata-find-instance-by-lladdr</a> ,  但是又有一种情况, 不同namespace下可能允许出现相关的mac地址的(overlapping mac), 这样根据mac地址将查询出两个port出来,</p>
<p>用源IP及network_id (不同的tenant下是可以存在的subnet的）去查询port可能会有一个问题(找port是为了找到虚机的device_id和tenant_id信息）, 如纯IPv6环境（一个同MAC的port会有多个IPv6地址)，如虚机从外部获取IP时IP根本就不在port的fixed_ip字段里, 这样就会造成找不到port从而找不着device_id从而造成metadata服务不可用。(当然,可以通过allowed-address-pairs扩展将169.254.0.0/16加入虚机的port security里). 这种情况是不是可以用config-driver这种离线的元数据配置服务去代替在线的metadata服务. 或者搞一个所谓的serial port配置在fixed_ip list的源IP专门去读在线的metadata服务.</p>
<p>config-driver虚机注入见: <a href="http://niusmallnan.github.io/_build/html/_templates/openstack/vm_first_boot_fast.html" target="_blank" rel="external">http://niusmallnan.github.io/_build/html/_templates/openstack/vm_first_boot_fast.html</a>, 即把nova boot传来的元数据写到iso中, 虚机启动时自动挂载iso, 然后init-cloud从光驱里读元数据并设置</p>
<p>cat &lt;&lt; EOF &gt; user-data </p>
<p>#cloud-config<br>user: ubuntu<br>password: ubuntu<br>chpasswd: { expire: False }<br>EOF<br>openstack server create –wait –image <image name=""> –flavor m1.medium –key-name <keynam> –nic net-id=<net-id> testvm –user-data ./user-data –config-drive true </net-id></keynam></image></p>
<p>allowed-address-pairs见： <a href="http://blog.csdn.net/matt_mao/article/details/19417451" target="_blank" rel="external">http://blog.csdn.net/matt_mao/article/details/19417451</a></p>
<p>默认为每一个虚机生成的反欺骗规则如下，这样VM的流量才能出去与外界通信。同样，metadata服务响应的流量要出来其源IP是169.254.0.0/16，也应为其添加allowed-address-pairs后流量才能出去。</p>
<p>对于ipv6同样会有一个port有多个ipv6地址的情况，所以_select_ra_ips_for_network_ids方法就是使用ipv6的本地链路地址去为做网关的虚机生成默认的反欺骗规则从而允许其他虚机发过来的RA广播进来。</p>
<p>arget          prot    opt    in     out          source           destination</p>
<p>RETURN     all     –      <em>        </em>          <vm-ip>           0.0.0.0/0           MAC FA:16:3E:38:38:90<br>DROP          all     –      <em>        </em>          0.0.0.0/0            0.0.0.0/0</vm-ip></p>
<p>2)访问dmz规则，FLAGS.dmz_cidr定义了一个dmz列表,虚机应该能访问它，例本例的dmz列表为:10.0.128.0/24</p>
<p>-Anova-network-POSTROUTING -s 10.0.0.0/8 -d 10.0.128.0/24 -j ACCEPT</p>
<p>3)两个虚机互通，从一个子网且不是DNAT的连接放行。</p>
<p>-Anova-network-POSTROUTING -s 10.0.0.0/8 -d 10.0.0.0/8 -m conntrack !–ctstate DNAT</p>
<p>-j ACCEPT</p>
<p>４）SNAT规则，例如从10.0.0.0/8虚机内网网络出去的包将源目址修改为外网IP9.123.1.12</p>
<p>-A nova-network-snat -s10.0.0.0/8 -j SNAT –to-source 9.123.1.122</p>
<p>5)创建网桥要做的事</p>
<p>1，网络节点，转发流量，充当网关</p>
<p>-A nova-network-FORWARD -i br100 -j ACCEPT<br>-A nova-network-FORWARD -o br100 -j ACCEPT<br>2, 若是计算节点要允许虚机与网络节点以及其他计算节点上的虚机相连<br>-A nova-compute-FORWARD -i br100 -j ACCEPT<br>-A nova-compute-FORWARD -o br100 -j ACCEPT<br>若是计算节点要允许虚机与网络节点以及其他计算节点上的虚机相连<br>-A nova-compute-FORWARD -i br100 -j ACCEPT<br>-A nova-compute-FORWARD -o br100 -j ACCEPT<br>３,支持dhcp(67)和dns(53)</p>
<p>-A nova-network-INPUT -i br100 -p udp -m udp –dport 67 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p tcp -m tcp –dport 67 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p udp -m udp –dport 53 -j ACCEPT<br>-A nova-network-INPUT -i br100 -p tcp -m tcp –dport 53 -j ACCEPT<br>４，所以每个虚机的链和规则如下图：</p>
<p>４，所以每个虚机的链和规则如下图：</p>
<p>相应的, neutron l2 agent上的规则如下：</p>
<p>neutron l2 agent上的iptables设置，当它发现有新增tap设备时，就会从DB中取出和tap设备关联的port信息来设置vlan及security group（调用plugin的security_group_rules_for_devices方法获取port的安全组规则信息，规则信息里面已经考虑了允许dhcp, address_pair等）相关设置。每个port对应两条链(iX-XXXX和oX-XXXX), 下面只显示iX-XXXX的作为例子，oX-XXXX的依此类推。实现了这些功能：</p>
<pre><code>prepares, updates, removes firewall filters （准备、更新和删除防火墙过滤器）
drops all packets by default （默认丢弃所有包）
prevents IP spoofing based on port&apos;s mac address (compatible with allowed_address_pairs extension) （防 IP 欺骗）
allows incoming DHCP and ICMPv6 RA （允许进入虚机的 DHCP 包和 ICMPV6 RA）
blocks outgoing DHCP （禁止出虚机的 DHCP 包）
drops INVALID packets （丢弃无效状态的包）
allows stateful, established connections （允许有状态的并且已建立的连接，比如允许进来的 ICMP 的时候，从外面 ping 虚机时虚机的响应包是可以返回的）
converts security group rules to iptables rules (IPv4, IPv6, TCP, UDP, ICMP, ICMPv6) （将用户配置的规则转化为 iptables 规则）
multiple TCP/UDP ports per iptables rule using multiport module
支持 IPV4 和 IPV6
</code></pre><p>相应的链如下：</p>
<p>-N neutron-filter-top<br>-N neutron-openvswi-FORWARD #neutorn 定义的 FORWARD 链<br>-N neutron-openvswi-INPUT   #Neutron 定义的 INPUT 链<br>-N neutron-openvswi-OUTPUT  #Neutron 定义的 OUTPUT 链<br>-N neutron-openvswi-i6e3f2eda-3 #处理进入该虚机的网络包<br>-N neutron-openvswi-local<br>-N neutron-openvswi-o6e3f2eda-3 #处理出该虚机的网络包<br>-N neutron-openvswi-s6e3f2eda-3 #处理出该虚机的网络包的防IP欺骗<br>-N neutron-openvswi-sg-chain<br>-N neutron-openvswi-sg-fallback<br>-A INPUT -j neutron-openvswi-INPUT #将 INPUT 链转到 neutron 的 INPUT 链<br>-A FORWARD -j neutron-filter-top<br>-A FORWARD -j neutron-openvswi-FORWARD #将 FORWARD 链转到 neutorn 的 forward 链<br>-A OUTPUT -j neutron-filter-top<br>-A OUTPUT -j neutron-openvswi-OUTPUT   #将 OUTPUT 链转到 neutron 的 output 链<br>-A neutron-filter-top -j neutron-openvswi-local</p>
<p>-A neutron-openvswi-FORWARD -m physdev –physdev-out tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-sg-chain #处理进入虚机的数据包<br>-A neutron-openvswi-FORWARD -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-sg-chain  #处理出虚机的数据包<br>-A neutron-openvswi-INPUT -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-o6e3f2eda-3 #处理出虚机的数据包</p>
<p>#处理进虚机的包<br>-A neutron-openvswi-i6e3f2eda-3 -m state –state INVALID -j DROP                               #丢弃无效连接<br>-A neutron-openvswi-i6e3f2eda-3 -m state –state RELATED,ESTABLISHED -j RETURN                 #允许已建立的连接<br>-A neutron-openvswi-i6e3f2eda-3 -s 10.0.0.7/32 -p udp -m udp –sport 67 –dport 68 -j RETURN #允许 DHCP 服务器 10.0.0.3 的返回包<br>-A neutron-openvswi-i6e3f2eda-3 -s 10.0.0.2/32 -p udp -m udp –sport 67 –dport 68 -j RETURN #允许 DHCP 服务器 10.0.0.2 的返回包<br>-A neutron-openvswi-i6e3f2eda-3 -j neutron-openvswi-sg-fallback                                #其余包交给 fallback 链处理     </p>
<p>#处理出虚机的包<br>-A neutron-openvswi-o6e3f2eda-3 -p udp -m udp –sport 68 –dport 67 -j RETURN   #允许 DHCP 访问<br>-A neutron-openvswi-o6e3f2eda-3 -j neutron-openvswi-s6e3f2eda-3                 #防止 IP 欺骗<br>-A neutron-openvswi-o6e3f2eda-3 -p udp -m udp –sport 67 –dport 68 -j DROP     #不允许对外提供 DHCP 服务<br>-A neutron-openvswi-o6e3f2eda-3 -m state –state INVALID -j DROP                #禁止无效连接<br>-A neutron-openvswi-o6e3f2eda-3 -m state –state RELATED,ESTABLISHED -j RETURN  #允许已建立的连接<br>-A neutron-openvswi-o6e3f2eda-3 -j neutron-openvswi-sg-fallback                 #其余交给 fallback 链处理</p>
<p>#防 IP 欺骗规则：防止该虚机被利用来做 IP 欺骗攻击。<br>-A neutron-openvswi-s6e3f2eda-3 -s 10.0.0.14/32 -m mac –mac-source FA:16:3E:F3:1E:C0 -j RETURN #允许从虚机发出的MAC 和IP 同虚机的 MAC 和 IP 的包<br>-A neutron-openvswi-s6e3f2eda-3 -j DROP                                                           #禁止其余包</p>
<p>-A neutron-openvswi-sg-chain -m physdev –physdev-out tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-i6e3f2eda-3 #处理进入虚机的包<br>-A neutron-openvswi-sg-chain -m physdev –physdev-in tap6e3f2eda-32 –physdev-is-bridged -j neutron-openvswi-o6e3f2eda-3  #处理出虚机的包</p>
<p>-A neutron-openvswi-sg-chain -j ACCEPT<br>-A neutron-openvswi-sg-fallback -j DROP #丢弃其它包</p>
<p>l3-agent 上FWaaS 相关设置：</p>
<p>-A neutron-l3-agent-iv4XXXXXXXX-XXXX -m state –state INVALID -j DROP<br>-A neutron-l3-agent-iv4XXXXXXXX-XXXX -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A neutron-l3-agent-iv4XXXXXXXX-XXXX … -j ACCEPT/DROP</p>
<p>-A neutron-l3-agent-ov4XXXXXXXX-XXXX -m state –state INVALID -j DROP<br>-A neutron-l3-agent-ov4XXXXXXXX-XXXX -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A neutron-l3-agent-ov4XXXXXXXX-XXXX … -j ACCEPT/DROP</p>
<p>-A neutron-l3-agent-FORWARD -i qr-+ -j neutron-l3-agent-iv4XXXXXXXX-XXXX<br>-A neutron-l3-agent-FORWARD -o qr-+ -j neutron-l3-agent-ov4XXXXXXXX-XXXX<br>-A neutron-l3-agent-FORWARD -o qr-+ -j neutron-l3-agent-fwaas-default-policy<br>-A neutron-l3-agent-FORWARD -i qr-+ -j neutron-l3-agent-fwaas-default-policy</p>
<p>5,nova-api一开始会在filter表内创建一个规则允许他人能访问它（如nova-api的ip是：　172.16.1.122)</p>
<p>-A nova-api-INPUT -d 172.16.1.122/32 -p tcp -m tcp –dport 8775 -j ACCEPT<br>6, 浮动ip即外网ip设置在网络节点的外网网卡上<br>nova-manage floating create –ip_range=192.168.1.232/30<br>Nova floating-ip-create<br>nova add-floating-ip 8f773639-c04f-4885-9349-ac7d6a799843 192.168.1.233</p>
<p>-A nova-network-OUTPUT -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-PREROUTING -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-float-snat -s 10.10.10.2/32 -j SNAT –to-source 192.168.1.233<br>6，如果想ping一个虚机的话，需设置一个安全组规则（nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0），它将产生如下防炎墙rules. 请记住，在此 nova-compute 主机上，针对每个实例必须有一个特定链；其内的规则只允许来自固定子集内的 IP 的流量。<br>-A nova-compute-inst-1 -p icmp -j ACCEPT<br>浮动ip即外网ip设置在网络节点的外网网卡上<br>nova-manage floating create –ip_range=192.168.1.232/30<br>Nova floating-ip-create<br>nova add-floating-ip 8f773639-c04f-4885-9349-ac7d6a799843 192.168.1.233</p>
<p>-A nova-network-OUTPUT -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-PREROUTING -d 192.168.1.233/32 -j DNAT –to-destination 10.10.10.2<br>-A nova-network-float-snat -s 10.10.10.2/32 -j SNAT –to-source 192.168.1.233<br>6，如果想ping一个虚机的话，需设置一个安全组规则（nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0），它将产生如下防炎墙rules. 请记住，在此 nova-compute 主机上，针对每个实例必须有一个特定链；其内的规则只允许来自固定子集内的 IP 的流量。<br>-A nova-compute-inst-1 -p icmp -j ACCEPT</p>
<p>Neutron防火墙的定义位于：</p>
<p>vi/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini</p>
<p>[securitygroup]</p>
<p>firewall_driver =neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</p>
<p>既然neutron的OVSHybridIptablesFirewallDriver接管了计算节点上的防火墙，所以应该确保nova-compute的nova.conf配置：</p>
<p>[DEFAULT]</p>
<p>firewall_driver =nova.virt.firewall.NoopFirewallDriver</p>
<p>查看Neutron中定义防火墙信息命令如下：</p>
<p>[hua@laptop devstack]$ ip netns list</p>
<p>qrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7</p>
<p>qdhcp-8779fa7c-d8ea-4827-a15d-3c7f56cb3ac0</p>
<p>[hua@laptop devstack]$ sudo ip netns execqrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7 iptables-save</p>
<p>[hua@laptop devstack]$ sudo ip netns execqrouter-a4a3f113-4c61-4f74-adb6-ea3b6855a7e7 iptables-restore</p>
<p>下面是这篇文章《利用raw表实现iptables调试》<a href="http://blog.youlingman.info/debugging-iptables-with-raw-table/" target="_blank" rel="external">http://blog.youlingman.info/debugging-iptables-with-raw-table/</a> 中的内容。</p>
<p>关于上面的这个图，先要说一个很重要的说法，上图显示，netfilter实际上既可以在L2层过滤，也可以在L3层过滤的。</p>
<p>所以在网桥中一般会有下面的参数，即要求iptables不对bridge的数据进行处理：</p>
<h1 id="cat-gt-gt-etc-sysctl-conf-lt-lt-EOF"><a href="#cat-gt-gt-etc-sysctl-conf-lt-lt-EOF" class="headerlink" title="cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF"></a>cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</h1><p>  net.bridge.bridge-nf-call-ip6tables = 0<br>  net.bridge.bridge-nf-call-iptables = 0<br>  net.bridge.bridge-nf-call-arptables = 0<br>  EOF</p>
<h1 id="sysctl-p-etc-sysctl-conf"><a href="#sysctl-p-etc-sysctl-conf" class="headerlink" title="sysctl -p /etc/sysctl.conf"></a>sysctl -p /etc/sysctl.conf</h1><p>或者改用下面的方法解决：</p>
<p> iptables -t raw -I PREROUTING -i BRIDGE -s x.x.x.x -j NOTRACK.</p>
<p>如果net.bridge.bridge-nf-call-iptables＝1，也就意味着二层的网桥在转发包时也会被iptables的FORWARD规则所过滤，这样就会出现L3层的iptables rules去过滤L2的帧的问题（packets don’t cross nat table twice, In the bridging process, you don’t know the outgoing interface so the previous rule doesn’t work. He needs the interface because he’s using MASQUERADE. In the routing process, the packets go to iptables but they never cross NAT tables because the packet already crossed the table in the bridging process.<a href="http://www.woitasen.com.ar/2011/09/confusion-using-iptables-nat-and-bridge/），所以涉及一些dnat" target="_blank" rel="external">http://www.woitasen.com.ar/2011/09/confusion-using-iptables-nat-and-bridge/），所以涉及一些dnat</a>, snat就不生效了，举个例子，具体表现在openstack中就是metadata服务不好使了。这个说法可参见：<a href="https://bugzilla.redhat.com/show_bug.cgi?id=512206" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=512206</a></p>
<p>所以这样下面的规则也就失效了，所以<a href="http://blog.youlingman.info/debugging-iptables-with-raw-table/这个文章上的作者调试iptables的方法挺好，但实际上网络为什么不通的问题实质没有找准。" target="_blank" rel="external">http://blog.youlingman.info/debugging-iptables-with-raw-table/这个文章上的作者调试iptables的方法挺好，但实际上网络为什么不通的问题实质没有找准。</a></p>
<p>-A quantum-l3-agent-POSTROUTING ! -i qg-91757ded-c4 ! -o qg-91757ded-c4 -m conntrack ! –ctstate DNAT -j ACCEPT</p>
<p>还有一种等价于上面bridge-nf-call-iptables的做法，即iptables允许bridge上的数据直接转发</p>
<h1 id="iptables-I-FORWARD-m-physdev-–physdev-is-bridged-j-ACCEPT"><a href="#iptables-I-FORWARD-m-physdev-–physdev-is-bridged-j-ACCEPT" class="headerlink" title="iptables -I FORWARD -m physdev –physdev-is-bridged -j ACCEPT"></a>iptables -I FORWARD -m physdev –physdev-is-bridged -j ACCEPT</h1><h1 id="service-iptables-save"><a href="#service-iptables-save" class="headerlink" title="service iptables save"></a>service iptables save</h1><h1 id="service-iptables-restart"><a href="#service-iptables-restart" class="headerlink" title="service iptables restart"></a>service iptables restart</h1><p>physdev是二层的东西，三层的接口用-i来匹配，但二层的需要用physdev模块的physdev-in这个match了。</p>
<p>下列配置抓取所有经过本机的ICMP包：</p>
<p>iptables -t raw -A OUTPUT -p icmp -j TRACE<br>iptables -t raw -A PREROUTING -p icmp -j TRACE<br>modprobe ipt_LOG<br>调试信息记录在/var/log/message文件中</p>
<p>其他：</p>
<p>打开一个端口：</p>
<p>iptables -I INPUT -i eth0 -p tcp –dport 16509 -j ACCEPT<br>iptables  -I OUTPUT -o eth0 -p tcp –sport 16509 -j ACCEPT<br>sudo iptables-save &gt; /tmp/ipt.save<br>cat /tmp/ipt.save | sudo iptables-restore<br>lsof -i:16509</p>
<p>2014-04-25添加：</p>
<p>如果使用neutron中的security group的话，配置如下：</p>
<p>1, /etc/nova/nova.conf:<br>libvirt_vif_driver = nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver<br>linuxnet_interface_driver =nova.network.linux_net.LinuxOVSInterfaceDriver<br>security_group_api = neutron<br>firewall_driver = nova.virt.firewall.NoopFirewallDriver<br>2, /etc/neutron/ovs_neutron_plugin.ini:<br>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</p>
<p>Allowed Address Pairs Extenstion, 除了默认的防火墙, 还有其他什么ip可以穿过, 这样实例就可以用任意的源IP来访问外部网络</p>
<p>资料：</p>
<p>Linux网络路由表处理及钩子（Iptables and Ebtables） <a href="http://blog.chinaunix.net/uid-23741326-id-3573470.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-23741326-id-3573470.html</a></p>
<p>metadata, <a href="http://techbackground.blogspot.jp/2013/06/metadata-via-quantum-router.html" target="_blank" rel="external">http://techbackground.blogspot.jp/2013/06/metadata-via-quantum-router.html</a></p>
<p><a href="https://vietstack.wordpress.com/2014/09/27/introduction-of-metadata-service-in-openstack/" target="_blank" rel="external">https://vietstack.wordpress.com/2014/09/27/introduction-of-metadata-service-in-openstack/</a></p>
<p><a href="http://techbackground.blogspot.ie/2013/06/metadata-via-quantum-router.html" target="_blank" rel="external">http://techbackground.blogspot.ie/2013/06/metadata-via-quantum-router.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/25/k8s-Canal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/25/k8s-Canal/" itemprop="url">k8s Canal</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-25T16:51:16+08:00">
                2021-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2021-01-25<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<p>如OpenStack中的Secrity Group可以用来在传统服务应用架构中来实现层与层这的网络访问规则，但对于容器化的服务场景，一个容器一个应用粒度更小，且主机节点的个数和 IP地址都 是快速变化的，这样分层防火墙的思路不再可行。Calico就是这样一个工具，通过修改每个节点上的iptables与路由来实现容器间数据的路由和访问控制，并通过etcd协调节点配置信息。 K8s Network Policy可使用Calico作为CNI实现隔离性，只有匹配规则的流量才能进入pod，同理只有匹配规则的流量才可以离开pod。<br>Canal是Flannel与Calico的结合，访问控制部分由Calico(calico-node -felix)实现, 网络部分仍由Flannel实现(Calico有BGP路由与IPIP隧道两种，Flannel则有Vxlan隧道)。<br>Calico的网络规则的用法可参见(<a href="https://www.open-open.com/news/view/1a7c496" target="_blank" rel="external">https://www.open-open.com/news/view/1a7c496</a>), k8s通过CNI集成Canal能使用Calico实现的网络规则部分，但用法是怎样的呢(可参见－<a href="https://www.jianshu.com/p/331235d8bcbb）：" target="_blank" rel="external">https://www.jianshu.com/p/331235d8bcbb）：</a></p>
<ul>
<li>通过kubectl client创建NetworkPolicy资源</li>
<li>calico的policy-controller(calico-kube-controllers集成了calicoctl用于写policy)监听networkpolicy资源，获取到后写入calico的etcd数据库</li>
<li>node上calico-felix从etcd数据库中获取policy资源，调用iptables做相应配置。</li>
</ul>
<p>Calico policy架构<br><img src="https://img-blog.csdnimg.cn/20210126153921730.png#pic_center" alt=""></p>
<p>在node上最终生成的最终iptables如下：<br><img src="https://img-blog.csdnimg.cn/20210126153850128.png#pic_center" alt="在这里插入图片描述"></p>
<h2 id="测试环境信息"><a href="#测试环境信息" class="headerlink" title="测试环境信息"></a>测试环境信息</h2><p>kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1的IP如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-master/0*      active    idle   3        10.5.2.205      6443/tcp        Kubernetes master running.</span><br><span class="line">  canal/2*                active    idle            10.5.2.205                      Flannel subnet 10.1.49.1/24</span><br><span class="line">  containerd/2*           active    idle            10.5.2.205                      Container runtime available</span><br><span class="line">kubernetes-worker/0*      active    idle   4        10.5.3.197      80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  canal/0                 active    idle            10.5.3.197                      Flannel subnet 10.1.94.1/24</span><br><span class="line">  containerd/0            active    idle            10.5.3.197                      Container runtime available</span><br><span class="line">kubernetes-worker/1       active    idle   5        10.5.4.4        80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line">  canal/1                 active    idle            10.5.4.4                        Flannel subnet 10.1.3.1/24</span><br><span class="line">  containerd/1            active    idle            10.5.4.4                        Container runtime available</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE    IP          NODE                NOMINATED NODE   READINESS GATES</span><br><span class="line">ubuntu-debug-794979f648-4dj8w   1/1     Running   1          118m   10.1.3.14   juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ubuntu-debug-794979f648-fwdmv   1/1     Running   1          118m   10.1.94.7   juju-11ff05-k8s-4   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="canal中的flannel提供pod-to-pod通信"><a href="#canal中的flannel提供pod-to-pod通信" class="headerlink" title="canal中的flannel提供pod-to-pod通信"></a>canal中的flannel提供pod-to-pod通信</h2><p>flannel内的tunnel网段是10.1.0.0/16，vxlan类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.5.1.44:2379 get /coreos.com/network/config</span><br><span class="line">&#123;&quot;Network&quot;: &quot;10.1.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>flannel为kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1分配的subnet分别是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.5.1.44:2379 ls /coreos.com/network/subnets/</span><br><span class="line">/coreos.com/network/subnets/10.1.94.0-24 (kubernetes-worker/0)</span><br><span class="line">/coreos.com/network/subnets/10.1.3.0-24  (kubernetes-worker/1)</span><br><span class="line">/coreos.com/network/subnets/10.1.49.0-24 (kubernetes-master/0)</span><br></pre></td></tr></table></figure></p>
<p>flannel是根据subnet.env分配的，kubernetes-master/0, kubernetes-worker/0, kubernetes-worker/1均应有下列配置，下面只是粘出了kubernetes-worker/0上的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# cat /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.1.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.1.94.1/24</span><br><span class="line">FLANNEL_MTU=8908</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip addr show flannel.1 |grep global</span><br><span class="line">    inet 10.1.94.0/32 scope global flannel.1</span><br></pre></td></tr></table></figure></p>
<p>防火墙应该允许该子网的流量进入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#on kubernetes-worker/0, it should ALLOW 10.1.94.0/24</span><br><span class="line">root@juju-11ff05-k8s-4:~# iptables-save |grep 10.1.94 |grep POST</span><br><span class="line">-A POSTROUTING ! -s 10.1.0.0/16 -d 10.1.94.0/24 -j RETURN</span><br><span class="line"># iptables -t nat -nvL |grep &apos;Chain POSTROUTING&apos; -A9</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1447 packets, 89820 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 1885  119K KUBE-POSTROUTING  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span><br><span class="line">    8   460 fan-egress  all  --  *      *       252.0.0.0/8          0.0.0.0/0</span><br><span class="line">  183 11249 RETURN     all  --  *      *       10.1.0.0/16          10.1.0.0/16</span><br><span class="line">    6   360 MASQUERADE  all  --  *      *       10.1.0.0/16         !224.0.0.0/4</span><br><span class="line">    0     0 RETURN     all  --  *      *      !10.1.0.0/16          10.1.94.0/24</span><br><span class="line">    0     0 MASQUERADE  all  --  *      *      !10.1.0.0/16          10.1.0.0/16</span><br></pre></td></tr></table></figure></p>
<p>另外，底层docker或contained也应该将etcd中为每个节点配置的subnet加载进去：</p>
<ul>
<li>如果使用docker, 容器内的流量会先到docker0, 然后根据下列路由到flannel.1</li>
<li>如果使用containerd，是通过下列的/etc/cni/net.d/10-canal.conflist文件将subnet设置进flannel的。<h2 id="canal中的Calico-Felix提供网络访问规则"><a href="#canal中的Calico-Felix提供网络访问规则" class="headerlink" title="canal中的Calico/Felix提供网络访问规则"></a>canal中的Calico/Felix提供网络访问规则</h2>本来calico的felix（通过calico-node -felix运行）是运行在每个节点上负责配置路由及网络访问规则的，现在路由这块不做还是由Flannel来做，所以主要用到felix的网络访问规则。calio的felix的访问规则这块由下列iptables实现(详见Calico网络模型 - <a href="https://www.cnblogs.com/menkeyi/p/11364977.html)，但尚不清楚canal有没有作其他更改。" target="_blank" rel="external">https://www.cnblogs.com/menkeyi/p/11364977.html)，但尚不清楚canal有没有作其他更改。</a><br><img src="https://img-blog.csdnimg.cn/2021012519223249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# route -n |grep flannel</span><br><span class="line">10.1.3.0        10.1.3.0        255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.49.0       10.1.49.0       255.255.255.0   UG    0      0        0 flannel.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>接着流量会被封装成vxlan tunnel送到对方endpoint.<br>Calico如何管网络策略的还没研究清楚(我估计上节中的充许防火墙规则就是这块设置的，当然只是猜测)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">root@juju-11ff05-k8s-4:~# ip addr show |grep cali -A1</span><br><span class="line">6: cali8215eb6fd4a@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-262d6f97-ad60-b48b-85e1-ee180b620c30</span><br><span class="line">--</span><br><span class="line">7: cali105686d7bac@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-09304b68-97b3-c72b-2bd6-b47d9f626890</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.5.0.1        0.0.0.0         UG    100    0        0 ens3</span><br><span class="line">10.1.3.0        10.1.3.0        255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.49.0       10.1.49.0       255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.1.94.6       0.0.0.0         255.255.255.255 UH    0      0        0 cali105686d7bac</span><br><span class="line">10.1.94.7       0.0.0.0         255.255.255.255 UH    0      0        0 cali8215eb6fd4a</span><br><span class="line">10.5.0.0        0.0.0.0         255.255.0.0     U     0      0        0 ens3</span><br><span class="line">169.254.169.254 10.5.0.1        255.255.255.255 UGH   100    0        0 ens3</span><br><span class="line">252.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 fan-252</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-09304b68-97b3-c72b-2bd6-b47d9f626890 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-262d6f97-ad60-b48b-85e1-ee180b620c30 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ctr c ls</span><br><span class="line">CONTAINER      IMAGE                                              RUNTIME</span><br><span class="line">calico-node    rocks.canonical.com:443/cdk/calico/node:v3.10.1    io.containerd.runc.v2</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns</span><br><span class="line">cni-09304b68-97b3-c72b-2bd6-b47d9f626890 (id: 1)</span><br><span class="line">cni-262d6f97-ad60-b48b-85e1-ee180b620c30 (id: 0)</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-09304b68-97b3-c72b-2bd6-b47d9f626890 ip addr show |grep eth0</span><br><span class="line">3: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    inet 10.1.94.6/32 scope global eth0</span><br><span class="line">root@juju-11ff05-k8s-4:~# ip netns exec cni-262d6f97-ad60-b48b-85e1-ee180b620c30 ip addr show |grep eth0</span><br><span class="line">3: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    inet 10.1.94.7/32 scope global eth0</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# cat /etc/cni/net.d/10-canal.conflist</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;cdk-canal&quot;,</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;calico&quot;,</span><br><span class="line">      &quot;etcd_endpoints&quot;: &quot;https://10.5.1.44:2379&quot;,</span><br><span class="line">      &quot;etcd_key_file&quot;: &quot;/opt/calicoctl/etcd-key&quot;,</span><br><span class="line">      &quot;etcd_cert_file&quot;: &quot;/opt/calicoctl/etcd-cert&quot;,</span><br><span class="line">      &quot;etcd_ca_cert_file&quot;: &quot;/opt/calicoctl/etcd-ca&quot;,</span><br><span class="line">      &quot;log_level&quot;: &quot;info&quot;,</span><br><span class="line">      &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.1.94.1/24&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;policy&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;k8s&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;kubeconfig&quot;: &quot;/root/cdk/kubeconfig&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">      &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125;,</span><br><span class="line">      &quot;snat&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="iptables提供Service-to-Pod通信"><a href="#iptables提供Service-to-Pod通信" class="headerlink" title="iptables提供Service-to-Pod通信"></a>iptables提供Service-to-Pod通信</h2><p>以dashboard为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services -A |grep kubernetes-dashboard</span><br><span class="line">kubernetes-dashboard              dashboard-metrics-scraper                ClusterIP   10.152.183.92    &lt;none&gt;        8000/TCP                 3d22h</span><br><span class="line">kubernetes-dashboard              kubernetes-dashboard                     ClusterIP   10.152.183.89    &lt;none&gt;        443/TCP                  3d22h</span><br><span class="line">$ kubectl describe --namespace kubernetes-dashboard service kubernetes-dashboard |grep -E &apos;IPs|Endpoints|Port&apos;</span><br><span class="line">IPs:               10.152.183.89</span><br><span class="line">Port:              &lt;unset&gt;  443/TCP</span><br><span class="line">TargetPort:        8443/TCP</span><br><span class="line">Endpoints:         10.1.3.16:8443</span><br><span class="line">$ kubectl get pods -A -o wide |grep dashboard</span><br><span class="line">kubernetes-dashboard              dashboard-metrics-scraper-74757fb5b7-9rqxd                1/1     Running   1          3d22h   10.1.3.17    juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard              kubernetes-dashboard-64f87676d4-s26bs                     1/1     Running   1          3d22h   10.1.3.16    juju-11ff05-k8s-5   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">root@juju-11ff05-k8s-4:~# iptables-save |grep kubernetes-dashboard</span><br><span class="line">-A KUBE-SEP-LGG4MZT3C2GWQFZG -s 10.1.3.17/32 -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-LGG4MZT3C2GWQFZG -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -m tcp -j DNAT --to-destination 10.1.3.17:8000</span><br><span class="line">-A KUBE-SEP-RMJCCMAWKQ3DCGZP -s 10.1.3.16/32 -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-RMJCCMAWKQ3DCGZP -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -m tcp -j DNAT --to-destination 10.1.3.16:8443</span><br><span class="line">-A KUBE-SERVICES ! -s 10.1.0.0/16 -d 10.152.183.92/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper cluster IP&quot; -m tcp --dport 8000 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -d 10.152.183.92/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper cluster IP&quot; -m tcp --dport 8000 -j KUBE-SVC-Z6GDYMWE5TV2NNJN</span><br><span class="line">-A KUBE-SERVICES ! -s 10.1.0.0/16 -d 10.152.183.89/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard cluster IP&quot; -m tcp --dport 443 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SERVICES -d 10.152.183.89/32 -p tcp -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard cluster IP&quot; -m tcp --dport 443 -j KUBE-SVC-CEZPIJSAUFW5MYPQ</span><br><span class="line">-A KUBE-SVC-CEZPIJSAUFW5MYPQ -m comment --comment &quot;kubernetes-dashboard/kubernetes-dashboard&quot; -j KUBE-SEP-RMJCCMAWKQ3DCGZP</span><br><span class="line">-A KUBE-SVC-Z6GDYMWE5TV2NNJN -m comment --comment &quot;kubernetes-dashboard/dashboard-metrics-scraper&quot; -j KUBE-SEP-LGG4MZT3C2GWQFZG</span><br></pre></td></tr></table></figure></p>
<h2 id="相关服务"><a href="#相关服务" class="headerlink" title="相关服务"></a>相关服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status flannel</span><br><span class="line">systemctl status calico-node.service</span><br><span class="line">systemctl status snap.kubelet.daemon.service</span><br></pre></td></tr></table></figure>
<h2 id="附录-一个客户问题"><a href="#附录-一个客户问题" class="headerlink" title="附录 - 一个客户问题"></a>附录 - 一个客户问题</h2><p>一个客户有一个k8s over vSphere managed by juju 环境，报告使用    goldpinger发现pod间网络不通。<br>先是遇到问题<a href="https://bugs.launchpad.net/juju/+bug/1831244，juju" target="_blank" rel="external">https://bugs.launchpad.net/juju/+bug/1831244，juju</a> controllers与vSphere之间存在用户名和密码的问题，这样”juju status –format yaml”能看到controller处于suspended状态（注意：只有带–format yaml才能看到得）。<br>解决1831244之后就可以正常创建新节点了，将那个失败的keycloak pod迁移到新节点，问题依然存在，’kubectl logs’看到keycloak失败原因是： ‘Caused by: java.net.UnknownHostException: postgres’<br>显然，keycloak依赖于postgres service, 存在dns问题。<br>coredns并没有从旧节新移到新节点，旧节点上存在一个问题, canal的flannel使用的subnet(/run/flannel/subnet.env)与canal的calico使用的subnet(/etc/cni/net.d/10-canal.conflist)不一致，这样导致旧节点上的iptables下列倒数第二行就弄错了，没有充许flannel的数据包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grep -A9 &quot;Chain POSTROUTING&quot; sos_commands/networking/iptables_-t_nat_-nvL</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">pkts bytes target prot opt in out source destination</span><br><span class="line">1411K 88M cali-POSTROUTING all -- * * 0.0.0.0/0 0.0.0.0/0 /* cali:O3lYWMrLQYEMJtB5 */</span><br><span class="line">1378K 86M CNI-HOSTPORT-MASQ all -- * * 0.0.0.0/0 0.0.0.0/0 /* CNI portfwd requiring masquerade */</span><br><span class="line">1376K 86M KUBE-POSTROUTING all -- * * 0.0.0.0/0 0.0.0.0/0 /* kubernetes postrouting rules */</span><br><span class="line">800K 50M RETURN all -- * * 172.17.240.0/20 172.17.240.0/20</span><br><span class="line">0 0 MASQUERADE all -- * * 172.17.240.0/20 !224.0.0.0/4</span><br><span class="line">0 0 RETURN all -- * * !172.17.240.0/20 172.17.247.0/24</span><br><span class="line">521K 31M MASQUERADE all -- * * !172.17.240.0/20 172.17.240.0/20</span><br></pre></td></tr></table></figure></p>
<p>下列语句可以查询etcd中每个节点的subnet配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju run -u kubernetes-worker/&lt;N&gt; etcdctl --cert-file /etc/ssl/flannel/client-cert.pem --key-file /etc/ssl/flannel/client-key.pem --ca-file /etc/ssl/flannel/client-ca.pem -endpoints=https://10.1.234.195:2379,https://10.1.234.196:2379,https://10.1.234.203:2379 ls /coreos.com/network/subnets/</span><br></pre></td></tr></table></figure></p>
<p>需要先从etcd里删除它　－　rm /coreos.com/network/subnets/172.17.247.0-24<br>然后重它systemctl restart flannel.service, 接着将 /run/flannel/subnet.env的subnet更新为正确的subnet, 之后通过“ip a s flannel.1 ”确认。最后：<br>systemctl restart calico-node.service<br>systemctl restart snap.kubelet.daemon.service</p>
<h2 id="calicoctl测试"><a href="#calicoctl测试" class="headerlink" title="calicoctl测试"></a>calicoctl测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">juju ssh kubernetes-worker/0 -- sudo -s</span><br><span class="line">#https://docs.projectcalico.org/getting-started/clis/calicoctl/install</span><br><span class="line">curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.17.1/calicoctl</span><br><span class="line">cp calicoctl /usr/bin/ &amp;&amp; chmod +x /usr/bin/calicoctl</span><br><span class="line">#copy env variable like ETCD_ENDPOINTS from the output of &apos;ps -ef |grep calicoctl&apos;</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get networkPolicy</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get globalNetworkPolicy</span><br><span class="line"></span><br><span class="line">k8s networkpolicy - https://docs.projectcalico.org/security/kubernetes-network-policy</span><br><span class="line">calico networkpolicy - https://docs.projectcalico.org/security/calico-network-policy</span><br><span class="line">cat &lt;&lt; EOF | sudo tee calicoPolicyTest.yaml</span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: GlobalNetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-circle-blue</span><br><span class="line">spec:</span><br><span class="line">  selector: k8s-app == &apos;kubernetes-dashboard&apos;</span><br><span class="line">  ingress:</span><br><span class="line">  - action: Deny</span><br><span class="line">    protocol: TCP</span><br><span class="line">    destination:</span><br><span class="line">      ports:</span><br><span class="line">      - 22</span><br><span class="line">EOF</span><br><span class="line">ETCD_ENDPOINTS=https://10.5.0.131:2379 ETCD_CA_CERT_FILE=/opt/calicoctl/etcd-ca ETCD_CERT_FILE=/opt/calicoctl/etcd-cert ETCD_KEY_FILE=/opt/calicoctl/etcd-key calicoctl get globalNetworkPolicy</span><br><span class="line">#go to the worker which dashboard pos is on (kubectl get pod -A -o wide |grep dash)</span><br><span class="line">iptables-save |grep 2222</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210127200046326.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p>[1] <a href="https://courses.academy.tigera.io/courses/course-v1:tigera+CCO-L1+CCO-L1-2020/course/" target="_blank" rel="external">https://courses.academy.tigera.io/courses/course-v1:tigera+CCO-L1+CCO-L1-2020/course/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/23/ebpf-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/23/ebpf-study/" itemprop="url">ebpf study</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-23T09:38:20+08:00">
                2021-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>作者：张华 发表于：2020-01-13<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明</strong></p>
<h2 id="动态追踪工具比较"><a href="#动态追踪工具比较" class="headerlink" title="动态追踪工具比较"></a>动态追踪工具比较</h2><p>为了追踪内核或用户空间的事件，Dtrace和SystemTap都会把用户传入的追踪处理函数（一般称为 Action），关联到被称为探针的检测点上。这些探针，实际上也就是各种动态追踪技术所依赖的事件源。<br>在这些探针的基础上，Linux 也提供了一系列的动态追踪机制，比如内核内的ftrace、perf、eBPF等。内核外的SystemTap等。</p>
<ul>
<li>ftrace，侧重于函数跟踪，但最早用于函数跟踪，现在又扩展支持了各种事件跟踪功能。ftrace通过debugfs以普通文件的形式，向用户空间提供访问接口。这样，不需要额外的工具，你就可以通过挂载点（通常为/sys/kernel/debug/tracing 目录）内的文件读写，来跟 ftrace 交互，跟踪内核或者应用程序的运行事件。</li>
<li>perf,侧重于性能分析，是一种最简单的静态跟踪机制。通过perf，应用程序可以利用PMU、tracepoint和内核中的计数器来进行性能统计。</li>
<li>eBPF则在BPFBerkeley Packet Filter）的基础上扩展而来，不仅支持事件跟踪机制，还可以通过自定义的 BPF代码（使用 C 语言）来自由扩展。所以，eBPF实际上就是常驻于内核的运行时，可以说就是Linux版的DTrace。</li>
<li>SystemTap不像Dtrace并没有常驻内核的运行时，它需要先把脚本编译为内核模块，然后再插入到内核中执行。这也导致SystemTap启动比较缓慢，并且依赖于完整的调试符号表。ftrace和perf的功能已经比较丰富了，不过，它们有一个共同的缺陷，那就是它们只是DSL不够灵活，没法像DTrace那样通过脚本自由扩展。eBPF就是Linux版的 DTrace，可以通过C语言自由扩展（这些扩展通过 LLVM 转换为 BPF字节码后，加载到内核中执行）。</li>
<li>SystemTap, 在eBPF出现之前，SystemTap是最接近DTrace的动态追踪机制，不过在很长时间都游离于内核之外，且是以内核模块运行。</li>
<li>sysdig，主要用于容器的动态追踪，sysdig = strace + tcpdump + htop + iftop + lsof + docker inspect + ebpf<h2 id="常用动态追踪场景和工具"><a href="#常用动态追踪场景和工具" class="headerlink" title="常用动态追踪场景和工具"></a>常用动态追踪场景和工具</h2></li>
<li>内核函数跟踪: ftrace, trace-cmd</li>
<li>CPU性能分析和堆栈解析： perf, 火焰图</li>
<li>4.x内核跟踪内核或应用程序函数或事件： ebpf, bcctools, systemtap</li>
<li>Docker容器应用性能分析: sysdig</li>
</ul>
<h2 id="libbcc"><a href="#libbcc" class="headerlink" title="libbcc"></a>libbcc</h2><p>libbcc(sudo apt install bpfcc-tools)和libbpf库是bcc的前身, 这两个库提供了使用BPF程序对事件进行观测的函数. bpftrace是另一个基于DSL的前端工具。<br><img src="https://img-blog.csdnimg.cn/2021012309290472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>且BCC源代码库中提供了70多个BPF现成工具:</p>
<p><img src="https://img-blog.csdnimg.cn/20210123092923580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>例如（详见 - <a href="https://www.howtoing.com/bcc-best-linux-performance-monitoring-tools/" target="_blank" rel="external">https://www.howtoing.com/bcc-best-linux-performance-monitoring-tools/</a> )：</p>
<ul>
<li>execsnoop -t 通过跟踪execve系统调用可以知道一个程序正在调用其他哪些进程。</li>
<li>statsnoop, 跟踪stat系统调用</li>
<li>biotop, biosnoop</li>
<li>tcpconnect, 跟踪tcp连接.</li>
</ul>
<h2 id="BPFTool"><a href="#BPFTool" class="headerlink" title="BPFTool"></a>BPFTool</h2><p>BPFTool是一个管理BPF程序和映射的内核工具。下面讲解如何安装它。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#install hwe kernel</span><br><span class="line">sudo add-apt-repository ppa:canonical-kernel-team/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install linux-image-generic-hwe-20.04</span><br><span class="line">sudo reboot</span><br><span class="line"></span><br><span class="line">#install bcc-tools - on bionic</span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD</span><br><span class="line">echo &quot;deb https://repo.iovisor.org/apt/$(lsb_release -cs) $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/iovisor.list</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install bcc-tools libbcc-examples python3-bcc</span><br><span class="line">ls /usr/share/bcc/tools</span><br><span class="line"></span><br><span class="line"># install bcc-tools - on focal, at the moment the iovisor doesn’t have a release for focal, so you have to use bionic</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/bcc-lua_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/bcc-tools_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/python-bcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/python3-bcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/libbcc-examples_0.10.0-34.git.6836168f_amd64.deb</span><br><span class="line">wget https://repo.iovisor.org/apt/bionic/pool/main/b/bcc/libbcc_0.10.0-34.git.6836168f_all.deb</span><br><span class="line">sudo apt install ./libbcc_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./python-bcc_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./bcc-tools_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./bcc-lua_0.10.0-34.git.6836168f_all.deb -y</span><br><span class="line">sudo apt install ./libbcc-examples_0.10.0-34.git.6836168f_amd64.deb -y</span><br><span class="line"></span><br><span class="line">sudo apt install linux-headers-$(uname -r) linux-tools-$(uname -r) -y</span><br><span class="line"></span><br><span class="line">#install hwe kernel source linux-source-5.4.0 and build bpftool (bpftool is for viewing and manipulating BPF objects)</span><br><span class="line">sudo apt install build-essential binutils-dev libelf-dev -y</span><br><span class="line">#unment deb-src line in /etc/apt/sources.list.d/canonical-kernel-team-ubuntu-ppa-bionic.list</span><br><span class="line">VER=$(uname -r |awk -F &quot;-&quot; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">sudo apt-cache policy linux-source-$VER</span><br><span class="line">sudo apt install linux-source-$VER  #linux-source-5.4.0</span><br><span class="line">mkdir -p /bak/build/hwe &amp;&amp; cd /bak/build/hwe</span><br><span class="line">cp /usr/src/linux-source-$&#123;VER&#125;/linux-source-$&#123;VER&#125;.tar.bz2 .</span><br><span class="line">tar vxf linux-source-$&#123;VER&#125;.tar.bz2</span><br><span class="line">make -C ./linux-source-$&#123;VER&#125;/tools/bpf/bpftool</span><br><span class="line">sudo cp ./linux-source-$&#123;VER&#125;/tools/bpf/bpftool/bpftool /usr/local/bin/</span><br><span class="line">bpftool --version</span><br><span class="line"></span><br><span class="line">#DEMO</span><br><span class="line">#The perf subcommand shows BPF programs attached via perf_event_open()</span><br><span class="line">sudo bpftool perf</span><br><span class="line">#The prog show subcommand lists all programs (not just those that are perf_event_open() based)</span><br><span class="line">sudo bpftool prog show</span><br><span class="line">#Each BPF program can be printed/dumped via it&apos;s ID</span><br><span class="line">#the xlated mode prints the BPF instructions translated to assembly, linum mode can used to included source file num info.</span><br><span class="line">#opcodes modifier can be used to include the BPF instruction opcodes</span><br><span class="line">#visual modifier can be used to emit control flow graph info in DOT/GraphViz format (dot -Tpng -Elen=2.5 xx.dot -o xx.png)</span><br><span class="line">sudo bpftool prog dump xlated id &lt;ID&gt; linum</span><br><span class="line">#jited subcommand shows the machine code for the processor that is executed</span><br><span class="line">sudo bpftool prog dump jited id &lt;ID&gt;</span><br><span class="line">#while tcpdump can emit BPF instructions with -d, bpftrace can do the same thing with -v</span><br><span class="line">sudo tcpdump -nni eth0 &apos;tcp port 80&apos; -d &gt; test.bt</span><br><span class="line">#this file must be saved at home dir to avoid &apos;No such file or directory&apos; when using snap</span><br><span class="line">sudo /snap/bin/bpftrace -v test.bt</span><br></pre></td></tr></table></figure></p>
<h2 id="Running-ebpf-examples-and-writing-the-pure-C-ebpf"><a href="#Running-ebpf-examples-and-writing-the-pure-C-ebpf" class="headerlink" title="Running ebpf examples and writing the pure C ebpf"></a>Running ebpf examples and writing the pure C ebpf</h2><p>ebpf是bpf的扩展，相比bpf添加了更多的寄存器，特别充许通过mapping将事件/数据(FD)从内核态往用户态或在ebpf程序之前共享从而扩大的bpf的使用场景。<br><img src="https://img-blog.csdnimg.cn/20210123093623710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#good doc - https://www.ebpf.top/post/ebpf_c_env/</span><br><span class="line">sudo apt install libncurses5-dev build-essential git make libelf-dev clang llvm strace tar bpfcc-tools linux-headers-$(uname -r) gcc-multilib  flex  bison libssl-dev binutils-dev -y</span><br><span class="line">VER=$(uname -r |awk -F &quot;-&quot; &apos;&#123;print $1&#125;&apos;)</span><br><span class="line">mkdir -p /bak/build/kernel &amp;&amp; cd /bak/build/kernel</span><br><span class="line">cp /usr/src/linux-source-$&#123;VER&#125;/linux-source-$&#123;VER&#125;.tar.bz2 .</span><br><span class="line">tar vxf linux-source-$&#123;VER&#125;.tar.bz2</span><br><span class="line">cd linux-source-$&#123;VER&#125;</span><br><span class="line">#make defconfig &amp;&amp; make menuconfig</span><br><span class="line">cp -v /boot/config-$(uname -r) .config</span><br><span class="line">make headers_install</span><br><span class="line">make scripts  #fix the error &apos;scripts/mod/modpost: not found&apos;</span><br><span class="line"># for the error &apos;./include/linux/spinlock.h:60:10: fatal error: &apos;asm/mmiowb.h&apos; file not found&apos;</span><br><span class="line">sudo find / -name &apos;mmiowb.h&apos;</span><br><span class="line">#mkdir -p include/asm</span><br><span class="line">#sudo cp /usr/src/linux-headers-5.4.0-60-generic/arch/x86/include/generated/asm/* include/asm</span><br><span class="line">#compile bpf exmaple</span><br><span class="line">#make oldconfig &amp;&amp; make prepare</span><br><span class="line">#make M=samples/bpf clean</span><br><span class="line">make M=samples/bpf</span><br><span class="line">ls samples/bpf/</span><br><span class="line"></span><br><span class="line">cd /bak/build/kernel/linux-source-5.4.0/samples/bpf</span><br><span class="line">cat &lt;&lt; EOF | sudo tee hello_kern.c</span><br><span class="line">#include &lt;linux/bpf.h&gt;</span><br><span class="line">#define SEC(NAME) __attribute__((section(NAME), used))</span><br><span class="line"></span><br><span class="line">SEC(&quot;tracepoint/syscalls/sys_enter_execve&quot;)</span><br><span class="line">int bpf_prog(void *ctx)&#123;</span><br><span class="line">	char msg[] = &quot;Hello BPF!\n&quot;;</span><br><span class="line">	bpf_trace_printk(msg, sizeof(msg));</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">char _license[] SEC(&quot;license&quot;) = &quot;GPL&quot;;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee hello_user.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;bpf_load.h&quot;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)&#123;</span><br><span class="line">	if(load_bpf_file(&quot;hello_kern.o&quot;)!=0)&#123;</span><br><span class="line">		printf(&quot;The kernel didn&apos;t load BPF program\n&quot;);</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	read_trace_pipe();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#use Makefile to compile them</span><br><span class="line">vim /bak/build/kernel/linux-source-5.4.0/samples/bpf/Makefile</span><br><span class="line">hostprogs-y += hello</span><br><span class="line">hello-objs := bpf_load.o hello_user.o</span><br><span class="line">always += hello_kern.o</span><br><span class="line"></span><br><span class="line">cd ../../ &amp;&amp; make M=samples/bpf V=1</span><br><span class="line">llvm-objdump -S -no-show-raw-insn hello_kern.o</span><br><span class="line">cd sample/bfp &amp;&amp; ./hello</span><br><span class="line">hua@node1:/bak/build/kernel/linux-source-5.4.0$ ls samples/bpf/hello*</span><br><span class="line">samples/bpf/hello  samples/bpf/hello_kern.c  samples/bpf/hello_kern.o  samples/bpf/hello_user.c  samples/bpf/hello_user.o</span><br><span class="line"></span><br><span class="line">#or use clang and gcc to compile instead of Makefile</span><br><span class="line">clang -I/usr/src/linux-headers-$(uname -r)/include -I/usr/include/x86_64-linux-gnu \</span><br><span class="line">-O2 -target bpf  -c hello_kern.c -o hello_kern.o</span><br><span class="line">gcc \</span><br><span class="line">    -I /usr/include/x86_64-linux-gnu \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/arch/x86/include/generated \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/include \</span><br><span class="line">    -I /usr/src/linux-headers-$(uname -r)/arch/x86/include  \</span><br><span class="line">    -O2 -Wall -g -lelf -lbpf \</span><br><span class="line">    -o hello_user hello_user.c bpf_load.c</span><br></pre></td></tr></table></figure>
<h2 id="Using-BPF-USDT-to-trace-Python-OpenStack"><a href="#Using-BPF-USDT-to-trace-Python-OpenStack" class="headerlink" title="Using BPF USDT to trace Python/OpenStack"></a>Using BPF USDT to trace Python/OpenStack</h2><p>see <a href="https://zhhuabj.blog.csdn.net/article/details/112633898" target="_blank" rel="external">https://zhhuabj.blog.csdn.net/article/details/112633898</a></p>
<h2 id="BPFTrace-example-bcache-debug"><a href="#BPFTrace-example-bcache-debug" class="headerlink" title="BPFTrace example - bcache debug"></a>BPFTrace example - bcache debug</h2><p><img src="https://img-blog.csdnimg.cn/20210123093257219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>详见：<a href="https://blog.csdn.net/loy_184548/article/details/104624854" target="_blank" rel="external">https://blog.csdn.net/loy_184548/article/details/104624854</a><br>BPFTrace充许你使用DSL编写BPF程序，是一个类似于DTrace的替代品，与用C语言或其他工具直接编写BPF程序相比，使用BPFTrace的优势之一是它提供了很多内置功能，无须自己实现，比如聚合信息和创建直方图。另一方面，它的编程能力有限。<br>下面的@代表映射<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee bcache_io_lat.bt</span><br><span class="line">#include &lt;linux/bio.h&gt;</span><br><span class="line"></span><br><span class="line">kprobe:cached_dev_make_request</span><br><span class="line">&#123;</span><br><span class="line">   @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:bio_endio /@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line"> if(((struct bio *)arg0)-&gt;bi_opf &amp; 1) &#123;</span><br><span class="line">    @write = hist(nsecs - @start[arg0]); delete(@start[arg0]);</span><br><span class="line"> &#125;</span><br><span class="line"> else &#123;</span><br><span class="line">    @read = hist(nsecs - @start[arg0]); delete(@start[arg0]);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl restart apparmor</span><br><span class="line">sudo dpkg-reconfigure apparmor</span><br><span class="line">sudo snap install bpftrace --devmode</span><br><span class="line">sudo snap connect bpftrace:system-trace</span><br><span class="line">#this file must be saved at home dir to avoid &apos;No such file or directory&apos; when using snap</span><br><span class="line">sudo /snap/bin/bpftrace bcache_io_lat.bt</span><br></pre></td></tr></table></figure></p>
<h2 id="XDP"><a href="#XDP" class="headerlink" title="XDP"></a>XDP</h2><p>XDP使用于ACL，在网络包进入网卡还未进行内核前就判断是ACCEPT还是TROP还是REDIRECT.<br><img src="https://img-blog.csdnimg.cn/2021012309374782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F1cWk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="sysdig"><a href="#sysdig" class="headerlink" title="sysdig"></a>sysdig</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#https://sysdig.com/blog/let-light-sysdig-adds-container-visibility/</span><br><span class="line">#https://sysdig.com/blog/digging-into-kubernetes-with-sysdig/</span><br><span class="line">sudo apt install linux-headers-$(uname -r) sysdig -y</span><br><span class="line">sudo sysdig -c lscontainers</span><br><span class="line">sudo sysdig -c topcontainers_cpu -pc  #cpu</span><br><span class="line">sudo sysdig -c topprocs_net -pc       #net</span><br><span class="line">sudo sysdig -pc -c topconns           #socket</span><br><span class="line">sudo sysdig -c topcontainers_file     #disk</span><br><span class="line">sudo sysdig -pc -c topprocs_file      #disk io</span><br><span class="line">#new connection on container calico-node (sudo ctr c ls)</span><br><span class="line">sudo sysdig -p&quot;%fd.name&quot; container.name=calico-node and evt.type=accept</span><br><span class="line">#send and receive data on 80 port of container calico-node</span><br><span class="line">sudo sysdig -A -cecho_fds container.name=calico-node and fd.port=80</span><br><span class="line">#view the activity of a file (regardless of which container it belongs to)</span><br><span class="line">sudo sysdig -pc -c echo_fds &quot;fd.name=/etc/passwd&quot;</span><br><span class="line">#io spectrogram</span><br><span class="line">sudo sysdig -c spectrogram fd.type=file and container.name=calico-node</span><br><span class="line">#data traffic between containers</span><br><span class="line">#kubectl exec -ti ubuntu-debug-794979f648-4dj8w ping 10.1.94.7</span><br><span class="line">sudo sysdig -pc -A -c echo_fds &quot;fd.ip=10.1.3.14 and fd.ip=10.1.94.7&quot;</span><br><span class="line"></span><br><span class="line">sysdig -l | grep k8s</span><br><span class="line">sudo modprobe sysdig-probe &amp;&amp; ls /dev/sysdig0</span><br><span class="line">sudo sysdig -k https://10.5.0.104:443 -chttptop k8s.svc.name=postgresql</span><br></pre></td></tr></table></figure>
<h2 id="appedix-trace-cmd-check-if-sequential-cutoff-was-hit"><a href="#appedix-trace-cmd-check-if-sequential-cutoff-was-hit" class="headerlink" title="appedix - trace-cmd - check if sequential_cutoff was hit"></a>appedix - trace-cmd - check if sequential_cutoff was hit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo trace-cmd record -e bcache:bcache_bypass_sequential</span><br><span class="line">sudo trace-cmd report &gt; output.file</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
