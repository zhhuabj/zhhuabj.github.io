<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="作者：张华 发表于：2019-11-05版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (https://zhhuabj.blog.csdn.net) 问题 L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s http&#x2F;https nginx ingress">
<meta property="og:url" content="http://yoursite.com/2019/11/05/k8s-http-https-nginx-ingress/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="作者：张华 发表于：2019-11-05版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (https://zhhuabj.blog.csdn.net) 问题 L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x">
<meta property="og:updated_time" content="2019-11-14T02:31:51.460Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s http&#x2F;https nginx ingress">
<meta name="twitter:description" content="作者：张华 发表于：2019-11-05版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (https://zhhuabj.blog.csdn.net) 问题 L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/05/k8s-http-https-nginx-ingress/"/>





  <title>k8s http/https nginx ingress | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/05/k8s-http-https-nginx-ingress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">k8s http/https nginx ingress</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-05T12:02:18+08:00">
                2019-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>作者：张华 发表于：2019-11-05<br>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (<a href="https://zhhuabj.blog.csdn.net" target="_blank" rel="external">https://zhhuabj.blog.csdn.net</a>)</strong></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>L7 LB, 为了实现http到https的重定向, 需要将L4 LB换成L7 LB, 这样真实的client ip放在了x-forwarded-for header里, 客户真实的scheme放在了x-forwarded-proto里. 所以在L7 LB模式中, 并没有将tcp连接透传给nginx-ingress. <strong>NOTE: 这块可以使用”curl -H ‘X-Forwarded-Proto: https’ -H ‘X-Forwsarded-Host: newhost’ 192.168.99.135:8000”模拟代替.</strong></li>
<li>nginx-ingress, 默认的nginx-ingress里使用(proxy_set_header X-Forwarded-Proto $pass_access_scheme;)与(proxy_set_header X-Original-Forwarded-For $http_x_forwarded_for;)获取的是L7 LB的IP作为client ip, 以及将L7</li>
<li>LB访问的scheme作为scheme. 这里应该改从header里取(http_x_forwarded_proto). backend, 如果backend利用了x-forwarded-*这些header来构造redirect url的话, 如果没有获取到x-forwarded-proto时, 它如果要继续转发(Http Redirect)的话, 可以就会出现url问题.</li>
</ul>
<p>Client与nginx-ingress之间可以配置https，此时nginx-ignress与backends仍然可以配置http, ssl termination, ssl passthrough三种模式。若Client前面还有L7 LB那就是四种模式：</p>
<ul>
<li>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination https (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS” or nginx.ingress.kubernetes.io/secure-backends: “true”)</li>
<li>client –(HTTPs)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl passthrough https (–enable-ssl-passthrough and nginx.ingress.kubernetes.io/ssl-passthrough: “true”)</li>
<li>client –(HTTPs)–&gt; L7 LB –(use-forwarded-headers=true, X-Forwarded-Proto=https)–&gt; ingress-controller –(HTTPs)–&gt; backend     # ssl termination with F5 - <a href="https://bugs.launchpad.net/bugs/1842286" target="_blank" rel="external">https://bugs.launchpad.net/bugs/1842286</a><h2 id="http-ingress"><a href="#http-ingress" class="headerlink" title="http ingress"></a>http ingress</h2>client –(HTTP)–&gt; ingress-controller  –(HTTP)–&gt; backend      # http lb<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">juju scp kubernetes-master/0:config ~/.kube/config</span><br><span class="line">#juju run-action etcd/0 health --wait</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line">kubectl get services --namespace=ingress-nginx-kubernetes-worker default-http-backend-kubernetes-worker -o yaml</span><br><span class="line">kubectl get daemonset --namespace=ingress-nginx-kubernetes-worker nginx-ingress-controller-kubernetes-worker -o yaml</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - /nginx-ingress-controller</span><br><span class="line">        - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class="line">        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class="line">        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class="line">        - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class="line">        - --enable-ssl-chain-completion=False</span><br><span class="line">        - --enable-ssl-passthrough=False</span><br><span class="line"></span><br><span class="line">#deploy http ingress</span><br><span class="line">kubectl run nginx --image=nginx --port 80</span><br><span class="line">kubectl expose deployment nginx --port=80 --target-port=80 --type=NodePort</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-test.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-service</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: &quot;quqi.com&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ./ingress-test.yaml</span><br><span class="line">kubectl describe ingresses ingress-service</span><br><span class="line">kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">$ kubectl describe service nginx</span><br><span class="line">IP:                       10.152.183.250</span><br><span class="line">Port:                     &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  31463/TCP</span><br><span class="line">Endpoints:                10.1.60.3:80</span><br><span class="line">$ juju status |grep worker/0</span><br><span class="line">kubernetes-worker/0*      active    idle   4        10.5.0.53       80/tcp,443/tcp  Kubernetes worker running.</span><br><span class="line"></span><br><span class="line">#curl http(s)://&lt;worker-ip&gt;:NodePort&gt;/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos;</span><br><span class="line">curl http://10.5.0.53:31463/ -H &apos;Host: quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ssl-termination-http"><a href="#ssl-termination-http" class="headerlink" title="ssl termination http"></a>ssl termination http</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTP)–&gt; backend      # ssl termination http<br>ssl termination可参见：<a href="https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/" target="_blank" rel="external">https://www.howtoing.com/how-to-set-up-nginx-load-balancing-with-ssl-termination/</a><br>在k8s中， 如果nginx-ingress前面还有LB如F5的话，nginx-ingress并不是和client直接相连的，client传给F5的链接里的https标记会最终设置成X-Forwarded-Proto=https, 所以nginx-ingress这端需要在configmap中设置use-forwarded-headers=true(kubectl -n ingress-nginx-kubernetes-worker edit cm nginx-configura<br>tion), If true, nginx-ingress passes the incoming X-Forwarded-* (eg: X-Forwarded-Proto) headers to upstreams. Use this option when nginx is behind another L7 proxy / LB that is setting these headers.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">kubectl create secret tls ingress-ssl-secret --cert=server.crt --key=server.key</span><br><span class="line">kubectl describe secret ingress-ssl-secret</span><br><span class="line">kubectl run nginx --image=nginx --port 80 --expose</span><br><span class="line"></span><br><span class="line"># 将ingress controller pods定义service对外暴露NodePort (NOTE: 下面namespace应该用default) -</span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32080</span><br><span class="line">    - name: https</span><br><span class="line">      port: 443</span><br><span class="line">      targetPort: 443</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 32443</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx-kubernetes-worker</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx-kubernetes-worker</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-nginx.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-nginx.yaml</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line">kubectl exec pod/nginx-ingress-controller-kubernetes-worker-w98fm -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 2.txt</span><br><span class="line">vimdiff 1.txt 2.txt</span><br><span class="line">#https://paste.ubuntu.com/p/8yV7RZJ9D7/</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure></p>
<p>如果nginx-ingress和backend总是采用https的话， ingress定义时需添加annotation：nginx.ingress.kubernetes.io/secure-backends: “true”<br>或者使用附录中的tomcat容器也行。</p>
<h2 id="ssl-termination-with-HTTPS-backend"><a href="#ssl-termination-with-HTTPS-backend" class="headerlink" title="ssl termination with HTTPS backend"></a>ssl termination with HTTPS backend</h2><p>client –(HTTPs)–&gt; ingress-controller –(HTTPS)–&gt; backend     # ssl termination (nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”  or nginx.ingress.kubernetes.io/secure-backends: “true”)<br>后端需要做一个https测试应用： <a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>新版本需添加：nginx.ingress.kubernetes.io/backend-protocol: “HTTPS”， 旧版本使用：nginx.ingress.kubernetes.io/secure-backends: “true”,<br>下面是制作一个https测试应用的步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line"></span><br><span class="line">openssl genrsa -passout pass:password -out ca.key</span><br><span class="line">openssl req -x509 -passin pass:password -new -nodes -key ca.key -days 3650 -out ca.crt -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl genrsa -passout pass:password -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=ssltest.quqi.com&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br><span class="line">cat server.crt server.key &gt; server.pem</span><br><span class="line">#openssl pkcs12 -export -inkey server.key -in server.crt -certfile ca.crt -passout pass:password -out server.p12</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;simple-https-server.py&apos; &lt;&lt;EOF</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import ssl</span><br><span class="line">httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 443), SimpleHTTPServer.SimpleHTTPRequestHandler)</span><br><span class="line">httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">httpd.serve_forever()</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt;index.html&apos; &lt;&lt;EOF</span><br><span class="line">Hello world!</span><br><span class="line">EOF</span><br><span class="line">nohup sudo python simple-https-server.py &amp;</span><br><span class="line">curl --resolve ssltest.quqi.com:443:192.168.99.135 --cacert ./server.pem https://ssltest.quqi.com</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;Dockerfile&apos; &lt;&lt;EOF</span><br><span class="line">FROM python:2.7-alpine</span><br><span class="line">ADD simple-https-server.py /</span><br><span class="line">ADD index.html /</span><br><span class="line">ADD server.pem /</span><br><span class="line">RUN apk update &amp;&amp; apk add bash</span><br><span class="line">RUN pip install simple_http_server</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./simple-https-server.py&quot; ]</span><br><span class="line">EOF</span><br><span class="line">#sudo docker run -it --rm --name simple-https-server -v &quot;$PWD&quot;:/root -w /root python:2.7-alpine python simple-https-server.py</span><br><span class="line"></span><br><span class="line">sudo apt install docker.io -y</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/default/docker&apos; &lt;&lt;EOF</span><br><span class="line">DOCKER_OPTS=&quot;--insecure-registry $DOCKER_OPTS --insecure-registry registry.mirrors.aliyuncs.com&quot;</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &gt; /etc/docker/daemon.json&apos; &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https://6kx4zyno.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line">sudo docker build -t simple-https-server .</span><br><span class="line">sudo docker tag simple-https-server zhhuabj/simple-https-server</span><br><span class="line">sudo docker image rm simple-https-server</span><br><span class="line">sudo docker history zhhuabj/simple-https-server</span><br><span class="line">#sudo docker run -d --rm --name simple-https-server zhhuabj/simple-https-server</span><br><span class="line">#sudo docker inspect simple-https-server |grep IPAddress</span><br><span class="line">#curl --resolve ssltest.quqi.com:443:172.17.0.2 --cacert server.pem https://ssltest.quqi.com</span><br><span class="line">#sudo docker rm simple-https-server --force</span><br><span class="line">proxychains4 sudo docker login</span><br><span class="line">sudo docker push zhhuabj/simple-https-server</span><br><span class="line"></span><br><span class="line">#don&apos;t know why image always doesn&apos;t update even if using --image-pul-policy=Always, so:</span><br><span class="line">sudo docker pull zhhuabj/simple-https-server</span><br><span class="line">sudo docker tag zhhuabj/simple-https-server zhhuabj/simple-https-server:withbash</span><br><span class="line">sudo docker push zhhuabj/simple-https-server:withbash</span><br><span class="line">#debug, containerd operation</span><br><span class="line">sudo ctr --namespace k8s.io containers ls</span><br><span class="line">sudo ctr --namespace k8s.io images ls</span><br><span class="line"></span><br><span class="line">kubectl run simple-https-server --image=zhhuabj/simple-https-server:withbash --image-pull-policy=Always --port 443</span><br><span class="line">kubectl expose deployment simple-https-server --port=443 --target-port=443</span><br><span class="line">kubectl describe service simple-https-server</span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl --resolve ssltest.quqi.com:31750:10.5.0.26 --cacert server.pem https://ssltest.quqi.com:31750</span><br></pre></td></tr></table></figure></p>
<p>继续测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;ingress-simple-https-server.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-simple-https-server</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: simple-https-server</span><br><span class="line">          servicePort: 443</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-simple-https-server.yaml</span><br><span class="line"></span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k</span><br><span class="line">curl https://10.5.0.26:32443/ -H &apos;Host: ssltest.quqi.com&apos; -k -I -L</span><br><span class="line">telnet 10.5.0.40 32443</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker describe service ingress-nginx</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 --cacert server.pem https://ssltest.quqi.com:32443</span><br><span class="line"></span><br><span class="line">kubectl exec -ti simple-https-server-84d588fcb4-9sxsh -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- bash</span><br><span class="line">kubectl -n ingress-nginx-kubernetes-worker exec -ti nginx-ingress-controller-kubernetes-worker-bfkct -- cat /etc/nginx/nginx.conf grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 1.txt</span><br><span class="line"># NOTE: Wrong usage</span><br><span class="line">#kubectl exec pod/nginx-ingress-controller-kubernetes-worker-k9n6j -n ingress-nginx-kubernetes-worker -- cat /etc/nginx/nginx.conf |grep &apos;start server ssltest.quqi.com&apos; -A 123 &gt; 3.txt</span><br><span class="line">Error from server (NotFound): pods &quot;pod&quot; not found  #need to re-install env</span><br></pre></td></tr></table></figure></p>
<h2 id="ssl-passthrough"><a href="#ssl-passthrough" class="headerlink" title="ssl passthrough"></a>ssl passthrough</h2><p>ssl passthrough可参见：<a href="https://www.jianshu.com/p/96f52ed2266d" target="_blank" rel="external">https://www.jianshu.com/p/96f52ed2266d</a><br>ssl passthrough时由于使用tcp不做https拆包取不到https相关字段，但nginx提供了preread on特性在握手阶段读取domain, 这样可实现SNI - 见： <a href="https://www.jianshu.com/p/c86a94b14137" target="_blank" rel="external">https://www.jianshu.com/p/c86a94b14137</a><br>在k8s中，需要启动controller时添加–enable-ssl-passthrough标志, ssl passthrough only works on layer 4 (TCP) and not on layer 7 (HTTP), 同时ingress定义时添加annotation：nginx.ingress.kubernetes.io/ssl-passthrough: “true”， 另外测试时应指明key:<br>curl –resolve ssltest.quqi.com:443:10.5.0.8 –cacert server.pem <a href="https://ssltest.quqi.com" target="_blank" rel="external">https://ssltest.quqi.com</a></p>
<h2 id="k8s-ingress-前端再加F7-LB"><a href="#k8s-ingress-前端再加F7-LB" class="headerlink" title="k8s ingress 前端再加F7 LB"></a>k8s ingress 前端再加F7 LB</h2><p>1, 编辑configmap添加内容：<br>kubectl edit cm –namespace=ingress-nginx-kubernetes-worker nginx-configuration<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  use-forwarded-headers: &quot;true&quot;</span><br></pre></td></tr></table></figure></p>
<p>2, Set up L7 LB in front of ingress-controller<br>sudo apt install haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#install haproxy in bastion</span><br><span class="line">sudo apt install haproxy -y</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/haproxy/haproxy.cfg&apos; &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     2048</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    tune.ssl.default-dh-param 2048</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option forwardfor</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">   mode http</span><br><span class="line">   bind 10.5.0.8:80</span><br><span class="line">   reqadd X-Forwarded-Proto:\ http</span><br><span class="line">   default_backend https-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind 10.5.0.8:443 ssl crt /home/ubuntu/sslkey/server.pem ca-file /home/ubuntu/sslkey/ca.crt</span><br><span class="line">    reqadd X-Forwarded-Proto:\ https</span><br><span class="line">    default_backend https-routers</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    balance roundrobin</span><br><span class="line">    cookie SERVERID insert indirect nocache</span><br><span class="line">    #http-request set-header Host ssltest.quqi.com</span><br><span class="line">    server s1 10.5.0.40:32443 check check-ssl ssl verify none</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl stop haproxy</span><br><span class="line">haproxy -vv</span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg -c</span><br><span class="line">sudo haproxy -f /etc/haproxy/haproxy.cfg -V</span><br><span class="line">curl --resolve ssltest.quqi.com:32443:10.5.0.40 https://ssltest.quqi.com:32443 --cacert ~/sslkey/server.pem</span><br><span class="line">curl https://10.5.0.8 -k</span><br><span class="line">curl --resolve ssltest.quqi.com:443:10.5.0.8 https://ssltest.quqi.com:443 --cacert ~/sslkey/server.pem</span><br></pre></td></tr></table></figure>
<p>如果需要ssl双向认证, 可将上面的” server s1 10.5.0.40:32443 check check-ssl ssl verify none”改为(but it doesn’t work now):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#two-day authenication, but it doesn&apos;t work - https://blog.csdn.net/yin_slin/article/details/81130723</span><br><span class="line">openssl genrsa -passout pass:password -out client.key</span><br><span class="line">openssl req -new -key client.key -out client.csr -subj &quot;/C=CN/ST=BJ/O=STS/CN=10.5.0.8&quot;</span><br><span class="line">openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 3650</span><br><span class="line">openssl pkcs12 -export -inkey client.key -in client.crt -certfile ca.crt -passout pass:password -out client.p12</span><br><span class="line">echo y | keytool -importcert -alias ca -file ca.crt -keystore client-trust.jks -storepass password</span><br><span class="line">echo y | keytool -importcert -alias client -file client.crt -keystore client-trust.jks -storepass password</span><br></pre></td></tr></table></figure></p>
<h2 id="支持X-FORWARDED-PROTO转发的应用"><a href="#支持X-FORWARDED-PROTO转发的应用" class="headerlink" title="支持X_FORWARDED_PROTO转发的应用"></a>支持X_FORWARDED_PROTO转发的应用</h2><p>要继续测试nginx-ingress未传X_FORWARDED_PROTO的影响的话, 需要构建这么一个测试应用, 它要使用X_FORWARDED_PROTO来构建url来做跳转. (或者应用前再搞一级nginx代理之类的作跳转?)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-django -y</span><br><span class="line">python -m django --version</span><br><span class="line">django-admin startproject mysite</span><br><span class="line">cd mysite</span><br><span class="line">sed -i &quot;s,ALLOWED_HOSTS = \[\],ALLOWED_HOSTS = \[&apos;*&apos;\],g&quot; mysite/settings.py</span><br><span class="line">sed -i &quot;s,DEBUG = True,DEBUG = False,g&quot; mysite/settings.py</span><br><span class="line">echo &quot;SECURE_PROXY_SSL_HEADER = (&apos;HTTP_X_FORWARDED_PROTO&apos;, &apos;https&apos;)&quot; &gt;&gt; mysite/settings.py</span><br><span class="line"></span><br><span class="line">#Note: To properly simulate a HTTPS connection in Django, you should also set an environment variable HTTPS=on.</span><br><span class="line">HTTPS=on python manage.py runserver 192.168.99.135:8000</span><br><span class="line">lynx http://192.168.99.135:8000/</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF | sudo tee mysite/sslmiddleware.py</span><br><span class="line"># refer https://github.com/rdegges/django-sslify.git</span><br><span class="line">try:</span><br><span class="line">    # Python 2.x</span><br><span class="line">    from urlparse import urlsplit, urlunsplit</span><br><span class="line">except ImportError:</span><br><span class="line">    # Python 3.x</span><br><span class="line">    from urllib.parse import urlsplit</span><br><span class="line">    from urllib.parse import urlunsplit</span><br><span class="line"></span><br><span class="line">from django.conf import settings</span><br><span class="line">from django.http import HttpResponsePermanentRedirect</span><br><span class="line">from django.http import HttpResponse, HttpResponseRedirect</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    # Django 1.10</span><br><span class="line">    from django.utils.deprecation import MiddlewareMixin</span><br><span class="line">except ImportError:</span><br><span class="line">    # Django &lt;1.10</span><br><span class="line">    class MiddlewareMixin(object):</span><br><span class="line">        def __init__(self, get_response=None):</span><br><span class="line">            self.get_response = get_response</span><br><span class="line">            super(MiddlewareMixin, self).__init__()</span><br><span class="line"></span><br><span class="line">        def __call__(self, request):</span><br><span class="line">            response = None</span><br><span class="line">            if hasattr(self, &apos;process_request&apos;):</span><br><span class="line">                response = self.process_request(request)</span><br><span class="line">            if not response:</span><br><span class="line">                response = self.get_response(request)</span><br><span class="line">            if hasattr(self, &apos;process_response&apos;):</span><br><span class="line">                response = self.process_response(request, response)</span><br><span class="line">            return response</span><br><span class="line"></span><br><span class="line">import logging</span><br><span class="line">logger = logging.getLogger(&apos;router&apos;)</span><br><span class="line"></span><br><span class="line">class SSLMiddleware(MiddlewareMixin):</span><br><span class="line"></span><br><span class="line">    def process_request(self, request):</span><br><span class="line">        url = request.build_absolute_uri(request.get_full_path())</span><br><span class="line">        forwarded_proto = request.environ.get(&quot;HTTP_X_FORWARDED_PROTO&quot;)</span><br><span class="line">        #forwarded_proto = request.META.get(&quot;HTTP_X_FORWARDED_PROTO&quot;, &quot;&quot;)</span><br><span class="line">        if forwarded_proto:</span><br><span class="line">            url_split = urlsplit(url)</span><br><span class="line">            scheme = &apos;https&apos; if url_split.scheme == &apos;http&apos; else url_split.scheme</span><br><span class="line">            url_secure_split = (scheme, &quot;%s:%d&quot; % (url_split.hostname or &apos;&apos;, 443)) + url_split[2:]</span><br><span class="line">            #secure_url = url.replace(&quot;http://&quot;, &quot;https://&quot;)</span><br><span class="line">            secure_url = urlunsplit(url_secure_split)</span><br><span class="line">        #print(url)</span><br><span class="line">        #print(forwarded_proto)</span><br><span class="line">        #print(secure_url)</span><br><span class="line">        #return HttpResponsePermanentRedirect(secure_url)</span><br><span class="line">        return HttpResponseRedirect(secure_url)</span><br><span class="line"></span><br><span class="line">    def process_response(self,request,response):</span><br><span class="line">        #print(&apos;response:&apos;)</span><br><span class="line">        print(response)</span><br><span class="line">        return response</span><br><span class="line">EOF</span><br><span class="line">add the line &apos;mysite.middleware.SSLMiddleware&apos;, into MIDDLEWARE item in settings.py, NOTE: Make sure this middleware is the first middleware class listed, as this will ensure that if a user makes an insecure request (over HTTP)</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; http://192.168.99.135:8000</span><br><span class="line">$ python manage.py runserver 192.168.99.135:8000</span><br><span class="line">...</span><br><span class="line">Starting development server at http://192.168.99.135:8000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Location: https://192.168.99.135:443/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[13/Nov/2019 11:16:31] &quot;GET / HTTP/1.1&quot; 302 0</span><br></pre></td></tr></table></figure></p>
<p>改良型的应用如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | sudo tee simple-http-server.py</span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line"># NOTE: Need to make chrome stop redirect from http to https when using chrome for test</span><br><span class="line"># Go to chrome://net-internals/#hsts , enter 192.168.99.135 under Delete domain security policies and press the Delete button.</span><br><span class="line"># Go to chrome://settings/clearBrowserData,  tick the box Cached images and files and press click the button Clear data.</span><br><span class="line">import BaseHTTPServer, SimpleHTTPServer</span><br><span class="line">import os, io, shutil</span><br><span class="line">import ssl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyHandler(SimpleHTTPServer.SimpleHTTPRequestHandler):</span><br><span class="line"></span><br><span class="line">    def do_GET(self):</span><br><span class="line">        #SimpleHTTPServer.SimpleHTTPRequestHandler.do_GET(self)</span><br><span class="line">        scheme = self.headers.get(&apos;X-Forwarded-Proto&apos;,&apos;&apos;)</span><br><span class="line">        serverip = self.headers.get(&apos;X-Forwarded-Host&apos;,&apos;localhost&apos;)</span><br><span class="line">        port = self.headers.get(&apos;X-Forwarded-Port&apos;,&apos;443&apos;)</span><br><span class="line">        clientip = self.headers.get(&apos;X-Forwarded-For&apos;,&apos;localhost&apos;)</span><br><span class="line">        if scheme == &apos;https&apos;:</span><br><span class="line">            # 301 will redirect with a GET request even if you sent a POST request</span><br><span class="line">            self.send_response(301)</span><br><span class="line">            #url_secure_split = (scheme, &quot;%s:%d&quot; % (serverip, port)) + self.path</span><br><span class="line">            new_url = &apos;%s%s%s%s%s%s&apos; % (scheme, &apos;://&apos;, serverip, &apos;:&apos;, port, self.path)</span><br><span class="line">            self.send_header(&apos;Location&apos;, new_url)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(&quot;redirect url to %s&quot; % (new_url))</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line">        else:</span><br><span class="line">            self.send_response(200)</span><br><span class="line">            #self.send_header(&apos;Content-type&apos;,&apos;text/html&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            # NOTE: need to make chrom stop redirect from http to https when using chrom for test</span><br><span class="line">            self.wfile.write(&quot;X-Forwarded-Proto = &quot; + scheme)</span><br><span class="line">            self.wfile.write(str(self.headers))</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    httpd = BaseHTTPServer.HTTPServer((&apos;0.0.0.0&apos;, 8000), MyHandler)</span><br><span class="line">    #httpd.socket = ssl.wrap_socket (httpd.socket, certfile=&apos;./server.pem&apos;, server_side=True)</span><br><span class="line">    httpd.serve_forever()</span><br><span class="line">except KeyboardInterrupt:</span><br><span class="line">    print(&apos;^C received, shutting down server&apos;)</span><br><span class="line">    httpd.socket.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: http&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpHost: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: http</span><br><span class="line">X-Forwsarded-Host: newhost</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;X-Forwarded-Proto: https&apos; -H &apos;X-Forwsarded-Host: newhost&apos; 192.168.99.135:8000</span><br><span class="line">X-Forwarded-Proto = httpsredirect url to https://localhost:443/Host: 192.168.99.135:8000</span><br><span class="line">User-Agent: curl/7.58.0</span><br><span class="line">Accept: */*</span><br><span class="line">X-Forwarded-Proto: https</span><br><span class="line">X-Forwsarded-Host: newhost</span><br></pre></td></tr></table></figure>
<h2 id="Appendix-tomcat-container"><a href="#Appendix-tomcat-container" class="headerlink" title="Appendix - tomcat container"></a>Appendix - tomcat container</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;tomcat-deploy.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    port: 8080</span><br><span class="line">  - name: ajp</span><br><span class="line">    targetPort: 8009</span><br><span class="line">    port: 8009</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tomcat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: tomcat:9.0-jre8-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: ajp</span><br><span class="line">          containerPort: 8009</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f tomcat-deploy.yaml</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;ingress-tomcat.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tomcat</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - ssltest.quqi.com</span><br><span class="line">    secretName: ingress-ssl-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: ssltest.quqi.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path:</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: tomcat</span><br><span class="line">          servicePort: 8080</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f ingress-tomcat.yaml</span><br><span class="line"></span><br><span class="line">#kubectl run -i --rm --tty client --image=tutum/curl</span><br><span class="line">curl http://10.5.0.53:32080/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos;</span><br><span class="line">curl -k https://10.5.0.53:32443/ -H &apos;Host: ssltest.quqi.com&apos; -I -L</span><br></pre></td></tr></table></figure>
<h2 id="Apendix-a-haproxy-example"><a href="#Apendix-a-haproxy-example" class="headerlink" title="Apendix - a haproxy example"></a>Apendix - a haproxy example</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">global</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">    debug</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log global</span><br><span class="line">    option httpclose</span><br><span class="line">    timeout connect 30000ms</span><br><span class="line">    timeout client 300000ms</span><br><span class="line">    timeout server 300000ms</span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:80</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: http</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend https-in</span><br><span class="line">    mode http</span><br><span class="line">    bind *:443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    option httplog</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto: https</span><br><span class="line">    default_backend http-routers</span><br><span class="line"></span><br><span class="line">frontend ssl-in</span><br><span class="line">    mode tcp</span><br><span class="line">    reqirep ^Host: 10.5.0.53:4443 Host: ssltest.quqi.com</span><br><span class="line">    bind :4443 ssl /home/ubuntu/stsstack-bundles/kubernetes/ingress/simple-https-server/server.pem</span><br><span class="line">    default_backend tcp-routers</span><br><span class="line"></span><br><span class="line">backend http-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:80 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:80 check inter 1000</span><br><span class="line"></span><br><span class="line">backend https-routers</span><br><span class="line">    mode http</span><br><span class="line">    reqirep ^Host: 10.5.0.53:443 Host: ssltest.quqi.com</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:443 check inter 1000</span><br><span class="line"></span><br><span class="line">backend tcp-routers</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">        server k8s-nginx-ingress ssltest.quqi.com:4443 check inter 1000</span><br><span class="line"> reqirep ^Host: external-address:4443 Host: loggregator.internal-address:4443</span><br></pre></td></tr></table></figure>
<p>```</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://ju.outofmemory.cn/entry/359682" target="_blank" rel="external">http://ju.outofmemory.cn/entry/359682</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/14/OpenStack开发过程中常用Git操作场景/" rel="next" title="OpenStack开发过程中常用Git操作场景">
                <i class="fa fa-chevron-left"></i> OpenStack开发过程中常用Git操作场景
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/06/使用apt-mirror和simplestreams搭建本地源/" rel="prev" title="使用apt-mirror和simplestreams搭建本地源">
                使用apt-mirror和simplestreams搭建本地源 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http-ingress"><span class="nav-number">2.</span> <span class="nav-text">http ingress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ssl-termination-http"><span class="nav-number">3.</span> <span class="nav-text">ssl termination http</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ssl-termination-with-HTTPS-backend"><span class="nav-number">4.</span> <span class="nav-text">ssl termination with HTTPS backend</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ssl-passthrough"><span class="nav-number">5.</span> <span class="nav-text">ssl passthrough</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s-ingress-前端再加F7-LB"><span class="nav-number">6.</span> <span class="nav-text">k8s ingress 前端再加F7 LB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#支持X-FORWARDED-PROTO转发的应用"><span class="nav-number">7.</span> <span class="nav-text">支持X_FORWARDED_PROTO转发的应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Appendix-tomcat-container"><span class="nav-number">8.</span> <span class="nav-text">Appendix - tomcat container</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Apendix-a-haproxy-example"><span class="nav-number">9.</span> <span class="nav-text">Apendix - a haproxy example</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">10.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
