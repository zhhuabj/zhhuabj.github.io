<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-07-13) Bootstrapping master with kubeadm1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545">
<meta property="og:type" content="article">
<meta property="og:title" content="Using kubeadm to deploy k8s">
<meta property="og:url" content="http://yoursite.com/2019/01/02/Using-kubeadm-to-deploy-k8s/index.html">
<meta property="og:site_name" content="技术并艺术着">
<meta property="og:description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-07-13) Bootstrapping master with kubeadm1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545">
<meta property="og:updated_time" content="2019-01-02T03:08:44.909Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Using kubeadm to deploy k8s">
<meta name="twitter:description" content="版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-07-13) Bootstrapping master with kubeadm1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/02/Using-kubeadm-to-deploy-k8s/"/>





  <title>Using kubeadm to deploy k8s | 技术并艺术着</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术并艺术着</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">张华的技术博客 - blog.csdn.net/quqi99</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/02/Using-kubeadm-to-deploy-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="张华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术并艺术着">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Using kubeadm to deploy k8s</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-02T11:08:22+08:00">
                2019-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>版权声明：可以任意转载，转载时请务必以超链接形式标明文章原始出处和作者信息及本版权声明 (作者：张华 发表于：2018-07-13)</strong></p>
<h2 id="Bootstrapping-master-with-kubeadm"><a href="#Bootstrapping-master-with-kubeadm" class="headerlink" title="Bootstrapping master with kubeadm"></a>Bootstrapping master with kubeadm</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/setup/independent/install-kubeadm/</span><br><span class="line">Create a VM (ubuntu 18.04) joshuazhang1c.mylabserver.com in linuxacademy.com, then run:</span><br><span class="line"></span><br><span class="line"># Reset env</span><br><span class="line">kubectl drain joshuazhang1c.mylabserver.com --delete-local-data --force --ignore-daemonsets</span><br><span class="line">kubectl get node</span><br><span class="line">kubectl delete node joshuazhang1c.mylabserver.com</span><br><span class="line">sudo kubeadm reset</span><br><span class="line"></span><br><span class="line"># Installing kubeadm, kubelet, kubectl, docker</span><br><span class="line">sudo apt update &amp;&amp; sudo apt install -y apt-transport-https curl</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/apt/sources.list.d/kubernetes.list&apos; &lt;&lt;EOF</span><br><span class="line">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">sudo systemctl enable docker.service</span><br><span class="line"></span><br><span class="line"># Creating a single master cluster with kubeadm</span><br><span class="line"># For flannle to work correctly, you must pass --pod-network-cidr=10.244.0.0/16</span><br><span class="line">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</span><br><span class="line">sudo kubeadm init --pod-network-cidr=10.244.0.0/16</span><br><span class="line">kubectl describe ds kube-flannel-ds-amd64 --namespace kube-system</span><br><span class="line">cat /etc/cni/net.d/10-flannel.conflist</span><br><span class="line"></span><br><span class="line"># the following commands come from the output of &apos;kubeadm init&apos;</span><br><span class="line"># export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">rm -rf ~/.kube/config &amp;&amp; sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"># configure kubectl completion</span><br><span class="line">kubectl completion bash | sudo tee /etc/bash_completion.d/k8s</span><br><span class="line"></span><br><span class="line"># Installing a pod network add-on</span><br><span class="line">sudo bash -c &apos;cat &gt;&gt; /etc/sysctl.conf&apos; &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">EOF</span><br><span class="line">sysctl -p</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml</span><br><span class="line">kubectl get daemonsets --all-namespaces</span><br><span class="line">kubectl get nodes --all-namespaces -o wide</span><br><span class="line"></span><br><span class="line"># Joining your nodes with kubeadm way, we will aslo try tls bootstrap way below</span><br><span class="line">ssh cloud_user@joshuazhang3c.mylabserver.com -v</span><br><span class="line">sudo -i</span><br><span class="line">apt install -y docker.io</span><br><span class="line">systemctl enable docker.service</span><br><span class="line">apt update &amp;&amp; apt install -y apt-transport-https curl</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">apt update</span><br><span class="line">apt install -y kubeadm</span><br><span class="line"></span><br><span class="line"># kubeadm token list</span><br><span class="line"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &apos;s/^.* //&apos;</span><br><span class="line"># kubectl get secrets --namespace=kube-system bootstrap-token-9k9xoo -o jsonpath=&apos;&#123;.data.token-id&#125;&apos; |base64 -d</span><br><span class="line"># kubectl get secrets --namespace=kube-system bootstrap-token-9k9xoo -o jsonpath=&apos;&#123;.data.token-secret&#125;&apos; |base64 -d</span><br><span class="line">kubeadm join 172.31.19.84:6443 --token 0c4fdy.xptpmgh4eqihxh66 --discovery-token-ca-cert-hash sha256:b227cfd35c9d1ad42d8692576c0a453271741f59e5052c98674bc075b0789a17</span><br></pre></td></tr></table></figure>
<h2 id="Bootstrapping-workerwith-tls-bootstrapping"><a href="#Bootstrapping-workerwith-tls-bootstrapping" class="headerlink" title="Bootstrapping workerwith tls bootstrapping"></a>Bootstrapping workerwith tls bootstrapping</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/</span><br><span class="line">Just need to copy two files(/var/lib/kubelet/config.yaml and ca.crt) to new worker node, then use bootstrap token (temporary auth) and ca.crt to generate kubeconfig, finally restart kubelet with &apos;kubelet --bootstrap-kubeconfig=&quot;/etc/kubelet/bootstrap-kubelet.conf&quot; --kubeconfig=&quot;/etc/kubelet/kubeconfig.conf&quot; --config=&quot;/var/lib/kubelet/config.yaml&quot;&apos;, then master will create the certificate(for non-temporary auth) for worker and auto approve them.</span><br><span class="line"></span><br><span class="line">a, Principle behind. kubeadm has created bootstrap token with the auth-extra-groups &apos;system:bootstrappers:kubeadm:default-node-token&apos; for us. You can change the group name &apos;system:bootstrappers:kubeadm:default-node-token&apos; to another, eg: system:bootstrappers:myworkers</span><br><span class="line"></span><br><span class="line">$ kubectl get --namespace=kube-system secrets bootstrap-token-9k9xoo -o jsonpath=&apos;&#123;.data.auth-extra-groups&#125;&apos; |base64 -d</span><br><span class="line">system:bootstrappers:kubeadm:default-node-token</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; bootstrap-token.yaml&apos; &lt;&lt;EOF</span><br><span class="line"># https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  # Name MUST be of form &quot;bootstrap-token-&lt;token id&gt;&quot;</span><br><span class="line">  name: bootstrap-token-07401b</span><br><span class="line">  namespace: kube-system</span><br><span class="line"># Type MUST be &apos;bootstrap.kubernetes.io/token&apos;</span><br><span class="line">type: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  # Human readable description. Optional.</span><br><span class="line">  description: &quot;The default bootstrap token generated by &apos;kubeadm init&apos;.&quot;</span><br><span class="line">  # Token ID and secret. Required.</span><br><span class="line">  token-id: 07401b</span><br><span class="line">  token-secret: f395accd246ae52d</span><br><span class="line">  # Expiration. Optional.</span><br><span class="line">  expiration: 2019-03-10T03:22:11Z</span><br><span class="line">  # Allowed usages.</span><br><span class="line">  usage-bootstrap-authentication: &quot;true&quot;</span><br><span class="line">  usage-bootstrap-signing: &quot;true&quot;</span><br><span class="line">  # Extra groups to authenticate the token as. Must start with &quot;system:bootstrappers:&quot;</span><br><span class="line">  auth-extra-groups: system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f bootstrap-token.yaml</span><br><span class="line">kubectl describe secrets --namespace=kube-system bootstrap-token-07401b</span><br><span class="line">kubectl get secrets --namespace=kube-system bootstrap-token-07401b -o jsonpath=&#123;.data.token-id&#125; |base64 -d</span><br><span class="line">kubectl get secrets --namespace=kube-system bootstrap-token-07401b -o jsonpath=&#123;.data.token-secret&#125; |base64 -d</span><br><span class="line"></span><br><span class="line">So the following &apos;kubeadm token create&apos; will create a new token with the auth-extra-groups &apos;system:bootstrappers:kubeadm:default-node-token&apos;.</span><br><span class="line">$ kubeadm token create</span><br><span class="line">iate9c.v9qhw2dyngxfcsig</span><br><span class="line">TOKEN_ID=$(kubectl get secrets --namespace=kube-system bootstrap-token-iate9c -o jsonpath=&apos;&#123;.data.token-id&#125;&apos; |base64 -d)</span><br><span class="line">TOKEN_SECRET=$(kubectl get secrets --namespace=kube-system bootstrap-token-iate9c -o jsonpath=&apos;&#123;.data.token-secret&#125;&apos; |base64 -d)</span><br><span class="line"></span><br><span class="line">b, Principle behind. kubeadm has also create the following 3 clusterrolebindings to map the group &apos;system:bootstrappers:kubeadm:default-node-token&apos; for us. If you are using the new group &apos;system:bootstrappers:myworkers&apos;, here you need to change to &apos;system:bootstrappers:myworkers&apos; or &apos;system:bootstrappers&apos;.</span><br><span class="line"></span><br><span class="line">#Authorize kubelet to create CSR by mapping the clusterrole &apos;system:node-bootstrapper&apos; to the group &apos;system:bootstrappers&apos; or &apos;system:bootstrappers:joshuazhang2c.mylabserver.com&apos;</span><br><span class="line">kubectl create clusterrolebinding create-csrs-for-bootstrapping --group=system:bootstrappers:kubeadm:default-node-token --clusterrole=system:node-bootstrapper</span><br><span class="line"></span><br><span class="line">#Auto approve all CSRs by mapping the clusterrole &apos;selfnodeclient&apos; to the group &quot;system:bootstrappers&quot; or &apos;system:bootstrappers:joshuazhang2c.mylabserver.com&apos;</span><br><span class="line">kubectl create clusterrolebinding auto-approve-csrs-for-group --group=system:bootstrappers:kubeadm:default-node-token --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line"></span><br><span class="line">#Auto approve renewal CSRs by mapping the clusterrole &apos;selfnodeclient&apos; to the group &quot;system:nodes&quot;</span><br><span class="line">kubectl create clusterrolebinding auto-approve-renewals-csrs-for-group --group=system:nodes --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line"></span><br><span class="line">So we can use the following CertificateSigningRequest to self-test it.</span><br><span class="line"></span><br><span class="line">openssl genrsa -out joshuazhang2c.mylabserver.com.key</span><br><span class="line">openssl req -new -key joshuazhang2c.mylabserver.com.key -out joshuazhang2c.mylabserver.com.csr -subj &quot;/CN=system:node:joshuazhang2c.mylabserver.com/O=system:nodes&quot;</span><br><span class="line">openssl x509 -req -in joshuazhang2c.mylabserver.com.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out joshuazhang4c.mylabserver.com.crt -days 45</span><br><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: certificates.k8s.io/v1beta1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  name: system:node:joshuazhang2c.mylabserver.com</span><br><span class="line">spec:</span><br><span class="line">  groups:</span><br><span class="line">    - system:nodes</span><br><span class="line">  request: $(cat joshuazhang2c.mylabserver.com.csr | base64 | tr -d &apos;\n&apos;)</span><br><span class="line">  usages:</span><br><span class="line">    - key encipherment</span><br><span class="line">    - digital signature</span><br><span class="line">    - client auth</span><br><span class="line">EOF</span><br><span class="line">kubectl get csr</span><br><span class="line"></span><br><span class="line">c, Generate kubeconfig with bootstrap token and ca</span><br><span class="line">ENDPOINT=$(kubectl describe service kubernetes |grep -i endpoints |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">CLUSTER=$(kubectl config view |grep &apos;  cluster:&apos; |awk &apos;&#123;print $2&#125;&apos;)</span><br><span class="line">TOKEN_ID=$(kubectl get secrets --namespace=kube-system bootstrap-token-iate9c -o jsonpath=&apos;&#123;.data.token-id&#125;&apos; |base64 -d)</span><br><span class="line">TOKEN_SECRET=$(kubectl get secrets --namespace=kube-system bootstrap-token-iate9c -o jsonpath=&apos;&#123;.data.token-secret&#125;&apos; |base64 -d)</span><br><span class="line">sudo kubectl config --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf set-cluster $&#123;CLUSTER&#125; --server=https://$&#123;ENDPOINT&#125; --certificate-authority=/etc/kubernetes/pki/ca.crt</span><br><span class="line">sudo kubectl config --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf set-credentials kubelet-bootstrap --token=$&#123;TOKEN_ID&#125;.$&#123;TOKEN_SECRET&#125;</span><br><span class="line">sudo kubectl config --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf set-context bootstrap --user=kubelet-bootstrap --cluster=$&#123;CLUSTER&#125;</span><br><span class="line">sudo kubectl config --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf use-context bootstrap</span><br><span class="line"></span><br><span class="line"># Copy the following files from master to the new node</span><br><span class="line">scp joshuazhang1c.mylabserver.com:/etc/kubernetes/bootstrap-kubelet.conf . &amp;&amp; sudo mv bootstrap-kubelet.conf /etc/kubernetes/</span><br><span class="line">scp joshuazhang1c.mylabserver.com:/etc/kubernetes/pki/ca.crt . &amp;&amp; sudo mv ca.crt /etc/kubernetes/pki/</span><br><span class="line">scp joshuazhang1c.mylabserver.com:/var/lib/kubelet/config.yaml . &amp;&amp; sudo mv config.yaml /var/lib/kubelet/</span><br><span class="line"></span><br><span class="line">c, Install kubelet in the new node joshuazhang2c.mylabserver.com</span><br><span class="line"></span><br><span class="line">sudo apt update &amp;&amp; sudo apt install -y apt-transport-https curl</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">sudo bash -c &apos;cat &gt;/etc/apt/sources.list.d/kubernetes.list&apos; &lt;&lt;EOF</span><br><span class="line">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">sudo systemctl enable docker.service</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt;/lib/systemd/system/kubelet.service&apos; &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubelet: The Kubernetes Node Agent</span><br><span class="line">Documentation=https://kubernetes.io/docs/home/</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">#ExecStart=/usr/bin/kubelet --bootstrap-kubeconfig=&quot;/etc/kubernetes/bootstrap-kubelet.conf&quot; --kubeconfig=&quot;/etc/kubernetes/kubeconfig.conf&quot; --config=&quot;/var/lib/kubernetes/config.yaml&quot;</span><br><span class="line">ExecStart=/usr/bin/kubelet --bootstrap-kubeconfig=&quot;/etc/kubernetes/bootstrap-kubelet.conf&quot; --kubeconfig=&quot;/etc/kubernetes/kubeconfig.conf&quot; --pod-manifest-path=&quot;/etc/kubernetes/manifests/&quot; --feature-gates=RotateKubeletClientCertificate=true</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload; sudo systemctl restart kubelet</span><br><span class="line">sudo systemctl status kubelet</span><br><span class="line"></span><br><span class="line"># Verify</span><br><span class="line">kubectl get nodes joshuazhang2c.mylabserver.com</span><br><span class="line"># kubectl get csr</span><br><span class="line">NAME                                                   AGE   REQUESTOR                 CONDITION</span><br><span class="line">node-csr-mdou0axSg2vlk5wx2_a1uA0-buvaC-PsiF69Jvjg110   87s   system:bootstrap:iate9c   Approved,Issued</span><br><span class="line"># ls /var/lib/kubelet/pki/</span><br><span class="line">kubelet-client-2018-12-04-08-50-51.pem  kubelet-client-current.pem  kubelet.crt  kubelet.key</span><br><span class="line"># openssl x509 -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem |grep system:node</span><br><span class="line">        Subject: O = system:nodes, CN = system:node:joshuazhang4c.mylabserver.com</span><br></pre></td></tr></table></figure>
<h2 id="附件-RBAC-authentication"><a href="#附件-RBAC-authentication" class="headerlink" title="附件 - RBAC authentication"></a>附件 - RBAC authentication</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns development</span><br><span class="line">kubectl create ns production</span><br><span class="line">$ kubectl config get-contexts</span><br><span class="line">CURRENT   NAME           CLUSTER        AUTHINFO   NAMESPACE</span><br><span class="line">*         juju-context   juju-cluster   admin</span><br><span class="line"></span><br><span class="line">sudo useradd -s /bin/bash DevHua</span><br><span class="line">sudo passwd DevHua</span><br><span class="line"></span><br><span class="line"># Generate a private key, then Certificate Signing Request (CSR) for DevHua</span><br><span class="line">openssl genrsa -out DevHua.key</span><br><span class="line">openssl req -new -key DevHua.key -out DevHua.csr -subj &quot;/CN=DevHua/O=development&quot;</span><br><span class="line"># Using the newly created request generate a self-signed certificate using the x509 protocol</span><br><span class="line">openssl x509 -req -in DevHua.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out DevHua.crt -days 45</span><br><span class="line"></span><br><span class="line">kubectl config view</span><br><span class="line">kubectl config set-credentials --help</span><br><span class="line">kubectl config set-credentials DevHua --client-certificate=./DevHua.crt --client-key=./DevHua.key</span><br><span class="line">kubectl config set-context --help</span><br><span class="line">kubectl config set-context DevHua-context --cluster=juju-cluster --namespace=development --user=DevHua</span><br><span class="line">kubectl --context=DevHua-context get pods</span><br><span class="line">#kubectl config use-context DevHua-context</span><br><span class="line">kubectl config get-contexts</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; role-dev.yaml&apos; &lt;&lt;EOF</span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: development</span><br><span class="line">  name: developer</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;, &quot;extensions&quot;, &quot;apps&quot;]</span><br><span class="line">  resources: [&quot;deployments&quot;, &quot;replicasets&quot;, &quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;get&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f role-dev.yaml</span><br><span class="line">kubectl -n development describe roles developer</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; rolebind.yaml&apos; &lt;&lt;EOF</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: developer-role-binding</span><br><span class="line">  namespace: development</span><br><span class="line">subjects:</span><br><span class="line">  - kind: User</span><br><span class="line">    name: DevHua</span><br><span class="line">    apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: developer</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f rolebind.yaml</span><br><span class="line">kubectl -n development describe rolebinding developer-role-binding</span><br><span class="line"></span><br><span class="line">kubectl --context=DevHua-context run nginx --image=nginx</span><br><span class="line">kubectl --context=DevHua-context get pods</span><br><span class="line">kubectl --context=DevHua-context delete deploy nginx</span><br><span class="line"></span><br><span class="line">sudo bash -c &apos;cat &gt; adminrolebind.yaml&apos; &lt;&lt;EOF</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: developer-adminrole-binding</span><br><span class="line">  namespace: development</span><br><span class="line">subjects:</span><br><span class="line">  - kind: User</span><br><span class="line">    name: DevHua</span><br><span class="line">    apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f adminrolebind.yaml</span><br><span class="line">kubectl --context=DevHua-context get pods</span><br><span class="line"></span><br><span class="line">kubectl apply -f role-prod.yaml</span><br><span class="line">vim role-prod.yaml</span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: production #&lt;&lt;- This line</span><br><span class="line">  name: dev-prod #&lt;&lt;- and this line</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;, &quot;extensions&quot;, &quot;apps&quot;]</span><br><span class="line">  resources: [&quot;deployments&quot;, &quot;replicasets&quot;, &quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] #&lt;&lt;- and this one</span><br><span class="line"></span><br><span class="line">kubectl apply -f rolebindprod.yaml</span><br><span class="line">vim rolebindprod.yaml</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: production-role-binding</span><br><span class="line">  namespace: production</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: DevDan</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: dev-prod</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-context ProdHua-context --cluster=kubernetes --namespace=production --user=DevHua</span><br><span class="line">kubectl --context=ProdHua-context run nginx --image=nginx</span><br></pre></td></tr></table></figure>
<h2 id="附件-RBAC-authentication-in-Dashboard"><a href="#附件-RBAC-authentication-in-Dashboard" class="headerlink" title="附件 - RBAC authentication in Dashboard"></a>附件 - RBAC authentication in Dashboard</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># Use default anonymous user</span><br><span class="line"># generate client-certificate-data</span><br><span class="line">grep &apos;client-certificate-data&apos; /var/run/kubernetes/admin.kubeconfig | head -n 1 | awk &apos;&#123;print $2&#125;&apos; | base64 -d &gt;&gt; kubecfg.crt</span><br><span class="line"># generate client-key-data</span><br><span class="line">grep &apos;client-key-data&apos; /var/run/kubernetes/admin.kubeconfig | head -n 1 | awk &apos;&#123;print $2&#125;&apos; | base64 -d &gt;&gt; kubecfg.key</span><br><span class="line"># generate p12</span><br><span class="line">openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name &quot;kubernetes-client&quot;</span><br><span class="line"></span><br><span class="line">kubectl get secret -n kube-system | grep dashboard</span><br><span class="line">kubectlh -n kube-system  get secret kubernetes-dashboard-token-kglhd -o jsonpath=&#123;.data.token&#125;| base64 -d</span><br><span class="line"></span><br><span class="line"># Use admin user</span><br><span class="line">cat &gt; /tmp/admin-user.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line">cat &gt; /tmp/admin-user-role-binding.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line">kubectl create -f /tmp/admin-user.yaml</span><br><span class="line">kubectl create -f /tmp/admin-user-role-binding.yaml</span><br><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin | awk &apos;&#123;print $1&#125;&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="附件-TLS-bootstrapping"><a href="#附件-TLS-bootstrapping" class="headerlink" title="附件 - TLS bootstrapping"></a>附件 - TLS bootstrapping</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/</span><br><span class="line">https://www.codercto.com/a/23740.html</span><br><span class="line">Workers must use a certificate issued by masters to communicatate with masters. To save the workload of creating certificates each time the worker is added, kubelet in worker will use a predefined certificate bootstrap-kubelet.conf to request masters to apply for cerfificate for this worker dynamically.</span><br><span class="line">kubelet has two ports, one is 10250 used to provide read/write tls private api, one is 10255 used to provide read-only non-tls private api.</span><br><span class="line">Bootstrap Token Secret (kubectl describe secrets --namespace=kube-system bootstrap-signer-token-8xsmh) will replace the previous token.csv.</span><br><span class="line"></span><br><span class="line">kube-apiserver side receives the requests for certificates from the kubelet and authenticates those requests:</span><br><span class="line">a, Recognizing CA that signs the client certificate</span><br><span class="line">   kube-apiserver --client-ca-file=/etc/kubernetes/pki/ca.crt --enable-bootstrap-token-auth=true ...</span><br><span class="line">b, Authenticating the bootstrapping kubelet to the system:bootstrappers group</span><br><span class="line"># Create Bootstrap Token</span><br><span class="line">echo &quot;$(head -c 6 /dev/urandom | md5sum | head -c 6)&quot;.&quot;$(head -c 16 /dev/urandom | md5sum | head -c 16)&quot;</span><br><span class="line">vdb9xb.jiqhz35y355g1ngx</span><br><span class="line">vdb9xb.jiqhz35y355g1ngx,kubelet-bootstrap,10001,&quot;system:bootstrappers&quot;  #token.csv</span><br><span class="line">c, Authorize the bootstrapping kubelet to create a certificate signing request (CSR)</span><br><span class="line">kubectl describe roles.rbac.authorization.k8s.io --namespace=kube-system system:controller:bootstrap-signer</span><br><span class="line">sudo bash -c &apos;cat &lt; rolebinding.yaml&apos; &lt;&lt;EOF</span><br><span class="line"># enable bootstrapping nodes to create CSR</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: create-csrs-for-bootstrapping</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-bootstrapper</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kube-controller-manager side is responsible for issuing actual signed certificates:</span><br><span class="line">a, access to the “kuberetes CA key and certificate” that you created and distributed</span><br><span class="line">kube-controller-manager --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key ...</span><br><span class="line">b, approve CSR signing automatically</span><br><span class="line">sudo bash -c &apos;cat &lt; certificatesigningrequests.yaml&apos; &lt;&lt;EOF</span><br><span class="line"># Approve all CSRs for the group &quot;system:bootstrappers&quot;</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: auto-approve-csrs-for-group</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: system:bootstrappers</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line">sudo bash -c &apos;cat &lt; renewal.yaml&apos; &lt;&lt;EOF</span><br><span class="line"># Approve renewal CSRs for the group &quot;system:nodes&quot;</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: auto-approve-renewals-for-nodes</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubelet side:</span><br><span class="line">kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf ...</span><br><span class="line"># cat /etc/kubernetes/bootstrap-kubelet.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: [xxx]</span><br><span class="line">    server: https://172.31.43.252:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: tls-bootstrap-token-user</span><br><span class="line">  name: tls-bootstrap-token-user@kubernetes</span><br><span class="line">current-context: tls-bootstrap-token-user@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: tls-bootstrap-token-user</span><br><span class="line">  user:</span><br><span class="line">    token: vdb9xb.jiqhz35y355g1ngx</span><br><span class="line"></span><br><span class="line">In Summary:</span><br><span class="line">kubectl get secrets -n kube-system |grep -i bootstrap</span><br><span class="line">kubectl -n kube-system get secret bootstrap-signer-token-8xsmh -o jsonpath=&#123;.data.token&#125;| base64 -d</span><br></pre></td></tr></table></figure>
<h2 id="附件-microk8s"><a href="#附件-microk8s" class="headerlink" title="附件 - microk8s"></a>附件 - microk8s</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#sudo snap install microk8s --beta --classic</span><br><span class="line">sudo snap install microk8s --edge --classic</span><br><span class="line">snap list</span><br><span class="line">journalctl -u snap.microk8s.daemon-apiserver.service</span><br><span class="line">microk8s.kubectl get no</span><br><span class="line">microk8s.enable dns dashboard</span><br><span class="line">microk8s.kubectl get all --all-namespaces</span><br><span class="line">lynx http://xxxx</span><br></pre></td></tr></table></figure>
<h2 id="附件-其他"><a href="#附件-其他" class="headerlink" title="附件 - 其他"></a>附件 - 其他</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line"># How to generate yaml template</span><br><span class="line">kubectl run --restart=Always # creates a Deployment</span><br><span class="line">kubectl run --restart=Never # creates bare pod</span><br><span class="line">kubectl run --restart=OnFailure # creates a Job.</span><br><span class="line"></span><br><span class="line">https://kubernetes.io/docs/reference/kubectl/conventions/#generators</span><br><span class="line">pod template:</span><br><span class="line">  kubectl run --help |grep generator</span><br><span class="line">  kubectl run --generator=run-pod/v1 nginx --image=nginx --dry-run -o yaml</span><br><span class="line">service and deployment template:</span><br><span class="line">  kubectl run nginx --service-generator=&apos;service/v2&apos; --image=nginx --dry-run --expose --port 80 -o yaml</span><br><span class="line">job template:</span><br><span class="line">  kubectl run --generator=job/v1 nginx --image=nginx --dry-run -o yaml</span><br><span class="line"></span><br><span class="line"># jq, jsonpath, sort-by, kubectl top etc</span><br><span class="line">kubectl delete pods,services -l name=myLabel --include-uninitialized</span><br><span class="line">kubectl get pods --field-selector=status.phase=Running</span><br><span class="line">kubectl get pod ubuntu -o yaml |sed &apos;s/\(image: ubuntu\):.*$/\1:18.04/&apos; |kubectl replace -f -</span><br><span class="line">kubectl top pod -l name=nginx-ingress-kubernetes-worker</span><br><span class="line">kubectl get pods --sort-by=.metadata.name</span><br><span class="line"></span><br><span class="line">kubectl get -o template pod/web-pod-13je7 --template=&#123;&#123;.status.phase&#125;&#125;</span><br><span class="line"></span><br><span class="line">kubectl get nodes -o jsonpath=&apos;&#123;.items[*].metadata.name&#125;&apos; equals kubectl get nodes -o jsonpath=&apos;&#123;.items..metadata.name&#125;&apos;</span><br><span class="line">kubectl get nodes -o jsonpath=&apos;&#123;.items[].metadata.name&#125;&apos; equals kubectl get nodes -o jsonpath=&apos;&#123;.items[0].metadata.name&#125;&apos;</span><br><span class="line">kubectl get nodes -o jsonpath=&apos;&#123;.items[*].status.addresses[?(@.type==&quot;InternalIP&quot;)].address&#125;&apos;</span><br><span class="line"></span><br><span class="line">kubectl get pods -o json |jq &apos;.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name&apos; |grep -v null |sort |uniq</span><br><span class="line"></span><br><span class="line"># just get pod&apos;s names</span><br><span class="line">kubectl get pod -l app=nginx -o json |jq &apos;.items[].metadata.name&apos;</span><br><span class="line">kubectl get pods -l app=nginx -o=custom-columns=NAME:.metadata.name</span><br><span class="line">kubectl get pods -l app=nginx -o=name</span><br><span class="line"></span><br><span class="line"># dont&apos;s forget --record</span><br><span class="line">#kubectl rollout pause deployment/scale-deploy</span><br><span class="line">#kubectl set resources deployment/scale-deploy -c=nginx --limits=cpu=200m,memory=512Mi</span><br><span class="line">#kubectl rollout resume deployment/scale-deploy</span><br><span class="line">deployment.apps/nginx-deployment resource requirements updated</span><br><span class="line">kubectl set image deploy scale-deploy nginx=nginx:1.9.1 --record</span><br><span class="line">kubectl rollout history deployment/scale-deploy</span><br><span class="line">kubectl rollout history deployment/scale-deploy --revision=1</span><br><span class="line">kubectl rollout undo deployment/scale-deploy</span><br><span class="line">kubectl rollout undo deployment/scale-deploy --to-revision=2</span><br><span class="line">kubectl scale deployment/scale-deploy --replicas=2</span><br><span class="line">kubectl autoscale deployment/scale-deploy --min=3 --max=4 --cpu-percent=80</span><br><span class="line"></span><br><span class="line"># volume template</span><br><span class="line">cat &gt; test_pod.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod</span><br><span class="line">spec:</span><br><span class="line">  #initContainers:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /test</span><br><span class="line">      name: secret-volume</span><br><span class="line">    env:</span><br><span class="line">    - name: PASS</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef:</span><br><span class="line">          name: test-secret</span><br><span class="line">          key: passwd</span><br><span class="line">  volumes:</span><br><span class="line">  - name: hostpath-volume</span><br><span class="line">    hostPath:</span><br><span class="line">      path: /data</span><br><span class="line">  - name: emptydir-volume</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line">  - name: secret-volume</span><br><span class="line">    secret:</span><br><span class="line">      secretName: test-secret</span><br><span class="line">EOF</span><br><span class="line">kubectl create --save-config -f test_pod.yaml</span><br><span class="line">kubectl apply --record -f test_pod.yaml</span><br><span class="line"></span><br><span class="line"># initcontainers</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: workdir</span><br><span class="line">      mountPath: /usr/share/nginx/html</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: touch</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    command: [&apos;touch&apos;, &apos;/work-dir/index.html&apos;]</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: workdir</span><br><span class="line">      mountPath: &quot;/work-dir&quot;</span><br><span class="line">  volumes:</span><br><span class="line">  - name: workdir</span><br><span class="line">    emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line"># Create a pod that uses secrets</span><br><span class="line">kubectl create secret generic test-secret --from-literal=usename=hua --from-literal=passwd=password --dry-run -o yaml</span><br><span class="line">kubectl create secret generic test-secret --from-literal=usename=hua --from-literal=passwd=password</span><br><span class="line">kubectl get pods --namespace=kube-system kube-flannel-ds-amd64-4mt82 -o yaml &gt; pod_template.yaml</span><br><span class="line">cat &gt; pod-secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: question1</span><br><span class="line">  name: pod-secret</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: nginx</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /mnt/secret</span><br><span class="line">      name: test-secret-vol</span><br><span class="line">  volumes:</span><br><span class="line">  - name: test-secret-vol</span><br><span class="line">    secret:</span><br><span class="line">      secretName: test-secret</span><br><span class="line">EOF</span><br><span class="line">kubectl exec pod-secret -- cat /mnt/secret/passwd</span><br><span class="line">cat &gt; pod_secret_env.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: question1</span><br><span class="line">  name: pod-secret-env</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx</span><br><span class="line">    name: nginx</span><br><span class="line">    env:</span><br><span class="line">    - name: PASS</span><br><span class="line">      valueFrom:</span><br><span class="line">        secretKeyRef:</span><br><span class="line">          name: test-secret</span><br><span class="line">          key: passwd</span><br><span class="line">EOF</span><br><span class="line">kubectl exec pod-secret-env -- env |grep PASS</span><br><span class="line"></span><br><span class="line"># etcd 3</span><br><span class="line">ETCDCTL_API=3 etcdctl --help |grep snap</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt --key=/etc/kubernetes/pki/apiserver-etcd-client.key member list</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt --key=/etc/kubernetes/pki/apiserver-etcd-client.key snapshot save snapshot.db</span><br><span class="line">etcdctl --endpoints=https://[127.0.0.1]:2379 --ca-file=/etc/kubernetes/pki/etcd/ca.crt --cert-file=/etc/kubernetes/pki/apiserver-etcd-client.crt --key-file=/etc/kubernetes/pki/apiserver-etcd-client.key cluster-health</span><br><span class="line"></span><br><span class="line"># PV &amp; PVC &amp; Pod</span><br><span class="line">cat &gt; pv.yaml &lt;&lt;EOF</span><br><span class="line">pv + hostpath</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: task-pv-volume</span><br><span class="line">  labels:</span><br><span class="line">    type: local</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: manual</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &quot;/mnt/data&quot;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; pv.yaml &lt;&lt;EOF</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: task-pv-claim</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: manual</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Gi</span><br><span class="line">EOF</span><br><span class="line">cat &gt; pv.yaml &lt;&lt;EOF</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: task-pv-pod</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: task-pv-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">       claimName: task-pv-claim</span><br><span class="line">  containers:</span><br><span class="line">    - name: task-pv-container</span><br><span class="line">      image: nginx</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: &quot;http-server&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">          name: task-pv-storage</span><br><span class="line">EOF</span><br><span class="line"># NOTE: the following command should be runned in the pod which ship pod</span><br><span class="line">echo &apos;hello&apos; &gt; /mnt/data/index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># custom install master (TBD)</span><br><span class="line"># install kube* and etcd binary - https://kubernetes.io/docs/setup/scratch/</span><br><span class="line">wget https://github.com/kubernetes/kubernetes/releases/download/v1.13.0/kubernetes.tar.gz</span><br><span class="line">tar -xf kubernetes.tar.gz</span><br><span class="line">./kubernetes/cluster/get-kube-binaries.sh</span><br><span class="line">tar -xf kubernetes/server/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">sudo cp kubernetes/server/bin/&#123;kube-apiserver,kube-scheduler,kube-controller-manager,kube-proxy,kubectl,kubelet&#125; /usr/bin/</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">tar -xf etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">sudo cp etcd-v3.3.10-linux-amd64/&#123;etcd,etcdctl&#125; /usr/bin/</span><br><span class="line"></span><br><span class="line"># create cert</span><br><span class="line">sudo -i</span><br><span class="line">mkdir -p /etc/kubernetes &amp;&amp; cd /etc/kubernetes</span><br><span class="line">openssl genrsa -out ca.key</span><br><span class="line">openssl req -x509 -new -nodes -key ca.key -subj &quot;/CN=quqi.cluster&quot; -days 5000 -out ca.crt</span><br><span class="line"># openssl x509 -in ca.crt -out ca.pem  #convert CRT to PEM</span><br><span class="line"></span><br><span class="line">#Create key pair for kube-master. NOTE: kube-master should be the same as it&apos;s hostname</span><br><span class="line">openssl genrsa -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/CN=system:node:172.31.20.224/O=system:nodes&quot;</span><br><span class="line">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 5000</span><br><span class="line">openssl x509  -noout -text -in ./server.crt</span><br><span class="line"></span><br><span class="line"># Create key pair for every kube-worker, here we will just create one for all-workers</span><br><span class="line">openssl genrsa -out client.key</span><br><span class="line">openssl req -new -key client.key -out client.csr -subj &quot;/CN=system:node:worker/O=system:nodes&quot;</span><br><span class="line">openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 5000</span><br><span class="line">openssl x509  -noout -text -in ./client.crt</span><br><span class="line"></span><br><span class="line"># static pod way</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">sudo mkdir -p /etc/kubernetes/manifests</span><br><span class="line">sudo kubelet --register-node=false --pod-manifest-path=/etc/kubernetes/manifests</span><br><span class="line">https://medium.com/containerum/4-ways-to-bootstrap-a-kubernetes-cluster-de0d5150a1e4</span><br><span class="line"></span><br><span class="line"># systemd way - https://medium.com/containerum/4-ways-to-bootstrap-a-kubernetes-cluster-de0d5150a1e4</span><br><span class="line">git clone https://github.com/kubernetes/contrib.git</span><br><span class="line">cd ./contrib/init/systemd/</span><br><span class="line">sudo useradd kube</span><br><span class="line">sudo mv *.service /etc/systemd/system/</span><br><span class="line">sudo mv ./environ/* /etc/kubernetes/</span><br><span class="line">sudo mkdir -p  /var/run/kubernetes</span><br><span class="line">sudo systemctl enable kube-apiserver</span><br><span class="line">sudo systemctl restart kube-apiserver</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># install etcd - https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/</span><br><span class="line">sudo touch /var/log/etcd.log &amp;&amp; sudo chown -R $(id -u) /var/log/etcd.log</span><br><span class="line">sudo etcd --listen-client-urls=http://0.0.0.0:2379 --advertise-client-urls=http://172.31.20.224:2379 &gt;&gt; /var/log/etcd.log 2&gt;&amp;1 &amp;</span><br><span class="line">sudo ETCDCTL_API=2 etcdctl --endpoints=http://172.31.20.224:2379 cluster-health</span><br><span class="line">sudo ETCDCTL_API=3 etcdctl --endpoints=http://172.31.20.224:2379 member list</span><br><span class="line">sudo ETCDCTL_API=3 etcdctl --endpoints=http://172.31.20.224:2379 snapshot save snapshot.save</span><br><span class="line"></span><br><span class="line"># run kube-apiserver</span><br><span class="line">sudo touch /var/log/kube-apiserver.log &amp;&amp; sudo chown -R $(id -u) /var/log/kube-apiserver.log</span><br><span class="line">#sudo kube-apiserver --logtostderr --v=0 --etcd-servers=http://172.31.20.224:2379 --insecure-bind-address=0.0.0.0 --insecure-port=8080 --service-cluster-ip-range=10.244.0.0/16 --admission-control=ServiceAccount,LimitRanger,ResourceQuota --bind-address=0.0.0.0 --secure-port=6443 --client-ca-file=/etc/kubernetes/ca.crt --tls-private-key-file=/etc/kubernetes/server.key --tls-cert-file=/etc/kubernetes/server.crt &gt;&gt; /var/log/kube-apiserver.log 2&gt;&amp;1 &amp;</span><br><span class="line">sudo kube-apiserver --logtostderr --v=0 --etcd-servers=http://172.31.20.224:2379 --insecure-bind-address=0.0.0.0 --insecure-port=8080 --service-cluster-ip-range=10.244.0.0/16 --admission-control=ServiceAccount,LimitRanger,ResourceQuota &gt;&gt; /var/log/kube-apiserver.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"># run kube-controller-manager</span><br><span class="line">sudo touch /var/log/kube-controller-manager.log &amp;&amp; sudo chown -R $(id -u) /var/log/kube-controller-manager.log</span><br><span class="line">#sudo kube-controller-manager --logtostderr --v=0 --master=https://172.31.20.224:6443 --service-account-private-key-file=/etc/kubernetes/server.key --root-ca-file=/etc/kubernetes/ca.crt</span><br><span class="line">sudo kube-controller-manager --logtostderr --v=0 --master=http://172.31.20.224:8080  &gt;&gt; /var/log/kube-controller-manager.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"># run kube-scheduler</span><br><span class="line">sudo touch /var/log/kube-scheduler.log &amp;&amp; sudo chown -R $(id -u) /var/log/kube-scheduler.log</span><br><span class="line">sudo kube-scheduler --logtostderr --v=0 --master=http://172.31.20.224:8080  &gt;&gt; /var/log/kube-scheduler.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"># verity master</span><br><span class="line">kubectl -s http://172.31.20.224:8080 get componentstatus</span><br><span class="line">kubectl -s http://172.31.20.224:8080 get node</span><br><span class="line"></span><br><span class="line"># run kube-proxy, docker and kubelet</span><br><span class="line">sudo touch /var/log/kube-proxy.log &amp;&amp; sudo chown -R $(id -u) /var/log/kube-proxy.log</span><br><span class="line">sudo kube-proxy --logtostderr --v=0 --master=http://172.31.20.224:8080  &gt;&gt; /var/log/kube-proxy.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">sudo apt install docker.io</span><br><span class="line">sudo systemctl enable docker</span><br><span class="line"></span><br><span class="line">kubectl config view</span><br><span class="line">kubectl config set-credentials admin --username=admin --password=password</span><br><span class="line">kubectl config set-cluster quqi.cluster --insecure-skip-tls-verify=true --server=http://172.31.20.224:8080</span><br><span class="line">kubectl config set-context quqi.context --user=admin --namespace=default --cluster=quqi.cluster</span><br><span class="line">kubectl config use-context quqi.context</span><br><span class="line">sudo cp .kube/config /etc/kubernetes/kubeconfig</span><br><span class="line"></span><br><span class="line">sudo touch /var/log/kubelet.log &amp;&amp; sudo chown -R $(id -u) /var/log/kubelet.log</span><br><span class="line">sudo kubelet --logtostderr --v=0 --kubeconfig=/etc/kubernetes/kubeconfig  &gt;&gt; /var/log/kubelet.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"># self-hosted way</span><br><span class="line"># create kubeconfig</span><br><span class="line">NOTE: Put the kubeconfig(s) on every node. eg: in /var/lib/kube-proxy/kubeconfig and /var/lib/kubelet/kubeconfig.</span><br><span class="line">CLUSTER_NAME=quqicluster</span><br><span class="line">CA_CERT=/etc/kubernetes/pki/ca.crt</span><br><span class="line">CLI_CERT=/etc/kubernetes/pki/client.crt</span><br><span class="line">CLI_KEY=/etc/kubernetes/pki/client.key</span><br><span class="line">TOKEN=$(dd if=/dev/urandom bs=128 count=1 2&gt;/dev/null | base64 | tr -d &quot;=+/[:space:]&quot; | dd bs=32 count=1 2&gt;/dev/null)</span><br><span class="line">USER=admin</span><br><span class="line">CONTEXT_NAME=admin_context</span><br><span class="line">MASTER_IP=172.31.29.147</span><br><span class="line">sudo kubectl config set-cluster $CLUSTER_NAME --certificate-authority=$CA_CERT --embed-certs=true --server=https://$MASTER_IP</span><br><span class="line">sudo kubectl config set-credentials $USER --client-certificate=$CLI_CERT --client-key=$CLI_KEY --embed-certs=true --token=$TOKEN</span><br><span class="line">sudo kubectl config set-context $CONTEXT_NAME --cluster=$CLUSTER_NAME --user=$USER</span><br><span class="line">sudo kubectl config use-context $CONTEXT_NAME</span><br><span class="line"></span><br><span class="line"># install docker</span><br><span class="line">#iptables -t nat -F</span><br><span class="line">#ip link set docker0 down</span><br><span class="line">#ip link delete docker0</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">sudo systemctl enable docker</span><br><span class="line"></span><br><span class="line"># Install kubelet</span><br><span class="line">sudo mkdir -p /var/lib/kubelet</span><br><span class="line">sudo cp ~/.kube/config /var/lib/kubelet/kubeconfig</span><br><span class="line">sudo kubelet --kubeconfig=/var/lib/kubelet/kubeconfig</span><br><span class="line"></span><br><span class="line">kubelet --kubeconfig=/var/lib/kubelet/kubeconfig --cgroup-driver=cgroupfs --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"># Install kube-proxy</span><br><span class="line">sudo mkdir -p /var/lib/kube-proxy</span><br><span class="line">sudo cp ~/.kube/config /var/lib/kube-proxy/kubeconfig</span><br><span class="line">sudo kube-proxy --master=https://$MASTER_IP --kubeconfig=/var/lib/kube-proxy/kubeconfig</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://blog.spider.im/2018/06/26/cka-exam/" target="_blank" rel="external">http://blog.spider.im/2018/06/26/cka-exam/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/31/Use-Octavia-to-Implement-HTTPS-Health-Monitors/" rel="next" title="Use Octavia to Implement HTTPS Health Monitors">
                <i class="fa fa-chevron-left"></i> Use Octavia to Implement HTTPS Health Monitors
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/18/Set-ip-IPv6-env/" rel="prev" title="Set ip IPv6 env">
                Set ip IPv6 env <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">张华</p>
              <p class="site-description motion-element" itemprop="description">blog.csdn.net/quqi99</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bootstrapping-master-with-kubeadm"><span class="nav-number">1.</span> <span class="nav-text">Bootstrapping master with kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bootstrapping-workerwith-tls-bootstrapping"><span class="nav-number">2.</span> <span class="nav-text">Bootstrapping workerwith tls bootstrapping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-RBAC-authentication"><span class="nav-number">3.</span> <span class="nav-text">附件 - RBAC authentication</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-RBAC-authentication-in-Dashboard"><span class="nav-number">4.</span> <span class="nav-text">附件 - RBAC authentication in Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-TLS-bootstrapping"><span class="nav-number">5.</span> <span class="nav-text">附件 - TLS bootstrapping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-microk8s"><span class="nav-number">6.</span> <span class="nav-text">附件 - microk8s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件-其他"><span class="nav-number">7.</span> <span class="nav-text">附件 - 其他</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">8.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张华</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
